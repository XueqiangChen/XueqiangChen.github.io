<!doctype html><html lang=en><meta charset=utf-8>
<meta name=viewport content="width=device-width">
<title>解决setcap导致Java加载libjli.so 失败问题 | AhaMoment</title>
<meta name=generator content="Hugo Eureka 0.8.3">
<link rel=stylesheet href=https://ahamoment.cn/css/eureka.min.css>
<script defer src=https://ahamoment.cn/js/eureka.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'">
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity="sha256-Zmpaaj+GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE=" crossorigin></script>
<link rel=preconnect href=https://www.google-analytics.com crossorigin>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-80D5T229MJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-80D5T229MJ')</script>
<style type=text/css>.widget+.widget{margin-top:1rem}.widget-title{font-weight:700;margin-bottom:1rem}.widget-list li{font-size:.9rem}.bg-cover img{opacity:1;transition:all .5s ease-in-out}.bg-cover img.dark{opacity:0;height:0}.dark .bg-cover img.day{opacity:0;height:0}.dark .bg-cover img.dark{opacity:1;height:auto}.search-container{margin-top:-.3rem;margin-right:1rem}.search-container .search{border:1px solid #e2e8f0;border-radius:4px}.search-container input{padding-left:1rem;line-height:2rem;outline:none;background:0 0}.search-container button{font-size:.8rem;margin-right:.5rem;color:#e2e8f0}</style>
<link rel=icon type=image/png sizes=32x32 href=https://ahamoment.cn/images/icon_hudefd788b34d9017ea35c49e86618f3e1_134481_32x32_fill_box_center_3.png>
<link rel=apple-touch-icon sizes=180x180 href=https://ahamoment.cn/images/icon_hudefd788b34d9017ea35c49e86618f3e1_134481_180x180_fill_box_center_3.png>
<meta name=description content="背景 最近碰到一个问题，有个应用在启动的时候一直报错，错误信息如下：
java: error while loading shared libraries: libjli.so: cannot open shared object file: No such file or directory  错误信息是说 java 应用加载不到 libjli.so 文件，我们使用 java -version 命令，同样的错误又出现了。使用 ldd 命令查看一下 java 应用是否加载了这个 so 文件，发现 java 应用加载的 so 文件中存在 libjli.so。
$ ldd java linux-vdso.so.1 => (0x00007ffe2a9c7000) /usr/local/lib/libsysconfcpus.so (0x00002ac503ca8000) libz.so.1 => /lib64/libz.so.1 (0x00002ac503eaa000) libjli.so => /apps/svr/jdk-14.0.1/bin/./../lib/libjli.so (0x00002ac5040c0000) libpthread.so.0 => /lib64/libpthread.so.0 (0x00002ac5042d1000) libdl.so.2 => /lib64/libdl.so.2 (0x00002ac5044ee000) libc.so.6 => /lib64/libc.so.6 (0x00002ac5046f2000) /lib64/ld-linux-x86-64.so.2 (0x00002ac503883000)  我们接着查看了 LD_LIBRARY_PATH 和 /etc/ld.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ahamoment.cn/posts/"},{"@type":"ListItem","position":2,"name":"解决setcap导致Java加载libjli.so 失败问题","item":"https://ahamoment.cn/posts/linux/linux-cap/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://ahamoment.cn/posts/linux/linux-cap/"},"headline":"解决setcap导致Java加载libjli.so 失败问题 | AhaMoment","datePublished":"2020-09-11T11:12:43+08:00","dateModified":"2020-09-11T11:12:43+08:00","wordCount":464,"publisher":{"@type":"Person","name":"Chenxueqiang","logo":{"@type":"ImageObject","url":"https://ahamoment.cn/images/icon.png"}},"description":"背景 最近碰到一个问题，有个应用在启动的时候一直报错，错误信息如下：\njava: error while loading shared libraries: libjli.so: cannot open shared object file: No such file or directory  错误信息是说 java 应用加载不到 libjli.so 文件，我们使用 java -version 命令，同样的错误又出现了。使用 ldd 命令查看一下 java 应用是否加载了这个 so 文件，发现 java 应用加载的 so 文件中存在 libjli.so。\n$ ldd java linux-vdso.so.1 =\u0026gt; (0x00007ffe2a9c7000) \/usr\/local\/lib\/libsysconfcpus.so (0x00002ac503ca8000) libz.so.1 =\u0026gt; \/lib64\/libz.so.1 (0x00002ac503eaa000) libjli.so =\u0026gt; \/apps\/svr\/jdk-14.0.1\/bin\/.\/..\/lib\/libjli.so (0x00002ac5040c0000) libpthread.so.0 =\u0026gt; \/lib64\/libpthread.so.0 (0x00002ac5042d1000) libdl.so.2 =\u0026gt; \/lib64\/libdl.so.2 (0x00002ac5044ee000) libc.so.6 =\u0026gt; \/lib64\/libc.so.6 (0x00002ac5046f2000) \/lib64\/ld-linux-x86-64.so.2 (0x00002ac503883000)  我们接着查看了 LD_LIBRARY_PATH 和 \/etc\/ld."}</script><meta property="og:title" content="解决setcap导致Java加载libjli.so 失败问题 | AhaMoment">
<meta property="og:type" content="article">
<meta property="og:image" content="https://ahamoment.cn/images/icon.png">
<meta property="og:url" content="https://ahamoment.cn/posts/linux/linux-cap/">
<meta property="og:description" content="背景 最近碰到一个问题，有个应用在启动的时候一直报错，错误信息如下：
java: error while loading shared libraries: libjli.so: cannot open shared object file: No such file or directory  错误信息是说 java 应用加载不到 libjli.so 文件，我们使用 java -version 命令，同样的错误又出现了。使用 ldd 命令查看一下 java 应用是否加载了这个 so 文件，发现 java 应用加载的 so 文件中存在 libjli.so。
$ ldd java linux-vdso.so.1 => (0x00007ffe2a9c7000) /usr/local/lib/libsysconfcpus.so (0x00002ac503ca8000) libz.so.1 => /lib64/libz.so.1 (0x00002ac503eaa000) libjli.so => /apps/svr/jdk-14.0.1/bin/./../lib/libjli.so (0x00002ac5040c0000) libpthread.so.0 => /lib64/libpthread.so.0 (0x00002ac5042d1000) libdl.so.2 => /lib64/libdl.so.2 (0x00002ac5044ee000) libc.so.6 => /lib64/libc.so.6 (0x00002ac5046f2000) /lib64/ld-linux-x86-64.so.2 (0x00002ac503883000)  我们接着查看了 LD_LIBRARY_PATH 和 /etc/ld.">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="AhaMoment">
<meta property="article:published_time" content="2020-09-11T11:12:43+08:00">
<meta property="article:modified_time" content="2020-09-11T11:12:43+08:00">
<meta property="article:section" content="posts">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="java">
<body class="flex flex-col min-h-screen">
<header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
<div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
<a href=/ class="mr-6 text-primary-text text-xl font-bold">AhaMoment</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i>
</button>
<div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
<div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
<a href=/docs/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">文档</a>
<a href=/archive/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">归档</a>
<a href=/authors/chenxq/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">关于我</a>
</div>
<div class=flex>
<div class="search-container relative pt-4 md:pt-0">
<div class=search>
<form role=search class=search-form action=/search/index.html method=get>
<label>
<input name=q type=text placeholder="搜索 ..." class=search-field>
</label>
<button>
<i class="fas fa-search"></i>
</button>
</form>
</div>
</div>
<div class="relative pt-4 md:pt-0">
<div class="cursor-pointer hover:text-eureka" id=lightDarkMode>
<i class="fas fa-adjust"></i>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open>
</div>
<div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions>
<span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span>
</div>
</div>
</div>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile>
</div>
</nav>
<script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script>
</div>
</header>
<main class="flex-grow pt-16">
<div class=pl-scrollbar>
<div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">
<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
<div class="col-span-2 lg:col-start-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
<h1 class="font-bold text-3xl text-primary-text">解决setcap导致Java加载libjli.so 失败问题</h1>
<div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
<div class="mr-6 my-2">
<i class="fas fa-calendar mr-1"></i>
<span>2020-09-11</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-clock mr-1"></i>
<span>3 min read</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-folder mr-1"></i>
<a href=https://ahamoment.cn/categories/linux/ class=hover:text-eureka>Linux</a>
</div>
</div>
<div class=content>
<h2 id=背景>背景</h2>
<p>最近碰到一个问题，有个应用在启动的时候一直报错，错误信息如下：</p>
<pre><code class=language-bash>java: error while loading shared libraries: libjli.so: cannot open shared object file: No such file or directory
</code></pre>
<p>错误信息是说 java 应用加载不到 libjli.so 文件，我们使用 <code>java -version</code> 命令，同样的错误又出现了。使用 ldd 命令查看一下 java 应用是否加载了这个 so 文件，发现 java 应用加载的 so 文件中存在 libjli.so。</p>
<pre><code class=language-bash>$ ldd java
        linux-vdso.so.1 =&gt;  (0x00007ffe2a9c7000)
        /usr/local/lib/libsysconfcpus.so (0x00002ac503ca8000)
        libz.so.1 =&gt; /lib64/libz.so.1 (0x00002ac503eaa000)
        libjli.so =&gt; /apps/svr/jdk-14.0.1/bin/./../lib/libjli.so (0x00002ac5040c0000)
        libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00002ac5042d1000)
        libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00002ac5044ee000)
        libc.so.6 =&gt; /lib64/libc.so.6 (0x00002ac5046f2000)
        /lib64/ld-linux-x86-64.so.2 (0x00002ac503883000)
</code></pre>
<p>我们接着查看了 <code>LD_LIBRARY_PATH</code> 和 <code>/etc/ld.so.conf.d/xxx.conf</code> 文件的配置，发现都是正常的。通过对比其他应用的启动配置，发现该应用使用了 80 端口启动，但是我们的容器只能使用 apps 权限登录，所以在启动前使用 <code>setcap</code> 命令提升了 java 应用的权限，允许其使用 80 端口，会不会是这个操作导致的呢？在查看原因之前，我们需要先理解几个概念。</p>
<h2 id=linux-动态库>Linux 动态库</h2>
<p>动态库(共享库)的代码在可执行程序运行时才载入内存，在编译过程中仅简单的引用，不同的应用程序如果调用相同的库,那么在内存中只需要有一份该动态库(共享库)的实例。这类库的名字一般是libxxx.so，其中so是 Shared Object 的缩写，即可以共享的目标文件。在链接动态库生成可执行文件时，并不会把动态库的代码复制到执行文件中，而是在执行文件中记录对动态库的引用。</p>
<p>Linux下生成和使用动态库的步骤如下：</p>
<ol>
<li>编写源文件。</li>
<li>将一个或几个源文件编译链接，生成共享库。</li>
<li>通过 <code>-L -lxxx</code> 的gcc选项链接生成的libxxx.so。例如<code>gcc -fPIC -shared -o libmax.so max.c</code> , <code>-fPIC</code> 是编译选项，PIC是 Position Independent Code 的缩写，表示要生成位置无关的代码，这是动态库需要的特性； <code>-shared</code> 是链接选项，告诉gcc生成动态库而不是可执行文件</li>
<li>把libxxx.so放入链接库的标准路径，或指定 <code>LD_LIBRARY_PATH</code>，才能运行链接了libxxx.so的程序。</li>
</ol>
<p>Linux是通过 <code>/etc/ld.so.cache</code> 文件搜寻要链接的动态库的。而 <code>/etc/ld.so.cache</code> 是 ldconfig 程序读取 <code>/etc/ld.so.conf</code> 文件生成的。
（注意， <code>/etc/ld.so.conf</code> 中并不必包含 <code>/lib</code> 和 <code>/usr/lib</code>，<code>ldconfig</code>程序会自动搜索这两个目录）</p>
<p>我们把要用的 libxx.so 文件所在的路径添加到 <code>/etc/ld.so.conf</code> 中，再以root权限运行 <code>ldconfig</code> 程序，更新 <code>/etc/ld.so.cache</code> ，程序运行时，就可以找到 <code>libxx.so</code>。另外就是通过配置 <code>LD_LIBRARY_PATH</code> 的方式来指定通过某些路径寻找链接的动态库。</p>
<h3 id=ldd-查看程序依赖>ldd 查看程序依赖</h3>
<p>理解了动态库的概念之后，当碰到某个程序报错缺少某个库文件时，我们应该怎么查看该程序当前加载了哪些库文件呢？可以用 <code>ldd</code> 命令。</p>
<p>ldd 命令的作用是用来查看程式运行所需的共享库,常用来解决程式因缺少某个库文件而不能运行的一些问题。</p>
<p>例如：查看test程序运行所依赖的库:</p>
<pre><code class=language-bash>[root@localhost testso]# ldd /etc/alternatives/java
        linux-vdso.so.1 =&gt;  (0x00007ffde15f8000)
        libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007f03f2f8d000)
        libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f03f2d89000)
        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f03f29bb000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f03f33ab000)
</code></pre>
<ul>
<li>第一列：程序需要依赖什么库</li>
<li>第二列: 系统提供的与程序需要的库所对应的库</li>
<li>第三列：库加载的开始地址</li>
</ul>
<p>通过上面的信息，我们可以得到以下几个信息：</p>
<ol>
<li>通过对比第一列和第二列，我们可以分析程序需要依赖的库和系统实际提供的，是否相匹配</li>
<li>通过观察第三列，我们可以知道在当前的库中的符号在对应的进程的地址空间中的开始位置</li>
</ol>
<p>如果依赖的某个库找不到，通过这个命令可以迅速定位问题所在.</p>
<h2 id=linux-capability>Linux capability</h2>
<p>从内核 2.2 开始，Linux 将传统上与超级用户 root 关联的特权划分为不同的单元，称为 capabilites。Capabilites 作为线程(Linux 并不真正区分进程和线程)的属性存在，每个单元可以独立启用和禁用。如此一来，权限检查的过程就变成了：在执行特权操作时，如果进程的有效身份不是 root，就去检查是否具有该特权操作所对应的 capabilites，并以此决定是否可以进行该特权操作。</p>
<p>下面是从 <a href=http://man7.org/linux/man-pages/man7/capabilities.7.html>capabilities man page</a> 中摘取的 capabilites 列表：</p>
<table>
<thead>
<tr>
<th>capability 名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CAP_AUDIT_CONTROL</td>
<td>启用和禁用内核审计；改变审计过滤规则；检索审计状态和过滤规则</td>
</tr>
<tr>
<td>CAP_AUDIT_READ</td>
<td>允许通过 multicast netlink 套接字读取审计日志</td>
</tr>
<tr>
<td>CAP_AUDIT_WRITE</td>
<td>将记录写入内核审计日志</td>
</tr>
<tr>
<td>CAP_BLOCK_SUSPEND</td>
<td>使用可以阻止系统挂起的特性</td>
</tr>
<tr>
<td>CAP_CHOWN</td>
<td>修改文件所有者的权限</td>
</tr>
<tr>
<td>CAP_DAC_OVERRIDE</td>
<td>忽略文件的 DAC 访问限制</td>
</tr>
<tr>
<td>CAP_DAC_READ_SEARCH</td>
<td>忽略文件读及目录搜索的 DAC 访问限制</td>
</tr>
<tr>
<td>CAP_FOWNER</td>
<td>忽略文件属主 ID 必须和进程用户 ID 相匹配的限制</td>
</tr>
<tr>
<td>CAP_FSETID</td>
<td>允许设置文件的 setuid 位</td>
</tr>
<tr>
<td>CAP_IPC_LOCK</td>
<td>允许锁定共享内存片段</td>
</tr>
<tr>
<td>CAP_IPC_OWNER</td>
<td>忽略 IPC 所有权检查</td>
</tr>
<tr>
<td>CAP_KILL</td>
<td>允许对不属于自己的进程发送信号</td>
</tr>
<tr>
<td>CAP_LEASE</td>
<td>允许修改文件锁的 FL_LEASE 标志</td>
</tr>
<tr>
<td>CAP_LINUX_IMMUTABLE</td>
<td>允许修改文件的 IMMUTABLE 和 APPEND 属性标志</td>
</tr>
<tr>
<td>CAP_MAC_ADMIN</td>
<td>允许 MAC 配置或状态更改</td>
</tr>
<tr>
<td>CAP_MAC_OVERRIDE</td>
<td>覆盖 MAC(Mandatory Access Control)</td>
</tr>
<tr>
<td>CAP_MKNOD</td>
<td>允许使用 mknod() 系统调用</td>
</tr>
<tr>
<td>CAP_NET_ADMIN</td>
<td>允许执行网络管理任务</td>
</tr>
<tr>
<td>CAP_NET_BIND_SERVICE</td>
<td>允许绑定到小于 1024 的端口</td>
</tr>
<tr>
<td>CAP_NET_BROADCAST</td>
<td>允许网络广播和多播访问</td>
</tr>
<tr>
<td>CAP_NET_RAW</td>
<td>允许使用原始套接字</td>
</tr>
<tr>
<td>CAP_SETGID</td>
<td>允许改变进程的 GID</td>
</tr>
<tr>
<td>CAP_SETFCAP</td>
<td>允许为文件设置任意的 capabilities</td>
</tr>
<tr>
<td>CAP_SETPCAP</td>
<td>参考 <a href=http://man7.org/linux/man-pages/man7/capabilities.7.html>capabilities man page</a></td>
</tr>
<tr>
<td>CAP_SETUID</td>
<td>允许改变进程的 UID</td>
</tr>
<tr>
<td>CAP_SYS_ADMIN</td>
<td>允许执行系统管理任务，如加载或卸载文件系统、设置磁盘配额等</td>
</tr>
<tr>
<td>CAP_SYS_BOOT</td>
<td>允许重新启动系统</td>
</tr>
<tr>
<td>CAP_SYS_CHROOT</td>
<td>允许使用 chroot() 系统调用</td>
</tr>
<tr>
<td>CAP_SYS_MODULE</td>
<td>允许插入和删除内核模块</td>
</tr>
<tr>
<td>CAP_SYS_NICE</td>
<td>允许提升优先级及设置其他进程的优先级</td>
</tr>
<tr>
<td>CAP_SYS_PACCT</td>
<td>允许执行进程的 BSD 式审计</td>
</tr>
<tr>
<td>CAP_SYS_PTRACE</td>
<td>允许跟踪任何进程</td>
</tr>
<tr>
<td>CAP_SYS_RAWIO</td>
<td>允许直接访问 /devport、/dev/mem、/dev/kmem 及原始块设备</td>
</tr>
<tr>
<td>CAP_SYS_RESOURCE</td>
<td>忽略资源限制</td>
</tr>
<tr>
<td>CAP_SYS_TIME</td>
<td>允许改变系统时钟</td>
</tr>
<tr>
<td>CAP_SYS_TTY_CONFIG</td>
<td>允许配置 TTY 设备</td>
</tr>
<tr>
<td>CAP_SYSLOG</td>
<td>允许使用 syslog() 系统调用</td>
</tr>
<tr>
<td>CAP_WAKE_ALARM</td>
<td>允许触发一些能唤醒系统的东西(比如 CLOCK_BOOTTIME_ALARM 计时器)</td>
</tr>
</tbody>
</table>
<p><strong>getcap</strong> 命令和 <strong>setcap</strong> 命令分别用来查看和设置程序文件的 capabilities 属性。</p>
<p>例如<strong>为 ping 命令文件添加 capabilities</strong></p>
<p>执行 ping 命令所需的 capabilities 为 cap_net_admin 和 cap_net_raw，通过 setcap 命令可以添加它们：</p>
<pre><code class=language-bash>$ sudo setcap cap_net_admin,cap_net_raw+ep /bin/ping
</code></pre>
<p>移除添加的 capabilities ，执行下面的命令：</p>
<pre><code class=language-bash>$ sudo setcap cap_net_admin,cap_net_raw-ep /bin/ping
</code></pre>
<p>命令中的 ep 分别表示 Effective 和 Permitted 集合(接下来会介绍)，+ 号表示把指定的 capabilities 添加到这些集合中，- 号表示从集合中移除(对于 Effective 来说是设置或者清除位)。</p>
<h2 id=解决问题>解决问题</h2>
<p>回到我们开始的问题，由于我们为非 root 用户赋予了使用 80 端口的权限，调用了如下命令：</p>
<pre><code class=language-bash>setcap cap_net_bind_service=+ep /usr/bin/java
</code></pre>
<p>当一个可执行文件提升了权限后，运行时加载程序（rtld）— ld.so，它不会与不受信任路径中的库链接。Linux 会为使用了 <code>setcap</code> 或 <code>suid</code> 的程序禁用掉 <code>LD_LIBRARY_PATH</code>。所以就出现了 java 程序加载不到 libjli.so 的情况了，这是 JDK 的一个 bug。</p>
<blockquote>
<p><a href="http://bugs.sun.com/view_bug.do?bug_id=7157699">JDK-7157699 : can not run java after granting posix capabilities</a></p>
</blockquote>
<p>那么既然使用 setcap 后不会加载链接库，我们就可以将 libjli.so 所在的路径添加到 <code>/etc/ld.so.conf/xxx.conf</code>中，例如：</p>
<pre><code class=language-bash>% cat /etc/ld.so.conf.d/java.conf
/usr/java/jdk1.8.0_261-amd64/lib/amd64/jli
</code></pre>
<p>使用 <code>ldconfig</code> 重载 so 文件。</p>
<pre><code class=language-bash>[root@localhost jli]# ldconfig -p | grep libjli
        libjli.so (libc6,x86-64) =&gt; /usr/java/jdk1.8.0_261-amd64/lib/amd64/jli/libjli.so% ldconfig | grep libjli
libjli.so -&gt; libjli.so
.......
</code></pre>
<p>这样再次测试就可以了。</p>
<h2 id=参考文章>参考文章</h2>
<p>【1】<a href=https://www.cnblogs.com/jiqingwu/p/linux_dynamic_lib_create.html>Linux动态库生成与使用指南</a></p>
<p>【2】<a href=https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/ldd.html#ldd>ldd 查看程序依赖库</a></p>
<p>【3】<a href=https://www.cnblogs.com/sparkdev/p/11417781.html>Linux Capabiliites 简介</a></p>
<p>【4】<a href=https://linux.die.net/man/7/capabilities>capabilities(7) - Linux man page</a></p>
<p>【5】<a href=https://www.boris1993.com/linux/allow-non-root-process-to-bind-low-numbered-ports.html>如何允许非 root 进程绑定低位端口</a></p>
<p>【6】[<a href=https://unix.stackexchange.com/questions/87978/how-to-get-oracle-java-7-to-work-with-setcap-cap-net-bind-serviceep>How to get Oracle java 7 to work with setcap cap_net_bind_service+ep</a>](<a href=https://unix.stackexchange.com/questions/87978/how-to-get-oracle-java-7-to-work-with-setcap-cap-net-bind-serviceep>https://unix.stackexchange.com/questions/87978/how-to-get-oracle-java-7-to-work-with-setcap-cap-net-bind-serviceep</a>)</p>
</div>
<div class=my-4>
<a href=https://ahamoment.cn/tags/linux/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#linux</a>
<a href=https://ahamoment.cn/tags/java/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#java</a>
</div>
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
<div>
<span class="block font-bold">Previous</span>
<a href=https://ahamoment.cn/posts/cloud/cloud-container-get-cpu/ class=block>容器内获取 CPU 核数问题</a>
</div>
<div class="md:text-right mt-4 md:mt-0">
<span class="block font-bold">Next</span>
<a href=https://ahamoment.cn/posts/algorithm/algorithm-balanced-binary-tree/ class=block>平衡二叉树</a>
</div>
</div>
</div>
</div>
<script>document.addEventListener('DOMContentLoaded',()=>{hljs.initHighlightingOnLoad()})</script>
</div>
</div>
</main>
<footer class=pl-scrollbar>
<div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
<p class="text-sm text-tertiary-text">&copy; 2021
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p>
</div></div>
</footer>
</body>
</html>