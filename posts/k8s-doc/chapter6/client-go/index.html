<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>K8s Go 客户端浅析 - Aha Moment</title><meta name=Description content="软件工程师"><meta property="og:title" content="K8s Go 客户端浅析"><meta property="og:description" content="在使用 Kubernetes REST API 编写应用程序时， 您并不需要自己实现 API 调用和 “请求/响应” 类型。 您可以根据自己的编程语言需要选择使用合适的客户端库。 客户端库通常为"><meta property="og:type" content="article"><meta property="og:url" content="https://ahamoment.cn/posts/k8s-doc/chapter6/client-go/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-06T19:58:51+08:00"><meta property="article:modified_time" content="2021-04-06T19:58:51+08:00"><meta property="og:site_name" content="Aha Moment"><meta name=twitter:card content="summary"><meta name=twitter:title content="K8s Go 客户端浅析"><meta name=twitter:description content="在使用 Kubernetes REST API 编写应用程序时， 您并不需要自己实现 API 调用和 “请求/响应” 类型。 您可以根据自己的编程语言需要选择使用合适的客户端库。 客户端库通常为"><meta name=application-name content="Aha Moment!"><meta name=apple-mobile-web-app-title content="Aha Moment!"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ahamoment.cn/posts/k8s-doc/chapter6/client-go/><link rel=prev href=https://ahamoment.cn/posts/go/go-new-vs-make/><link rel=next href=https://ahamoment.cn/posts/k8s-doc/chapter6/resource-model/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"K8s Go 客户端浅析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ahamoment.cn\/posts\/k8s-doc\/chapter6\/client-go\/"},"genre":"posts","keywords":"kubernetes, client-go","wordcount":1961,"url":"https:\/\/ahamoment.cn\/posts\/k8s-doc\/chapter6\/client-go\/","datePublished":"2021-04-06T19:58:51+08:00","dateModified":"2021-04-06T19:58:51+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xueqiang.chen"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Aha Moment">Aha Moment!</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Aha Moment">Aha Moment!</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">K8s Go 客户端浅析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://ahamoment.cn title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xueqiang.chen</a></span>&nbsp;<span class=post-category>included in <a href=/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/><i class="far fa-folder fa-fw" aria-hidden=true></i>云计算</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-04-06>2021-04-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1961 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div></div><div class=content id=content><p>在使用 <a href=https://kubernetes.io/zh/docs/reference/using-api/ target=_blank rel="noopener noreffer">Kubernetes REST API</a> 编写应用程序时， 您并不需要自己实现 API 调用和 “请求/响应” 类型。 您可以根据自己的编程语言需要选择使用合适的客户端库。</p><p>客户端库通常为您处理诸如身份验证之类的常见任务。 如果 API 客户端在 Kubernetes 集群中运行，大多数客户端库可以发现并使用 Kubernetes 服务帐户进行身份验证， 或者能够理解 <a href=https://kubernetes.io/zh/docs/tasks/access-application-cluster/configure-access-multiple-clusters/ target=_blank rel="noopener noreffer">kubeconfig 文件</a> 格式来读取凭据和 API 服务器地址。</p><p>kubernetes 官方支持的客户端有 go/python/java/dotnet/js 等，今天我们要讨论的是其中的 <a href=https://github.com/kubernetes/client-go/ target=_blank rel="noopener noreffer">go 客户端</a>。</p><p>首先下载源代码，进入到<code>examples</code>目录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>➜ git clone git@github.com:kubernetes/client-go.git
</span></span><span class=line><span class=cl>➜  ~ <span class=nb>cd</span> client-go/examples
</span></span><span class=line><span class=cl>➜  examples git:<span class=o>(</span>master<span class=o>)</span> ✗ ll
</span></span><span class=line><span class=cl>total 32K
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> root root 2.0K Apr  <span class=m>6</span> 17:33 README.md
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root 4.0K Apr  <span class=m>6</span> 17:46 create-update-delete-deployment
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root 4.0K Apr  <span class=m>6</span> 17:33 dynamic-create-update-delete-deployment
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root 4.0K Apr  <span class=m>6</span> 17:33 fake-client
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root 4.0K Apr  <span class=m>6</span> 17:33 in-cluster-client-configuration
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root 4.0K Apr  <span class=m>6</span> 17:33 leader-election
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root 4.0K Apr  <span class=m>6</span> 17:33 out-of-cluster-client-configuration
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root 4.0K Apr  <span class=m>6</span> 17:33 workqueue
</span></span></code></pre></div><p>go 客户端提供了很多的使用样例，我们重点来看一下<a href=https://github.com/kubernetes/client-go/tree/master/examples/create-update-delete-deployment target=_blank rel="noopener noreffer">create-update-delete-deployment</a> 这个目录，这个目录中是关于操作deployment资源对象的样例，包括创建，查询，更新，删除。</p><blockquote><p>This example program demonstrates the fundamental operations for managing on <a href=https://kubernetes.io/docs/user-guide/deployments/ target=_blank rel="noopener noreffer">Deployment</a> resources, such as <code>Create</code>, <code>List</code>, <code>Update</code> and <code>Delete</code>.</p><p>You can adopt the source code from this example to write programs that manage other types of resources through the Kubernetes API.</p></blockquote><p>我们从 <code>main</code> 函数开始看起，这里尝试使用 <code>go-callvis</code> 将整个调用关系可视化出来：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/frame_generic_dark.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/frame_generic_dark.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/frame_generic_dark.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/frame_generic_dark.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/frame_generic_dark.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/frame_generic_dark.png></p><p>总的来看，<code>main</code> 使用 <code>kubeconfig</code> 的配置来生成 rest client，通过 rest client 调用 k8s api 进行资源的操作。</p><p>接下来，具体来看一下读取 <code>kubeconfig</code> 配置的代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>kubeconfig</span> <span class=o>*</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>home</span> <span class=o>:=</span> <span class=nx>homedir</span><span class=p>.</span><span class=nf>HomeDir</span><span class=p>();</span> <span class=nx>home</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubeconfig</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;kubeconfig&#34;</span><span class=p>,</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>home</span><span class=p>,</span> <span class=s>&#34;.kube&#34;</span><span class=p>,</span> <span class=s>&#34;config&#34;</span><span class=p>),</span> <span class=s>&#34;(optional) absolute path to the kubeconfig file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubeconfig</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;kubeconfig&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;absolute path to the kubeconfig file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>config</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientcmd</span><span class=p>.</span><span class=nf>BuildConfigFromFlags</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>kubeconfig</span><span class=p>)</span>
</span></span></code></pre></div><p>命令行参数指定<code>kubeconfig</code>的绝对路径，调用<code>clientcmd.BuildConfigFromFlags("", *kubeconfig)</code>来解析 config 的配置信息。 <code>BuildConfigFromFlags</code> 函数是用来从master地址或者kubeconfig文件地址来构建config配置，这个函数做了两件事情：</p><ol><li>调用<code>func NewNonInteractiveDeferredLoadingClientConfig(loader ClientConfigLoader, overrides *ConfigOverrides) ClientConfig</code></li><li>调用 <code>func (config *DeferredLoadingClientConfig) ClientConfig() (*restclient.Config, error)</code> 函数</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>BuildConfigFromFlags</span><span class=p>(</span><span class=nx>masterUrl</span><span class=p>,</span> <span class=nx>kubeconfigPath</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>restclient</span><span class=p>.</span><span class=nx>Config</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>......</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>NewNonInteractiveDeferredLoadingClientConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;</span><span class=nx>ClientConfigLoadingRules</span><span class=p>{</span><span class=nx>ExplicitPath</span><span class=p>:</span> <span class=nx>kubeconfigPath</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;</span><span class=nx>ConfigOverrides</span><span class=p>{</span><span class=nx>ClusterInfo</span><span class=p>:</span> <span class=nx>clientcmdapi</span><span class=p>.</span><span class=nx>Cluster</span><span class=p>{</span><span class=nx>Server</span><span class=p>:</span> <span class=nx>masterUrl</span><span class=p>}}).</span><span class=nf>ClientConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我们来看看这两个链式函数做了什么事情：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewNonInteractiveDeferredLoadingClientConfig</span><span class=p>(</span><span class=nx>loader</span> <span class=nx>ClientConfigLoader</span><span class=p>,</span> <span class=nx>overrides</span> <span class=o>*</span><span class=nx>ConfigOverrides</span><span class=p>)</span> <span class=nx>ClientConfig</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>DeferredLoadingClientConfig</span><span class=p>{</span><span class=nx>loader</span><span class=p>:</span> <span class=nx>loader</span><span class=p>,</span> <span class=nx>overrides</span><span class=p>:</span> <span class=nx>overrides</span><span class=p>,</span> <span class=nx>icc</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>inClusterClientConfig</span><span class=p>{</span><span class=nx>overrides</span><span class=p>:</span> <span class=nx>overrides</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>NewNonInteractiveDeferredLoadingClientConfig</code> 函数返回一个 <code>ClientConfig</code> 接口的实现: <code>DeferredLoadingClientConfig</code>。<code>DeferredLoadingClientConfig</code> 主要工作是确保装载的 <code>Config</code> 实例使用的是最新 <code>kubeconfig</code> 数据（对于配置了多个集群的，<code>export KUBECONFIG=cluster1-config:cluster2-config</code>，需要执行 merge）。在这个结构体的注释中写道：</p><pre tabindex=0><code>It is used in cases where the loading rules may change after you&#39;ve instantiated them and you want to be sure that the most recent rules are used.  This is useful in cases where you bind flags to loading rule parameters before the parse happens and you want your calling code to be ignorant of how the values are being mutated to avoid passing extraneous information down a call stack

实例化加载规则后，如果要更改加载规则，并且要确保使用最新的规则，则可以使用它。这在以下情况下很有用：
在解析发生之前将标志绑定到加载规则参数，并且您希望您的调用代码不知道值的变化方式，以避免在调用堆栈中传递无关的信息
</code></pre><p>上一个函数返回了 ClientConfig 接口实例。然后调用 ClientConfig 接口定义的 ClientConfig() 方法。ClientConfig() 工作是解析、处理 kubeconfig 文件里的认证信息，并返回一个完整的 rest#Config 实例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ClientConfig implements ClientConfig
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>config</span> <span class=o>*</span><span class=nx>DeferredLoadingClientConfig</span><span class=p>)</span> <span class=nf>ClientConfig</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>restclient</span><span class=p>.</span><span class=nx>Config</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>mergedClientConfig</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>config</span><span class=p>.</span><span class=nf>createClientConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=c1>// load the configuration and return on non-empty errors and if the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// content differs from the default config
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>mergedConfig</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mergedClientConfig</span><span class=p>.</span><span class=nf>ClientConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// check for in-cluster configuration and use it
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>config</span><span class=p>.</span><span class=nx>icc</span><span class=p>.</span><span class=nf>Possible</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Using in-cluster configuration&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>config</span><span class=p>.</span><span class=nx>icc</span><span class=p>.</span><span class=nf>ClientConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// return the result of the merged client config
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>mergedConfig</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这个函数主要有两个重要部分：</p><p>1.<code>mergedClientConfig, err := config.createClientConfig()</code></p><p>内部执行遍历 kubeconfig files （如果有多个）， 对每个 kubeconfig 执行 LoadFromFile 返回 tools/clientcmd/api#Config 实例。api#Config 顾名思义 api 包下的 Config，是把 kubeconfig （eg. $HOME/.kube/config） 序列化为一个 API 资源对象。</p><p>现在,我们看到了几种结构体或接口命名相似，不要混淆了：</p><ul><li>api#Config：序列化 kubeconfig 文件后生成的对象</li><li>tools/clientcmd#ClientConfig：负责用 api#Config 真正创建 rest#Config。处理、解析 kubeconfig 中的认证信息，有了它才能创建 rest#Config，所以命名叫 <strong>Client</strong>Config</li><li>rest#Config：用于创建 http 客户端</li></ul><p>对于 merge 后的 api#Config，调用 NewNonInteractiveClientConfig 创建一个 ClientConfig 接口的实现。</p><p>2.<code>mergedConfig, err := mergedClientConfig.ClientConfig()</code></p><p>真正创建 rest#Config 的地方。在这里解析、处理 kubeconfig 中的认证信息。</p><p>完成 rest client 创建之后，就需要创建 <code>clientset</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>clientset</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>kubernetes</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span></code></pre></div><p>这里的 <code>func NewForConfig(c *rest.Config) (*Clientset, error)</code> 函数会根据 api group 为不同的资源生成客户端。例如这里用到的 deployment 的客户端，定义了deployment的namespace：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>deploymentsClient</span> <span class=o>:=</span> <span class=nx>clientset</span><span class=p>.</span><span class=nf>AppsV1</span><span class=p>().</span><span class=nf>Deployments</span><span class=p>(</span><span class=nx>apiv1</span><span class=p>.</span><span class=nx>NamespaceDefault</span><span class=p>)</span>
</span></span></code></pre></div><p>接下来创建 deployment 的描述信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>deployment</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;demo-deployment&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>Spec</span><span class=p>:</span> <span class=nx>appsv1</span><span class=p>.</span><span class=nx>DeploymentSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Replicas</span><span class=p>:</span> <span class=nf>int32Ptr</span><span class=p>(</span><span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>Selector</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>MatchLabels</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;app&#34;</span><span class=p>:</span> <span class=s>&#34;demo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>Template</span><span class=p>:</span> <span class=nx>apiv1</span><span class=p>.</span><span class=nx>PodTemplateSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>Labels</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;app&#34;</span><span class=p>:</span> <span class=s>&#34;demo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>Spec</span><span class=p>:</span> <span class=nx>apiv1</span><span class=p>.</span><span class=nx>PodSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>Containers</span><span class=p>:</span> <span class=p>[]</span><span class=nx>apiv1</span><span class=p>.</span><span class=nx>Container</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>Name</span><span class=p>:</span>  <span class=s>&#34;web&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nx>Image</span><span class=p>:</span> <span class=s>&#34;nginx:1.12&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nx>Ports</span><span class=p>:</span> <span class=p>[]</span><span class=nx>apiv1</span><span class=p>.</span><span class=nx>ContainerPort</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nx>Name</span><span class=p>:</span>          <span class=s>&#34;http&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=nx>Protocol</span><span class=p>:</span>      <span class=nx>apiv1</span><span class=p>.</span><span class=nx>ProtocolTCP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=nx>ContainerPort</span><span class=p>:</span> <span class=mi>80</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=p>},</span>
</span></span><span class=line><span class=cl>                        <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>创建deployment：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Create Deployment
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Creating deployment...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>deploymentsClient</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>deployment</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>CreateOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Created deployment %q.\n&#34;</span><span class=p>,</span> <span class=nx>result</span><span class=p>.</span><span class=nf>GetObjectMeta</span><span class=p>().</span><span class=nf>GetName</span><span class=p>())</span>
</span></span></code></pre></div><p>这个创建的函数实际上就是调用 HTTP 的 POST 请求来跟K8s集群进行通信的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>deployments</span><span class=p>)</span> <span class=nf>Create</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>deployment</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>,</span> <span class=nx>opts</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>CreateOptions</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>result</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Post</span><span class=p>().</span>
</span></span><span class=line><span class=cl>		<span class=nf>Namespace</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>ns</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Resource</span><span class=p>(</span><span class=s>&#34;deployments&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>VersionedParams</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>scheme</span><span class=p>.</span><span class=nx>ParameterCodec</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Body</span><span class=p>(</span><span class=nx>deployment</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Do</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Into</span><span class=p>(</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>至于post的请求细节，这里不做详细的阐述。</p><p><strong>参考：</strong></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzkzMzE2ODg1MQ==&amp;mid=2247489358&amp;idx=1&amp;sn=7045014044efa1767d6c88340c2d398f&amp;source=41#wechat_redirect" target=_blank rel="noopener noreffer">k8s informer</a></p><p><a href=http://borismattijssen.github.io/articles/kubernetes-informers-controllers-reflectors-stores target=_blank rel="noopener noreffer">Kubernetes: Controllers, Informers, Reflectors and Stores</a></p><p><a href=https://segmentfault.com/a/1190000018953168 target=_blank rel="noopener noreffer">解读 kubernetes client-go 官方 examples</a>](<a href=https://segmentfault.com/a/1190000018953168 target=_blank rel="noopener noreffer">https://segmentfault.com/a/1190000018953168</a>)</p><p><a href=https://qiankunli.github.io/2020/07/20/client_go.html#%E7%AE%80%E4%BB%8B target=_blank rel="noopener noreffer">client-go学习</a></p><p><a href=https://github.com/ofabry/go-callvis target=_blank rel="noopener noreffer">go-callvis</a>：callvis 查看代码调用关系工具，一个不错的调用链可视化工具，可以方便我们分析代码</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-04-06</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://ahamoment.cn/posts/k8s-doc/chapter6/client-go/ data-title="K8s Go 客户端浅析" data-via=xueqiang_chen data-hashtags=kubernetes,client-go><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://ahamoment.cn/posts/k8s-doc/chapter6/client-go/ data-hashtag=kubernetes><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://ahamoment.cn/posts/k8s-doc/chapter6/client-go/ data-title="K8s Go 客户端浅析"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://ahamoment.cn/posts/k8s-doc/chapter6/client-go/ data-title="K8s Go 客户端浅析"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://ahamoment.cn/posts/k8s-doc/chapter6/client-go/ data-title="K8s Go 客户端浅析" data-ralateuid=陈先森cxq><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Evernote" data-sharer=evernote data-url=https://ahamoment.cn/posts/k8s-doc/chapter6/client-go/ data-title="K8s Go 客户端浅析"><i class="fab fa-evernote fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/tags/client-go/>client-go</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/go/go-new-vs-make/ class=prev rel=prev title="Go 语言中的 new 关键字和 make 关键字的区别"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Go 语言中的 new 关键字和 make 关键字的区别</a>
<a href=/posts/k8s-doc/chapter6/resource-model/ class=next rel=next title=Kubernetes的资源模型和资源管理>Kubernetes的资源模型和资源管理<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"XueqiangChen/hugo-comments"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:50},twemoji:!0}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>