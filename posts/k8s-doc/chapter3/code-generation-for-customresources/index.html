<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[译]Kubernetes深入研究：CustomResources的代码生成 - Aha Moment</title><meta name=Description content="软件工程师"><meta property="og:title" content="[译]Kubernetes深入研究：CustomResources的代码生成"><meta property="og:description" content="
原文链接：Kubernetes Deep Dive: Code Generation for CustomResources
"><meta property="og:type" content="article"><meta property="og:url" content="https://ahamoment.cn/posts/k8s-doc/chapter3/code-generation-for-customresources/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-12T10:57:25+08:00"><meta property="article:modified_time" content="2021-03-12T10:57:25+08:00"><meta property="og:site_name" content="Aha Moment"><meta name=twitter:card content="summary"><meta name=twitter:title content="[译]Kubernetes深入研究：CustomResources的代码生成"><meta name=twitter:description content="
原文链接：Kubernetes Deep Dive: Code Generation for CustomResources
"><meta name=application-name content="Aha Moment!"><meta name=apple-mobile-web-app-title content="Aha Moment!"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ahamoment.cn/posts/k8s-doc/chapter3/code-generation-for-customresources/><link rel=prev href=https://ahamoment.cn/posts/k8s-doc/chapter9/code-generation-for-customresources/><link rel=next href=https://ahamoment.cn/posts/go/go-project-catalogs/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[译]Kubernetes深入研究：CustomResources的代码生成","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ahamoment.cn\/posts\/k8s-doc\/chapter3\/code-generation-for-customresources\/"},"genre":"posts","keywords":"kubernetes, codegen","wordcount":5281,"url":"https:\/\/ahamoment.cn\/posts\/k8s-doc\/chapter3\/code-generation-for-customresources\/","datePublished":"2021-03-12T10:57:25+08:00","dateModified":"2021-03-12T10:57:25+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xueqiang.chen"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Aha Moment">Aha Moment!</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Aha Moment">Aha Moment!</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">[译]Kubernetes深入研究：CustomResources的代码生成</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://ahamoment.cn title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xueqiang.chen</a></span>&nbsp;<span class=post-category>included in <a href=/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/><i class="far fa-folder fa-fw" aria-hidden=true></i>云计算</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-03-12>2021-03-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;5281 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;11 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#为什么要使用代码生成>为什么要使用代码生成？</a></li><li><a href=#在你的项目中调用代码生成器>在你的项目中调用代码生成器</a></li><li><a href=#控制生成的代码标签>控制生成的代码–标签</a><ul><li><a href=#global-tags>GLOBAL TAGS</a></li><li><a href=#lacal-tags>LACAL TAGS</a></li><li><a href=#runtimeobject-and-deepcopyobject>runtime.Object and DeepCopyObject</a></li><li><a href=#client-gen-标签>Client-gen 标签</a></li></ul></li><li><a href=#使用类型客户端的主要功能>使用类型客户端的主要功能</a><ul><li><a href=#以编程方式在golang创建自定义资源>以编程方式在GOLANG创建自定义资源</a></li></ul></li></ul></nav></div></div><div class=content id=content><blockquote><p>原文链接：<a href=https://www.openshift.com/blog/kubernetes-deep-dive-code-generation-customresources target=_blank rel="noopener noreffer">Kubernetes Deep Dive: Code Generation for CustomResources</a></p></blockquote><p>CustomResourceDefinitions (CRDs)是kubernetes 1.7 中引入的，并在1.8中从alpha版本升级为beta版本了，最新版本的kubernetes 1.20 中，CRDs的版本已经是v1了。由于CRDs的易用性，在很多实现了控制器模式的例子中都可以看到它的身影。</p><p>在Kubernetes 1.8中， CRDs 在基于golang的项目中的使用也变得更加自然：通过用户提供的 CustomResources，我们可以利用在Kubernetes提供的代码生成工具来生成代码。这篇文章展示了代码生成器的工作方式，以及如何以最少的代码行将其应用到自己的项目中，为您提供了生成的Deepcopy函数，内置的clients，listers和informers，所有这些都带有一个Shell脚本调用和几个代码注释。</p><blockquote><p>注：deepcopy，意为”深拷贝“，深拷贝意味着会重新生成对象并拷贝对象中的所有字段、地址等数据；浅拷贝仅仅是对象的引用，并没有生成新的对象。</p></blockquote><h2 id=为什么要使用代码生成>为什么要使用代码生成？</h2><p>那些在golang中原生使用ThirdPartyResources或CustomResourceDefinition的人可能会惊讶于突然在Kubernetes 1.8中需要生成client-go。更具体地说，client-go要求 runtime.Object 类型（golang中的CustomResources必须实现runtime.Object接口）必须具有DeepCopy方法。这里的代码生成通过deepcopy-gen生成器起作用，可以在<a href=https://github.com/kubernetes/code-generator target=_blank rel="noopener noreffer">k8s.io/code-generator</a>存储库中找到。</p><p>除了deepcopy-gen 生成器外，还有几个代码生成器是大多数CustomResources用户都想使用的：</p><ul><li>deepcopy-gen - 为每个T类型的方法创建<code>func (t* T) DeepCopy() *T</code> 函数</li><li>client-gen - 为 CustomResource APIGroups 创建内置的客户端集</li><li>informer-gen - 为CustomResources创建informer，该informer提供基于事件的界面以对服务器上CustomResources的更改做出反应</li><li>lister-gen - 为CustomResources创建listers，该listers为GET和LIST请求提供只读缓存层。</li></ul><p>最后两个是构建控制器（或Operators）的基础。在后续博客中，我们将更详细地介绍控制器。这四个代码生成器使用与Kubernetes上游控制器所使用的相同的机制和软件包，构成了构建功能齐全，可用于生产环境的控制器的强大基础。</p><p><code>k8s.io/code-generator</code> 中还有其他用于其他上下文的生成器，例如，如果您构建自己的聚合API服务器，则除了版本化类型外，还将使用内部类型。Conversion-gen 将在这些内部和外部类型之间创建转换函数。Defaulter-gen将负责默认某些字段。</p><h2 id=在你的项目中调用代码生成器>在你的项目中调用代码生成器</h2><p>所有的Kubernetes代码生成器都是在<a href=https://github.com/kubernetes/gengo target=_blank rel="noopener noreffer">k8s.io/gengo</a>之上实现的。它们共享许多公共命令行标志。基本上，所有生成器都获得输入包<code>（--input-dirs）</code>的列表，它们通过类型进行检查，并输出生成的代码。生成的代码：</p><ul><li>要么进入与输入文件相同的目录，例如deepcopy-gen （ <code>--output-file-base "zz_generated.deepcopy"</code>定义文件名）</li><li>或者它们生成一个或多个输出包(<code>--output-package</code>)例如 client-, informer- 和 lister-gen 所做的（通常将生成的代码放在 pkg/client 目录下）</li></ul><p>k8s.io/code-generator附带了一个shell脚本<code>generator-group.sh</code>，这个脚本会帮我们处理这些繁重的工作，通常只要调用<code>hack/update-codegen.sh</code>就行，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vendor/k8s.io/code-generator/generate-groups.sh all <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>github.com/openshift-evangelist/crd-code-generation/pkg/client <span class=se>\ </span>
</span></span><span class=line><span class=cl>github.com/openshift-evangelist/crd-code-generation/pkg/apis <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>example.com:v1
</span></span></code></pre></div><p>运行这个命令后生成的目录如下所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/Screen-Shot-2017-10-16-at-17_58_28.webp data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/Screen-Shot-2017-10-16-at-17_58_28.webp, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/Screen-Shot-2017-10-16-at-17_58_28.webp 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/Screen-Shot-2017-10-16-at-17_58_28.webp 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/Screen-Shot-2017-10-16-at-17_58_28.webp title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/Screen-Shot-2017-10-16-at-17_58_28.webp></p><p>所有的 APIs 都被创建到 <code>pkg/apis</code> 目录下，clientsets，informers 以及 listers 被创建到 <code>pkg/client</code> 这个目录下。总而言之，<code>pkg/client</code> 文件夹完全都是生成的，并且包括<code>zz_generated.deepcopy.go</code>这个文件。两者都不应该手动修改，而是通过运行以下命令创建：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ hack/update-codegen.sh
</span></span></code></pre></div><p>这个脚本的<a href=https://github.com/kubernetes/code-generator/tree/master/hack target=_blank rel="noopener noreffer">附近</a>还有一个 <code>hack/verify-codegen.sh</code> 脚本，如果生成的任何文件不是最新的，该脚本都将以非零的返回码终止。这对于放入CI脚本中非常有帮助：如果开发人员无意中修改了文件，或者如果文件刚刚过时，CI会注意到并报错。</p><h2 id=控制生成的代码标签>控制生成的代码–标签</h2><p>如上所述，虽然代码生成器的某些行为是通过命令行标志（尤其是要处理的程序包）来控制的，但更多的属性是通过golang文件中的标签来控制的。</p><p>标签有两种：</p><ul><li>Global tags 相关的在<code>package</code>目录下的<code>doc.go</code>文件中</li><li>Local tags 在它需要处理的类型中定义</li></ul><p>标签通常是 <code>// +tag-name</code> 或者 <code>// +tag-name=value</code> 这两种形式，写在注释中。根据标签，注释的位置变得很重要。大部分的注释的标签应该直接标注在类型上（对于全局标签来说应该在<code>package</code>行中），其他的必须与类型分开，中间至少要有一条空线。</p><h3 id=global-tags>GLOBAL TAGS</h3><p>Global tags 被写入到包的 <code>doc.go</code> 文件中，一个典型的<code>pkg/apis/&lt;apigroup>/&lt;version>/doc.go</code>文件如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// +k8s:deepcopy-gen=package,register
</span></span></span><span class=line><span class=cl><span class=c1>// Package v1 is the v1 version of the API.
</span></span></span><span class=line><span class=cl><span class=c1>// +groupName=example.com
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>v1</span>
</span></span></code></pre></div><p>它告诉deepcopy-gen默认为该包中的每种类型创建Deepcopy方法。如果你的类型中不需要生成deepcopy方法，可以使用local tag来关闭<code>// +k8s:deepcopy-gen=false</code>。如果你不在包的声明中使用生成 deepcopy 方法，就需要通过在每个类型的注释中定义 <code>// +k8s:deepcopy-gen=false</code>。</p><blockquote><p>注意：上例中的值中的 <code>register</code> 关键字将使deepcopy方法注册到该scheme中。在Kubernetes 1.9中被取消了，因为该scheme将不再负责执行<code>runtime.Objects</code>的深层复制。取而代之的是调用 <code>yourobject.DeepCopy()</code> 或者 <code>yourobject.DeepCopyObject()</code>。</p><p>Scheme定义了序列化和反序列化API对象的方法，用于将group、版本和类型信息转换为Go模式和从Go模式转换为Go模式的类型注册表，以及不同版本的Go模式之间的映射。</p></blockquote><p>最后，<code>// +groupName=example.com</code> 定义了API 组的全限定名称。如果你写错了这个名称，client-gen 会生成错误的代码。另外这个标签必须在包上的注释块中。</p><h3 id=lacal-tags>LACAL TAGS</h3><p>本地标记要么直接写在API类型上方，要么写在它上方的第二个注释块中。如下的 <code>types.go</code> 文件所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// +genclient
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// +genclient:noStatus
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span><span class=line><span class=cl><span class=c1>// Database describes a database.
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=kd>type</span> <span class=nx>Database</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span> <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=cl>     <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span> <span class=s>`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>     <span class=nx>Spec</span> <span class=nx>DatabaseSpec</span> <span class=s>`json:&#34;spec&#34;`</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// DatabaseSpec is the spec for a Foo resource
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=kd>type</span> <span class=nx>DatabaseSpec</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nx>User</span> <span class=kt>string</span> <span class=s>`json:&#34;user&#34;`</span>
</span></span><span class=line><span class=cl>     <span class=nx>Password</span> <span class=kt>string</span> <span class=s>`json:&#34;password&#34;`</span>
</span></span><span class=line><span class=cl>     <span class=nx>Encoding</span> <span class=kt>string</span> <span class=s>`json:&#34;encoding,omitempty&#34;`</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// DatabaseList is a list of Database resources
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=kd>type</span> <span class=nx>DatabaseList</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span> <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=cl>     <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListMeta</span> <span class=s>`json:&#34;metadata&#34;`</span>
</span></span><span class=line><span class=cl>     <span class=nx>Items</span> <span class=p>[]</span><span class=nx>Database</span> <span class=s>`json:&#34;items&#34;`</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span></code></pre></div><p>请注意，默认情况下，我们为所有类型启用了deepcopy，也就是说，可以选择不使用 deepcopy。但是，这些类型都是API类型，需要深度复制。因此，在此示例types.go中，我们不必打开或关闭deepcopy，而仅在<code>doc.go</code>中的程序包范围内即可。</p><h3 id=runtimeobject-and-deepcopyobject>runtime.Object and DeepCopyObject</h3><p>有一个特殊的 deepcopy 标签，需要更多说明：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span></code></pre></div><p>如果您尝试将CustomResources与基于Kubernetes 1.8的客户端一起使用，有些人可能已经很高兴，因为他们不小心出售了master分支的k8s.op/apimachinery，您遇到了由于CustomResource类型未实现runtime.Object而导致的编译器错误，因为未在您的类型上定义DeepCopyObject（）runtime.Object。原因是在1.8中，<code>runtime.Object</code>接口使用此方法签名进行了扩展，因此每个<code>runtime.Objec</code>t都必须实现<code>DeepCopyObject</code>。 <code>DeepCopyObject（）runtime.Object</code>的实现很简单：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>in</span> <span class=o>*</span><span class=nx>T</span><span class=p>)</span> <span class=nf>DeepCopyObject</span><span class=p>()</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>c</span> <span class=o>:=</span> <span class=nx>in</span><span class=p>.</span><span class=nf>DeepCopy</span><span class=p>();</span> <span class=nx>c</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>c</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>但幸运的是，您不必为每种类型都实现此功能，而只需将以下本地标记放在顶级API类型的上方：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span></code></pre></div><p>在上面的示例中，<code>Database</code> 和<code>DatabaseList</code>都是顶级类型，因为它们被用作runtime.Objects。根据经验，顶级类型是那些嵌入了<code>metav1.TypeMeta</code>的类型。同样，这些是客户端使用client-gen创建的类型。</p><p>请注意，<code>// + k8s：deepcopy-gen：interfaces</code> 标记可以并且也应该在定义具有某些接口类型的字段（例如，<code>field SomeInterface</code>）的API类型的情况下使用。然后<code>// + k8s：deepcopy-gen：interfaces=example.com/pkg/apis/example.SomeInterface</code>将导致<code>DeepeepSomeInterface（）SomeInterface</code>方法的生成。这允许它以类型正确的方式对这些字段进行深度复制。</p><h3 id=client-gen-标签>Client-gen 标签</h3><p>最后，有许多标记可控制client-gen，在我们的示例中可以看到其中两个：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// +genclient
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// +genclient:noStatus
</span></span></span></code></pre></div><p>第一个标记告诉client-gen为该类型创建一个客户端（始终启用）。请注意，您不必将其放在API对象的列表类型上方。</p><p>第二个标记告诉client-gen该类型未通过<code>/status</code>子资源使用规范状态分隔。生成的客户端将没有<code>UpdateStatus</code>方法（client-gen一旦在您的结构中找到<code>Status</code>字段，就会盲目生成该方法）。<code> /status</code>子资源仅在1.8中才适用于本地（在golang中）实现的资源。但是，随着PR 913中为CustomResources讨论子资源，这种情况可能很快就会改变。</p><p>对于群集范围的资源，必须使用标签：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// +genclient:nonNamespaced
</span></span></span></code></pre></div><p>对于特殊用途的客户端，您可能还希望详细控制客户端提供哪些HTTP方法。可以使用几个标签来完成此操作，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// +genclient:noVerbs
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// +genclient:onlyVerbs=create,delete
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// +genclient:skipVerbs=get,list,create,update,patch,delete,deleteCollection,watch
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// +genclient:method=Create,verb=create,result=k8s.io/apimachinery/pkg/apis/meta/v1.Status
</span></span></span></code></pre></div><p>前三个应该是不言自明的，但是最后一个需要一些解释。上面写入此标记的类型将是仅创建的，并且不会返回API类型本身，而是metav1.Status。对于CustomResources来说，这没有多大意义，但是对于用golang编写的用户提供的API服务器，这些资源可以存在，并且实际上可以在OpenShift API中使用。</p><h2 id=使用类型客户端的主要功能>使用类型客户端的主要功能</h2><p>尽管大多数基于Kubernetes 1.7和更早版本的示例都使用了<code>Client-go dynamic client</code> 作为CustomResources，但在很长一段时间内，本地Kubernetes API类型的类型化客户端都更加方便。在1.8版中进行了更改：如上所述，client-gen还为您的自定义类型创建了native，功能齐全且易于使用的类型化客户端。实际上，client-gen不知道您是将其应用于CustomResource类型还是native类型。
因此，使用此客户端与使用客户端Gober客户端完全等效。这是一个非常简单的示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>examplecomclientset</span> <span class=s>&#34;github.com/openshift-evangelist/crd-code-generation/pkg/client/clientset/versioned&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=nx>kuberconfig</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;kubeconfig&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;Path to a kubeconfig. Only required if out-of-cluster.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>master</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;master&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;The address of the Kubernetes API server. Overrides any value in kubeconfig. Only required if out-of-cluster.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>cfg</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientcmd</span><span class=p>.</span><span class=nf>BuildConfigFromFlags</span><span class=p>(</span><span class=o>*</span><span class=nx>master</span><span class=p>,</span> <span class=o>*</span><span class=nx>kuberconfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> 	<span class=nx>glog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error building kubeconfig: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>exampleClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>examplecomclientset</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> 	<span class=nx>glog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error building example clientset: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>list</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span>  <span class=nx>exampleClient</span><span class=p>.</span><span class=nf>ExampleV1</span><span class=p>().</span><span class=nf>Databases</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOpti</span> <span class=nx>ons</span><span class=p>{})</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> 	<span class=nx>glog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error listing all databases: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>db</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>list</span><span class=p>.</span><span class=nx>Items</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> 	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;database %s with user %q\n&#34;</span><span class=p>,</span> <span class=nx>db</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>db</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>User</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span></code></pre></div><p>它与kubeconfig文件一起使用，实际上可以与kubectl和Kubernetes客户端一起使用。</p><p>与动态客户端使用的旧版TPR或CustomResource代码相比，您无需进行类型转换。相反，实际的客户端调用看起来完全是本地的，它是：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>list</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>exampleClient</span><span class=p>.</span><span class=nf>ExampleV1</span><span class=p>().</span><span class=nf>Databases</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{})</span>
</span></span></code></pre></div><p>在此示例中，结果是群集中所有数据库的<code>DatabaseList</code>。如果您将类型切换为集群范围（即没有命名空间；请不要忘记使用<code>// + genclientnonNamespaced</code>标记告诉client-gen！），调用将变成</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>list</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>exampleClient</span><span class=p>.</span><span class=nf>ExampleV1</span><span class=p>().</span><span class=nf>Databases</span><span class=p>().</span><span class=nf>List</span><span class=p>(</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{})</span>
</span></span></code></pre></div><h3 id=以编程方式在golang创建自定义资源>以编程方式在GOLANG创建自定义资源</h3><p>由于这个问题经常出现，因此请您谈谈如何从您的golang代码中以编程方式创建CRD的几句话。</p><p>客户代总是创建所谓的clinetsets。客户端集将一个或多个API组捆绑到一个客户端中。通常，这些API组来自一个存储库，并位于一个基本程序包中，例如，如本博文示例中的<code>pkg/apis</code>；对于Kubernetes，则来自<code>k8s.io/api</code>。</p><p>CustomResourceDefinitions由
<a href=https://github.com/kubernetes/apiextensions-apiserver target=_blank rel="noopener noreffer">kubernetes/apiextensions-apiserver存储库</a>。该API服务器（也可以独立启动）是由kube-apiserver嵌入的，因此CRD在每个Kubernetes群集上都可用。但是创建CRD的客户端会创建到apiextensions-apiserver存储库中，当然也要使用client-gen。阅读此博客后，您可以在<code>kubernetes/apiextensions-apiserver/tree/master/pkg/client</code>上找到客户端也不会感到惊讶，创建客户端实例以及如何创建CRD看起来也不奇怪：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>apiextensionsclientset</span> <span class=err>&#34;</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>apiextensions</span><span class=o>-</span><span class=nx>apiserver</span><span class=o>/</span><span class=nx>pkg</span><span class=o>/</span><span class=nx>client</span><span class=o>/</span><span class=nx>clientset</span><span class=o>/</span><span class=nx>clientset</span><span class=err>”</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>apiextensionsClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>apiextensionsclientset</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=o>...</span>
</span></span><span class=line><span class=cl> <span class=nx>createdCRD</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>apiextensionsClient</span><span class=p>.</span><span class=nf>ApiextensionsV1beta1</span><span class=p>().</span><span class=nf>CustomResourceDefinitions</span><span class=p>().</span><span class=nf>Create</span><span class=p>(</span><span class=nx>yourCRD</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span></code></pre></div><p>请注意，创建完成后，您将必须等待在新CRD上设置“已建立”条件。只有这样，kube-apiserver才会开始提供资源。如果您不等待该条件，则每次CR操作都会返回404 HTTP状态代码。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-03-12</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://ahamoment.cn/posts/k8s-doc/chapter3/code-generation-for-customresources/ data-title=[译]Kubernetes深入研究：CustomResources的代码生成 data-via=xueqiang_chen data-hashtags=kubernetes,codegen><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://ahamoment.cn/posts/k8s-doc/chapter3/code-generation-for-customresources/ data-hashtag=kubernetes><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://ahamoment.cn/posts/k8s-doc/chapter3/code-generation-for-customresources/ data-title=[译]Kubernetes深入研究：CustomResources的代码生成><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://ahamoment.cn/posts/k8s-doc/chapter3/code-generation-for-customresources/ data-title=[译]Kubernetes深入研究：CustomResources的代码生成><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://ahamoment.cn/posts/k8s-doc/chapter3/code-generation-for-customresources/ data-title=[译]Kubernetes深入研究：CustomResources的代码生成 data-ralateuid=陈先森cxq><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Evernote" data-sharer=evernote data-url=https://ahamoment.cn/posts/k8s-doc/chapter3/code-generation-for-customresources/ data-title=[译]Kubernetes深入研究：CustomResources的代码生成><i class="fab fa-evernote fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/tags/codegen/>codegen</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/k8s-doc/chapter9/code-generation-for-customresources/ class=prev rel=prev title=[译]Kubernetes深入研究：CustomResources的代码生成><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>[译]Kubernetes深入研究：CustomResources的代码生成</a>
<a href=/posts/go/go-project-catalogs/ class=next rel=next title="Go 语言工作目录">Go 语言工作目录<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"XueqiangChen/hugo-comments"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:50},twemoji:!0}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>