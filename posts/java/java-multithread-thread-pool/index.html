<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Java 多线程 - 自定义线程池 - Aha Moment</title><meta name=Description content="软件工程师"><meta property="og:title" content="Java 多线程 - 自定义线程池"><meta property="og:description" content="1. 为什么要用线程池？ 池化技术相比大家已经屡见不鲜了，线程池、数据库连接池、Http 连接池等等都是对这个思想的应用。池化技术的思想主要是为了减"><meta property="og:type" content="article"><meta property="og:url" content="https://ahamoment.cn/posts/java/java-multithread-thread-pool/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-12T10:22:13+08:00"><meta property="article:modified_time" content="2020-11-12T10:22:13+08:00"><meta property="og:site_name" content="Aha Moment"><meta name=twitter:card content="summary"><meta name=twitter:title content="Java 多线程 - 自定义线程池"><meta name=twitter:description content="1. 为什么要用线程池？ 池化技术相比大家已经屡见不鲜了，线程池、数据库连接池、Http 连接池等等都是对这个思想的应用。池化技术的思想主要是为了减"><meta name=application-name content="Aha Moment!"><meta name=apple-mobile-web-app-title content="Aha Moment!"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ahamoment.cn/posts/java/java-multithread-thread-pool/><link rel=prev href=https://ahamoment.cn/posts/java/java-multithread-thread-lifecycle/><link rel=next href=https://ahamoment.cn/posts/tool/tool-git-common-operations/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Java 多线程 - 自定义线程池","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ahamoment.cn\/posts\/java\/java-multithread-thread-pool\/"},"genre":"posts","keywords":"多线程, 线程池","wordcount":4475,"url":"https:\/\/ahamoment.cn\/posts\/java\/java-multithread-thread-pool\/","datePublished":"2020-11-12T10:22:13+08:00","dateModified":"2020-11-12T10:22:13+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xueqiang.chen"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Aha Moment">Aha Moment!</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Aha Moment">Aha Moment!</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Java 多线程 - 自定义线程池</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://ahamoment.cn title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xueqiang.chen</a></span>&nbsp;<span class=post-category>included in <a href=/categories/java/><i class="far fa-folder fa-fw" aria-hidden=true></i>java</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2020-11-12>2020-11-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;4475 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;9 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-为什么要用线程池>1. 为什么要用线程池？</a></li><li><a href=#2-自定义一个简单的线程池>2. 自定义一个简单的线程池</a><ul><li><a href=#21-线程池实现类图>2.1 线程池实现类图</a></li><li><a href=#22-threadpool>2.2 ThreadPool</a></li><li><a href=#23-runnablequeue>2.3 RunnableQueue</a></li><li><a href=#24-threadfactory>2.4 ThreadFactory</a></li><li><a href=#25-拒绝策略denypolicy>2.5 拒绝策略（DenyPolicy）</a></li><li><a href=#26-internaltask>2.6 InternalTask</a></li><li><a href=#27-线程池详细实现>2.7 线程池详细实现</a></li></ul></li><li><a href=#3-线程池的应用>3. 线程池的应用</a></li><li><a href=#4-参考>4. 参考</a></li></ul></nav></div></div><div class=content id=content><h2 id=1-为什么要用线程池>1. 为什么要用线程池？</h2><blockquote><p><strong>池化技术相比大家已经屡见不鲜了，线程池、数据库连接池、Http 连接池等等都是对这个思想的应用。池化技术的思想主要是为了减少每次获取资源的消耗，提高对资源的利用率。</strong></p></blockquote><p><strong>线程池</strong>提供了一种限制和管理资源（包括执行一个任务）。 每个<strong>线程池</strong>还维护一些基本统计信息，例如已完成任务的数量。</p><p>这里借用《Java 并发编程的艺术》提到的来说一下<strong>使用线程池的好处</strong>：</p><ul><li><strong>降低资源消耗</strong>。通过重复利用已创建的线程降低线程创建和销毁造成的消耗。</li><li><strong>提高响应速度</strong>。当任务到达时，任务可以不需要的等到线程创建就能立即执行。</li><li><strong>提高线程的可管理性</strong>。线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控。</li></ul><h2 id=2-自定义一个简单的线程池>2. 自定义一个简单的线程池</h2><p>一个线程池应该具备以下要素：</p><ul><li>任务队列：用于缓存提交的任务。</li><li>任务线程管理功能：一个线程池必须能够很好地管理和控制线程数量，可通过如下三个参数来实现，比如创建线程池时初始的线程数量init；线程池自动扩充时最大的线程数量max；在线程池空闲时需要释放线程但是也要维护一定数量的活跃数量或者核心数量core。有了这三个参数，就能够很好地控制线程池中的线程数量，将其维护在一个合理的范围之内，三者之间的关系是init＜=core＜=max。</li><li>任务拒绝策略：如果线程数量已达到上限且任务队列已满，则需要有相应的拒绝策略来通知任务提交者。</li><li>线程工厂：主要用于个性化定制线程，比如将线程设置为守护线程以及设置线程名称等。</li><li>QueueSize：任务队列主要存放提交的Runnable，但是为了防止内存溢出，需要有limit数量对其进行控制。</li><li>Keepedalive时间：该时间主要决定线程各个重要参数自动维护的时间间隔。</li></ul><h3 id=21-线程池实现类图>2.1 线程池实现类图</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/threadpool.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/threadpool.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/threadpool.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/threadpool.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/threadpool.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/threadpool.png></p><p>上图为线程池实现类图，下面看具体的代码。</p><h3 id=22-threadpool>2.2 ThreadPool</h3><p>先定义一个线程池接口，定义常用的方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>ThreadPool</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>//提交任务到线程池
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>void</span> <span class=nf>execute</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 关闭线程池
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>void</span> <span class=nf>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取线程池的初始化大小
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=nf>getInitSize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取线程池的最大线程数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=nf>getMaxSize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取线程池的核心线程数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=nf>getCoreSize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取线程池中用于缓存任务队列的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=nf>getQueueSize</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取线程池中活跃线程的数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=nf>getActiveCount</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 查看线程池是否已经被shutdown
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>boolean</span> <span class=nf>isShutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=23-runnablequeue>2.3 RunnableQueue</h3><p>我们需要一个任务队列，用来存放提交的任务，该队列是一个BlockedQueue，并且有limit的限制。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>RunnableQueue</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// 当有新任务进来时首先会offer到队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=kt>void</span> <span class=nf>offer</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// 工作线程通过take方法获取Runnable
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>Runnable</span> <span class=nf>take</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// 获取任务队列中任务的数量
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=kt>int</span> <span class=nf>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=24-threadfactory>2.4 ThreadFactory</h3><p>ThreadFactory提供了创建线程的接口，以便于个性化地定制Thread，比如Thread应该被加到哪个Group中，优先级、线程名字以及是否为守护线程等。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@FunctionalInterface</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>ThreadFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>Thread</span> <span class=nf>createThread</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=25-拒绝策略denypolicy>2.5 拒绝策略（DenyPolicy）</h3><p>DenyPolicy主要用于当Queue中的runnable达到了limit上限时，决定采用何种策略通知提交者。该接口中定义了三种默认的实现。</p><ol><li>DiscardDenyPolicy：直接将任务丢弃。</li><li>AbortDenyPolicy：向任务提交者抛出异常。</li><li>RunnerDenyPolicy：使用提交者所在的线程执行任务。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>DenyPolicy</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=nf>reject</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>,</span> <span class=n>ThreadPool</span> <span class=n>threadPool</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * 该拒绝策略会直接将任务丢弃
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>class</span> <span class=nc>DiscardDenyPolicy</span> <span class=kd>implements</span> <span class=n>DenyPolicy</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=kt>void</span> <span class=nf>reject</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>,</span> <span class=n>ThreadPool</span> <span class=n>threadPool</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>//do nothing
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;task will be discard&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * 该拒绝策略会向任务提交者抛出异常
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>class</span> <span class=nc>AbortDenyPolicy</span> <span class=kd>implements</span> <span class=n>DenyPolicy</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=kt>void</span> <span class=nf>reject</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>,</span> <span class=n>ThreadPool</span> <span class=n>threadPool</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>RunnableDenyException</span><span class=o>(</span><span class=s>&#34;The Runnable &#34;</span> <span class=o>+</span> <span class=n>runnable</span> <span class=o>+</span> <span class=s>&#34; will be abort.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * 该拒绝策略会使任务在提交者所在的线程中执行任务
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>class</span> <span class=nc>RunnerDenyPolicy</span> <span class=kd>implements</span> <span class=n>DenyPolicy</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=kt>void</span> <span class=nf>reject</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>,</span> <span class=n>ThreadPool</span> <span class=n>threadPool</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(!</span><span class=n>threadPool</span><span class=o>.</span><span class=na>isShutdown</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>runnable</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>这里还定义了一个 RunnableDenyException ，主要用于通知任务提交者，任务队列已经无法再接收新的任务。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RunnableDenyException</span> <span class=kd>extends</span> <span class=n>RuntimeException</span><span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=nf>RunnableDenyException</span><span class=o>(</span><span class=n>String</span> <span class=n>message</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>super</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=26-internaltask>2.6 InternalTask</h3><p>InternalTask是Runnable的一个实现，是实际任务存储的数据结构。主要用于线程池内部，该类会使用到RunnableQueue，然后不断地从queue中取出某个runnable，并运行runnable的run方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>InternalTask</span> <span class=kd>implements</span> <span class=n>Runnable</span><span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>RunnableQueue</span> <span class=n>runnableQueue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>running</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=nf>InternalTask</span><span class=o>(</span><span class=n>RunnableQueue</span> <span class=n>runnableQueue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>runnableQueue</span> <span class=o>=</span> <span class=n>runnableQueue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果当前任务为running并且没有被中断，则其将不断地从queue中获取runnable，然后执行run方法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 这是提交到线程池的任务最终运行的地方
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>while</span> <span class=o>(</span><span class=n>running</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>isInterrupted</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Runnable</span> <span class=n>task</span> <span class=o>=</span> <span class=n>runnableQueue</span><span class=o>.</span><span class=na>take</span><span class=o>();</span>
</span></span><span class=line><span class=cl>				<span class=n>task</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>running</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 停止当前任务，主要会在线程池的shutdown方法中使用
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>stop</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>running</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>代码还对该类增加了一个开关方法stop，主要用于停止当前线程，一般在线程池销毁和线程数量维护的时候会使用到。</p><h3 id=27-线程池详细实现>2.7 线程池详细实现</h3><p>在LinkedRunnableQueue中有几个重要的属性，第一个是limit，也就是Runnable队列的上限；当提交的Runnable数量达到limit上限时，则会调用DenyPolicy的reject方法；runnableList是一个双向循环列表，用于存放Runnable任务</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LinkedRunnableQueue</span> <span class=kd>implements</span> <span class=n>RunnableQueue</span><span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 任务队列的最大容量，在构造时传入
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>limit</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 若任务队列已满，则执行拒绝策略
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>DenyPolicy</span> <span class=n>denyPolicy</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 存放任务的队列
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>runnableList</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>ThreadPool</span> <span class=n>threadPool</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=nf>LinkedRunnableQueue</span><span class=o>(</span><span class=kt>int</span> <span class=n>limit</span><span class=o>,</span> <span class=n>DenyPolicy</span> <span class=n>denyPolicy</span><span class=o>,</span> <span class=n>ThreadPool</span> <span class=n>threadPool</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>limit</span> <span class=o>=</span> <span class=n>limit</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>denyPolicy</span>  <span class=o>=</span> <span class=n>denyPolicy</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>threadPool</span> <span class=o>=</span> <span class=n>threadPool</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>offer</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>synchronized</span> <span class=o>(</span><span class=n>runnableList</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>runnableList</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>&gt;=</span> <span class=n>limit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 无法容纳新的任务，执行拒绝策略
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>denyPolicy</span><span class=o>.</span><span class=na>reject</span><span class=o>(</span><span class=n>runnable</span><span class=o>,</span> <span class=n>threadPool</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 将任务加入队尾，并且唤醒阻塞中的线程
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>runnableList</span><span class=o>.</span><span class=na>addLast</span><span class=o>(</span><span class=n>runnable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=n>runnableList</span><span class=o>.</span><span class=na>notifyAll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * take方法也是同步方法，线程不断从队列中获取Runnable任务，当队列为空的时候工作线程会陷入阻塞，
</span></span></span><span class=line><span class=cl><span class=cm>	 * 有可能在阻塞的过程中被中断，为了传递中断信号需要在catch语句块中将异常抛出以通知上游（InternalTask）
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return 任务
</span></span></span><span class=line><span class=cl><span class=cm>	 * @throws InterruptedException 中断异常，通知上游(InternalTask)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>Runnable</span> <span class=nf>take</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>synchronized</span> <span class=o>(</span><span class=n>runnableList</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>while</span> <span class=o>(</span><span class=n>runnableList</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// 如果任务队列中没有可执行任务，则当前线程挂起，进入runnableList关联的monitor waitset中等待唤醒
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=n>runnableList</span><span class=o>.</span><span class=na>wait</span><span class=o>();</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// 被中断时需要将异常抛出
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 从任务队列头排除一个任务
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=n>runnableList</span><span class=o>.</span><span class=na>removeFirst</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>int</span> <span class=nf>size</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>runnableList</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>根据前面的讲解，线程池需要有数量控制属性、创建线程工厂、任务队列策略等功能，线程池初始化代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BasicThreadPool</span> <span class=kd>extends</span> <span class=n>Thread</span> <span class=kd>implements</span> <span class=n>ThreadPool</span><span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 初始化线程数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>initSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 线程池最大数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 线程池核心线程数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>coreSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 当前活跃的线程数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kt>int</span> <span class=n>activeCount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建线程所需的工厂
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>ThreadFactory</span> <span class=n>threadFactory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 任务队列
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>RunnableQueue</span> <span class=n>runnableQueue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 线程池是否已经被shutdown
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>isShutdown</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 工作线程队列
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>Queue</span><span class=o>&lt;</span><span class=n>ThreadTask</span><span class=o>&gt;</span> <span class=n>threadQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayDeque</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=kd>static</span> <span class=n>DenyPolicy</span> <span class=n>DEFAULT_DENY_POLICY</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DenyPolicy</span><span class=o>.</span><span class=na>DiscardDenyPolicy</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=kd>static</span> <span class=n>ThreadFactory</span> <span class=n>DEFAULT_THREAD_FACTORY</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultThreadFactory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>keepAliveTime</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>TimeUnit</span> <span class=n>timeUnit</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 构造时需要传递的参数：初始的线程数量，最大的线程数量，核心线程数量，任务队列的最大数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>public</span> <span class=nf>BasicThreadPool</span><span class=o>(</span><span class=kt>int</span> <span class=n>initSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>maxSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>coreSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>queueSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>(</span><span class=n>initSize</span><span class=o>,</span> <span class=n>maxSize</span><span class=o>,</span> <span class=n>coreSize</span><span class=o>,</span> <span class=n>DEFAULT_THREAD_FACTORY</span><span class=o>,</span> <span class=n>queueSize</span><span class=o>,</span> <span class=n>DEFAULT_DENY_POLICY</span><span class=o>,</span> <span class=n>10</span> <span class=o>,</span><span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 构造线程池时需要传入的参数，该构造函数需要的参数比较多
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>public</span> <span class=nf>BasicThreadPool</span><span class=o>(</span><span class=kt>int</span> <span class=n>initSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>maxSize</span><span class=o>,</span> <span class=kt>int</span> <span class=n>coreSize</span><span class=o>,</span> <span class=n>ThreadFactory</span> <span class=n>threadFactory</span><span class=o>,</span> <span class=kt>int</span> <span class=n>queueSize</span><span class=o>,</span> <span class=n>DenyPolicy</span> <span class=n>denyPolicy</span><span class=o>,</span> <span class=kt>long</span> <span class=n>keepAliveTime</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>timeUnit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>initSize</span> <span class=o>=</span> <span class=n>initSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>maxSize</span> <span class=o>=</span> <span class=n>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>coreSize</span> <span class=o>=</span> <span class=n>coreSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>threadFactory</span> <span class=o>=</span> <span class=n>threadFactory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>runnableQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedRunnableQueue</span><span class=o>(</span><span class=n>queueSize</span><span class=o>,</span> <span class=n>denyPolicy</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>keepAliveTime</span> <span class=o>=</span> <span class=n>keepAliveTime</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>timeUnit</span> <span class=o>=</span> <span class=n>timeUnit</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>init</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 初始化时，先创建 initSize 个线程
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kt>void</span> <span class=nf>init</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>initSize</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>newThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kt>void</span> <span class=nf>newThread</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>//创建任务线程，并且启动
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>InternalTask</span> <span class=n>internalTask</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalTask</span><span class=o>(</span><span class=n>runnableQueue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>threadFactory</span><span class=o>.</span><span class=na>createThread</span><span class=o>(</span><span class=n>internalTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=n>ThreadTask</span> <span class=n>threadTask</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadTask</span><span class=o>(</span><span class=n>thread</span><span class=o>,</span> <span class=n>internalTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=n>threadQueue</span><span class=o>.</span><span class=na>offer</span><span class=o>(</span><span class=n>threadTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>activeCount</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>		<span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kt>void</span> <span class=nf>removeThread</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 从线程池中移除某个线程
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>ThreadTask</span> <span class=n>threadTask</span> <span class=o>=</span> <span class=n>threadQueue</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=n>threadTask</span><span class=o>.</span><span class=na>internalTask</span><span class=o>.</span><span class=na>stop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>activeCount</span><span class=o>--;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;The thread pool is destroy&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 提交任务只是简单地往任务队列中插入Runnable
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>this</span><span class=o>.</span><span class=na>runnableQueue</span><span class=o>.</span><span class=na>offer</span><span class=o>(</span><span class=n>runnable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// run 方法继承自Thread，主要用于维护线程数量，比如扩容、回收工作
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>while</span> <span class=o>(!</span><span class=n>isShutdown</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isInterrupted</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>timeUnit</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>keepAliveTime</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>isShutdown</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=n>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>//当前队列中有尚未处理，并且activeCount&lt;coreSize则继续扩容
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=o>(</span><span class=n>runnableQueue</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>&gt;</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=n>activeCount</span> <span class=o>&lt;</span> <span class=n>coreSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>initSize</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>coreSize</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>newThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>					<span class=c1>// continue 的目的在于不想让线程的扩容直接达到maxsize
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 当前队列中有任务尚未处理，并且activeCount&lt;maxSize则继续扩容
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=o>(</span><span class=n>runnableQueue</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>&gt;</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=n>activeCount</span> <span class=o>&lt;</span> <span class=n>maxSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>coreSize</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>maxSize</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>newThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=c1>// 如果任务队列中没有任务，则需要回收，回收至coreSize即可
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=o>(</span><span class=n>runnableQueue</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>==</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=n>activeCount</span> <span class=o>&gt;</span> <span class=n>coreSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>coreSize</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>activeCount</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>removeThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>//ThreadTask 只是InternalTask和Thread的一个组合
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>ThreadTask</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Thread</span> <span class=n>thread</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=n>InternalTask</span> <span class=n>internalTask</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=nf>ThreadTask</span><span class=o>(</span><span class=n>Thread</span> <span class=n>thread</span><span class=o>,</span> <span class=n>InternalTask</span> <span class=n>internalTask</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>thread</span> <span class=o>=</span> <span class=n>thread</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>internalTask</span> <span class=o>=</span> <span class=n>internalTask</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * 销毁线程池主要为了是停止BasicThreadPool线程，停止线程池中的活动线程并且将isShutdown开关变量更改为true。
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>shutdown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>isShutdown</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=n>threadQueue</span><span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>threadTask</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>threadTask</span><span class=o>.</span><span class=na>internalTask</span><span class=o>.</span><span class=na>stop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>				<span class=n>threadTask</span><span class=o>.</span><span class=na>thread</span><span class=o>.</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>int</span> <span class=nf>getInitSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;The thread pool is destroy&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>initSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>int</span> <span class=nf>getMaxSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;The thread pool is destroy&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>maxSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>int</span> <span class=nf>getCoreSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;The thread pool is destroy&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>coreSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>int</span> <span class=nf>getQueueSize</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>isShutdown</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;The thread pool is destroy&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>runnableQueue</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>int</span> <span class=nf>getActiveCount</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>activeCount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isShutdown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>isShutdown</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>DefaultThreadFactory</span> <span class=kd>implements</span> <span class=n>ThreadFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>AtomicInteger</span> <span class=n>GROUP_COUNTER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>ThreadGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadGroup</span><span class=o>(</span><span class=s>&#34;MyThreadPool-&#34;</span> <span class=o>+</span> <span class=n>GROUP_COUNTER</span><span class=o>.</span><span class=na>getAndIncrement</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>AtomicInteger</span> <span class=n>COUNTER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=n>Thread</span> <span class=nf>createThread</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>group</span><span class=o>,</span> <span class=n>runnable</span><span class=o>,</span> <span class=s>&#34;thread-pool-&#34;</span> <span class=o>+</span> <span class=n>COUNTER</span><span class=o>.</span><span class=na>getAndIncrement</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>自动维护线程的代码块是同步代码块，主要是为了阻止在线程维护过程中线程池销毁引起的数据不一致问题。</p><p>任务队列中若存在积压任务，并且当前活动线程少于核心线程数，则新建 <code>coreSize-initSize</code>数量的线程，并且将其加入到活动线程队列中，为了防止马上进行<code>maxSize-coreSize</code>数量的扩充，建议使用<code>continue</code>终止本次循环。</p><p>任务队列中有积压任务，并且当前活动线程少于最大线程数，则新建<code>maxSize-coreSize</code>数量的线程，并且将其加入到活动队列中。</p><p>当前线程池不够繁忙时，则需要回收部分线程，回收到<code>coreSize</code>数量即可，回收时调用<code>removeThread()</code>方法，在该方法中需要考虑的一点是，如果被回收的线程恰巧从<code>Runnable</code>任务取出了某个任务，则会继续保持该线程的运行，直到完成了任务的运行为止，详见<code>InternalTask</code>的run方法。</p><h2 id=3-线程池的应用>3. 线程池的应用</h2><p>写一个简单的程序分别测试线程池的任务提交、线程池线程数量的动态扩展，以及线程池的销毁功能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThreadPoolTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>//定义线程池，初始化线程数为2，核心线程数为4，最大线程数位6，任务队列最多允许1000个任务
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kd>final</span> <span class=n>ThreadPool</span> <span class=n>threadPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicThreadPool</span><span class=o>(</span><span class=n>2</span><span class=o>,</span> <span class=n>6</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 定义20个任务并且提交给线程池
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>20</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>threadPool</span><span class=o>.</span><span class=na>execute</span><span class=o>(()-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; is running and done.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>});</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=o>(;</span> <span class=o>;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>//不断输出线程池的信息
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;getActiveCount: &#34;</span> <span class=o>+</span> <span class=n>threadPool</span><span class=o>.</span><span class=na>getActiveCount</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;getQueueSize: &#34;</span> <span class=o>+</span> <span class=n>threadPool</span><span class=o>.</span><span class=na>getQueueSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;getCoreSize: &#34;</span> <span class=o>+</span> <span class=n>threadPool</span><span class=o>.</span><span class=na>getCoreSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;getMaxSize: &#34;</span> <span class=o>+</span> <span class=n>threadPool</span><span class=o>.</span><span class=na>getMaxSize</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;================================================&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>上述测试代码中，定义了一个Basic线程池，其中初始化线程数量为2，核心线程数量为4，最大线程数量为6，最大任务队列数量为1000，同时提交了20个任务到线程池中，然后在main线程中不断地输出线程池中的线程数量信息监控变化，运行上述代码，截取的部分输出信息如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>2</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>18</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>2</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>18</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>1</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>0</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>14</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>14</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>2</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>3</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>0</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>1</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>8</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>8</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>4</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>5</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>3</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>2</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>0</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>1</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>2</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>2</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>3</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>2</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>5</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>4</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>1</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>0</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>0</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>0</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>3</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>thread</span><span class=o>-</span><span class=n>pool</span><span class=o>-</span><span class=n>2</span> <span class=n>is</span> <span class=n>running</span> <span class=n>and</span> <span class=n>done</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>5</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>0</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>5</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>0</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>0</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span></code></pre></div><p>通过上述输出信息可以看出，线程池中线程的动态扩展状况以及任务执行情况，在输出的最后会发现active count停留在了core size的位置，这也符合我们的设计，最后为了确定线程池中的活跃线程数量</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>0</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span><span class=line><span class=cl><span class=o>================================================</span>
</span></span><span class=line><span class=cl><span class=nl>getActiveCount:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getQueueSize:</span> <span class=n>0</span>
</span></span><span class=line><span class=cl><span class=nl>getCoreSize:</span> <span class=n>4</span>
</span></span><span class=line><span class=cl><span class=nl>getMaxSize:</span> <span class=n>6</span>
</span></span></code></pre></div><h2 id=4-参考>4. 参考</h2><blockquote><p>【1】<a href=https://book.douban.com/subject/30255689/ target=_blank rel="noopener noreffer">《Java 高并发编程详解》-汪文君</a></p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2020-11-12</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://ahamoment.cn/posts/java/java-multithread-thread-pool/ data-title="Java 多线程 - 自定义线程池" data-via=xueqiang_chen data-hashtags=多线程,线程池><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://ahamoment.cn/posts/java/java-multithread-thread-pool/ data-hashtag=多线程><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://ahamoment.cn/posts/java/java-multithread-thread-pool/ data-title="Java 多线程 - 自定义线程池"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://ahamoment.cn/posts/java/java-multithread-thread-pool/ data-title="Java 多线程 - 自定义线程池"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://ahamoment.cn/posts/java/java-multithread-thread-pool/ data-title="Java 多线程 - 自定义线程池" data-ralateuid=陈先森cxq><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Evernote" data-sharer=evernote data-url=https://ahamoment.cn/posts/java/java-multithread-thread-pool/ data-title="Java 多线程 - 自定义线程池"><i class="fab fa-evernote fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/>多线程</a>,&nbsp;<a href=/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/>线程池</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/java/java-multithread-thread-lifecycle/ class=prev rel=prev title="Java 多线程 - 线程生命周期"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Java 多线程 - 线程生命周期</a>
<a href=/posts/tool/tool-git-common-operations/ class=next rel=next title="Git 常用命令汇总">Git 常用命令汇总<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"XueqiangChen/hugo-comments"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:50},twemoji:!0}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>