<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>流式处理和实时计算：Kafka - Aha Moment</title><meta name=Description content="软件工程师"><meta property="og:title" content="流式处理和实时计算：Kafka"><meta property="og:description" content="kafka不仅仅是消息系统，更可以用在流式处理的场景中。本文主要介绍消息系统概述，kafka系统架构和原理。"><meta property="og:type" content="article"><meta property="og:url" content="https://ahamoment.cn/posts/bigdata/kafka/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-11T02:35:35+00:00"><meta property="article:modified_time" content="2021-10-11T01:48:41+00:00"><meta property="og:site_name" content="Aha Moment"><meta name=twitter:card content="summary"><meta name=twitter:title content="流式处理和实时计算：Kafka"><meta name=twitter:description content="kafka不仅仅是消息系统，更可以用在流式处理的场景中。本文主要介绍消息系统概述，kafka系统架构和原理。"><meta name=application-name content="Aha Moment!"><meta name=apple-mobile-web-app-title content="Aha Moment!"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ahamoment.cn/posts/bigdata/kafka/><link rel=prev href=https://ahamoment.cn/posts/bigdata/olap-presto/><link rel=next href=https://ahamoment.cn/posts/bigdata/hive-hive/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"流式处理和实时计算：Kafka","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ahamoment.cn\/posts\/bigdata\/kafka\/"},"genre":"posts","keywords":"kafka","wordcount":4474,"url":"https:\/\/ahamoment.cn\/posts\/bigdata\/kafka\/","datePublished":"2021-10-11T02:35:35+00:00","dateModified":"2021-10-11T01:48:41+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xueqiang.chen"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Aha Moment">Aha Moment!</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Aha Moment">Aha Moment!</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">流式处理和实时计算：Kafka</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://ahamoment.cn title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xueqiang.chen</a></span>&nbsp;<span class=post-category>included in <a href=/categories/bigdata/><i class="far fa-folder fa-fw" aria-hidden=true></i>bigdata</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-10-11>2021-10-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;4474 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;9 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafkalogo.jpg data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafkalogo.jpg, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafkalogo.jpg 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafkalogo.jpg 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafkalogo.jpg title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafkalogo.jpg></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#消息系统概述>消息系统概述</a></li><li><a href=#kafka的发展历程和现状>Kafka的发展历程和现状</a></li><li><a href=#kafka系统架构和原理>Kafka系统架构和原理</a></li><li><a href=#如何做到可靠数据传递>如何做到可靠数据传递</a></li><li><a href=#page-cache和零拷贝>Page Cache和零拷贝</a></li><li><a href=#ksql>KSQL</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>kafka不仅仅是消息系统，更可以用在流式处理的场景中。本文主要介绍消息系统概述，kafka系统架构和原理。</p><h3 id=消息系统概述>消息系统概述</h3><blockquote><p>为什么需要消息系统</p></blockquote><p>解耦、冗余、扩展性、灵活性&峰值处理、可恢复性、顺序保证、缓冲、异步处理、消息通信</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/system-kafka.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/system-kafka.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/system-kafka.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/system-kafka.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/system-kafka.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/system-kafka.png></p><p>kafka是个消息队列，但是又不是简单的消息队列。首先有主题，针对不同的主题有不同的消费。特性：主题、不同订阅端消费不同的主题、接受不同的生产者，数据源</p><blockquote><p>消息系统</p></blockquote><p>ActiveMQ、Kafka、RabbitMQ、Redis、Jafka、ZeroMQ</p><blockquote><p>生产者和消费者模式</p></blockquote><p>在生产者／消费者模型中，生产者Producer负责生产数据，而消费者Consumer负责<br>使用数据。多个生产者会在同一时间生产数据，并放到内存中一个共享的区域。<br><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/consumer-producer.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/consumer-producer.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/consumer-producer.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/consumer-producer.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/consumer-producer.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/consumer-producer.png></p><h3 id=kafka的发展历程和现状>Kafka的发展历程和现状</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafa_history.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafa_history.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafa_history.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafa_history.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafa_history.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafa_history.png></p><blockquote><p>KSQL</p></blockquote><p>流式计算，针对流进行增强</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql1.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql1.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql1.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql1.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql1.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql1.png></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql2.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql2.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql2.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql2.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql2.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/ksql2.png></p><h3 id=kafka系统架构和原理>Kafka系统架构和原理</h3><blockquote><p>Topics 和 Append Log</p></blockquote><p>一个topic是对一组消息的归纳，一个topic是对一组消息的归纳，每个partition会生成一个append log文件。每条消息在文件中的位置称为offset（偏移量），唯一标记一条消息。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/topic.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/topic.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/topic.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/topic.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/topic.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/topic.png></p><blockquote><p>Producer和Consumer</p></blockquote><p>Producer即生产者，向Kafka集群发送消息，消息会按照Topic进行分类。<br>Consumer即消费者，消费者通过与Kafka集群建立长连接的方式，不断地从集群中<br>拉取消息，然后可以对这些消息进行处理。它需要保存消费消息的offset：当<br>consumer正常消费消息时，offset将会“线性”的增加，即消息将依次顺序被消费。<br>通过设置offset，consumer可以从任意位置消费消息。<br>Consumer可以在本地保存最后消息的offset，并向ZooKeeper注册offset。</p><blockquote><p>Consumer Group</p></blockquote><p>这是Kafka用来实现一个topic消息广播的手段。即多个不同的group来同时消费同一<br>个topic下的消息。他们消费的offset各不相同，各不干扰。<br>一个group中，Consumer的数量不应该多于Partition的数量，即一个消费者可以消<br>费多个分区，但一个分区只能给一个消费者消费。若一个group中的消费者数量大于<br>Partition数量的话，多余的消费者将不会收到任何消息。</p><blockquote><p>Broker</p></blockquote><p>消息保存在一组服务器中，它们被称为代理（Broker）或Kafka集群。<br>每个Broker有一个Broker id。<br>每个Broker存储Topic的部分数据。<br>Kafka的存储文件按照offset.kafka来命名，用offset做名字的好处是方便查找。例如<br>你想找位于2049的位置，只要找到2048.kafka的文件即可。第一个个存储文件是<br>00000000000.kafka。</p><blockquote><p>整体架构图</p></blockquote><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafka_arch.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafka_arch.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafka_arch.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafka_arch.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafka_arch.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafka_arch.png></p><blockquote><p>消息传送机制</p></blockquote><p>对于传统消息系统，消息传输担保非常直接：有且只有一次(exactly once)。在Kafka<br>中稍有不同：<br>• at most once：消息最多发生一次，无论消费者是否接受到，都不会重发。<br>• at least once：消息至少发送一次，如果消息未能接受成功，会重发直到接收成功。<br>• exactly once：消息只会发送一次</p><p>新版本才有。</p><blockquote><p>Kafka中各语义如何实现</p></blockquote><p>at most once：消费者fetch消息，先保存消息的offset，然后处理消息。当消费者保<br>存offset之后，但是在消息处理过程中出现了异常，导致部分消息未能继续处理。那<br>么此后“未处理”的消息将不能被fetch到，这就是“at most once”。<br>at least once：消费者fetch消息，先处理消息，然后保存offset。如果消息处理成功<br>之后，但是在保存offset阶段，ZooKeeper异常导致保存操作未能执行成功，这就导<br>致接下来再次fetch时可能获得上次已经处理过的消息，这就是“at least once”。<br>exactly once：Kafka中并没有严格的去实现（基于2阶段提交、事务），我们认为这<br>种策略在Kafka中是没有必要的</p><h3 id=如何做到可靠数据传递>如何做到可靠数据传递</h3><blockquote><p>Replica</p></blockquote><p>Kafka将每个partition数据复制到多个server上，任何一个partition有一个leader和<br>零个或多个follower（ISR），称为partition的副本（replica）。<br>• Leader处理所有的读写请求，follower需要和leader保持同步。Follower和<br>consumer一样，消费消息并保存在本地日志中。<br>• 当所有的follower都将一条消息保存成功，此消息才被认为是“committed”。只有<br>committed的消息，consumer才能消费它。<br>• 当leader失效时，需在followers中选取出新的leader。可能此时follower落后于<br>leader，因此需要选择一个尽可能“新”的follower。</p><blockquote><p>容灾</p></blockquote><blockquote><p>Producer ACK</p></blockquote><ul><li>ACK=0，即没有ack，可能会造成数据丢失（at most once）</li><li>ACK=1，producer会等接收到Leader的ack再发生下一条消息（at most once）</li><li>ACK=all，producer会等接收到Leader+Follower的ack再发生下一条消息（at least<br>once / exactly once）</li></ul><blockquote><p>Producer Key</p></blockquote><ul><li>Producer可以为发送的消息设置Key来进行发生模式选择。</li><li>当key=null，数据才用轮训（Round Robin）方式进行发送。</li><li>当key!=null，数据可以根据散列键（Hash）方式进行发送，相同Key的数据能发送<br>到同一个Partition。</li></ul><blockquote><p>Consumer Rebalance</p></blockquote><ul><li>Consumer记录每个partition所消费的maximum offset，并定期commit到offset<br>manager。</li><li>属于同一个group的consumer（group id一样）平均分配partition，每个partition<br>只会被一个consumer消费。</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/producer_key.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/producer_key.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/producer_key.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/producer_key.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/producer_key.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/producer_key.png></p><ul><li>ZooKeeper会管理broker与consumer的动态关系。</li><li>当broker或consumer加入或离开时会触发负载均衡算法，使得一个consumer group内的多个consumer的订阅负载平衡。</li><li>ZooKeeper还维护每个partition的消费offset。</li><li>算法：<br>假如topic1,具有如下partitions: P0,P1,P2,P3<br>假如group中,有如下consumer: C1,C2<br>首先根据partition索引号对partitions排序: P0,P1,P2,P3<br>根据consumer.id排序: C0,C1<br>计算倍数: M = [P0,P1,P2,P3].size / [C0,C1].size,本例值M=2(向上取整)<br>然后依次分配partitions: C0 = [P0,P1],C1=[P2,P3]<br>Ci = [P(i * M),P((i + 1) * M -1)]</li></ul><h3 id=page-cache和零拷贝>Page Cache和零拷贝</h3><blockquote><p>文件存储</p></blockquote><ul><li>在Kafka文件存储中，同一个topic下有多个不同partition，每个partition为一个目录，<br>partiton目录的命名规则为topic名称+有序序号，第一个partiton序号从0开始。</li><li>每个partition目录存储着多个segment数据文件。Segment数据文件size固定，但消息数量不一定相等。默认保留7天。</li><li>每个segment由index file（.index后缀）和data file（.log后缀）”组成。</li><li>Partition全局的第一个segment从0开始，后续每个segment文件名为上一个segment文件最后一条消息的offset值。</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/segment.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/segment.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/segment.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/segment.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/segment.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/segment.png></p><blockquote><p>Segment 存储</p></blockquote><ul><li><p>疑问一：为什么要分区呢？<br>为了性能考虑，如果不分区每个topic的消息只存在一个broker上，那么所有的消费者都是从这个broker上消费消息，那么单节点的broker成为性能的瓶颈，如果有分区的话生产者发过来的消息分别存储在各个broker不同的partition上，这样消费者可以并行的从不同的broker不同的partition上读消息，实现了水平扩展。</p></li><li><p>疑问二：为什么有了partition还需要segment ？<br>如果不引入segment，那么一个partition只对应一个文件（log），随着消息的不断发送这个文件不断增大，由于Kafka的消息不会做更新操作都是顺序写入的，如果做消息清理的时候只能删除文件的前面部分删除，不符合Kafka顺序写入的设计，如果多个segment的话那就比较方便了，直接删除整个文件即可保证了每个segment的顺序写入。</p></li><li><p>疑问三：分区文件下到底存了那些东西？</p><p>其实每个分区下保存了很多文件，而概念上我们把他叫segment，即每个分区都是又多个<br>segment构成的，其中index（索引文件）、log（数据文件）、time index（时间索引文件）统称为一个segment。</p></li></ul><blockquote><p>消费者如何通过offset查找message</p></blockquote><p>假如我们想要读取offset=1066的message，需要通过下面2个步骤查找：</p><ol><li><p>查找segment file</p><p>0000.index表示最开始的文件，起始偏移量(offset)为0。第二个文件1018.index的消息量起始偏移量为1019(1018 +1)。同样，第三个文件2042.index的起始偏移量为2043(2042 + 1)。只要根据offset进行二分查找文件列表，就可以快速定位到具体文件。当offset=1066时定位到1018.index|log。</p></li><li><p>通过segment file 查找message</p><p>通过第一步定位到segment file，当offset=1066时，依次定位到1018.index的元数据物理位置和1018.log的物理偏移地址，此时我们只能拿到1065的物理偏移地址，然后再通过368769.log顺序查找直到offset=1066为止。</p></li></ol><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/find_message.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/find_message.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/find_message.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/find_message.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/find_message.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/find_message.png></p><blockquote><p>高性能</p></blockquote><p>Kafka官方测试其数据读写速率能达到600M/s，那么为什么性能会这么高呢？</p><ul><li>sequence IO</li><li>PageCache</li><li>Zero Copy（SendFile）</li></ul><blockquote><p>Sequence IO</p></blockquote><p>Kafka在将数据持久化到磁盘时，采用只追加的顺序写，有效降低了寻址时间，提高效率。</p><blockquote><p>PageCache</p></blockquote><p>PageCache是Linux系统级别的缓存，它把尽可能多的空闲内存当作磁盘缓存使用来进一步提高IO效率。</p><p>当写操作发生时，操作系统只是将数据写入PageCache，同时标记Page属性为Dirty。当读操作发生时，先从PageCache中查找，如果发生缺页才进行磁盘调度，最终返回需要的数据。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache.png></p><ul><li>Producer把消息发到broker后，数据并不是直接落入磁盘的，而是先进入PageCache。PageCache中的数据会被内核中的处理线程采用同步或异步的方式写回到磁盘。</li><li>Consumer消费消息时，会先从PageCache获取消息，获取不到才回去磁盘读取，并且会预读出一些相邻的块放入PageCache，以方便下一次读取。</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache2.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache2.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache2.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache2.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache2.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/page_cache2.png></p><blockquote><p>Zero Copy</p></blockquote><p>传统的网络I/O过程：</p><ol><li>操作系统从磁盘把数据读到内核区</li><li>用户进程把数据从内核区copy到用户区</li><li>然后用户进程再把数据写入到内核区的socket buffer上</li><li>最后把数据从socket buffer中发送到网卡</li></ol><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/tradition_copy.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/tradition_copy.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/tradition_copy.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/tradition_copy.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/tradition_copy.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/tradition_copy.png></p><p>通过SendFile（又称Zero Copy）优化后，数据从内核区copy到socket，然后发送到网卡，避免了数据在内核态和用户态的来回拷贝。</p><p>从Linux内核2.4版本开始，对于网卡支持SG-DMA的，SendFile进一步减少通过CPU把内核缓冲区里的数据拷贝到socket缓冲区的过程。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/zero_copy.png data-srcset="https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/zero_copy.png, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/zero_copy.png 1.5x, https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/zero_copy.png 2x" data-sizes=auto alt=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/zero_copy.png title=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/zero_copy.png></p><h3 id=ksql>KSQL</h3></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-10-11</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://ahamoment.cn/posts/bigdata/kafka/ data-title=流式处理和实时计算：Kafka data-via=xueqiang_chen data-hashtags=kafka><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://ahamoment.cn/posts/bigdata/kafka/ data-hashtag=kafka><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://ahamoment.cn/posts/bigdata/kafka/ data-title=流式处理和实时计算：Kafka><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://ahamoment.cn/posts/bigdata/kafka/ data-title=流式处理和实时计算：Kafka><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://ahamoment.cn/posts/bigdata/kafka/ data-title=流式处理和实时计算：Kafka data-image=https://chenxqblog-1258795182.cos.ap-guangzhou.myqcloud.com/typora/kafkalogo.jpg data-ralateuid=陈先森cxq><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Evernote" data-sharer=evernote data-url=https://ahamoment.cn/posts/bigdata/kafka/ data-title=流式处理和实时计算：Kafka><i class="fab fa-evernote fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/kafka/>kafka</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/bigdata/olap-presto/ class=prev rel=prev title="大数据 OLAP 引擎：Presto 概述"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>大数据 OLAP 引擎：Presto 概述</a>
<a href=/posts/bigdata/hive-hive/ class=next rel=next title=HIVE概述和HIVE基本原理>HIVE概述和HIVE基本原理<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"XueqiangChen/hugo-comments"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:50},twemoji:!0}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>