[{"contents":"æ ‡é¢˜ä¸€ hugo åšå®¢æ ‡é¢˜\næ ‡é¢˜äºŒ hello world çš„demo\næ ‡é¢˜ä¸‰ æµ‹è¯•ä¸€ä¸‹\næ ‡é¢˜å›› å•¦å•¦å•¦å•¦\näºŒçº§æ ‡é¢˜ \u0026lt;div class=\u0026quot;widget bg-secondary-bg rounded p-6\u0026quot;\u0026gt; \u0026lt;h2 class=\u0026quot;widget-title\u0026quot;\u0026gt;ç®¡ç†\u0026lt;/h2\u0026gt; \u0026lt;ul class=\u0026quot;widget-list\u0026quot;\u0026gt; \u0026lt;li\u0026gt; \u0026lt;a href=\u0026quot;/admin/\u0026quot;\u0026gt;ğŸ›  åå°ç®¡ç†\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;li\u0026gt; \u0026lt;a href=\u0026quot;{{ .Site.Params.comment.waline.serverURL }}/ui\u0026quot;\u0026gt;ğŸ’¬ è¯„è®ºç®¡ç†\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt;   å¼•ç”¨ä¸Šæ–‡çš„è¯\n ","date":"2021å¹´08æœˆ10æ—¥","permalink":"https://ahamoment.cn/posts/hello-world/","summary":"æ ‡é¢˜ä¸€ hugo åšå®¢æ ‡é¢˜\næ ‡é¢˜äºŒ hello world çš„demo\næ ‡é¢˜ä¸‰ æµ‹è¯•ä¸€ä¸‹\næ ‡é¢˜å›› å•¦å•¦å•¦å•¦\näºŒçº§æ ‡é¢˜ \u0026lt;div class=\u0026quot;widget bg-secondary-bg rounded p-6\u0026quot;\u0026gt; \u0026lt;h2 class=\u0026quot;widget-title\u0026quot;\u0026gt;ç®¡ç†\u0026lt;/h2\u0026gt; \u0026lt;ul class=\u0026quot;widget-list\u0026quot;\u0026gt; \u0026lt;li\u0026gt; \u0026lt;a href=\u0026quot;/admin/\u0026quot;\u0026gt;ğŸ›  åå°ç®¡ç†\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;li\u0026gt; \u0026lt;a href=\u0026quot;{{ .","title":"hello world"},{"contents":"å‰è¨€ åŸå…ˆçš„åšå®¢ä¸»é¢˜ even ç”¨äº†ä¸€æ®µæ—¶é—´ï¼Œç”±äºæƒ³æŠŠåšå®¢å†…çš„ä¸€äº›ç³»åˆ—æ–‡ç« æ•´ç†æˆä¸€ä¸ªç‹¬ç«‹çš„ç¬”è®°é“¾æ¥ï¼Œç´¢æ€§å°±ä¸€èµ·æ›´æ¢äº†åšå®¢çš„ä¸»é¢˜ï¼Œç°åœ¨ä½¿ç”¨çš„è¿™æ¬¾ä¸»é¢˜æ˜¯ hugo-clarity, ä¸èƒ½è¯´åå…¨åç¾ï¼Œä½†æ˜¯æ¯”è¾ƒæ»¡è¶³æˆ‘ç°åœ¨çš„éœ€æ±‚ã€‚è¿™æ¬¾ä¸»é¢˜çš„ä»£ç é«˜äº®å’Œæ˜¾ç¤ºç‰¹åˆ«æœ‰ç‰¹ç‚¹ï¼Œç¬¦åˆç¨‹åºå‘˜çš„éœ€æ±‚ã€‚å¦å¤–ä¹‹å‰ä¸€ç›´æƒ³ç”¨github actionçš„è‡ªåŠ¨åŒ–æ¥éƒ¨ç½²åšå®¢ï¼Œä¸€ç›´éƒ½æ²¡æœ‰æ—¶é—´ï¼Œè¿™æ¬¡ä¸€èµ·åšäº†ã€‚\n1. åšå®¢ä¸»ä½“ åšå®¢ä¸»ä½“æ˜¯ç”±\nhttps://github.com/peaceiris/actions-gh-pages\nhttps://github.com/GitbookIO/gitbook-cli\nhttps://github.com/marketplace/actions/publish-gitbook\nhttps://github.com/marketplace?type=actions\n","date":"2021å¹´06æœˆ17æ—¥","permalink":"https://ahamoment.cn/posts/tool/tool-hugo-blog/","summary":"å‰è¨€ åŸå…ˆçš„åšå®¢ä¸»é¢˜ even ç”¨äº†ä¸€æ®µæ—¶é—´ï¼Œç”±äºæƒ³æŠŠåšå®¢å†…çš„ä¸€äº›ç³»åˆ—æ–‡ç« æ•´ç†æˆä¸€ä¸ªç‹¬ç«‹çš„ç¬”è®°é“¾æ¥ï¼Œç´¢æ€§å°±ä¸€èµ·æ›´æ¢äº†åšå®¢çš„ä¸»é¢˜ï¼Œç°åœ¨ä½¿ç”¨çš„è¿™æ¬¾ä¸»é¢˜æ˜¯ hugo-clarity, ä¸èƒ½è¯´åå…¨åç¾ï¼Œä½†æ˜¯æ¯”è¾ƒæ»¡è¶³æˆ‘ç°åœ¨çš„éœ€æ±‚ã€‚è¿™æ¬¾ä¸»é¢˜çš„ä»£ç é«˜äº®å’Œæ˜¾ç¤ºç‰¹åˆ«æœ‰ç‰¹ç‚¹ï¼Œç¬¦åˆç¨‹åºå‘˜çš„éœ€æ±‚ã€‚å¦å¤–ä¹‹å‰ä¸€ç›´æƒ³ç”¨github actionçš„è‡ªåŠ¨åŒ–æ¥éƒ¨ç½²åšå®¢ï¼Œä¸€ç›´éƒ½æ²¡æœ‰æ—¶é—´ï¼Œè¿™æ¬¡ä¸€èµ·åšäº†ã€‚\n1. åšå®¢ä¸»ä½“ åšå®¢ä¸»ä½“æ˜¯ç”±\nhttps://github.com/peaceiris/actions-gh-pages\nhttps://github.com/GitbookIO/gitbook-cli\nhttps://github.com/marketplace/actions/publish-gitbook\nhttps://github.com/marketplace?type=actions","title":"Hugo åšå®¢æ­å»º"},{"contents":" æœ¬æ–‡æ¥è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æKuberntesã€‹è¯¾ç¨‹ç¬”è®°ï¼Œè¯·å‹¿è½¬è½½ã€‚\n åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸»è¦ä¸ºä½ ä»‹ç»äº† Kubernetes é‡Œå…³äºèµ„æºæ¨¡å‹å’Œèµ„æºç®¡ç†çš„è®¾è®¡æ–¹æ³•ã€‚è€Œåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°±æ¥ä¸ºä½ ä»‹ç»ä¸€ä¸‹ Kubernetes çš„é»˜è®¤è°ƒåº¦å™¨ï¼ˆdefault schedulerï¼‰ã€‚\nåœ¨ Kubernetes é¡¹ç›®ä¸­ï¼Œé»˜è®¤è°ƒåº¦å™¨çš„ä¸»è¦èŒè´£ï¼Œå°±æ˜¯ä¸ºä¸€ä¸ªæ–°åˆ›å»ºå‡ºæ¥çš„ Podï¼Œå¯»æ‰¾ä¸€ä¸ªæœ€åˆé€‚çš„èŠ‚ç‚¹ï¼ˆNodeï¼‰ã€‚\nè€Œè¿™é‡Œâ€œæœ€åˆé€‚â€çš„å«ä¹‰ï¼ŒåŒ…æ‹¬ä¸¤å±‚ï¼š\n ä»é›†ç¾¤æ‰€æœ‰çš„èŠ‚ç‚¹ä¸­ï¼Œæ ¹æ®è°ƒåº¦ç®—æ³•æŒ‘é€‰å‡ºæ‰€æœ‰å¯ä»¥è¿è¡Œè¯¥ Pod çš„èŠ‚ç‚¹ï¼› ä»ç¬¬ä¸€æ­¥çš„ç»“æœä¸­ï¼Œå†æ ¹æ®è°ƒåº¦ç®—æ³•æŒ‘é€‰ä¸€ä¸ªæœ€ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ä½œä¸ºæœ€ç»ˆç»“æœã€‚  æ‰€ä»¥åœ¨å…·ä½“çš„è°ƒåº¦æµç¨‹ä¸­ï¼Œé»˜è®¤è°ƒåº¦å™¨ä¼šé¦–å…ˆè°ƒç”¨ä¸€ç»„å«ä½œ Predicate çš„è°ƒåº¦ç®—æ³•ï¼Œæ¥æ£€æŸ¥æ¯ä¸ª Nodeã€‚ç„¶åï¼Œå†è°ƒç”¨ä¸€ç»„å«ä½œ Priority çš„è°ƒåº¦ç®—æ³•ï¼Œæ¥ç»™ä¸Šä¸€æ­¥å¾—åˆ°çš„ç»“æœé‡Œçš„æ¯ä¸ª Node æ‰“åˆ†ã€‚æœ€ç»ˆçš„è°ƒåº¦ç»“æœï¼Œå°±æ˜¯å¾—åˆ†æœ€é«˜çš„é‚£ä¸ª Nodeã€‚\nè€Œæˆ‘åœ¨å‰é¢çš„æ–‡ç« ä¸­æ›¾ç»ä»‹ç»è¿‡ï¼Œè°ƒåº¦å™¨å¯¹ä¸€ä¸ª Pod è°ƒåº¦æˆåŠŸï¼Œå®é™…ä¸Šå°±æ˜¯å°†å®ƒçš„ spec.nodeName å­—æ®µå¡«ä¸Šè°ƒåº¦ç»“æœçš„èŠ‚ç‚¹åå­—ã€‚\nåœ¨ Kubernetes ä¸­ï¼Œä¸Šè¿°è°ƒåº¦æœºåˆ¶çš„å·¥ä½œåŸç†ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€å¹…ç¤ºæ„å›¾æ¥è¡¨ç¤ºã€‚\nå¯ä»¥çœ‹åˆ°ï¼ŒKubernetes çš„è°ƒåº¦å™¨çš„æ ¸å¿ƒï¼Œå®é™…ä¸Šå°±æ˜¯ä¸¤ä¸ªç›¸äº’ç‹¬ç«‹çš„æ§åˆ¶å¾ªç¯ã€‚\nå…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªæ§åˆ¶å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸º Informer Pathã€‚å®ƒçš„ä¸»è¦ç›®çš„ï¼Œæ˜¯å¯åŠ¨ä¸€ç³»åˆ— Informerï¼Œç”¨æ¥ç›‘å¬ï¼ˆWatchï¼‰Etcd ä¸­ Podã€Nodeã€Service ç­‰ä¸è°ƒåº¦ç›¸å…³çš„ API å¯¹è±¡çš„å˜åŒ–ã€‚æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªå¾…è°ƒåº¦ Podï¼ˆå³ï¼šå®ƒçš„ nodeName å­—æ®µæ˜¯ç©ºçš„ï¼‰è¢«åˆ›å»ºå‡ºæ¥ä¹‹åï¼Œè°ƒåº¦å™¨å°±ä¼šé€šè¿‡ Pod Informer çš„ Handlerï¼Œå°†è¿™ä¸ªå¾…è°ƒåº¦ Pod æ·»åŠ è¿›è°ƒåº¦é˜Ÿåˆ—ã€‚\nåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes çš„è°ƒåº¦é˜Ÿåˆ—æ˜¯ä¸€ä¸ª PriorityQueueï¼ˆä¼˜å…ˆçº§é˜Ÿåˆ—ï¼‰ï¼Œå¹¶ä¸”å½“æŸäº›é›†ç¾¤ä¿¡æ¯å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œè°ƒåº¦å™¨è¿˜ä¼šå¯¹è°ƒåº¦é˜Ÿåˆ—é‡Œçš„å†…å®¹è¿›è¡Œä¸€äº›ç‰¹æ®Šæ“ä½œã€‚è¿™é‡Œçš„è®¾è®¡ï¼Œä¸»è¦æ˜¯å‡ºäºè°ƒåº¦ä¼˜å…ˆçº§å’ŒæŠ¢å çš„è€ƒè™‘ï¼Œæˆ‘ä¼šåœ¨åé¢çš„æ–‡ç« ä¸­å†è¯¦ç»†ä»‹ç»è¿™éƒ¨åˆ†å†…å®¹ã€‚\næ­¤å¤–ï¼ŒKubernetes çš„é»˜è®¤è°ƒåº¦å™¨è¿˜è¦è´Ÿè´£å¯¹è°ƒåº¦å™¨ç¼“å­˜ï¼ˆå³ï¼šscheduler cacheï¼‰è¿›è¡Œæ›´æ–°ã€‚äº‹å®ä¸Šï¼ŒKubernetes è°ƒåº¦éƒ¨åˆ†è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„ä¸€ä¸ªæœ€æ ¹æœ¬åŸåˆ™ï¼Œå°±æ˜¯å°½æœ€å¤§å¯èƒ½å°†é›†ç¾¤ä¿¡æ¯ Cache åŒ–ï¼Œä»¥ä¾¿ä»æ ¹æœ¬ä¸Šæé«˜ Predicate å’Œ Priority è°ƒåº¦ç®—æ³•çš„æ‰§è¡Œæ•ˆç‡ã€‚\nè€Œç¬¬äºŒä¸ªæ§åˆ¶å¾ªç¯ï¼Œæ˜¯è°ƒåº¦å™¨è´Ÿè´£ Pod è°ƒåº¦çš„ä¸»å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸º Scheduling Pathã€‚\nScheduling Path çš„ä¸»è¦é€»è¾‘ï¼Œå°±æ˜¯ä¸æ–­åœ°ä»è°ƒåº¦é˜Ÿåˆ—é‡Œå‡ºé˜Ÿä¸€ä¸ª Podã€‚ç„¶åï¼Œè°ƒç”¨ Predicates ç®—æ³•è¿›è¡Œâ€œè¿‡æ»¤â€ã€‚è¿™ä¸€æ­¥â€œè¿‡æ»¤â€å¾—åˆ°çš„ä¸€ç»„ Nodeï¼Œå°±æ˜¯æ‰€æœ‰å¯ä»¥è¿è¡Œè¿™ä¸ª Pod çš„å®¿ä¸»æœºåˆ—è¡¨ã€‚å½“ç„¶ï¼ŒPredicates ç®—æ³•éœ€è¦çš„ Node ä¿¡æ¯ï¼Œéƒ½æ˜¯ä» Scheduler Cache é‡Œç›´æ¥æ‹¿åˆ°çš„ï¼Œè¿™æ˜¯è°ƒåº¦å™¨ä¿è¯ç®—æ³•æ‰§è¡Œæ•ˆç‡çš„ä¸»è¦æ‰‹æ®µä¹‹ä¸€ã€‚\næ¥ä¸‹æ¥ï¼Œè°ƒåº¦å™¨å°±ä¼šå†è°ƒç”¨ Priorities ç®—æ³•ä¸ºä¸Šè¿°åˆ—è¡¨é‡Œçš„ Node æ‰“åˆ†ï¼Œåˆ†æ•°ä» 0 åˆ° 10ã€‚å¾—åˆ†æœ€é«˜çš„ Nodeï¼Œå°±ä¼šä½œä¸ºè¿™æ¬¡è°ƒåº¦çš„ç»“æœã€‚\nè°ƒåº¦ç®—æ³•æ‰§è¡Œå®Œæˆåï¼Œè°ƒåº¦å™¨å°±éœ€è¦å°† Pod å¯¹è±¡çš„ nodeName å­—æ®µçš„å€¼ï¼Œä¿®æ”¹ä¸ºä¸Šè¿° Node çš„åå­—ã€‚è¿™ä¸ªæ­¥éª¤åœ¨ Kubernetes é‡Œé¢è¢«ç§°ä½œ Bindã€‚\nä½†æ˜¯ï¼Œä¸ºäº†ä¸åœ¨å…³é”®è°ƒåº¦è·¯å¾„é‡Œè¿œç¨‹è®¿é—® APIServerï¼ŒKubernetes çš„é»˜è®¤è°ƒåº¦å™¨åœ¨ Bind é˜¶æ®µï¼Œåªä¼šæ›´æ–° Scheduler Cache é‡Œçš„ Pod å’Œ Node çš„ä¿¡æ¯ã€‚è¿™ç§åŸºäºâ€œä¹è§‚â€å‡è®¾çš„ API å¯¹è±¡æ›´æ–°æ–¹å¼ï¼Œåœ¨ Kubernetes é‡Œè¢«ç§°ä½œ Assumeã€‚\nAssume ä¹‹åï¼Œè°ƒåº¦å™¨æ‰ä¼šåˆ›å»ºä¸€ä¸ª Goroutine æ¥å¼‚æ­¥åœ°å‘ APIServer å‘èµ·æ›´æ–° Pod çš„è¯·æ±‚ï¼Œæ¥çœŸæ­£å®Œæˆ Bind æ“ä½œã€‚å¦‚æœè¿™æ¬¡å¼‚æ­¥çš„ Bind è¿‡ç¨‹å¤±è´¥äº†ï¼Œå…¶å®ä¹Ÿæ²¡æœ‰å¤ªå¤§å…³ç³»ï¼Œç­‰ Scheduler Cache åŒæ­¥ä¹‹åä¸€åˆ‡å°±ä¼šæ¢å¤æ­£å¸¸ã€‚\nå½“ç„¶ï¼Œæ­£æ˜¯ç”±äºä¸Šè¿° Kubernetes è°ƒåº¦å™¨çš„â€œä¹è§‚â€ç»‘å®šçš„è®¾è®¡ï¼Œå½“ä¸€ä¸ªæ–°çš„ Pod å®Œæˆè°ƒåº¦éœ€è¦åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œèµ·æ¥ä¹‹å‰ï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„ kubelet è¿˜ä¼šé€šè¿‡ä¸€ä¸ªå«ä½œ Admit çš„æ“ä½œæ¥å†æ¬¡éªŒè¯è¯¥ Pod æ˜¯å¦ç¡®å®èƒ½å¤Ÿè¿è¡Œåœ¨è¯¥èŠ‚ç‚¹ä¸Šã€‚è¿™ä¸€æ­¥ Admit æ“ä½œï¼Œå®é™…ä¸Šå°±æ˜¯æŠŠä¸€ç»„å«ä½œ GeneralPredicates çš„ã€æœ€åŸºæœ¬çš„è°ƒåº¦ç®—æ³•ï¼Œæ¯”å¦‚ï¼šâ€œèµ„æºæ˜¯å¦å¯ç”¨â€â€œç«¯å£æ˜¯å¦å†²çªâ€ç­‰å†æ‰§è¡Œä¸€éï¼Œä½œä¸º kubelet ç«¯çš„äºŒæ¬¡ç¡®è®¤ã€‚\n å¤‡æ³¨ï¼šå…³äº Kubernetes é»˜è®¤è°ƒåº¦å™¨çš„è°ƒåº¦ç®—æ³•ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é‡Œä¸ºä½ è®²è§£ã€‚\n é™¤äº†ä¸Šè¿°çš„â€œCache åŒ–â€å’Œâ€œä¹è§‚ç»‘å®šâ€ï¼ŒKubernetes é»˜è®¤è°ƒåº¦å™¨è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„è®¾è®¡ï¼Œé‚£å°±æ˜¯â€œæ— é”åŒ–â€ã€‚\nåœ¨ Scheduling Path ä¸Šï¼Œè°ƒåº¦å™¨ä¼šå¯åŠ¨å¤šä¸ª Goroutine ä»¥èŠ‚ç‚¹ä¸ºç²’åº¦å¹¶å‘æ‰§è¡Œ Predicates ç®—æ³•ï¼Œä»è€Œæé«˜è¿™ä¸€é˜¶æ®µçš„æ‰§è¡Œæ•ˆç‡ã€‚è€Œä¸ä¹‹ç±»ä¼¼çš„ï¼ŒPriorities ç®—æ³•ä¹Ÿä¼šä»¥ MapReduce çš„æ–¹å¼å¹¶è¡Œè®¡ç®—ç„¶åå†è¿›è¡Œæ±‡æ€»ã€‚è€Œåœ¨è¿™äº›æ‰€æœ‰éœ€è¦å¹¶å‘çš„è·¯å¾„ä¸Šï¼Œè°ƒåº¦å™¨ä¼šé¿å…è®¾ç½®ä»»ä½•å…¨å±€çš„ç«äº‰èµ„æºï¼Œä»è€Œå…å»äº†ä½¿ç”¨é”è¿›è¡ŒåŒæ­¥å¸¦æ¥çš„å·¨å¤§çš„æ€§èƒ½æŸè€—ã€‚\næ‰€ä»¥ï¼Œåœ¨è¿™ç§æ€æƒ³çš„æŒ‡å¯¼ä¸‹ï¼Œå¦‚æœä½ å†å»æŸ¥çœ‹ä¸€ä¸‹å‰é¢çš„è°ƒåº¦å™¨åŸç†å›¾ï¼Œä½ å°±ä¼šå‘ç°ï¼ŒKubernetes è°ƒåº¦å™¨åªæœ‰å¯¹è°ƒåº¦é˜Ÿåˆ—å’Œ Scheduler Cache è¿›è¡Œæ“ä½œæ—¶ï¼Œæ‰éœ€è¦åŠ é”ã€‚è€Œè¿™ä¸¤éƒ¨åˆ†æ“ä½œï¼Œéƒ½ä¸åœ¨ Scheduling Path çš„ç®—æ³•æ‰§è¡Œè·¯å¾„ä¸Šã€‚\nå½“ç„¶ï¼ŒKubernetes è°ƒåº¦å™¨çš„ä¸Šè¿°è®¾è®¡æ€æƒ³ï¼Œä¹Ÿæ˜¯åœ¨é›†ç¾¤è§„æ¨¡ä¸æ–­å¢é•¿çš„æ¼”è¿›è¿‡ç¨‹ä¸­é€æ­¥å®ç°çš„ã€‚å°¤å…¶æ˜¯ â€œCache åŒ–â€ï¼Œè¿™ä¸ªå˜åŒ–å…¶å®æ˜¯æœ€è¿‘å‡ å¹´ Kubernetes è°ƒåº¦å™¨æ€§èƒ½å¾—ä»¥æå‡çš„ä¸€ä¸ªå…³é”®æ¼”åŒ–ã€‚\nä¸è¿‡ï¼Œéšç€ Kubernetes é¡¹ç›®å‘å±•åˆ°ä»Šå¤©ï¼Œå®ƒçš„é»˜è®¤è°ƒåº¦å™¨ä¹Ÿå·²ç»æ¥åˆ°äº†ä¸€ä¸ªå…³é”®çš„åå­—è·¯å£ã€‚äº‹å®ä¸Šï¼ŒKubernetes ç°ä»Šå‘å±•çš„ä¸»æ—‹å¾‹ï¼Œæ˜¯æ•´ä¸ªå¼€æºé¡¹ç›®çš„â€œæ°‘ä¸»åŒ–â€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒKubernetes ä¸‹ä¸€æ­¥å‘å±•çš„æ–¹å‘ï¼Œæ˜¯ç»„ä»¶çš„è½»é‡åŒ–ã€æ¥å£åŒ–å’Œæ’ä»¶åŒ–ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æ‰æœ‰äº† CRIã€CNIã€CSIã€CRDã€Aggregated APIServerã€Initializerã€Device Plugin ç­‰å„ä¸ªå±‚çº§çš„å¯æ‰©å±•èƒ½åŠ›ã€‚å¯æ˜¯ï¼Œé»˜è®¤è°ƒåº¦å™¨ï¼Œå´æˆäº† Kubernetes é¡¹ç›®é‡Œæœ€åä¸€ä¸ªæ²¡æœ‰å¯¹å¤–æš´éœ²å‡ºè‰¯å¥½å®šä¹‰è¿‡çš„ã€å¯æ‰©å±•æ¥å£çš„ç»„ä»¶ã€‚\nå½“ç„¶ï¼Œè¿™æ˜¯æœ‰ä¸€å®šçš„å†å²åŸå› çš„ã€‚åœ¨è¿‡å»å‡ å¹´ï¼ŒKubernetes å‘å±•çš„é‡ç‚¹ï¼Œéƒ½æ˜¯ä»¥åŠŸèƒ½æ€§éœ€æ±‚çš„å®ç°å’Œå®Œå–„ä¸ºæ ¸å¿ƒã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒçš„å¾ˆå¤šå†³ç­–ï¼Œè¿˜æ˜¯ä»¥ä¼˜å…ˆæœåŠ¡å…¬æœ‰äº‘çš„éœ€æ±‚ä¸ºä¸»ï¼Œè€Œæ€§èƒ½å’Œè§„æ¨¡åˆ™å±…äºç›¸å¯¹æ¬¡è¦çš„ä½ç½®ã€‚\nè€Œç°åœ¨ï¼Œéšç€ Kubernetes é¡¹ç›®é€æ­¥è¶‹äºç¨³å®šï¼Œè¶Šæ¥è¶Šå¤šçš„ç”¨æˆ·å¼€å§‹æŠŠ Kubernetes ç”¨åœ¨è§„æ¨¡æ›´å¤§ã€ä¸šåŠ¡æ›´åŠ å¤æ‚çš„ç§æœ‰é›†ç¾¤å½“ä¸­ã€‚å¾ˆå¤šä»¥å‰çš„ Mesos ç”¨æˆ·ï¼Œä¹Ÿå¼€å§‹å°è¯•ä½¿ç”¨ Kubernetes æ¥æ›¿ä»£å…¶åŸæœ‰æ¶æ„ã€‚åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œå¯¹é»˜è®¤è°ƒåº¦å™¨è¿›è¡Œæ‰©å±•å’Œé‡æ–°å®ç°ï¼Œå°±æˆäº†ç¤¾åŒºå¯¹ Kubernetes é¡¹ç›®æœ€ä¸»è¦çš„ä¸€ä¸ªè¯‰æ±‚ã€‚\næ‰€ä»¥ï¼ŒKubernetes çš„é»˜è®¤è°ƒåº¦å™¨ï¼Œæ˜¯ç›®å‰è¿™ä¸ªé¡¹ç›®é‡Œä¸ºæ•°ä¸å¤šçš„ã€æ­£åœ¨ç»å†å¤§é‡é‡æ„çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚è¿™äº›æ­£åœ¨è¿›è¡Œçš„é‡æ„çš„ç›®çš„ï¼Œä¸€æ–¹é¢æ˜¯å°†é»˜è®¤è°ƒåº¦å™¨é‡Œå¤§é‡çš„â€œæŠ€æœ¯å€ºâ€æ¸…ç†å¹²å‡€ï¼›å¦ä¸€æ–¹é¢ï¼Œå°±æ˜¯ä¸ºé»˜è®¤è°ƒåº¦å™¨çš„å¯æ‰©å±•æ€§è®¾è®¡è¿›è¡Œé“ºå«ã€‚\nè€Œ Kubernetes é»˜è®¤è°ƒåº¦å™¨çš„å¯æ‰©å±•æ€§è®¾è®¡ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€å¹…ç¤ºæ„å›¾æ¥æè¿°ï¼š\nå¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤è°ƒåº¦å™¨çš„å¯æ‰©å±•æœºåˆ¶ï¼Œåœ¨ Kubernetes é‡Œé¢å«ä½œ Scheduler Frameworkã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªè®¾è®¡çš„ä¸»è¦ç›®çš„ï¼Œå°±æ˜¯åœ¨è°ƒåº¦å™¨ç”Ÿå‘½å‘¨æœŸçš„å„ä¸ªå…³é”®ç‚¹ä¸Šï¼Œä¸ºç”¨æˆ·æš´éœ²å‡ºå¯ä»¥è¿›è¡Œæ‰©å±•å’Œå®ç°çš„æ¥å£ï¼Œä»è€Œå®ç°ç”±ç”¨æˆ·è‡ªå®šä¹‰è°ƒåº¦å™¨çš„èƒ½åŠ›ã€‚\nä¸Šå›¾ä¸­ï¼Œæ¯ä¸€ä¸ªç»¿è‰²çš„ç®­å¤´éƒ½æ˜¯ä¸€ä¸ªå¯ä»¥æ’å…¥è‡ªå®šä¹‰é€»è¾‘çš„æ¥å£ã€‚æ¯”å¦‚ï¼Œä¸Šé¢çš„ Queue éƒ¨åˆ†ï¼Œå°±æ„å‘³ç€ä½ å¯ä»¥åœ¨è¿™ä¸€éƒ¨åˆ†æä¾›ä¸€ä¸ªè‡ªå·±çš„è°ƒåº¦é˜Ÿåˆ—çš„å®ç°ï¼Œä»è€Œæ§åˆ¶æ¯ä¸ª Pod å¼€å§‹è¢«è°ƒåº¦ï¼ˆå‡ºé˜Ÿï¼‰çš„æ—¶æœºã€‚\nè€Œ Predicates éƒ¨åˆ†ï¼Œåˆ™æ„å‘³ç€ä½ å¯ä»¥æä¾›è‡ªå·±çš„è¿‡æ»¤ç®—æ³•å®ç°ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œæ¥å†³å®šé€‰æ‹©å“ªäº›æœºå™¨ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°è¿™äº›å¯æ’æ‹”å¼é€»è¾‘ï¼Œéƒ½æ˜¯æ ‡å‡†çš„ Go è¯­è¨€æ’ä»¶æœºåˆ¶ï¼ˆGo plugin æœºåˆ¶ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ éœ€è¦åœ¨ç¼–è¯‘çš„æ—¶å€™é€‰æ‹©æŠŠå“ªäº›æ’ä»¶ç¼–è¯‘è¿›å»ã€‚\næœ‰äº†ä¸Šè¿°è®¾è®¡ä¹‹åï¼Œæ‰©å±•å’Œè‡ªå®šä¹‰ Kubernetes çš„é»˜è®¤è°ƒåº¦å™¨å°±å˜æˆäº†ä¸€ä»¶éå¸¸å®¹æ˜“å®ç°çš„äº‹æƒ…ã€‚è¿™ä¹Ÿæ„å‘³ç€é»˜è®¤è°ƒåº¦å™¨åœ¨åé¢çš„å‘å±•è¿‡ç¨‹ä¸­ï¼Œå¿…ç„¶ä¸ä¼šåœ¨ç°åœ¨çš„å®ç°ä¸Šå†æ·»åŠ å¤ªå¤šçš„åŠŸèƒ½ï¼Œåè€Œè¿˜ä¼šå¯¹ç°åœ¨çš„å®ç°è¿›è¡Œç²¾ç®€ï¼Œæœ€ç»ˆæˆä¸º Scheduler Framework çš„ä¸€ä¸ªæœ€å°å®ç°ã€‚è€Œè°ƒåº¦é¢†åŸŸæ›´å¤šçš„åˆ›æ–°å’Œå·¥ç¨‹å·¥ä½œï¼Œå°±å¯ä»¥äº¤ç»™æ•´ä¸ªç¤¾åŒºæ¥å®Œæˆäº†ã€‚è¿™ä¸ªæ€è·¯ï¼Œæ˜¯å®Œå…¨ç¬¦åˆæˆ‘åœ¨å‰é¢æåˆ°çš„ Kubernetes çš„â€œæ°‘ä¸»åŒ–â€è®¾è®¡çš„ã€‚\nä¸è¿‡ï¼Œè¿™æ ·çš„ Scheduler Framework ä¹Ÿæœ‰ä¸€ä¸ªä¸å°çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯ä¸€æ—¦è¿™äº›æ’å…¥ç‚¹çš„æ¥å£è®¾è®¡ä¸åˆç†ï¼Œå°±ä¼šå¯¼è‡´æ•´ä¸ªç”Ÿæ€æ²¡åŠæ³•å¾ˆå¥½åœ°æŠŠè¿™ä¸ªæ’ä»¶æœºåˆ¶ä½¿ç”¨èµ·æ¥ã€‚è€Œä¸æ­¤åŒæ—¶ï¼Œè¿™äº›æ¥å£æœ¬èº«çš„å˜æ›´åˆæ˜¯ä¸€ä¸ªè´¹æ—¶è´¹åŠ›çš„è¿‡ç¨‹ï¼Œä¸€æ—¦æŠŠæ§ä¸å¥½ï¼Œå°±å¾ˆå¯èƒ½ä¼šæŠŠç¤¾åŒºæ¨å‘å¦ä¸€ä¸ªæç«¯ï¼Œå³ï¼šScheduler Framework æ²¡æ³•å®é™…è½åœ°ï¼Œå¤§å®¶åªå¥½éƒ½å†æ¬¡ fork kube-schedulerã€‚\næ€»ç»“\nåœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ºä½ è¯¦ç»†è®²è§£äº† Kubernetes é‡Œé»˜è®¤è°ƒåº¦å™¨çš„è®¾è®¡ä¸å®ç°ï¼Œåˆ†æäº†å®ƒç°åœ¨æ­£åœ¨ç»å†çš„é‡æ„ï¼Œä»¥åŠæœªæ¥çš„èµ°å‘ã€‚ä¸éš¾çœ‹åˆ°ï¼Œåœ¨ Kubernetes çš„æ•´ä½“æ¶æ„ä¸­ï¼Œkube-scheduler çš„è´£ä»»è™½ç„¶é‡å¤§ï¼Œä½†å…¶å®å®ƒå´æ˜¯åœ¨ç¤¾åŒºé‡Œæœ€å°‘å—åˆ°å…³æ³¨çš„ç»„ä»¶ä¹‹ä¸€ã€‚è¿™é‡Œçš„åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œè°ƒåº¦è¿™ä¸ªäº‹æƒ…ï¼Œåœ¨ä¸åŒçš„å…¬å¸å’Œå›¢é˜Ÿé‡Œçš„å®é™…éœ€æ±‚ä¸€å®šæ˜¯å¤§ç›¸å¾„åº­çš„ï¼Œä¸Šæ¸¸ç¤¾åŒºä¸å¯èƒ½æä¾›ä¸€ä¸ªå¤§è€Œå…¨çš„æ–¹æ¡ˆå‡ºæ¥ã€‚æ‰€ä»¥ï¼Œå°†é»˜è®¤è°ƒåº¦å™¨è¿›ä¸€æ­¥åšè½»åšè–„ï¼Œå¹¶ä¸”æ’ä»¶åŒ–ï¼Œæ‰æ˜¯ kube-scheduler æ­£ç¡®çš„æ¼”è¿›æ–¹å‘ã€‚\næ€è€ƒé¢˜\nè¯·é—®ï¼ŒKubernetes é»˜è®¤è°ƒåº¦å™¨ä¸ Mesos çš„â€œä¸¤çº§â€è°ƒåº¦å™¨ï¼Œæœ‰ä»€ä¹ˆå¼‚åŒå‘¢ï¼Ÿ\né—®é¢˜å›ç­”ï¼šmessosäºŒçº§è°ƒåº¦æ˜¯èµ„æºè°ƒåº¦å’Œä¸šåŠ¡è°ƒåº¦åˆ†å¼€ï¼›ä¼˜ç‚¹ï¼šæ’ä»¶åŒ–è°ƒåº¦æ¡†æ¶ï¼ˆç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰è‡ªå·±è°ƒåº¦å™¨ç„¶åæ³¨å†Œåˆ°messosèµ„æºè°ƒåº¦æ¡†æ¶å³å¯ï¼‰ï¼Œçµæ´»å¯æ‰©å±•æ€§é«˜.ç¼ºç‚¹ï¼šèµ„æºå’Œä¸šåŠ¡è°ƒåº¦åˆ†å¼€æ— æ³•è·å–èµ„æºä½¿ç”¨æƒ…å†µï¼Œè¿›è€Œæ— æ³•åšæ›´ç»†ç²’åº¦çš„è°ƒåº¦.k8sè°ƒåº¦æ˜¯ç»Ÿä¸€è°ƒåº¦ä¹Ÿå°±æ˜¯ä¸šåŠ¡å’Œèµ„æºè°ƒåº¦è¿›è¡Œç»Ÿä¸€è°ƒåº¦ï¼Œå¯ä»¥è¿›è¡Œæ›´ç»†ç²’åº¦çš„è°ƒåº¦ï¼›ç¼ºç‚¹å…¶è°ƒåº¦å™¨æ‰©å±•æ€§å·®ã€‚\n","date":"2021å¹´04æœˆ21æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter6/default-scheduler/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡æ¥è‡ªå¼ ç£Šè€å¸ˆçš„\u003ca href=\"https://time.geekbang.org/column/article/69678\"\u003eã€Šæ·±å…¥å‰–æKuberntesã€‹\u003c/a\u003eè¯¾ç¨‹ç¬”è®°ï¼Œè¯·å‹¿è½¬è½½ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e","title":"åå­—è·¯å£ä¸Šçš„Kubernetesé»˜è®¤è°ƒåº¦å™¨"},{"contents":"QOS çš„ä½œç”¨è¯·å‚è€ƒä¸Šé¢çš„å‡ ç¯‡æ–‡ç« Kubernetesçš„èµ„æºæ¨¡å‹å’Œèµ„æºç®¡ç†\nqos\n// pkg/apis/core/v1/helper/qos/qos.go func GetPodQOS(pod *v1.Pod) v1.PodQOSClass { requests := v1.ResourceList{} limits := v1.ResourceList{} zeroQuantity := resource.MustParse(\u0026quot;0\u0026quot;) isGuaranteed := true allContainers := []v1.Container{} allContainers = append(allContainers, pod.Spec.Containers...) allContainers = append(allContainers, pod.Spec.InitContainers...) for _, container := range allContainers { // process requests for name, quantity := range container.Resources.Requests { if !isSupportedQoSComputeResource(name) { continue } if quantity.Cmp(zeroQuantity) == 1 { delta := quantity.DeepCopy() if _, exists := requests[name]; !exists { requests[name] = delta } else { delta.Add(requests[name]) requests[name] = delta } } } // process limits qosLimitsFound := sets.NewString() for name, quantity := range container.Resources.Limits { if !isSupportedQoSComputeResource(name) { continue } if quantity.Cmp(zeroQuantity) == 1 { qosLimitsFound.Insert(string(name)) delta := quantity.DeepCopy() if _, exists := limits[name]; !exists { limits[name] = delta } else { delta.Add(limits[name]) limits[name] = delta } } } if !qosLimitsFound.HasAll(string(v1.ResourceMemory), string(v1.ResourceCPU)) { isGuaranteed = false } } if len(requests) == 0 \u0026amp;\u0026amp; len(limits) == 0 { return v1.PodQOSBestEffort } // Check is requests match limits for all resources. if isGuaranteed { for name, req := range requests { if lim, exists := limits[name]; !exists || lim.Cmp(req) != 0 { isGuaranteed = false break } } } if isGuaranteed \u0026amp;\u0026amp; len(requests) == len(limits) { return v1.PodQOSGuaranteed } return v1.PodQOSBurstable }  ä¸Šé¢æœ‰æ³¨é‡Šæˆ‘å°±ä¸è¿‡å¤šä»‹ç»ï¼Œéå¸¸çš„ç®€å•ã€‚\nä¸‹é¢è¿™é‡Œæ˜¯QOS OOMæ‰“åˆ†æœºåˆ¶ï¼Œé€šè¿‡ç»™ä¸åŒçš„podæ‰“åˆ†æ¥åˆ¤æ–­ï¼Œå“ªäº›podå¯ä»¥è¢«ä¼˜å…ˆkillæ‰ï¼Œåˆ†æ•°è¶Šé«˜çš„è¶Šå®¹æ˜“è¢«killã€‚\npolicy\n//\\pkg\\kubelet\\qos\\policy.go // åˆ†å€¼è¶Šé«˜è¶Šå®¹æ˜“è¢«kill const ( // KubeletOOMScoreAdj is the OOM score adjustment for Kubelet KubeletOOMScoreAdj int = -999 // KubeProxyOOMScoreAdj is the OOM score adjustment for kube-proxy KubeProxyOOMScoreAdj int = -999 guaranteedOOMScoreAdj int = -998 besteffortOOMScoreAdj int = 1000 )  policy#GetContainerOOMScoreAdjust\n// pkg/kubelet/qos/policy.go // GetContainerOOMScoreAdjust returns the amount by which the OOM score of all processes in the // container should be adjusted. // The OOM score of a process is the percentage of memory it consumes // multiplied by 10 (barring exceptional cases) + a configurable quantity which is between -1000 // and 1000. Containers with higher OOM scores are killed if the system runs out of memory. // See https://lwn.net/Articles/391222/ for more information. func GetContainerOOMScoreAdjust(pod *v1.Pod, container *v1.Container, memoryCapacity int64) int { if types.IsNodeCriticalPod(pod) { // Only node critical pod should be the last to get killed. return guaranteedOOMScoreAdj } switch v1qos.GetPodQOS(pod) { case v1.PodQOSGuaranteed: // Guaranteed containers should be the last to get killed. return guaranteedOOMScoreAdj case v1.PodQOSBestEffort: return besteffortOOMScoreAdj } // Burstable containers are a middle tier, between Guaranteed and Best-Effort. Ideally, // we want to protect Burstable containers that consume less memory than requested. // The formula below is a heuristic. A container requesting for 10% of a system's // memory will have an OOM score adjust of 900. If a process in container Y // uses over 10% of memory, its OOM score will be 1000. The idea is that containers // which use more than their request will have an OOM score of 1000 and will be prime // targets for OOM kills. // Note that this is a heuristic, it won't work if a container has many small processes. memoryRequest := container.Resources.Requests.Memory().Value() oomScoreAdjust := 1000 - (1000*memoryRequest)/memoryCapacity // A guaranteed pod using 100% of memory can have an OOM score of 10. Ensure // that burstable pods have a higher OOM score adjustment. if int(oomScoreAdjust) \u0026lt; (1000 + guaranteedOOMScoreAdj) { return (1000 + guaranteedOOMScoreAdj) } // Give burstable pods a higher chance of survival over besteffort pods. if int(oomScoreAdjust) == besteffortOOMScoreAdj { return int(oomScoreAdjust - 1) } return int(oomScoreAdjust) }  è¿™ä¸ªå‡½æ•°è¿”å›å®¹å™¨ä¸­æ‰€æœ‰è¿›ç¨‹çš„OOMåˆ†æ•°ã€‚è¿›ç¨‹çš„OOMåˆ†æ•°æ˜¯å…¶æ¶ˆè€—çš„å†…å­˜ç™¾åˆ†æ¯”ä¹˜ä»¥10(é™¤éæœ‰ç‰¹æ®Šæƒ…å†µ)å†åŠ ä¸Šä¸€ä¸ªå¯é…ç½®çš„æ•°ï¼Œè¿™ä¸ªæ•°åœ¨ -1000 åˆ° 1000 ä¹‹é—´ã€‚å½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼ŒOOM åˆ†æ•°è¶Šé«˜çš„å®¹å™¨è¶Šå®¹æ˜“è¢«killæ‰ã€‚\nå¯¹äºé™æ€Podã€é•œåƒPodå’Œé«˜ä¼˜å…ˆçº§Podï¼ŒQoSç›´æ¥è¢«è®¾ç½®æˆä¸ºGuaranteedï¼Œè€Œ Guaranteed ç­‰çº§çš„å®¹å™¨æœ€åè¢« killã€‚Besteffort ç­‰çº§çš„å®¹å™¨æœ€å®¹æ˜“è¢«åˆ æ‰ï¼Œè€Œå¤„äºä¸­é—´ä½ç½®çš„ Burstable ç­‰çº§çš„ Podã€‚\nç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦ä¿æŠ¤æ¶ˆè€—å°‘äºè¯·æ±‚çš„å†…å­˜çš„Burstableå®¹å™¨ã€‚è¿™é‡Œé‡‡ç”¨äº†ä¸€ç§å¯å‘å¼è®¡ç®—ï¼š\noomScoreAdjust = 1000 - (1000*memoryRequest)/memoryCapacity   é—®é¢˜ï¼šè¿™é‡Œçš„memoryRequest å•ä½æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦ä¹˜ä»¥1000\n è¯·æ±‚ç³»ç»Ÿå†…å­˜çš„10ï¼…çš„å®¹å™¨çš„OOMå¾—åˆ†è°ƒæ•´ä¸º900ã€‚å¦‚æœå®¹å™¨Yä¸­çš„è¿›ç¨‹ä½¿ç”¨äº†è¶…è¿‡10ï¼…çš„å†…å­˜ï¼Œåˆ™å…¶OOMå¾—åˆ†å°†ä¸º1000ã€‚å®¹å™¨ä½¿ç”¨çš„å†…å­˜æ¯”å…¶è¯·æ±‚å¤šï¼Œé‚£ä¹ˆOOMå¾—åˆ†å°†ä¸º1000ï¼Œå¹¶ä¸”å°†æ˜¯OOM killçš„ä¸»è¦ç›®æ ‡ã€‚å¦‚æœåˆ†æ•°å°äº1000 + guaranteedOOMScoreAdjï¼Œä¹Ÿå°±æ˜¯2åˆ†ï¼Œé‚£ä¹ˆè¢«ç›´æ¥è®¾ç½®æˆ2åˆ†ï¼Œé¿å…åˆ†æ•°è¿‡ä½ã€‚\nå‚è€ƒæ–‡çŒ®\n https://lwn.net/Articles/391222/ ","date":"2021å¹´04æœˆ20æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter6/qos-sc/","summary":"\u003cp\u003eQOS çš„ä½œç”¨è¯·å‚è€ƒä¸Šé¢çš„å‡ ç¯‡æ–‡ç« \u003ca href=\"https://chenxq.xyz/post/cloud-k8s-resource-model-and-resource-manager/\"\u003eKubernetesçš„èµ„æºæ¨¡å‹å’Œèµ„æºç®¡ç†\u003c/a\u003e\u003c/p\u003e","title":"QoS æºä»£ç åˆ†æ"},{"contents":"äºŒå‰æ ‘çš„éå†æ–¹æ³•åˆ†ä¸ºå…ˆåºéå†ï¼Œä¸­åºéå†ï¼Œååºéå†ä»¥åŠå±‚åºéå†è¿™å››ç§ï¼Œå…¶ä¸­å…ˆåºï¼Œä¸­åºä»¥åŠååºåˆå¯ä»¥ç”¨é€’å½’å’Œéé€’å½’çš„æ–¹å¼æ¥å®ç°ï¼Œå±‚åºéå†ä¸€èˆ¬åˆ™æ˜¯ç”¨ä¸€ä¸ªé˜Ÿåˆ—æ¥å®ç°ã€‚å…³äºè¿™å‡ ç§éå†æ–¹å¼å’Œä»£ç å¯ä»¥å‚è€ƒæœ¬åšå®¢çš„ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« \u0026mdash;\u0026gt;ä¼ é€é—¨\nè¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¸€é“ leetcode é¢˜ç›®æ¥å¯¹äºŒå‰æ ‘çš„ä¸­åºéå†æ³•å±•å¼€è®¨è®ºã€‚è¿™é“é¢˜çš„æè¿°å¦‚ä¸‹ï¼š\nleetcode 94 [https://leetcode-cn.com/problems/binary-tree-inorder-traversal/] ç»™å®šä¸€ä¸ªäºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root ï¼Œè¿”å›å®ƒçš„ ä¸­åº éå†ã€‚ ç¤ºä¾‹1ï¼š 1 \\ 2 / 3 è¾“å…¥ï¼šroot = [1,null,2,3] è¾“å‡ºï¼š[1,3,2]  1. é€’å½’ é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ä»€ä¹ˆæ˜¯äºŒå‰æ ‘çš„ä¸­åºéå†ï¼šæŒ‰ç…§è®¿é—®å·¦å­æ ‘â€”â€”æ ¹èŠ‚ç‚¹â€”â€”å³å­æ ‘çš„æ–¹å¼éå†è¿™æ£µæ ‘ï¼Œè€Œåœ¨è®¿é—®å·¦å­æ ‘æˆ–è€…å³å­æ ‘çš„æ—¶å€™æˆ‘ä»¬æŒ‰ç…§åŒæ ·çš„æ–¹å¼éå†ï¼Œç›´åˆ°éå†å®Œæ•´æ£µæ ‘ã€‚å› æ­¤æ•´ä¸ªéå†è¿‡ç¨‹å¤©ç„¶å…·æœ‰é€’å½’çš„æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨é€’å½’å‡½æ•°æ¥æ¨¡æ‹Ÿè¿™ä¸€è¿‡ç¨‹ã€‚\nå®šä¹‰ inorder(root) è¡¨ç¤ºå½“å‰éå†åˆ°rootèŠ‚ç‚¹çš„ç­”æ¡ˆï¼Œé‚£ä¹ˆæŒ‰ç…§å®šä¹‰ï¼Œæˆ‘ä»¬åªè¦é€’å½’è°ƒç”¨ inorder(root.left) æ¥éå† root èŠ‚ç‚¹çš„å·¦å­æ ‘ï¼Œç„¶åå°† root èŠ‚ç‚¹çš„å€¼åŠ å…¥ç­”æ¡ˆï¼Œå†é€’å½’è°ƒç”¨ inorder(root.right) æ¥éå† root èŠ‚ç‚¹çš„å³å­æ ‘å³å¯ï¼Œé€’å½’ç»ˆæ­¢çš„æ¡ä»¶ä¸ºç¢°åˆ°ç©ºèŠ‚ç‚¹ã€‚\nclass Solution { public List\u0026lt;Integer\u0026gt; inorderTraversal(TreeNode root) { List\u0026lt;Integer\u0026gt; res = new ArrayList\u0026lt;Integer\u0026gt;(); inorder(root, res); return res; } public void inorder(TreeNode root, List\u0026lt;Integer\u0026gt; res) { if (root == null) { return; } inorder(root.left, res); res.add(root.val); inorder(root.right, res); } }  2. è¿­ä»£ æ–¹æ³•ä¸€çš„é€’å½’å‡½æ•°æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨è¿­ä»£çš„æ–¹å¼å®ç°ï¼Œä¸¤ç§æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼ŒåŒºåˆ«åœ¨äºé€’å½’çš„æ—¶å€™éšå¼åœ°ç»´æŠ¤äº†ä¸€ä¸ªæ ˆï¼Œè€Œæˆ‘ä»¬åœ¨è¿­ä»£çš„æ—¶å€™éœ€è¦æ˜¾å¼åœ°å°†è¿™ä¸ªæ ˆæ¨¡æ‹Ÿå‡ºæ¥ï¼Œå…¶ä»–éƒ½ç›¸åŒï¼Œå…·ä½“å®ç°å¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç ã€‚\nclass Solution { public List\u0026lt;Integer\u0026gt; inorderTraversal(TreeNode root) { List\u0026lt;Integer\u0026gt; res = new ArrayList\u0026lt;Integer\u0026gt;(); // å®šä¹‰ä¸€ä¸ªæ ˆ Deque\u0026lt;TreeNode\u0026gt; stk = new LinkedList\u0026lt;TreeNode\u0026gt;(); // èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå¹¶ä¸”æ ˆä¸ä¸ºç©º while (root != null || !stk.isEmpty()) { // ä¸€ç›´èµ°åˆ°æœ€å·¦çš„èŠ‚ç‚¹ï¼Œè¾¹èµ°è¾¹å‹æ ˆ while (root != null) { stk.push(root); root = root.left; } // ä»æœ€å·¦çš„èŠ‚ç‚¹å¼€å§‹å¼¹æ ˆ,å¹¶ä¸”åˆ¤æ–­å³èŠ‚ç‚¹æ˜¯å¦ä¸ºç©º root = stk.pop(); res.add(root.val); root = root.right; } return res; } }  3. Morris ä¸­åºéå† Morris éå†ç®—æ³•æ˜¯å¦ä¸€ç§éå†äºŒå‰æ ‘çš„æ–¹æ³•ï¼Œå®ƒèƒ½å°†éé€’å½’çš„ä¸­åºéå†ç©ºé—´å¤æ‚åº¦é™ä¸º O(1)ã€‚\nMorris éå†ç®—æ³•æ•´ä½“æ­¥éª¤å¦‚ä¸‹ï¼ˆå‡è®¾å½“å‰éå†åˆ°çš„èŠ‚ç‚¹ä¸º xï¼‰ï¼š\n å¦‚æœ x æ— å·¦å­©å­ï¼Œå…ˆå°† x çš„å€¼åŠ å…¥ç­”æ¡ˆæ•°ç»„ï¼Œå†è®¿é—® x çš„å³å­©å­ï¼Œå³ x=x.rightã€‚ å¦‚æœ x æœ‰å·¦å­©å­ï¼Œåˆ™æ‰¾åˆ° x å·¦å­æ ‘ä¸Šæœ€å³çš„èŠ‚ç‚¹ï¼ˆå³å·¦å­æ ‘ä¸­åºéå†çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œx åœ¨ä¸­åºéå†ä¸­çš„å‰é©±èŠ‚ç‚¹ï¼‰ï¼Œæˆ‘ä»¬è®°ä¸º predecessorã€‚æ ¹æ® predecessor çš„å³å­©å­æ˜¯å¦ä¸ºç©ºï¼Œè¿›è¡Œå¦‚ä¸‹æ“ä½œã€‚ å¦‚æœ predecessor çš„å³å­©å­ä¸ºç©ºï¼Œåˆ™å°†å…¶å³å­©å­æŒ‡å‘ xï¼Œç„¶åè®¿é—® x çš„å·¦å­©å­ï¼Œå³ x=x.leftã€‚ å¦‚æœ predecessor çš„å³å­©å­ä¸ä¸ºç©ºï¼Œåˆ™æ­¤æ—¶å…¶å³å­©å­æŒ‡å‘ xï¼Œè¯´æ˜æˆ‘ä»¬å·²ç»éå†å®Œ x çš„å·¦å­æ ‘ï¼Œæˆ‘ä»¬å°† predecessor çš„å³å­©å­ç½®ç©ºï¼Œå°† x çš„å€¼åŠ å…¥ç­”æ¡ˆæ•°ç»„ï¼Œç„¶åè®¿é—® x çš„å³å­©å­ï¼Œå³ x=x.rightã€‚ é‡å¤ä¸Šè¿°æ“ä½œï¼Œç›´è‡³è®¿é—®å®Œæ•´æ£µæ ‘ã€‚  å…¶å®æ•´ä¸ªè¿‡ç¨‹æˆ‘ä»¬å°±å¤šåšä¸€æ­¥ï¼šå‡è®¾å½“å‰éå†åˆ°çš„èŠ‚ç‚¹ä¸º xï¼Œå°† x çš„å·¦å­æ ‘ä¸­æœ€å³è¾¹çš„èŠ‚ç‚¹çš„å³å­©å­æŒ‡å‘ xï¼Œè¿™æ ·åœ¨å·¦å­æ ‘éå†å®Œæˆåæˆ‘ä»¬é€šè¿‡è¿™ä¸ªæŒ‡å‘èµ°å›äº† xï¼Œä¸”èƒ½é€šè¿‡è¿™ä¸ªæŒ‡å‘çŸ¥æ™“æˆ‘ä»¬å·²ç»éå†å®Œæˆäº†å·¦å­æ ‘ï¼Œè€Œä¸ç”¨å†é€šè¿‡æ ˆæ¥ç»´æŠ¤ï¼Œçœå»äº†æ ˆçš„ç©ºé—´å¤æ‚åº¦ã€‚\nclass Solution { public List\u0026lt;Integer\u0026gt; inorderTraversal(TreeNode root) { List\u0026lt;Integer\u0026gt; res = new ArrayList\u0026lt;Integer\u0026gt;(); TreeNode predecessor = null; while (root != null) { if (root.left != null) { // predecessor èŠ‚ç‚¹å°±æ˜¯å½“å‰ root èŠ‚ç‚¹å‘å·¦èµ°ä¸€æ­¥ï¼Œç„¶åä¸€ç›´å‘å³èµ°è‡³æ— æ³•èµ°ä¸ºæ­¢ predecessor = root.left; while (predecessor.right != null \u0026amp;\u0026amp; predecessor.right != root) { predecessor = predecessor.right; } // è®© predecessor çš„å³æŒ‡é’ˆæŒ‡å‘ rootï¼Œç»§ç»­éå†å·¦å­æ ‘ if (predecessor.right == null) { predecessor.right = root; root = root.left; } // è¯´æ˜å·¦å­æ ‘å·²ç»è®¿é—®å®Œäº†ï¼Œæˆ‘ä»¬éœ€è¦æ–­å¼€é“¾æ¥ else { res.add(root.val); predecessor.right = null; root = root.right; } } // å¦‚æœæ²¡æœ‰å·¦å­©å­ï¼Œåˆ™ç›´æ¥è®¿é—®å³å­©å­ else { res.add(root.val); root = root.right; } } return res; } }  å¤æ‚åº¦åˆ†æ\næ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­ n ä¸ºäºŒå‰æœç´¢æ ‘çš„èŠ‚ç‚¹ä¸ªæ•°ã€‚Morris éå†ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¼šè¢«è®¿é—®ä¸¤æ¬¡ï¼Œå› æ­¤æ€»æ—¶é—´å¤æ‚åº¦ä¸º O(2n)=O(n)ã€‚\nç©ºé—´å¤æ‚åº¦ï¼šO(1)ã€‚\n","date":"2021å¹´04æœˆ15æ—¥","permalink":"https://ahamoment.cn/posts/algorithm/algorithm-tree-inorder/","summary":"äºŒå‰æ ‘çš„éå†æ–¹æ³•åˆ†ä¸ºå…ˆåºéå†ï¼Œä¸­åºéå†ï¼Œååºéå†ä»¥åŠå±‚åºéå†è¿™å››ç§ï¼Œå…¶ä¸­å…ˆåºï¼Œä¸­åºä»¥åŠååºåˆå¯ä»¥ç”¨é€’å½’å’Œéé€’å½’çš„æ–¹å¼æ¥å®ç°ï¼Œå±‚åºéå†ä¸€èˆ¬åˆ™æ˜¯ç”¨ä¸€ä¸ªé˜Ÿåˆ—æ¥å®ç°ã€‚å…³äºè¿™å‡ ç§éå†æ–¹å¼å’Œä»£ç å¯ä»¥å‚è€ƒæœ¬åšå®¢çš„ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« \u0026mdash;\u0026gt;ä¼ é€é—¨\nè¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¸€é“ leetcode é¢˜ç›®æ¥å¯¹äºŒå‰æ ‘çš„ä¸­åºéå†æ³•å±•å¼€è®¨è®ºã€‚è¿™é“é¢˜çš„æè¿°å¦‚ä¸‹ï¼š\nleetcode 94 [https://leetcode-cn.com/problems/binary-tree-inorder-traversal/] ç»™å®šä¸€ä¸ªäºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root ï¼Œè¿”å›å®ƒçš„ ä¸­åº éå†ã€‚ ç¤ºä¾‹1ï¼š 1 \\ 2 / 3 è¾“å…¥ï¼šroot = [1,null,2,3] è¾“å‡ºï¼š[1,3,2]  1.","title":"äºŒå‰æ ‘çš„ä¸­åºéå†"},{"contents":" æœ¬æ–‡æ¥è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æKuberntesã€‹è¯¾ç¨‹ç¬”è®°ï¼Œè¯·å‹¿è½¬è½½ã€‚\n ä½œä¸ºä¸€ä¸ªå®¹å™¨é›†ç¾¤ç¼–æ’ä¸ç®¡ç†é¡¹ç›®ï¼ŒKubernetes ä¸ºç”¨æˆ·æä¾›çš„åŸºç¡€è®¾æ–½èƒ½åŠ›ï¼Œä¸ä»…åŒ…æ‹¬äº†æˆ‘åœ¨å‰é¢ä¸ºä½ è®²è¿°çš„åº”ç”¨å®šä¹‰å’Œæè¿°çš„éƒ¨åˆ†ï¼Œè¿˜åŒ…æ‹¬äº†å¯¹åº”ç”¨çš„èµ„æºç®¡ç†å’Œè°ƒåº¦çš„å¤„ç†ã€‚é‚£ä¹ˆï¼Œä»ä»Šå¤©è¿™ç¯‡æ–‡ç« å¼€å§‹ï¼Œæˆ‘å°±æ¥ä¸ºä½ è¯¦ç»†è®²è§£ä¸€ä¸‹åé¢è¿™éƒ¨åˆ†å†…å®¹ã€‚\n1. èµ„æºæ¨¡å‹ è€Œä½œä¸º Kubernetes çš„èµ„æºç®¡ç†ä¸è°ƒåº¦éƒ¨åˆ†çš„åŸºç¡€ï¼Œæˆ‘ä»¬è¦ä»å®ƒçš„èµ„æºæ¨¡å‹å¼€å§‹è¯´èµ·ã€‚\næˆ‘åœ¨å‰é¢çš„æ–‡ç« ä¸­å·²ç»æåˆ°è¿‡ï¼Œåœ¨ Kubernetes é‡Œï¼ŒPod æ˜¯æœ€å°çš„åŸå­è°ƒåº¦å•ä½ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œæ‰€æœ‰è·Ÿè°ƒåº¦å’Œèµ„æºç®¡ç†ç›¸å…³çš„å±æ€§éƒ½åº”è¯¥æ˜¯å±äº Pod å¯¹è±¡çš„å­—æ®µã€‚è€Œè¿™å…¶ä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå°±æ˜¯ Pod çš„ CPU å’Œå†…å­˜é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: v1 kind: Pod metadata: name: frontend spec: containers: - name: db image: mysql env: - name: MYSQL_ROOT_PASSWORD value: \u0026quot;password\u0026quot; resources: requests: memory: \u0026quot;64Mi\u0026quot; cpu: \u0026quot;250m\u0026quot; limits: memory: \u0026quot;128Mi\u0026quot; cpu: \u0026quot;500m\u0026quot; - name: wp image: wordpress resources: requests: memory: \u0026quot;64Mi\u0026quot; cpu: \u0026quot;250m\u0026quot; limits: memory: \u0026quot;128Mi\u0026quot; cpu: \u0026quot;500m\u0026quot;   å¤‡æ³¨ï¼šå…³äºå“ªäº›å±æ€§å±äº Pod å¯¹è±¡ï¼Œè€Œå“ªäº›å±æ€§å±äº Containerï¼Œä½ å¯ä»¥åœ¨å›é¡¾ä¸€ä¸‹ç¬¬ 14 ç¯‡æ–‡ç« ã€Šæ·±å…¥è§£æ Pod å¯¹è±¡ï¼ˆä¸€ï¼‰ï¼šåŸºæœ¬æ¦‚å¿µã€‹ä¸­çš„ç›¸å…³å†…å®¹ã€‚\n åœ¨ Kubernetes ä¸­ï¼Œåƒ CPU è¿™æ ·çš„èµ„æºè¢«ç§°ä½œâ€œå¯å‹ç¼©èµ„æºâ€ï¼ˆcompressible resourcesï¼‰ã€‚å®ƒçš„å…¸å‹ç‰¹ç‚¹æ˜¯ï¼Œå½“å¯å‹ç¼©èµ„æºä¸è¶³æ—¶ï¼ŒPod åªä¼šâ€œé¥¥é¥¿â€ï¼Œä½†ä¸ä¼šé€€å‡ºã€‚è€Œåƒå†…å­˜è¿™æ ·çš„èµ„æºï¼Œåˆ™è¢«ç§°ä½œâ€œä¸å¯å‹ç¼©èµ„æºï¼ˆincompressible resourcesï¼‰ã€‚å½“ä¸å¯å‹ç¼©èµ„æºä¸è¶³æ—¶ï¼ŒPod å°±ä¼šå› ä¸º OOMï¼ˆOut-Of-Memoryï¼‰è¢«å†…æ ¸æ€æ‰ã€‚\nè€Œç”±äº Pod å¯ä»¥ç”±å¤šä¸ª Container ç»„æˆï¼Œæ‰€ä»¥ CPU å’Œå†…å­˜èµ„æºçš„é™é¢ï¼Œæ˜¯è¦é…ç½®åœ¨æ¯ä¸ª Container çš„å®šä¹‰ä¸Šçš„ã€‚è¿™æ ·ï¼ŒPod æ•´ä½“çš„èµ„æºé…ç½®ï¼Œå°±ç”±è¿™äº› Container çš„é…ç½®å€¼ç´¯åŠ å¾—åˆ°ã€‚\nå…¶ä¸­ï¼ŒKubernetes é‡Œä¸º CPU è®¾ç½®çš„å•ä½æ˜¯â€œCPU çš„ä¸ªæ•°â€ã€‚æ¯”å¦‚ï¼Œcpu=1 æŒ‡çš„å°±æ˜¯ï¼Œè¿™ä¸ª Pod çš„ CPU é™é¢æ˜¯ 1 ä¸ª CPUã€‚å½“ç„¶ï¼Œå…·ä½“â€œ1 ä¸ª CPUâ€åœ¨å®¿ä¸»æœºä¸Šå¦‚ä½•è§£é‡Šï¼Œæ˜¯ 1 ä¸ª CPU æ ¸å¿ƒï¼Œè¿˜æ˜¯ 1 ä¸ª vCPUï¼Œè¿˜æ˜¯ 1 ä¸ª CPU çš„è¶…çº¿ç¨‹ï¼ˆHyperthreadï¼‰ï¼Œå®Œå…¨å–å†³äºå®¿ä¸»æœºçš„ CPU å®ç°æ–¹å¼ã€‚Kubernetes åªè´Ÿè´£ä¿è¯ Pod èƒ½å¤Ÿä½¿ç”¨åˆ°â€œ1 ä¸ª CPUâ€çš„è®¡ç®—èƒ½åŠ›ã€‚\n å¤‡æ³¨ï¼šå…³äºCPUçš„å‡ ä¸ªæ¦‚å¿µï¼Œç‰©ç†CPUï¼Œç‰©ç†æ ¸ï¼Œé€»è¾‘CPUï¼ŒvCPUçš„åŒºåˆ«\na. ç‰©ç†CPU:ç‰©ç†CPUæ˜¯ç›¸å¯¹äºè™šæ‹ŸCPUè€Œè¨€çš„æ¦‚å¿µï¼ŒæŒ‡å®é™…å­˜åœ¨çš„å¤„ç†å™¨,å°±æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹çš„è§ï¼Œæ‘¸å¾—ç€çš„CPUï¼Œå°±æ˜¯æ’åœ¨ä¸»æ¿ä¸Šé¢çš„ã€‚\nb. ç‰©ç†æ ¸ï¼šCPUä¸­åŒ…å«çš„ç‰©ç†å†…æ ¸ä¸ªæ•°ï¼Œæ¯”å¦‚æˆ‘ä»¬é€šå¸¸è¯´çš„åŒæ ¸CPUï¼Œå•æ ¸CPUã€‚è¿™ä¸ªå‘¢æœ‰ç‚¹çœ‹ä¸è§æ‘¸ä¸ç€ï¼Œå·²ç»é›†æˆåœ¨CPUå†…éƒ¨äº†ã€‚åœ¨linuxç³»ç»Ÿä¸‹é¢çš„/proc/cpuinfoæ–‡ä»¶çš„æ¡ç›®ä¸­ï¼š1.æœ‰å¤šå°‘ä¸ªä¸åŒçš„physical idå°±æœ‰å¤šå°‘ä¸ªç‰©ç†CPUã€‚2.cpu coresè®°å½•äº†å¯¹åº”çš„ç‰©ç†CPUï¼ˆä»¥è¯¥æ¡ç›®ä¸­çš„physical idæ ‡è¯†ï¼‰æœ‰å¤šå°‘ä¸ªç‰©ç†æ ¸ï¼Œç°åœ¨æˆ‘ä»¬ä¸ªäººä½¿ç”¨çš„å•æœºPCå¤§éƒ¨åˆ†ä½¿ç”¨çš„éƒ½æ˜¯åŒæ ¸CPUã€‚\nc. é€»è¾‘CPUï¼ˆé€»è¾‘æ ¸ï¼‰ï¼šç”¨Intelçš„è¶…çº¿ç¨‹æŠ€æœ¯(HT)å°†ç‰©ç†æ ¸è™šæ‹Ÿè€Œæˆçš„é€»è¾‘å¤„ç†å•å…ƒ,ç°åœ¨å¤§éƒ¨åˆ†çš„ä¸»æœºçš„CPUéƒ½åœ¨ä½¿ç”¨HTæŠ€æœ¯ï¼Œæˆ‘ä»¬åœ¨windowsç³»ç»Ÿä¸‹é¢çœ‹ä¸‹å›¾ï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰4ä¸ªcpuè®°å½•ï¼Œå…¶å®æˆ‘ä»¬ä½¿ç”¨çš„åŒæ ¸CPUåªæ˜¯ä½¿ç”¨HTæŠ€æœ¯è™šæ‹Ÿå‡ºæ¥4ä¸ªé€»è¾‘CPU.åœ¨linuxç³»ç»Ÿä¸‹é¢çš„/proc/cpuinfoæ–‡ä»¶çš„æ¡ç›®ä¸­siblingsè®°å½•äº†å¯¹åº”çš„ç‰©ç†CPUï¼ˆä»¥è¯¥æ¡ç›®ä¸­çš„physical idæ ‡è¯†ï¼‰æœ‰å¤šå°‘ä¸ªé€»è¾‘æ ¸ã€‚\nd. vCPU:è™šæ‹Ÿcpuæ˜¯æˆ‘ä»¬åœ¨åšè™šæ‹ŸåŒ–æ—¶å€™ï¼Œåˆ©ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œè™šæ‹Ÿå‡ºæ¥çš„CPUã€‚è®¨è®ºvCPUç¦»ä¸å¼€VMï¼Œå› æ­¤vCPUçš„è®¨è®ºéƒ½æ˜¯åœ¨è™šæ‹ŸåŒ–æ—¶å€™ï¼Œåˆ’åˆ†cpuæ‰ä¼šè®¨è®ºçš„é—®é¢˜ã€‚é€šå¸¸ä¸€ä¸ªç‰©ç†CPUæŒ‰ç…§1:4â€”â€”1ï¼š10çš„æ¯”ä¾‹åˆ’åˆ†ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰4ä¸ª8ç‰©ç†æ ¸å¿ƒçš„CPUæŒ‰ç…§1:5çš„æ¯”ä¾‹åˆ’åˆ†ï¼Œå¯ä»¥å¾—åˆ°4X8X5=160vCPU.\n æ­¤å¤–ï¼ŒKubernetes å…è®¸ä½ å°† CPU é™é¢è®¾ç½®ä¸ºåˆ†æ•°ï¼Œæ¯”å¦‚åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼ŒCPU limits çš„å€¼å°±æ˜¯ 500mã€‚æ‰€è°“ 500mï¼ŒæŒ‡çš„å°±æ˜¯ 500 millicpuï¼Œä¹Ÿå°±æ˜¯ 0.5 ä¸ª CPU çš„æ„æ€ã€‚è¿™æ ·ï¼Œè¿™ä¸ª Pod å°±ä¼šè¢«åˆ†é…åˆ° 1 ä¸ª CPU ä¸€åŠçš„è®¡ç®—èƒ½åŠ›ã€‚\nå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥æŠŠè¿™ä¸ªé…ç½®å†™æˆ cpu=0.5ã€‚ä½†åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæˆ‘è¿˜æ˜¯æ¨èä½ ä½¿ç”¨ 500m çš„å†™æ³•ï¼Œæ¯•ç«Ÿè¿™æ‰æ˜¯ Kubernetes å†…éƒ¨é€šç”¨çš„ CPU è¡¨ç¤ºæ–¹å¼ã€‚\nè€Œå¯¹äºå†…å­˜èµ„æºæ¥è¯´ï¼Œå®ƒçš„å•ä½è‡ªç„¶å°±æ˜¯ bytesã€‚Kubernetes æ”¯æŒä½ ä½¿ç”¨ Eiã€Piã€Tiã€Giã€Miã€Kiï¼ˆæˆ–è€… Eã€Pã€Tã€Gã€Mã€Kï¼‰çš„æ–¹å¼æ¥ä½œä¸º bytes çš„å€¼ã€‚æ¯”å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼ŒMemory requests çš„å€¼å°±æ˜¯ 64MiB (2 çš„ 26 æ¬¡æ–¹ bytes) ã€‚è¿™é‡Œè¦æ³¨æ„åŒºåˆ† MiBï¼ˆmebibyteï¼‰å’Œ MBï¼ˆmegabyteï¼‰çš„åŒºåˆ«ã€‚\n å¤‡æ³¨ï¼š1Mi=1024*1024ï¼›1M=1000*1000\n æ­¤å¤–ï¼Œä¸éš¾çœ‹åˆ°ï¼ŒKubernetes é‡Œ Pod çš„ CPU å’Œå†…å­˜èµ„æºï¼Œå®é™…ä¸Šè¿˜è¦åˆ†ä¸º limits å’Œ requests ä¸¤ç§æƒ…å†µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nspec.containers[].resources.limits.cpu spec.containers[].resources.limits.memory spec.containers[].resources.requests.cpu spec.containers[].resources.requests.memory  è¿™ä¸¤è€…çš„åŒºåˆ«å…¶å®éå¸¸ç®€å•ï¼šåœ¨è°ƒåº¦çš„æ—¶å€™ï¼Œkube-scheduler åªä¼šæŒ‰ç…§ requests çš„å€¼è¿›è¡Œè®¡ç®—ã€‚è€Œåœ¨çœŸæ­£è®¾ç½® Cgroups é™åˆ¶çš„æ—¶å€™ï¼Œkubelet åˆ™ä¼šæŒ‰ç…§ limits çš„å€¼æ¥è¿›è¡Œè®¾ç½®ã€‚\næ›´ç¡®åˆ‡åœ°è¯´ï¼Œå½“ä½ æŒ‡å®šäº† requests.cpu=250m ä¹‹åï¼Œç›¸å½“äºå°† Cgroups çš„ cpu.shares çš„å€¼è®¾ç½®ä¸º (250/1000)*1024ã€‚è€Œå½“ä½ æ²¡æœ‰è®¾ç½® requests.cpu çš„æ—¶å€™ï¼Œcpu.shares é»˜è®¤åˆ™æ˜¯ 1024ã€‚è¿™æ ·ï¼ŒKubernetes å°±é€šè¿‡ cpu.shares å®Œæˆäº†å¯¹ CPU æ—¶é—´çš„æŒ‰æ¯”ä¾‹åˆ†é…ã€‚\nè€Œå¦‚æœä½ æŒ‡å®šäº† limits.cpu=500m ä¹‹åï¼Œåˆ™ç›¸å½“äºå°† Cgroups çš„ cpu.cfs_quota_us çš„å€¼è®¾ç½®ä¸º (500/1000)*100msï¼Œè€Œ cpu.cfs_period_us çš„å€¼å§‹ç»ˆæ˜¯ 100msã€‚è¿™æ ·ï¼ŒKubernetes å°±ä¸ºä½ è®¾ç½®äº†è¿™ä¸ªå®¹å™¨åªèƒ½ç”¨åˆ° CPU çš„ 50%ã€‚\nè€Œå¯¹äºå†…å­˜æ¥è¯´ï¼Œå½“ä½ æŒ‡å®šäº† limits.memory=128Mi ä¹‹åï¼Œç›¸å½“äºå°† Cgroups çš„ memory.limit_in_bytes è®¾ç½®ä¸º 128 * 1024 * 1024ã€‚è€Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è°ƒåº¦çš„æ—¶å€™ï¼Œè°ƒåº¦å™¨åªä¼šä½¿ç”¨ requests.memory=64Mi æ¥è¿›è¡Œåˆ¤æ–­ã€‚\n å…³äºcpu.share å’Œ cpu.quotas çš„æ¦‚å¿µï¼Œå¯ä»¥å‚è€ƒè¿™ä¸¤ç¯‡æ–‡ç« ï¼Œç¬¬ä¸€ç¯‡æ–‡ç« çš„é‚£ä¸ªä¾‹å­å¾ˆå¥½ï¼Œçœ‹æ‡‚äº†å°±åŸºæœ¬ä¸Šæ˜ç™½è¿™ä¸¤ä¸ªæ¦‚å¿µä¹‹é—´çš„å…³ç³»äº†ï¼š\n ä»CFSçš„å±‚é¢æ¥åˆ†ædockeræ˜¯å¦‚ä½•é™åˆ¶å®¹å™¨å¯¹CPUçš„ä½¿ç”¨çš„ Understanding Linux Container Scheduling  æˆ‘ä»¬ç®€å•ç†è§£ï¼Œshares çš„å¤§å°å†³å®šäº†åœ¨ä¸€ä¸ªCFSè°ƒåº¦å‘¨æœŸä¸­ï¼Œè¿›ç¨‹å ç”¨çš„æ¯”ä¾‹ï¼Œæ¯”å¦‚è¿›ç¨‹Açš„sharesæ˜¯1024ï¼ŒBçš„sharesæ˜¯512ï¼Œå‡è®¾è°ƒåº¦å‘¨æœŸä¸º3ç§’ï¼Œé‚£ä¹ˆAå°†åªç”¨2ç§’ï¼ŒBå°†ä½¿ç”¨1ç§’ã€‚è€Œ quotas é€šå¸¸å’Œ period ä¸€èµ·ä½¿ç”¨ï¼ŒæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªé‡åˆ†é…å‘¨æœŸå†…ï¼Œå®¹å™¨èƒ½å¤Ÿå ç”¨çš„æœ€å¤§æ—¶é—´ã€‚å› ä¸º shares æ˜¯ä¸ä¼šé™åˆ¶æœ€å¤§çš„å ç”¨æ—¶é—´çš„ï¼Œæ‰€ä»¥å³ä½¿è®¾ç½®äº†sharesçš„å€¼ï¼Œä¹Ÿå¯èƒ½ä¼šè·‘æ»¡æ•´ä¸ªcpuï¼Œè¿™æ—¶å€™å°±éœ€è¦ quotas çš„å€¼æ¥é™åˆ¶äº†ã€‚\n Kubernetes è¿™ç§å¯¹ CPU å’Œå†…å­˜èµ„æºé™é¢çš„è®¾è®¡ï¼Œå®é™…ä¸Šå‚è€ƒäº† Borg è®ºæ–‡ä¸­å¯¹â€œåŠ¨æ€èµ„æºè¾¹ç•Œâ€çš„å®šä¹‰ï¼Œæ—¢ï¼šå®¹å™¨åŒ–ä½œä¸šåœ¨æäº¤æ—¶æ‰€è®¾ç½®çš„èµ„æºè¾¹ç•Œï¼Œå¹¶ä¸ä¸€å®šæ˜¯è°ƒåº¦ç³»ç»Ÿæ‰€å¿…é¡»ä¸¥æ ¼éµå®ˆçš„ï¼Œè¿™æ˜¯å› ä¸ºåœ¨å®é™…åœºæ™¯ä¸­ï¼Œå¤§å¤šæ•°ä½œä¸šä½¿ç”¨åˆ°çš„èµ„æºå…¶å®è¿œå°äºå®ƒæ‰€è¯·æ±‚çš„èµ„æºé™é¢ã€‚\nè€Œ Kubernetes çš„ requests+limits çš„åšæ³•ï¼Œå…¶å®å°±æ˜¯ä¸Šè¿°æ€è·¯çš„ä¸€ä¸ªç®€åŒ–ç‰ˆï¼šç”¨æˆ·åœ¨æäº¤ Pod æ—¶ï¼Œå¯ä»¥å£°æ˜ä¸€ä¸ªç›¸å¯¹è¾ƒå°çš„ requests å€¼ä¾›è°ƒåº¦å™¨ä½¿ç”¨ï¼Œè€Œ Kubernetes çœŸæ­£è®¾ç½®ç»™å®¹å™¨ Cgroups çš„ï¼Œåˆ™æ˜¯ç›¸å¯¹è¾ƒå¤§çš„ limits å€¼ã€‚ä¸éš¾çœ‹åˆ°ï¼Œè¿™è·Ÿ Borg çš„æ€è·¯ç›¸é€šçš„ã€‚\n2. QoS æ¨¡å‹ åœ¨ç†è§£äº† Kubernetes èµ„æºæ¨¡å‹çš„è®¾è®¡ä¹‹åï¼Œæˆ‘å†æ¥å’Œä½ è°ˆè°ˆ Kubernetes é‡Œçš„ QoS æ¨¡å‹ã€‚åœ¨ Kubernetes ä¸­ï¼Œä¸åŒçš„ requests å’Œ limits çš„è®¾ç½®æ–¹å¼ï¼Œå…¶å®ä¼šå°†è¿™ä¸ª Pod åˆ’åˆ†åˆ°ä¸åŒçš„ QoS çº§åˆ«å½“ä¸­ã€‚\n   çº§åˆ« æ¡ä»¶     Guaranteed 1.Pod ä¸­çš„æ¯ä¸ªå®¹å™¨ï¼ŒåŒ…å«åˆå§‹åŒ–å®¹å™¨ï¼Œå¿…é¡»æŒ‡å®šå†…å­˜è¯·æ±‚å’Œå†…å­˜é™åˆ¶ï¼Œå¹¶ä¸”ä¸¤è€…è¦ç›¸ç­‰ã€‚ 2.Pod ä¸­çš„æ¯ä¸ªå®¹å™¨ï¼ŒåŒ…å«åˆå§‹åŒ–å®¹å™¨ï¼Œå¿…é¡»æŒ‡å®š CPU è¯·æ±‚å’Œ CPU é™åˆ¶ï¼Œå¹¶ä¸”ä¸¤è€…è¦ç›¸ç­‰ã€‚   Burstable 1.Pod ä¸ç¬¦åˆ Guaranteed QoS ç±»çš„æ ‡å‡†ã€‚2.Pod ä¸­è‡³å°‘ä¸€ä¸ªå®¹å™¨å…·æœ‰å†…å­˜æˆ– CPU è¯·æ±‚ã€‚   BestEffort å¯¹äº QoS ç±»ä¸º BestEffort çš„ Podï¼ŒPod ä¸­çš„å®¹å™¨å¿…é¡»æ²¡æœ‰è®¾ç½®å†…å­˜å’Œ CPU é™åˆ¶æˆ–è¯·æ±‚ã€‚    å½“ Pod é‡Œçš„æ¯ä¸€ä¸ª Container éƒ½åŒæ—¶è®¾ç½®äº† requests å’Œ limitsï¼Œå¹¶ä¸” requests å’Œ limits å€¼ç›¸ç­‰çš„æ—¶å€™ï¼Œè¿™ä¸ª Pod å°±å±äº Guaranteed ç±»åˆ«ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: v1 kind: Pod metadata: name: qos-demo namespace: qos-example spec: containers: - name: qos-demo-ctr image: nginx resources: limits: memory: \u0026quot;200Mi\u0026quot; cpu: \u0026quot;700m\u0026quot; requests: memory: \u0026quot;200Mi\u0026quot; cpu: \u0026quot;700m\u0026quot;  å½“è¿™ä¸ª Pod åˆ›å»ºä¹‹åï¼Œå®ƒçš„ qosClass å­—æ®µå°±ä¼šè¢« Kubernetes è‡ªåŠ¨è®¾ç½®ä¸º Guaranteedã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ Pod ä»…è®¾ç½®äº† limits æ²¡æœ‰è®¾ç½® requests çš„æ—¶å€™ï¼ŒKubernetes ä¼šè‡ªåŠ¨ä¸ºå®ƒè®¾ç½®ä¸ limits ç›¸åŒçš„ requests å€¼ï¼Œæ‰€ä»¥ï¼Œè¿™ä¹Ÿå±äº Guaranteed æƒ…å†µã€‚è€Œå½“ Pod ä¸æ»¡è¶³ Guaranteed çš„æ¡ä»¶ï¼Œä½†è‡³å°‘æœ‰ä¸€ä¸ª Container è®¾ç½®äº† requestsã€‚é‚£ä¹ˆè¿™ä¸ª Pod å°±ä¼šè¢«åˆ’åˆ†åˆ° Burstable ç±»åˆ«ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\napiVersion: v1 kind: Pod metadata: name: qos-demo-2 namespace: qos-example spec: containers: - name: qos-demo-2-ctr image: nginx resources: limits memory: \u0026quot;200Mi\u0026quot; requests: memory: \u0026quot;100Mi\u0026quot;  è€Œå¦‚æœä¸€ä¸ª Pod æ—¢æ²¡æœ‰è®¾ç½® requestsï¼Œä¹Ÿæ²¡æœ‰è®¾ç½® limitsï¼Œé‚£ä¹ˆå®ƒçš„ QoS ç±»åˆ«å°±æ˜¯ BestEffortã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\napiVersion: v1 kind: Pod metadata: name: qos-demo-3 namespace: qos-example spec: containers: - name: qos-demo-3-ctr image: nginx  é‚£ä¹ˆï¼ŒKubernetes ä¸º Pod è®¾ç½®è¿™æ ·ä¸‰ç§ QoS ç±»åˆ«ï¼Œå…·ä½“æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ\nå®é™…ä¸Šï¼ŒQoS åˆ’åˆ†çš„ä¸»è¦åº”ç”¨åœºæ™¯ï¼Œæ˜¯å½“å®¿ä¸»æœºèµ„æºç´§å¼ çš„æ—¶å€™ï¼Œkubelet å¯¹ Pod è¿›è¡Œ Evictionï¼ˆå³èµ„æºå›æ”¶ï¼‰æ—¶éœ€è¦ç”¨åˆ°çš„ã€‚\nå…·ä½“åœ°è¯´ï¼Œå½“ Kubernetes æ‰€ç®¡ç†çš„å®¿ä¸»æœºä¸Šä¸å¯å‹ç¼©èµ„æºçŸ­ç¼ºæ—¶ï¼Œå°±æœ‰å¯èƒ½è§¦å‘ Evictionã€‚æ¯”å¦‚ï¼Œå¯ç”¨å†…å­˜ï¼ˆmemory.availableï¼‰ã€å¯ç”¨çš„å®¿ä¸»æœºç£ç›˜ç©ºé—´ï¼ˆnodefs.availableï¼‰ï¼Œä»¥åŠå®¹å™¨è¿è¡Œæ—¶é•œåƒå­˜å‚¨ç©ºé—´ï¼ˆimagefs.availableï¼‰ç­‰ç­‰ã€‚\nç›®å‰ï¼ŒKubernetes ä¸ºä½ è®¾ç½®çš„ Eviction çš„é»˜è®¤é˜ˆå€¼å¦‚ä¸‹æ‰€ç¤ºï¼š\nmemory.available\u0026lt;100Mi nodefs.available\u0026lt;10% nodefs.inodesFree\u0026lt;5% imagefs.available\u0026lt;15%  å½“ç„¶ï¼Œä¸Šè¿°å„ä¸ªè§¦å‘æ¡ä»¶åœ¨ kubelet é‡Œéƒ½æ˜¯å¯é…ç½®çš„ã€‚\né˜ˆå€¼çš„å®šä¹‰æ–¹å¼ä¸º [eviction-signal][operator][quantity]\neviction-signal\næŒ‰ç…§å®˜æ–¹æ–‡æ¡£åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š\n   Eviction Signal Description     memory.available memory.available := node.status.capacity[memory] â€“ node.stats.memory.workingSet   nodefs.available nodefs.available := node.stats.fs.available   nodefs.inodesFree nodefs.inodesFree := node.stats.fs.inodesFree   imagefs.available imagefs.available := node.stats.runtime.imagefs.available   imagefs.inodesFree imagefs.inodesFree := node.stats.runtime.imagefs.inodesFree    nodefså’Œimagefsè¡¨ç¤ºä¸¤ç§æ–‡ä»¶ç³»ç»Ÿåˆ†åŒºï¼š\n  nodefsï¼šæ–‡ä»¶ç³»ç»Ÿï¼Œkubelet å°†å…¶ç”¨äºå·å’Œå®ˆæŠ¤ç¨‹åºæ—¥å¿—ç­‰ã€‚\n  imagefsï¼šæ–‡ä»¶ç³»ç»Ÿï¼Œå®¹å™¨è¿è¡Œæ—¶ç”¨äºä¿å­˜é•œåƒå’Œå®¹å™¨å¯å†™å±‚ã€‚\n  operator\nå…³ç³»è¿ç®—ç¬¦ï¼Œä¾‹å¦‚â€œ\u0026lt;â€\nquantity\næ˜¯é˜ˆå€¼çš„å¤§å°ï¼Œå¯ä»¥å®¹é‡å¤§å°ï¼Œå¦‚ï¼š1Giï¼›ä¹Ÿå¯ä»¥ç”¨ç™¾åˆ†æ¯”æ¥è¡¨ç¤ºï¼š10%ã€‚\nå¦‚æœkubeletåœ¨èŠ‚ç‚¹ç»å†ç³»ç»Ÿ OOM ä¹‹å‰æ— æ³•å›æ”¶å†…å­˜ï¼Œé‚£ä¹ˆoom_killerå°†åŸºäºå®ƒåœ¨èŠ‚ç‚¹ä¸Š ä½¿ç”¨çš„å†…å­˜ç™¾åˆ†æ¯”ç®—å‡ºä¸€ä¸ªoom_scoreï¼Œç„¶åç»“æŸå¾—åˆ†æœ€é«˜çš„å®¹å™¨ã€‚è¿™äº›å€¼æˆ‘ä»¬æ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\nkubelet --eviction-hard=imagefs.available\u0026lt;10%,memory.available\u0026lt;500Mi,nodefs.available\u0026lt;5%,nodefs.inodesFree\u0026lt;5% --eviction-soft=imagefs.available\u0026lt;30%,nodefs.available\u0026lt;10% --eviction-soft-grace-period=imagefs.available=2m,nodefs.available=2m --eviction-max-pod-grace-period=600  åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ° Eviction åœ¨ Kubernetes é‡Œå…¶å®åˆ†ä¸º Soft å’Œ Hard ä¸¤ç§æ¨¡å¼ã€‚\nå…¶ä¸­ï¼ŒSoft Eviction å…è®¸ä½ ä¸º Eviction è¿‡ç¨‹è®¾ç½®ä¸€æ®µâ€œä¼˜é›…æ—¶é—´â€ï¼Œæ¯”å¦‚ä¸Šé¢ä¾‹å­é‡Œçš„ imagefs.available=2mï¼Œå°±æ„å‘³ç€å½“ imagefs ä¸è¶³çš„é˜ˆå€¼è¾¾åˆ° 2 åˆ†é’Ÿä¹‹åï¼Œkubelet æ‰ä¼šå¼€å§‹ Eviction çš„è¿‡ç¨‹ã€‚\nè€Œ Hard Eviction æ¨¡å¼ä¸‹ï¼ŒEviction è¿‡ç¨‹å°±ä¼šåœ¨é˜ˆå€¼è¾¾åˆ°ä¹‹åç«‹åˆ»å¼€å§‹ã€‚\n Kubernetes è®¡ç®— Eviction é˜ˆå€¼çš„æ•°æ®æ¥æºï¼Œä¸»è¦ä¾èµ–äºä» Cgroups è¯»å–åˆ°çš„å€¼ï¼Œä»¥åŠä½¿ç”¨ cAdvisor ç›‘æ§åˆ°çš„æ•°æ®ã€‚\n å½“å®¿ä¸»æœºçš„ Eviction é˜ˆå€¼è¾¾åˆ°åï¼Œå°±ä¼šè¿›å…¥ MemoryPressure æˆ–è€… DiskPressure çŠ¶æ€ï¼Œä»è€Œé¿å…æ–°çš„ Pod è¢«è°ƒåº¦åˆ°è¿™å°å®¿ä¸»æœºä¸Šã€‚\nè€Œå½“ Eviction å‘ç”Ÿçš„æ—¶å€™ï¼Œkubelet å…·ä½“ä¼šæŒ‘é€‰å“ªäº› Pod è¿›è¡Œåˆ é™¤æ“ä½œï¼Œå°±éœ€è¦å‚è€ƒè¿™äº› Pod çš„ QoS ç±»åˆ«äº†ã€‚\n é¦–å½“å…¶å†²çš„ï¼Œè‡ªç„¶æ˜¯ BestEffort ç±»åˆ«çš„ Podã€‚\nå…¶æ¬¡ï¼Œæ˜¯å±äº Burstable ç±»åˆ«ã€å¹¶ä¸”å‘ç”Ÿâ€œé¥¥é¥¿â€çš„èµ„æºä½¿ç”¨é‡å·²ç»è¶…å‡ºäº† requests çš„ Podã€‚\næœ€åï¼Œæ‰æ˜¯ Guaranteed ç±»åˆ«ã€‚å¹¶ä¸”ï¼ŒKubernetes ä¼šä¿è¯åªæœ‰å½“ Guaranteed ç±»åˆ«çš„ Pod çš„èµ„æºä½¿ç”¨é‡è¶…è¿‡äº†å…¶ limits çš„é™åˆ¶ï¼Œæˆ–è€…å®¿ä¸»æœºæœ¬èº«æ­£å¤„äº Memory Pressure çŠ¶æ€æ—¶ï¼ŒGuaranteed çš„ Pod æ‰å¯èƒ½è¢«é€‰ä¸­è¿›è¡Œ Eviction æ“ä½œã€‚\n å½“ç„¶ï¼Œå¯¹äºåŒ QoS ç±»åˆ«çš„ Pod æ¥è¯´ï¼ŒKubernetes è¿˜ä¼šæ ¹æ® Pod çš„ä¼˜å…ˆçº§æ¥è¿›è¡Œè¿›ä¸€æ­¥åœ°æ’åºå’Œé€‰æ‹©ã€‚åœ¨ç†è§£äº† Kubernetes é‡Œçš„ QoS ç±»åˆ«çš„è®¾è®¡ä¹‹åï¼Œæˆ‘å†æ¥ä¸ºä½ è®²è§£ä¸€ä¸‹Kubernetes é‡Œä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ç‰¹æ€§ï¼šcpuset çš„è®¾ç½®ã€‚\n3. cpuset æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ä½¿ç”¨å®¹å™¨çš„æ—¶å€™ï¼Œä½ å¯ä»¥é€šè¿‡è®¾ç½® cpuset æŠŠå®¹å™¨ç»‘å®šåˆ°æŸä¸ª CPU çš„æ ¸ä¸Šï¼Œè€Œä¸æ˜¯åƒ cpushare é‚£æ ·å…±äº« CPU çš„è®¡ç®—èƒ½åŠ›ã€‚\nè¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºæ“ä½œç³»ç»Ÿåœ¨ CPU ä¹‹é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°å¤§å¤§å‡å°‘ï¼Œå®¹å™¨é‡Œåº”ç”¨çš„æ€§èƒ½ä¼šå¾—åˆ°å¤§å¹…æå‡ã€‚äº‹å®ä¸Šï¼Œcpuset æ–¹å¼ï¼Œæ˜¯ç”Ÿäº§ç¯å¢ƒé‡Œéƒ¨ç½²åœ¨çº¿åº”ç”¨ç±»å‹çš„ Pod æ—¶ï¼Œéå¸¸å¸¸ç”¨çš„ä¸€ç§æ–¹å¼ã€‚\nå¯æ˜¯ï¼Œè¿™æ ·çš„éœ€æ±‚åœ¨ Kubernetes é‡Œåˆè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿå…¶å®éå¸¸ç®€å•ã€‚\n é¦–å…ˆï¼Œä½ çš„ Pod å¿…é¡»æ˜¯ Guaranteed çš„ QoS ç±»å‹ï¼›\nç„¶åï¼Œä½ åªéœ€è¦å°† Pod çš„ CPU èµ„æºçš„ requests å’Œ limits è®¾ç½®ä¸ºåŒä¸€ä¸ªç›¸ç­‰çš„æ•´æ•°å€¼å³å¯ã€‚\n æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\nspec: containers: - name: nginx image: nginx resources: limits: memory: \u0026quot;200Mi\u0026quot; cpu: \u0026quot;2\u0026quot; requests: memory: \u0026quot;200Mi\u0026quot; cpu: \u0026quot;2\u0026quot;  è¿™æ—¶å€™ï¼Œè¯¥ Pod å°±ä¼šè¢«ç»‘å®šåœ¨ 2 ä¸ªç‹¬å çš„ CPU æ ¸ä¸Šã€‚å½“ç„¶ï¼Œå…·ä½“æ˜¯å“ªä¸¤ä¸ª CPU æ ¸ï¼Œæ˜¯ç”± kubelet ä¸ºä½ åˆ†é…çš„ã€‚ä»¥ä¸Šï¼Œå°±æ˜¯ Kubernetes çš„èµ„æºæ¨¡å‹å’Œ QoS ç±»åˆ«ç›¸å…³çš„ä¸»è¦å†…å®¹ã€‚\n4. æ€»ç»“ åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å…ˆä¸ºä½ è¯¦ç»†è®²è§£äº† Kubernetes é‡Œå¯¹èµ„æºçš„å®šä¹‰æ–¹å¼å’Œèµ„æºæ¨¡å‹çš„è®¾è®¡ã€‚ç„¶åï¼Œæˆ‘ä¸ºä½ è®²è¿°äº† Kubernetes é‡Œå¯¹ Pod è¿›è¡Œ Eviction çš„å…·ä½“ç­–ç•¥å’Œå®è·µæ–¹å¼ã€‚\næ­£æ˜¯åŸºäºä¸Šè¿°è®²è¿°ï¼Œåœ¨å®é™…çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘å¼ºçƒˆå»ºè®®ä½ å°† DaemonSet çš„ Pod éƒ½è®¾ç½®ä¸º Guaranteed çš„ QoS ç±»å‹ã€‚å¦åˆ™ï¼Œä¸€æ—¦ DaemonSet çš„ Pod è¢«å›æ”¶ï¼Œå®ƒåˆä¼šç«‹å³åœ¨åŸå®¿ä¸»æœºä¸Šè¢«é‡å»ºå‡ºæ¥ï¼Œè¿™å°±ä½¿å¾—å‰é¢èµ„æºå›æ”¶çš„åŠ¨ä½œï¼Œå®Œå…¨æ²¡æœ‰æ„ä¹‰äº†ã€‚\n","date":"2021å¹´04æœˆ14æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter6/resource-model/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡æ¥è‡ªå¼ ç£Šè€å¸ˆçš„\u003ca href=\"https://time.geekbang.org/column/article/69678\"\u003eã€Šæ·±å…¥å‰–æKuberntesã€‹\u003c/a\u003eè¯¾ç¨‹ç¬”è®°ï¼Œè¯·å‹¿è½¬è½½ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e","title":"Kubernetesçš„èµ„æºæ¨¡å‹å’Œèµ„æºç®¡ç†"},{"contents":"åœ¨ä½¿ç”¨ Kubernetes REST API ç¼–å†™åº”ç”¨ç¨‹åºæ—¶ï¼Œ æ‚¨å¹¶ä¸éœ€è¦è‡ªå·±å®ç° API è°ƒç”¨å’Œ â€œè¯·æ±‚/å“åº”â€ ç±»å‹ã€‚ æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„ç¼–ç¨‹è¯­è¨€éœ€è¦é€‰æ‹©ä½¿ç”¨åˆé€‚çš„å®¢æˆ·ç«¯åº“ã€‚\nå®¢æˆ·ç«¯åº“é€šå¸¸ä¸ºæ‚¨å¤„ç†è¯¸å¦‚èº«ä»½éªŒè¯ä¹‹ç±»çš„å¸¸è§ä»»åŠ¡ã€‚ å¦‚æœ API å®¢æˆ·ç«¯åœ¨ Kubernetes é›†ç¾¤ä¸­è¿è¡Œï¼Œå¤§å¤šæ•°å®¢æˆ·ç«¯åº“å¯ä»¥å‘ç°å¹¶ä½¿ç”¨ Kubernetes æœåŠ¡å¸æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼Œ æˆ–è€…èƒ½å¤Ÿç†è§£ kubeconfig æ–‡ä»¶ æ ¼å¼æ¥è¯»å–å‡­æ®å’Œ API æœåŠ¡å™¨åœ°å€ã€‚\nkubernetes å®˜æ–¹æ”¯æŒçš„å®¢æˆ·ç«¯æœ‰ go/python/java/dotnet/js ç­‰ï¼Œä»Šå¤©æˆ‘ä»¬è¦è®¨è®ºçš„æ˜¯å…¶ä¸­çš„ go å®¢æˆ·ç«¯ã€‚\né¦–å…ˆä¸‹è½½æºä»£ç ï¼Œè¿›å…¥åˆ°examplesç›®å½•ï¼š\nâœ git clone git@github.com:kubernetes/client-go.git âœ ~ cd client-go/examples âœ examples git:(master) âœ— ll total 32K -rwxr-xr-x 1 root root 2.0K Apr 6 17:33 README.md drwxr-xr-x 2 root root 4.0K Apr 6 17:46 create-update-delete-deployment drwxr-xr-x 2 root root 4.0K Apr 6 17:33 dynamic-create-update-delete-deployment drwxr-xr-x 2 root root 4.0K Apr 6 17:33 fake-client drwxr-xr-x 2 root root 4.0K Apr 6 17:33 in-cluster-client-configuration drwxr-xr-x 2 root root 4.0K Apr 6 17:33 leader-election drwxr-xr-x 2 root root 4.0K Apr 6 17:33 out-of-cluster-client-configuration drwxr-xr-x 2 root root 4.0K Apr 6 17:33 workqueue  go å®¢æˆ·ç«¯æä¾›äº†å¾ˆå¤šçš„ä½¿ç”¨æ ·ä¾‹ï¼Œæˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸€ä¸‹create-update-delete-deployment è¿™ä¸ªç›®å½•ï¼Œè¿™ä¸ªç›®å½•ä¸­æ˜¯å…³äºæ“ä½œdeploymentèµ„æºå¯¹è±¡çš„æ ·ä¾‹ï¼ŒåŒ…æ‹¬åˆ›å»ºï¼ŒæŸ¥è¯¢ï¼Œæ›´æ–°ï¼Œåˆ é™¤ã€‚\n This example program demonstrates the fundamental operations for managing on Deployment resources, such as Create, List, Update and Delete.\nYou can adopt the source code from this example to write programs that manage other types of resources through the Kubernetes API.\n æˆ‘ä»¬ä» main å‡½æ•°å¼€å§‹çœ‹èµ·ï¼Œè¿™é‡Œå°è¯•ä½¿ç”¨ go-callvis å°†æ•´ä¸ªè°ƒç”¨å…³ç³»å¯è§†åŒ–å‡ºæ¥ï¼š\næ€»çš„æ¥çœ‹ï¼Œmain ä½¿ç”¨ kubeconfig çš„é…ç½®æ¥ç”Ÿæˆ rest clientï¼Œé€šè¿‡ rest client è°ƒç”¨ k8s api è¿›è¡Œèµ„æºçš„æ“ä½œã€‚\næ¥ä¸‹æ¥ï¼Œå…·ä½“æ¥çœ‹ä¸€ä¸‹è¯»å– kubeconfig é…ç½®çš„ä»£ç ï¼š\nvar kubeconfig *string if home := homedir.HomeDir(); home != \u0026quot;\u0026quot; { kubeconfig = flag.String(\u0026quot;kubeconfig\u0026quot;, filepath.Join(home, \u0026quot;.kube\u0026quot;, \u0026quot;config\u0026quot;), \u0026quot;(optional) absolute path to the kubeconfig file\u0026quot;) } else { kubeconfig = flag.String(\u0026quot;kubeconfig\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;absolute path to the kubeconfig file\u0026quot;) } flag.Parse() config, err := clientcmd.BuildConfigFromFlags(\u0026quot;\u0026quot;, *kubeconfig)  å‘½ä»¤è¡Œå‚æ•°æŒ‡å®škubeconfigçš„ç»å¯¹è·¯å¾„ï¼Œè°ƒç”¨clientcmd.BuildConfigFromFlags(\u0026quot;\u0026quot;, *kubeconfig)æ¥è§£æ config çš„é…ç½®ä¿¡æ¯ã€‚ BuildConfigFromFlags å‡½æ•°æ˜¯ç”¨æ¥ä»masteråœ°å€æˆ–è€…kubeconfigæ–‡ä»¶åœ°å€æ¥æ„å»ºconfigé…ç½®ï¼Œè¿™ä¸ªå‡½æ•°åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š\n è°ƒç”¨func NewNonInteractiveDeferredLoadingClientConfig(loader ClientConfigLoader, overrides *ConfigOverrides) ClientConfig è°ƒç”¨ func (config *DeferredLoadingClientConfig) ClientConfig() (*restclient.Config, error) å‡½æ•°  func BuildConfigFromFlags(masterUrl, kubeconfigPath string) (*restclient.Config, error) { ...... return NewNonInteractiveDeferredLoadingClientConfig( \u0026amp;ClientConfigLoadingRules{ExplicitPath: kubeconfigPath}, \u0026amp;ConfigOverrides{ClusterInfo: clientcmdapi.Cluster{Server: masterUrl}}).ClientConfig() }  æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªé“¾å¼å‡½æ•°åšäº†ä»€ä¹ˆäº‹æƒ…ï¼š\nfunc NewNonInteractiveDeferredLoadingClientConfig(loader ClientConfigLoader, overrides *ConfigOverrides) ClientConfig { return \u0026amp;DeferredLoadingClientConfig{loader: loader, overrides: overrides, icc: \u0026amp;inClusterClientConfig{overrides: overrides}} }  NewNonInteractiveDeferredLoadingClientConfig å‡½æ•°è¿”å›ä¸€ä¸ª ClientConfig æ¥å£çš„å®ç°: DeferredLoadingClientConfigã€‚DeferredLoadingClientConfig ä¸»è¦å·¥ä½œæ˜¯ç¡®ä¿è£…è½½çš„ Config å®ä¾‹ä½¿ç”¨çš„æ˜¯æœ€æ–° kubeconfig æ•°æ®ï¼ˆå¯¹äºé…ç½®äº†å¤šä¸ªé›†ç¾¤çš„ï¼Œexport KUBECONFIG=cluster1-config:cluster2-configï¼Œéœ€è¦æ‰§è¡Œ mergeï¼‰ã€‚åœ¨è¿™ä¸ªç»“æ„ä½“çš„æ³¨é‡Šä¸­å†™é“ï¼š\nIt is used in cases where the loading rules may change after you've instantiated them and you want to be sure that the most recent rules are used. This is useful in cases where you bind flags to loading rule parameters before the parse happens and you want your calling code to be ignorant of how the values are being mutated to avoid passing extraneous information down a call stack å®ä¾‹åŒ–åŠ è½½è§„åˆ™åï¼Œå¦‚æœè¦æ›´æ”¹åŠ è½½è§„åˆ™ï¼Œå¹¶ä¸”è¦ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„è§„åˆ™ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å®ƒã€‚è¿™åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ï¼š åœ¨è§£æå‘ç”Ÿä¹‹å‰å°†æ ‡å¿—ç»‘å®šåˆ°åŠ è½½è§„åˆ™å‚æ•°ï¼Œå¹¶ä¸”æ‚¨å¸Œæœ›æ‚¨çš„è°ƒç”¨ä»£ç ä¸çŸ¥é“å€¼çš„å˜åŒ–æ–¹å¼ï¼Œä»¥é¿å…åœ¨è°ƒç”¨å †æ ˆä¸­ä¼ é€’æ— å…³çš„ä¿¡æ¯  ä¸Šä¸€ä¸ªå‡½æ•°è¿”å›äº† ClientConfig æ¥å£å®ä¾‹ã€‚ç„¶åè°ƒç”¨ ClientConfig æ¥å£å®šä¹‰çš„ ClientConfig() æ–¹æ³•ã€‚ClientConfig() å·¥ä½œæ˜¯è§£æã€å¤„ç† kubeconfig æ–‡ä»¶é‡Œçš„è®¤è¯ä¿¡æ¯ï¼Œå¹¶è¿”å›ä¸€ä¸ªå®Œæ•´çš„ rest#Config å®ä¾‹ã€‚\n// ClientConfig implements ClientConfig func (config *DeferredLoadingClientConfig) ClientConfig() (*restclient.Config, error) { mergedClientConfig, err := config.createClientConfig() ...... // load the configuration and return on non-empty errors and if the // content differs from the default config mergedConfig, err := mergedClientConfig.ClientConfig() ...... // check for in-cluster configuration and use it if config.icc.Possible() { klog.V(4).Infof(\u0026quot;Using in-cluster configuration\u0026quot;) return config.icc.ClientConfig() } // return the result of the merged client config return mergedConfig, err }  è¿™ä¸ªå‡½æ•°ä¸»è¦æœ‰ä¸¤ä¸ªé‡è¦éƒ¨åˆ†ï¼š\n1.mergedClientConfig, err := config.createClientConfig()\nå†…éƒ¨æ‰§è¡Œéå† kubeconfig files ï¼ˆå¦‚æœæœ‰å¤šä¸ªï¼‰ï¼Œ å¯¹æ¯ä¸ª kubeconfig æ‰§è¡Œ LoadFromFile è¿”å› tools/clientcmd/api#Config å®ä¾‹ã€‚api#Config é¡¾åæ€ä¹‰ api åŒ…ä¸‹çš„ Configï¼Œæ˜¯æŠŠ kubeconfig ï¼ˆeg. $HOME/.kube/configï¼‰ åºåˆ—åŒ–ä¸ºä¸€ä¸ª API èµ„æºå¯¹è±¡ã€‚\nç°åœ¨,æˆ‘ä»¬çœ‹åˆ°äº†å‡ ç§ç»“æ„ä½“æˆ–æ¥å£å‘½åç›¸ä¼¼ï¼Œä¸è¦æ··æ·†äº†ï¼š\n api#Configï¼šåºåˆ—åŒ– kubeconfig æ–‡ä»¶åç”Ÿæˆçš„å¯¹è±¡ tools/clientcmd#ClientConfigï¼šè´Ÿè´£ç”¨ api#Config çœŸæ­£åˆ›å»º rest#Configã€‚å¤„ç†ã€è§£æ kubeconfig ä¸­çš„è®¤è¯ä¿¡æ¯ï¼Œæœ‰äº†å®ƒæ‰èƒ½åˆ›å»º rest#Configï¼Œæ‰€ä»¥å‘½åå« ClientConfig rest#Configï¼šç”¨äºåˆ›å»º http å®¢æˆ·ç«¯  å¯¹äº merge åçš„ api#Configï¼Œè°ƒç”¨ NewNonInteractiveClientConfig åˆ›å»ºä¸€ä¸ª ClientConfig æ¥å£çš„å®ç°ã€‚\n2.mergedConfig, err := mergedClientConfig.ClientConfig()\nçœŸæ­£åˆ›å»º rest#Config çš„åœ°æ–¹ã€‚åœ¨è¿™é‡Œè§£æã€å¤„ç† kubeconfig ä¸­çš„è®¤è¯ä¿¡æ¯ã€‚\nå®Œæˆ rest client åˆ›å»ºä¹‹åï¼Œå°±éœ€è¦åˆ›å»º clientset :\nclientset, err := kubernetes.NewForConfig(config)  è¿™é‡Œçš„ func NewForConfig(c *rest.Config) (*Clientset, error) å‡½æ•°ä¼šæ ¹æ® api group ä¸ºä¸åŒçš„èµ„æºç”Ÿæˆå®¢æˆ·ç«¯ã€‚ä¾‹å¦‚è¿™é‡Œç”¨åˆ°çš„ deployment çš„å®¢æˆ·ç«¯ï¼Œå®šä¹‰äº†deploymentçš„namespaceï¼š\ndeploymentsClient := clientset.AppsV1().Deployments(apiv1.NamespaceDefault)  æ¥ä¸‹æ¥åˆ›å»º deployment çš„æè¿°ä¿¡æ¯ï¼š\ndeployment := \u0026amp;appsv1.Deployment{ ObjectMeta: metav1.ObjectMeta{ Name: \u0026quot;demo-deployment\u0026quot;, }, Spec: appsv1.DeploymentSpec{ Replicas: int32Ptr(2), Selector: \u0026amp;metav1.LabelSelector{ MatchLabels: map[string]string{ \u0026quot;app\u0026quot;: \u0026quot;demo\u0026quot;, }, }, Template: apiv1.PodTemplateSpec{ ObjectMeta: metav1.ObjectMeta{ Labels: map[string]string{ \u0026quot;app\u0026quot;: \u0026quot;demo\u0026quot;, }, }, Spec: apiv1.PodSpec{ Containers: []apiv1.Container{ { Name: \u0026quot;web\u0026quot;, Image: \u0026quot;nginx:1.12\u0026quot;, Ports: []apiv1.ContainerPort{ { Name: \u0026quot;http\u0026quot;, Protocol: apiv1.ProtocolTCP, ContainerPort: 80, }, }, }, }, }, }, }, }  åˆ›å»ºdeploymentï¼š\n// Create Deployment fmt.Println(\u0026quot;Creating deployment...\u0026quot;) result, err := deploymentsClient.Create(context.TODO(), deployment, metav1.CreateOptions{}) if err != nil { panic(err) } fmt.Printf(\u0026quot;Created deployment %q.\\n\u0026quot;, result.GetObjectMeta().GetName())  è¿™ä¸ªåˆ›å»ºçš„å‡½æ•°å®é™…ä¸Šå°±æ˜¯è°ƒç”¨ HTTP çš„ POST è¯·æ±‚æ¥è·ŸK8sé›†ç¾¤è¿›è¡Œé€šä¿¡çš„ã€‚\nfunc (c *deployments) Create(ctx context.Context, deployment *v1.Deployment, opts metav1.CreateOptions) (result *v1.Deployment, err error) { result = \u0026amp;v1.Deployment{} err = c.client.Post(). Namespace(c.ns). Resource(\u0026quot;deployments\u0026quot;). VersionedParams(\u0026amp;opts, scheme.ParameterCodec). Body(deployment). Do(ctx). Into(result) return }  è‡³äºpostçš„è¯·æ±‚ç»†èŠ‚ï¼Œè¿™é‡Œä¸åšè¯¦ç»†çš„é˜è¿°ã€‚\nå‚è€ƒï¼š\nk8s informer\nKubernetes: Controllers, Informers, Reflectors and Stores\nè§£è¯» kubernetes client-go å®˜æ–¹ examples](https://segmentfault.com/a/1190000018953168)\nclient-goå­¦ä¹ \ngo-callvisï¼šcallvis æŸ¥çœ‹ä»£ç è°ƒç”¨å…³ç³»å·¥å…·ï¼Œä¸€ä¸ªä¸é”™çš„è°ƒç”¨é“¾å¯è§†åŒ–å·¥å…·ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬åˆ†æä»£ç \n","date":"2021å¹´04æœˆ06æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter6/client-go/","summary":"åœ¨ä½¿ç”¨ Kubernetes REST API ç¼–å†™åº”ç”¨ç¨‹åºæ—¶ï¼Œ æ‚¨å¹¶ä¸éœ€è¦è‡ªå·±å®ç° API è°ƒç”¨å’Œ â€œè¯·æ±‚/å“åº”â€ ç±»å‹ã€‚ æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„ç¼–ç¨‹è¯­è¨€éœ€è¦é€‰æ‹©ä½¿ç”¨åˆé€‚çš„å®¢æˆ·ç«¯åº“ã€‚\nå®¢æˆ·ç«¯åº“é€šå¸¸ä¸ºæ‚¨å¤„ç†è¯¸å¦‚èº«ä»½éªŒè¯ä¹‹ç±»çš„å¸¸è§ä»»åŠ¡ã€‚ å¦‚æœ API å®¢æˆ·ç«¯åœ¨ Kubernetes é›†ç¾¤ä¸­è¿è¡Œï¼Œå¤§å¤šæ•°å®¢æˆ·ç«¯åº“å¯ä»¥å‘ç°å¹¶ä½¿ç”¨ Kubernetes æœåŠ¡å¸æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼Œ æˆ–è€…èƒ½å¤Ÿç†è§£ kubeconfig æ–‡ä»¶ æ ¼å¼æ¥è¯»å–å‡­æ®å’Œ API æœåŠ¡å™¨åœ°å€ã€‚","title":"K8s Go å®¢æˆ·ç«¯æµ…æ"},{"contents":"Go è¯­è¨€åˆ†é…å†…å­˜çš„å‡½æ•°åŒ…æ‹¬ new å’Œ makeã€‚new ç”¨æ¥è·å–ç±»å‹å¯¹åº”çš„æŒ‡é’ˆç±»å‹ï¼Œå³è¦è·å–æŒ‡é’ˆç±»å‹çš„å†…å­˜åˆ†é…ã€‚make åªç”¨æ¥åˆ†é…å¼•ç”¨ç±»å‹ï¼Œå³ä¸ºchannelï¼Œmapï¼Œsliceåˆ†é…å†…å­˜ã€‚\nå¯¹äºå€¼ç±»å‹çš„å˜é‡ï¼Œæˆ‘ä»¬é€šè¿‡var å£°æ˜ï¼Œç³»ç»Ÿä¼šé»˜è®¤ä¸ºä»–åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶èµ‹è¯¥ç±»å‹çš„é›¶å€¼ã€‚å¦‚ä¸‹ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªintç±»å‹å˜é‡iï¼Œè¾“å‡ºä¸º0ã€‚\npackage main import \u0026quot;fmt\u0026quot; func main() { var i int fmt.Println(i) }  è€Œå¦‚æœæˆ‘ä»¬å£°æ˜ä¸€ä¸ªæŒ‡é’ˆç±»å‹çš„å˜é‡ï¼Œç³»ç»Ÿä¸ä¼šä¸ºä»–åˆ†é…å†…å­˜ï¼Œæ”¹å˜é‡é»˜è®¤å°±æ˜¯nilã€‚æ­¤æ—¶å¦‚æœä½ æƒ³ç›´æ¥ä½¿ç”¨ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šæŠ›å¼‚å¸¸ã€‚\nvar j *int fmt.Println(j) *j = 10 //panic: runtime error: invalid memory address or nil pointer dereference  ä¹Ÿå°±æ˜¯è¯´ï¼Œç©ºæŒ‡é’ˆè¿˜æ²¡æœ‰å†…å­˜åˆ†é…ï¼Œæ˜¯ä¸èƒ½ä½¿ç”¨çš„ã€‚é‚£ä¹ˆè¦æƒ³ä½¿ç”¨ï¼Œæ­¤æ—¶å°±éœ€è¦newå‡ºåœºå•¦ã€‚\nvar j *int j = new(int) fmt.Println(j) fmt.Println(*j) *j = 10 fmt.Println(*j)  0xc00000a0e0 0 10  å£°æ˜æŒ‡é’ˆç±»å‹å˜é‡åï¼Œé€šè¿‡newä¸ºä»–åˆ†é…å†…å­˜ï¼Œæœ‰äº†å†…å­˜ç©ºé—´ï¼Œè¿™ä¸ªå˜é‡å°±å¯ä»¥è‡ªç”±çš„ä½¿ç”¨å•¦ã€‚\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹newå‡½æ•°\n// The new built-in function allocates memory. The first argument is a type, // not a value, and the value returned is a pointer to a newly // allocated zero value of that type. func new(Type) *Type  å®ƒåªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç±»å‹ï¼Œåˆ†é…å¥½å†…å­˜åï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥ç±»å‹å†…å­˜åœ°å€çš„æŒ‡é’ˆã€‚åŒæ—¶æŠŠåˆ†é…çš„å†…å­˜ç½®ä¸ºé›¶ï¼Œä¹Ÿå°±æ˜¯ç±»å‹çš„é›¶å€¼ã€‚\næ¥ç€ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹makeå‡½æ•°ã€‚\n// The make built-in function allocates and initializes an object of type // slice, map, or chan (only). Like new, the first argument is a type, not a // value. Unlike new, make's return type is the same as the type of its // argument, not a pointer to it. The specification of the result depends on // the type: //\tSlice: The size specifies the length. The capacity of the slice is //\tequal to its length. A second integer argument may be provided to //\tspecify a different capacity; it must be no smaller than the //\tlength. For example, make([]int, 0, 10) allocates an underlying array //\tof size 10 and returns a slice of length 0 and capacity 10 that is //\tbacked by this underlying array. //\tMap: An empty map is allocated with enough space to hold the //\tspecified number of elements. The size may be omitted, in which case //\ta small starting size is allocated. //\tChannel: The channel's buffer is initialized with the specified //\tbuffer capacity. If zero, or the size is omitted, the channel is //\tunbuffered. func make(t Type, size ...IntegerType) Type   make æ˜¯åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–å¹¶ä¸æ˜¯ç½®ä¸ºé›¶å€¼ã€‚ ä¸newä¸€æ ·ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªç±»å‹ï¼Œä½†æ˜¯ä¸ä¸€æ ·çš„æ˜¯ï¼Œmakeè¿”å›çš„æ˜¯ä¼ å…¥çš„ç±»å‹ï¼Œè€Œä¸æ˜¯æŒ‡é’ˆï¼  var c chan int fmt.Printf(\u0026quot;%#v \\n\u0026quot;,c) //(chan int)(nil) c = make(chan int) fmt.Printf(\u0026quot;%#v\u0026quot;, c) //(chan int)(0xc000062060)  å£°æ˜ç®¡é“ç±»å‹å˜é‡cï¼Œæ­¤æ—¶cè¿˜æ˜¯nilï¼Œä¸å¯ç”¨ï¼›é€šè¿‡makeæ¥åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–ï¼Œcå°±è·å¾—äº†å†…å­˜å¯ä»¥ä½¿ç”¨äº†ã€‚\n","date":"2021å¹´04æœˆ01æ—¥","permalink":"https://ahamoment.cn/posts/go/go-new-vs-make/","summary":"Go è¯­è¨€åˆ†é…å†…å­˜çš„å‡½æ•°åŒ…æ‹¬ new å’Œ makeã€‚new ç”¨æ¥è·å–ç±»å‹å¯¹åº”çš„æŒ‡é’ˆç±»å‹ï¼Œå³è¦è·å–æŒ‡é’ˆç±»å‹çš„å†…å­˜åˆ†é…ã€‚make åªç”¨æ¥åˆ†é…å¼•ç”¨ç±»å‹ï¼Œå³ä¸ºchannelï¼Œmapï¼Œsliceåˆ†é…å†…å­˜ã€‚\nå¯¹äºå€¼ç±»å‹çš„å˜é‡ï¼Œæˆ‘ä»¬é€šè¿‡var å£°æ˜ï¼Œç³»ç»Ÿä¼šé»˜è®¤ä¸ºä»–åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶èµ‹è¯¥ç±»å‹çš„é›¶å€¼ã€‚å¦‚ä¸‹ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªintç±»å‹å˜é‡iï¼Œè¾“å‡ºä¸º0ã€‚\npackage main import \u0026quot;fmt\u0026quot; func main() { var i int fmt.Println(i) }  è€Œå¦‚æœæˆ‘ä»¬å£°æ˜ä¸€ä¸ªæŒ‡é’ˆç±»å‹çš„å˜é‡ï¼Œç³»ç»Ÿä¸ä¼šä¸ºä»–åˆ†é…å†…å­˜ï¼Œæ”¹å˜é‡é»˜è®¤å°±æ˜¯nilã€‚æ­¤æ—¶å¦‚æœä½ æƒ³ç›´æ¥ä½¿ç”¨ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šæŠ›å¼‚å¸¸ã€‚","title":"Go è¯­è¨€ä¸­çš„ new å…³é”®å­—å’Œ make å…³é”®å­—çš„åŒºåˆ«"},{"contents":"å¸¸ç”¨å¿«æ·é”® Overall Mac é”®ç›˜å¿«æ·é”®\nä¿®é¥°é”®  Commandï¼ˆæˆ– Cmdï¼‰âŒ˜ Shift â‡§ Optionï¼ˆæˆ– Altï¼‰âŒ¥ Controlï¼ˆæˆ– Ctrlï¼‰âŒƒ Caps Lock â‡ª Fn  åœ¨ Windows PC ä¸“ç”¨é”®ç›˜ä¸Šï¼Œè¯·ç”¨ Alt é”®ä»£æ›¿ Option é”®ï¼Œç”¨ Windows æ ‡å¿—é”®ä»£æ›¿ Command é”®ã€‚\næˆªå›¾   å…¨å±\nshift + command + 3\n  æˆªå–éƒ¨åˆ†\nshift + command + 4\n  æ‰“å¼€æˆªå±å·¥å…·\nshift + command + 5\n  æ–‡ç¨¿ç¼–è¾‘  Fn-ä¸Šç®­å¤´ï¼šPage Upï¼šå‘ä¸Šæ»šåŠ¨ä¸€é¡µã€‚ Fnâ€“ä¸‹ç®­å¤´ï¼šPage Downï¼šå‘ä¸‹æ»šåŠ¨ä¸€é¡µã€‚ **Fnâ€“å·¦ç®­å¤´ï¼š**Homeï¼šæ»šåŠ¨åˆ°æ–‡ç¨¿å¼€å¤´ã€‚ Fnâ€“å³ç®­å¤´ï¼šEndï¼šæ»šåŠ¨åˆ°æ–‡ç¨¿æœ«å°¾ã€‚ Commandâ€“ä¸Šç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³æ–‡ç¨¿å¼€å¤´ã€‚ Commandâ€“ä¸‹ç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³æ–‡ç¨¿æœ«å°¾ã€‚ Commandâ€“å·¦ç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³å½“å‰è¡Œçš„è¡Œé¦–ã€‚ Commandâ€“å³ç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³å½“å‰è¡Œçš„è¡Œå°¾ã€‚ Optionâ€“å·¦ç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³ä¸Šä¸€å­—è¯çš„è¯é¦–ã€‚ Optionâ€“å³ç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³ä¸‹ä¸€å­—è¯çš„è¯å°¾ã€‚  ","date":"2021å¹´03æœˆ25æ—¥","permalink":"https://ahamoment.cn/posts/tool/tool-mac-os-commands/","summary":"å¸¸ç”¨å¿«æ·é”® Overall Mac é”®ç›˜å¿«æ·é”®\nä¿®é¥°é”®  Commandï¼ˆæˆ– Cmdï¼‰âŒ˜ Shift â‡§ Optionï¼ˆæˆ– Altï¼‰âŒ¥ Controlï¼ˆæˆ– Ctrlï¼‰âŒƒ Caps Lock â‡ª Fn  åœ¨ Windows PC ä¸“ç”¨é”®ç›˜ä¸Šï¼Œè¯·ç”¨ Alt é”®ä»£æ›¿ Option é”®ï¼Œç”¨ Windows æ ‡å¿—é”®ä»£æ›¿ Command é”®ã€‚","title":"Mac å‘½ä»¤æ±‡æ€»"},{"contents":"å®‰è£… Anaconda https://www.anaconda.com/products/individual\næ ¹æ®ç³»ç»Ÿé€‰æ‹©ä¸‹è½½ä¸åŒçš„ anaconda å®‰è£…ï¼š\nè¿™é‡Œå®‰è£…çš„æ˜¯ MacOS çš„è½¯ä»¶åŒ…ï¼Œå®‰è£…å®Œæˆåä½¿ç”¨ conda å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸï¼š\n$ conda --version conda 4.9.2  æ›´æ¢ conda é•œåƒæº æŸ¥çœ‹ç”¨æˆ·ç›®å½•ä¸‹çš„ .condarc æ–‡ä»¶ï¼š\næ›´æ¢æˆæ¸…åå¤§å­¦é•œåƒæº\nchannels: - defaults show_channel_urls: true default_channels: - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2 custom_channels: conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud msys2: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud bioconda: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud menpo: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud simpleitk: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud  è¿è¡Œ conda clean -i æ¸…é™¤ç´¢å¼•ç¼“å­˜ï¼Œä¿è¯ç”¨çš„æ˜¯é•œåƒç«™æä¾›çš„ç´¢å¼•ã€‚\nè¿è¡Œ conda create -n myenv numpy æµ‹è¯•ä¸€ä¸‹å§ã€‚\næ›´æ¢ pip çš„é•œåƒæº é»˜è®¤çš„ pip ä¸‹è½½åœ°å€é€Ÿåº¦è¾ƒæ…¢ï¼Œæˆ‘ä»¬å°†å…¶æ›´æ¢æˆæ¸…åå¤§å­¦çš„é•œåƒåœ°å€ï¼š\n$ pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple Writing to /Users/yaoxiaojiao/.config/pip/pip.conf  è¯¦æƒ…æŸ¥çœ‹ï¼špypi é•œåƒä½¿ç”¨å¸®åŠ©\nå®‰è£… Tensorflow 2.2 åˆ›å»ºä¸€ä¸ª TF2.2 çš„ conda å®éªŒç¯å¢ƒå¹¶å®‰è£…ç›¸å…³è½¯ä»¶åŒ…ï¼š\nconda create -n TF2.2 python=3.8  è¿›å…¥ TF2.2 ç¯å¢ƒä¸­ï¼š\nconda activate TF2.2  å®‰è£…è‹±ä¼Ÿè¾¾æ˜¾å¡çš„ SDK Tensorflow2.1 åŒ¹é…çš„ cuda toolkit æ˜¯ 10.1ï¼Œç”±äºæˆ‘çš„ç”µè„‘ä¸Šæ²¡æœ‰è‹±ä¼Ÿè¾¾çš„æ˜¾å¡ï¼Œæ— æ³•å®‰è£…ï¼Œå…ˆè®°å½•ä¸‹å®‰è£…å‘½ä»¤ï¼Œåç»­æ‰¾å°æœ‰è‹±ä¼Ÿè¾¾æ˜¾å¡çš„æœºå™¨å®éªŒï¼š\nconda install cudatoolkit=10.1  tf2.1å¯¹åº”çš„è‹±ä¼Ÿè¾¾æ˜¾å¡çš„æ·±åº¦å­¦ä¹ è½¯ä»¶åŒ…ç‰ˆæœ¬ä¸º cudnn7.6\nconda install cudnn=7.6  mac pro ç”±äºæ²¡æœ‰è‹±ä¼Ÿè¾¾çš„æ˜¾å¡ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•é€šè¿‡ pycharm è¿œç¨‹è¿æ¥è§£é‡Šå™¨çš„æ–¹å¼ï¼Œåœ¨è¿œç¨‹ä¸€å°æœ‰æ˜¾å¡çš„æœåŠ¡å™¨ä¸Šè¿›è¡Œè§£æã€‚è¯¦æƒ…å‚è€ƒï¼šRemote Debugging with PyCharm\nå®‰è£… tensorflow 2.2\npip install tensorflow==2.2.0  éªŒè¯ tensorflow2.0 å®‰è£…æˆåŠŸï¼š\nimport tensorflow as tf tf.__version__  å‚è€ƒ https://zhuanlan.zhihu.com/p/87123943\nhttps://www.jetbrains.com/help/pycharm/remote-debugging-with-product.html#remote-debug-config\n","date":"2021å¹´03æœˆ25æ—¥","permalink":"https://ahamoment.cn/posts/machinelearning/ml-tensorflow2.0-install/","summary":"å®‰è£… Anaconda https://www.anaconda.com/products/individual\næ ¹æ®ç³»ç»Ÿé€‰æ‹©ä¸‹è½½ä¸åŒçš„ anaconda å®‰è£…ï¼š\nè¿™é‡Œå®‰è£…çš„æ˜¯ MacOS çš„è½¯ä»¶åŒ…ï¼Œå®‰è£…å®Œæˆåä½¿ç”¨ conda å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸï¼š\n$ conda --version conda 4.9.2  æ›´æ¢ conda é•œåƒæº æŸ¥çœ‹ç”¨æˆ·ç›®å½•ä¸‹çš„ .","title":"å®‰è£… Tensorflow2"},{"contents":"æŠ˜è…¾äº†ä¸¤å¤©çš„vimï¼Œæƒ³è¦æŠŠå®ƒå˜æˆæˆ‘çš„æœºå™¨ä¸Šé»˜è®¤çš„IDEï¼Œæ–¹ä¾¿åœ¨æ²¡æœ‰ç¯å¢ƒçš„æ—¶å€™ï¼Œå¿«é€ŸæŸ¥é˜…ä»£ç ï¼Œåšä¸€äº›åŸºæœ¬çš„å¼€å‘ä»»åŠ¡ï¼ŒæŠ˜è…¾è¿‡ç¨‹è®°å½•åœ¨è¿™ç¯‡åšå®¢ä¸Š\nç¯å¢ƒ # cat /etc/*release CentOS Linux release 7.9.2009 (Core)  ç³»ç»Ÿè‡ªå¸¦çš„vimæ˜¯7.xï¼Œå¯¹äºå¾ˆå¤šçš„æ’ä»¶æ¥è¯´(ä¾‹å¦‚ ycm)éƒ½å·²ç»ä¸å…¼å®¹äº†ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥å°±æ˜¯è¦å°† vim çš„ç‰ˆæœ¬æ›´æ–°åˆ° 8.0 ä»¥ä¸Š\nå®‰è£…è½¯ä»¶ ç¼–è¯‘vimä¹‹å‰å…ˆå¸è½½æ‰æ—§ç‰ˆæœ¬çš„vim\nyum remove vim-enhanced vim-common vim-filesystem vim-minimal  ä¸ºäº†ç¼–è¯‘èƒ½å¤Ÿæ­£å¸¸ï¼Œéœ€è¦å®‰è£…ä¸Šä¸€äº›ä¾èµ–å’Œå¸¸ç”¨çš„å·¥å…·åŒ…ï¼š\n# install devtoolset-8 yum install centos-release-scl yum-config-manager --enable rhel-server-rhscl-7-rpms yum install devtoolset-8 scl enable devtoolset-8 bash # install cmake, python3-devel, etc. yum -y install git ncurses-devel ruby ruby-devel lua lua-devel perl perl-devel python3 python3-devel python2-devel perl-ExtUtils-Embed lrzsz cmake wget gcc gcc-c++ unzi  å…¶ä¸­æœ‰éƒ¨åˆ†å·¥å…·æ˜¯ç»™åé¢å®‰è£…æ’ä»¶ä½¿ç”¨çš„ã€‚\nä¸‹è½½vimçš„æºä»£ç ï¼š\ngit clone https://github.com/vim/vim.git cd vim # if you build vim before make distclean # config # --enable-fail-if-missing è¡¨ç¤ºé—®é¢˜ä¼šæç¤ºæŠ¥é”™ï¼Œå¹¶åœæ­¢ # --enable-***interp=yes è¡¨ç¤ºåŠ å…¥***æ”¯æŒ # --with-***-config-dir=*** è¡¨ç¤ºæŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ ./configure --with-features=huge \\ --enable-rubyinterp=yes \\ --enable-luainterp=yes \\ --enable-perlinterp=yes \\ --enable-python3interp=yes \\ --enable-pythoninterp=yes \\ --with-python-config-dir=/usr/lib64/python2.7/config \\ --with-python3-config-dir=/usr/lib64/python3.6/config-3.6m-x86_64-linux-gnu \\ --enable-fontset=yes \\ --enable-cscope=yes \\ --enable-multibyte \\ --disable-gui \\ --enable-fail-if-missing \\ --prefix=/usr/local \\ --with-compiledby='Professional operations' # ç¼–è¯‘ # make VIMRUNTIMEDIR=*** è¡¨ç¤ºæŒ‡å®šVIMå¯æ‰§è¡Œæ–‡ä»¶çš„ä½ç½® make VIMRUNTIMEDIR=/usr/local/share/vim/vim82 \u0026amp;\u0026amp; make install  ç¼–è¯‘å®Œæˆä¹‹åï¼ŒæŸ¥çœ‹ä¸€ä¸‹vimçš„ç‰ˆæœ¬ï¼š\n$ vim --version VIM - Vi IMproved 8.2 (2019 Dec 12, compiled Mar 16 2021 16:12:42)  é…ç½®ä¸æ’ä»¶ ä¸ºäº†æ”¯æŒgoä»£ç çš„å¼€å‘ï¼Œè¿™é‡Œå…ˆä»¥goçš„IDEç¯å¢ƒä¸ºç¤ºä¾‹ï¼Œ\né¦–å…ˆï¼Œæ’ä»¶çš„ç®¡ç†å·¥å…·ï¼Œè¿™é‡Œé€‰æ‹© vim-plugã€‚åœ¨Linuxç¯å¢ƒä¸‹ç›´æ¥ç”¨curlä¸‹è½½å³å¯ï¼š\ncurl -fLo ~/.vim/autoload/plug.vim --create-dirs \\ https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim  æ’ä»¶çš„é…ç½®ä¹Ÿéå¸¸ç®€å•ï¼Œåªè¦å°†æ‰€æœ‰çš„æ’ä»¶é…ç½®åœ¨ call plug#begin('~/.vim/plugged') å’Œ call plug#end() ä¹‹é—´å³å¯ï¼Œå¸¸è§çš„æ’ä»¶åŸºæœ¬ä¸Šéƒ½å¯ä»¥ä» github ä¸­æ‰¾åˆ°ï¼Œå¦‚æœ github æ‰¾ä¸åˆ°çš„è¯åŸºæœ¬ä¸Š vim.org çš„è„šæœ¬éƒ½å¯ä»¥åœ¨ vim-script ä¸­æ‰¾åˆ°å¤‡ä»½\næ¥çœ‹ä¸€ä¸‹ ~/.vimrc çš„æœ€ç»ˆé…ç½®ï¼š\n\u0026quot; æ˜¾ç¤ºè¡Œæ•° set number \u0026quot; æ˜¾ç¤ºå…‰æ ‡æ‰€åœ¨çš„å½“å‰è¡Œçš„è¡Œå·ï¼Œå…¶ä»–è¡Œéƒ½ä¸ºç›¸å¯¹äºè¯¥è¡Œçš„ç›¸å¯¹è¡Œå·ã€‚ \u0026quot; set relativenumber \u0026quot; å…‰æ ‡æ‰€åœ¨å½“å‰è¡Œé«˜äº® \u0026quot; set cursorline \u0026quot; è‡ªåŠ¨æŠ˜è¡Œï¼Œå³å¤ªé•¿çš„è¡Œåˆ†æˆå‡ è¡Œæ˜¾ç¤ºã€‚ \u0026quot; å…³é—­è‡ªåŠ¨æŠ˜è¡Œ \u0026quot; set nowrap set wrap \u0026quot; åªæœ‰é‡åˆ°æŒ‡å®šçš„ç¬¦å·ï¼ˆæ¯”å¦‚ç©ºæ ¼ã€è¿è¯å·å’Œå…¶ä»–æ ‡ç‚¹ç¬¦å·ï¼‰ï¼Œæ‰å‘ç”ŸæŠ˜è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šåœ¨å•è¯å†…éƒ¨æŠ˜è¡Œã€‚ set linebreak \u0026quot; æŒ‡å®šæŠ˜è¡Œå¤„ä¸ç¼–è¾‘çª—å£çš„å³è¾¹ç¼˜ä¹‹é—´ç©ºå‡ºçš„å­—ç¬¦æ•°ã€‚ set wrapmargin=2 \u0026quot; é¿å… backspace ä¸èƒ½ä½¿ç”¨ \u0026quot; 0 same as â€œ:set backspace=â€ (Vi compatible) \u0026quot; 1 same as â€œ:set backspace=indent,eolâ€ \u0026quot; 2 same as â€œ:set backspace=indent,eol,startâ€ set backspace=2 \u0026quot; è‡ªåŠ¨å°†tabé”®è½¬ä¸ºç©ºæ ¼ set expandtab \u0026quot; tab è½¬ä¸ºå¤šå°‘ä¸ªç©ºæ ¼ set softtabstop=4 \u0026quot; è®¾ç½®è¯­æ³•é«˜äº® syntax enable syntax on \u0026quot; æŒ‰ä¸‹å›è½¦é”®åï¼Œä¸‹ä¸€è¡Œçš„ç¼©è¿›ä¼šè‡ªåŠ¨è·Ÿä¸Šä¸€è¡Œçš„ç¼©è¿›ä¿æŒä¸€è‡´ã€‚ set autoindent \u0026quot; å…‰æ ‡é‡åˆ°åœ†æ‹¬å·ã€æ–¹æ‹¬å·ã€å¤§æ‹¬å·æ—¶ï¼Œè‡ªåŠ¨é«˜äº®å¯¹åº”çš„å¦ä¸€ä¸ªåœ†æ‹¬å·ã€æ–¹æ‹¬å·å’Œå¤§æ‹¬å· set showmatch \u0026quot; æŒ‰ä¸‹tabé”®æ—¶ï¼Œvimæ˜¾ç¤ºçš„ç©ºæ ¼æ•° set tabstop=4 \u0026quot; ç»Ÿä¸€ç¼©è¿›ä¸º4 set shiftwidth=4 \u0026quot; åœ¨åº•éƒ¨æ˜¾ç¤ºï¼Œå½“å‰å¤„äºå‘½ä»¤æ¨¡å¼è¿˜æ˜¯æ’å…¥æ¨¡å¼ set showmode \u0026quot; æ”¯æŒä½¿ç”¨é¼ æ ‡ set mouse-=a \u0026quot; ä½¿ç”¨ utf-8 ç¼–ç  set encoding=utf-8 \u0026quot; å¼€å¯æ–‡ä»¶ç±»å‹æ£€æŸ¥ï¼Œå¹¶ä¸”è½½å…¥ä¸è¯¥ç±»å‹å¯¹åº”çš„ç¼©è¿›è§„åˆ™ã€‚æ¯”å¦‚ï¼Œå¦‚æœç¼–è¾‘çš„æ˜¯.pyæ–‡ä»¶ï¼ŒVim å°±æ˜¯ä¼šæ‰¾ Python çš„ç¼©è¿›è§„åˆ™~/.vim/indent/python.vimã€‚ filetype indent on \u0026quot;-------------------------------------- \u0026quot; æœç´¢ \u0026quot;-------------------------------------- \u0026quot; æœç´¢æ—¶ï¼Œé«˜äº®æ˜¾ç¤ºåŒ¹é…ç»“æœ set hlsearch \u0026quot; æœç´¢æ—¶å¿½ç•¥å¤§å°å†™ set ignorecase \u0026quot;-------------------------------------- \u0026quot; æœç´¢(END) \u0026quot;-------------------------------------- \u0026quot;-------------------------------------- \u0026quot; ç¼–è¾‘ \u0026quot;-------------------------------------- \u0026quot; æ‰“å¼€è‹±è¯­å•è¯çš„æ‹¼å†™æ£€æŸ¥ \u0026quot; set spell spelllang=en_us \u0026quot; ä¸åˆ›å»ºäº¤æ¢æ–‡ä»¶ã€‚äº¤æ¢æ–‡ä»¶ä¸»è¦ç”¨äºç³»ç»Ÿå´©æºƒæ—¶æ¢å¤æ–‡ä»¶ï¼Œæ–‡ä»¶åçš„å¼€å¤´æ˜¯.ã€ç»“å°¾æ˜¯.swpã€‚ set noswapfile \u0026quot; å¯ç”¨è‡ªåŠ¨è¡¥å…¨ filetype plugin indent on \u0026quot; é€€å‡ºæ’å…¥æ¨¡å¼æŒ‡å®šç±»å‹çš„æ–‡ä»¶è‡ªåŠ¨ä¿å­˜ au InsertLeave *.go,*.sh,*.php write \u0026quot;-------------------------------------- \u0026quot; ç¼–è¾‘(ç»“æŸ) \u0026quot;------------------------------------- set nocompatible \u0026quot; å»é™¤VIä¸€è‡´æ€§,å¿…é¡» filetype off \u0026quot; å¿…é¡» \u0026quot;-------------------------------------- \u0026quot; vim-plug \u0026quot;-------------------------------------- \u0026quot;\u0026quot; æ’ä»¶å¼€å§‹çš„ä½ç½® call plug#begin('~/.vim/plugged') \u0026quot; Shorthand notation; fetches https://github.com/junegunn/vim-easy-align \u0026quot; å¯ä»¥å¿«é€Ÿå¯¹é½çš„æ’ä»¶ Plug 'junegunn/vim-easy-align' \u0026quot; ç”¨æ¥æä¾›ä¸€ä¸ªå¯¼èˆªç›®å½•çš„ä¾§è¾¹æ  Plug 'scrooloose/nerdtree' \u0026quot; å¯ä»¥ä½¿ nerdtree çš„ tab æ›´åŠ å‹å¥½äº› Plug 'jistr/vim-nerdtree-tabs' \u0026quot; å¯ä»¥åœ¨å¯¼èˆªç›®å½•ä¸­çœ‹åˆ° git ç‰ˆæœ¬ä¿¡æ¯ Plug 'Xuyuanp/nerdtree-git-plugin' \u0026quot; æŸ¥çœ‹å½“å‰ä»£ç æ–‡ä»¶ä¸­çš„å˜é‡å’Œå‡½æ•°åˆ—è¡¨çš„æ’ä»¶ï¼Œ \u0026quot; å¯ä»¥åˆ‡æ¢å’Œè·³è½¬åˆ°ä»£ç ä¸­å¯¹åº”çš„å˜é‡å’Œå‡½æ•°çš„ä½ç½® \u0026quot; å¤§çº²å¼å¯¼èˆª, Go éœ€è¦ https://github.com/jstemmer/gotags æ”¯æŒ Plug 'majutsushi/tagbar' \u0026quot; è‡ªåŠ¨è¡¥å…¨æ‹¬å·çš„æ’ä»¶ï¼ŒåŒ…æ‹¬å°æ‹¬å·ï¼Œä¸­æ‹¬å·ï¼Œä»¥åŠèŠ±æ‹¬å· Plug 'jiangmiao/auto-pairs' \u0026quot; VimçŠ¶æ€æ æ’ä»¶ï¼ŒåŒ…æ‹¬æ˜¾ç¤ºè¡Œå·ï¼Œåˆ—å·ï¼Œæ–‡ä»¶ç±»å‹ï¼Œæ–‡ä»¶åï¼Œä»¥åŠGitçŠ¶æ€ Plug 'vim-airline/vim-airline' \u0026quot; æœ‰é“è¯å…¸åœ¨çº¿ç¿»è¯‘ \u0026quot; Plug 'ianva/vim-youdao-translater' \u0026quot; ä»£ç è‡ªåŠ¨å®Œæˆï¼Œå®‰è£…å®Œæ’ä»¶è¿˜éœ€è¦é¢å¤–é…ç½®æ‰å¯ä»¥ä½¿ç”¨ Plug 'Valloric/YouCompleteMe' \u0026quot; å¯ä»¥åœ¨æ–‡æ¡£ä¸­æ˜¾ç¤º git ä¿¡æ¯ Plug 'airblade/vim-gitgutter' \u0026quot; ä¸‹é¢ä¸¤ä¸ªæ’ä»¶è¦é…åˆä½¿ç”¨ï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆä»£ç å— \u0026quot;Plug 'SirVer/ultisnips' \u0026quot;Plug 'honza/vim-snippets' \u0026quot; å¯ä»¥åœ¨ vim ä¸­ä½¿ç”¨ tab è¡¥å…¨ Plug 'vim-scripts/SuperTab' \u0026quot; å¯ä»¥åœ¨ vim ä¸­è‡ªåŠ¨å®Œæˆ \u0026quot;Plug 'Shougo/neocomplete.vim' \u0026quot; é…è‰²æ–¹æ¡ˆ \u0026quot; colorscheme neodark Plug 'KeitaNakamura/neodark.vim' \u0026quot; colorscheme monokai Plug 'crusoexia/vim-monokai' \u0026quot; colorscheme github Plug 'acarapetis/vim-colors-github' \u0026quot; colorscheme one Plug 'rakr/vim-one' \u0026quot; go ä¸»è¦æ’ä»¶ Plug 'fatih/vim-go', { 'tag': '*' } \u0026quot; go ä¸­çš„ä»£ç è¿½è¸ªï¼Œè¾“å…¥ gd å°±å¯ä»¥è‡ªåŠ¨è·³è½¬ \u0026quot; Plug 'dgryski/vim-godef' \u0026quot; markdown æ’ä»¶ Plug 'iamcco/mathjax-support-for-mkdp' Plug 'iamcco/markdown-preview.vim' \u0026quot; æ’ä»¶ç»“æŸçš„ä½ç½®ï¼Œæ’ä»¶å…¨éƒ¨æ”¾åœ¨æ­¤è¡Œä¸Šé¢ call plug#end() \u0026quot;------------------------------------- \u0026quot; VIM-PLUG(end) \u0026quot;------------------------------------- \u0026quot;============================================================================== \u0026quot; ä¸»é¢˜é…è‰² \u0026quot;============================================================================== \u0026quot; ä½¿ç”¨256è‰² \u0026quot; set t_Co=256 \u0026quot; å¼€å¯24bitçš„é¢œè‰²ï¼Œå¼€å¯è¿™ä¸ªé¢œè‰²ä¼šæ›´æ¼‚äº®ä¸€äº› set termguicolors \u0026quot; é…è‰²æ–¹æ¡ˆ, å¯ä»¥ä»ä¸Šé¢æ’ä»¶å®‰è£…ä¸­çš„é€‰æ‹©ä¸€ä¸ªä½¿ç”¨ colorscheme one \u0026quot; ä¸»é¢˜ set background=dark \u0026quot; ä¸»é¢˜èƒŒæ™¯ dark-æ·±è‰²; light-æµ…è‰² \u0026quot;============================================================================== \u0026quot; vim-go æ’ä»¶ \u0026quot;============================================================================== let g:go_fmt_command = \u0026quot;goimports\u0026quot; \u0026quot; æ ¼å¼åŒ–å°†é»˜è®¤çš„ gofmt æ›¿æ¢ let g:go_autodetect_gopath = 1 let g:go_list_type = \u0026quot;quickfix\u0026quot; let g:go_version_warning = 1 let g:go_highlight_types = 1 let g:go_highlight_fields = 1 let g:go_highlight_functions = 1 let g:go_highlight_function_calls = 1 let g:go_highlight_operators = 1 let g:go_highlight_extra_types = 1 let g:go_highlight_methods = 1 let g:go_highlight_generate_tags = 1 let g:godef_split=2 \u0026quot;============================================================================== \u0026quot; NERDTree æ’ä»¶ \u0026quot;============================================================================== \u0026quot; æ‰“å¼€å’Œå…³é—­NERDTreeå¿«æ·é”® map \u0026lt;F3\u0026gt; :NERDTreeToggle\u0026lt;CR\u0026gt; \u0026quot; æ˜¾ç¤ºè¡Œå· let NERDTreeShowLineNumbers=1 \u0026quot; æ‰“å¼€æ–‡ä»¶æ—¶æ˜¯å¦æ˜¾ç¤ºç›®å½• let NERDTreeAutoCenter=1 \u0026quot; æ˜¯å¦æ˜¾ç¤ºéšè—æ–‡ä»¶ let NERDTreeShowHidden=0 \u0026quot; è®¾ç½®å®½åº¦ \u0026quot; let NERDTreeWinSize=31 \u0026quot; å¿½ç•¥ä¸€ä¸‹æ–‡ä»¶çš„æ˜¾ç¤º let NERDTreeIgnore=['\\.pyc','\\~$','\\.swp'] \u0026quot; æ‰“å¼€ vim æ–‡ä»¶åŠæ˜¾ç¤ºä¹¦ç­¾åˆ—è¡¨ let NERDTreeShowBookmarks=2 \u0026quot; åœ¨ç»ˆç«¯å¯åŠ¨vimæ—¶ï¼Œå…±äº«NERDTree let g:nerdtree_tabs_open_on_console_startup=1 \u0026quot;============================================================================== \u0026quot; majutsushi/tagbar æ’ä»¶ \u0026quot;============================================================================== \u0026quot; majutsushi/tagbar æ’ä»¶æ‰“å¼€å…³é—­å¿«æ·é”® nmap \u0026lt;F9\u0026gt; :TagbarToggle\u0026lt;CR\u0026gt; let g:tagbar_type_go = { \\ 'ctagstype' : 'go', \\ 'kinds' : [ \\ 'p:package', \\ 'i:imports:1', \\ 'c:constants', \\ 'v:variables', \\ 't:types', \\ 'n:interfaces', \\ 'w:fields', \\ 'e:embedded', \\ 'm:methods', \\ 'r:constructor', \\ 'f:functions' \\ ], \\ 'sro' : '.', \\ 'kind2scope' : { \\ 't' : 'ctype', \\ 'n' : 'ntype' \\ }, \\ 'scope2kind' : { \\ 'ctype' : 't', \\ 'ntype' : 'n' \\ }, \\ 'ctagsbin' : 'gotags', \\ 'ctagsargs' : '-sort -silent' \\ } \u0026quot;============================================================================== \u0026quot; nerdtree-git-plugin æ’ä»¶ \u0026quot;============================================================================== let g:NERDTreeGitStatusIndicatorMapCustom = { \\ \u0026quot;Modified\u0026quot; : \u0026quot;âœ¹\u0026quot;, \\ \u0026quot;Staged\u0026quot; : \u0026quot;âœš\u0026quot;, \\ \u0026quot;Untracked\u0026quot; : \u0026quot;âœ­\u0026quot;, \\ \u0026quot;Renamed\u0026quot; : \u0026quot;âœ\u0026quot;, \\ \u0026quot;Unmerged\u0026quot; : \u0026quot;â•\u0026quot;, \\ \u0026quot;Deleted\u0026quot; : \u0026quot;âœ–\u0026quot;, \\ \u0026quot;Dirty\u0026quot; : \u0026quot;âœ—\u0026quot;, \\ \u0026quot;Clean\u0026quot; : \u0026quot;âœ”ï¸\u0026quot;, \\ 'Ignored' : 'â˜’', \\ \u0026quot;Unknown\u0026quot; : \u0026quot;?\u0026quot; \\ } let g:NERDTreeGitStatusShowIgnored = 1 \u0026quot;============================================================================== \u0026quot; Valloric/YouCompleteMe æ’ä»¶ \u0026quot;============================================================================== \u0026quot; make YCM compatible with UltiSnips (using supertab) let g:ycm_key_list_select_completion = ['\u0026lt;C-n\u0026gt;', '\u0026lt;space\u0026gt;'] let g:ycm_key_list_previous_completion = ['\u0026lt;C-p\u0026gt;', '\u0026lt;Up\u0026gt;'] let g:SuperTabDefaultCompletionType = '\u0026lt;C-n\u0026gt;' \u0026quot; better key bindings for UltiSnipsExpandTrigger let g:UltiSnipsExpandTrigger = \u0026quot;\u0026lt;tab\u0026gt;\u0026quot; let g:UltiSnipsJumpForwardTrigger = \u0026quot;\u0026lt;tab\u0026gt;\u0026quot; let g:UltiSnipsJumpBackwardTrigger = \u0026quot;\u0026lt;s-tab\u0026gt;\u0026quot; \u0026quot;============================================================================== \u0026quot; å…¶ä»–æ’ä»¶é…ç½® \u0026quot;============================================================================== \u0026quot; markdwon çš„å¿«æ·é”® map \u0026lt;silent\u0026gt; \u0026lt;F5\u0026gt; \u0026lt;Plug\u0026gt;MarkdownPreview map \u0026lt;silent\u0026gt; \u0026lt;F6\u0026gt; \u0026lt;Plug\u0026gt;StopMarkdownPreview \u0026quot; tab æ ‡ç­¾é¡µåˆ‡æ¢å¿«æ·é”® :nn \u0026lt;Leader\u0026gt;1 1gt :nn \u0026lt;Leader\u0026gt;2 2gt :nn \u0026lt;Leader\u0026gt;3 3gt :nn \u0026lt;Leader\u0026gt;4 4gt :nn \u0026lt;Leader\u0026gt;5 5gt :nn \u0026lt;Leader\u0026gt;6 6gt :nn \u0026lt;Leader\u0026gt;7 7gt :nn \u0026lt;Leader\u0026gt;8 8gt :nn \u0026lt;Leader\u0026gt;9 8gt :nn \u0026lt;Leader\u0026gt;0 :tablast\u0026lt;CR\u0026gt;  å‚è€ƒ å°† VIM æ‰“é€ æˆ go è¯­è¨€çš„ ide\n","date":"2021å¹´03æœˆ16æ—¥","permalink":"https://ahamoment.cn/posts/tool/tool-vim/","summary":"\u003cp\u003eæŠ˜è…¾äº†ä¸¤å¤©çš„vimï¼Œæƒ³è¦æŠŠå®ƒå˜æˆæˆ‘çš„æœºå™¨ä¸Šé»˜è®¤çš„IDEï¼Œæ–¹ä¾¿åœ¨æ²¡æœ‰ç¯å¢ƒçš„æ—¶å€™ï¼Œå¿«é€ŸæŸ¥é˜…ä»£ç ï¼Œåšä¸€äº›åŸºæœ¬çš„å¼€å‘ä»»åŠ¡ï¼ŒæŠ˜è…¾è¿‡ç¨‹è®°å½•åœ¨è¿™ç¯‡åšå®¢ä¸Š\u003c/p\u003e","title":"Vim æŠ˜è…¾è®°"},{"contents":"GOPATH æ˜¯ Goè¯­è¨€ä¸­ä½¿ç”¨çš„ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå®ƒä½¿ç”¨ç»å¯¹è·¯å¾„æä¾›é¡¹ç›®çš„å·¥ä½œç›®å½•ã€‚\nå·¥ä½œç›®å½•æ˜¯ä¸€ä¸ªå·¥ç¨‹å¼€å‘çš„ç›¸å¯¹å‚è€ƒç›®å½•ï¼Œå¥½æ¯”å½“ä½ è¦åœ¨å…¬å¸ç¼–å†™ä¸€å¥—æœåŠ¡å™¨ä»£ç ï¼Œä½ çš„å·¥ä½æ‰€åŒ…å«çš„æ¡Œé¢ã€è®¡ç®—æœºåŠæ¤…å­å°±æ˜¯ä½ çš„å·¥ä½œåŒºã€‚å·¥ä½œåŒºçš„æ¦‚å¿µä¸å·¥ä½œç›®å½•çš„æ¦‚å¿µä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚å¦‚æœä¸ä½¿ç”¨å·¥ä½œç›®å½•çš„æ¦‚å¿µï¼Œåœ¨å¤šäººå¼€å‘æ—¶ï¼Œæ¯ä¸ªäººæœ‰ä¸€å¥—è‡ªå·±çš„ç›®å½•ç»“æ„ï¼Œè¯»å–é…ç½®æ–‡ä»¶çš„ä½ç½®ä¸ç»Ÿä¸€ï¼Œè¾“å‡ºçš„äºŒè¿›åˆ¶è¿è¡Œæ–‡ä»¶ä¹Ÿä¸ç»Ÿä¸€ï¼Œè¿™æ ·ä¼šå¯¼è‡´å¼€å‘çš„æ ‡å‡†ä¸ç»Ÿä¸€ï¼Œå½±å“å¼€å‘æ•ˆç‡ã€‚\nGOPATH é€‚åˆå¤„ç†å¤§é‡ Goè¯­è¨€æºç ã€å¤šä¸ªåŒ…ç»„åˆè€Œæˆçš„å¤æ‚å·¥ç¨‹ã€‚\nåœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ go env æ¥æŸ¥çœ‹å½“å‰ GOPATH è·¯å¾„è®¾ç½®æƒ…å†µï¼š\n# go env GO111MODULE=\u0026quot;\u0026quot; GOARCH=\u0026quot;amd64\u0026quot; GOBIN=\u0026quot;\u0026quot; GOCACHE=\u0026quot;/root/.cache/go-build\u0026quot; GOENV=\u0026quot;/root/.config/go/env\u0026quot; GOEXE=\u0026quot;\u0026quot; GOFLAGS=\u0026quot;\u0026quot; GOHOSTARCH=\u0026quot;amd64\u0026quot; GOHOSTOS=\u0026quot;linux\u0026quot; GOINSECURE=\u0026quot;\u0026quot; GOMODCACHE=\u0026quot;/root/go/pkg/mod\u0026quot; GONOPROXY=\u0026quot;\u0026quot; GONOSUMDB=\u0026quot;\u0026quot; GOOS=\u0026quot;linux\u0026quot; GOPATH=\u0026quot;/root/go\u0026quot; GOPRIVATE=\u0026quot;\u0026quot; GOPROXY=\u0026quot;https://proxy.golang.org,direct\u0026quot; GOROOT=\u0026quot;/usr/local/go\u0026quot; GOSUMDB=\u0026quot;sum.golang.org\u0026quot; GOTMPDIR=\u0026quot;\u0026quot; GOTOOLDIR=\u0026quot;/usr/local/go/pkg/tool/linux_amd64\u0026quot; GOVCS=\u0026quot;\u0026quot; GOVERSION=\u0026quot;go1.16\u0026quot; GCCGO=\u0026quot;gccgo\u0026quot; AR=\u0026quot;ar\u0026quot; CC=\u0026quot;gcc\u0026quot; CXX=\u0026quot;g++\u0026quot; CGO_ENABLED=\u0026quot;1\u0026quot; GOMOD=\u0026quot;/dev/null\u0026quot; CGO_CFLAGS=\u0026quot;-g -O2\u0026quot; CGO_CPPFLAGS=\u0026quot;\u0026quot; CGO_CXXFLAGS=\u0026quot;-g -O2\u0026quot; CGO_FFLAGS=\u0026quot;-g -O2\u0026quot; CGO_LDFLAGS=\u0026quot;-g -O2\u0026quot; PKG_CONFIG=\u0026quot;pkg-config\u0026quot; GOGCCFLAGS=\u0026quot;-fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build439564896=/tmp/go-build -gno-record-gcc-switches\u0026quot;  å‘½ä»¤è¡Œè¾“å‡ºçš„è¯´æ˜å¦‚ä¸‹ï¼š\n GOARCH è¡¨ç¤ºç›®æ ‡å¤„ç†å™¨çš„æ¶æ„ GOBIN è¡¨ç¤ºç¼–è¯‘å™¨å’Œé“¾æ¥å™¨çš„å®‰è£…ä½ç½® GOOS è¡¨ç¤ºç›®æ ‡æ“ä½œç³»ç»Ÿ GOPATH è¡¨ç¤ºå½“å‰å·¥ä½œç›®å½• GOROOT è¡¨ç¤ºGOå¼€å‘åŒ…çš„å®‰è£…ç›®å½•  ä»å‘½ä»¤è¡Œè¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œå½“å‰GOPATH çš„è·¯å¾„ä¸ºï¼š /root/goã€‚\nåœ¨ GOPATH æŒ‡å®šçš„å·¥ä½œç›®å½•ä¸‹ï¼Œä»£ç æ€»æ˜¯ä¼šä¿å­˜åœ¨ $GOPATH/src ç›®å½•ä¸‹ã€‚åœ¨å·¥ç¨‹ç»è¿‡ go buildã€go install æˆ– go get ç­‰æŒ‡ä»¤åï¼Œä¼šå°†äº§ç”Ÿçš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶æ”¾åœ¨ $GOPATH/bin ç›®å½•ä¸‹ï¼Œç”Ÿæˆçš„ä¸­é—´ç¼“å­˜æ–‡ä»¶ä¼šè¢«ä¿å­˜åœ¨ $GOPATH/pkg ä¸‹ã€‚\nå¦‚æœéœ€è¦å°†æ•´ä¸ªæºç æ·»åŠ åˆ°ç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼ˆVersion Control Systemï¼ŒVCSï¼‰ä¸­æ—¶ï¼Œåªéœ€è¦æ·»åŠ  $GOPATH/src ç›®å½•çš„æºç å³å¯ã€‚bin å’Œ pkg ç›®å½•çš„å†…å®¹éƒ½å¯ä»¥ç”± src ç›®å½•ç”Ÿæˆã€‚\nè®¾ç½®å’Œä½¿ç”¨ GOPATH æœ¬èŠ‚ä»¥ Linux ä¸ºæ¼”ç¤ºå¹³å°ï¼Œä¸ºå¤§å®¶æ¼”ç¤ºä½¿ç”¨ GOPATH çš„æ–¹æ³•ã€‚\n1. è®¾ç½®å½“å‰ç›®å½•ä¸ºGOPATH é€‰æ‹©ä¸€ä¸ªç›®å½•ï¼Œåœ¨ç›®å½•ä¸­çš„å‘½ä»¤è¡Œä¸­æ‰§è¡Œä¸‹é¢çš„æŒ‡ä»¤ï¼š\nexport GOPATH=`pwd`  è¯¥æŒ‡ä»¤ä¸­çš„ pwd å°†è¾“å‡ºå½“å‰çš„ç›®å½•ï¼Œä½¿ç”¨åå¼•å·å°† pwd æŒ‡ä»¤æ‹¬èµ·æ¥è¡¨ç¤ºå‘½ä»¤è¡Œæ›¿æ¢ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨pwdå°†è·å¾— pwd è¿”å›çš„å½“å‰ç›®å½•çš„å€¼ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ çš„å½“å‰ç›®å½•æ˜¯â€œ/home/davy/goâ€ï¼Œé‚£ä¹ˆä½¿ç”¨pwdå°†è·å¾—è¿”å›å€¼â€œ/home/davy/goâ€ã€‚\nä½¿ç”¨ export æŒ‡ä»¤å¯ä»¥å°†å½“å‰ç›®å½•çš„å€¼è®¾ç½®åˆ°ç¯å¢ƒå˜é‡ GOPATHä¸­ã€‚\n2. å»ºç«‹GOPATHä¸­çš„æºç ç›®å½• ä½¿ç”¨ä¸‹é¢çš„æŒ‡ä»¤åˆ›å»º GOPATH ä¸­çš„srcç›®å½•ï¼Œåœ¨ src ç›®å½•ä¸‹è¿˜æœ‰ä¸€ä¸ª hello ç›®å½•ï¼Œè¯¥ç›®å½•ç”¨äºä¿å­˜æºä»£ç ã€‚\nmkdir -p src/hello  mkdir æŒ‡ä»¤çš„ -p å¯ä»¥è¿ç»­åˆ›å»ºä¸€ä¸ªè·¯å¾„ã€‚\n3. æ·»åŠ  main.go æºç æ–‡ä»¶ ä½¿ç”¨ Linux ç¼–è¾‘å™¨å°†ä¸‹é¢çš„æºç ä¿å­˜ä¸º main.go å¹¶ä¿å­˜åˆ° $GOPATH/src/hello ç›®å½•ä¸‹ã€‚\npackage main import \u0026quot;fmt\u0026quot; func main(){ fmt.Println(\u0026quot;hello\u0026quot;) }  4. ç¼–è¯‘æºç è¿è¡Œ æ­¤æ—¶æˆ‘ä»¬å·²ç»è®¾ç½®äº† GOPATHï¼Œ å› æ­¤åœ¨ GO è¯­è¨€ä¸­å¯ä»¥é€šè¿‡ GOPATH æ‰¾åˆ°å·¥ç¨‹çš„ä½ç½®ã€‚\nåœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ç¼–è¯‘æºç ï¼š\ngo install hell  ç¼–è¯‘å®Œæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¼šä¿å­˜åœ¨$GOPATH/bin ç›®å½•ä¸‹ã€‚\nåœ¨ bin ç›®å½•ä¸­æ‰§è¡Œ ./helloï¼Œå‘½ä»¤è¡Œè¾“å‡ºå¦‚ä¸‹ï¼š\nhello world\nåœ¨å¤šé¡¹ç›®å·¥ç¨‹ä¸­ä½¿ç”¨ GOPATH åœ¨å¾ˆå¤šä¸ Goè¯­è¨€ç›¸å…³çš„ä¹¦ç±ã€æ–‡ç« ä¸­æè¿°çš„ GOPATH éƒ½æ˜¯é€šè¿‡ä¿®æ”¹ç³»ç»Ÿå…¨å±€çš„ç¯å¢ƒå˜é‡æ¥å®ç°çš„ã€‚ç„¶è€Œï¼Œæ ¹æ®ç¬”è€…å¤šå¹´çš„ Goè¯­è¨€ä½¿ç”¨å’Œå®è·µç»éªŒåŠå‘¨è¾¹æœ‹å‹ã€åŒäº‹çš„åé¦ˆï¼Œè¿™ç§è®¾ç½®å…¨å±€ GOPATH çš„æ–¹æ³•å¯èƒ½ä¼šå¯¼è‡´å½“å‰é¡¹ç›®é”™è¯¯å¼•ç”¨äº†å…¶ä»–ç›®å½•çš„ Go æºç æ–‡ä»¶ä»è€Œé€ æˆç¼–è¯‘è¾“å‡ºé”™è¯¯çš„ç‰ˆæœ¬æˆ–ç¼–è¯‘æŠ¥å‡ºä¸€äº›æ— æ³•ç†è§£çš„é”™è¯¯æç¤ºã€‚\næ¯”å¦‚è¯´ï¼Œå°†æŸé¡¹ç›®ä»£ç ä¿å­˜åœ¨ /home/davy/projectA ç›®å½•ä¸‹ï¼Œå°†è¯¥ç›®å½•è®¾ç½®ä¸º GOPATHã€‚éšç€å¼€å‘è¿›è¡Œï¼Œéœ€è¦å†æ¬¡è·å–ä¸€ä»½å·¥ç¨‹é¡¹ç›®çš„æºç ï¼Œæ­¤æ—¶æºç ä¿å­˜åœ¨ /home/davy/projectB ç›®å½•ä¸‹ï¼Œå¦‚æœæ­¤æ—¶éœ€è¦ç¼–è¯‘ projectB ç›®å½•çš„é¡¹ç›®ï¼Œä½†å¼€å‘è€…å¿˜è®°è®¾ç½® GOPATH è€Œç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œç¼–è¯‘ï¼Œåˆ™å½“å‰çš„ GOPATH æŒ‡å‘çš„æ˜¯ /home/davy/projectA ç›®å½•ï¼Œè€Œä¸æ˜¯å¼€å‘è€…ç¼–è¯‘æ—¶æœŸæœ›çš„ projectB ç›®å½•ã€‚ç¼–è¯‘å®Œæˆåï¼Œå¼€å‘è€…å°±ä¼šå°†é”™è¯¯çš„å·¥ç¨‹ç‰ˆæœ¬å‘å¸ƒåˆ°å¤–ç½‘ã€‚\nå› æ­¤ï¼Œå»ºè®®å¤§å®¶æ— è®ºæ˜¯ä½¿ç”¨å‘½ä»¤è¡Œæˆ–è€…ä½¿ç”¨é›†æˆå¼€å‘ç¯å¢ƒç¼–è¯‘ Go æºç æ—¶ï¼ŒGOPATH è·Ÿéšé¡¹ç›®è®¾å®šã€‚åœ¨ Jetbrains å…¬å¸çš„ GoLand é›†æˆå¼€å‘ç¯å¢ƒï¼ˆIDEï¼‰ä¸­çš„ GOPATH è®¾ç½®åˆ†ä¸ºå…¨å±€ GOPATH å’Œé¡¹ç›® GOPATHï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nå›¾ä¸­çš„ Global GOPATH ä»£è¡¨å…¨å±€ GOPATHï¼Œä¸€èˆ¬æ¥æºäºç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­çš„ GOPATHï¼›Project GOPATH ä»£è¡¨é¡¹ç›®æ‰€ä½¿ç”¨çš„ GOPATHï¼Œè¯¥è®¾ç½®ä¼šè¢«ä¿å­˜åœ¨å·¥ä½œç›®å½•çš„ .idea ç›®å½•ä¸‹ï¼Œä¸ä¼šè¢«è®¾ç½®åˆ°ç¯å¢ƒå˜é‡çš„ GOPATH ä¸­ï¼Œä½†ä¼šåœ¨ç¼–è¯‘æ—¶ä½¿ç”¨åˆ°è¿™ä¸ªç›®å½•ã€‚å»ºè®®åœ¨å¼€å‘æ—¶åªå¡«å†™é¡¹ç›® GOPATHï¼Œæ¯ä¸€ä¸ªé¡¹ç›®å°½é‡åªè®¾ç½®ä¸€ä¸ª GOPATHï¼Œä¸ä½¿ç”¨å¤šä¸ª GOPATH å’Œå…¨å±€çš„ GOPATHã€‚\næç¤º Visual Studio æ—©æœŸåœ¨è®¾è®¡æ—¶ï¼Œå…è®¸ C++ è¯­è¨€åœ¨å…¨å±€æ‹¥æœ‰ä¸€ä¸ªåŒ…å«è·¯å¾„ã€‚å½“ä¸€ä¸ªå·¥ç¨‹å¤šä¸ªç‰ˆæœ¬çš„ç¼–è¯‘ï¼Œæˆ–è€…ä¸¤ä¸ªé¡¹ç›®æ··æ‚æœ‰ä¸åŒçš„å…±äº«å…¨å±€åŒ…å«æ—¶ï¼Œä¼šå‘ç”Ÿéš¾ä»¥å¯Ÿè§‰çš„é”™è¯¯ã€‚åœ¨æ–°ç‰ˆæœ¬ Visual Studio ä¸­å·²ç»åºŸé™¤äº†è¿™ç§å…¨å±€åŒ…å«çš„è·¯å¾„è®¾è®¡ï¼Œå¹¶å»ºè®®å¼€å‘è€…å°†åŒ…å«ç›®å½•ä¸é¡¹ç›®å…³è”ã€‚\nGoè¯­è¨€ä¸­çš„ GOPATH ä¹Ÿæ˜¯ä¸€ç§ç±»ä¼¼å…¨å±€åŒ…å«çš„è®¾è®¡ï¼Œå› æ­¤é‰´äº Visual Studio åœ¨è®¾è®¡ä¸Šçš„å¤±è¯¯ï¼Œå»ºè®®å¼€å‘è€…ä¸è¦è®¾ç½®å…¨å±€çš„ GOPATHï¼Œè€Œæ˜¯éšé¡¹ç›®è®¾ç½® GOPATH\n","date":"2021å¹´03æœˆ15æ—¥","permalink":"https://ahamoment.cn/posts/go/go-project-catalogs/","summary":"GOPATH æ˜¯ Goè¯­è¨€ä¸­ä½¿ç”¨çš„ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå®ƒä½¿ç”¨ç»å¯¹è·¯å¾„æä¾›é¡¹ç›®çš„å·¥ä½œç›®å½•ã€‚\nå·¥ä½œç›®å½•æ˜¯ä¸€ä¸ªå·¥ç¨‹å¼€å‘çš„ç›¸å¯¹å‚è€ƒç›®å½•ï¼Œå¥½æ¯”å½“ä½ è¦åœ¨å…¬å¸ç¼–å†™ä¸€å¥—æœåŠ¡å™¨ä»£ç ï¼Œä½ çš„å·¥ä½æ‰€åŒ…å«çš„æ¡Œé¢ã€è®¡ç®—æœºåŠæ¤…å­å°±æ˜¯ä½ çš„å·¥ä½œåŒºã€‚å·¥ä½œåŒºçš„æ¦‚å¿µä¸å·¥ä½œç›®å½•çš„æ¦‚å¿µä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚å¦‚æœä¸ä½¿ç”¨å·¥ä½œç›®å½•çš„æ¦‚å¿µï¼Œåœ¨å¤šäººå¼€å‘æ—¶ï¼Œæ¯ä¸ªäººæœ‰ä¸€å¥—è‡ªå·±çš„ç›®å½•ç»“æ„ï¼Œè¯»å–é…ç½®æ–‡ä»¶çš„ä½ç½®ä¸ç»Ÿä¸€ï¼Œè¾“å‡ºçš„äºŒè¿›åˆ¶è¿è¡Œæ–‡ä»¶ä¹Ÿä¸ç»Ÿä¸€ï¼Œè¿™æ ·ä¼šå¯¼è‡´å¼€å‘çš„æ ‡å‡†ä¸ç»Ÿä¸€ï¼Œå½±å“å¼€å‘æ•ˆç‡ã€‚\nGOPATH é€‚åˆå¤„ç†å¤§é‡ Goè¯­è¨€æºç ã€å¤šä¸ªåŒ…ç»„åˆè€Œæˆçš„å¤æ‚å·¥ç¨‹ã€‚\nåœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ go env æ¥æŸ¥çœ‹å½“å‰ GOPATH è·¯å¾„è®¾ç½®æƒ…å†µï¼š\n# go env GO111MODULE=\u0026quot;\u0026quot; GOARCH=\u0026quot;amd64\u0026quot; GOBIN=\u0026quot;\u0026quot; GOCACHE=\u0026quot;/root/.cache/go-build\u0026quot; GOENV=\u0026quot;/root/.","title":"Go è¯­è¨€å·¥ä½œç›®å½•"},{"contents":" åŸæ–‡é“¾æ¥ï¼šKubernetes Deep Dive: Code Generation for CustomResources\n CustomResourceDefinitions (CRDs)æ˜¯kubernetes 1.7 ä¸­å¼•å…¥çš„ï¼Œå¹¶åœ¨1.8ä¸­ä»alphaç‰ˆæœ¬å‡çº§ä¸ºbetaç‰ˆæœ¬äº†ï¼Œæœ€æ–°ç‰ˆæœ¬çš„kubernetes 1.20 ä¸­ï¼ŒCRDsçš„ç‰ˆæœ¬å·²ç»æ˜¯v1äº†ã€‚ç”±äºCRDsçš„æ˜“ç”¨æ€§ï¼Œåœ¨å¾ˆå¤šå®ç°äº†æ§åˆ¶å™¨æ¨¡å¼çš„ä¾‹å­ä¸­éƒ½å¯ä»¥çœ‹åˆ°å®ƒçš„èº«å½±ã€‚\nåœ¨Kubernetes 1.8ä¸­ï¼Œ CRDs åœ¨åŸºäºgolangçš„é¡¹ç›®ä¸­çš„ä½¿ç”¨ä¹Ÿå˜å¾—æ›´åŠ è‡ªç„¶ï¼šé€šè¿‡ç”¨æˆ·æä¾›çš„ CustomResourcesï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨åœ¨Kubernetesæä¾›çš„ä»£ç ç”Ÿæˆå·¥å…·æ¥ç”Ÿæˆä»£ç ã€‚è¿™ç¯‡æ–‡ç« å±•ç¤ºäº†ä»£ç ç”Ÿæˆå™¨çš„å·¥ä½œæ–¹å¼ï¼Œä»¥åŠå¦‚ä½•ä»¥æœ€å°‘çš„ä»£ç è¡Œå°†å…¶åº”ç”¨åˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œä¸ºæ‚¨æä¾›äº†ç”Ÿæˆçš„Deepcopyå‡½æ•°ï¼Œå†…ç½®çš„clientsï¼Œlisterså’Œinformersï¼Œæ‰€æœ‰è¿™äº›éƒ½å¸¦æœ‰ä¸€ä¸ªShellè„šæœ¬è°ƒç”¨å’Œå‡ ä¸ªä»£ç æ³¨é‡Šã€‚\n æ³¨ï¼šdeepcopyï¼Œæ„ä¸ºâ€æ·±æ‹·è´â€œï¼Œæ·±æ‹·è´æ„å‘³ç€ä¼šé‡æ–°ç”Ÿæˆå¯¹è±¡å¹¶æ‹·è´å¯¹è±¡ä¸­çš„æ‰€æœ‰å­—æ®µã€åœ°å€ç­‰æ•°æ®ï¼›æµ…æ‹·è´ä»…ä»…æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶æ²¡æœ‰ç”Ÿæˆæ–°çš„å¯¹è±¡ã€‚\n ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä»£ç ç”Ÿæˆï¼Ÿ é‚£äº›åœ¨golangä¸­åŸç”Ÿä½¿ç”¨ThirdPartyResourcesæˆ–CustomResourceDefinitionçš„äººå¯èƒ½ä¼šæƒŠè®¶äºçªç„¶åœ¨Kubernetes 1.8ä¸­éœ€è¦ç”Ÿæˆclient-goã€‚æ›´å…·ä½“åœ°è¯´ï¼Œclient-goè¦æ±‚ runtime.Object ç±»å‹ï¼ˆgolangä¸­çš„CustomResourceså¿…é¡»å®ç°runtime.Objectæ¥å£ï¼‰å¿…é¡»å…·æœ‰DeepCopyæ–¹æ³•ã€‚è¿™é‡Œçš„ä»£ç ç”Ÿæˆé€šè¿‡deepcopy-genç”Ÿæˆå™¨èµ·ä½œç”¨ï¼Œå¯ä»¥åœ¨k8s.io/code-generatorå­˜å‚¨åº“ä¸­æ‰¾åˆ°ã€‚\né™¤äº†deepcopy-gen ç”Ÿæˆå™¨å¤–ï¼Œè¿˜æœ‰å‡ ä¸ªä»£ç ç”Ÿæˆå™¨æ˜¯å¤§å¤šæ•°CustomResourcesç”¨æˆ·éƒ½æƒ³ä½¿ç”¨çš„ï¼š\n deepcopy-gen - ä¸ºæ¯ä¸ªTç±»å‹çš„æ–¹æ³•åˆ›å»ºfunc (t* T) DeepCopy() *T å‡½æ•° client-gen - ä¸º CustomResource APIGroups åˆ›å»ºå†…ç½®çš„å®¢æˆ·ç«¯é›† informer-gen - ä¸ºCustomResourcesåˆ›å»ºinformerï¼Œè¯¥informeræä¾›åŸºäºäº‹ä»¶çš„ç•Œé¢ä»¥å¯¹æœåŠ¡å™¨ä¸ŠCustomResourcesçš„æ›´æ”¹åšå‡ºååº” lister-gen - ä¸ºCustomResourcesåˆ›å»ºlistersï¼Œè¯¥listersä¸ºGETå’ŒLISTè¯·æ±‚æä¾›åªè¯»ç¼“å­˜å±‚ã€‚  æœ€åä¸¤ä¸ªæ˜¯æ„å»ºæ§åˆ¶å™¨ï¼ˆæˆ–Operatorsï¼‰çš„åŸºç¡€ã€‚åœ¨åç»­åšå®¢ä¸­ï¼Œæˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°ä»‹ç»æ§åˆ¶å™¨ã€‚è¿™å››ä¸ªä»£ç ç”Ÿæˆå™¨ä½¿ç”¨ä¸Kubernetesä¸Šæ¸¸æ§åˆ¶å™¨æ‰€ä½¿ç”¨çš„ç›¸åŒçš„æœºåˆ¶å’Œè½¯ä»¶åŒ…ï¼Œæ„æˆäº†æ„å»ºåŠŸèƒ½é½å…¨ï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒçš„æ§åˆ¶å™¨çš„å¼ºå¤§åŸºç¡€ã€‚\nk8s.io/code-generator ä¸­è¿˜æœ‰å…¶ä»–ç”¨äºå…¶ä»–ä¸Šä¸‹æ–‡çš„ç”Ÿæˆå™¨ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ„å»ºè‡ªå·±çš„èšåˆAPIæœåŠ¡å™¨ï¼Œåˆ™é™¤äº†ç‰ˆæœ¬åŒ–ç±»å‹å¤–ï¼Œè¿˜å°†ä½¿ç”¨å†…éƒ¨ç±»å‹ã€‚Conversion-gen å°†åœ¨è¿™äº›å†…éƒ¨å’Œå¤–éƒ¨ç±»å‹ä¹‹é—´åˆ›å»ºè½¬æ¢å‡½æ•°ã€‚Defaulter-genå°†è´Ÿè´£é»˜è®¤æŸäº›å­—æ®µã€‚\nåœ¨ä½ çš„é¡¹ç›®ä¸­è°ƒç”¨ä»£ç ç”Ÿæˆå™¨ æ‰€æœ‰çš„Kubernetesä»£ç ç”Ÿæˆå™¨éƒ½æ˜¯åœ¨k8s.io/gengoä¹‹ä¸Šå®ç°çš„ã€‚å®ƒä»¬å…±äº«è®¸å¤šå…¬å…±å‘½ä»¤è¡Œæ ‡å¿—ã€‚åŸºæœ¬ä¸Šï¼Œæ‰€æœ‰ç”Ÿæˆå™¨éƒ½è·å¾—è¾“å…¥åŒ…ï¼ˆ--input-dirsï¼‰çš„åˆ—è¡¨ï¼Œå®ƒä»¬é€šè¿‡ç±»å‹è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶è¾“å‡ºç”Ÿæˆçš„ä»£ç ã€‚ç”Ÿæˆçš„ä»£ç ï¼š\n è¦ä¹ˆè¿›å…¥ä¸è¾“å…¥æ–‡ä»¶ç›¸åŒçš„ç›®å½•ï¼Œä¾‹å¦‚deepcopy-gen ï¼ˆ --output-file-base \u0026quot;zz_generated.deepcopy\u0026quot;å®šä¹‰æ–‡ä»¶åï¼‰ æˆ–è€…å®ƒä»¬ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªè¾“å‡ºåŒ…(--output-package)ä¾‹å¦‚ client-, informer- å’Œ lister-gen æ‰€åšçš„ï¼ˆé€šå¸¸å°†ç”Ÿæˆçš„ä»£ç æ”¾åœ¨ pkg/client ç›®å½•ä¸‹ï¼‰  k8s.io/code-generatoré™„å¸¦äº†ä¸€ä¸ªshellè„šæœ¬generator-group.shï¼Œè¿™ä¸ªè„šæœ¬ä¼šå¸®æˆ‘ä»¬å¤„ç†è¿™äº›ç¹é‡çš„å·¥ä½œï¼Œé€šå¸¸åªè¦è°ƒç”¨hack/update-codegen.shå°±è¡Œï¼Œä¾‹å¦‚ï¼š\n$ vendor/k8s.io/code-generator/generate-groups.sh all \\ github.com/openshift-evangelist/crd-code-generation/pkg/client \\ github.com/openshift-evangelist/crd-code-generation/pkg/apis \\ example.com:v1  è¿è¡Œè¿™ä¸ªå‘½ä»¤åç”Ÿæˆçš„ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š\næ‰€æœ‰çš„ APIs éƒ½è¢«åˆ›å»ºåˆ° pkg/apis ç›®å½•ä¸‹ï¼Œclientsetsï¼Œinformers ä»¥åŠ listers è¢«åˆ›å»ºåˆ° pkg/client è¿™ä¸ªç›®å½•ä¸‹ã€‚æ€»è€Œè¨€ä¹‹ï¼Œpkg/client æ–‡ä»¶å¤¹å®Œå…¨éƒ½æ˜¯ç”Ÿæˆçš„ï¼Œå¹¶ä¸”åŒ…æ‹¬zz_generated.deepcopy.goè¿™ä¸ªæ–‡ä»¶ã€‚ä¸¤è€…éƒ½ä¸åº”è¯¥æ‰‹åŠ¨ä¿®æ”¹ï¼Œè€Œæ˜¯é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºï¼š\n$ hack/update-codegen.sh  è¿™ä¸ªè„šæœ¬çš„é™„è¿‘è¿˜æœ‰ä¸€ä¸ª hack/verify-codegen.sh è„šæœ¬ï¼Œå¦‚æœç”Ÿæˆçš„ä»»ä½•æ–‡ä»¶ä¸æ˜¯æœ€æ–°çš„ï¼Œè¯¥è„šæœ¬éƒ½å°†ä»¥éé›¶çš„è¿”å›ç ç»ˆæ­¢ã€‚è¿™å¯¹äºæ”¾å…¥CIè„šæœ¬ä¸­éå¸¸æœ‰å¸®åŠ©ï¼šå¦‚æœå¼€å‘äººå‘˜æ— æ„ä¸­ä¿®æ”¹äº†æ–‡ä»¶ï¼Œæˆ–è€…å¦‚æœæ–‡ä»¶åˆšåˆšè¿‡æ—¶ï¼ŒCIä¼šæ³¨æ„åˆ°å¹¶æŠ¥é”™ã€‚\næ§åˆ¶ç”Ÿæˆçš„ä»£ç â€“æ ‡ç­¾ å¦‚ä¸Šæ‰€è¿°ï¼Œè™½ç„¶ä»£ç ç”Ÿæˆå™¨çš„æŸäº›è¡Œä¸ºæ˜¯é€šè¿‡å‘½ä»¤è¡Œæ ‡å¿—ï¼ˆå°¤å…¶æ˜¯è¦å¤„ç†çš„ç¨‹åºåŒ…ï¼‰æ¥æ§åˆ¶çš„ï¼Œä½†æ›´å¤šçš„å±æ€§æ˜¯é€šè¿‡golangæ–‡ä»¶ä¸­çš„æ ‡ç­¾æ¥æ§åˆ¶çš„ã€‚\næ ‡ç­¾æœ‰ä¸¤ç§ï¼š\n Global tags ç›¸å…³çš„åœ¨packageç›®å½•ä¸‹çš„doc.goæ–‡ä»¶ä¸­ Local tags åœ¨å®ƒéœ€è¦å¤„ç†çš„ç±»å‹ä¸­å®šä¹‰  æ ‡ç­¾é€šå¸¸æ˜¯ // +tag-name æˆ–è€… // +tag-name=value è¿™ä¸¤ç§å½¢å¼ï¼Œå†™åœ¨æ³¨é‡Šä¸­ã€‚æ ¹æ®æ ‡ç­¾ï¼Œæ³¨é‡Šçš„ä½ç½®å˜å¾—å¾ˆé‡è¦ã€‚å¤§éƒ¨åˆ†çš„æ³¨é‡Šçš„æ ‡ç­¾åº”è¯¥ç›´æ¥æ ‡æ³¨åœ¨ç±»å‹ä¸Šï¼ˆå¯¹äºå…¨å±€æ ‡ç­¾æ¥è¯´åº”è¯¥åœ¨packageè¡Œä¸­ï¼‰ï¼Œå…¶ä»–çš„å¿…é¡»ä¸ç±»å‹åˆ†å¼€ï¼Œä¸­é—´è‡³å°‘è¦æœ‰ä¸€æ¡ç©ºçº¿ã€‚\nGLOBAL TAGS Global tags è¢«å†™å…¥åˆ°åŒ…çš„ doc.go æ–‡ä»¶ä¸­ï¼Œä¸€ä¸ªå…¸å‹çš„pkg/apis/\u0026lt;apigroup\u0026gt;/\u0026lt;version\u0026gt;/doc.goæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š\n// +k8s:deepcopy-gen=package,register // Package v1 is the v1 version of the API. // +groupName=example.com package v1  å®ƒå‘Šè¯‰deepcopy-gené»˜è®¤ä¸ºè¯¥åŒ…ä¸­çš„æ¯ç§ç±»å‹åˆ›å»ºDeepcopyæ–¹æ³•ã€‚å¦‚æœä½ çš„ç±»å‹ä¸­ä¸éœ€è¦ç”Ÿæˆdeepcopyæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨local tagæ¥å…³é—­// +k8s:deepcopy-gen=falseã€‚å¦‚æœä½ ä¸åœ¨åŒ…çš„å£°æ˜ä¸­ä½¿ç”¨ç”Ÿæˆ deepcopy æ–¹æ³•ï¼Œå°±éœ€è¦é€šè¿‡åœ¨æ¯ä¸ªç±»å‹çš„æ³¨é‡Šä¸­å®šä¹‰ // +k8s:deepcopy-gen=falseã€‚\n æ³¨æ„ï¼šä¸Šä¾‹ä¸­çš„å€¼ä¸­çš„ register å…³é”®å­—å°†ä½¿deepcopyæ–¹æ³•æ³¨å†Œåˆ°è¯¥schemeä¸­ã€‚åœ¨Kubernetes 1.9ä¸­è¢«å–æ¶ˆäº†ï¼Œå› ä¸ºè¯¥schemeå°†ä¸å†è´Ÿè´£æ‰§è¡Œruntime.Objectsçš„æ·±å±‚å¤åˆ¶ã€‚å–è€Œä»£ä¹‹çš„æ˜¯è°ƒç”¨ yourobject.DeepCopy() æˆ–è€… yourobject.DeepCopyObject()ã€‚\nSchemeå®šä¹‰äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–APIå¯¹è±¡çš„æ–¹æ³•ï¼Œç”¨äºå°†groupã€ç‰ˆæœ¬å’Œç±»å‹ä¿¡æ¯è½¬æ¢ä¸ºGoæ¨¡å¼å’Œä»Goæ¨¡å¼è½¬æ¢ä¸ºGoæ¨¡å¼çš„ç±»å‹æ³¨å†Œè¡¨ï¼Œä»¥åŠä¸åŒç‰ˆæœ¬çš„Goæ¨¡å¼ä¹‹é—´çš„æ˜ å°„ã€‚\n æœ€åï¼Œ// +groupName=example.com å®šä¹‰äº†API ç»„çš„å…¨é™å®šåç§°ã€‚å¦‚æœä½ å†™é”™äº†è¿™ä¸ªåç§°ï¼Œclient-gen ä¼šç”Ÿæˆé”™è¯¯çš„ä»£ç ã€‚å¦å¤–è¿™ä¸ªæ ‡ç­¾å¿…é¡»åœ¨åŒ…ä¸Šçš„æ³¨é‡Šå—ä¸­ã€‚\nLACAL TAGS æœ¬åœ°æ ‡è®°è¦ä¹ˆç›´æ¥å†™åœ¨APIç±»å‹ä¸Šæ–¹ï¼Œè¦ä¹ˆå†™åœ¨å®ƒä¸Šæ–¹çš„ç¬¬äºŒä¸ªæ³¨é‡Šå—ä¸­ã€‚å¦‚ä¸‹çš„ types.go æ–‡ä»¶æ‰€ç¤ºï¼š\n// +genclient // +genclient:noStatus // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object // Database describes a database. type Database struct { metav1.TypeMeta `json:\u0026quot;,inline\u0026quot;` metav1.ObjectMeta `json:\u0026quot;metadata,omitempty\u0026quot;` Spec DatabaseSpec `json:\u0026quot;spec\u0026quot;` } // DatabaseSpec is the spec for a Foo resource type DatabaseSpec struct { User string `json:\u0026quot;user\u0026quot;` Password string `json:\u0026quot;password\u0026quot;` Encoding string `json:\u0026quot;encoding,omitempty\u0026quot;` } // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object // DatabaseList is a list of Database resources type DatabaseList struct { metav1.TypeMeta `json:\u0026quot;,inline\u0026quot;` metav1.ListMeta `json:\u0026quot;metadata\u0026quot;` Items []Database `json:\u0026quot;items\u0026quot;` }  è¯·æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ºæ‰€æœ‰ç±»å‹å¯ç”¨äº†deepcopyï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥é€‰æ‹©ä¸ä½¿ç”¨ deepcopyã€‚ä½†æ˜¯ï¼Œè¿™äº›ç±»å‹éƒ½æ˜¯APIç±»å‹ï¼Œéœ€è¦æ·±åº¦å¤åˆ¶ã€‚å› æ­¤ï¼Œåœ¨æ­¤ç¤ºä¾‹types.goä¸­ï¼Œæˆ‘ä»¬ä¸å¿…æ‰“å¼€æˆ–å…³é—­deepcopyï¼Œè€Œä»…åœ¨doc.goä¸­çš„ç¨‹åºåŒ…èŒƒå›´å†…å³å¯ã€‚\nruntime.Object and DeepCopyObject æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ deepcopy æ ‡ç­¾ï¼Œéœ€è¦æ›´å¤šè¯´æ˜ï¼š\n// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object  å¦‚æœæ‚¨å°è¯•å°†CustomResourcesä¸åŸºäºKubernetes 1.8çš„å®¢æˆ·ç«¯ä¸€èµ·ä½¿ç”¨ï¼Œæœ‰äº›äººå¯èƒ½å·²ç»å¾ˆé«˜å…´ï¼Œå› ä¸ºä»–ä»¬ä¸å°å¿ƒå‡ºå”®äº†masteråˆ†æ”¯çš„k8s.op/apimachineryï¼Œæ‚¨é‡åˆ°äº†ç”±äºCustomResourceç±»å‹æœªå®ç°runtime.Objectè€Œå¯¼è‡´çš„ç¼–è¯‘å™¨é”™è¯¯ï¼Œå› ä¸ºæœªåœ¨æ‚¨çš„ç±»å‹ä¸Šå®šä¹‰DeepCopyObjectï¼ˆï¼‰runtime.Objectã€‚åŸå› æ˜¯åœ¨1.8ä¸­ï¼Œruntime.Objectæ¥å£ä½¿ç”¨æ­¤æ–¹æ³•ç­¾åè¿›è¡Œäº†æ‰©å±•ï¼Œå› æ­¤æ¯ä¸ªruntime.Objectéƒ½å¿…é¡»å®ç°DeepCopyObjectã€‚ DeepCopyObjectï¼ˆï¼‰runtime.Objectçš„å®ç°å¾ˆç®€å•ï¼š\nfunc (in *T) DeepCopyObject() runtime.Object { if c := in.DeepCopy(); c != nil { return c } else { return nil } }  ä½†å¹¸è¿çš„æ˜¯ï¼Œæ‚¨ä¸å¿…ä¸ºæ¯ç§ç±»å‹éƒ½å®ç°æ­¤åŠŸèƒ½ï¼Œè€Œåªéœ€å°†ä»¥ä¸‹æœ¬åœ°æ ‡è®°æ”¾åœ¨é¡¶çº§APIç±»å‹çš„ä¸Šæ–¹ï¼š\n// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object  åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼ŒDatabase å’ŒDatabaseListéƒ½æ˜¯é¡¶çº§ç±»å‹ï¼Œå› ä¸ºå®ƒä»¬è¢«ç”¨ä½œruntime.Objectsã€‚æ ¹æ®ç»éªŒï¼Œé¡¶çº§ç±»å‹æ˜¯é‚£äº›åµŒå…¥äº†metav1.TypeMetaçš„ç±»å‹ã€‚åŒæ ·ï¼Œè¿™äº›æ˜¯å®¢æˆ·ç«¯ä½¿ç”¨client-genåˆ›å»ºçš„ç±»å‹ã€‚\nè¯·æ³¨æ„ï¼Œ// + k8sï¼šdeepcopy-genï¼šinterfaces æ ‡è®°å¯ä»¥å¹¶ä¸”ä¹Ÿåº”è¯¥åœ¨å®šä¹‰å…·æœ‰æŸäº›æ¥å£ç±»å‹çš„å­—æ®µï¼ˆä¾‹å¦‚ï¼Œfield SomeInterfaceï¼‰çš„APIç±»å‹çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚ç„¶å// + k8sï¼šdeepcopy-genï¼šinterfaces=example.com/pkg/apis/example.SomeInterfaceå°†å¯¼è‡´DeepeepSomeInterfaceï¼ˆï¼‰SomeInterfaceæ–¹æ³•çš„ç”Ÿæˆã€‚è¿™å…è®¸å®ƒä»¥ç±»å‹æ­£ç¡®çš„æ–¹å¼å¯¹è¿™äº›å­—æ®µè¿›è¡Œæ·±åº¦å¤åˆ¶ã€‚\nClient-gen æ ‡ç­¾ æœ€åï¼Œæœ‰è®¸å¤šæ ‡è®°å¯æ§åˆ¶client-genï¼Œåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°å…¶ä¸­ä¸¤ä¸ªï¼š\n// +genclient // +genclient:noStatus  ç¬¬ä¸€ä¸ªæ ‡è®°å‘Šè¯‰client-genä¸ºè¯¥ç±»å‹åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆå§‹ç»ˆå¯ç”¨ï¼‰ã€‚è¯·æ³¨æ„ï¼Œæ‚¨ä¸å¿…å°†å…¶æ”¾åœ¨APIå¯¹è±¡çš„åˆ—è¡¨ç±»å‹ä¸Šæ–¹ã€‚\nç¬¬äºŒä¸ªæ ‡è®°å‘Šè¯‰client-genè¯¥ç±»å‹æœªé€šè¿‡/statuså­èµ„æºä½¿ç”¨è§„èŒƒçŠ¶æ€åˆ†éš”ã€‚ç”Ÿæˆçš„å®¢æˆ·ç«¯å°†æ²¡æœ‰UpdateStatusæ–¹æ³•ï¼ˆclient-genä¸€æ—¦åœ¨æ‚¨çš„ç»“æ„ä¸­æ‰¾åˆ°Statuså­—æ®µï¼Œå°±ä¼šç›²ç›®ç”Ÿæˆè¯¥æ–¹æ³•ï¼‰ã€‚ /statuså­èµ„æºä»…åœ¨1.8ä¸­æ‰é€‚ç”¨äºæœ¬åœ°ï¼ˆåœ¨golangä¸­ï¼‰å®ç°çš„èµ„æºã€‚ä½†æ˜¯ï¼Œéšç€PR 913ä¸­ä¸ºCustomResourcesè®¨è®ºå­èµ„æºï¼Œè¿™ç§æƒ…å†µå¯èƒ½å¾ˆå¿«å°±ä¼šæ”¹å˜ã€‚\nå¯¹äºç¾¤é›†èŒƒå›´çš„èµ„æºï¼Œå¿…é¡»ä½¿ç”¨æ ‡ç­¾ï¼š\n// +genclient:nonNamespaced  å¯¹äºç‰¹æ®Šç”¨é€”çš„å®¢æˆ·ç«¯ï¼Œæ‚¨å¯èƒ½è¿˜å¸Œæœ›è¯¦ç»†æ§åˆ¶å®¢æˆ·ç«¯æä¾›å“ªäº›HTTPæ–¹æ³•ã€‚å¯ä»¥ä½¿ç”¨å‡ ä¸ªæ ‡ç­¾æ¥å®Œæˆæ­¤æ“ä½œï¼Œä¾‹å¦‚ï¼š\n// +genclient:noVerbs // +genclient:onlyVerbs=create,delete // +genclient:skipVerbs=get,list,create,update,patch,delete,deleteCollection,watch // +genclient:method=Create,verb=create,result=k8s.io/apimachinery/pkg/apis/meta/v1.Status  å‰ä¸‰ä¸ªåº”è¯¥æ˜¯ä¸è¨€è‡ªæ˜çš„ï¼Œä½†æ˜¯æœ€åä¸€ä¸ªéœ€è¦ä¸€äº›è§£é‡Šã€‚ä¸Šé¢å†™å…¥æ­¤æ ‡è®°çš„ç±»å‹å°†æ˜¯ä»…åˆ›å»ºçš„ï¼Œå¹¶ä¸”ä¸ä¼šè¿”å›APIç±»å‹æœ¬èº«ï¼Œè€Œæ˜¯metav1.Statusã€‚å¯¹äºCustomResourcesæ¥è¯´ï¼Œè¿™æ²¡æœ‰å¤šå¤§æ„ä¹‰ï¼Œä½†æ˜¯å¯¹äºç”¨golangç¼–å†™çš„ç”¨æˆ·æä¾›çš„APIæœåŠ¡å™¨ï¼Œè¿™äº›èµ„æºå¯ä»¥å­˜åœ¨ï¼Œå¹¶ä¸”å®é™…ä¸Šå¯ä»¥åœ¨OpenShift APIä¸­ä½¿ç”¨ã€‚\nä½¿ç”¨ç±»å‹å®¢æˆ·ç«¯çš„ä¸»è¦åŠŸèƒ½ å°½ç®¡å¤§å¤šæ•°åŸºäºKubernetes 1.7å’Œæ›´æ—©ç‰ˆæœ¬çš„ç¤ºä¾‹éƒ½ä½¿ç”¨äº†Client-go dynamic client ä½œä¸ºCustomResourcesï¼Œä½†åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…ï¼Œæœ¬åœ°Kubernetes APIç±»å‹çš„ç±»å‹åŒ–å®¢æˆ·ç«¯éƒ½æ›´åŠ æ–¹ä¾¿ã€‚åœ¨1.8ç‰ˆä¸­è¿›è¡Œäº†æ›´æ”¹ï¼šå¦‚ä¸Šæ‰€è¿°ï¼Œclient-genè¿˜ä¸ºæ‚¨çš„è‡ªå®šä¹‰ç±»å‹åˆ›å»ºäº†nativeï¼ŒåŠŸèƒ½é½å…¨ä¸”æ˜“äºä½¿ç”¨çš„ç±»å‹åŒ–å®¢æˆ·ç«¯ã€‚å®é™…ä¸Šï¼Œclient-genä¸çŸ¥é“æ‚¨æ˜¯å°†å…¶åº”ç”¨äºCustomResourceç±»å‹è¿˜æ˜¯nativeç±»å‹ã€‚ å› æ­¤ï¼Œä½¿ç”¨æ­¤å®¢æˆ·ç«¯ä¸ä½¿ç”¨å®¢æˆ·ç«¯Goberå®¢æˆ·ç«¯å®Œå…¨ç­‰æ•ˆã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç¤ºä¾‹ï¼š\nimport ( ... metav1 \u0026quot;k8s.io/apimachinery/pkg/apis/meta/v1\u0026quot; \u0026quot;k8s.io/client-go/tools/clientcmd\u0026quot; examplecomclientset \u0026quot;github.com/openshift-evangelist/crd-code-generation/pkg/client/clientset/versioned\u0026quot; ) var ( kuberconfig = flag.String(\u0026quot;kubeconfig\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;Path to a kubeconfig. Only required if out-of-cluster.\u0026quot;) master = flag.String(\u0026quot;master\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;The address of the Kubernetes API server. Overrides any value in kubeconfig. Only required if out-of-cluster.\u0026quot;) ) func main() { flag.Parse() cfg, err := clientcmd.BuildConfigFromFlags(*master, *kuberconfig) if err != nil { glog.Fatalf(\u0026quot;Error building kubeconfig: %v\u0026quot;, err) } exampleClient, err := examplecomclientset.NewForConfig(cfg) if err != nil { glog.Fatalf(\u0026quot;Error building example clientset: %v\u0026quot;, err) } list, err := exampleClient.ExampleV1().Databases(\u0026quot;default\u0026quot;).List(metav1.ListOpti ons{}) if err != nil { glog.Fatalf(\u0026quot;Error listing all databases: %v\u0026quot;, err) } for _, db := range list.Items { fmt.Printf(\u0026quot;database %s with user %q\\n\u0026quot;, db.Name, db.Spec.User) } }  å®ƒä¸kubeconfigæ–‡ä»¶ä¸€èµ·ä½¿ç”¨ï¼Œå®é™…ä¸Šå¯ä»¥ä¸kubectlå’ŒKuberneteså®¢æˆ·ç«¯ä¸€èµ·ä½¿ç”¨ã€‚\nä¸åŠ¨æ€å®¢æˆ·ç«¯ä½¿ç”¨çš„æ—§ç‰ˆTPRæˆ–CustomResourceä»£ç ç›¸æ¯”ï¼Œæ‚¨æ— éœ€è¿›è¡Œç±»å‹è½¬æ¢ã€‚ç›¸åï¼Œå®é™…çš„å®¢æˆ·ç«¯è°ƒç”¨çœ‹èµ·æ¥å®Œå…¨æ˜¯æœ¬åœ°çš„ï¼Œå®ƒæ˜¯ï¼š\nlist, err := exampleClient.ExampleV1().Databases(\u0026quot;default\u0026quot;).List(metav1.ListOptions{})  åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œç»“æœæ˜¯ç¾¤é›†ä¸­æ‰€æœ‰æ•°æ®åº“çš„DatabaseListã€‚å¦‚æœæ‚¨å°†ç±»å‹åˆ‡æ¢ä¸ºé›†ç¾¤èŒƒå›´ï¼ˆå³æ²¡æœ‰å‘½åç©ºé—´ï¼›è¯·ä¸è¦å¿˜è®°ä½¿ç”¨// + genclientnonNamespacedæ ‡è®°å‘Šè¯‰client-genï¼ï¼‰ï¼Œè°ƒç”¨å°†å˜æˆ\nlist, err := exampleClient.ExampleV1().Databases().List(metav1.ListOptions{})  ä»¥ç¼–ç¨‹æ–¹å¼åœ¨GOLANGåˆ›å»ºè‡ªå®šä¹‰èµ„æº ç”±äºè¿™ä¸ªé—®é¢˜ç»å¸¸å‡ºç°ï¼Œå› æ­¤è¯·æ‚¨è°ˆè°ˆå¦‚ä½•ä»æ‚¨çš„golangä»£ç ä¸­ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»ºCRDçš„å‡ å¥è¯ã€‚\nå®¢æˆ·ä»£æ€»æ˜¯åˆ›å»ºæ‰€è°“çš„clinetsetsã€‚å®¢æˆ·ç«¯é›†å°†ä¸€ä¸ªæˆ–å¤šä¸ªAPIç»„æ†ç»‘åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯ä¸­ã€‚é€šå¸¸ï¼Œè¿™äº›APIç»„æ¥è‡ªä¸€ä¸ªå­˜å‚¨åº“ï¼Œå¹¶ä½äºä¸€ä¸ªåŸºæœ¬ç¨‹åºåŒ…ä¸­ï¼Œä¾‹å¦‚ï¼Œå¦‚æœ¬åšæ–‡ç¤ºä¾‹ä¸­çš„pkg/apisï¼›å¯¹äºKubernetesï¼Œåˆ™æ¥è‡ªk8s.io/apiã€‚\nCustomResourceDefinitionsç”± kubernetes/apiextensions-apiserverå­˜å‚¨åº“ã€‚è¯¥APIæœåŠ¡å™¨ï¼ˆä¹Ÿå¯ä»¥ç‹¬ç«‹å¯åŠ¨ï¼‰æ˜¯ç”±kube-apiserveråµŒå…¥çš„ï¼Œå› æ­¤CRDåœ¨æ¯ä¸ªKubernetesç¾¤é›†ä¸Šéƒ½å¯ç”¨ã€‚ä½†æ˜¯åˆ›å»ºCRDçš„å®¢æˆ·ç«¯ä¼šåˆ›å»ºåˆ°apiextensions-apiserverå­˜å‚¨åº“ä¸­ï¼Œå½“ç„¶ä¹Ÿè¦ä½¿ç”¨client-genã€‚é˜…è¯»æ­¤åšå®¢åï¼Œæ‚¨å¯ä»¥åœ¨kubernetes/apiextensions-apiserver/tree/master/pkg/clientä¸Šæ‰¾åˆ°å®¢æˆ·ç«¯ä¹Ÿä¸ä¼šæ„Ÿåˆ°æƒŠè®¶ï¼Œåˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹ä»¥åŠå¦‚ä½•åˆ›å»ºCRDçœ‹èµ·æ¥ä¹Ÿä¸å¥‡æ€ªï¼š\nimport ( ... apiextensionsclientset \u0026quot;k8s.io/apiextensions-apiserver/pkg/client/clientset/clientsetâ€ ) apiextensionsClient, err := apiextensionsclientset.NewForConfig(cfg) ... createdCRD, err := apiextensionsClient.ApiextensionsV1beta1().CustomResourceDefinitions().Create(yourCRD)  è¯·æ³¨æ„ï¼Œåˆ›å»ºå®Œæˆåï¼Œæ‚¨å°†å¿…é¡»ç­‰å¾…åœ¨æ–°CRDä¸Šè®¾ç½®â€œå·²å»ºç«‹â€æ¡ä»¶ã€‚åªæœ‰è¿™æ ·ï¼Œkube-apiserveræ‰ä¼šå¼€å§‹æä¾›èµ„æºã€‚å¦‚æœæ‚¨ä¸ç­‰å¾…è¯¥æ¡ä»¶ï¼Œåˆ™æ¯æ¬¡CRæ“ä½œéƒ½ä¼šè¿”å›404 HTTPçŠ¶æ€ä»£ç ã€‚\n","date":"2021å¹´03æœˆ12æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/code-generation-for-customresources/","summary":"\u003cblockquote\u003e\n\u003cp\u003eåŸæ–‡é“¾æ¥ï¼š\u003ca href=\"https://www.openshift.com/blog/kubernetes-deep-dive-code-generation-customresources\"\u003eKubernetes Deep Dive: Code Generation for CustomResources\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e","title":"[è¯‘]Kubernetesæ·±å…¥ç ”ç©¶ï¼šCustomResourcesçš„ä»£ç ç”Ÿæˆ"},{"contents":" åŸæ–‡é“¾æ¥ï¼šKubernetes Deep Dive: Code Generation for CustomResources\n CustomResourceDefinitions (CRDs)æ˜¯kubernetes 1.7 ä¸­å¼•å…¥çš„ï¼Œå¹¶åœ¨1.8ä¸­ä»alphaç‰ˆæœ¬å‡çº§ä¸ºbetaç‰ˆæœ¬äº†ï¼Œæœ€æ–°ç‰ˆæœ¬çš„kubernetes 1.20 ä¸­ï¼ŒCRDsçš„ç‰ˆæœ¬å·²ç»æ˜¯v1äº†ã€‚ç”±äºCRDsçš„æ˜“ç”¨æ€§ï¼Œåœ¨å¾ˆå¤šå®ç°äº†æ§åˆ¶å™¨æ¨¡å¼çš„ä¾‹å­ä¸­éƒ½å¯ä»¥çœ‹åˆ°å®ƒçš„èº«å½±ã€‚\nåœ¨Kubernetes 1.8ä¸­ï¼Œ CRDs åœ¨åŸºäºgolangçš„é¡¹ç›®ä¸­çš„ä½¿ç”¨ä¹Ÿå˜å¾—æ›´åŠ è‡ªç„¶ï¼šé€šè¿‡ç”¨æˆ·æä¾›çš„ CustomResourcesï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨åœ¨Kubernetesæä¾›çš„ä»£ç ç”Ÿæˆå·¥å…·æ¥ç”Ÿæˆä»£ç ã€‚è¿™ç¯‡æ–‡ç« å±•ç¤ºäº†ä»£ç ç”Ÿæˆå™¨çš„å·¥ä½œæ–¹å¼ï¼Œä»¥åŠå¦‚ä½•ä»¥æœ€å°‘çš„ä»£ç è¡Œå°†å…¶åº”ç”¨åˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œä¸ºæ‚¨æä¾›äº†ç”Ÿæˆçš„Deepcopyå‡½æ•°ï¼Œå†…ç½®çš„clientsï¼Œlisterså’Œinformersï¼Œæ‰€æœ‰è¿™äº›éƒ½å¸¦æœ‰ä¸€ä¸ªShellè„šæœ¬è°ƒç”¨å’Œå‡ ä¸ªä»£ç æ³¨é‡Šã€‚\n æ³¨ï¼šdeepcopyï¼Œæ„ä¸ºâ€æ·±æ‹·è´â€œï¼Œæ·±æ‹·è´æ„å‘³ç€ä¼šé‡æ–°ç”Ÿæˆå¯¹è±¡å¹¶æ‹·è´å¯¹è±¡ä¸­çš„æ‰€æœ‰å­—æ®µã€åœ°å€ç­‰æ•°æ®ï¼›æµ…æ‹·è´ä»…ä»…æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶æ²¡æœ‰ç”Ÿæˆæ–°çš„å¯¹è±¡ã€‚\n ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä»£ç ç”Ÿæˆï¼Ÿ é‚£äº›åœ¨golangä¸­åŸç”Ÿä½¿ç”¨ThirdPartyResourcesæˆ–CustomResourceDefinitionçš„äººå¯èƒ½ä¼šæƒŠè®¶äºçªç„¶åœ¨Kubernetes 1.8ä¸­éœ€è¦ç”Ÿæˆclient-goã€‚æ›´å…·ä½“åœ°è¯´ï¼Œclient-goè¦æ±‚ runtime.Object ç±»å‹ï¼ˆgolangä¸­çš„CustomResourceså¿…é¡»å®ç°runtime.Objectæ¥å£ï¼‰å¿…é¡»å…·æœ‰DeepCopyæ–¹æ³•ã€‚è¿™é‡Œçš„ä»£ç ç”Ÿæˆé€šè¿‡deepcopy-genç”Ÿæˆå™¨èµ·ä½œç”¨ï¼Œå¯ä»¥åœ¨k8s.io/code-generatorå­˜å‚¨åº“ä¸­æ‰¾åˆ°ã€‚\né™¤äº†deepcopy-gen ç”Ÿæˆå™¨å¤–ï¼Œè¿˜æœ‰å‡ ä¸ªä»£ç ç”Ÿæˆå™¨æ˜¯å¤§å¤šæ•°CustomResourcesç”¨æˆ·éƒ½æƒ³ä½¿ç”¨çš„ï¼š\n deepcopy-gen - ä¸ºæ¯ä¸ªTç±»å‹çš„æ–¹æ³•åˆ›å»ºfunc (t* T) DeepCopy() *T å‡½æ•° client-gen - ä¸º CustomResource APIGroups åˆ›å»ºå†…ç½®çš„å®¢æˆ·ç«¯é›† informer-gen - ä¸ºCustomResourcesåˆ›å»ºinformerï¼Œè¯¥informeræä¾›åŸºäºäº‹ä»¶çš„ç•Œé¢ä»¥å¯¹æœåŠ¡å™¨ä¸ŠCustomResourcesçš„æ›´æ”¹åšå‡ºååº” lister-gen - ä¸ºCustomResourcesåˆ›å»ºlistersï¼Œè¯¥listersä¸ºGETå’ŒLISTè¯·æ±‚æä¾›åªè¯»ç¼“å­˜å±‚ã€‚  æœ€åä¸¤ä¸ªæ˜¯æ„å»ºæ§åˆ¶å™¨ï¼ˆæˆ–Operatorsï¼‰çš„åŸºç¡€ã€‚åœ¨åç»­åšå®¢ä¸­ï¼Œæˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°ä»‹ç»æ§åˆ¶å™¨ã€‚è¿™å››ä¸ªä»£ç ç”Ÿæˆå™¨ä½¿ç”¨ä¸Kubernetesä¸Šæ¸¸æ§åˆ¶å™¨æ‰€ä½¿ç”¨çš„ç›¸åŒçš„æœºåˆ¶å’Œè½¯ä»¶åŒ…ï¼Œæ„æˆäº†æ„å»ºåŠŸèƒ½é½å…¨ï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒçš„æ§åˆ¶å™¨çš„å¼ºå¤§åŸºç¡€ã€‚\nk8s.io/code-generator ä¸­è¿˜æœ‰å…¶ä»–ç”¨äºå…¶ä»–ä¸Šä¸‹æ–‡çš„ç”Ÿæˆå™¨ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ„å»ºè‡ªå·±çš„èšåˆAPIæœåŠ¡å™¨ï¼Œåˆ™é™¤äº†ç‰ˆæœ¬åŒ–ç±»å‹å¤–ï¼Œè¿˜å°†ä½¿ç”¨å†…éƒ¨ç±»å‹ã€‚Conversion-gen å°†åœ¨è¿™äº›å†…éƒ¨å’Œå¤–éƒ¨ç±»å‹ä¹‹é—´åˆ›å»ºè½¬æ¢å‡½æ•°ã€‚Defaulter-genå°†è´Ÿè´£é»˜è®¤æŸäº›å­—æ®µã€‚\nåœ¨ä½ çš„é¡¹ç›®ä¸­è°ƒç”¨ä»£ç ç”Ÿæˆå™¨ æ‰€æœ‰çš„Kubernetesä»£ç ç”Ÿæˆå™¨éƒ½æ˜¯åœ¨k8s.io/gengoä¹‹ä¸Šå®ç°çš„ã€‚å®ƒä»¬å…±äº«è®¸å¤šå…¬å…±å‘½ä»¤è¡Œæ ‡å¿—ã€‚åŸºæœ¬ä¸Šï¼Œæ‰€æœ‰ç”Ÿæˆå™¨éƒ½è·å¾—è¾“å…¥åŒ…ï¼ˆ--input-dirsï¼‰çš„åˆ—è¡¨ï¼Œå®ƒä»¬é€šè¿‡ç±»å‹è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶è¾“å‡ºç”Ÿæˆçš„ä»£ç ã€‚ç”Ÿæˆçš„ä»£ç ï¼š\n è¦ä¹ˆè¿›å…¥ä¸è¾“å…¥æ–‡ä»¶ç›¸åŒçš„ç›®å½•ï¼Œä¾‹å¦‚deepcopy-gen ï¼ˆ --output-file-base \u0026quot;zz_generated.deepcopy\u0026quot;å®šä¹‰æ–‡ä»¶åï¼‰ æˆ–è€…å®ƒä»¬ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªè¾“å‡ºåŒ…(--output-package)ä¾‹å¦‚ client-, informer- å’Œ lister-gen æ‰€åšçš„ï¼ˆé€šå¸¸å°†ç”Ÿæˆçš„ä»£ç æ”¾åœ¨ pkg/client ç›®å½•ä¸‹ï¼‰  k8s.io/code-generatoré™„å¸¦äº†ä¸€ä¸ªshellè„šæœ¬generator-group.shï¼Œè¿™ä¸ªè„šæœ¬ä¼šå¸®æˆ‘ä»¬å¤„ç†è¿™äº›ç¹é‡çš„å·¥ä½œï¼Œé€šå¸¸åªè¦è°ƒç”¨hack/update-codegen.shå°±è¡Œï¼Œä¾‹å¦‚ï¼š\n$ vendor/k8s.io/code-generator/generate-groups.sh all \\ github.com/openshift-evangelist/crd-code-generation/pkg/client \\ github.com/openshift-evangelist/crd-code-generation/pkg/apis \\ example.com:v1  è¿è¡Œè¿™ä¸ªå‘½ä»¤åç”Ÿæˆçš„ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š\næ‰€æœ‰çš„ APIs éƒ½è¢«åˆ›å»ºåˆ° pkg/apis ç›®å½•ä¸‹ï¼Œclientsetsï¼Œinformers ä»¥åŠ listers è¢«åˆ›å»ºåˆ° pkg/client è¿™ä¸ªç›®å½•ä¸‹ã€‚æ€»è€Œè¨€ä¹‹ï¼Œpkg/client æ–‡ä»¶å¤¹å®Œå…¨éƒ½æ˜¯ç”Ÿæˆçš„ï¼Œå¹¶ä¸”åŒ…æ‹¬zz_generated.deepcopy.goè¿™ä¸ªæ–‡ä»¶ã€‚ä¸¤è€…éƒ½ä¸åº”è¯¥æ‰‹åŠ¨ä¿®æ”¹ï¼Œè€Œæ˜¯é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºï¼š\n$ hack/update-codegen.sh  è¿™ä¸ªè„šæœ¬çš„é™„è¿‘è¿˜æœ‰ä¸€ä¸ª hack/verify-codegen.sh è„šæœ¬ï¼Œå¦‚æœç”Ÿæˆçš„ä»»ä½•æ–‡ä»¶ä¸æ˜¯æœ€æ–°çš„ï¼Œè¯¥è„šæœ¬éƒ½å°†ä»¥éé›¶çš„è¿”å›ç ç»ˆæ­¢ã€‚è¿™å¯¹äºæ”¾å…¥CIè„šæœ¬ä¸­éå¸¸æœ‰å¸®åŠ©ï¼šå¦‚æœå¼€å‘äººå‘˜æ— æ„ä¸­ä¿®æ”¹äº†æ–‡ä»¶ï¼Œæˆ–è€…å¦‚æœæ–‡ä»¶åˆšåˆšè¿‡æ—¶ï¼ŒCIä¼šæ³¨æ„åˆ°å¹¶æŠ¥é”™ã€‚\næ§åˆ¶ç”Ÿæˆçš„ä»£ç â€“æ ‡ç­¾ å¦‚ä¸Šæ‰€è¿°ï¼Œè™½ç„¶ä»£ç ç”Ÿæˆå™¨çš„æŸäº›è¡Œä¸ºæ˜¯é€šè¿‡å‘½ä»¤è¡Œæ ‡å¿—ï¼ˆå°¤å…¶æ˜¯è¦å¤„ç†çš„ç¨‹åºåŒ…ï¼‰æ¥æ§åˆ¶çš„ï¼Œä½†æ›´å¤šçš„å±æ€§æ˜¯é€šè¿‡golangæ–‡ä»¶ä¸­çš„æ ‡ç­¾æ¥æ§åˆ¶çš„ã€‚\næ ‡ç­¾æœ‰ä¸¤ç§ï¼š\n Global tags ç›¸å…³çš„åœ¨packageç›®å½•ä¸‹çš„doc.goæ–‡ä»¶ä¸­ Local tags åœ¨å®ƒéœ€è¦å¤„ç†çš„ç±»å‹ä¸­å®šä¹‰  æ ‡ç­¾é€šå¸¸æ˜¯ // +tag-name æˆ–è€… // +tag-name=value è¿™ä¸¤ç§å½¢å¼ï¼Œå†™åœ¨æ³¨é‡Šä¸­ã€‚æ ¹æ®æ ‡ç­¾ï¼Œæ³¨é‡Šçš„ä½ç½®å˜å¾—å¾ˆé‡è¦ã€‚å¤§éƒ¨åˆ†çš„æ³¨é‡Šçš„æ ‡ç­¾åº”è¯¥ç›´æ¥æ ‡æ³¨åœ¨ç±»å‹ä¸Šï¼ˆå¯¹äºå…¨å±€æ ‡ç­¾æ¥è¯´åº”è¯¥åœ¨packageè¡Œä¸­ï¼‰ï¼Œå…¶ä»–çš„å¿…é¡»ä¸ç±»å‹åˆ†å¼€ï¼Œä¸­é—´è‡³å°‘è¦æœ‰ä¸€æ¡ç©ºçº¿ã€‚\nGLOBAL TAGS Global tags è¢«å†™å…¥åˆ°åŒ…çš„ doc.go æ–‡ä»¶ä¸­ï¼Œä¸€ä¸ªå…¸å‹çš„pkg/apis/\u0026lt;apigroup\u0026gt;/\u0026lt;version\u0026gt;/doc.goæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š\n// +k8s:deepcopy-gen=package,register // Package v1 is the v1 version of the API. // +groupName=example.com package v1  å®ƒå‘Šè¯‰deepcopy-gené»˜è®¤ä¸ºè¯¥åŒ…ä¸­çš„æ¯ç§ç±»å‹åˆ›å»ºDeepcopyæ–¹æ³•ã€‚å¦‚æœä½ çš„ç±»å‹ä¸­ä¸éœ€è¦ç”Ÿæˆdeepcopyæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨local tagæ¥å…³é—­// +k8s:deepcopy-gen=falseã€‚å¦‚æœä½ ä¸åœ¨åŒ…çš„å£°æ˜ä¸­ä½¿ç”¨ç”Ÿæˆ deepcopy æ–¹æ³•ï¼Œå°±éœ€è¦é€šè¿‡åœ¨æ¯ä¸ªç±»å‹çš„æ³¨é‡Šä¸­å®šä¹‰ // +k8s:deepcopy-gen=falseã€‚\n æ³¨æ„ï¼šä¸Šä¾‹ä¸­çš„å€¼ä¸­çš„ register å…³é”®å­—å°†ä½¿deepcopyæ–¹æ³•æ³¨å†Œåˆ°è¯¥schemeä¸­ã€‚åœ¨Kubernetes 1.9ä¸­è¢«å–æ¶ˆäº†ï¼Œå› ä¸ºè¯¥schemeå°†ä¸å†è´Ÿè´£æ‰§è¡Œruntime.Objectsçš„æ·±å±‚å¤åˆ¶ã€‚å–è€Œä»£ä¹‹çš„æ˜¯è°ƒç”¨ yourobject.DeepCopy() æˆ–è€… yourobject.DeepCopyObject()ã€‚\nSchemeå®šä¹‰äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–APIå¯¹è±¡çš„æ–¹æ³•ï¼Œç”¨äºå°†groupã€ç‰ˆæœ¬å’Œç±»å‹ä¿¡æ¯è½¬æ¢ä¸ºGoæ¨¡å¼å’Œä»Goæ¨¡å¼è½¬æ¢ä¸ºGoæ¨¡å¼çš„ç±»å‹æ³¨å†Œè¡¨ï¼Œä»¥åŠä¸åŒç‰ˆæœ¬çš„Goæ¨¡å¼ä¹‹é—´çš„æ˜ å°„ã€‚\n æœ€åï¼Œ// +groupName=example.com å®šä¹‰äº†API ç»„çš„å…¨é™å®šåç§°ã€‚å¦‚æœä½ å†™é”™äº†è¿™ä¸ªåç§°ï¼Œclient-gen ä¼šç”Ÿæˆé”™è¯¯çš„ä»£ç ã€‚å¦å¤–è¿™ä¸ªæ ‡ç­¾å¿…é¡»åœ¨åŒ…ä¸Šçš„æ³¨é‡Šå—ä¸­ã€‚\nLACAL TAGS æœ¬åœ°æ ‡è®°è¦ä¹ˆç›´æ¥å†™åœ¨APIç±»å‹ä¸Šæ–¹ï¼Œè¦ä¹ˆå†™åœ¨å®ƒä¸Šæ–¹çš„ç¬¬äºŒä¸ªæ³¨é‡Šå—ä¸­ã€‚å¦‚ä¸‹çš„ types.go æ–‡ä»¶æ‰€ç¤ºï¼š\n// +genclient // +genclient:noStatus // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object // Database describes a database. type Database struct { metav1.TypeMeta `json:\u0026quot;,inline\u0026quot;` metav1.ObjectMeta `json:\u0026quot;metadata,omitempty\u0026quot;` Spec DatabaseSpec `json:\u0026quot;spec\u0026quot;` } // DatabaseSpec is the spec for a Foo resource type DatabaseSpec struct { User string `json:\u0026quot;user\u0026quot;` Password string `json:\u0026quot;password\u0026quot;` Encoding string `json:\u0026quot;encoding,omitempty\u0026quot;` } // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object // DatabaseList is a list of Database resources type DatabaseList struct { metav1.TypeMeta `json:\u0026quot;,inline\u0026quot;` metav1.ListMeta `json:\u0026quot;metadata\u0026quot;` Items []Database `json:\u0026quot;items\u0026quot;` }  è¯·æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ºæ‰€æœ‰ç±»å‹å¯ç”¨äº†deepcopyï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥é€‰æ‹©ä¸ä½¿ç”¨ deepcopyã€‚ä½†æ˜¯ï¼Œè¿™äº›ç±»å‹éƒ½æ˜¯APIç±»å‹ï¼Œéœ€è¦æ·±åº¦å¤åˆ¶ã€‚å› æ­¤ï¼Œåœ¨æ­¤ç¤ºä¾‹types.goä¸­ï¼Œæˆ‘ä»¬ä¸å¿…æ‰“å¼€æˆ–å…³é—­deepcopyï¼Œè€Œä»…åœ¨doc.goä¸­çš„ç¨‹åºåŒ…èŒƒå›´å†…å³å¯ã€‚\nruntime.Object and DeepCopyObject æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ deepcopy æ ‡ç­¾ï¼Œéœ€è¦æ›´å¤šè¯´æ˜ï¼š\n// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object  å¦‚æœæ‚¨å°è¯•å°†CustomResourcesä¸åŸºäºKubernetes 1.8çš„å®¢æˆ·ç«¯ä¸€èµ·ä½¿ç”¨ï¼Œæœ‰äº›äººå¯èƒ½å·²ç»å¾ˆé«˜å…´ï¼Œå› ä¸ºä»–ä»¬ä¸å°å¿ƒå‡ºå”®äº†masteråˆ†æ”¯çš„k8s.op/apimachineryï¼Œæ‚¨é‡åˆ°äº†ç”±äºCustomResourceç±»å‹æœªå®ç°runtime.Objectè€Œå¯¼è‡´çš„ç¼–è¯‘å™¨é”™è¯¯ï¼Œå› ä¸ºæœªåœ¨æ‚¨çš„ç±»å‹ä¸Šå®šä¹‰DeepCopyObjectï¼ˆï¼‰runtime.Objectã€‚åŸå› æ˜¯åœ¨1.8ä¸­ï¼Œruntime.Objectæ¥å£ä½¿ç”¨æ­¤æ–¹æ³•ç­¾åè¿›è¡Œäº†æ‰©å±•ï¼Œå› æ­¤æ¯ä¸ªruntime.Objectéƒ½å¿…é¡»å®ç°DeepCopyObjectã€‚ DeepCopyObjectï¼ˆï¼‰runtime.Objectçš„å®ç°å¾ˆç®€å•ï¼š\nfunc (in *T) DeepCopyObject() runtime.Object { if c := in.DeepCopy(); c != nil { return c } else { return nil } }  ä½†å¹¸è¿çš„æ˜¯ï¼Œæ‚¨ä¸å¿…ä¸ºæ¯ç§ç±»å‹éƒ½å®ç°æ­¤åŠŸèƒ½ï¼Œè€Œåªéœ€å°†ä»¥ä¸‹æœ¬åœ°æ ‡è®°æ”¾åœ¨é¡¶çº§APIç±»å‹çš„ä¸Šæ–¹ï¼š\n// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object  åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼ŒDatabase å’ŒDatabaseListéƒ½æ˜¯é¡¶çº§ç±»å‹ï¼Œå› ä¸ºå®ƒä»¬è¢«ç”¨ä½œruntime.Objectsã€‚æ ¹æ®ç»éªŒï¼Œé¡¶çº§ç±»å‹æ˜¯é‚£äº›åµŒå…¥äº†metav1.TypeMetaçš„ç±»å‹ã€‚åŒæ ·ï¼Œè¿™äº›æ˜¯å®¢æˆ·ç«¯ä½¿ç”¨client-genåˆ›å»ºçš„ç±»å‹ã€‚\nè¯·æ³¨æ„ï¼Œ// + k8sï¼šdeepcopy-genï¼šinterfaces æ ‡è®°å¯ä»¥å¹¶ä¸”ä¹Ÿåº”è¯¥åœ¨å®šä¹‰å…·æœ‰æŸäº›æ¥å£ç±»å‹çš„å­—æ®µï¼ˆä¾‹å¦‚ï¼Œfield SomeInterfaceï¼‰çš„APIç±»å‹çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚ç„¶å// + k8sï¼šdeepcopy-genï¼šinterfaces=example.com/pkg/apis/example.SomeInterfaceå°†å¯¼è‡´DeepeepSomeInterfaceï¼ˆï¼‰SomeInterfaceæ–¹æ³•çš„ç”Ÿæˆã€‚è¿™å…è®¸å®ƒä»¥ç±»å‹æ­£ç¡®çš„æ–¹å¼å¯¹è¿™äº›å­—æ®µè¿›è¡Œæ·±åº¦å¤åˆ¶ã€‚\nClient-gen æ ‡ç­¾ æœ€åï¼Œæœ‰è®¸å¤šæ ‡è®°å¯æ§åˆ¶client-genï¼Œåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°å…¶ä¸­ä¸¤ä¸ªï¼š\n// +genclient // +genclient:noStatus  ç¬¬ä¸€ä¸ªæ ‡è®°å‘Šè¯‰client-genä¸ºè¯¥ç±»å‹åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆå§‹ç»ˆå¯ç”¨ï¼‰ã€‚è¯·æ³¨æ„ï¼Œæ‚¨ä¸å¿…å°†å…¶æ”¾åœ¨APIå¯¹è±¡çš„åˆ—è¡¨ç±»å‹ä¸Šæ–¹ã€‚\nç¬¬äºŒä¸ªæ ‡è®°å‘Šè¯‰client-genè¯¥ç±»å‹æœªé€šè¿‡/statuså­èµ„æºä½¿ç”¨è§„èŒƒçŠ¶æ€åˆ†éš”ã€‚ç”Ÿæˆçš„å®¢æˆ·ç«¯å°†æ²¡æœ‰UpdateStatusæ–¹æ³•ï¼ˆclient-genä¸€æ—¦åœ¨æ‚¨çš„ç»“æ„ä¸­æ‰¾åˆ°Statuså­—æ®µï¼Œå°±ä¼šç›²ç›®ç”Ÿæˆè¯¥æ–¹æ³•ï¼‰ã€‚ /statuså­èµ„æºä»…åœ¨1.8ä¸­æ‰é€‚ç”¨äºæœ¬åœ°ï¼ˆåœ¨golangä¸­ï¼‰å®ç°çš„èµ„æºã€‚ä½†æ˜¯ï¼Œéšç€PR 913ä¸­ä¸ºCustomResourcesè®¨è®ºå­èµ„æºï¼Œè¿™ç§æƒ…å†µå¯èƒ½å¾ˆå¿«å°±ä¼šæ”¹å˜ã€‚\nå¯¹äºç¾¤é›†èŒƒå›´çš„èµ„æºï¼Œå¿…é¡»ä½¿ç”¨æ ‡ç­¾ï¼š\n// +genclient:nonNamespaced  å¯¹äºç‰¹æ®Šç”¨é€”çš„å®¢æˆ·ç«¯ï¼Œæ‚¨å¯èƒ½è¿˜å¸Œæœ›è¯¦ç»†æ§åˆ¶å®¢æˆ·ç«¯æä¾›å“ªäº›HTTPæ–¹æ³•ã€‚å¯ä»¥ä½¿ç”¨å‡ ä¸ªæ ‡ç­¾æ¥å®Œæˆæ­¤æ“ä½œï¼Œä¾‹å¦‚ï¼š\n// +genclient:noVerbs // +genclient:onlyVerbs=create,delete // +genclient:skipVerbs=get,list,create,update,patch,delete,deleteCollection,watch // +genclient:method=Create,verb=create,result=k8s.io/apimachinery/pkg/apis/meta/v1.Status  å‰ä¸‰ä¸ªåº”è¯¥æ˜¯ä¸è¨€è‡ªæ˜çš„ï¼Œä½†æ˜¯æœ€åä¸€ä¸ªéœ€è¦ä¸€äº›è§£é‡Šã€‚ä¸Šé¢å†™å…¥æ­¤æ ‡è®°çš„ç±»å‹å°†æ˜¯ä»…åˆ›å»ºçš„ï¼Œå¹¶ä¸”ä¸ä¼šè¿”å›APIç±»å‹æœ¬èº«ï¼Œè€Œæ˜¯metav1.Statusã€‚å¯¹äºCustomResourcesæ¥è¯´ï¼Œè¿™æ²¡æœ‰å¤šå¤§æ„ä¹‰ï¼Œä½†æ˜¯å¯¹äºç”¨golangç¼–å†™çš„ç”¨æˆ·æä¾›çš„APIæœåŠ¡å™¨ï¼Œè¿™äº›èµ„æºå¯ä»¥å­˜åœ¨ï¼Œå¹¶ä¸”å®é™…ä¸Šå¯ä»¥åœ¨OpenShift APIä¸­ä½¿ç”¨ã€‚\nä½¿ç”¨ç±»å‹å®¢æˆ·ç«¯çš„ä¸»è¦åŠŸèƒ½ å°½ç®¡å¤§å¤šæ•°åŸºäºKubernetes 1.7å’Œæ›´æ—©ç‰ˆæœ¬çš„ç¤ºä¾‹éƒ½ä½¿ç”¨äº†Client-go dynamic client ä½œä¸ºCustomResourcesï¼Œä½†åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…ï¼Œæœ¬åœ°Kubernetes APIç±»å‹çš„ç±»å‹åŒ–å®¢æˆ·ç«¯éƒ½æ›´åŠ æ–¹ä¾¿ã€‚åœ¨1.8ç‰ˆä¸­è¿›è¡Œäº†æ›´æ”¹ï¼šå¦‚ä¸Šæ‰€è¿°ï¼Œclient-genè¿˜ä¸ºæ‚¨çš„è‡ªå®šä¹‰ç±»å‹åˆ›å»ºäº†nativeï¼ŒåŠŸèƒ½é½å…¨ä¸”æ˜“äºä½¿ç”¨çš„ç±»å‹åŒ–å®¢æˆ·ç«¯ã€‚å®é™…ä¸Šï¼Œclient-genä¸çŸ¥é“æ‚¨æ˜¯å°†å…¶åº”ç”¨äºCustomResourceç±»å‹è¿˜æ˜¯nativeç±»å‹ã€‚ å› æ­¤ï¼Œä½¿ç”¨æ­¤å®¢æˆ·ç«¯ä¸ä½¿ç”¨å®¢æˆ·ç«¯Goberå®¢æˆ·ç«¯å®Œå…¨ç­‰æ•ˆã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç¤ºä¾‹ï¼š\nimport ( ... metav1 \u0026quot;k8s.io/apimachinery/pkg/apis/meta/v1\u0026quot; \u0026quot;k8s.io/client-go/tools/clientcmd\u0026quot; examplecomclientset \u0026quot;github.com/openshift-evangelist/crd-code-generation/pkg/client/clientset/versioned\u0026quot; ) var ( kuberconfig = flag.String(\u0026quot;kubeconfig\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;Path to a kubeconfig. Only required if out-of-cluster.\u0026quot;) master = flag.String(\u0026quot;master\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;The address of the Kubernetes API server. Overrides any value in kubeconfig. Only required if out-of-cluster.\u0026quot;) ) func main() { flag.Parse() cfg, err := clientcmd.BuildConfigFromFlags(*master, *kuberconfig) if err != nil { glog.Fatalf(\u0026quot;Error building kubeconfig: %v\u0026quot;, err) } exampleClient, err := examplecomclientset.NewForConfig(cfg) if err != nil { glog.Fatalf(\u0026quot;Error building example clientset: %v\u0026quot;, err) } list, err := exampleClient.ExampleV1().Databases(\u0026quot;default\u0026quot;).List(metav1.ListOpti ons{}) if err != nil { glog.Fatalf(\u0026quot;Error listing all databases: %v\u0026quot;, err) } for _, db := range list.Items { fmt.Printf(\u0026quot;database %s with user %q\\n\u0026quot;, db.Name, db.Spec.User) } }  å®ƒä¸kubeconfigæ–‡ä»¶ä¸€èµ·ä½¿ç”¨ï¼Œå®é™…ä¸Šå¯ä»¥ä¸kubectlå’ŒKuberneteså®¢æˆ·ç«¯ä¸€èµ·ä½¿ç”¨ã€‚\nä¸åŠ¨æ€å®¢æˆ·ç«¯ä½¿ç”¨çš„æ—§ç‰ˆTPRæˆ–CustomResourceä»£ç ç›¸æ¯”ï¼Œæ‚¨æ— éœ€è¿›è¡Œç±»å‹è½¬æ¢ã€‚ç›¸åï¼Œå®é™…çš„å®¢æˆ·ç«¯è°ƒç”¨çœ‹èµ·æ¥å®Œå…¨æ˜¯æœ¬åœ°çš„ï¼Œå®ƒæ˜¯ï¼š\nlist, err := exampleClient.ExampleV1().Databases(\u0026quot;default\u0026quot;).List(metav1.ListOptions{})  åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œç»“æœæ˜¯ç¾¤é›†ä¸­æ‰€æœ‰æ•°æ®åº“çš„DatabaseListã€‚å¦‚æœæ‚¨å°†ç±»å‹åˆ‡æ¢ä¸ºé›†ç¾¤èŒƒå›´ï¼ˆå³æ²¡æœ‰å‘½åç©ºé—´ï¼›è¯·ä¸è¦å¿˜è®°ä½¿ç”¨// + genclientnonNamespacedæ ‡è®°å‘Šè¯‰client-genï¼ï¼‰ï¼Œè°ƒç”¨å°†å˜æˆ\nlist, err := exampleClient.ExampleV1().Databases().List(metav1.ListOptions{})  ä»¥ç¼–ç¨‹æ–¹å¼åœ¨GOLANGåˆ›å»ºè‡ªå®šä¹‰èµ„æº ç”±äºè¿™ä¸ªé—®é¢˜ç»å¸¸å‡ºç°ï¼Œå› æ­¤è¯·æ‚¨è°ˆè°ˆå¦‚ä½•ä»æ‚¨çš„golangä»£ç ä¸­ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»ºCRDçš„å‡ å¥è¯ã€‚\nå®¢æˆ·ä»£æ€»æ˜¯åˆ›å»ºæ‰€è°“çš„clinetsetsã€‚å®¢æˆ·ç«¯é›†å°†ä¸€ä¸ªæˆ–å¤šä¸ªAPIç»„æ†ç»‘åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯ä¸­ã€‚é€šå¸¸ï¼Œè¿™äº›APIç»„æ¥è‡ªä¸€ä¸ªå­˜å‚¨åº“ï¼Œå¹¶ä½äºä¸€ä¸ªåŸºæœ¬ç¨‹åºåŒ…ä¸­ï¼Œä¾‹å¦‚ï¼Œå¦‚æœ¬åšæ–‡ç¤ºä¾‹ä¸­çš„pkg/apisï¼›å¯¹äºKubernetesï¼Œåˆ™æ¥è‡ªk8s.io/apiã€‚\nCustomResourceDefinitionsç”± kubernetes/apiextensions-apiserverå­˜å‚¨åº“ã€‚è¯¥APIæœåŠ¡å™¨ï¼ˆä¹Ÿå¯ä»¥ç‹¬ç«‹å¯åŠ¨ï¼‰æ˜¯ç”±kube-apiserveråµŒå…¥çš„ï¼Œå› æ­¤CRDåœ¨æ¯ä¸ªKubernetesç¾¤é›†ä¸Šéƒ½å¯ç”¨ã€‚ä½†æ˜¯åˆ›å»ºCRDçš„å®¢æˆ·ç«¯ä¼šåˆ›å»ºåˆ°apiextensions-apiserverå­˜å‚¨åº“ä¸­ï¼Œå½“ç„¶ä¹Ÿè¦ä½¿ç”¨client-genã€‚é˜…è¯»æ­¤åšå®¢åï¼Œæ‚¨å¯ä»¥åœ¨kubernetes/apiextensions-apiserver/tree/master/pkg/clientä¸Šæ‰¾åˆ°å®¢æˆ·ç«¯ä¹Ÿä¸ä¼šæ„Ÿåˆ°æƒŠè®¶ï¼Œåˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹ä»¥åŠå¦‚ä½•åˆ›å»ºCRDçœ‹èµ·æ¥ä¹Ÿä¸å¥‡æ€ªï¼š\nimport ( ... apiextensionsclientset \u0026quot;k8s.io/apiextensions-apiserver/pkg/client/clientset/clientsetâ€ ) apiextensionsClient, err := apiextensionsclientset.NewForConfig(cfg) ... createdCRD, err := apiextensionsClient.ApiextensionsV1beta1().CustomResourceDefinitions().Create(yourCRD)  è¯·æ³¨æ„ï¼Œåˆ›å»ºå®Œæˆåï¼Œæ‚¨å°†å¿…é¡»ç­‰å¾…åœ¨æ–°CRDä¸Šè®¾ç½®â€œå·²å»ºç«‹â€æ¡ä»¶ã€‚åªæœ‰è¿™æ ·ï¼Œkube-apiserveræ‰ä¼šå¼€å§‹æä¾›èµ„æºã€‚å¦‚æœæ‚¨ä¸ç­‰å¾…è¯¥æ¡ä»¶ï¼Œåˆ™æ¯æ¬¡CRæ“ä½œéƒ½ä¼šè¿”å›404 HTTPçŠ¶æ€ä»£ç ã€‚\n","date":"2021å¹´03æœˆ12æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter9/code-generation-for-customresources/","summary":"\u003cblockquote\u003e\n\u003cp\u003eåŸæ–‡é“¾æ¥ï¼š\u003ca href=\"https://www.openshift.com/blog/kubernetes-deep-dive-code-generation-customresources\"\u003eKubernetes Deep Dive: Code Generation for CustomResources\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e","title":"[è¯‘]Kubernetesæ·±å…¥ç ”ç©¶ï¼šCustomResourcesçš„ä»£ç ç”Ÿæˆ"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹ï¼Œæœ¬èŠ‚ä¸»è¦æ˜¯å…³äºè‡ªå®šä¹‰APIèµ„æº(CRD)ã€‚\n åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ºä½ è¯¦ç»†è®²è§£äº† Kubernetes å£°æ˜å¼ API çš„è®¾è®¡ã€ç‰¹ç‚¹ï¼Œä»¥åŠä½¿ç”¨æ–¹å¼ã€‚è€Œåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°±æ¥ä¸ºä½ è®²è§£ä¸€ä¸‹ Kubernetes å£°æ˜å¼ API çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨è¿™å¥— API æœºåˆ¶ï¼Œåœ¨ Kubernetes é‡Œæ·»åŠ è‡ªå®šä¹‰çš„ API å¯¹è±¡ã€‚\nä½ å¯èƒ½ä¸€ç›´å°±å¾ˆå¥½å¥‡ï¼šå½“æˆ‘æŠŠä¸€ä¸ª YAML æ–‡ä»¶æäº¤ç»™ Kubernetes ä¹‹åï¼Œå®ƒç©¶ç«Ÿæ˜¯å¦‚ä½•åˆ›å»ºå‡ºä¸€ä¸ª API å¯¹è±¡çš„å‘¢ï¼Ÿè¿™å¾—ä»å£°æ˜å¼ API çš„è®¾è®¡è°ˆèµ·äº†ã€‚\nåœ¨ Kubernetes é¡¹ç›®ä¸­ï¼Œä¸€ä¸ª API å¯¹è±¡åœ¨ Etcd é‡Œçš„å®Œæ•´èµ„æºè·¯å¾„ï¼Œæ˜¯ç”±ï¼šGroupï¼ˆAPI ç»„ï¼‰ã€Versionï¼ˆAPI ç‰ˆæœ¬ï¼‰å’Œ Resourceï¼ˆAPI èµ„æºç±»å‹ï¼‰ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆçš„ã€‚\né€šè¿‡è¿™æ ·çš„ç»“æ„ï¼Œæ•´ä¸ª Kubernetes é‡Œçš„æ‰€æœ‰ API å¯¹è±¡ï¼Œå®é™…ä¸Šå°±å¯ä»¥ç”¨å¦‚ä¸‹çš„æ ‘å½¢ç»“æ„è¡¨ç¤ºå‡ºæ¥ï¼š\nåœ¨è¿™å¹…å›¾ä¸­ï¼Œä½ å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ° Kubernetes é‡Œ API å¯¹è±¡çš„ç»„ç»‡æ–¹å¼ï¼Œå…¶å®æ˜¯å±‚å±‚é€’è¿›çš„ã€‚æ¯”å¦‚ï¼Œç°åœ¨æˆ‘è¦å£°æ˜è¦åˆ›å»ºä¸€ä¸ª CronJob å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘çš„ YAML æ–‡ä»¶çš„å¼€å§‹éƒ¨åˆ†ä¼šè¿™ä¹ˆå†™ï¼š\napiVersion: batch/v2alpha1 kind: CronJob ...  åœ¨è¿™ä¸ª YAML æ–‡ä»¶ä¸­ï¼Œâ€œCronJobâ€å°±æ˜¯è¿™ä¸ª API å¯¹è±¡çš„èµ„æºç±»å‹ï¼ˆResourceï¼‰ï¼Œâ€œbatchâ€å°±æ˜¯å®ƒçš„ç»„ï¼ˆGroupï¼‰ï¼Œv2alpha1 å°±æ˜¯å®ƒçš„ç‰ˆæœ¬ï¼ˆVersionï¼‰ã€‚å½“æˆ‘ä»¬æäº¤äº†è¿™ä¸ª YAML æ–‡ä»¶ä¹‹åï¼ŒKubernetes å°±ä¼šæŠŠè¿™ä¸ª YAML æ–‡ä»¶é‡Œæè¿°çš„å†…å®¹ï¼Œè½¬æ¢æˆ Kubernetes é‡Œçš„ä¸€ä¸ª CronJob å¯¹è±¡ã€‚\né‚£ä¹ˆï¼ŒKubernetes æ˜¯å¦‚ä½•å¯¹ Resourceã€Group å’Œ Version è¿›è¡Œè§£æï¼Œä»è€Œåœ¨ Kubernetes é¡¹ç›®é‡Œæ‰¾åˆ° CronJob å¯¹è±¡çš„å®šä¹‰å‘¢ï¼Ÿ\né¦–å…ˆï¼ŒKubernetes ä¼šåŒ¹é… API å¯¹è±¡çš„ç»„ã€‚\néœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œå¯¹äº Kubernetes é‡Œçš„æ ¸å¿ƒ API å¯¹è±¡ï¼Œæ¯”å¦‚ï¼šPodã€Node ç­‰ï¼Œæ˜¯ä¸éœ€è¦ Group çš„ï¼ˆå³ï¼šå®ƒä»¬çš„ Group æ˜¯â€œâ€ï¼‰ã€‚æ‰€ä»¥ï¼Œå¯¹äºè¿™äº› API å¯¹è±¡æ¥è¯´ï¼ŒKubernetes ä¼šç›´æ¥åœ¨ /api è¿™ä¸ªå±‚çº§è¿›è¡Œä¸‹ä¸€æ­¥çš„åŒ¹é…è¿‡ç¨‹ã€‚è€Œå¯¹äº CronJob ç­‰éæ ¸å¿ƒ API å¯¹è±¡æ¥è¯´ï¼ŒKubernetes å°±å¿…é¡»åœ¨ /apis è¿™ä¸ªå±‚çº§é‡ŒæŸ¥æ‰¾å®ƒå¯¹åº”çš„ Groupï¼Œè¿›è€Œæ ¹æ®â€œbatchâ€è¿™ä¸ª Group çš„åå­—ï¼Œæ‰¾åˆ° /apis/batchã€‚ä¸éš¾å‘ç°ï¼Œè¿™äº› API Group çš„åˆ†ç±»æ˜¯ä»¥å¯¹è±¡åŠŸèƒ½ä¸ºä¾æ®çš„ï¼Œæ¯”å¦‚ Job å’Œ CronJob å°±éƒ½å±äºâ€œbatchâ€ ï¼ˆç¦»çº¿ä¸šåŠ¡ï¼‰è¿™ä¸ª Groupã€‚\nç„¶åï¼ŒKubernetes ä¼šè¿›ä¸€æ­¥åŒ¹é…åˆ° API å¯¹è±¡çš„ç‰ˆæœ¬å·ã€‚\nå¯¹äº CronJob è¿™ä¸ª API å¯¹è±¡æ¥è¯´ï¼ŒKubernetes åœ¨ batch è¿™ä¸ª Group ä¸‹ï¼ŒåŒ¹é…åˆ°çš„ç‰ˆæœ¬å·å°±æ˜¯ v2alpha1ã€‚åœ¨ Kubernetes ä¸­ï¼ŒåŒä¸€ç§ API å¯¹è±¡å¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œè¿™æ­£æ˜¯ Kubernetes è¿›è¡Œ API ç‰ˆæœ¬åŒ–ç®¡ç†çš„é‡è¦æ‰‹æ®µã€‚è¿™æ ·ï¼Œæ¯”å¦‚åœ¨ CronJob çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯¹äºä¼šå½±å“åˆ°ç”¨æˆ·çš„å˜æ›´å°±å¯ä»¥é€šè¿‡å‡çº§æ–°ç‰ˆæœ¬æ¥å¤„ç†ï¼Œä»è€Œä¿è¯äº†å‘åå…¼å®¹ã€‚\næœ€åï¼ŒKubernetes ä¼šåŒ¹é… API å¯¹è±¡çš„èµ„æºç±»å‹ã€‚\nåœ¨å‰é¢åŒ¹é…åˆ°æ­£ç¡®çš„ç‰ˆæœ¬ä¹‹åï¼ŒKubernetes å°±çŸ¥é“ï¼Œæˆ‘è¦åˆ›å»ºçš„åŸæ¥æ˜¯ä¸€ä¸ª /apis/batch/v2alpha1 ä¸‹çš„ CronJob å¯¹è±¡ã€‚è¿™æ—¶å€™ï¼ŒAPIServer å°±å¯ä»¥ç»§ç»­åˆ›å»ºè¿™ä¸ª CronJob å¯¹è±¡äº†ã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä¸ºä½ æ€»ç»“äº†ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºæµç¨‹å›¾æ¥é˜è¿°è¿™ä¸ªåˆ›å»ºè¿‡ç¨‹ï¼š\né¦–å…ˆï¼Œå½“æˆ‘ä»¬å‘èµ·äº†åˆ›å»º CronJob çš„ POST è¯·æ±‚ä¹‹åï¼Œæˆ‘ä»¬ç¼–å†™çš„ YAML çš„ä¿¡æ¯å°±è¢«æäº¤ç»™äº† APIServerã€‚è€Œ APIServer çš„ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯è¿‡æ»¤è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶å®Œæˆä¸€äº›å‰ç½®æ€§çš„å·¥ä½œï¼Œæ¯”å¦‚æˆæƒã€è¶…æ—¶å¤„ç†ã€å®¡è®¡ç­‰ã€‚\nç„¶åï¼Œè¯·æ±‚ä¼šè¿›å…¥ MUX å’Œ Routes æµç¨‹ã€‚å¦‚æœä½ ç¼–å†™è¿‡ Web Server çš„è¯å°±ä¼šçŸ¥é“ï¼ŒMUX å’Œ Routes æ˜¯ APIServer å®Œæˆ URL å’Œ Handler ç»‘å®šçš„åœºæ‰€ã€‚è€Œ APIServer çš„ Handler è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯æŒ‰ç…§æˆ‘åˆšåˆšä»‹ç»çš„åŒ¹é…è¿‡ç¨‹ï¼Œæ‰¾åˆ°å¯¹åº”çš„ CronJob ç±»å‹å®šä¹‰ã€‚\næ¥ç€ï¼ŒAPIServer æœ€é‡è¦çš„èŒè´£å°±æ¥äº†ï¼šæ ¹æ®è¿™ä¸ª CronJob ç±»å‹å®šä¹‰ï¼Œä½¿ç”¨ç”¨æˆ·æäº¤çš„ YAML æ–‡ä»¶é‡Œçš„å­—æ®µï¼Œåˆ›å»ºä¸€ä¸ª CronJob å¯¹è±¡ã€‚è€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒAPIServer ä¼šè¿›è¡Œä¸€ä¸ª Convert å·¥ä½œï¼Œå³ï¼šæŠŠç”¨æˆ·æäº¤çš„ YAML æ–‡ä»¶ï¼Œè½¬æ¢æˆä¸€ä¸ªå«ä½œ Super Version çš„å¯¹è±¡ï¼Œå®ƒæ­£æ˜¯è¯¥ API èµ„æºç±»å‹æ‰€æœ‰ç‰ˆæœ¬çš„å­—æ®µå…¨é›†ã€‚è¿™æ ·ç”¨æˆ·æäº¤çš„ä¸åŒç‰ˆæœ¬çš„ YAML æ–‡ä»¶ï¼Œå°±éƒ½å¯ä»¥ç”¨è¿™ä¸ª Super Version å¯¹è±¡æ¥è¿›è¡Œå¤„ç†äº†ã€‚\næ¥ä¸‹æ¥ï¼ŒAPIServer ä¼šå…ˆåè¿›è¡Œ Admission() å’Œ Validation() æ“ä½œã€‚æ¯”å¦‚ï¼Œæˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„ Admission Controller å’Œ Initializerï¼Œå°±éƒ½å±äº Admission çš„å†…å®¹ã€‚è€Œ Validationï¼Œåˆ™è´Ÿè´£éªŒè¯è¿™ä¸ªå¯¹è±¡é‡Œçš„å„ä¸ªå­—æ®µæ˜¯å¦åˆæ³•ã€‚è¿™ä¸ªè¢«éªŒè¯è¿‡çš„ API å¯¹è±¡ï¼Œéƒ½ä¿å­˜åœ¨äº† APIServer é‡Œä¸€ä¸ªå«ä½œ Registry çš„æ•°æ®ç»“æ„ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä¸€ä¸ª API å¯¹è±¡çš„å®šä¹‰èƒ½åœ¨ Registry é‡ŒæŸ¥åˆ°ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ Kubernetes API å¯¹è±¡ã€‚\næœ€åï¼ŒAPIServer ä¼šæŠŠéªŒè¯è¿‡çš„ API å¯¹è±¡è½¬æ¢æˆç”¨æˆ·æœ€åˆæäº¤çš„ç‰ˆæœ¬ï¼Œè¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œå¹¶è°ƒç”¨ Etcd çš„ API æŠŠå®ƒä¿å­˜èµ·æ¥ã€‚\nç”±æ­¤å¯è§ï¼Œå£°æ˜å¼ API å¯¹äº Kubernetes æ¥è¯´éå¸¸é‡è¦ã€‚æ‰€ä»¥ï¼ŒAPIServer è¿™æ ·ä¸€ä¸ªåœ¨å…¶ä»–é¡¹ç›®é‡Œâ€œå¹³æ·¡æ— å¥‡â€çš„ç»„ä»¶ï¼Œå´æˆäº† Kubernetes é¡¹ç›®çš„é‡ä¸­ä¹‹é‡ã€‚å®ƒä¸ä»…æ˜¯ Google Borg è®¾è®¡æ€æƒ³çš„é›†ä¸­ä½“ç°ï¼Œä¹Ÿæ˜¯ Kubernetes é¡¹ç›®é‡Œå”¯ä¸€ä¸€ä¸ªè¢« Google å…¬å¸å’Œ RedHat å…¬å¸åŒé‡æ§åˆ¶ã€å…¶ä»–åŠ¿åŠ›æ ¹æœ¬æ— æ³•å‚ä¸å…¶ä¸­çš„ç»„ä»¶ã€‚\næ­¤å¤–ï¼Œç”±äºåŒæ—¶è¦å…¼é¡¾æ€§èƒ½ã€API å®Œå¤‡æ€§ã€ç‰ˆæœ¬åŒ–ã€å‘åå…¼å®¹ç­‰å¾ˆå¤šå·¥ç¨‹åŒ–æŒ‡æ ‡ï¼Œæ‰€ä»¥ Kubernetes å›¢é˜Ÿåœ¨ APIServer é¡¹ç›®é‡Œå¤§é‡ä½¿ç”¨äº† Go è¯­è¨€çš„ä»£ç ç”ŸæˆåŠŸèƒ½ï¼Œæ¥è‡ªåŠ¨åŒ–è¯¸å¦‚ Convertã€DeepCopy ç­‰ä¸ API èµ„æºç›¸å…³çš„æ“ä½œã€‚è¿™éƒ¨åˆ†è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼Œæ›¾ä¸€åº¦å åˆ° Kubernetes é¡¹ç›®æ€»ä»£ç çš„ 20%~30%ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä½•ï¼Œåœ¨è¿‡å»å¾ˆé•¿ä¸€æ®µæ—¶é—´é‡Œï¼Œåœ¨è¿™æ ·ä¸€ä¸ªæå…¶â€œå¤æ‚â€çš„ APIServer ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª Kubernetes é£æ ¼çš„ API èµ„æºç±»å‹ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å›°éš¾çš„å·¥ä½œã€‚ä¸è¿‡ï¼Œåœ¨ Kubernetes v1.7 ä¹‹åï¼Œè¿™ä¸ªå·¥ä½œå°±å˜å¾—è½»æ¾å¾—å¤šäº†ã€‚è¿™ï¼Œå½“ç„¶å¾—ç›Šäºä¸€ä¸ªå…¨æ–°çš„ API æ’ä»¶æœºåˆ¶ï¼šCRDã€‚\nCRD çš„å…¨ç§°æ˜¯ Custom Resource Definitionã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒæŒ‡çš„å°±æ˜¯ï¼Œå…è®¸ç”¨æˆ·åœ¨ Kubernetes ä¸­æ·»åŠ ä¸€ä¸ªè·Ÿ Podã€Node ç±»ä¼¼çš„ã€æ–°çš„ API èµ„æºç±»å‹ï¼Œå³ï¼šè‡ªå®šä¹‰ API èµ„æºã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ç°åœ¨è¦ä¸º Kubernetes æ·»åŠ ä¸€ä¸ªåå« Network çš„ API èµ„æºç±»å‹ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼Œä¸€æ—¦ç”¨æˆ·åˆ›å»ºä¸€ä¸ª Network å¯¹è±¡ï¼Œé‚£ä¹ˆ Kubernetes å°±åº”è¯¥ä½¿ç”¨è¿™ä¸ªå¯¹è±¡å®šä¹‰çš„ç½‘ç»œå‚æ•°ï¼Œè°ƒç”¨çœŸå®çš„ç½‘ç»œæ’ä»¶ï¼Œæ¯”å¦‚ Neutron é¡¹ç›®ï¼Œä¸ºç”¨æˆ·åˆ›å»ºä¸€ä¸ªçœŸæ­£çš„â€œç½‘ç»œâ€ã€‚è¿™æ ·ï¼Œå°†æ¥ç”¨æˆ·åˆ›å»ºçš„ Podï¼Œå°±å¯ä»¥å£°æ˜ä½¿ç”¨è¿™ä¸ªâ€œç½‘ç»œâ€äº†ã€‚\nè¿™ä¸ª Network å¯¹è±¡çš„ YAML æ–‡ä»¶ï¼Œåå« example-network.yamlï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: samplecrd.k8s.io/v1 kind: Network metadata: name: example-network spec: cidr: \u0026quot;192.168.0.0/16\u0026quot; gateway: \u0026quot;192.168.0.1\u0026quot;  å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘æƒ³è¦æè¿°â€œç½‘ç»œâ€çš„ API èµ„æºç±»å‹æ˜¯ Networkï¼›API ç»„æ˜¯samplecrd.k8s.ioï¼›API ç‰ˆæœ¬æ˜¯ v1ã€‚\né‚£ä¹ˆï¼ŒKubernetes åˆè¯¥å¦‚ä½•çŸ¥é“è¿™ä¸ª APIï¼ˆsamplecrd.k8s.io/v1/networkï¼‰çš„å­˜åœ¨å‘¢ï¼Ÿ\nå…¶å®ï¼Œä¸Šé¢çš„è¿™ä¸ª YAML æ–‡ä»¶ï¼Œå°±æ˜¯ä¸€ä¸ªå…·ä½“çš„â€œè‡ªå®šä¹‰ API èµ„æºâ€å®ä¾‹ï¼Œä¹Ÿå« CRï¼ˆCustom Resourceï¼‰ã€‚è€Œä¸ºäº†èƒ½å¤Ÿè®© Kubernetes è®¤è¯†è¿™ä¸ª CRï¼Œä½ å°±éœ€è¦è®© Kubernetes æ˜ç™½è¿™ä¸ª CR çš„å®è§‚å®šä¹‰æ˜¯ä»€ä¹ˆï¼Œä¹Ÿå°±æ˜¯ CRDï¼ˆCustom Resource Definitionï¼‰ã€‚\nè¿™å°±å¥½æ¯”ï¼Œä½ æƒ³è®©è®¡ç®—æœºè®¤è¯†å„ç§å…”å­çš„ç…§ç‰‡ï¼Œå°±å¾—å…ˆè®©è®¡ç®—æœºæ˜ç™½ï¼Œå…”å­çš„æ™®éå®šä¹‰æ˜¯ä»€ä¹ˆã€‚æ¯”å¦‚ï¼Œå…”å­â€œæ˜¯å“ºä¹³åŠ¨ç‰©â€â€œæœ‰é•¿è€³æœµï¼Œä¸‰ç“£å˜´â€ã€‚\næ‰€ä»¥ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘å°±å…ˆç¼–å†™ä¸€ä¸ª CRD çš„ YAML æ–‡ä»¶ï¼Œå®ƒçš„åå­—å«ä½œ network.yamlï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: networks.samplecrd.k8s.io spec: group: samplecrd.k8s.io version: v1 names: kind: Network plural: networks scope: Namespaced  å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ª CRD ä¸­ï¼Œæˆ‘æŒ‡å®šäº†â€œgroup: samplecrd.k8s.ioâ€â€œversion: v1â€è¿™æ ·çš„ API ä¿¡æ¯ï¼Œä¹ŸæŒ‡å®šäº†è¿™ä¸ª CR çš„èµ„æºç±»å‹å«ä½œ Networkï¼Œå¤æ•°ï¼ˆpluralï¼‰æ˜¯ networksã€‚ç„¶åï¼Œæˆ‘è¿˜å£°æ˜äº†å®ƒçš„ scope æ˜¯ Namespacedï¼Œå³ï¼šæˆ‘ä»¬å®šä¹‰çš„è¿™ä¸ª Network æ˜¯ä¸€ä¸ªå±äº Namespace çš„å¯¹è±¡ï¼Œç±»ä¼¼äº Podã€‚è¿™å°±æ˜¯ä¸€ä¸ª Network API èµ„æºç±»å‹çš„ API éƒ¨åˆ†çš„å®è§‚å®šä¹‰äº†ã€‚è¿™å°±ç­‰åŒäºå‘Šè¯‰äº†è®¡ç®—æœºï¼šâ€œå…”å­æ˜¯å“ºä¹³åŠ¨ç‰©â€ã€‚æ‰€ä»¥è¿™æ—¶å€™ï¼ŒKubernetes å°±èƒ½å¤Ÿè®¤è¯†å’Œå¤„ç†æ‰€æœ‰å£°æ˜äº† API ç±»å‹æ˜¯â€œsamplecrd.k8s.io/v1/networkâ€çš„ YAML æ–‡ä»¶äº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘è¿˜éœ€è¦è®© Kubernetesâ€œè®¤è¯†â€è¿™ç§ YAML æ–‡ä»¶é‡Œæè¿°çš„â€œç½‘ç»œâ€éƒ¨åˆ†ï¼Œæ¯”å¦‚â€œcidrâ€ï¼ˆç½‘æ®µï¼‰ï¼Œâ€œgatewayâ€ï¼ˆç½‘å…³ï¼‰è¿™äº›å­—æ®µçš„å«ä¹‰ã€‚è¿™å°±ç›¸å½“äºæˆ‘è¦å‘Šè¯‰è®¡ç®—æœºï¼šâ€œå…”å­æœ‰é•¿è€³æœµå’Œä¸‰ç“£å˜´â€ã€‚è¿™æ—¶å€™å‘¢ï¼Œæˆ‘å°±éœ€è¦ç¨å¾®åšäº›ä»£ç å·¥ä½œäº†ã€‚\né¦–å…ˆï¼Œæˆ‘è¦åœ¨ GOPATH ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªç»“æ„å¦‚ä¸‹çš„é¡¹ç›®ï¼š\n$ tree $GOPATH/src/github.com/\u0026lt;your-name\u0026gt;/k8s-controller-custom-resource . â”œâ”€â”€ controller.go â”œâ”€â”€ crd â”‚ â””â”€â”€ network.yaml â”œâ”€â”€ example â”‚ â””â”€â”€ example-network.yaml â”œâ”€â”€ main.go â””â”€â”€ pkg â””â”€â”€ apis â””â”€â”€ samplecrd â”œâ”€â”€ register.go â””â”€â”€ v1 â”œâ”€â”€ doc.go â”œâ”€â”€ register.go â””â”€â”€ types.go  å…¶ä¸­ï¼Œpkg/apis/samplecrd å°±æ˜¯ API ç»„çš„åå­—ï¼Œv1 æ˜¯ç‰ˆæœ¬ï¼Œè€Œ v1 ä¸‹é¢çš„ types.go æ–‡ä»¶é‡Œï¼Œåˆ™å®šä¹‰äº† Network å¯¹è±¡çš„å®Œæ•´æè¿°ã€‚æˆ‘å·²ç»æŠŠè¿™ä¸ªé¡¹ç›®ä¸Šä¼ åˆ°äº† GitHub ä¸Šï¼Œä½ å¯ä»¥éšæ—¶å‚è€ƒã€‚\nç„¶åï¼Œæˆ‘åœ¨ pkg/apis/samplecrd ç›®å½•ä¸‹åˆ›å»ºäº†ä¸€ä¸ª register.go æ–‡ä»¶ï¼Œç”¨æ¥æ”¾ç½®åé¢è¦ç”¨åˆ°çš„å…¨å±€å˜é‡ã€‚è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š\npackage samplecrd const ( GroupName = \u0026quot;samplecrd.k8s.io\u0026quot; Version = \u0026quot;v1\u0026quot; )  æ¥ç€ï¼Œæˆ‘éœ€è¦åœ¨ pkg/apis/samplecrd ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ª doc.go æ–‡ä»¶ï¼ˆGolang çš„æ–‡æ¡£æºæ–‡ä»¶ï¼‰ã€‚è¿™ä¸ªæ–‡ä»¶é‡Œçš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š\n// +k8s:deepcopy-gen=package // +groupName=samplecrd.k8s.io package v1  åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œä½ ä¼šçœ‹åˆ° +\u0026lt;tag_name\u0026gt;[=value]æ ¼å¼çš„æ³¨é‡Šï¼Œè¿™å°±æ˜¯ Kubernetes è¿›è¡Œä»£ç ç”Ÿæˆè¦ç”¨çš„ Annotation é£æ ¼çš„æ³¨é‡Šã€‚å…¶ä¸­ï¼Œ+k8s:deepcopy-gen=package æ„æ€æ˜¯ï¼Œè¯·ä¸ºæ•´ä¸ª v1 åŒ…é‡Œçš„æ‰€æœ‰ç±»å‹å®šä¹‰è‡ªåŠ¨ç”Ÿæˆ DeepCopy æ–¹æ³•ï¼›è€Œ+groupName=samplecrd.k8s.ioï¼Œåˆ™å®šä¹‰äº†è¿™ä¸ªåŒ…å¯¹åº”çš„ API ç»„çš„åå­—ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›å®šä¹‰åœ¨ doc.go æ–‡ä»¶çš„æ³¨é‡Šï¼Œèµ·åˆ°çš„æ˜¯å…¨å±€çš„ä»£ç ç”Ÿæˆæ§åˆ¶çš„ä½œç”¨ï¼Œæ‰€ä»¥ä¹Ÿè¢«ç§°ä¸º Global Tagsã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦æ·»åŠ  types.go æ–‡ä»¶ã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å®šä¹‰ä¸€ä¸ª Network ç±»å‹åˆ°åº•æœ‰å“ªäº›å­—æ®µï¼ˆæ¯”å¦‚ï¼Œspec å­—æ®µé‡Œçš„å†…å®¹ï¼‰ã€‚è¿™ä¸ªæ–‡ä»¶çš„ä¸»è¦å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š\npackage v1 ... // +genclient // +genclient:noStatus // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object // Network describes a Network resource type Network struct { // TypeMeta is the metadata for the resource, like kind and apiversion metav1.TypeMeta `json:\u0026quot;,inline\u0026quot;` // ObjectMeta contains the metadata for the particular object, including // things like... // - name // - namespace // - self link // - labels // - ... etc ... metav1.ObjectMeta `json:\u0026quot;metadata,omitempty\u0026quot;` Spec networkspec `json:\u0026quot;spec\u0026quot;` } // networkspec is the spec for a Network resource type networkspec struct { Cidr string `json:\u0026quot;cidr\u0026quot;` Gateway string `json:\u0026quot;gateway\u0026quot;` } // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object // NetworkList is a list of Network resources type NetworkList struct { metav1.TypeMeta `json:\u0026quot;,inline\u0026quot;` metav1.ListMeta `json:\u0026quot;metadata\u0026quot;` Items []Network `json:\u0026quot;items\u0026quot;` }  åœ¨ä¸Šé¢è¿™éƒ¨åˆ†ä»£ç é‡Œï¼Œä½ å¯ä»¥çœ‹åˆ° Network ç±»å‹å®šä¹‰æ–¹æ³•è·Ÿæ ‡å‡†çš„ Kubernetes å¯¹è±¡ä¸€æ ·ï¼Œéƒ½åŒ…æ‹¬äº† TypeMetaï¼ˆAPI å…ƒæ•°æ®ï¼‰å’Œ ObjectMetaï¼ˆå¯¹è±¡å…ƒæ•°æ®ï¼‰å­—æ®µã€‚è€Œå…¶ä¸­çš„ Spec å­—æ®µï¼Œå°±æ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„éƒ¨åˆ†ã€‚æ‰€ä»¥ï¼Œåœ¨ networkspec é‡Œï¼Œæˆ‘å®šä¹‰äº† Cidr å’Œ Gateway ä¸¤ä¸ªå­—æ®µã€‚å…¶ä¸­ï¼Œæ¯ä¸ªå­—æ®µæœ€åé¢çš„éƒ¨åˆ†æ¯”å¦‚json:\u0026ldquo;cidr\u0026rdquo;ï¼ŒæŒ‡çš„å°±æ˜¯è¿™ä¸ªå­—æ®µè¢«è½¬æ¢æˆ JSON æ ¼å¼ä¹‹åçš„åå­—ï¼Œä¹Ÿå°±æ˜¯ YAML æ–‡ä»¶é‡Œçš„å­—æ®µåå­—ã€‚\næ­¤å¤–ï¼Œé™¤äº†å®šä¹‰ Network ç±»å‹ï¼Œä½ è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª NetworkList ç±»å‹ï¼Œç”¨æ¥æè¿°ä¸€ç»„ Network å¯¹è±¡åº”è¯¥åŒ…æ‹¬å“ªäº›å­—æ®µã€‚ä¹‹æ‰€ä»¥éœ€è¦è¿™æ ·ä¸€ä¸ªç±»å‹ï¼Œæ˜¯å› ä¸ºåœ¨ Kubernetes ä¸­ï¼Œè·å–æ‰€æœ‰ X å¯¹è±¡çš„ List() æ–¹æ³•ï¼Œè¿”å›å€¼éƒ½æ˜¯List ç±»å‹ï¼Œè€Œä¸æ˜¯ X ç±»å‹çš„æ•°ç»„ã€‚è¿™æ˜¯ä¸ä¸€æ ·çš„ã€‚åŒæ ·åœ°ï¼Œåœ¨ Network å’Œ NetworkList ç±»å‹ä¸Šï¼Œä¹Ÿæœ‰ä»£ç ç”Ÿæˆæ³¨é‡Šã€‚\nå…¶ä¸­ï¼Œ+genclient çš„æ„æ€æ˜¯ï¼šè¯·ä¸ºä¸‹é¢è¿™ä¸ª API èµ„æºç±»å‹ç”Ÿæˆå¯¹åº”çš„ Client ä»£ç ï¼ˆè¿™ä¸ª Clientï¼Œæˆ‘é©¬ä¸Šä¼šè®²åˆ°ï¼‰ã€‚è€Œ +genclient:noStatus çš„æ„æ€æ˜¯ï¼šè¿™ä¸ª API èµ„æºç±»å‹å®šä¹‰é‡Œï¼Œæ²¡æœ‰ Status å­—æ®µã€‚å¦åˆ™ï¼Œç”Ÿæˆçš„ Client å°±ä¼šè‡ªåŠ¨å¸¦ä¸Š UpdateStatus æ–¹æ³•ã€‚\nå¦‚æœä½ çš„ç±»å‹å®šä¹‰åŒ…æ‹¬äº† Status å­—æ®µçš„è¯ï¼Œå°±ä¸éœ€è¦è¿™å¥ +genclient:noStatus æ³¨é‡Šäº†ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\n// +genclient // Network is a specification for a Network resource type Network struct { metav1.TypeMeta `json:\u0026quot;,inline\u0026quot;` metav1.ObjectMeta `json:\u0026quot;metadata,omitempty\u0026quot;` Spec NetworkSpec `json:\u0026quot;spec\u0026quot;` Status NetworkStatus `json:\u0026quot;status\u0026quot;` }  éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ+genclient åªéœ€è¦å†™åœ¨ Network ç±»å‹ä¸Šï¼Œè€Œä¸ç”¨å†™åœ¨ NetworkList ä¸Šã€‚å› ä¸º NetworkList åªæ˜¯ä¸€ä¸ªè¿”å›å€¼ç±»å‹ï¼ŒNetwork æ‰æ˜¯â€œä¸»ç±»å‹â€ã€‚\nè€Œç”±äºæˆ‘åœ¨ Global Tags é‡Œå·²ç»å®šä¹‰äº†ä¸ºæ‰€æœ‰ç±»å‹ç”Ÿæˆ DeepCopy æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸éœ€è¦å†æ˜¾å¼åœ°åŠ ä¸Š +k8s:deepcopy-gen=true äº†ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ä½ å¯ä»¥ç”¨ +k8s:deepcopy-gen=false æ¥é˜»æ­¢ä¸ºæŸäº›ç±»å‹ç”Ÿæˆ DeepCopyã€‚\nä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œåœ¨è¿™ä¸¤ä¸ªç±»å‹ä¸Šé¢è¿˜æœ‰ä¸€å¥+k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Objectçš„æ³¨é‡Šã€‚å®ƒçš„æ„æ€æ˜¯ï¼Œè¯·åœ¨ç”Ÿæˆ DeepCopy çš„æ—¶å€™ï¼Œå®ç° Kubernetes æä¾›çš„ runtime.Object æ¥å£ã€‚å¦åˆ™ï¼Œåœ¨æŸäº›ç‰ˆæœ¬çš„ Kubernetes é‡Œï¼Œä½ çš„è¿™ä¸ªç±»å‹å®šä¹‰ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ã€‚è¿™æ˜¯ä¸€ä¸ªå›ºå®šçš„æ“ä½œï¼Œè®°ä½å³å¯ã€‚\nä¸è¿‡ï¼Œä½ æˆ–è®¸ä¼šæœ‰è¿™æ ·çš„é¡¾è™‘ï¼šè¿™äº›ä»£ç ç”Ÿæˆæ³¨é‡Šè¿™ä¹ˆçµæ´»ï¼Œæˆ‘è¯¥æ€ä¹ˆæŒæ¡å‘¢ï¼Ÿå…¶å®ï¼Œä¸Šé¢æˆ‘æ‰€è®²è¿°çš„å†…å®¹ï¼Œå·²ç»è¶³ä»¥åº”å¯¹ 99% çš„åœºæ™¯äº†ã€‚å½“ç„¶ï¼Œå¦‚æœä½ å¯¹ä»£ç ç”Ÿæˆæ„Ÿå…´è¶£çš„è¯ï¼Œæˆ‘æ¨èä½ é˜…è¯»è¿™ç¯‡åšå®¢ï¼Œå®ƒè¯¦ç»†åœ°ä»‹ç»äº† Kubernetes çš„ä»£ç ç”Ÿæˆè¯­æ³•ã€‚\næœ€åï¼Œæˆ‘éœ€è¦å†ç¼–å†™ä¸€ä¸ª pkg/apis/samplecrd/v1/register.go æ–‡ä»¶ã€‚\nåœ¨å‰é¢å¯¹ APIServer å·¥ä½œåŸç†çš„è®²è§£ä¸­ï¼Œæˆ‘å·²ç»æåˆ°ï¼Œâ€œregistryâ€çš„ä½œç”¨å°±æ˜¯æ³¨å†Œä¸€ä¸ªç±»å‹ï¼ˆTypeï¼‰ç»™ APIServerã€‚å…¶ä¸­ï¼ŒNetwork èµ„æºç±»å‹åœ¨æœåŠ¡å™¨ç«¯æ³¨å†Œçš„å·¥ä½œï¼ŒAPIServer ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆã€‚ä½†ä¸ä¹‹å¯¹åº”çš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®©å®¢æˆ·ç«¯ä¹Ÿèƒ½â€œçŸ¥é“â€Network èµ„æºç±»å‹çš„å®šä¹‰ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬åœ¨é¡¹ç›®é‡Œæ·»åŠ ä¸€ä¸ª register.go æ–‡ä»¶ã€‚å®ƒæœ€ä¸»è¦çš„åŠŸèƒ½ï¼Œå°±æ˜¯å®šä¹‰äº†å¦‚ä¸‹æ‰€ç¤ºçš„ addKnownTypes() æ–¹æ³•ï¼š\npackage v1 ... // addKnownTypes adds our types to the API scheme by registering // Network and NetworkList func addKnownTypes(scheme *runtime.Scheme) error { scheme.AddKnownTypes( SchemeGroupVersion, \u0026amp;Network{}, \u0026amp;NetworkList{}, ) // register the type in the scheme metav1.AddToGroupVersion(scheme, SchemeGroupVersion) return nil }  æœ‰äº†è¿™ä¸ªæ–¹æ³•ï¼ŒKubernetes å°±èƒ½å¤Ÿåœ¨åé¢ç”Ÿæˆå®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œâ€œçŸ¥é“â€Network ä»¥åŠ NetworkList ç±»å‹çš„å®šä¹‰äº†ã€‚åƒä¸Šé¢è¿™ç§ register.go æ–‡ä»¶é‡Œçš„å†…å®¹å…¶å®æ˜¯éå¸¸å›ºå®šçš„ï¼Œä½ ä»¥åå¯ä»¥ç›´æ¥ä½¿ç”¨æˆ‘æä¾›çš„è¿™éƒ¨åˆ†ä»£ç åšæ¨¡æ¿ï¼Œç„¶åæŠŠå…¶ä¸­çš„èµ„æºç±»å‹ã€GroupName å’Œ Version æ›¿æ¢æˆä½ è‡ªå·±çš„å®šä¹‰å³å¯ã€‚\nè¿™æ ·ï¼ŒNetwork å¯¹è±¡çš„å®šä¹‰å·¥ä½œå°±å…¨éƒ¨å®Œæˆäº†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå…¶å®å®šä¹‰äº†ä¸¤éƒ¨åˆ†å†…å®¹ï¼š\n ç¬¬ä¸€éƒ¨åˆ†æ˜¯ï¼Œè‡ªå®šä¹‰èµ„æºç±»å‹çš„ API æè¿°ï¼ŒåŒ…æ‹¬ï¼šç»„ï¼ˆGroupï¼‰ã€ç‰ˆæœ¬ï¼ˆVersionï¼‰ã€èµ„æºç±»å‹ï¼ˆResourceï¼‰ç­‰ã€‚è¿™ç›¸å½“äºå‘Šè¯‰äº†è®¡ç®—æœºï¼šå…”å­æ˜¯å“ºä¹³åŠ¨ç‰©ã€‚ ç¬¬äºŒéƒ¨åˆ†æ˜¯ï¼Œè‡ªå®šä¹‰èµ„æºç±»å‹çš„å¯¹è±¡æè¿°ï¼ŒåŒ…æ‹¬ï¼šSpecã€Status ç­‰ã€‚è¿™ç›¸å½“äºå‘Šè¯‰äº†è®¡ç®—æœºï¼šå…”å­æœ‰é•¿è€³æœµå’Œä¸‰ç“£å˜´ã€‚  æ¥ä¸‹æ¥ï¼Œæˆ‘å°±è¦ä½¿ç”¨ Kubernetes æä¾›çš„ä»£ç ç”Ÿæˆå·¥å…·ï¼Œä¸ºä¸Šé¢å®šä¹‰çš„ Network èµ„æºç±»å‹è‡ªåŠ¨ç”Ÿæˆ clientsetã€informer å’Œ listerã€‚å…¶ä¸­ï¼Œclientset å°±æ˜¯æ“ä½œ Network å¯¹è±¡æ‰€éœ€è¦ä½¿ç”¨çš„å®¢æˆ·ç«¯ï¼Œè€Œ informer å’Œ lister è¿™ä¸¤ä¸ªåŒ…çš„ä¸»è¦åŠŸèƒ½ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­é‡ç‚¹è®²è§£ã€‚\nè¿™ä¸ªä»£ç ç”Ÿæˆå·¥å…·åå«k8s.io/code-generatorï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š\n# ä»£ç ç”Ÿæˆçš„å·¥ä½œç›®å½•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„é¡¹ç›®è·¯å¾„ $ ROOT_PACKAGE=\u0026quot;github.com/resouer/k8s-controller-custom-resource\u0026quot; # API Group $ CUSTOM_RESOURCE_NAME=\u0026quot;samplecrd\u0026quot; # API Version $ CUSTOM_RESOURCE_VERSION=\u0026quot;v1\u0026quot; # å®‰è£…k8s.io/code-generator $ go get -u k8s.io/code-generator/... $ cd $GOPATH/src/k8s.io/code-generator # æ‰§è¡Œä»£ç è‡ªåŠ¨ç”Ÿæˆï¼Œå…¶ä¸­pkg/clientæ˜¯ç”Ÿæˆç›®æ ‡ç›®å½•ï¼Œpkg/apisæ˜¯ç±»å‹å®šä¹‰ç›®å½• $ ./generate-groups.sh all \u0026quot;$ROOT_PACKAGE/pkg/client\u0026quot; \u0026quot;$ROOT_PACKAGE/pkg/apis\u0026quot; \u0026quot;$CUSTOM_RESOURCE_NAME:$CUSTOM_RESOURCE_VERSION\u0026quot;  ä»£ç ç”Ÿæˆå·¥ä½œå®Œæˆä¹‹åï¼Œæˆ‘ä»¬å†æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®çš„ç›®å½•ç»“æ„ï¼š\n$ tree . â”œâ”€â”€ controller.go â”œâ”€â”€ crd â”‚ â””â”€â”€ network.yaml â”œâ”€â”€ example â”‚ â””â”€â”€ example-network.yaml â”œâ”€â”€ main.go â””â”€â”€ pkg â”œâ”€â”€ apis â”‚ â””â”€â”€ samplecrd â”‚ â”œâ”€â”€ constants.go â”‚ â””â”€â”€ v1 â”‚ â”œâ”€â”€ doc.go â”‚ â”œâ”€â”€ register.go â”‚ â”œâ”€â”€ types.go â”‚ â””â”€â”€ zz_generated.deepcopy.go â””â”€â”€ client â”œâ”€â”€ clientset â”œâ”€â”€ informers â””â”€â”€ listers  å…¶ä¸­ï¼Œpkg/apis/samplecrd/v1 ä¸‹é¢çš„ zz_generated.deepcopy.go æ–‡ä»¶ï¼Œå°±æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ DeepCopy ä»£ç æ–‡ä»¶ã€‚è€Œæ•´ä¸ª client ç›®å½•ï¼Œä»¥åŠä¸‹é¢çš„ä¸‰ä¸ªåŒ…ï¼ˆclientsetã€informersã€ listersï¼‰ï¼Œéƒ½æ˜¯ Kubernetes ä¸º Network ç±»å‹ç”Ÿæˆçš„å®¢æˆ·ç«¯åº“ï¼Œè¿™äº›åº“ä¼šåœ¨åé¢ç¼–å†™è‡ªå®šä¹‰æ§åˆ¶å™¨çš„æ—¶å€™ç”¨åˆ°ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåˆ°ç›®å‰ä¸ºæ­¢çš„è¿™äº›å·¥ä½œï¼Œå…¶å®å¹¶ä¸è¦æ±‚ä½ å†™å¤šå°‘ä»£ç ï¼Œä¸»è¦è€ƒéªŒçš„æ˜¯â€œå¤åˆ¶ã€ç²˜è´´ã€æ›¿æ¢â€è¿™æ ·çš„â€œåŸºæœ¬åŠŸâ€ã€‚è€Œæœ‰äº†è¿™äº›å†…å®¹ï¼Œç°åœ¨ä½ å°±å¯ä»¥åœ¨ Kubernetes é›†ç¾¤é‡Œåˆ›å»ºä¸€ä¸ª Network ç±»å‹çš„ API å¯¹è±¡äº†ã€‚æˆ‘ä»¬ä¸å¦¨ä¸€èµ·æ¥è¯•éªŒä¸‹ã€‚\né¦–å…ˆï¼Œä½¿ç”¨ network.yaml æ–‡ä»¶ï¼Œåœ¨ Kubernetes ä¸­åˆ›å»º Network å¯¹è±¡çš„ CRDï¼ˆCustom Resource Definitionï¼‰ï¼š\n$ kubectl apply -f crd/network.yaml customresourcedefinition.apiextensions.k8s.io/networks.samplecrd.k8s.io created  è¿™ä¸ªæ“ä½œï¼Œå°±å‘Šè¯‰äº† Kubernetesï¼Œæˆ‘ç°åœ¨è¦æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„ API å¯¹è±¡ã€‚è€Œè¿™ä¸ªå¯¹è±¡çš„ API ä¿¡æ¯ï¼Œæ­£æ˜¯ network.yaml é‡Œå®šä¹‰çš„å†…å®¹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ kubectl get å‘½ä»¤ï¼ŒæŸ¥çœ‹è¿™ä¸ª CRDï¼š\n$ kubectl get crd NAME CREATED AT networks.samplecrd.k8s.io 2018-09-15T10:57:12Z  ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ª Network å¯¹è±¡äº†ï¼Œè¿™é‡Œç”¨åˆ°çš„æ˜¯ example-network.yamlï¼š\n$ kubectl apply -f example/example-network.yaml network.samplecrd.k8s.io/example-network created  é€šè¿‡è¿™ä¸ªæ“ä½œï¼Œä½ å°±åœ¨ Kubernetes é›†ç¾¤é‡Œåˆ›å»ºäº†ä¸€ä¸ª Network å¯¹è±¡ã€‚å®ƒçš„ API èµ„æºè·¯å¾„æ˜¯samplecrd.k8s.io/v1/networksã€‚è¿™æ—¶å€™ï¼Œä½ å°±å¯ä»¥é€šè¿‡ kubectl get å‘½ä»¤ï¼ŒæŸ¥çœ‹åˆ°æ–°åˆ›å»ºçš„ Network å¯¹è±¡ï¼š\n$ kubectl get network NAME AGE example-network 8s  ä½ è¿˜å¯ä»¥é€šè¿‡ kubectl describe å‘½ä»¤ï¼Œçœ‹åˆ°è¿™ä¸ª Network å¯¹è±¡çš„ç»†èŠ‚ï¼š\n$ kubectl describe network example-network Name: example-network Namespace: default Labels: \u0026lt;none\u0026gt; ...API Version: samplecrd.k8s.io/v1 Kind: Network Metadata: ... Generation: 1 Resource Version: 468239 ... Spec: Cidr: 192.168.0.0/16 Gateway: 192.168.0.1  å½“ç„¶ ï¼Œä½ ä¹Ÿå¯ä»¥ç¼–å†™æ›´å¤šçš„ YAML æ–‡ä»¶æ¥åˆ›å»ºæ›´å¤šçš„ Network å¯¹è±¡ï¼Œè¿™å’Œåˆ›å»º Podã€Deployment çš„æ“ä½œï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚\næ€»ç»“\nåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ºä½ è¯¦ç»†è§£æäº† Kubernetes å£°æ˜å¼ API çš„å·¥ä½œåŸç†ï¼Œè®²è§£äº†å¦‚ä½•éµå¾ªå£°æ˜å¼ API çš„è®¾è®¡ï¼Œä¸º Kubernetes æ·»åŠ ä¸€ä¸ªåå« Network çš„ API èµ„æºç±»å‹ã€‚ä»è€Œè¾¾åˆ°äº†é€šè¿‡æ ‡å‡†çš„ kubectl create å’Œ get æ“ä½œï¼Œæ¥ç®¡ç†è‡ªå®šä¹‰ API å¯¹è±¡çš„ç›®çš„ã€‚ä¸è¿‡ï¼Œåˆ›å»ºå‡ºè¿™æ ·ä¸€ä¸ªè‡ªå®šä¹‰ API å¯¹è±¡ï¼Œæˆ‘ä»¬åªæ˜¯å®Œæˆäº† Kubernetes å£°æ˜å¼ API çš„ä¸€åŠå·¥ä½œã€‚æ¥ä¸‹æ¥çš„å¦ä¸€åŠå·¥ä½œæ˜¯ï¼šä¸ºè¿™ä¸ª API å¯¹è±¡ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰æ§åˆ¶å™¨ï¼ˆCustom Controllerï¼‰ã€‚è¿™æ ·ï¼Œ Kubernetes æ‰èƒ½æ ¹æ® Network API å¯¹è±¡çš„â€œå¢ã€åˆ ã€æ”¹â€æ“ä½œï¼Œåœ¨çœŸå®ç¯å¢ƒä¸­åšå‡ºç›¸åº”çš„å“åº”ã€‚æ¯”å¦‚ï¼Œâ€œåˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹â€çœŸæ­£çš„ Neutron ç½‘ç»œã€‚è€Œè¿™ï¼Œæ­£æ˜¯ Network è¿™ä¸ª API å¯¹è±¡æ‰€å…³æ³¨çš„â€œä¸šåŠ¡é€»è¾‘â€ã€‚è¿™ä¸ªä¸šåŠ¡é€»è¾‘çš„å®ç°è¿‡ç¨‹ï¼Œä»¥åŠå®ƒæ‰€ä½¿ç”¨çš„ Kubernetes API ç¼–ç¨‹åº“çš„å·¥ä½œåŸç†ï¼Œå°±æ˜¯æˆ‘è¦åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è®²è§£çš„ä¸»è¦å†…å®¹ã€‚\næ€è€ƒé¢˜\nåœ¨äº†è§£äº† CRD çš„å®šä¹‰æ–¹æ³•ä¹‹åï¼Œä½ æ˜¯å¦å·²ç»åœ¨è€ƒè™‘ä½¿ç”¨ CRDï¼ˆæˆ–è€…å·²ç»ä½¿ç”¨äº† CRDï¼‰æ¥æè¿°ç°å®ä¸­çš„æŸç§å®ä½“äº†å‘¢ï¼Ÿèƒ½å¦åˆ†äº«ä¸€ä¸‹ä½ çš„æ€è·¯ï¼Ÿï¼ˆä¸¾ä¸ªä¾‹å­ï¼šæŸæŠ€æœ¯å›¢é˜Ÿä½¿ç”¨ CRD æè¿°äº†â€œå®¿ä¸»æœºâ€ï¼Œç„¶åç”¨ Kubernetes éƒ¨ç½²äº† Kubernetesï¼‰\nå‚è€ƒ\nk8s build\n","date":"2021å¹´03æœˆ12æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/api-object/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹ï¼Œæœ¬èŠ‚ä¸»è¦æ˜¯å…³äºè‡ªå®šä¹‰APIèµ„æº(CRD)ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e","title":"æ·±å…¥è§£æå£°æ˜å¼APIï¼ˆä¸€ï¼‰ï¼šAPIå¯¹è±¡çš„å¥¥ç§˜"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹ï¼Œæœ¬èŠ‚ä¸»è¦æ˜¯å…³äºå£°æ˜å¼ API ä¸ Kubernetes ç¼–ç¨‹èŒƒå¼ã€‚\n åœ¨å‰é¢çš„å‡ ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å’Œä½ åˆ†äº«äº†å¾ˆå¤š Kubernetes çš„ API å¯¹è±¡ã€‚è¿™äº› API å¯¹è±¡ï¼Œæœ‰çš„æ˜¯ç”¨æ¥æè¿°åº”ç”¨ï¼Œæœ‰çš„åˆ™æ˜¯ä¸ºåº”ç”¨æä¾›å„ç§å„æ ·çš„æœåŠ¡ã€‚ä½†æ˜¯ï¼Œæ— ä¸€ä¾‹å¤–åœ°ï¼Œä¸ºäº†ä½¿ç”¨è¿™äº› API å¯¹è±¡æä¾›çš„èƒ½åŠ›ï¼Œä½ éƒ½éœ€è¦ç¼–å†™ä¸€ä¸ªå¯¹åº”çš„ YAML æ–‡ä»¶äº¤ç»™ Kubernetesã€‚\nè¿™ä¸ª YAML æ–‡ä»¶ï¼Œæ­£æ˜¯ Kubernetes å£°æ˜å¼ API æ‰€å¿…é¡»å…·å¤‡çš„ä¸€ä¸ªè¦ç´ ã€‚ä¸è¿‡ï¼Œæ˜¯ä¸æ˜¯åªè¦ç”¨ YAML æ–‡ä»¶ä»£æ›¿äº†å‘½ä»¤è¡Œæ“ä½œï¼Œå°±æ˜¯å£°æ˜å¼ API äº†å‘¢ï¼Ÿ\nä¸¾ä¸ªä¾‹å­ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒDocker Swarm çš„ç¼–æ’æ“ä½œéƒ½æ˜¯åŸºäºå‘½ä»¤è¡Œçš„ï¼Œæ¯”å¦‚ï¼š\n$ docker service create --name nginx --replicas 2 nginx $ docker service update --image nginx:1.7.9 nginx  åƒè¿™æ ·çš„ä¸¤æ¡å‘½ä»¤ï¼Œå°±æ˜¯ç”¨ Docker Swarm å¯åŠ¨äº†ä¸¤ä¸ª Nginx å®¹å™¨å®ä¾‹ã€‚å…¶ä¸­ï¼Œç¬¬ä¸€æ¡ create å‘½ä»¤åˆ›å»ºäº†è¿™ä¸¤ä¸ªå®¹å™¨ï¼Œè€Œç¬¬äºŒæ¡ update å‘½ä»¤åˆ™æŠŠå®ƒä»¬â€œæ»šåŠ¨æ›´æ–°â€æˆäº†ä¸€ä¸ªæ–°çš„é•œåƒã€‚\nå¯¹äºè¿™ç§ä½¿ç”¨æ–¹å¼ï¼Œæˆ‘ä»¬ç§°ä¸ºå‘½ä»¤å¼å‘½ä»¤è¡Œæ“ä½œã€‚\né‚£ä¹ˆï¼Œåƒä¸Šé¢è¿™æ ·çš„åˆ›å»ºå’Œæ›´æ–°ä¸¤ä¸ª Nginx å®¹å™¨çš„æ“ä½œï¼Œåœ¨ Kubernetes é‡Œåˆè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™ä¸ªæµç¨‹ï¼Œç›¸ä¿¡ä½ å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼šæˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°ç¼–å†™ä¸€ä¸ª Deployment çš„ YAML æ–‡ä»¶ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment spec: selector: matchLabels: app: nginx replicas: 2 template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80  ç„¶åï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨ kubectl create å‘½ä»¤åœ¨ Kubernetes é‡Œåˆ›å»ºè¿™ä¸ª Deployment å¯¹è±¡ï¼š\n$ kubectl create -f nginx.yaml  è¿™æ ·ï¼Œä¸¤ä¸ª Nginx çš„ Pod å°±ä¼šè¿è¡Œèµ·æ¥äº†ã€‚è€Œå¦‚æœè¦æ›´æ–°è¿™ä¸¤ä¸ª Pod ä½¿ç”¨çš„ Nginx é•œåƒï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å‰é¢æ›¾ç»ä½¿ç”¨è¿‡ kubectl set image å’Œ kubectl edit å‘½ä»¤ï¼Œæ¥ç›´æ¥ä¿®æ”¹ Kubernetes é‡Œçš„ API å¯¹è±¡ã€‚ä¸è¿‡ï¼Œç›¸ä¿¡å¾ˆå¤šäººéƒ½æœ‰è¿™æ ·çš„æƒ³æ³•ï¼Œæˆ‘èƒ½ä¸èƒ½é€šè¿‡ä¿®æ”¹æœ¬åœ° YAML æ–‡ä»¶æ¥å®Œæˆè¿™ä¸ªæ“ä½œå‘¢ï¼Ÿè¿™æ ·æˆ‘çš„æ”¹åŠ¨å°±ä¼šä½“ç°åœ¨è¿™ä¸ªæœ¬åœ° YAML æ–‡ä»¶é‡Œäº†ã€‚å½“ç„¶å¯ä»¥ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¿™ä¸ª YAML æ–‡ä»¶é‡Œçš„ Pod æ¨¡æ¿éƒ¨åˆ†ï¼ŒæŠŠ Nginx å®¹å™¨çš„é•œåƒæ”¹æˆ 1.7.9ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n... spec: containers: - name: nginx image: nginx:1.7.9  è€Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œä¸€å¥ kubectl replace æ“ä½œï¼Œæ¥å®Œæˆè¿™ä¸ª Deployment çš„æ›´æ–°ï¼š\n$ kubectl replace -f nginx.yaml  å¯æ˜¯ï¼Œä¸Šé¢è¿™ç§åŸºäº YAML æ–‡ä»¶çš„æ“ä½œæ–¹å¼ï¼Œæ˜¯â€œå£°æ˜å¼ APIâ€å—ï¼Ÿå¹¶ä¸æ˜¯ã€‚å¯¹äºä¸Šé¢è¿™ç§å…ˆ kubectl createï¼Œå† replace çš„æ“ä½œï¼Œæˆ‘ä»¬ç§°ä¸ºå‘½ä»¤å¼é…ç½®æ–‡ä»¶æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒçš„å¤„ç†æ–¹å¼ï¼Œå…¶å®è·Ÿå‰é¢ Docker Swarm çš„ä¸¤å¥å‘½ä»¤ï¼Œæ²¡ä»€ä¹ˆæœ¬è´¨ä¸Šçš„åŒºåˆ«ã€‚åªä¸è¿‡ï¼Œå®ƒæ˜¯æŠŠ Docker å‘½ä»¤è¡Œé‡Œçš„å‚æ•°ï¼Œå†™åœ¨äº†é…ç½®æ–‡ä»¶é‡Œè€Œå·²ã€‚\né‚£ä¹ˆï¼Œåˆ°åº•ä»€ä¹ˆæ‰æ˜¯â€œå£°æ˜å¼ APIâ€å‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯ï¼Œkubectl apply å‘½ä»¤ã€‚\nåœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘æ›¾ç»æåˆ°è¿‡è¿™ä¸ª kubectl apply å‘½ä»¤ï¼Œå¹¶æ¨èä½ ä½¿ç”¨å®ƒæ¥ä»£æ›¿ kubectl create å‘½ä»¤,ç°åœ¨ï¼Œæˆ‘å°±ä½¿ç”¨ kubectl apply å‘½ä»¤æ¥åˆ›å»ºè¿™ä¸ª Deploymentï¼š\n$ kubectl apply -f nginx.yaml  è¿™æ ·ï¼ŒNginx çš„ Deployment å°±è¢«åˆ›å»ºäº†å‡ºæ¥ï¼Œè¿™çœ‹èµ·æ¥è·Ÿ kubectl create çš„æ•ˆæœä¸€æ ·ã€‚\nç„¶åï¼Œæˆ‘å†ä¿®æ”¹ä¸€ä¸‹ nginx.yaml é‡Œå®šä¹‰çš„é•œåƒï¼š\n... spec: containers: - name: nginx image: nginx:1.7.9  è¿™æ—¶å€™ï¼Œå…³é”®æ¥äº†ã€‚åœ¨ä¿®æ”¹å®Œè¿™ä¸ª YAML æ–‡ä»¶ä¹‹åï¼Œæˆ‘ä¸å†ä½¿ç”¨ kubectl replace å‘½ä»¤è¿›è¡Œæ›´æ–°ï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œä¸€æ¡ kubectl apply å‘½ä»¤ï¼Œå³ï¼š\n$ kubectl apply -f nginx.yaml  è¿™æ—¶ï¼ŒKubernetes å°±ä¼šç«‹å³è§¦å‘è¿™ä¸ª Deployment çš„â€œæ»šåŠ¨æ›´æ–°â€ã€‚å¯æ˜¯ï¼Œå®ƒè·Ÿ kubectl replace å‘½ä»¤æœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«å—ï¼Ÿ\nå®é™…ä¸Šï¼Œä½ å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºï¼Œkubectl replace çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯ä½¿ç”¨æ–°çš„ YAML æ–‡ä»¶ä¸­çš„ API å¯¹è±¡ï¼Œæ›¿æ¢åŸæœ‰çš„ API å¯¹è±¡ï¼›è€Œ kubectl applyï¼Œåˆ™æ˜¯æ‰§è¡Œäº†ä¸€ä¸ªå¯¹åŸæœ‰ API å¯¹è±¡çš„ PATCH æ“ä½œã€‚\næ›´è¿›ä¸€æ­¥åœ°ï¼Œè¿™æ„å‘³ç€ kube-apiserver åœ¨å“åº”å‘½ä»¤å¼è¯·æ±‚ï¼ˆæ¯”å¦‚ï¼Œkubectl replaceï¼‰çš„æ—¶å€™ï¼Œä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªå†™è¯·æ±‚ï¼Œå¦åˆ™ä¼šæœ‰äº§ç”Ÿå†²çªçš„å¯èƒ½ã€‚è€Œå¯¹äºå£°æ˜å¼è¯·æ±‚ï¼ˆæ¯”å¦‚ï¼Œkubectl applyï¼‰ï¼Œä¸€æ¬¡èƒ½å¤„ç†å¤šä¸ªå†™æ“ä½œï¼Œå¹¶ä¸”å…·å¤‡ Merge èƒ½åŠ›ã€‚\nè¿™ç§åŒºåˆ«ï¼Œå¯èƒ½ä¹ä¸€å¬èµ·æ¥æ²¡é‚£ä¹ˆé‡è¦ã€‚è€Œä¸”ï¼Œæ­£æ˜¯ç”±äºè¦ç…§é¡¾åˆ°è¿™æ ·çš„ API è®¾è®¡ï¼ŒåšåŒæ ·ä¸€ä»¶äº‹æƒ…ï¼ŒKubernetes éœ€è¦çš„æ­¥éª¤å¾€å¾€è¦æ¯”å…¶ä»–é¡¹ç›®å¤šä¸å°‘ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ ä»”ç»†æ€è€ƒä¸€ä¸‹ Kubernetes é¡¹ç›®çš„å·¥ä½œæµç¨‹ï¼Œå°±ä¸éš¾ä½“ä¼šåˆ°è¿™ç§å£°æ˜å¼ API çš„ç‹¬åˆ°ä¹‹å¤„ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘å°±ä»¥ Istio é¡¹ç›®ä¸ºä¾‹ï¼Œæ¥ä¸ºä½ è®²è§£ä¸€ä¸‹å£°æ˜å¼ API åœ¨å®é™…ä½¿ç”¨æ—¶çš„é‡è¦æ„ä¹‰ã€‚\nåœ¨ 2017 å¹´ 5 æœˆï¼ŒGoogleã€IBM å’Œ Lyft å…¬å¸ï¼Œå…±åŒå®£å¸ƒäº† Istio å¼€æºé¡¹ç›®çš„è¯ç”Ÿã€‚å¾ˆå¿«ï¼Œè¿™ä¸ªé¡¹ç›®å°±åœ¨æŠ€æœ¯åœˆå„¿é‡Œï¼Œæ€èµ·äº†ä¸€é˜µåå«â€œå¾®æœåŠ¡â€çš„çƒ­æ½®ï¼ŒæŠŠ Service Mesh è¿™ä¸ªæ–°çš„ç¼–æ’æ¦‚å¿µæ¨åˆ°äº†é£å£æµªå°–ã€‚è€Œ Istio é¡¹ç›®ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªåŸºäº Kubernetes é¡¹ç›®çš„å¾®æœåŠ¡æ²»ç†æ¡†æ¶ã€‚å®ƒçš„æ¶æ„éå¸¸æ¸…æ™°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nåœ¨ä¸Šé¢è¿™ä¸ªæ¶æ„å›¾ä¸­ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹åˆ° Istio é¡¹ç›®æ¶æ„çš„æ ¸å¿ƒæ‰€åœ¨ã€‚Istio æœ€æ ¹æœ¬çš„ç»„ä»¶ï¼Œæ˜¯è¿è¡Œåœ¨æ¯ä¸€ä¸ªåº”ç”¨ Pod é‡Œçš„ Envoy å®¹å™¨ã€‚è¿™ä¸ª Envoy é¡¹ç›®æ˜¯ Lyft å…¬å¸æ¨å‡ºçš„ä¸€ä¸ªé«˜æ€§èƒ½ C++ ç½‘ç»œä»£ç†ï¼Œä¹Ÿæ˜¯ Lyft å…¬å¸å¯¹ Istio é¡¹ç›®çš„å”¯ä¸€è´¡çŒ®ã€‚è€Œ Istio é¡¹ç›®ï¼Œåˆ™æŠŠè¿™ä¸ªä»£ç†æœåŠ¡ä»¥ sidecar å®¹å™¨çš„æ–¹å¼ï¼Œè¿è¡Œåœ¨äº†æ¯ä¸€ä¸ªè¢«æ²»ç†çš„åº”ç”¨ Pod ä¸­ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒPod é‡Œçš„æ‰€æœ‰å®¹å™¨éƒ½å…±äº«åŒä¸€ä¸ª Network Namespaceã€‚æ‰€ä»¥ï¼ŒEnvoy å®¹å™¨å°±èƒ½å¤Ÿé€šè¿‡é…ç½® Pod é‡Œçš„ iptables è§„åˆ™ï¼ŒæŠŠæ•´ä¸ª Pod çš„è¿›å‡ºæµé‡æ¥ç®¡ä¸‹æ¥ã€‚è¿™æ—¶å€™ï¼ŒIstio çš„æ§åˆ¶å±‚ï¼ˆControl Planeï¼‰é‡Œçš„ Pilot ç»„ä»¶ï¼Œå°±èƒ½å¤Ÿé€šè¿‡è°ƒç”¨æ¯ä¸ª Envoy å®¹å™¨çš„ APIï¼Œå¯¹è¿™ä¸ª Envoy ä»£ç†è¿›è¡Œé…ç½®ï¼Œä»è€Œå®ç°å¾®æœåŠ¡æ²»ç†ã€‚\næˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚å‡è®¾è¿™ä¸ª Istio æ¶æ„å›¾å·¦è¾¹çš„ Pod æ˜¯å·²ç»åœ¨è¿è¡Œçš„åº”ç”¨ï¼Œè€Œå³è¾¹çš„ Pod åˆ™æ˜¯æˆ‘ä»¬åˆšåˆšä¸Šçº¿çš„åº”ç”¨çš„æ–°ç‰ˆæœ¬ã€‚è¿™æ—¶å€™ï¼ŒPilot é€šè¿‡è°ƒèŠ‚è¿™ä¸¤ Pod é‡Œçš„ Envoy å®¹å™¨çš„é…ç½®ï¼Œä»è€Œå°† 90% çš„æµé‡åˆ†é…ç»™æ—§ç‰ˆæœ¬çš„åº”ç”¨ï¼Œå°† 10% çš„æµé‡åˆ†é…ç»™æ–°ç‰ˆæœ¬åº”ç”¨ï¼Œå¹¶ä¸”ï¼Œè¿˜å¯ä»¥åœ¨åç»­çš„è¿‡ç¨‹ä¸­éšæ—¶è°ƒæ•´ã€‚è¿™æ ·ï¼Œä¸€ä¸ªå…¸å‹çš„â€œç°åº¦å‘å¸ƒâ€çš„åœºæ™¯å°±å®Œæˆäº†ã€‚æ¯”å¦‚ï¼ŒIstio å¯ä»¥è°ƒèŠ‚è¿™ä¸ªæµé‡ä» 90%-10%ï¼Œæ”¹åˆ° 80%-20%ï¼Œå†åˆ° 50%-50%ï¼Œæœ€ååˆ° 0%-100%ï¼Œå°±å®Œæˆäº†è¿™ä¸ªç°åº¦å‘å¸ƒçš„è¿‡ç¨‹ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œåœ¨æ•´ä¸ªå¾®æœåŠ¡æ²»ç†çš„è¿‡ç¨‹ä¸­ï¼Œæ— è®ºæ˜¯å¯¹ Envoy å®¹å™¨çš„éƒ¨ç½²ï¼Œè¿˜æ˜¯åƒä¸Šé¢è¿™æ ·å¯¹ Envoy ä»£ç†çš„é…ç½®ï¼Œç”¨æˆ·å’Œåº”ç”¨éƒ½æ˜¯å®Œå…¨â€œæ— æ„Ÿâ€çš„ã€‚\nè¿™æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šæœ‰æ‰€ç–‘æƒ‘ï¼šIstio é¡¹ç›®æ˜æ˜éœ€è¦åœ¨æ¯ä¸ª Pod é‡Œå®‰è£…ä¸€ä¸ª Envoy å®¹å™¨ï¼Œåˆæ€ä¹ˆèƒ½åšåˆ°â€œæ— æ„Ÿâ€çš„å‘¢ï¼Ÿå®é™…ä¸Šï¼ŒIstio é¡¹ç›®ä½¿ç”¨çš„ï¼Œæ˜¯ Kubernetes ä¸­çš„ä¸€ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½ï¼Œå«ä½œ Dynamic Admission Controlã€‚\nåœ¨ Kubernetes é¡¹ç›®ä¸­ï¼Œå½“ä¸€ä¸ª Pod æˆ–è€…ä»»ä½•ä¸€ä¸ª API å¯¹è±¡è¢«æäº¤ç»™ APIServer ä¹‹åï¼Œæ€»æœ‰ä¸€äº›â€œåˆå§‹åŒ–â€æ€§è´¨çš„å·¥ä½œéœ€è¦åœ¨å®ƒä»¬è¢« Kubernetes é¡¹ç›®æ­£å¼å¤„ç†ä¹‹å‰è¿›è¡Œã€‚æ¯”å¦‚ï¼Œè‡ªåŠ¨ä¸ºæ‰€æœ‰ Pod åŠ ä¸ŠæŸäº›æ ‡ç­¾ï¼ˆLabelsï¼‰ã€‚è€Œè¿™ä¸ªâ€œåˆå§‹åŒ–â€æ“ä½œçš„å®ç°ï¼Œå€ŸåŠ©çš„æ˜¯ä¸€ä¸ªå«ä½œ Admission çš„åŠŸèƒ½ã€‚å®ƒå…¶å®æ˜¯ Kubernetes é¡¹ç›®é‡Œä¸€ç»„è¢«ç§°ä¸º Admission Controller çš„ä»£ç ï¼Œå¯ä»¥é€‰æ‹©æ€§åœ°è¢«ç¼–è¯‘è¿› APIServer ä¸­ï¼Œåœ¨ API å¯¹è±¡åˆ›å»ºä¹‹åä¼šè¢«ç«‹åˆ»è°ƒç”¨åˆ°ã€‚\nä½†è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ ç°åœ¨æƒ³è¦æ·»åŠ ä¸€äº›è‡ªå·±çš„è§„åˆ™åˆ° Admission Controllerï¼Œå°±ä¼šæ¯”è¾ƒå›°éš¾ã€‚å› ä¸ºï¼Œè¿™è¦æ±‚é‡æ–°ç¼–è¯‘å¹¶é‡å¯ APIServerã€‚æ˜¾ç„¶ï¼Œè¿™ç§ä½¿ç”¨æ–¹æ³•å¯¹ Istio æ¥è¯´ï¼Œå½±å“å¤ªå¤§äº†ã€‚æ‰€ä»¥ï¼ŒKubernetes é¡¹ç›®ä¸ºæˆ‘ä»¬é¢å¤–æä¾›äº†ä¸€ç§â€œçƒ­æ’æ‹”â€å¼çš„ Admission æœºåˆ¶ï¼Œå®ƒå°±æ˜¯ Dynamic Admission Controlï¼Œä¹Ÿå«ä½œï¼šInitializerã€‚\nç°åœ¨ï¼Œæˆ‘ç»™ä½ ä¸¾ä¸ªä¾‹å­ã€‚æ¯”å¦‚ï¼Œæˆ‘æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€ä¸ªåº”ç”¨ Podï¼š\napiVersion: v1 kind: Pod metadata: name: myapp-pod labels: app: myapp spec: containers: - name: myapp-container image: busybox command: ['sh', '-c', 'echo Hello Kubernetes! \u0026amp;\u0026amp; sleep 3600']  å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª Pod é‡Œé¢åªæœ‰ä¸€ä¸ªç”¨æˆ·å®¹å™¨ï¼Œå«ä½œï¼šmyapp-containerã€‚æ¥ä¸‹æ¥ï¼ŒIstio é¡¹ç›®è¦åšçš„ï¼Œå°±æ˜¯åœ¨è¿™ä¸ª Pod YAML è¢«æäº¤ç»™ Kubernetes ä¹‹åï¼Œåœ¨å®ƒå¯¹åº”çš„ API å¯¹è±¡é‡Œè‡ªåŠ¨åŠ ä¸Š Envoy å®¹å™¨çš„é…ç½®ï¼Œä½¿è¿™ä¸ªå¯¹è±¡å˜æˆå¦‚ä¸‹æ‰€ç¤ºçš„æ ·å­ï¼š\napiVersion: v1 kind: Pod metadata: name: myapp-pod labels: app: myapp spec: containers: - name: myapp-container image: busybox command: ['sh', '-c', 'echo Hello Kubernetes! \u0026amp;\u0026amp; sleep 3600'] - name: envoy image: lyft/envoy:845747b88f102c0fd262ab234308e9e22f693a1 command: [\u0026quot;/usr/local/bin/envoy\u0026quot;] ...  å¯ä»¥çœ‹åˆ°ï¼Œè¢« Istio å¤„ç†åçš„è¿™ä¸ª Pod é‡Œï¼Œé™¤äº†ç”¨æˆ·è‡ªå·±å®šä¹‰çš„ myapp-container å®¹å™¨ä¹‹å¤–ï¼Œå¤šå‡ºäº†ä¸€ä¸ªå«ä½œ envoy çš„å®¹å™¨ï¼Œå®ƒå°±æ˜¯ Istio è¦ä½¿ç”¨çš„ Envoy ä»£ç†ã€‚é‚£ä¹ˆï¼ŒIstio åˆæ˜¯å¦‚ä½•åœ¨ç”¨æˆ·å®Œå…¨ä¸çŸ¥æƒ…çš„å‰æä¸‹å®Œæˆè¿™ä¸ªæ“ä½œçš„å‘¢ï¼ŸIstio è¦åšçš„ï¼Œå°±æ˜¯ç¼–å†™ä¸€ä¸ªç”¨æ¥ä¸º Podâ€œè‡ªåŠ¨æ³¨å…¥â€Envoy å®¹å™¨çš„ Initializerã€‚\né¦–å…ˆï¼ŒIstio ä¼šå°†è¿™ä¸ª Envoy å®¹å™¨æœ¬èº«çš„å®šä¹‰ï¼Œä»¥ ConfigMap çš„æ–¹å¼ä¿å­˜åœ¨ Kubernetes å½“ä¸­ã€‚è¿™ä¸ª ConfigMapï¼ˆåå«ï¼šenvoy-initializerï¼‰çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: v1 kind: ConfigMap metadata: name: envoy-initializer data: config: | containers: - name: envoy image: lyft/envoy:845747db88f102c0fd262ab234308e9e22f693a1 command: [\u0026quot;/usr/local/bin/envoy\u0026quot;] args: - \u0026quot;--concurrency 4\u0026quot; - \u0026quot;--config-path /etc/envoy/envoy.json\u0026quot; - \u0026quot;--mode serve\u0026quot; ports: - containerPort: 80 protocol: TCP resources: limits: cpu: \u0026quot;1000m\u0026quot; memory: \u0026quot;512Mi\u0026quot; requests: cpu: \u0026quot;100m\u0026quot; memory: \u0026quot;64Mi\u0026quot; volumeMounts: - name: envoy-conf mountPath: /etc/envoy volumes: - name: envoy-conf configMap: name: envoy  ç›¸ä¿¡ä½ å·²ç»æ³¨æ„åˆ°äº†ï¼Œè¿™ä¸ª ConfigMap çš„ data éƒ¨åˆ†ï¼Œæ­£æ˜¯ä¸€ä¸ª Pod å¯¹è±¡çš„ä¸€éƒ¨åˆ†å®šä¹‰ã€‚å…¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Envoy å®¹å™¨å¯¹åº”çš„ containers å­—æ®µï¼Œä»¥åŠä¸€ä¸ªç”¨æ¥å£°æ˜ Envoy é…ç½®æ–‡ä»¶çš„ volumes å­—æ®µã€‚ä¸éš¾æƒ³åˆ°ï¼ŒInitializer è¦åšçš„å·¥ä½œï¼Œå°±æ˜¯æŠŠè¿™éƒ¨åˆ† Envoy ç›¸å…³çš„å­—æ®µï¼Œè‡ªåŠ¨æ·»åŠ åˆ°ç”¨æˆ·æäº¤çš„ Pod çš„ API å¯¹è±¡é‡Œã€‚å¯æ˜¯ï¼Œç”¨æˆ·æäº¤çš„ Pod é‡Œæœ¬æ¥å°±æœ‰ containers å­—æ®µå’Œ volumes å­—æ®µï¼Œæ‰€ä»¥ Kubernetes åœ¨å¤„ç†è¿™æ ·çš„æ›´æ–°è¯·æ±‚æ—¶ï¼Œå°±å¿…é¡»ä½¿ç”¨ç±»ä¼¼äº git merge è¿™æ ·çš„æ“ä½œï¼Œæ‰èƒ½å°†è¿™ä¸¤éƒ¨åˆ†å†…å®¹åˆå¹¶åœ¨ä¸€èµ·ã€‚æ‰€ä»¥è¯´ï¼Œåœ¨ Initializer æ›´æ–°ç”¨æˆ·çš„ Pod å¯¹è±¡çš„æ—¶å€™ï¼Œå¿…é¡»ä½¿ç”¨ PATCH API æ¥å®Œæˆã€‚è€Œè¿™ç§ PATCH APIï¼Œæ­£æ˜¯å£°æ˜å¼ API æœ€ä¸»è¦çš„èƒ½åŠ›ã€‚\næ¥ä¸‹æ¥ï¼ŒIstio å°†ä¸€ä¸ªç¼–å†™å¥½çš„ Initializerï¼Œä½œä¸ºä¸€ä¸ª Pod éƒ¨ç½²åœ¨ Kubernetes ä¸­ã€‚è¿™ä¸ª Pod çš„å®šä¹‰éå¸¸ç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: v1 kind: Pod metadata: labels: app: envoy-initializer name: envoy-initializer spec: containers: - name: envoy-initializer image: envoy-initializer:0.0.1 imagePullPolicy: Always  æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª envoy-initializer ä½¿ç”¨çš„ envoy-initializer:0.0.1 é•œåƒï¼Œå°±æ˜¯ä¸€ä¸ªäº‹å…ˆç¼–å†™å¥½çš„â€œè‡ªå®šä¹‰æ§åˆ¶å™¨â€ï¼ˆCustom Controllerï¼‰ï¼Œæˆ‘å°†ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è®²è§£å®ƒçš„ç¼–å†™æ–¹æ³•ã€‚è€Œåœ¨è¿™é‡Œï¼Œæˆ‘è¦å…ˆä¸ºä½ è§£é‡Šä¸€ä¸‹è¿™ä¸ªæ§åˆ¶å™¨çš„ä¸»è¦åŠŸèƒ½ã€‚æˆ‘æ›¾åœ¨ç¬¬ 16 ç¯‡æ–‡ç« ã€Šç¼–æ’å…¶å®å¾ˆç®€å•ï¼šè°ˆè°ˆâ€œæ§åˆ¶å™¨â€æ¨¡å‹ã€‹ä¸­å’Œä½ åˆ†äº«è¿‡ï¼Œä¸€ä¸ª Kubernetes çš„æ§åˆ¶å™¨ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªâ€œæ­»å¾ªç¯â€ï¼šå®ƒä¸æ–­åœ°è·å–â€œå®é™…çŠ¶æ€â€ï¼Œç„¶åä¸â€œæœŸæœ›çŠ¶æ€â€ä½œå¯¹æ¯”ï¼Œå¹¶ä»¥æ­¤ä¸ºä¾æ®å†³å®šä¸‹ä¸€æ­¥çš„æ“ä½œã€‚è€Œ Initializer çš„æ§åˆ¶å™¨ï¼Œä¸æ–­è·å–åˆ°çš„â€œå®é™…çŠ¶æ€â€ï¼Œå°±æ˜¯ç”¨æˆ·æ–°åˆ›å»ºçš„ Podã€‚è€Œå®ƒçš„â€œæœŸæœ›çŠ¶æ€â€ï¼Œåˆ™æ˜¯ï¼šè¿™ä¸ª Pod é‡Œè¢«æ·»åŠ äº† Envoy å®¹å™¨çš„å®šä¹‰ã€‚æˆ‘è¿˜æ˜¯ç”¨ä¸€æ®µ Go è¯­è¨€é£æ ¼çš„ä¼ªä»£ç ï¼Œæ¥ä¸ºä½ æè¿°è¿™ä¸ªæ§åˆ¶é€»è¾‘ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nfor { // è·å–æ–°åˆ›å»ºçš„Pod pod := client.GetLatestPod() // Diffä¸€ä¸‹ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡ if !isInitialized(pod) { // æ²¡æœ‰ï¼Ÿé‚£å°±æ¥åˆå§‹åŒ–ä¸€ä¸‹ doSomething(pod) } }   å¦‚æœè¿™ä¸ª Pod é‡Œé¢å·²ç»æ·»åŠ è¿‡ Envoy å®¹å™¨ï¼Œé‚£ä¹ˆå°±â€œæ”¾è¿‡â€è¿™ä¸ª Podï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªæ£€æŸ¥å‘¨æœŸã€‚ è€Œå¦‚æœè¿˜æ²¡æœ‰æ·»åŠ è¿‡ Envoy å®¹å™¨çš„è¯ï¼Œå®ƒå°±è¦è¿›è¡Œ Initialize æ“ä½œäº†ï¼Œå³ï¼šä¿®æ”¹è¯¥ Pod çš„ API å¯¹è±¡ï¼ˆdoSomething å‡½æ•°ï¼‰ã€‚  è¿™æ—¶å€™ï¼Œä½ åº”è¯¥ç«‹åˆ»èƒ½æƒ³åˆ°ï¼ŒIstio è¦å¾€è¿™ä¸ª Pod é‡Œåˆå¹¶çš„å­—æ®µï¼Œæ­£æ˜¯æˆ‘ä»¬ä¹‹å‰ä¿å­˜åœ¨ envoy-initializer è¿™ä¸ª ConfigMap é‡Œçš„æ•°æ®ï¼ˆå³ï¼šå®ƒçš„ data å­—æ®µçš„å€¼ï¼‰ã€‚æ‰€ä»¥ï¼Œåœ¨ Initializer æ§åˆ¶å™¨çš„å·¥ä½œé€»è¾‘é‡Œï¼Œå®ƒé¦–å…ˆä¼šä» APIServer ä¸­æ‹¿åˆ°è¿™ä¸ª ConfigMapï¼š\nfunc doSomething(pod) { cm := client.Get(ConfigMap, \u0026quot;envoy-initializer\u0026quot;) }  ç„¶åï¼ŒæŠŠè¿™ä¸ª ConfigMap é‡Œå­˜å‚¨çš„ containers å’Œ volumes å­—æ®µï¼Œç›´æ¥æ·»åŠ è¿›ä¸€ä¸ªç©ºçš„ Pod å¯¹è±¡é‡Œï¼š\nfunc doSomething(pod) { cm := client.Get(ConfigMap, \u0026quot;envoy-initializer\u0026quot;) newPod := Pod{} newPod.Spec.Containers = cm.Containers newPod.Spec.Volumes = cm.Volumes }  ç°åœ¨ï¼Œå…³é”®æ¥äº†ã€‚Kubernetes çš„ API åº“ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨æ–°æ—§ä¸¤ä¸ª Pod å¯¹è±¡ï¼Œç”Ÿæˆä¸€ä¸ª TwoWayMergePatchï¼š\nfunc doSomething(pod) { cm := client.Get(ConfigMap, \u0026quot;envoy-initializer\u0026quot;) newPod := Pod{} newPod.Spec.Containers = cm.Containers newPod.Spec.Volumes = cm.Volumes // ç”Ÿæˆpatchæ•°æ® patchBytes := strategicpatch.CreateTwoWayMergePatch(pod, newPod) // å‘èµ·PATCHè¯·æ±‚ï¼Œä¿®æ”¹è¿™ä¸ªpodå¯¹è±¡ client.Patch(pod.Name, patchBytes) }  æœ‰äº†è¿™ä¸ª TwoWayMergePatch ä¹‹åï¼ŒInitializer çš„ä»£ç å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ª patch çš„æ•°æ®ï¼Œè°ƒç”¨ Kubernetes çš„ Clientï¼Œå‘èµ·ä¸€ä¸ª PATCH è¯·æ±‚ã€‚\nè¿™æ ·ï¼Œä¸€ä¸ªç”¨æˆ·æäº¤çš„ Pod å¯¹è±¡é‡Œï¼Œå°±ä¼šè¢«è‡ªåŠ¨åŠ ä¸Š Envoy å®¹å™¨ç›¸å…³çš„å­—æ®µã€‚å½“ç„¶ï¼ŒKubernetes è¿˜å…è®¸ä½ é€šè¿‡é…ç½®ï¼Œæ¥æŒ‡å®šè¦å¯¹ä»€ä¹ˆæ ·çš„èµ„æºè¿›è¡Œè¿™ä¸ª Initialize æ“ä½œï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\napiVersion: admissionregistration.k8s.io/v1alpha1 kind: InitializerConfiguration metadata: name: envoy-config initializers: // è¿™ä¸ªåå­—å¿…é¡»è‡³å°‘åŒ…æ‹¬ä¸¤ä¸ª \u0026quot;.\u0026quot; - name: envoy.initializer.kubernetes.io rules: - apiGroups: - \u0026quot;\u0026quot; // å‰é¢è¯´è¿‡ï¼Œ \u0026quot;\u0026quot;å°±æ˜¯core API Groupçš„æ„æ€ apiVersions: - v1 resources: - pods  è¿™ä¸ªé…ç½®ï¼Œå°±æ„å‘³ç€ Kubernetes è¦å¯¹æ‰€æœ‰çš„ Pod è¿›è¡Œè¿™ä¸ª Initialize æ“ä½œï¼Œå¹¶ä¸”ï¼Œæˆ‘ä»¬æŒ‡å®šäº†è´Ÿè´£è¿™ä¸ªæ“ä½œçš„ Initializerï¼Œåå«ï¼šenvoy-initializerã€‚è€Œä¸€æ—¦è¿™ä¸ª InitializerConfiguration è¢«åˆ›å»ºï¼ŒKubernetes å°±ä¼šæŠŠè¿™ä¸ª Initializer çš„åå­—ï¼ŒåŠ åœ¨æ‰€æœ‰æ–°åˆ›å»ºçš„ Pod çš„ Metadata ä¸Šï¼Œæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: v1 kind: Pod metadata: initializers: pending: - name: envoy.initializer.kubernetes.io name: myapp-pod labels: app: myapp ...  å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ Podï¼Œéƒ½ä¼šè‡ªåŠ¨æºå¸¦äº† metadata.initializers.pending çš„ Metadata ä¿¡æ¯ã€‚è¿™ä¸ª Metadataï¼Œæ­£æ˜¯æ¥ä¸‹æ¥ Initializer çš„æ§åˆ¶å™¨åˆ¤æ–­è¿™ä¸ª Pod æœ‰æ²¡æœ‰æ‰§è¡Œè¿‡è‡ªå·±æ‰€è´Ÿè´£çš„åˆå§‹åŒ–æ“ä½œçš„é‡è¦ä¾æ®ï¼ˆä¹Ÿå°±æ˜¯å‰é¢ä¼ªä»£ç ä¸­ isInitialized() æ–¹æ³•çš„å«ä¹‰ï¼‰ã€‚\nè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå½“ä½ åœ¨ Initializer é‡Œå®Œæˆäº†è¦åšçš„æ“ä½œåï¼Œä¸€å®šè¦è®°å¾—å°†è¿™ä¸ª metadata.initializers.pending æ ‡å¿—æ¸…é™¤æ‰ã€‚è¿™ä¸€ç‚¹ï¼Œä½ åœ¨ç¼–å†™ Initializer ä»£ç çš„æ—¶å€™ä¸€å®šè¦éå¸¸æ³¨æ„ã€‚\næ­¤å¤–ï¼Œé™¤äº†ä¸Šé¢çš„é…ç½®æ–¹æ³•ï¼Œä½ è¿˜å¯ä»¥åœ¨å…·ä½“çš„ Pod çš„ Annotation é‡Œæ·»åŠ ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„å­—æ®µï¼Œä»è€Œå£°æ˜è¦ä½¿ç”¨æŸä¸ª Initializerï¼š\napiVersion: v1 kind: Pod metadata annotations: \u0026quot;initializer.kubernetes.io/envoy\u0026quot;: \u0026quot;true\u0026quot; ...  åœ¨è¿™ä¸ª Pod é‡Œï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ª Annotationï¼Œå†™æ˜ï¼š initializer.kubernetes.io/envoy=trueã€‚è¿™æ ·ï¼Œå°±ä¼šä½¿ç”¨åˆ°æˆ‘ä»¬å‰é¢æ‰€å®šä¹‰çš„ envoy-initializer äº†ã€‚\nä»¥ä¸Šï¼Œå°±æ˜¯å…³äº Initializer æœ€åŸºæœ¬çš„å·¥ä½œåŸç†å’Œä½¿ç”¨æ–¹æ³•äº†ã€‚ç›¸ä¿¡ä½ æ­¤æ—¶å·²ç»æ˜ç™½ï¼ŒIstio é¡¹ç›®çš„æ ¸å¿ƒï¼Œå°±æ˜¯ç”±æ— æ•°ä¸ªè¿è¡Œåœ¨åº”ç”¨ Pod ä¸­çš„ Envoy å®¹å™¨ç»„æˆçš„æœåŠ¡ä»£ç†ç½‘æ ¼ã€‚è¿™ä¹Ÿæ­£æ˜¯ Service Mesh çš„å«ä¹‰ã€‚\nè€Œè¿™ä¸ªæœºåˆ¶å¾—ä»¥å®ç°çš„åŸç†ï¼Œæ­£æ˜¯å€ŸåŠ©äº† Kubernetes èƒ½å¤Ÿå¯¹ API å¯¹è±¡è¿›è¡Œåœ¨çº¿æ›´æ–°çš„èƒ½åŠ›ï¼Œè¿™ä¹Ÿæ­£æ˜¯ Kubernetesâ€œå£°æ˜å¼ APIâ€çš„ç‹¬ç‰¹ä¹‹å¤„ï¼š\n é¦–å…ˆï¼Œæ‰€è°“â€œå£°æ˜å¼â€ï¼ŒæŒ‡çš„å°±æ˜¯æˆ‘åªéœ€è¦æäº¤ä¸€ä¸ªå®šä¹‰å¥½çš„ API å¯¹è±¡æ¥â€œå£°æ˜â€ï¼Œæˆ‘æ‰€æœŸæœ›çš„çŠ¶æ€æ˜¯ä»€ä¹ˆæ ·å­ã€‚ å…¶æ¬¡ï¼Œâ€œå£°æ˜å¼ APIâ€å…è®¸æœ‰å¤šä¸ª API å†™ç«¯ï¼Œä»¥ PATCH çš„æ–¹å¼å¯¹ API å¯¹è±¡è¿›è¡Œä¿®æ”¹ï¼Œè€Œæ— éœ€å…³å¿ƒæœ¬åœ°åŸå§‹ YAML æ–‡ä»¶çš„å†…å®¹ã€‚ æœ€åï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„ï¼Œæœ‰äº†ä¸Šè¿°ä¸¤ä¸ªèƒ½åŠ›ï¼ŒKubernetes é¡¹ç›®æ‰å¯ä»¥åŸºäºå¯¹ API å¯¹è±¡çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ï¼Œåœ¨å®Œå…¨æ— éœ€å¤–ç•Œå¹²é¢„çš„æƒ…å†µä¸‹ï¼Œå®Œæˆå¯¹â€œå®é™…çŠ¶æ€â€å’Œâ€œæœŸæœ›çŠ¶æ€â€çš„è°ƒè°ï¼ˆReconcileï¼‰è¿‡ç¨‹ã€‚  æ‰€ä»¥è¯´ï¼Œå£°æ˜å¼ APIï¼Œæ‰æ˜¯ Kubernetes é¡¹ç›®ç¼–æ’èƒ½åŠ›â€œèµ–ä»¥ç”Ÿå­˜â€çš„æ ¸å¿ƒæ‰€åœ¨ï¼Œå¸Œæœ›ä½ èƒ½å¤Ÿè®¤çœŸç†è§£ã€‚\næ­¤å¤–ï¼Œä¸éš¾çœ‹åˆ°ï¼Œæ— è®ºæ˜¯å¯¹ sidecar å®¹å™¨çš„å·§å¦™è®¾è®¡ï¼Œè¿˜æ˜¯å¯¹ Initializer çš„åˆç†åˆ©ç”¨ï¼ŒIstio é¡¹ç›®çš„è®¾è®¡ä¸å®ç°ï¼Œå…¶å®éƒ½ä¾æ‰˜äº Kubernetes çš„å£°æ˜å¼ API å’Œå®ƒæ‰€æä¾›çš„å„ç§ç¼–æ’èƒ½åŠ›ã€‚å¯ä»¥è¯´ï¼ŒIstio æ˜¯åœ¨ Kubernetes é¡¹ç›®ä½¿ç”¨ä¸Šçš„ä¸€ä½â€œé›†å¤§æˆè€…â€ã€‚\n è¦çŸ¥é“ï¼Œä¸€ä¸ª Istio é¡¹ç›®éƒ¨ç½²å®Œæˆåï¼Œä¼šåœ¨ Kubernetes é‡Œåˆ›å»ºå¤§çº¦ 43 ä¸ª API å¯¹è±¡ã€‚\n æ‰€ä»¥ï¼ŒKubernetes ç¤¾åŒºä¹Ÿçœ‹å¾—å¾ˆæ˜ç™½ï¼šIstio é¡¹ç›®æœ‰å¤šç«çƒ­ï¼Œå°±è¯´æ˜ Kubernetes è¿™å¥—â€œå£°æ˜å¼ APIâ€æœ‰å¤šæˆåŠŸã€‚è¿™ï¼Œæ—¢æ˜¯ Google Cloud å–œé—»ä¹è§çš„äº‹æƒ…ï¼Œä¹Ÿæ˜¯ Istio é¡¹ç›®ä¸€æ¨å‡ºå°±è¢« Google å…¬å¸å’Œæ•´ä¸ªæŠ€æœ¯åœˆå„¿çƒ­æ§çš„é‡è¦åŸå› ã€‚\nè€Œåœ¨ä½¿ç”¨ Initializer çš„æµç¨‹ä¸­ï¼Œæœ€æ ¸å¿ƒçš„æ­¥éª¤ï¼Œè«è¿‡äº Initializerâ€œè‡ªå®šä¹‰æ§åˆ¶å™¨â€çš„ç¼–å†™è¿‡ç¨‹ã€‚å®ƒéµå¾ªçš„ï¼Œæ­£æ˜¯æ ‡å‡†çš„â€œKubernetes ç¼–ç¨‹èŒƒå¼â€ï¼Œ å³ï¼š\n å¦‚ä½•ä½¿ç”¨æ§åˆ¶å™¨æ¨¡å¼ï¼ŒåŒ Kubernetes é‡Œ API å¯¹è±¡çš„â€œå¢ã€åˆ ã€æ”¹ã€æŸ¥â€è¿›è¡Œåä½œï¼Œè¿›è€Œå®Œæˆç”¨æˆ·ä¸šåŠ¡é€»è¾‘çš„ç¼–å†™è¿‡ç¨‹\n è¿™ï¼Œä¹Ÿæ­£æ˜¯æˆ‘è¦åœ¨åé¢æ–‡ç« ä¸­ä¸ºä½ è¯¦ç»†è®²è§£çš„å†…å®¹ã€‚\næ€»ç»“\nåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ºä½ é‡ç‚¹è®²è§£äº† Kubernetes å£°æ˜å¼ API çš„å«ä¹‰ã€‚å¹¶ä¸”ï¼Œé€šè¿‡å¯¹ Istio é¡¹ç›®çš„å‰–æï¼Œæˆ‘ä¸ºä½ è¯´æ˜äº†å®ƒä½¿ç”¨ Kubernetes çš„ Initializer ç‰¹æ€§ï¼Œå®Œæˆ Envoy å®¹å™¨â€œè‡ªåŠ¨æ³¨å…¥â€çš„åŸç†ã€‚äº‹å®ä¸Šï¼Œä»â€œä½¿ç”¨ Kubernetes éƒ¨ç½²ä»£ç â€ï¼Œåˆ°â€œä½¿ç”¨ Kubernetes ç¼–å†™ä»£ç â€çš„èœ•å˜è¿‡ç¨‹ï¼Œæ­£æ˜¯ä½ ä»ä¸€ä¸ª Kubernetes ç”¨æˆ·ï¼Œåˆ° Kubernetes ç©å®¶çš„æ™‹çº§ä¹‹è·¯ã€‚è€Œï¼Œå¦‚ä½•ç†è§£â€œKubernetes ç¼–ç¨‹èŒƒå¼â€ï¼Œå¦‚ä½•ä¸º Kubernetes æ·»åŠ è‡ªå®šä¹‰ API å¯¹è±¡ï¼Œç¼–å†™è‡ªå®šä¹‰æ§åˆ¶å™¨ï¼Œæ­£æ˜¯è¿™ä¸ªæ™‹çº§è¿‡ç¨‹ä¸­çš„å…³é”®ç‚¹ï¼Œä¹Ÿæ˜¯æˆ‘è¦åœ¨åé¢å‡ ç¯‡æ–‡ç« ä¸­åˆ†äº«çš„æ ¸å¿ƒå†…å®¹ã€‚æ­¤å¤–ï¼ŒåŸºäºä»Šå¤©è¿™ç¯‡æ–‡ç« æ‰€è®²è¿°çš„ Istio çš„å·¥ä½œåŸç†ï¼Œå°½ç®¡ Istio é¡¹ç›®ä¸€ç›´å®£ç§°å®ƒå¯ä»¥è¿è¡Œåœ¨é Kubernetes ç¯å¢ƒä¸­ï¼Œä½†æˆ‘å¹¶ä¸å»ºè®®ä½ èŠ±å¤ªå¤šæ—¶é—´å»åšè¿™ä¸ªå°è¯•ã€‚æ¯•ç«Ÿï¼Œæ— è®ºæ˜¯ä»æŠ€æœ¯å®ç°è¿˜æ˜¯åœ¨ç¤¾åŒºè¿ä½œä¸Šï¼ŒIstio ä¸ Kubernetes é¡¹ç›®ä¹‹é—´éƒ½æ˜¯ç´§å¯†çš„ã€å”‡é½¿ç›¸ä¾çš„å…³ç³»ã€‚å¦‚æœè„±ç¦»äº† Kubernetes é¡¹ç›®è¿™ä¸ªåŸºç¡€ï¼Œé‚£ä¹ˆè¿™æ¡åŸæœ¬å°±ä¸ç®—å¹³å¦çš„â€œå¾®æœåŠ¡â€ä¹‹è·¯ï¼Œææ€•ä¼šæ›´åŠ å›°éš¾é‡é‡ã€‚\nå‚è€ƒ\nè°ˆ Kubernetes çš„æ¶æ„è®¾è®¡ä¸å®ç°åŸç†\n","date":"2021å¹´03æœˆ12æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/declarative-api/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹ï¼Œæœ¬èŠ‚ä¸»è¦æ˜¯å…³äºå£°æ˜å¼ API ä¸ Kubernetes ç¼–ç¨‹èŒƒå¼ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e","title":"å£°æ˜å¼APIä¸Kubernetesç¼–ç¨‹èŒƒå¼"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æKubernetesã€‹è¯¾ç¨‹.\n å®é™…ä¸Šï¼Œå®ƒä»¬ä¸»è¦ç¼–æ’çš„å¯¹è±¡ï¼Œéƒ½æ˜¯â€œåœ¨çº¿ä¸šåŠ¡â€ï¼Œå³ï¼šLong Running Taskï¼ˆé•¿ä½œä¸šï¼‰ã€‚æ¯”å¦‚ï¼Œæˆ‘åœ¨å‰é¢ä¸¾ä¾‹æ—¶å¸¸ç”¨çš„ Nginxã€Tomcatï¼Œä»¥åŠ MySQL ç­‰ç­‰ã€‚è¿™äº›åº”ç”¨ä¸€æ—¦è¿è¡Œèµ·æ¥ï¼Œé™¤éå‡ºé”™æˆ–è€…åœæ­¢ï¼Œå®ƒçš„å®¹å™¨è¿›ç¨‹ä¼šä¸€ç›´ä¿æŒåœ¨ Running çŠ¶æ€ã€‚\nä½†æ˜¯ï¼Œæœ‰ä¸€ç±»ä½œä¸šæ˜¾ç„¶ä¸æ»¡è¶³è¿™æ ·çš„æ¡ä»¶ï¼Œè¿™å°±æ˜¯â€œç¦»çº¿ä¸šåŠ¡â€ï¼Œæˆ–è€…å«ä½œ Batch Jobï¼ˆè®¡ç®—ä¸šåŠ¡ï¼‰ã€‚è¿™ç§ä¸šåŠ¡åœ¨è®¡ç®—å®Œæˆåå°±ç›´æ¥é€€å‡ºäº†ï¼Œè€Œæ­¤æ—¶å¦‚æœä½ ä¾ç„¶ç”¨ Deployment æ¥ç®¡ç†è¿™ç§ä¸šåŠ¡çš„è¯ï¼Œå°±ä¼šå‘ç° Pod ä¼šåœ¨è®¡ç®—ç»“æŸåé€€å‡ºï¼Œç„¶åè¢« Deployment Controller ä¸æ–­åœ°é‡å¯ï¼›è€Œåƒâ€œæ»šåŠ¨æ›´æ–°â€è¿™æ ·çš„ç¼–æ’åŠŸèƒ½ï¼Œæ›´æ— ä»è°ˆèµ·äº†ã€‚\næ‰€ä»¥ï¼Œæ—©åœ¨ Borg é¡¹ç›®ä¸­ï¼ŒGoogle å°±å·²ç»å¯¹ä½œä¸šè¿›è¡Œäº†åˆ†ç±»å¤„ç†ï¼Œæå‡ºäº† LRSï¼ˆLong Running Serviceï¼‰å’Œ Batch Jobs ä¸¤ç§ä½œä¸šå½¢æ€ï¼Œå¯¹å®ƒä»¬è¿›è¡Œâ€œåˆ†åˆ«ç®¡ç†â€å’Œâ€œæ··åˆè°ƒåº¦â€ã€‚\nä¸è¿‡ï¼Œåœ¨ 2015 å¹´ Borg è®ºæ–‡åˆšåˆšå‘å¸ƒçš„æ—¶å€™ï¼ŒKubernetes é¡¹ç›®å¹¶ä¸æ”¯æŒå¯¹ Batch Job çš„ç®¡ç†ã€‚ç›´åˆ° v1.4 ç‰ˆæœ¬ä¹‹åï¼Œç¤¾åŒºæ‰é€æ­¥è®¾è®¡å‡ºäº†ä¸€ä¸ªç”¨æ¥æè¿°ç¦»çº¿ä¸šåŠ¡çš„ API å¯¹è±¡ï¼Œå®ƒçš„åå­—å°±æ˜¯ï¼šJobã€‚\nJob API å¯¹è±¡çš„å®šä¹‰éå¸¸ç®€å•ï¼Œæˆ‘æ¥ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: batch/v1 kind: Job metadata: name: pi spec: template: spec: containers: - name: pi image: resouer/ubuntu-bc command: [\u0026quot;sh\u0026quot;, \u0026quot;-c\u0026quot;, \u0026quot;echo 'scale=10000; 4*a(1)' | bc -l \u0026quot;] restartPolicy: Never backoffLimit: 4  æ­¤æ—¶ï¼Œç›¸ä¿¡ä½ å¯¹ Kubernetes çš„ API å¯¹è±¡å·²ç»ä¸å†é™Œç”Ÿäº†ã€‚åœ¨è¿™ä¸ª Job çš„ YAML æ–‡ä»¶é‡Œï¼Œä½ è‚¯å®šä¸€çœ¼å°±ä¼šçœ‹åˆ°ä¸€ä½â€œè€ç†Ÿäººâ€ï¼šPod æ¨¡æ¿ï¼Œå³ spec.template å­—æ®µã€‚\nåœ¨è¿™ä¸ª Pod æ¨¡æ¿ä¸­ï¼Œæˆ‘å®šä¹‰äº†ä¸€ä¸ª Ubuntu é•œåƒçš„å®¹å™¨ï¼ˆå‡†ç¡®åœ°è¯´ï¼Œæ˜¯ä¸€ä¸ªå®‰è£…äº† bc å‘½ä»¤çš„ Ubuntu é•œåƒï¼‰ï¼Œå®ƒè¿è¡Œçš„ç¨‹åºæ˜¯ï¼š\necho \u0026quot;scale=10000; 4*a(1)\u0026quot; | bc -l  å…¶ä¸­ï¼Œbc å‘½ä»¤æ˜¯ Linux é‡Œçš„â€œè®¡ç®—å™¨â€ï¼›-l è¡¨ç¤ºï¼Œæˆ‘ç°åœ¨è¦ä½¿ç”¨æ ‡å‡†æ•°å­¦åº“ï¼›è€Œ a(1)ï¼Œåˆ™æ˜¯è°ƒç”¨æ•°å­¦åº“ä¸­çš„ arctangent å‡½æ•°ï¼Œè®¡ç®— atan(1)ã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ\nä¸­å­¦çŸ¥è¯†å‘Šè¯‰æˆ‘ä»¬ï¼štan(Ï€/4) = 1ã€‚æ‰€ä»¥ï¼Œ4*atan(1)æ­£å¥½å°±æ˜¯Ï€ï¼Œä¹Ÿå°±æ˜¯ 3.1415926â€¦ã€‚\næ‰€ä»¥ï¼Œè¿™å…¶å®å°±æ˜¯ä¸€ä¸ªè®¡ç®—Ï€å€¼çš„å®¹å™¨ã€‚è€Œé€šè¿‡ scale=10000ï¼Œæˆ‘æŒ‡å®šäº†è¾“å‡ºçš„å°æ•°ç‚¹åçš„ä½æ•°æ˜¯ 10000ã€‚åœ¨æˆ‘çš„è®¡ç®—æœºä¸Šï¼Œè¿™ä¸ªè®¡ç®—å¤§æ¦‚ç”¨æ—¶ 1 åˆ† 54 ç§’ã€‚\nä½†æ˜¯ï¼Œè·Ÿå…¶ä»–æ§åˆ¶å™¨ä¸åŒçš„æ˜¯ï¼ŒJob å¯¹è±¡å¹¶ä¸è¦æ±‚ä½ å®šä¹‰ä¸€ä¸ª spec.selector æ¥æè¿°è¦æ§åˆ¶å“ªäº› Podã€‚å…·ä½“åŸå› ï¼Œæˆ‘é©¬ä¸Šä¼šè®²è§£åˆ°ã€‚\nç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºè¿™ä¸ª Job äº†ï¼š\n$ kubectl create -f job.yaml  åœ¨æˆåŠŸåˆ›å»ºåï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ª Job å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl describe jobs/pi Name: pi Namespace: default Selector: controller-uid=c2db599a-2c9d-11e6-b324-0209dc45a495 Labels: controller-uid=c2db599a-2c9d-11e6-b324-0209dc45a495 job-name=pi Annotations: \u0026lt;none\u0026gt; Parallelism: 1 Completions: 1 .. Pods Statuses: 0 Running / 1 Succeeded / 0 Failed Pod Template: Labels: controller-uid=c2db599a-2c9d-11e6-b324-0209dc45a495 job-name=pi Containers: ... Volumes: \u0026lt;none\u0026gt; Events: FirstSeen LastSeen Count From SubobjectPath Type Reason Message --------- -------- ----- ---- ------------- -------- ------ ------- 1m 1m 1 {job-controller } Normal SuccessfulCreate Created pod: pi-rq5rl  å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª Job å¯¹è±¡åœ¨åˆ›å»ºåï¼Œå®ƒçš„ Pod æ¨¡æ¿ï¼Œè¢«è‡ªåŠ¨åŠ ä¸Šäº†ä¸€ä¸ª controller-uid=\u0026lt; ä¸€ä¸ªéšæœºå­—ç¬¦ä¸² \u0026gt; è¿™æ ·çš„ Labelã€‚è€Œè¿™ä¸ª Job å¯¹è±¡æœ¬èº«ï¼Œåˆ™è¢«è‡ªåŠ¨åŠ ä¸Šäº†è¿™ä¸ª Label å¯¹åº”çš„ Selectorï¼Œä»è€Œ ä¿è¯äº† Job ä¸å®ƒæ‰€ç®¡ç†çš„ Pod ä¹‹é—´çš„åŒ¹é…å…³ç³»ã€‚\nè€Œ Job Controller ä¹‹æ‰€ä»¥è¦ä½¿ç”¨è¿™ç§æºå¸¦äº† UID çš„ Labelï¼Œå°±æ˜¯ä¸ºäº†é¿å…ä¸åŒ Job å¯¹è±¡æ‰€ç®¡ç†çš„ Pod å‘ç”Ÿé‡åˆã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§è‡ªåŠ¨ç”Ÿæˆçš„ Label å¯¹ç”¨æˆ·æ¥è¯´å¹¶ä¸å‹å¥½ï¼Œæ‰€ä»¥ä¸å¤ªé€‚åˆæ¨å¹¿åˆ° Deployment ç­‰é•¿ä½œä¸šç¼–æ’å¯¹è±¡ä¸Šã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ª Job åˆ›å»ºçš„ Pod è¿›å…¥äº† Running çŠ¶æ€ï¼Œè¿™æ„å‘³ç€å®ƒæ­£åœ¨è®¡ç®— Pi çš„å€¼ã€‚\n$ kubectl get pods NAME READY STATUS RESTARTS AGE pi-rq5rl 1/1 Running 0 10s  è€Œå‡ åˆ†é’Ÿåè®¡ç®—ç»“æŸï¼Œè¿™ä¸ª Pod å°±ä¼šè¿›å…¥ Completed çŠ¶æ€ï¼š\n$ kubectl get pods NAME READY STATUS RESTARTS AGE pi-rq5rl 0/1 Completed 0 4m  è¿™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦åœ¨ Pod æ¨¡æ¿ä¸­å®šä¹‰ restartPolicy=Never çš„åŸå› ï¼šç¦»çº¿è®¡ç®—çš„ Pod æ°¸è¿œéƒ½ä¸åº”è¯¥è¢«é‡å¯ï¼Œå¦åˆ™å®ƒä»¬ä¼šå†é‡æ–°è®¡ç®—ä¸€éã€‚\n äº‹å®ä¸Šï¼ŒrestartPolicy åœ¨ Job å¯¹è±¡é‡Œåªå…è®¸è¢«è®¾ç½®ä¸º Never å’Œ OnFailureï¼›è€Œåœ¨ Deployment å¯¹è±¡é‡Œï¼ŒrestartPolicy åˆ™åªå…è®¸è¢«è®¾ç½®ä¸º Alwaysã€‚\n æ­¤æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ kubectl logs æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ª Pod çš„æ—¥å¿—ï¼Œå°±å¯ä»¥çœ‹åˆ°è®¡ç®—å¾—åˆ°çš„ Pi å€¼å·²ç»è¢«æ‰“å°äº†å‡ºæ¥ï¼š\n$ kubectl logs pi-rq5rl 3.141592653589793238462643383279...  è¿™æ—¶å€™ï¼Œä½ ä¸€å®šä¼šæƒ³åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¿™ä¸ªç¦»çº¿ä½œä¸šå¤±è´¥äº†è¦æ€ä¹ˆåŠï¼Ÿ\næ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªä¾‹å­ä¸­å®šä¹‰äº† restartPolicy=Neverï¼Œé‚£ä¹ˆç¦»çº¿ä½œä¸šå¤±è´¥å Job Controller å°±ä¼šä¸æ–­åœ°å°è¯•åˆ›å»ºä¸€ä¸ªæ–° Podï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl get pods NAME READY STATUS RESTARTS AGE pi-55h89 0/1 ContainerCreating 0 2s pi-tqbcz 0/1 Error 0 5s  å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ—¶å€™ä¼šä¸æ–­åœ°æœ‰æ–° Pod è¢«åˆ›å»ºå‡ºæ¥ã€‚\nå½“ç„¶ï¼Œè¿™ä¸ªå°è¯•è‚¯å®šä¸èƒ½æ— é™è¿›è¡Œä¸‹å»ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±åœ¨ Job å¯¹è±¡çš„ spec.backoffLimit å­—æ®µé‡Œå®šä¹‰äº†é‡è¯•æ¬¡æ•°ä¸º 4ï¼ˆå³ï¼ŒbackoffLimit=4ï¼‰ï¼Œè€Œè¿™ä¸ªå­—æ®µçš„é»˜è®¤å€¼æ˜¯ 6ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJob Controller é‡æ–°åˆ›å»º Pod çš„é—´éš”æ˜¯å‘ˆæŒ‡æ•°å¢åŠ çš„ï¼Œå³ä¸‹ä¸€æ¬¡é‡æ–°åˆ›å»º Pod çš„åŠ¨ä½œä¼šåˆ†åˆ«å‘ç”Ÿåœ¨ 10 sã€20 sã€40 s â€¦åã€‚\nè€Œå¦‚æœä½ å®šä¹‰çš„ restartPolicy=OnFailureï¼Œé‚£ä¹ˆç¦»çº¿ä½œä¸šå¤±è´¥åï¼ŒJob Controller å°±ä¸ä¼šå»å°è¯•åˆ›å»ºæ–°çš„ Podã€‚ä½†æ˜¯ï¼Œå®ƒä¼šä¸æ–­åœ°å°è¯•é‡å¯ Pod é‡Œçš„å®¹å™¨ã€‚è¿™ä¹Ÿæ­£å¥½å¯¹åº”äº† restartPolicy çš„å«ä¹‰ï¼ˆã€‚\nå¦‚å‰æ‰€è¿°ï¼Œå½“ä¸€ä¸ª Job çš„ Pod è¿è¡Œç»“æŸåï¼Œå®ƒä¼šè¿›å…¥ Completed çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¿™ä¸ª Pod å› ä¸ºæŸç§åŸå› ä¸€ç›´ä¸è‚¯ç»“æŸå‘¢ï¼Ÿ\nåœ¨ Job çš„ API å¯¹è±¡é‡Œï¼Œæœ‰ä¸€ä¸ª spec.activeDeadlineSeconds å­—æ®µå¯ä»¥è®¾ç½®æœ€é•¿è¿è¡Œæ—¶é—´ï¼Œæ¯”å¦‚ï¼š\nspec: backoffLimit: 5 activeDeadlineSeconds: 100  ä¸€æ—¦è¿è¡Œè¶…è¿‡äº† 100 sï¼Œè¿™ä¸ª Job çš„æ‰€æœ‰ Pod éƒ½ä¼šè¢«ç»ˆæ­¢ã€‚å¹¶ä¸”ï¼Œä½ å¯ä»¥åœ¨ Pod çš„çŠ¶æ€é‡Œçœ‹åˆ°ç»ˆæ­¢çš„åŸå› æ˜¯ reason: DeadlineExceededã€‚ä»¥ä¸Šï¼Œå°±æ˜¯ä¸€ä¸ª Job API å¯¹è±¡æœ€ä¸»è¦çš„æ¦‚å¿µå’Œç”¨æ³•äº†ã€‚ä¸è¿‡ï¼Œç¦»çº¿ä¸šåŠ¡ä¹‹æ‰€ä»¥è¢«ç§°ä¸º Batch Jobï¼Œå½“ç„¶æ˜¯å› ä¸ºå®ƒä»¬å¯ä»¥ä»¥â€œBatchâ€ï¼Œä¹Ÿå°±æ˜¯å¹¶è¡Œçš„æ–¹å¼å»è¿è¡Œã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¥ä¸ºä½ è®²è§£ä¸€ä¸‹Job Controller å¯¹å¹¶è¡Œä½œä¸šçš„æ§åˆ¶æ–¹æ³•ã€‚\nåœ¨ Job å¯¹è±¡ä¸­ï¼Œè´Ÿè´£å¹¶è¡Œæ§åˆ¶çš„å‚æ•°æœ‰ä¸¤ä¸ªï¼š\n spec.parallelismï¼Œå®ƒå®šä¹‰çš„æ˜¯ä¸€ä¸ª Job åœ¨ä»»æ„æ—¶é—´æœ€å¤šå¯ä»¥å¯åŠ¨å¤šå°‘ä¸ª Pod åŒæ—¶è¿è¡Œï¼› spec.completionsï¼Œå®ƒå®šä¹‰çš„æ˜¯ Job è‡³å°‘è¦å®Œæˆçš„ Pod æ•°ç›®ï¼Œå³ Job çš„æœ€å°å®Œæˆæ•°ã€‚  è¿™ä¸¤ä¸ªå‚æ•°å¬èµ·æ¥æœ‰ç‚¹å„¿æŠ½è±¡ï¼Œæ‰€ä»¥æˆ‘å‡†å¤‡äº†ä¸€ä¸ªä¾‹å­æ¥å¸®åŠ©ä½ ç†è§£ã€‚\nç°åœ¨ï¼Œæˆ‘åœ¨ä¹‹å‰è®¡ç®— Pi å€¼çš„ Job é‡Œï¼Œæ·»åŠ è¿™ä¸¤ä¸ªå‚æ•°ï¼š\napiVersion: batch/v1 kind: Job metadata: name: pi spec: parallelism: 2 completions: 4 template: spec: containers: - name: pi image: resouer/ubuntu-bc command: [\u0026quot;sh\u0026quot;, \u0026quot;-c\u0026quot;, \u0026quot;echo 'scale=5000; 4*a(1)' | bc -l \u0026quot;] restartPolicy: Never backoffLimit: 4  è¿™æ ·ï¼Œæˆ‘ä»¬å°±æŒ‡å®šäº†è¿™ä¸ª Job æœ€å¤§çš„å¹¶è¡Œæ•°æ˜¯ 2ï¼Œè€Œæœ€å°çš„å®Œæˆæ•°æ˜¯ 4ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºè¿™ä¸ª Job å¯¹è±¡ï¼š\n$ kubectl create -f job.yaml  å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª Job å…¶å®ä¹Ÿç»´æŠ¤äº†ä¸¤ä¸ªçŠ¶æ€å­—æ®µï¼Œå³ DESIRED å’Œ SUCCESSFULï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl get job NAME DESIRED SUCCESSFUL AGE pi 4 0 3s  å…¶ä¸­ï¼ŒDESIRED çš„å€¼ï¼Œæ­£æ˜¯ completions å®šä¹‰çš„æœ€å°å®Œæˆæ•°ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª Job é¦–å…ˆåˆ›å»ºäº†ä¸¤ä¸ªå¹¶è¡Œè¿è¡Œçš„ Pod æ¥è®¡ç®— Piï¼š\n$ kubectl get pods NAME READY STATUS RESTARTS AGE pi-5mt88 1/1 Running 0 6s pi-gmcq5 1/1 Running 0 6s  è€Œåœ¨ 40 s åï¼Œè¿™ä¸¤ä¸ª Pod ç›¸ç»§å®Œæˆè®¡ç®—ã€‚\nè¿™æ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¯å½“æœ‰ä¸€ä¸ª Pod å®Œæˆè®¡ç®—è¿›å…¥ Completed çŠ¶æ€æ—¶ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªæ–°çš„ Pod è¢«è‡ªåŠ¨åˆ›å»ºå‡ºæ¥ï¼Œå¹¶ä¸”å¿«é€Ÿåœ°ä» Pending çŠ¶æ€è¿›å…¥åˆ° ContainerCreating çŠ¶æ€ï¼š\n$ kubectl get pods NAME READY STATUS RESTARTS AGE pi-gmcq5 0/1 Completed 0 40s pi-84ww8 0/1 Pending 0 0s pi-5mt88 0/1 Completed 0 41s pi-62rbt 0/1 Pending 0 0s $ kubectl get pods NAME READY STATUS RESTARTS AGE pi-gmcq5 0/1 Completed 0 40s pi-84ww8 0/1 ContainerCreating 0 0s pi-5mt88 0/1 Completed 0 41s pi-62rbt 0/1 ContainerCreating 0 0s  ç´§æ¥ç€ï¼ŒJob Controller ç¬¬äºŒæ¬¡åˆ›å»ºå‡ºæ¥çš„ä¸¤ä¸ªå¹¶è¡Œçš„ Pod ä¹Ÿè¿›å…¥äº† Running çŠ¶æ€ï¼š\n$ kubectl get pods NAME READY STATUS RESTARTS AGE pi-5mt88 0/1 Completed 0 54s pi-62rbt 1/1 Running 0 13s pi-84ww8 1/1 Running 0 14s pi-gmcq5 0/1 Completed 0 54s  æœ€ç»ˆï¼Œåé¢åˆ›å»ºçš„è¿™ä¸¤ä¸ª Pod ä¹Ÿå®Œæˆäº†è®¡ç®—ï¼Œè¿›å…¥äº† Completed çŠ¶æ€ã€‚è¿™æ—¶ï¼Œç”±äºæ‰€æœ‰çš„ Pod å‡å·²ç»æˆåŠŸé€€å‡ºï¼Œè¿™ä¸ª Job ä¹Ÿå°±æ‰§è¡Œå®Œäº†ï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°å®ƒçš„ SUCCESSFUL å­—æ®µçš„å€¼å˜æˆäº† 4ï¼š\n$ kubectl get pods NAME READY STATUS RESTARTS AGE pi-5mt88 0/1 Completed 0 5m pi-62rbt 0/1 Completed 0 4m pi-84ww8 0/1 Completed 0 4m pi-gmcq5 0/1 Completed 0 5m $ kubectl get job NAME DESIRED SUCCESSFUL AGE pi 4 4 5m  é€šè¿‡ä¸Šè¿° Job çš„ DESIRED å’Œ SUCCESSFUL å­—æ®µçš„å…³ç³»ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾ˆå®¹æ˜“åœ°ç†è§£Job Controller çš„å·¥ä½œåŸç†äº†ã€‚\né¦–å…ˆï¼ŒJob Controller æ§åˆ¶çš„å¯¹è±¡ï¼Œç›´æ¥å°±æ˜¯ Podã€‚\nå…¶æ¬¡ï¼ŒJob Controller åœ¨æ§åˆ¶å¾ªç¯ä¸­è¿›è¡Œçš„è°ƒè°ï¼ˆReconcileï¼‰æ“ä½œï¼Œæ˜¯æ ¹æ®å®é™…åœ¨ Running çŠ¶æ€ Pod çš„æ•°ç›®ã€å·²ç»æˆåŠŸé€€å‡ºçš„ Pod çš„æ•°ç›®ï¼Œä»¥åŠ parallelismã€completions å‚æ•°çš„å€¼å…±åŒè®¡ç®—å‡ºåœ¨è¿™ä¸ªå‘¨æœŸé‡Œï¼Œåº”è¯¥åˆ›å»ºæˆ–è€…åˆ é™¤çš„ Pod æ•°ç›®ï¼Œç„¶åè°ƒç”¨ Kubernetes API æ¥æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚\nä»¥åˆ›å»º Pod ä¸ºä¾‹ã€‚åœ¨ä¸Šé¢è®¡ç®— Pi å€¼çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œå½“ Job ä¸€å¼€å§‹åˆ›å»ºå‡ºæ¥æ—¶ï¼Œå®é™…å¤„äº Running çŠ¶æ€çš„ Pod æ•°ç›® =0ï¼Œå·²ç»æˆåŠŸé€€å‡ºçš„ Pod æ•°ç›® =0ï¼Œè€Œç”¨æˆ·å®šä¹‰çš„ completionsï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆç”¨æˆ·éœ€è¦çš„ Pod æ•°ç›® =4ã€‚\næ‰€ä»¥ï¼Œåœ¨è¿™ä¸ªæ—¶åˆ»ï¼Œéœ€è¦åˆ›å»ºçš„ Pod æ•°ç›® = æœ€ç»ˆéœ€è¦çš„ Pod æ•°ç›® - å®é™…åœ¨ Running çŠ¶æ€ Pod æ•°ç›® - å·²ç»æˆåŠŸé€€å‡ºçš„ Pod æ•°ç›® = 4 - 0 - 0= 4ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJob Controller éœ€è¦åˆ›å»º 4 ä¸ª Pod æ¥çº æ­£è¿™ä¸ªä¸ä¸€è‡´çŠ¶æ€ã€‚\nå¯æ˜¯ï¼Œæˆ‘ä»¬åˆå®šä¹‰äº†è¿™ä¸ª Job çš„ parallelism=2ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è§„å®šäº†æ¯æ¬¡å¹¶å‘åˆ›å»ºçš„ Pod ä¸ªæ•°ä¸èƒ½è¶…è¿‡ 2 ä¸ªã€‚æ‰€ä»¥ï¼ŒJob Controller ä¼šå¯¹å‰é¢çš„è®¡ç®—ç»“æœåšä¸€ä¸ªä¿®æ­£ï¼Œä¿®æ­£åçš„æœŸæœ›åˆ›å»ºçš„ Pod æ•°ç›®åº”è¯¥æ˜¯ï¼š2 ä¸ªã€‚\nè¿™æ—¶å€™ï¼ŒJob Controller å°±ä¼šå¹¶å‘åœ°å‘ kube-apiserver å‘èµ·ä¸¤ä¸ªåˆ›å»º Pod çš„è¯·æ±‚ã€‚\nç±»ä¼¼åœ°ï¼Œå¦‚æœåœ¨è¿™æ¬¡è°ƒè°å‘¨æœŸé‡Œï¼ŒJob Controller å‘ç°å®é™…åœ¨ Running çŠ¶æ€çš„ Pod æ•°ç›®ï¼Œæ¯” parallelism è¿˜å¤§ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šåˆ é™¤ä¸€äº› Podï¼Œä½¿ä¸¤è€…ç›¸ç­‰ã€‚\nç»¼ä¸Šæ‰€è¿°ï¼ŒJob Controller å®é™…ä¸Šæ§åˆ¶äº†ï¼Œä½œä¸šæ‰§è¡Œçš„å¹¶è¡Œåº¦ï¼Œä»¥åŠæ€»å…±éœ€è¦å®Œæˆçš„ä»»åŠ¡æ•°è¿™ä¸¤ä¸ªé‡è¦å‚æ•°ã€‚è€Œåœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦æ ¹æ®ä½œä¸šçš„ç‰¹æ€§ï¼Œæ¥å†³å®šå¹¶è¡Œåº¦ï¼ˆparallelismï¼‰å’Œä»»åŠ¡æ•°ï¼ˆcompletionsï¼‰çš„åˆç†å–å€¼ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘å†å’Œä½ åˆ†äº«ä¸‰ç§å¸¸ç”¨çš„ã€ä½¿ç”¨ Job å¯¹è±¡çš„æ–¹æ³•ã€‚\nç¬¬ä¸€ç§ç”¨æ³•ï¼Œä¹Ÿæ˜¯æœ€ç®€å•ç²—æš´çš„ç”¨æ³•ï¼šå¤–éƒ¨ç®¡ç†å™¨ +Job æ¨¡æ¿ã€‚\nè¿™ç§æ¨¡å¼çš„ç‰¹å®šç”¨æ³•æ˜¯ï¼šæŠŠ Job çš„ YAML æ–‡ä»¶å®šä¹‰ä¸ºä¸€ä¸ªâ€œæ¨¡æ¿â€ï¼Œç„¶åç”¨ä¸€ä¸ªå¤–éƒ¨å·¥å…·æ§åˆ¶è¿™äº›â€œæ¨¡æ¿â€æ¥ç”Ÿæˆ Jobã€‚è¿™æ—¶ï¼ŒJob çš„å®šä¹‰æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: batch/v1 kind: Job metadata: name: process-item-$ITEM labels: jobgroup: jobexample spec: template: metadata: name: jobexample labels: jobgroup: jobexample spec: containers: - name: c image: busybox command: [\u0026quot;sh\u0026quot;, \u0026quot;-c\u0026quot;, \u0026quot;echo Processing item $ITEM \u0026amp;\u0026amp; sleep 5\u0026quot;] restartPolicy: Never  å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ª Job çš„ YAML é‡Œï¼Œå®šä¹‰äº† $ITEM è¿™æ ·çš„â€œå˜é‡â€ã€‚\næ‰€ä»¥ï¼Œåœ¨æ§åˆ¶è¿™ç§ Job æ—¶ï¼Œæˆ‘ä»¬åªè¦æ³¨æ„å¦‚ä¸‹ä¸¤ä¸ªæ–¹é¢å³å¯ï¼š\n åˆ›å»º Job æ—¶ï¼Œæ›¿æ¢æ‰ $ITEM è¿™æ ·çš„å˜é‡ï¼› æ‰€æœ‰æ¥è‡ªäºåŒä¸€ä¸ªæ¨¡æ¿çš„ Jobï¼Œéƒ½æœ‰ä¸€ä¸ª jobgroup: jobexample æ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸€ç»„ Job ä½¿ç”¨è¿™æ ·ä¸€ä¸ªç›¸åŒçš„æ ‡è¯†ã€‚  è€Œåšåˆ°ç¬¬ä¸€ç‚¹éå¸¸ç®€å•ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡è¿™æ ·ä¸€å¥ shell æŠŠ $ITEM æ›¿æ¢æ‰ï¼š\n$ mkdir ./jobs $ for i in apple banana cherry do cat job-tmpl.yaml | sed \u0026quot;s/\\$ITEM/$i/\u0026quot; \u0026gt; ./jobs/job-$i.yaml done  è¿™æ ·ï¼Œä¸€ç»„æ¥è‡ªäºåŒä¸€ä¸ªæ¨¡æ¿çš„ä¸åŒ Job çš„ yaml å°±ç”Ÿæˆäº†ã€‚æ¥ä¸‹æ¥ï¼Œä½ å°±å¯ä»¥é€šè¿‡ä¸€å¥ kubectl create æŒ‡ä»¤åˆ›å»ºè¿™äº› Job äº†ï¼š\n$ kubectl create -f ./jobs $ kubectl get pods -l jobgroup=jobexample NAME READY STATUS RESTARTS AGE process-item-apple-kixwv 0/1 Completed 0 4m process-item-banana-wrsf7 0/1 Completed 0 4m process-item-cherry-dnfu9 0/1 Completed 0 4m  è¿™ä¸ªæ¨¡å¼çœ‹èµ·æ¥è™½ç„¶å¾ˆâ€œå‚»â€ï¼Œä½†å´æ˜¯ Kubernetes ç¤¾åŒºé‡Œä½¿ç”¨ Job çš„ä¸€ä¸ªå¾ˆæ™®éçš„æ¨¡å¼ã€‚\nåŸå› å¾ˆç®€å•ï¼šå¤§å¤šæ•°ç”¨æˆ·åœ¨éœ€è¦ç®¡ç† Batch Job çš„æ—¶å€™ï¼Œéƒ½å·²ç»æœ‰äº†ä¸€å¥—è‡ªå·±çš„æ–¹æ¡ˆï¼Œéœ€è¦åšçš„å¾€å¾€å°±æ˜¯é›†æˆå·¥ä½œã€‚è¿™æ—¶å€™ï¼ŒKubernetes é¡¹ç›®å¯¹è¿™äº›æ–¹æ¡ˆæ¥è¯´æœ€æœ‰ä»·å€¼çš„ï¼Œå°±æ˜¯ Job è¿™ä¸ª API å¯¹è±¡ã€‚æ‰€ä»¥ï¼Œä½ åªéœ€è¦ç¼–å†™ä¸€ä¸ªå¤–éƒ¨å·¥å…·ï¼ˆç­‰åŒäºæˆ‘ä»¬è¿™é‡Œçš„ for å¾ªç¯ï¼‰æ¥ç®¡ç†è¿™äº› Job å³å¯ã€‚\nè¿™ç§æ¨¡å¼æœ€å…¸å‹çš„åº”ç”¨ï¼Œå°±æ˜¯ TensorFlow ç¤¾åŒºçš„ KubeFlow é¡¹ç›®ã€‚\nå¾ˆå®¹æ˜“ç†è§£ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ä½¿ç”¨ Job å¯¹è±¡ï¼Œcompletions å’Œ parallelism è¿™ä¸¤ä¸ªå­—æ®µéƒ½åº”è¯¥ä½¿ç”¨é»˜è®¤å€¼ 1ï¼Œè€Œä¸åº”è¯¥ç”±æˆ‘ä»¬è‡ªè¡Œè®¾ç½®ã€‚è€Œä½œä¸š Pod çš„å¹¶è¡Œæ§åˆ¶ï¼Œåº”è¯¥å®Œå…¨äº¤ç”±å¤–éƒ¨å·¥å…·æ¥è¿›è¡Œç®¡ç†ï¼ˆæ¯”å¦‚ï¼ŒKubeFlowï¼‰ã€‚\nç¬¬äºŒç§ç”¨æ³•ï¼šæ‹¥æœ‰å›ºå®šä»»åŠ¡æ•°ç›®çš„å¹¶è¡Œ Jobã€‚\nè¿™ç§æ¨¡å¼ä¸‹ï¼Œæˆ‘åªå…³å¿ƒæœ€åæ˜¯å¦æœ‰æŒ‡å®šæ•°ç›®ï¼ˆspec.completionsï¼‰ä¸ªä»»åŠ¡æˆåŠŸé€€å‡ºã€‚è‡³äºæ‰§è¡Œæ—¶çš„å¹¶è¡Œåº¦æ˜¯å¤šå°‘ï¼Œæˆ‘å¹¶ä¸å…³å¿ƒã€‚\næ¯”å¦‚ï¼Œæˆ‘ä»¬è¿™ä¸ªè®¡ç®— Pi å€¼çš„ä¾‹å­ï¼Œå°±æ˜¯è¿™æ ·ä¸€ä¸ªå…¸å‹çš„ã€æ‹¥æœ‰å›ºå®šä»»åŠ¡æ•°ç›®ï¼ˆcompletions=4ï¼‰çš„åº”ç”¨åœºæ™¯ã€‚ å®ƒçš„ parallelism å€¼æ˜¯ 2ï¼›æˆ–è€…ï¼Œä½ å¯ä»¥å¹²è„†ä¸æŒ‡å®š parallelismï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤çš„å¹¶è¡Œåº¦ï¼ˆå³ï¼š1ï¼‰ã€‚\næ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼ˆWork Queueï¼‰è¿›è¡Œä»»åŠ¡åˆ†å‘ã€‚è¿™æ—¶ï¼ŒJob çš„ YAML æ–‡ä»¶å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: batch/v1 kind: Job metadata: name: job-wq-1 spec: completions: 8 parallelism: 2 template: metadata: name: job-wq-1 spec: containers: - name: c image: myrepo/job-wq-1 env: - name: BROKER_URL value: amqp://guest:guest@rabbitmq-service:5672 - name: QUEUE value: job1 restartPolicy: OnFailure  æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„ completions çš„å€¼æ˜¯ï¼š8ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ€»å…±è¦å¤„ç†çš„ä»»åŠ¡æ•°ç›®æ˜¯ 8 ä¸ªã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ€»å…±ä¼šæœ‰ 8 ä¸ªä»»åŠ¡ä¼šè¢«é€ä¸€æ”¾å…¥å·¥ä½œé˜Ÿåˆ—é‡Œï¼ˆä½ å¯ä»¥è¿è¡Œä¸€ä¸ªå¤–éƒ¨å°ç¨‹åºä½œä¸ºç”Ÿäº§è€…ï¼Œæ¥æäº¤ä»»åŠ¡ï¼‰ã€‚åœ¨è¿™ä¸ªå®ä¾‹ä¸­ï¼Œæˆ‘é€‰æ‹©å……å½“å·¥ä½œé˜Ÿåˆ—çš„æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ Kubernetes é‡Œçš„ RabbitMQã€‚\næ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Pod æ¨¡æ¿é‡Œå®šä¹‰ BROKER_URLï¼Œæ¥ä½œä¸ºæ¶ˆè´¹è€…ã€‚æ‰€ä»¥ï¼Œä¸€æ—¦ä½ ç”¨ kubectl create åˆ›å»ºäº†è¿™ä¸ª Jobï¼Œå®ƒå°±ä¼šä»¥å¹¶å‘åº¦ä¸º 2 çš„æ–¹å¼ï¼Œæ¯ä¸¤ä¸ª Pod ä¸€ç»„ï¼Œåˆ›å»ºå‡º 8 ä¸ª Podã€‚æ¯ä¸ª Pod éƒ½ä¼šå»è¿æ¥ BROKER_URLï¼Œä» RabbitMQ é‡Œè¯»å–ä»»åŠ¡ï¼Œç„¶åå„è‡ªè¿›è¡Œå¤„ç†ã€‚è¿™ä¸ª Pod é‡Œçš„æ‰§è¡Œé€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è¿™æ ·ä¸€æ®µä¼ªä»£ç æ¥è¡¨ç¤ºï¼š\n/* job-wq-1çš„ä¼ªä»£ç  */ queue := newQueue($BROKER_URL, $QUEUE) task := queue.Pop() process(task) exit  å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ª Pod åªéœ€è¦å°†ä»»åŠ¡ä¿¡æ¯è¯»å–å‡ºæ¥ï¼Œå¤„ç†å®Œæˆï¼Œç„¶åé€€å‡ºå³å¯ã€‚è€Œä½œä¸ºç”¨æˆ·ï¼Œæˆ‘åªå…³å¿ƒæœ€ç»ˆä¸€å…±æœ‰ 8 ä¸ªè®¡ç®—ä»»åŠ¡å¯åŠ¨å¹¶ä¸”é€€å‡ºï¼Œåªè¦è¿™ä¸ªç›®æ ‡è¾¾åˆ°ï¼Œæˆ‘å°±è®¤ä¸ºæ•´ä¸ª Job å¤„ç†å®Œæˆäº†ã€‚æ‰€ä»¥è¯´ï¼Œè¿™ç§ç”¨æ³•ï¼Œå¯¹åº”çš„å°±æ˜¯â€œä»»åŠ¡æ€»æ•°å›ºå®šâ€çš„åœºæ™¯ã€‚\nç¬¬ä¸‰ç§ç”¨æ³•ï¼Œä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„ä¸€ä¸ªç”¨æ³•ï¼šæŒ‡å®šå¹¶è¡Œåº¦ï¼ˆparallelismï¼‰ï¼Œä½†ä¸è®¾ç½®å›ºå®šçš„ completions çš„å€¼ã€‚\næ­¤æ—¶ï¼Œä½ å°±å¿…é¡»è‡ªå·±æƒ³åŠæ³•ï¼Œæ¥å†³å®šä»€ä¹ˆæ—¶å€™å¯åŠ¨æ–° Podï¼Œä»€ä¹ˆæ—¶å€™ Job æ‰ç®—æ‰§è¡Œå®Œæˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»»åŠ¡çš„æ€»æ•°æ˜¯æœªçŸ¥çš„ï¼Œæ‰€ä»¥ä½ ä¸ä»…éœ€è¦ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—æ¥è´Ÿè´£ä»»åŠ¡åˆ†å‘ï¼Œè¿˜éœ€è¦èƒ½å¤Ÿåˆ¤æ–­å·¥ä½œé˜Ÿåˆ—å·²ç»ä¸ºç©ºï¼ˆå³ï¼šæ‰€æœ‰çš„å·¥ä½œå·²ç»ç»“æŸäº†ï¼‰ã€‚\nè¿™æ—¶å€™ï¼ŒJob çš„å®šä¹‰åŸºæœ¬ä¸Šæ²¡å˜åŒ–ï¼Œåªä¸è¿‡æ˜¯ä¸å†éœ€è¦å®šä¹‰ completions çš„å€¼äº†è€Œå·²ï¼š\napiVersion: batch/v1 kind: Job metadata: name: job-wq-2 spec: parallelism: 2 template: metadata: name: job-wq-2 spec: containers: - name: c image: gcr.io/myproject/job-wq-2 env: - name: BROKER_URL value: amqp://guest:guest@rabbitmq-service:5672 - name: QUEUE value: job2 restartPolicy: OnFailure  è€Œå¯¹åº”çš„ Pod çš„é€»è¾‘ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼Œæˆ‘å¯ä»¥ç”¨è¿™æ ·ä¸€æ®µä¼ªä»£ç æ¥æè¿°ï¼š\n/* job-wq-2çš„ä¼ªä»£ç  */ for !queue.IsEmpty($BROKER_URL, $QUEUE) { task := queue.Pop() process(task) } print(\u0026quot;Queue empty, exiting\u0026quot;) exit  ç”±äºä»»åŠ¡æ•°ç›®çš„æ€»æ•°ä¸å›ºå®šï¼Œæ‰€ä»¥æ¯ä¸€ä¸ª Pod å¿…é¡»èƒ½å¤ŸçŸ¥é“ï¼Œè‡ªå·±ä»€ä¹ˆæ—¶å€™å¯ä»¥é€€å‡ºã€‚æ¯”å¦‚ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ç®€å•åœ°ä»¥â€œé˜Ÿåˆ—ä¸ºç©ºâ€ï¼Œä½œä¸ºä»»åŠ¡å…¨éƒ¨å®Œæˆçš„æ ‡å¿—ã€‚æ‰€ä»¥è¯´ï¼Œè¿™ç§ç”¨æ³•ï¼Œå¯¹åº”çš„æ˜¯â€œä»»åŠ¡æ€»æ•°ä¸å›ºå®šâ€çš„åœºæ™¯ã€‚\nä¸è¿‡ï¼Œåœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œä½ éœ€è¦å¤„ç†çš„æ¡ä»¶å¾€å¾€ä¼šéå¸¸å¤æ‚ã€‚æ¯”å¦‚ï¼Œä»»åŠ¡å®Œæˆåçš„è¾“å‡ºã€æ¯ä¸ªä»»åŠ¡ Pod ä¹‹é—´æ˜¯ä¸æ˜¯æœ‰èµ„æºçš„ç«äº‰å’ŒååŒç­‰ç­‰ã€‚\næ‰€ä»¥ï¼Œåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°±ä¸å†å±•å¼€ Job çš„ç”¨æ³•äº†ã€‚å› ä¸ºï¼Œåœ¨å®é™…åœºæ™¯é‡Œï¼Œè¦ä¹ˆå¹²è„†å°±ç”¨ç¬¬ä¸€ç§ç”¨æ³•æ¥è‡ªå·±ç®¡ç†ä½œä¸šï¼›è¦ä¹ˆï¼Œè¿™äº›ä»»åŠ¡ Pod ä¹‹é—´çš„å…³ç³»å°±ä¸é‚£ä¹ˆâ€œå•çº¯â€ï¼Œç”šè‡³è¿˜æ˜¯â€œæœ‰çŠ¶æ€åº”ç”¨â€ï¼ˆæ¯”å¦‚ï¼Œä»»åŠ¡çš„è¾“å…¥ / è¾“å‡ºæ˜¯åœ¨æŒä¹…åŒ–æ•°æ®å·é‡Œï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘åœ¨åé¢è¦é‡ç‚¹è®²è§£çš„ Operatorï¼ŒåŠ ä¸Š Job å¯¹è±¡ä¸€èµ·ï¼Œå¯èƒ½æ‰èƒ½æ›´å¥½åœ°æ»¡è¶³å®é™…ç¦»çº¿ä»»åŠ¡çš„ç¼–æ’éœ€æ±‚ã€‚\næœ€åï¼Œæˆ‘å†æ¥å’Œä½ åˆ†äº«ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ Job å¯¹è±¡ï¼Œå«ä½œï¼šCronJobã€‚\né¡¾åæ€ä¹‰ï¼ŒCronJob æè¿°çš„ï¼Œæ­£æ˜¯å®šæ—¶ä»»åŠ¡ã€‚å®ƒçš„ API å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: batch/v1beta1 kind: CronJob metadata: name: hello spec: schedule: \u0026quot;*/1 * * * *\u0026quot; jobTemplate: spec: template: spec: containers: - name: hello image: busybox args: - /bin/sh - -c - date; echo Hello from the Kubernetes cluster restartPolicy: OnFailure  åœ¨è¿™ä¸ª YAML æ–‡ä»¶ä¸­ï¼Œæœ€é‡è¦çš„å…³é”®è¯å°±æ˜¯ jobTemplateã€‚çœ‹åˆ°å®ƒï¼Œä½ ä¸€å®šæç„¶å¤§æ‚Ÿï¼ŒåŸæ¥ CronJob æ˜¯ä¸€ä¸ª Job å¯¹è±¡çš„æ§åˆ¶å™¨ï¼ˆControllerï¼‰ï¼\næ²¡é”™ï¼ŒCronJob ä¸ Job çš„å…³ç³»ï¼Œæ­£å¦‚åŒ Deployment ä¸ ReplicaSet çš„å…³ç³»ä¸€æ ·ã€‚CronJob æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥ç®¡ç† Job å¯¹è±¡çš„æ§åˆ¶å™¨ã€‚åªä¸è¿‡ï¼Œå®ƒåˆ›å»ºå’Œåˆ é™¤ Job çš„ä¾æ®ï¼Œæ˜¯ schedule å­—æ®µå®šä¹‰çš„ã€ä¸€ä¸ªæ ‡å‡†çš„Unix Cronæ ¼å¼çš„è¡¨è¾¾å¼ã€‚\næ¯”å¦‚ï¼Œ\u0026quot;*/1 * * * *\u0026quot;ã€‚è¿™ä¸ª Cron è¡¨è¾¾å¼é‡Œ */1 ä¸­çš„ * è¡¨ç¤ºä» 0 å¼€å§‹ï¼Œ/ è¡¨ç¤ºâ€œæ¯â€ï¼Œ1 è¡¨ç¤ºåç§»é‡ã€‚æ‰€ä»¥ï¼Œå®ƒçš„æ„æ€å°±æ˜¯ï¼šä» 0 å¼€å§‹ï¼Œæ¯ 1 ä¸ªæ—¶é—´å•ä½æ‰§è¡Œä¸€æ¬¡ã€‚é‚£ä¹ˆï¼Œæ—¶é—´å•ä½åˆæ˜¯ä»€ä¹ˆå‘¢ï¼ŸCron è¡¨è¾¾å¼ä¸­çš„äº”ä¸ªéƒ¨åˆ†åˆ†åˆ«ä»£è¡¨ï¼šåˆ†é’Ÿã€å°æ—¶ã€æ—¥ã€æœˆã€æ˜ŸæœŸã€‚æ‰€ä»¥ï¼Œä¸Šé¢è¿™å¥ Cron è¡¨è¾¾å¼çš„æ„æ€æ˜¯ï¼šä»å½“å‰å¼€å§‹ï¼Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚è€Œè¿™é‡Œè¦æ‰§è¡Œçš„å†…å®¹ï¼Œå°±æ˜¯ jobTemplate å®šä¹‰çš„ Job äº†ã€‚\næ‰€ä»¥ï¼Œè¿™ä¸ª CronJob å¯¹è±¡åœ¨åˆ›å»º 1 åˆ†é’Ÿåï¼Œå°±ä¼šæœ‰ä¸€ä¸ª Job äº§ç”Ÿäº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl create -f ./cronjob.yaml cronjob \u0026quot;hello\u0026quot; created # ä¸€åˆ†é’Ÿå $ kubectl get jobs NAME DESIRED SUCCESSFUL AGE hello-4111706356 1 1 2s  æ­¤æ—¶ï¼ŒCronJob å¯¹è±¡ä¼šè®°å½•ä¸‹è¿™æ¬¡ Job æ‰§è¡Œçš„æ—¶é—´ï¼š\n$ kubectl get cronjob hello NAME SCHEDULE SUSPEND ACTIVE LAST-SCHEDULE hello */1 * * * * False 0 Thu, 6 Sep 2018 14:34:00 -070  éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºå®šæ—¶ä»»åŠ¡çš„ç‰¹æ®Šæ€§ï¼Œå¾ˆå¯èƒ½æŸä¸ª Job è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå¦å¤–ä¸€ä¸ªæ–° Job å°±äº§ç”Ÿäº†ã€‚è¿™æ—¶å€™ï¼Œä½ å¯ä»¥é€šè¿‡ spec.concurrencyPolicy å­—æ®µæ¥å®šä¹‰å…·ä½“çš„å¤„ç†ç­–ç•¥ã€‚æ¯”å¦‚ï¼š\n concurrencyPolicy=Allowï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤æƒ…å†µï¼Œè¿™æ„å‘³ç€è¿™äº› Job å¯ä»¥åŒæ—¶å­˜åœ¨ï¼› concurrencyPolicy=Forbidï¼Œè¿™æ„å‘³ç€ä¸ä¼šåˆ›å»ºæ–°çš„ Podï¼Œè¯¥åˆ›å»ºå‘¨æœŸè¢«è·³è¿‡ï¼› concurrencyPolicy=Replaceï¼Œè¿™æ„å‘³ç€æ–°äº§ç”Ÿçš„ Job ä¼šæ›¿æ¢æ—§çš„ã€æ²¡æœ‰æ‰§è¡Œå®Œçš„ Jobã€‚  è€Œå¦‚æœæŸä¸€æ¬¡ Job åˆ›å»ºå¤±è´¥ï¼Œè¿™æ¬¡åˆ›å»ºå°±ä¼šè¢«æ ‡è®°ä¸ºâ€œmissâ€ã€‚å½“åœ¨æŒ‡å®šçš„æ—¶é—´çª—å£å†…ï¼Œmiss çš„æ•°ç›®è¾¾åˆ° 100 æ—¶ï¼Œé‚£ä¹ˆ CronJob ä¼šåœæ­¢å†åˆ›å»ºè¿™ä¸ª Jobã€‚\nè¿™ä¸ªæ—¶é—´çª—å£ï¼Œå¯ä»¥ç”± spec.startingDeadlineSeconds å­—æ®µæŒ‡å®šã€‚æ¯”å¦‚ startingDeadlineSeconds=200ï¼Œæ„å‘³ç€åœ¨è¿‡å» 200 s é‡Œï¼Œå¦‚æœ miss çš„æ•°ç›®è¾¾åˆ°äº† 100 æ¬¡ï¼Œé‚£ä¹ˆè¿™ä¸ª Job å°±ä¸ä¼šè¢«åˆ›å»ºæ‰§è¡Œäº†ã€‚\næ€»ç»“\nåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸»è¦å’Œä½ åˆ†äº«äº† Job è¿™ä¸ªç¦»çº¿ä¸šåŠ¡çš„ç¼–æ’æ–¹æ³•ï¼Œè®²è§£äº† completions å’Œ parallelism å­—æ®µçš„å«ä¹‰ï¼Œä»¥åŠ Job Controller çš„æ‰§è¡ŒåŸç†ã€‚\nç´§æ¥ç€ï¼Œæˆ‘é€šè¿‡å®ä¾‹å’Œä½ åˆ†äº«äº† Job å¯¹è±¡ä¸‰ç§å¸¸è§çš„ä½¿ç”¨æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œæ ¹æ®æˆ‘åœ¨ç¤¾åŒºå’Œç”Ÿäº§ç¯å¢ƒä¸­çš„ç»éªŒï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ç”¨æˆ·è¿˜æ˜¯æ›´å€¾å‘äºè‡ªå·±æ§åˆ¶ Job å¯¹è±¡ã€‚æ‰€ä»¥ï¼Œç›¸æ¯”äºè¿™äº›å›ºå®šçš„â€œæ¨¡å¼â€ï¼ŒæŒæ¡ Job çš„ API å¯¹è±¡ï¼Œå’Œå®ƒå„ä¸ªå­—æ®µçš„å‡†ç¡®å«ä¹‰ä¼šæ›´åŠ é‡è¦ã€‚\næœ€åï¼Œæˆ‘è¿˜ä»‹ç»äº†ä¸€ç§ Job çš„æ§åˆ¶å™¨ï¼Œå«ä½œï¼šCronJobã€‚è¿™ä¹Ÿå°è¯äº†æˆ‘åœ¨å‰é¢çš„åˆ†äº«ä¸­æ‰€è¯´çš„ï¼šç”¨ä¸€ä¸ªå¯¹è±¡æ§åˆ¶å¦ä¸€ä¸ªå¯¹è±¡ï¼Œæ˜¯ Kubernetes ç¼–æ’çš„ç²¾é«“æ‰€åœ¨ã€‚\n","date":"2021å¹´03æœˆ09æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/job/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æKubernetesã€‹è¯¾ç¨‹.\u003c/p\u003e\n\u003c/blockquote\u003e","title":"æ’¬åŠ¨ç¦»çº¿ä¸šåŠ¡ï¼šJobä¸CronJob"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹ï¼Œæœ¬èŠ‚å†…å®¹ä¸»è¦ä»‹ç» StatefulSet çš„å­˜å‚¨çŠ¶æ€\n è€Œåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ç»§ç»­ä¸ºä½ è§£è¯» StatefulSet å¯¹å­˜å‚¨çŠ¶æ€çš„ç®¡ç†æœºåˆ¶ã€‚è¿™ä¸ªæœºåˆ¶ï¼Œä¸»è¦ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå«ä½œ Persistent Volume Claim çš„åŠŸèƒ½ã€‚\nåœ¨å‰é¢ä»‹ç» Pod çš„æ—¶å€™ï¼Œæˆ‘æ›¾æåˆ°è¿‡ï¼Œè¦åœ¨ä¸€ä¸ª Pod é‡Œå£°æ˜ Volumeï¼Œåªè¦åœ¨ Pod é‡ŒåŠ ä¸Š spec.volumes å­—æ®µå³å¯ã€‚ç„¶åï¼Œä½ å°±å¯ä»¥åœ¨è¿™ä¸ªå­—æ®µé‡Œå®šä¹‰ä¸€ä¸ªå…·ä½“ç±»å‹çš„ Volume äº†ï¼Œæ¯”å¦‚ï¼šhostPathã€‚\nå¯æ˜¯ï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šå¦‚æœä½ å¹¶ä¸çŸ¥é“æœ‰å“ªäº› Volume ç±»å‹å¯ä»¥ç”¨ï¼Œè¦æ€ä¹ˆåŠå‘¢ï¼Ÿ\næ›´å…·ä½“åœ°è¯´ï¼Œä½œä¸ºä¸€ä¸ªåº”ç”¨å¼€å‘è€…ï¼Œæˆ‘å¯èƒ½å¯¹æŒä¹…åŒ–å­˜å‚¨é¡¹ç›®ï¼ˆæ¯”å¦‚ Cephã€GlusterFS ç­‰ï¼‰ä¸€çªä¸é€šï¼Œä¹Ÿä¸çŸ¥é“å…¬å¸çš„ Kubernetes é›†ç¾¤é‡Œåˆ°åº•æ˜¯æ€ä¹ˆæ­å»ºå‡ºæ¥çš„ï¼Œæˆ‘ä¹Ÿè‡ªç„¶ä¸ä¼šç¼–å†™å®ƒä»¬å¯¹åº”çš„ Volume å®šä¹‰æ–‡ä»¶ã€‚æ‰€è°“â€œæœ¯ä¸šæœ‰ä¸“æ”»â€ï¼Œè¿™äº›å…³äº Volume çš„ç®¡ç†å’Œè¿œç¨‹æŒä¹…åŒ–å­˜å‚¨çš„çŸ¥è¯†ï¼Œä¸ä»…è¶…è¶Šäº†å¼€å‘è€…çš„çŸ¥è¯†å‚¨å¤‡ï¼Œè¿˜ä¼šæœ‰æš´éœ²å…¬å¸åŸºç¡€è®¾æ–½ç§˜å¯†çš„é£é™©ã€‚\næ¯”å¦‚ï¼Œä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œå°±æ˜¯ä¸€ä¸ªå£°æ˜äº† Ceph RBD ç±»å‹ Volume çš„ Podï¼š\napiVersion: v1 kind: Pod metadata: name: rbd spec: containers: - image: kubernetes/pause name: rbd-rw volumeMounts: - name: rbdpd mountPath: /mnt/rbd volumes: - name: rbdpd rbd: monitors: - '10.16.154.78:6789' - '10.16.154.82:6789' - '10.16.154.83:6789' pool: kube image: foo fsType: ext4 readOnly: true user: admin keyring: /etc/ceph/keyring imageformat: \u0026quot;2\u0026quot; imagefeatures: \u0026quot;layering\u0026quot;  å…¶ä¸€ï¼Œå¦‚æœä¸æ‡‚å¾— Ceph RBD çš„ä½¿ç”¨æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ª Pod é‡Œ Volumes å­—æ®µï¼Œä½ åæœ‰å…«ä¹ä¹Ÿå®Œå…¨çœ‹ä¸æ‡‚ã€‚å…¶äºŒï¼Œè¿™ä¸ª Ceph RBD å¯¹åº”çš„å­˜å‚¨æœåŠ¡å™¨çš„åœ°å€ã€ç”¨æˆ·åã€æˆæƒæ–‡ä»¶çš„ä½ç½®ï¼Œä¹Ÿéƒ½è¢«è½»æ˜“åœ°æš´éœ²ç»™äº†å…¨å…¬å¸çš„æ‰€æœ‰å¼€å‘äººå‘˜ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¿¡æ¯è¢«â€œè¿‡åº¦æš´éœ²â€çš„ä¾‹å­ã€‚\nè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œåœ¨åæ¥çš„æ¼”åŒ–ä¸­ï¼ŒKubernetes é¡¹ç›®å¼•å…¥äº†ä¸€ç»„å«ä½œ Persistent Volume Claimï¼ˆPVCï¼‰å’Œ Persistent Volumeï¼ˆPVï¼‰çš„ API å¯¹è±¡ï¼Œå¤§å¤§é™ä½äº†ç”¨æˆ·å£°æ˜å’Œä½¿ç”¨æŒä¹…åŒ– Volume çš„é—¨æ§›ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œæœ‰äº† PVC ä¹‹åï¼Œä¸€ä¸ªå¼€å‘äººå‘˜æƒ³è¦ä½¿ç”¨ä¸€ä¸ª Volumeï¼Œåªéœ€è¦ç®€å•çš„ä¸¤æ­¥å³å¯ã€‚\nç¬¬ä¸€æ­¥ï¼šå®šä¹‰ä¸€ä¸ª PVCï¼Œå£°æ˜æƒ³è¦çš„ Volume çš„å±æ€§ï¼š\nkind: PersistentVolumeClaim apiVersion: v1 metadata: name: pv-claim spec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi  å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ª PVC å¯¹è±¡é‡Œï¼Œä¸éœ€è¦ä»»ä½•å…³äº Volume ç»†èŠ‚çš„å­—æ®µï¼Œåªæœ‰æè¿°æ€§çš„å±æ€§å’Œå®šä¹‰ã€‚æ¯”å¦‚ï¼Œstorage: 1Giï¼Œè¡¨ç¤ºæˆ‘æƒ³è¦çš„ Volume å¤§å°è‡³å°‘æ˜¯ 1 GiBï¼›accessModes: ReadWriteOnceï¼Œè¡¨ç¤ºè¿™ä¸ª Volume çš„æŒ‚è½½æ–¹å¼æ˜¯å¯è¯»å†™ï¼Œå¹¶ä¸”åªèƒ½è¢«æŒ‚è½½åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè€Œéè¢«å¤šä¸ªèŠ‚ç‚¹å…±äº«ã€‚\n å¤‡æ³¨ï¼šå…³äºå“ªç§ç±»å‹çš„ Volume æ”¯æŒå“ªç§ç±»å‹çš„ AccessModeï¼Œä½ å¯ä»¥æŸ¥çœ‹ Kubernetes é¡¹ç›®å®˜æ–¹æ–‡æ¡£ä¸­çš„è¯¦ç»†åˆ—è¡¨ã€‚\n ç¬¬äºŒæ­¥ï¼šåœ¨åº”ç”¨çš„ Pod ä¸­ï¼Œå£°æ˜ä½¿ç”¨è¿™ä¸ª PVCï¼š\napiVersion: v1 kind: Pod metadata: name: pv-pod spec: containers: - name: pv-container image: nginx ports: - containerPort: 80 name: \u0026quot;http-server\u0026quot; volumeMounts: - mountPath: \u0026quot;/usr/share/nginx/html\u0026quot; name: pv-storage volumes: - name: pv-storage persistentVolumeClaim: claimName: pv-claim  å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ª Pod çš„ Volumes å®šä¹‰ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å£°æ˜å®ƒçš„ç±»å‹æ˜¯ persistentVolumeClaimï¼Œç„¶åæŒ‡å®š PVC çš„åå­—ï¼Œè€Œå®Œå…¨ä¸å¿…å…³å¿ƒ Volume æœ¬èº«çš„å®šä¹‰ã€‚è¿™æ—¶å€™ï¼Œåªè¦æˆ‘ä»¬åˆ›å»ºè¿™ä¸ª PVC å¯¹è±¡ï¼ŒKubernetes å°±ä¼šè‡ªåŠ¨ä¸ºå®ƒç»‘å®šä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ Volumeã€‚å¯æ˜¯ï¼Œè¿™äº›ç¬¦åˆæ¡ä»¶çš„ Volume åˆæ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œå®ƒä»¬æ¥è‡ªäºç”±è¿ç»´äººå‘˜ç»´æŠ¤çš„ PVï¼ˆPersistent Volumeï¼‰å¯¹è±¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸ªå¸¸è§çš„ PV å¯¹è±¡çš„ YAML æ–‡ä»¶ï¼š\nkind: PersistentVolume apiVersion: v1 metadata: name: pv-volume labels: type: local spec: capacity: storage: 10Gi accessModes: - ReadWriteOnce rbd: monitors: # ä½¿ç”¨ kubectl get pods -n rook-ceph æŸ¥çœ‹ rook-ceph-mon- å¼€å¤´çš„ POD IP å³å¯å¾—ä¸‹é¢çš„åˆ—è¡¨ - '10.16.154.78:6789' - '10.16.154.82:6789' - '10.16.154.83:6789' pool: kube image: foo fsType: ext4 readOnly: true user: admin keyring: /etc/ceph/keyring  å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª PV å¯¹è±¡çš„ spec.rbd å­—æ®µï¼Œæ­£æ˜¯æˆ‘ä»¬å‰é¢ä»‹ç»è¿‡çš„ Ceph RBD Volume çš„è¯¦ç»†å®šä¹‰ã€‚è€Œä¸”ï¼Œå®ƒè¿˜å£°æ˜äº†è¿™ä¸ª PV çš„å®¹é‡æ˜¯ 10 GiBã€‚è¿™æ ·ï¼ŒKubernetes å°±ä¼šä¸ºæˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ PVC å¯¹è±¡ç»‘å®šè¿™ä¸ª PVã€‚\næ‰€ä»¥ï¼ŒKubernetes ä¸­ PVC å’Œ PV çš„è®¾è®¡ï¼Œå®é™…ä¸Šç±»ä¼¼äºâ€œæ¥å£â€å’Œâ€œå®ç°â€çš„æ€æƒ³ã€‚å¼€å‘è€…åªè¦çŸ¥é“å¹¶ä¼šä½¿ç”¨â€œæ¥å£â€ï¼Œå³ï¼šPVCï¼›è€Œè¿ç»´äººå‘˜åˆ™è´Ÿè´£ç»™â€œæ¥å£â€ç»‘å®šå…·ä½“çš„å®ç°ï¼Œå³ï¼šPVã€‚\nè¿™ç§è§£è€¦ï¼Œå°±é¿å…äº†å› ä¸ºå‘å¼€å‘è€…æš´éœ²è¿‡å¤šçš„å­˜å‚¨ç³»ç»Ÿç»†èŠ‚è€Œå¸¦æ¥çš„éšæ‚£ã€‚æ­¤å¤–ï¼Œè¿™ç§èŒè´£çš„åˆ†ç¦»ï¼Œå¾€å¾€ä¹Ÿæ„å‘³ç€å‡ºç°äº‹æ•…æ—¶å¯ä»¥æ›´å®¹æ˜“å®šä½é—®é¢˜å’Œæ˜ç¡®è´£ä»»ï¼Œä»è€Œé¿å…â€œæ‰¯çš®â€ç°è±¡çš„å‡ºç°ã€‚è€Œ PVCã€PV çš„è®¾è®¡ï¼Œä¹Ÿä½¿å¾— StatefulSet å¯¹å­˜å‚¨çŠ¶æ€çš„ç®¡ç†æˆä¸ºäº†å¯èƒ½ã€‚\napiVersion: apps/v1 kind: StatefulSet metadata: name: web spec: serviceName: \u0026quot;nginx\u0026quot; replicas: 2 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.9.1 ports: - containerPort: 80 name: web volumeMounts: - name: www mountPath: /usr/share/nginx/html volumeClaimTemplates: - metadata: name: www spec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi  è¿™æ¬¡ï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸ª StatefulSet é¢å¤–æ·»åŠ äº†ä¸€ä¸ª volumeClaimTemplates å­—æ®µã€‚ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒè·Ÿ Deployment é‡Œ Pod æ¨¡æ¿ï¼ˆPodTemplateï¼‰çš„ä½œç”¨ç±»ä¼¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡¡æ˜¯è¢«è¿™ä¸ª StatefulSet ç®¡ç†çš„ Podï¼Œéƒ½ä¼šå£°æ˜ä¸€ä¸ªå¯¹åº”çš„ PVCï¼›è€Œè¿™ä¸ª PVC çš„å®šä¹‰ï¼Œå°±æ¥è‡ªäº volumeClaimTemplates è¿™ä¸ªæ¨¡æ¿å­—æ®µã€‚æ›´é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ª PVC çš„åå­—ï¼Œä¼šè¢«åˆ†é…ä¸€ä¸ªä¸è¿™ä¸ª Pod å®Œå…¨ä¸€è‡´çš„ç¼–å·ã€‚\nè¿™ä¸ªè‡ªåŠ¨åˆ›å»ºçš„ PVCï¼Œä¸ PV ç»‘å®šæˆåŠŸåï¼Œå°±ä¼šè¿›å…¥ Bound çŠ¶æ€ï¼Œè¿™å°±æ„å‘³ç€è¿™ä¸ª Pod å¯ä»¥æŒ‚è½½å¹¶ä½¿ç”¨è¿™ä¸ª PV äº†ã€‚å¦‚æœä½ è¿˜æ˜¯ä¸å¤ªç†è§£ PVC çš„è¯ï¼Œå¯ä»¥å…ˆè®°ä½è¿™æ ·ä¸€ä¸ªç»“è®ºï¼šPVC å…¶å®å°±æ˜¯ä¸€ç§ç‰¹æ®Šçš„ Volumeã€‚åªä¸è¿‡ä¸€ä¸ª PVC å…·ä½“æ˜¯ä»€ä¹ˆç±»å‹çš„ Volumeï¼Œè¦åœ¨è·ŸæŸä¸ª PV ç»‘å®šä¹‹åæ‰çŸ¥é“ã€‚\nå…³äº PVã€PVC æ›´è¯¦ç»†çš„çŸ¥è¯†ï¼Œæˆ‘ä¼šåœ¨å®¹å™¨å­˜å‚¨éƒ¨åˆ†åšè¿›ä¸€æ­¥è§£è¯»ã€‚å½“ç„¶ï¼ŒPVC ä¸ PV çš„ç»‘å®šå¾—ä»¥å®ç°çš„å‰ææ˜¯ï¼Œè¿ç»´äººå‘˜å·²ç»åœ¨ç³»ç»Ÿé‡Œåˆ›å»ºå¥½äº†ç¬¦åˆæ¡ä»¶çš„ PVï¼ˆæ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨å‰é¢ç”¨åˆ°çš„ pv-volumeï¼‰ï¼›æˆ–è€…ï¼Œä½ çš„ Kubernetes é›†ç¾¤è¿è¡Œåœ¨å…¬æœ‰äº‘ä¸Šï¼Œè¿™æ · Kubernetes å°±ä¼šé€šè¿‡ Dynamic Provisioning çš„æ–¹å¼ï¼Œè‡ªåŠ¨ä¸ºä½ åˆ›å»ºä¸ PVC åŒ¹é…çš„ PVã€‚\næ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ kubectl create åˆ›å»ºäº† StatefulSet ä¹‹åï¼Œå°±ä¼šçœ‹åˆ° Kubernetes é›†ç¾¤é‡Œå‡ºç°äº†ä¸¤ä¸ª PVCï¼š\n$ kubectl create -f statefulset.yaml $ kubectl get pvc -l app=nginx NAME STATUS VOLUME CAPACITY ACCESSMODES AGE www-web-0 Bound pvc-15c268c7-b507-11e6-932f-42010a800002 1Gi RWO 48s www-web-1 Bound pvc-15c79307-b507-11e6-932f-42010a800002 1Gi RWO 48s  å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº› PVCï¼Œéƒ½ä»¥â€œ\u0026lt;PVC åå­— \u0026gt;-\u0026lt;StatefulSet åå­— \u0026gt;-\u0026lt; ç¼–å· \u0026gt;â€çš„æ–¹å¼å‘½åï¼Œå¹¶ä¸”å¤„äº Bound çŠ¶æ€ã€‚\næˆ‘ä»¬å‰é¢å·²ç»è®²åˆ°è¿‡ï¼Œè¿™ä¸ª StatefulSet åˆ›å»ºå‡ºæ¥çš„æ‰€æœ‰ Podï¼Œéƒ½ä¼šå£°æ˜ä½¿ç”¨ç¼–å·çš„ PVCã€‚æ¯”å¦‚ï¼Œåœ¨åå« web-0 çš„ Pod çš„ volumes å­—æ®µï¼Œå®ƒä¼šå£°æ˜ä½¿ç”¨åå« www-web-0 çš„ PVCï¼Œä»è€ŒæŒ‚è½½åˆ°è¿™ä¸ª PVC æ‰€ç»‘å®šçš„ PVã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„æŒ‡ä»¤ï¼Œåœ¨ Pod çš„ Volume ç›®å½•é‡Œå†™å…¥ä¸€ä¸ªæ–‡ä»¶ï¼Œæ¥éªŒè¯ä¸€ä¸‹ä¸Šè¿° Volume çš„åˆ†é…æƒ…å†µï¼š\n$ for i in 0 1; do kubectl exec web-$i -- sh -c 'echo hello $(hostname) \u0026gt; /usr/share/nginx/html/admin.html'; done  å¦‚ä¸Šæ‰€ç¤ºï¼Œé€šè¿‡ kubectl exec æŒ‡ä»¤ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ª Pod çš„ Volume ç›®å½•é‡Œï¼Œå†™å…¥äº†ä¸€ä¸ª index.html æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œæ­£æ˜¯ Pod çš„ hostnameã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨ web-0 çš„ index.html é‡Œå†™å…¥çš„å†…å®¹å°±æ˜¯\u0026quot;hello web-0\u0026quot;ã€‚\næ­¤æ—¶ï¼Œå¦‚æœä½ åœ¨è¿™ä¸ª Pod å®¹å™¨é‡Œè®¿é—®â€œhttp://localhostâ€ï¼Œä½ å®é™…è®¿é—®åˆ°çš„å°±æ˜¯ Pod é‡Œ Nginx æœåŠ¡å™¨è¿›ç¨‹ï¼Œè€Œå®ƒä¼šä¸ºä½ è¿”å› /usr/share/nginx/html/index.html é‡Œçš„å†…å®¹ã€‚è¿™ä¸ªæ“ä½œçš„æ‰§è¡Œæ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š\n$ for i in 0 1; do kubectl exec -it web-$i -- curl localhost; done hello web-0 hello web-1  ç°åœ¨ï¼Œå…³é”®æ¥äº†ã€‚å¦‚æœä½ ä½¿ç”¨ kubectl delete å‘½ä»¤åˆ é™¤è¿™ä¸¤ä¸ª Podï¼Œè¿™äº› Volume é‡Œçš„æ–‡ä»¶ä¼šä¸ä¼šä¸¢å¤±å‘¢ï¼Ÿ\n$ kubectl delete pod -l app=nginx pod \u0026quot;web-0\u0026quot; deleted pod \u0026quot;web-1\u0026quot; deleted  å¯ä»¥çœ‹åˆ°ï¼Œæ­£å¦‚æˆ‘ä»¬å‰é¢ä»‹ç»è¿‡çš„ï¼Œåœ¨è¢«åˆ é™¤ä¹‹åï¼Œè¿™ä¸¤ä¸ª Pod ä¼šè¢«æŒ‰ç…§ç¼–å·çš„é¡ºåºè¢«é‡æ–°åˆ›å»ºå‡ºæ¥ã€‚è€Œè¿™æ—¶å€™ï¼Œå¦‚æœä½ åœ¨æ–°åˆ›å»ºçš„å®¹å™¨é‡Œé€šè¿‡è®¿é—®â€œhttp://localhostâ€çš„æ–¹å¼å»è®¿é—® web-0 é‡Œçš„ Nginx æœåŠ¡ï¼š\n# åœ¨è¢«é‡æ–°åˆ›å»ºå‡ºæ¥çš„Podå®¹å™¨é‡Œè®¿é—®http://localhost $ kubectl exec -it web-0 -- curl localhost hello web-0  è¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ\nå…¶å®ï¼Œæˆ‘å’Œä½ åˆ†æä¸€ä¸‹ StatefulSet æ§åˆ¶å™¨æ¢å¤è¿™ä¸ª Pod çš„è¿‡ç¨‹ï¼Œä½ å°±å¯ä»¥å¾ˆå®¹æ˜“ç†è§£äº†ã€‚é¦–å…ˆï¼Œå½“ä½ æŠŠä¸€ä¸ª Podï¼Œæ¯”å¦‚ web-0ï¼Œåˆ é™¤ä¹‹åï¼Œè¿™ä¸ª Pod å¯¹åº”çš„ PVC å’Œ PVï¼Œå¹¶ä¸ä¼šè¢«åˆ é™¤ï¼Œè€Œè¿™ä¸ª Volume é‡Œå·²ç»å†™å…¥çš„æ•°æ®ï¼Œä¹Ÿä¾ç„¶ä¼šä¿å­˜åœ¨è¿œç¨‹å­˜å‚¨æœåŠ¡é‡Œï¼ˆæ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªä¾‹å­é‡Œç”¨åˆ°çš„ Ceph æœåŠ¡å™¨ï¼‰ã€‚æ­¤æ—¶ï¼ŒStatefulSet æ§åˆ¶å™¨å‘ç°ï¼Œä¸€ä¸ªåå« web-0 çš„ Pod æ¶ˆå¤±äº†ã€‚æ‰€ä»¥ï¼Œæ§åˆ¶å™¨å°±ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ã€åå­—è¿˜æ˜¯å«ä½œ web-0 çš„ Pod æ¥ï¼Œâ€œçº æ­£â€è¿™ä¸ªä¸ä¸€è‡´çš„æƒ…å†µã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™ä¸ªæ–°çš„ Pod å¯¹è±¡çš„å®šä¹‰é‡Œï¼Œå®ƒå£°æ˜ä½¿ç”¨çš„ PVC çš„åå­—ï¼Œè¿˜æ˜¯å«ä½œï¼šwww-web-0ã€‚è¿™ä¸ª PVC çš„å®šä¹‰ï¼Œè¿˜æ˜¯æ¥è‡ªäº PVC æ¨¡æ¿ï¼ˆvolumeClaimTemplatesï¼‰ï¼Œè¿™æ˜¯ StatefulSet åˆ›å»º Pod çš„æ ‡å‡†æµç¨‹ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™ä¸ªæ–°çš„ web-0 Pod è¢«åˆ›å»ºå‡ºæ¥ä¹‹åï¼ŒKubernetes ä¸ºå®ƒæŸ¥æ‰¾åå« www-web-0 çš„ PVC æ—¶ï¼Œå°±ä¼šç›´æ¥æ‰¾åˆ°æ—§ Pod é—ç•™ä¸‹æ¥çš„åŒåçš„ PVCï¼Œè¿›è€Œæ‰¾åˆ°è·Ÿè¿™ä¸ª PVC ç»‘å®šåœ¨ä¸€èµ·çš„ PVã€‚è¿™æ ·ï¼Œæ–°çš„ Pod å°±å¯ä»¥æŒ‚è½½åˆ°æ—§ Pod å¯¹åº”çš„é‚£ä¸ª Volumeï¼Œå¹¶ä¸”è·å–åˆ°ä¿å­˜åœ¨ Volume é‡Œçš„æ•°æ®ã€‚\né€šè¿‡è¿™ç§æ–¹å¼ï¼ŒKubernetes çš„ StatefulSet å°±å®ç°äº†å¯¹åº”ç”¨å­˜å‚¨çŠ¶æ€çš„ç®¡ç†ã€‚\nçœ‹åˆ°è¿™é‡Œï¼Œä½ æ˜¯ä¸æ˜¯å·²ç»å¤§è‡´ç†è§£äº† StatefulSet çš„å·¥ä½œåŸç†å‘¢ï¼Ÿç°åœ¨ï¼Œæˆ‘å†ä¸ºä½ è¯¦ç»†æ¢³ç†ä¸€ä¸‹å§ã€‚\né¦–å…ˆï¼ŒStatefulSet çš„æ§åˆ¶å™¨ç›´æ¥ç®¡ç†çš„æ˜¯ Podã€‚è¿™æ˜¯å› ä¸ºï¼ŒStatefulSet é‡Œçš„ä¸åŒ Pod å®ä¾‹ï¼Œä¸å†åƒ ReplicaSet ä¸­é‚£æ ·éƒ½æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œè€Œæ˜¯æœ‰äº†ç»†å¾®åŒºåˆ«çš„ã€‚æ¯”å¦‚ï¼Œæ¯ä¸ª Pod çš„ hostnameã€åå­—ç­‰éƒ½æ˜¯ä¸åŒçš„ã€æºå¸¦äº†ç¼–å·çš„ã€‚è€Œ StatefulSet åŒºåˆ†è¿™äº›å®ä¾‹çš„æ–¹å¼ï¼Œå°±æ˜¯é€šè¿‡åœ¨ Pod çš„åå­—é‡ŒåŠ ä¸Šäº‹å…ˆçº¦å®šå¥½çš„ç¼–å·ã€‚\nå…¶æ¬¡ï¼ŒKubernetes é€šè¿‡ Headless Serviceï¼Œä¸ºè¿™äº›æœ‰ç¼–å·çš„ Podï¼Œåœ¨ DNS æœåŠ¡å™¨ä¸­ç”Ÿæˆå¸¦æœ‰åŒæ ·ç¼–å·çš„ DNS è®°å½•ã€‚åªè¦ StatefulSet èƒ½å¤Ÿä¿è¯è¿™äº› Pod åå­—é‡Œçš„ç¼–å·ä¸å˜ï¼Œé‚£ä¹ˆ Service é‡Œç±»ä¼¼äº web-0.nginx.default.svc.cluster.local è¿™æ ·çš„ DNS è®°å½•ä¹Ÿå°±ä¸ä¼šå˜ï¼Œè€Œè¿™æ¡è®°å½•è§£æå‡ºæ¥çš„ Pod çš„ IP åœ°å€ï¼Œåˆ™ä¼šéšç€åç«¯ Pod çš„åˆ é™¤å’Œå†åˆ›å»ºè€Œè‡ªåŠ¨æ›´æ–°ã€‚è¿™å½“ç„¶æ˜¯ Service æœºåˆ¶æœ¬èº«çš„èƒ½åŠ›ï¼Œä¸éœ€è¦ StatefulSet æ“å¿ƒã€‚\næœ€åï¼ŒStatefulSet è¿˜ä¸ºæ¯ä¸€ä¸ª Pod åˆ†é…å¹¶åˆ›å»ºä¸€ä¸ªåŒæ ·ç¼–å·çš„ PVCã€‚è¿™æ ·ï¼ŒKubernetes å°±å¯ä»¥é€šè¿‡ Persistent Volume æœºåˆ¶ä¸ºè¿™ä¸ª PVC ç»‘å®šä¸Šå¯¹åº”çš„ PVï¼Œä»è€Œä¿è¯äº†æ¯ä¸€ä¸ª Pod éƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ Volumeã€‚\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿ Pod è¢«åˆ é™¤ï¼Œå®ƒæ‰€å¯¹åº”çš„ PVC å’Œ PV ä¾ç„¶ä¼šä¿ç•™ä¸‹æ¥ã€‚æ‰€ä»¥å½“è¿™ä¸ª Pod è¢«é‡æ–°åˆ›å»ºå‡ºæ¥ä¹‹åï¼ŒKubernetes ä¼šä¸ºå®ƒæ‰¾åˆ°åŒæ ·ç¼–å·çš„ PVCï¼ŒæŒ‚è½½è¿™ä¸ª PVC å¯¹åº”çš„ Volumeï¼Œä»è€Œè·å–åˆ°ä»¥å‰ä¿å­˜åœ¨ Volume é‡Œçš„æ•°æ®ã€‚\nè¿™ä¹ˆä¸€çœ‹ï¼ŒåŸæœ¬éå¸¸å¤æ‚çš„ StatefulSetï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå¾ˆå®¹æ˜“ç†è§£äº†å‘¢ï¼Ÿ\næ€»ç»“\nåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ºä½ è¯¦ç»†ä»‹ç»äº† StatefulSet å¤„ç†å­˜å‚¨çŠ¶æ€çš„æ–¹æ³•ã€‚ç„¶åï¼Œä»¥æ­¤ä¸ºåŸºç¡€ï¼Œæˆ‘ä¸ºä½ æ¢³ç†äº† StatefulSet æ§åˆ¶å™¨çš„å·¥ä½œåŸç†ã€‚\nä»è¿™äº›è®²è¿°ä¸­ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡º StatefulSet çš„è®¾è®¡æ€æƒ³ï¼šStatefulSet å…¶å®å°±æ˜¯ä¸€ç§ç‰¹æ®Šçš„ Deploymentï¼Œè€Œå…¶ç‹¬ç‰¹ä¹‹å¤„åœ¨äºï¼Œå®ƒçš„æ¯ä¸ª Pod éƒ½è¢«ç¼–å·äº†ã€‚è€Œä¸”ï¼Œè¿™ä¸ªç¼–å·ä¼šä½“ç°åœ¨ Pod çš„åå­—å’Œ hostname ç­‰æ ‡è¯†ä¿¡æ¯ä¸Šï¼Œè¿™ä¸ä»…ä»£è¡¨äº† Pod çš„åˆ›å»ºé¡ºåºï¼Œä¹Ÿæ˜¯ Pod çš„é‡è¦ç½‘ç»œæ ‡è¯†ï¼ˆå³ï¼šåœ¨æ•´ä¸ªé›†ç¾¤é‡Œå”¯ä¸€çš„ã€å¯è¢«è®¿é—®çš„èº«ä»½ï¼‰ã€‚\næœ‰äº†è¿™ä¸ªç¼–å·åï¼ŒStatefulSet å°±ä½¿ç”¨ Kubernetes é‡Œçš„ä¸¤ä¸ªæ ‡å‡†åŠŸèƒ½ï¼šHeadless Service å’Œ PV/PVCï¼Œå®ç°äº†å¯¹ Pod çš„æ‹“æ‰‘çŠ¶æ€å’Œå­˜å‚¨çŠ¶æ€çš„ç»´æŠ¤ã€‚\nå®é™…ä¸Šï¼Œåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« çš„â€œæœ‰çŠ¶æ€åº”ç”¨â€å®è·µç¯èŠ‚ï¼Œä»¥åŠåç»­çš„è®²è§£ä¸­ï¼Œä½ å°±ä¼šé€æ¸æ„è¯†åˆ°ï¼ŒStatefulSet å¯ä»¥è¯´æ˜¯ Kubernetes ä¸­ä½œä¸šç¼–æ’çš„â€œé›†å¤§æˆè€…â€ã€‚\nå› ä¸ºï¼Œå‡ ä¹æ¯ä¸€ç§ Kubernetes çš„ç¼–æ’åŠŸèƒ½ï¼Œéƒ½å¯ä»¥åœ¨ç¼–å†™ StatefulSet çš„ YAML æ–‡ä»¶æ—¶è¢«ç”¨åˆ°ã€‚\n","date":"2021å¹´03æœˆ09æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/statefulset-2/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹ï¼Œæœ¬èŠ‚å†…å®¹ä¸»è¦ä»‹ç» StatefulSet çš„å­˜å‚¨çŠ¶æ€\u003c/p\u003e\n\u003c/blockquote\u003e","title":"æ·±å…¥ç†è§£StatefulSetï¼ˆäºŒï¼‰ï¼šå­˜å‚¨çŠ¶æ€"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹ï¼Œæœ¬èŠ‚å†…å®¹ä¸»è¦ä»‹ç» Daemonset\n é¡¾åæ€ä¹‰ï¼ŒDaemonSet çš„ä¸»è¦ä½œç”¨ï¼Œæ˜¯è®©ä½ åœ¨ Kubernetes é›†ç¾¤é‡Œï¼Œè¿è¡Œä¸€ä¸ª Daemon Podã€‚ æ‰€ä»¥ï¼Œè¿™ä¸ª Pod æœ‰å¦‚ä¸‹ä¸‰ä¸ªç‰¹å¾ï¼š\n è¿™ä¸ª Pod è¿è¡Œåœ¨ Kubernetes é›†ç¾¤é‡Œçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ä¸Šï¼› æ¯ä¸ªèŠ‚ç‚¹ä¸Šåªæœ‰ä¸€ä¸ªè¿™æ ·çš„ Pod å®ä¾‹ï¼› å½“æœ‰æ–°çš„èŠ‚ç‚¹åŠ å…¥ Kubernetes é›†ç¾¤åï¼Œè¯¥ Pod ä¼šè‡ªåŠ¨åœ°åœ¨æ–°èŠ‚ç‚¹ä¸Šè¢«åˆ›å»ºå‡ºæ¥ï¼›è€Œå½“æ—§èŠ‚ç‚¹è¢«åˆ é™¤åï¼Œå®ƒä¸Šé¢çš„ Pod ä¹Ÿç›¸åº”åœ°ä¼šè¢«å›æ”¶æ‰ã€‚  è¿™ä¸ªæœºåˆ¶å¬èµ·æ¥å¾ˆç®€å•ï¼Œä½† Daemon Pod çš„æ„ä¹‰ç¡®å®æ˜¯éå¸¸é‡è¦çš„ã€‚æˆ‘éšä¾¿ç»™ä½ åˆ—ä¸¾å‡ ä¸ªä¾‹å­ï¼š\n å„ç§ç½‘ç»œæ’ä»¶çš„ Agent ç»„ä»¶ï¼Œéƒ½å¿…é¡»è¿è¡Œåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç”¨æ¥å¤„ç†è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„å®¹å™¨ç½‘ç»œï¼› å„ç§å­˜å‚¨æ’ä»¶çš„ Agent ç»„ä»¶ï¼Œä¹Ÿå¿…é¡»è¿è¡Œåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç”¨æ¥åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸ŠæŒ‚è½½è¿œç¨‹å­˜å‚¨ç›®å½•ï¼Œæ“ä½œå®¹å™¨çš„ Volume ç›®å½•ï¼› å„ç§ç›‘æ§ç»„ä»¶å’Œæ—¥å¿—ç»„ä»¶ï¼Œä¹Ÿå¿…é¡»è¿è¡Œåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè´Ÿè´£è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„ç›‘æ§ä¿¡æ¯å’Œæ—¥å¿—æœé›†ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œè·Ÿå…¶ä»–ç¼–æ’å¯¹è±¡ä¸ä¸€æ ·ï¼ŒDaemonSet å¼€å§‹è¿è¡Œçš„æ—¶æœºï¼Œå¾ˆå¤šæ—¶å€™æ¯”æ•´ä¸ª Kubernetes é›†ç¾¤å‡ºç°çš„æ—¶æœºéƒ½è¦æ—©ã€‚  æ›´é‡è¦çš„æ˜¯ï¼Œè·Ÿå…¶ä»–ç¼–æ’å¯¹è±¡ä¸ä¸€æ ·ï¼ŒDaemonSet å¼€å§‹è¿è¡Œçš„æ—¶æœºï¼Œå¾ˆå¤šæ—¶å€™æ¯”æ•´ä¸ª Kubernetes é›†ç¾¤å‡ºç°çš„æ—¶æœºéƒ½è¦æ—©ã€‚è¿™ä¸ªä¹ä¸€å¬èµ·æ¥å¯èƒ½æœ‰ç‚¹å„¿å¥‡æ€ªã€‚ä½†å…¶å®ä½ æ¥æƒ³ä¸€ä¸‹ï¼šå¦‚æœè¿™ä¸ª DaemonSet æ­£æ˜¯ä¸€ä¸ªç½‘ç»œæ’ä»¶çš„ Agent ç»„ä»¶å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ï¼Œæ•´ä¸ª Kubernetes é›†ç¾¤é‡Œè¿˜æ²¡æœ‰å¯ç”¨çš„å®¹å™¨ç½‘ç»œï¼Œæ‰€æœ‰ Worker èŠ‚ç‚¹çš„çŠ¶æ€éƒ½æ˜¯ NotReadyï¼ˆNetworkReady=falseï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ™®é€šçš„ Pod è‚¯å®šä¸èƒ½è¿è¡Œåœ¨è¿™ä¸ªé›†ç¾¤ä¸Šã€‚æ‰€ä»¥ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ DaemonSet çš„è®¾è®¡ï¼Œå¿…é¡»è¦æœ‰æŸç§â€œè¿‡äººä¹‹å¤„â€æ‰è¡Œã€‚ä¸ºäº†å¼„æ¸…æ¥š DaemonSet çš„å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§è€è§„çŸ©ï¼Œå…ˆä»å®ƒçš„ API å¯¹è±¡çš„å®šä¹‰è¯´èµ·ã€‚\napiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: kube-system labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule containers: - name: fluentd-elasticsearch image: k8s.gcr.io/fluentd-elasticsearch:1.20 resources: limits: memory: 200Mi requests: cpu: 100m memory: 200Mi volumeMounts: - name: varlog mountPath: /var/log - name: varlibdockercontainers mountPath: /var/lib/docker/containers readOnly: true terminationGracePeriodSeconds: 30 volumes: - name: varlog hostPath: path: /var/log - name: varlibdockercontainers hostPath: path: /var/lib/docker/containers  è¿™ä¸ª DaemonSetï¼Œç®¡ç†çš„æ˜¯ä¸€ä¸ª fluentd-elasticsearch é•œåƒçš„ Podã€‚è¿™ä¸ªé•œåƒçš„åŠŸèƒ½éå¸¸å®ç”¨ï¼šé€šè¿‡ fluentd å°† Docker å®¹å™¨é‡Œçš„æ—¥å¿—è½¬å‘åˆ° ElasticSearch ä¸­ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒDaemonSet è·Ÿ Deployment å…¶å®éå¸¸ç›¸ä¼¼ï¼Œåªä¸è¿‡æ˜¯æ²¡æœ‰ replicas å­—æ®µï¼›å®ƒä¹Ÿä½¿ç”¨ selector é€‰æ‹©ç®¡ç†æ‰€æœ‰æºå¸¦äº† name=fluentd-elasticsearch æ ‡ç­¾çš„ Podã€‚è€Œè¿™äº› Pod çš„æ¨¡æ¿ï¼Œä¹Ÿæ˜¯ç”¨ template å­—æ®µå®šä¹‰çš„ã€‚åœ¨è¿™ä¸ªå­—æ®µä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªä½¿ç”¨ fluentd-elasticsearch:1.20 é•œåƒçš„å®¹å™¨ï¼Œè€Œä¸”è¿™ä¸ªå®¹å™¨æŒ‚è½½äº†ä¸¤ä¸ª hostPath ç±»å‹çš„ Volumeï¼Œåˆ†åˆ«å¯¹åº”å®¿ä¸»æœºçš„ /var/log ç›®å½•å’Œ /var/lib/docker/containers ç›®å½•ã€‚æ˜¾ç„¶ï¼Œfluentd å¯åŠ¨ä¹‹åï¼Œå®ƒä¼šä»è¿™ä¸¤ä¸ªç›®å½•é‡Œæœé›†æ—¥å¿—ä¿¡æ¯ï¼Œå¹¶è½¬å‘ç»™ ElasticSearch ä¿å­˜ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬é€šè¿‡ ElasticSearch å°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ£€ç´¢è¿™äº›æ—¥å¿—äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒDocker å®¹å™¨é‡Œåº”ç”¨çš„æ—¥å¿—ï¼Œé»˜è®¤ä¼šä¿å­˜åœ¨å®¿ä¸»æœºçš„ /var/lib/docker/containers/{{. å®¹å™¨ ID}}/{{. å®¹å™¨ ID}}-json.log æ–‡ä»¶é‡Œï¼Œæ‰€ä»¥è¿™ä¸ªç›®å½•æ­£æ˜¯ fluentd çš„æœé›†ç›®æ ‡ã€‚\né‚£ä¹ˆï¼ŒDaemonSet åˆæ˜¯å¦‚ä½•ä¿è¯æ¯ä¸ª Node ä¸Šæœ‰ä¸”åªæœ‰ä¸€ä¸ªè¢«ç®¡ç†çš„ Pod å‘¢ï¼Ÿ\næ˜¾ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œæ§åˆ¶å™¨æ¨¡å‹â€èƒ½å¤Ÿå¤„ç†çš„é—®é¢˜ã€‚\nDaemonSet Controllerï¼Œé¦–å…ˆä» Etcd é‡Œè·å–æ‰€æœ‰çš„ Node åˆ—è¡¨ï¼Œç„¶åéå†æ‰€æœ‰çš„ Nodeã€‚è¿™æ—¶ï¼Œå®ƒå°±å¯ä»¥å¾ˆå®¹æ˜“åœ°å»æ£€æŸ¥ï¼Œå½“å‰è¿™ä¸ª Node ä¸Šæ˜¯ä¸æ˜¯æœ‰ä¸€ä¸ªæºå¸¦äº† name=fluentd-elasticsearch æ ‡ç­¾çš„ Pod åœ¨è¿è¡Œã€‚è€Œæ£€æŸ¥çš„ç»“æœï¼Œå¯èƒ½æœ‰è¿™ä¹ˆä¸‰ç§æƒ…å†µï¼š\n æ²¡æœ‰è¿™ç§ Podï¼Œé‚£ä¹ˆå°±æ„å‘³ç€è¦åœ¨è¿™ä¸ª Node ä¸Šåˆ›å»ºè¿™æ ·ä¸€ä¸ª Podï¼› æœ‰è¿™ç§ Podï¼Œä½†æ˜¯æ•°é‡å¤§äº 1ï¼Œé‚£å°±è¯´æ˜è¦æŠŠå¤šä½™çš„ Pod ä»è¿™ä¸ª Node ä¸Šåˆ é™¤æ‰ï¼› æ­£å¥½åªæœ‰ä¸€ä¸ªè¿™ç§ Podï¼Œé‚£è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹æ˜¯æ­£å¸¸çš„ã€‚  å…¶ä¸­ï¼Œåˆ é™¤èŠ‚ç‚¹ï¼ˆNodeï¼‰ä¸Šå¤šä½™çš„ Pod éå¸¸ç®€å•ï¼Œç›´æ¥è°ƒç”¨ Kubernetes API å°±å¯ä»¥äº†ã€‚ä½†æ˜¯ï¼Œå¦‚ä½•åœ¨æŒ‡å®šçš„ Node ä¸Šåˆ›å»ºæ–° Pod å‘¢ï¼Ÿ\nå¦‚æœä½ å·²ç»ç†Ÿæ‚‰äº† Pod API å¯¹è±¡çš„è¯ï¼Œé‚£ä¸€å®šå¯ä»¥ç«‹åˆ»è¯´å‡ºç­”æ¡ˆï¼šç”¨ nodeSelectorï¼Œé€‰æ‹© Node çš„åå­—å³å¯ã€‚\nnodeSelector: name: \u0026lt;Nodeåå­—\u0026gt;  æ²¡é”™ã€‚ä¸è¿‡ï¼Œåœ¨ Kubernetes é¡¹ç›®é‡Œï¼ŒnodeSelector å…¶å®å·²ç»æ˜¯ä¸€ä¸ªå°†è¦è¢«åºŸå¼ƒçš„å­—æ®µäº†ã€‚å› ä¸ºï¼Œç°åœ¨æœ‰äº†ä¸€ä¸ªæ–°çš„ã€åŠŸèƒ½æ›´å®Œå–„çš„å­—æ®µå¯ä»¥ä»£æ›¿å®ƒï¼Œå³ï¼šnodeAffinityã€‚æˆ‘æ¥ä¸¾ä¸ªä¾‹å­ï¼š\napiVersion: v1 kind: Pod metadata: name: with-node-affinity spec: affinity: nodeAffinity: #å¿…é¡»åœ¨æ¯æ¬¡è°ƒåº¦çš„æ—¶å€™äºˆä»¥è€ƒè™‘ requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: #åªå…è®¸è¿è¡Œåœ¨ metadata.name æ˜¯ node-geektime çš„èŠ‚ç‚¹ä¸Š - matchExpressions: - key: metadata.name operator: In values: - node-geektime  åœ¨è¿™ä¸ª Pod é‡Œï¼Œæˆ‘å£°æ˜äº†ä¸€ä¸ª spec.affinity å­—æ®µï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ª nodeAffinityã€‚å…¶ä¸­ï¼Œspec.affinity å­—æ®µï¼Œæ˜¯ Pod é‡Œè·Ÿè°ƒåº¦ç›¸å…³çš„ä¸€ä¸ªå­—æ®µã€‚å…³äºå®ƒçš„å®Œæ•´å†…å®¹ï¼Œæˆ‘ä¼šåœ¨è®²è§£è°ƒåº¦ç­–ç•¥çš„æ—¶å€™å†è¯¦ç»†é˜è¿°ã€‚\nè€Œåœ¨è¿™é‡Œï¼Œæˆ‘å®šä¹‰çš„ nodeAffinity çš„å«ä¹‰æ˜¯ï¼šrequiredDuringSchedulingIgnoredDuringExecutionï¼šå®ƒçš„æ„æ€æ˜¯è¯´ï¼Œè¿™ä¸ª nodeAffinity å¿…é¡»åœ¨æ¯æ¬¡è°ƒåº¦çš„æ—¶å€™äºˆä»¥è€ƒè™‘ã€‚åŒæ—¶ï¼Œè¿™ä¹Ÿæ„å‘³ç€ä½ å¯ä»¥è®¾ç½®åœ¨æŸäº›æƒ…å†µä¸‹ä¸è€ƒè™‘è¿™ä¸ª nodeAffinityï¼›è¿™ä¸ª Podï¼Œå°†æ¥åªå…è®¸è¿è¡Œåœ¨â€œmetadata.nameâ€æ˜¯â€œnode-geektimeâ€çš„èŠ‚ç‚¹ä¸Šã€‚\nåœ¨è¿™é‡Œï¼Œä½ åº”è¯¥æ³¨æ„åˆ° nodeAffinity çš„å®šä¹‰ï¼Œå¯ä»¥æ”¯æŒæ›´åŠ ä¸°å¯Œçš„è¯­æ³•ï¼Œæ¯”å¦‚ operator: Inï¼ˆå³ï¼šéƒ¨åˆ†åŒ¹é…ï¼›å¦‚æœä½ å®šä¹‰ operator: Equalï¼Œå°±æ˜¯å®Œå…¨åŒ¹é…ï¼‰ï¼Œè¿™ä¹Ÿæ­£æ˜¯ nodeAffinity ä¼šå–ä»£ nodeSelector çš„åŸå› ä¹‹ä¸€ã€‚\n å¤‡æ³¨ï¼šå…¶å®åœ¨å¤§å¤šæ•°æ—¶å€™ï¼Œè¿™äº› Operator è¯­ä¹‰æ²¡å•¥ç”¨å¤„ã€‚æ‰€ä»¥è¯´ï¼Œåœ¨å­¦ä¹ å¼€æºé¡¹ç›®çš„æ—¶å€™ï¼Œä¸€å®šè¦å­¦ä¼šæŠ“ä½â€œä¸»çº¿â€ã€‚ä¸è¦é¡¾æ­¤å¤±å½¼ã€‚\n æ‰€ä»¥ï¼Œ**æˆ‘ä»¬çš„ DaemonSet Controller ä¼šåœ¨åˆ›å»º Pod çš„æ—¶å€™ï¼Œè‡ªåŠ¨åœ¨è¿™ä¸ª Pod çš„ API å¯¹è±¡é‡Œï¼ŒåŠ ä¸Šè¿™æ ·ä¸€ä¸ª nodeAffinity å®šä¹‰ã€‚**å…¶ä¸­ï¼Œéœ€è¦ç»‘å®šçš„èŠ‚ç‚¹åå­—ï¼Œæ­£æ˜¯å½“å‰æ­£åœ¨éå†çš„è¿™ä¸ª Nodeã€‚\nå½“ç„¶ï¼ŒDaemonSet å¹¶ä¸éœ€è¦ä¿®æ”¹ç”¨æˆ·æäº¤çš„ YAML æ–‡ä»¶é‡Œçš„ Pod æ¨¡æ¿ï¼Œè€Œæ˜¯åœ¨å‘ Kubernetes å‘èµ·è¯·æ±‚ä¹‹å‰ï¼Œç›´æ¥ä¿®æ”¹æ ¹æ®æ¨¡æ¿ç”Ÿæˆçš„ Pod å¯¹è±¡ã€‚è¿™ä¸ªæ€è·¯ï¼Œä¹Ÿæ­£æ˜¯æˆ‘åœ¨å‰é¢è®²è§£ Pod å¯¹è±¡æ—¶ä»‹ç»è¿‡çš„ã€‚\næ­¤å¤–ï¼ŒDaemonSet è¿˜ä¼šç»™è¿™ä¸ª Pod è‡ªåŠ¨åŠ ä¸Šå¦å¤–ä¸€ä¸ªä¸è°ƒåº¦ç›¸å…³çš„å­—æ®µï¼Œå«ä½œ tolerationsã€‚è¿™ä¸ªå­—æ®µæ„å‘³ç€è¿™ä¸ª Podï¼Œä¼šâ€œå®¹å¿â€ï¼ˆTolerationï¼‰æŸäº› Node çš„â€œæ±¡ç‚¹â€ï¼ˆTaintï¼‰ã€‚è€Œ DaemonSet è‡ªåŠ¨åŠ ä¸Šçš„ tolerations å­—æ®µï¼Œæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: v1 kind: Pod metadata: name: with-toleration spec: tolerations: - key: node.kubernetes.io/unschedulable operator: Exists effect: NoSchedule  è¿™ä¸ª Toleration çš„å«ä¹‰æ˜¯ï¼šâ€œå®¹å¿â€æ‰€æœ‰è¢«æ ‡è®°ä¸º unschedulableâ€œæ±¡ç‚¹â€çš„ Nodeï¼›â€œå®¹å¿â€çš„æ•ˆæœæ˜¯å…è®¸è°ƒåº¦ã€‚\n å¤‡æ³¨ï¼šå…³äºå¦‚ä½•ç»™ä¸€ä¸ª Node æ ‡è®°ä¸Šâ€œæ±¡ç‚¹â€ï¼Œä»¥åŠè¿™é‡Œå…·ä½“çš„è¯­æ³•å®šä¹‰ï¼Œæˆ‘ä¼šåœ¨åé¢ä»‹ç»è°ƒåº¦å™¨çš„æ—¶å€™åšè¯¦ç»†ä»‹ç»ã€‚è¿™é‡Œï¼Œä½ å¯ä»¥ç®€å•åœ°æŠŠâ€œæ±¡ç‚¹â€ç†è§£ä¸ºä¸€ç§ç‰¹æ®Šçš„ Labelã€‚\n è€Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¢«æ ‡è®°äº† unschedulableâ€œæ±¡ç‚¹â€çš„ Nodeï¼Œæ˜¯ä¸ä¼šæœ‰ä»»ä½• Pod è¢«è°ƒåº¦ä¸Šå»çš„ï¼ˆeffect: NoScheduleï¼‰ã€‚å¯æ˜¯ï¼ŒDaemonSet è‡ªåŠ¨åœ°ç»™è¢«ç®¡ç†çš„ Pod åŠ ä¸Šäº†è¿™ä¸ªç‰¹æ®Šçš„ Tolerationï¼Œå°±ä½¿å¾—è¿™äº› Pod å¯ä»¥å¿½ç•¥è¿™ä¸ªé™åˆ¶ï¼Œç»§è€Œä¿è¯æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šè¢«è°ƒåº¦ä¸€ä¸ª Podã€‚å½“ç„¶ï¼Œå¦‚æœè¿™ä¸ªèŠ‚ç‚¹æœ‰æ•…éšœçš„è¯ï¼Œè¿™ä¸ª Pod å¯èƒ½ä¼šå¯åŠ¨å¤±è´¥ï¼Œè€Œ DaemonSet åˆ™ä¼šå§‹ç»ˆå°è¯•ä¸‹å»ï¼Œç›´åˆ° Pod å¯åŠ¨æˆåŠŸã€‚\nè¿™æ—¶ï¼Œä½ åº”è¯¥å¯ä»¥çŒœåˆ°ï¼Œæˆ‘åœ¨å‰é¢ä»‹ç»åˆ°çš„ DaemonSet çš„â€œè¿‡äººä¹‹å¤„â€ï¼Œå…¶å®å°±æ˜¯ä¾é  Toleration å®ç°çš„ã€‚\nå‡å¦‚å½“å‰ DaemonSet ç®¡ç†çš„ï¼Œæ˜¯ä¸€ä¸ªç½‘ç»œæ’ä»¶çš„ Agent Podï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»åœ¨è¿™ä¸ª DaemonSet çš„ YAML æ–‡ä»¶é‡Œï¼Œç»™å®ƒçš„ Pod æ¨¡æ¿åŠ ä¸Šä¸€ä¸ªèƒ½å¤Ÿâ€œå®¹å¿â€node.kubernetes.io/network-unavailableâ€œæ±¡ç‚¹â€çš„ Tolerationã€‚æ­£å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­æ‰€ç¤ºï¼š\n... template: metadata: labels: name: network-plugin-agent spec: tolerations: - key: node.kubernetes.io/network-unavailable operator: Exists effect: NoSchedule  åœ¨ Kubernetes é¡¹ç›®ä¸­ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹çš„ç½‘ç»œæ’ä»¶å°šæœªå®‰è£…æ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¢«è‡ªåŠ¨åŠ ä¸Šåä¸ºnode.kubernetes.io/network-unavailableçš„â€œæ±¡ç‚¹â€ã€‚\nè€Œé€šè¿‡è¿™æ ·ä¸€ä¸ª Tolerationï¼Œè°ƒåº¦å™¨åœ¨è°ƒåº¦è¿™ä¸ª Pod çš„æ—¶å€™ï¼Œå°±ä¼šå¿½ç•¥å½“å‰èŠ‚ç‚¹ä¸Šçš„â€œæ±¡ç‚¹â€ï¼Œä»è€ŒæˆåŠŸåœ°å°†ç½‘ç»œæ’ä»¶çš„ Agent ç»„ä»¶è°ƒåº¦åˆ°è¿™å°æœºå™¨ä¸Šå¯åŠ¨èµ·æ¥ã€‚\nè¿™ç§æœºåˆ¶ï¼Œæ­£æ˜¯æˆ‘ä»¬åœ¨éƒ¨ç½² Kubernetes é›†ç¾¤çš„æ—¶å€™ï¼Œèƒ½å¤Ÿå…ˆéƒ¨ç½² Kubernetes æœ¬èº«ã€å†éƒ¨ç½²ç½‘ç»œæ’ä»¶çš„æ ¹æœ¬åŸå› ï¼šå› ä¸ºå½“æ—¶æˆ‘ä»¬æ‰€åˆ›å»ºçš„ Weave çš„ YAMLï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª DaemonSetã€‚\nè‡³æ­¤ï¼Œé€šè¿‡ä¸Šé¢è¿™äº›å†…å®¹ï¼Œä½ åº”è¯¥èƒ½å¤Ÿæ˜ç™½ï¼ŒDaemonSet å…¶å®æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ§åˆ¶å™¨ã€‚åœ¨å®ƒçš„æ§åˆ¶å¾ªç¯ä¸­ï¼Œåªéœ€è¦éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®èŠ‚ç‚¹ä¸Šæ˜¯å¦æœ‰è¢«ç®¡ç† Pod çš„æƒ…å†µï¼Œæ¥å†³å®šæ˜¯å¦è¦åˆ›å»ºæˆ–è€…åˆ é™¤ä¸€ä¸ª Podã€‚\nåªä¸è¿‡ï¼Œåœ¨åˆ›å»ºæ¯ä¸ª Pod çš„æ—¶å€™ï¼ŒDaemonSet ä¼šè‡ªåŠ¨ç»™è¿™ä¸ª Pod åŠ ä¸Šä¸€ä¸ª nodeAffinityï¼Œä»è€Œä¿è¯è¿™ä¸ª Pod åªä¼šåœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šå¯åŠ¨ã€‚åŒæ—¶ï¼Œå®ƒè¿˜ä¼šè‡ªåŠ¨ç»™è¿™ä¸ª Pod åŠ ä¸Šä¸€ä¸ª Tolerationï¼Œä»è€Œå¿½ç•¥èŠ‚ç‚¹çš„ unschedulableâ€œæ±¡ç‚¹â€ã€‚\nå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ Pod æ¨¡æ¿é‡ŒåŠ ä¸Šæ›´å¤šç§ç±»çš„ Tolerationï¼Œä»è€Œåˆ©ç”¨ DaemonSet è¾¾åˆ°è‡ªå·±çš„ç›®çš„ã€‚æ¯”å¦‚ï¼Œåœ¨è¿™ä¸ª fluentd-elasticsearch DaemonSet é‡Œï¼Œæˆ‘å°±ç»™å®ƒåŠ ä¸Šäº†è¿™æ ·çš„ Tolerationï¼š\ntolerations: - key: node-role.kubernetes.io/master effect: NoSchedule  è¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes é›†ç¾¤ä¸å…è®¸ç”¨æˆ·åœ¨ Master èŠ‚ç‚¹éƒ¨ç½² Podã€‚å› ä¸ºï¼ŒMaster èŠ‚ç‚¹é»˜è®¤æºå¸¦äº†ä¸€ä¸ªå«ä½œnode-role.kubernetes.io/masterçš„â€œæ±¡ç‚¹â€ã€‚æ‰€ä»¥ï¼Œä¸ºäº†èƒ½åœ¨ Master èŠ‚ç‚¹ä¸Šéƒ¨ç½² DaemonSet çš„ Podï¼Œæˆ‘å°±å¿…é¡»è®©è¿™ä¸ª Podâ€œå®¹å¿â€è¿™ä¸ªâ€œæ±¡ç‚¹â€ã€‚åœ¨ç†è§£äº† DaemonSet çš„å·¥ä½œåŸç†ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘å°±é€šè¿‡ä¸€ä¸ªå…·ä½“çš„å®è·µæ¥å¸®ä½ æ›´æ·±å…¥åœ°æŒæ¡ DaemonSet çš„ä½¿ç”¨æ–¹æ³•ã€‚\né¦–å…ˆï¼Œåˆ›å»ºè¿™ä¸ª DaemonSet å¯¹è±¡ï¼š\n$ kubectl create -f fluentd-elasticsearch.yaml  éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ DaemonSet ä¸Šï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½åº”è¯¥åŠ ä¸Š resources å­—æ®µï¼Œæ¥é™åˆ¶å®ƒçš„ CPU å’Œå†…å­˜ä½¿ç”¨ï¼Œé˜²æ­¢å®ƒå ç”¨è¿‡å¤šçš„å®¿ä¸»æœºèµ„æºã€‚è€Œåˆ›å»ºæˆåŠŸåï¼Œä½ å°±èƒ½çœ‹åˆ°ï¼Œå¦‚æœæœ‰ N ä¸ªèŠ‚ç‚¹ï¼Œå°±ä¼šæœ‰ N ä¸ª fluentd-elasticsearch Pod åœ¨è¿è¡Œã€‚æ¯”å¦‚åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼Œä¼šæœ‰ä¸¤ä¸ª Podï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl get pod -n kube-system -l name=fluentd-elasticsearch NAME READY STATUS RESTARTS AGE fluentd-elasticsearch-dqfv9 1/1 Running 0 53m fluentd-elasticsearch-pf9z5 1/1 Running 0 53m  è€Œå¦‚æœä½ æ­¤æ—¶é€šè¿‡ kubectl get æŸ¥çœ‹ä¸€ä¸‹ Kubernetes é›†ç¾¤é‡Œçš„ DaemonSet å¯¹è±¡ï¼š\n$ kubectl get ds -n kube-system fluentd-elasticsearch NAME DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGE fluentd-elasticsearch 2 2 2 2 2 \u0026lt;none\u0026gt; 1h   å¤‡æ³¨ï¼šKubernetes é‡Œæ¯”è¾ƒé•¿çš„ API å¯¹è±¡éƒ½æœ‰çŸ­åå­—ï¼Œæ¯”å¦‚ DaemonSet å¯¹åº”çš„æ˜¯ dsï¼ŒDeployment å¯¹åº”çš„æ˜¯ deployã€‚\n å°±ä¼šå‘ç° DaemonSet å’Œ Deployment ä¸€æ ·ï¼Œä¹Ÿæœ‰ DESIREDã€CURRENT ç­‰å¤šä¸ªçŠ¶æ€å­—æ®µã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼ŒDaemonSet å¯ä»¥åƒ Deployment é‚£æ ·ï¼Œè¿›è¡Œç‰ˆæœ¬ç®¡ç†ã€‚è¿™ä¸ªç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ kubectl rollout history çœ‹åˆ°ï¼š\n$ kubectl rollout history daemonset fluentd-elasticsearch -n kube-system daemonsets \u0026quot;fluentd-elasticsearch\u0026quot; REVISION CHANGE-CAUSE 1 \u0026lt;none\u0026gt;  æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥æŠŠè¿™ä¸ª DaemonSet çš„å®¹å™¨é•œåƒç‰ˆæœ¬åˆ° v2.2.0ï¼š\n$ kubectl set image ds/fluentd-elasticsearch fluentd-elasticsearch=k8s.gcr.io/fluentd-elasticsearch:v2.2.0 --record -n=kube-system  è¿™ä¸ª kubectl set image å‘½ä»¤é‡Œï¼Œç¬¬ä¸€ä¸ª fluentd-elasticsearch æ˜¯ DaemonSet çš„åå­—ï¼Œç¬¬äºŒä¸ª fluentd-elasticsearch æ˜¯å®¹å™¨çš„åå­—ã€‚\nè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ kubectl rollout status å‘½ä»¤çœ‹åˆ°è¿™ä¸ªâ€œæ»šåŠ¨æ›´æ–°â€çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl rollout status ds/fluentd-elasticsearch -n kube-system Waiting for daemon set \u0026quot;fluentd-elasticsearch\u0026quot; rollout to finish: 0 out of 2 new pods have been updated... Waiting for daemon set \u0026quot;fluentd-elasticsearch\u0026quot; rollout to finish: 0 out of 2 new pods have been updated... Waiting for daemon set \u0026quot;fluentd-elasticsearch\u0026quot; rollout to finish: 1 of 2 updated pods are available... daemon set \u0026quot;fluentd-elasticsearch\u0026quot; successfully rolled out  æ³¨æ„ï¼Œç”±äºè¿™ä¸€æ¬¡æˆ‘åœ¨å‡çº§å‘½ä»¤åé¢åŠ ä¸Šäº†â€“record å‚æ•°ï¼Œæ‰€ä»¥è¿™æ¬¡å‡çº§ä½¿ç”¨åˆ°çš„æŒ‡ä»¤å°±ä¼šè‡ªåŠ¨å‡ºç°åœ¨ DaemonSet çš„ rollout history é‡Œé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl rollout history daemonset fluentd-elasticsearch -n kube-system daemonsets \u0026quot;fluentd-elasticsearch\u0026quot; REVISION CHANGE-CAUSE 1 \u0026lt;none\u0026gt; 2 kubectl set image ds/fluentd-elasticsearch fluentd-elasticsearch=k8s.gcr.io/fluentd-elasticsearch:v2.2.0 --namespace=kube-system --record=true  æœ‰äº†ç‰ˆæœ¬å·ï¼Œä½ ä¹Ÿå°±å¯ä»¥åƒ Deployment ä¸€æ ·ï¼Œå°† DaemonSet å›æ»šåˆ°æŸä¸ªæŒ‡å®šçš„å†å²ç‰ˆæœ¬äº†\nè€Œæˆ‘åœ¨å‰é¢çš„æ–‡ç« ä¸­è®²è§£ Deployment å¯¹è±¡çš„æ—¶å€™ï¼Œæ›¾ç»æåˆ°è¿‡ï¼ŒDeployment ç®¡ç†è¿™äº›ç‰ˆæœ¬ï¼Œé çš„æ˜¯â€œä¸€ä¸ªç‰ˆæœ¬å¯¹åº”ä¸€ä¸ª ReplicaSet å¯¹è±¡â€ã€‚å¯æ˜¯ï¼ŒDaemonSet æ§åˆ¶å™¨æ“ä½œçš„ç›´æ¥å°±æ˜¯ Podï¼Œä¸å¯èƒ½æœ‰ ReplicaSet è¿™æ ·çš„å¯¹è±¡å‚ä¸å…¶ä¸­ã€‚é‚£ä¹ˆï¼Œå®ƒçš„è¿™äº›ç‰ˆæœ¬åˆæ˜¯å¦‚ä½•ç»´æŠ¤çš„å‘¢ï¼Ÿ\næ‰€è°“ï¼Œä¸€åˆ‡çš†å¯¹è±¡ï¼åœ¨ Kubernetes é¡¹ç›®ä¸­ï¼Œä»»ä½•ä½ è§‰å¾—éœ€è¦è®°å½•ä¸‹æ¥çš„çŠ¶æ€ï¼Œéƒ½å¯ä»¥è¢«ç”¨ API å¯¹è±¡çš„æ–¹å¼å®ç°ã€‚å½“ç„¶ï¼Œâ€œç‰ˆæœ¬â€ä¹Ÿä¸ä¾‹å¤–ã€‚Kubernetes v1.7 ä¹‹åæ·»åŠ äº†ä¸€ä¸ª API å¯¹è±¡ï¼Œåå« ControllerRevisionï¼Œä¸“é—¨ç”¨æ¥è®°å½•æŸç§ Controller å¯¹è±¡çš„ç‰ˆæœ¬ã€‚\næ¯”å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ fluentd-elasticsearch å¯¹åº”çš„ ControllerRevisionï¼š\n$ kubectl get controllerrevision -n kube-system -l name=fluentd-elasticsearch NAME CONTROLLER REVISION AGE fluentd-elasticsearch-64dc6799c9 daemonset.apps/fluentd-elasticsearch 2 1h  è€Œå¦‚æœä½ ä½¿ç”¨ kubectl describe æŸ¥çœ‹è¿™ä¸ª ControllerRevision å¯¹è±¡ï¼š\n$ kubectl describe controllerrevision fluentd-elasticsearch-64dc6799c9 -n kube-system Name: fluentd-elasticsearch-64dc6799c9 Namespace: kube-system Labels: controller-revision-hash=2087235575 name=fluentd-elasticsearch Annotations: deprecated.daemonset.template.generation=2 kubernetes.io/change-cause=kubectl set image ds/fluentd-elasticsearch fluentd-elasticsearch=k8s.gcr.io/fluentd-elasticsearch:v2.2.0 --record=true --namespace=kube-system API Version: apps/v1 Data: Spec: Template: $ Patch: replace Metadata: Creation Timestamp: \u0026lt;nil\u0026gt; Labels: Name: fluentd-elasticsearch Spec: Containers: Image: k8s.gcr.io/fluentd-elasticsearch:v2.2.0 Image Pull Policy: IfNotPresent Name: fluentd-elasticsearch ... Revision: 2 Events: \u0026lt;none\u0026gt;  å°±ä¼šçœ‹åˆ°ï¼Œè¿™ä¸ª ControllerRevision å¯¹è±¡ï¼Œå®é™…ä¸Šæ˜¯åœ¨ Data å­—æ®µä¿å­˜äº†è¯¥ç‰ˆæœ¬å¯¹åº”çš„å®Œæ•´çš„ DaemonSet çš„ API å¯¹è±¡ã€‚å¹¶ä¸”ï¼Œåœ¨ Annotation å­—æ®µä¿å­˜äº†åˆ›å»ºè¿™ä¸ªå¯¹è±¡æ‰€ä½¿ç”¨çš„ kubectl å‘½ä»¤ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å°†è¿™ä¸ª DaemonSet å›æ»šåˆ° Revision=1 æ—¶çš„çŠ¶æ€ï¼š\n$ kubectl rollout undo daemonset fluentd-elasticsearch --to-revision=1 -n kube-system daemonset.extensions/fluentd-elasticsearch rolled back  è¿™ä¸ª kubectl rollout undo æ“ä½œï¼Œå®é™…ä¸Šç›¸å½“äºè¯»å–åˆ°äº† Revision=1 çš„ ControllerRevision å¯¹è±¡ä¿å­˜çš„ Data å­—æ®µã€‚è€Œè¿™ä¸ª Data å­—æ®µé‡Œä¿å­˜çš„ä¿¡æ¯ï¼Œå°±æ˜¯ Revision=1 æ—¶è¿™ä¸ª DaemonSet çš„å®Œæ•´ API å¯¹è±¡ã€‚\næ‰€ä»¥ï¼Œç°åœ¨ DaemonSet Controller å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå†å² API å¯¹è±¡ï¼Œå¯¹ç°æœ‰çš„ DaemonSet åšä¸€æ¬¡ PATCH æ“ä½œï¼ˆç­‰ä»·äºæ‰§è¡Œä¸€æ¬¡ kubectl apply -f â€œæ—§çš„ DaemonSet å¯¹è±¡â€ï¼‰ï¼Œä»è€ŒæŠŠè¿™ä¸ª DaemonSetâ€œæ›´æ–°â€åˆ°ä¸€ä¸ªæ—§ç‰ˆæœ¬ã€‚\nè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œåœ¨æ‰§è¡Œå®Œè¿™æ¬¡å›æ»šå®Œæˆåï¼Œä½ ä¼šå‘ç°ï¼ŒDaemonSet çš„ Revision å¹¶ä¸ä¼šä» Revision=2 é€€å›åˆ° 1ï¼Œè€Œæ˜¯ä¼šå¢åŠ æˆ Revision=3ã€‚è¿™æ˜¯å› ä¸ºï¼Œä¸€ä¸ªæ–°çš„ ControllerRevision è¢«åˆ›å»ºäº†å‡ºæ¥ã€‚\næ€»ç»“\nåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘é¦–å…ˆç®€å•ä»‹ç»äº† StatefulSet çš„â€œæ»šåŠ¨æ›´æ–°â€ï¼Œç„¶åé‡ç‚¹è®²è§£äº†æœ¬ä¸“æ çš„ç¬¬ä¸‰ä¸ªé‡è¦ç¼–æ’å¯¹è±¡ï¼šDaemonSetã€‚\nç›¸æ¯”äº Deploymentï¼ŒDaemonSet åªç®¡ç† Pod å¯¹è±¡ï¼Œç„¶åé€šè¿‡ nodeAffinity å’Œ Toleration è¿™ä¸¤ä¸ªè°ƒåº¦å™¨çš„å°åŠŸèƒ½ï¼Œä¿è¯äº†æ¯ä¸ªèŠ‚ç‚¹ä¸Šæœ‰ä¸”åªæœ‰ä¸€ä¸ª Podã€‚è¿™ä¸ªæ§åˆ¶å™¨çš„å®ç°åŸç†ç®€å•æ˜“æ‡‚ï¼Œå¸Œæœ›ä½ èƒ½å¤Ÿå¿«é€ŸæŒæ¡ã€‚\nä¸æ­¤åŒæ—¶ï¼ŒDaemonSet ä½¿ç”¨ ControllerRevisionï¼Œæ¥ä¿å­˜å’Œç®¡ç†è‡ªå·±å¯¹åº”çš„â€œç‰ˆæœ¬â€ã€‚è¿™ç§â€œé¢å‘ API å¯¹è±¡â€çš„è®¾è®¡æ€è·¯ï¼Œå¤§å¤§ç®€åŒ–äº†æ§åˆ¶å™¨æœ¬èº«çš„é€»è¾‘ï¼Œä¹Ÿæ­£æ˜¯ Kubernetes é¡¹ç›®â€œå£°æ˜å¼ APIâ€çš„ä¼˜åŠ¿æ‰€åœ¨ã€‚\nè€Œä¸”ï¼Œç›¸ä¿¡èªæ˜çš„ä½ æ­¤æ—¶å·²ç»æƒ³åˆ°äº†ï¼ŒStatefulSet ä¹Ÿæ˜¯ç›´æ¥æ§åˆ¶ Pod å¯¹è±¡çš„ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸æ˜¯ä¹Ÿåœ¨ä½¿ç”¨ ControllerRevision è¿›è¡Œç‰ˆæœ¬ç®¡ç†å‘¢ï¼Ÿ\næ²¡é”™ã€‚åœ¨ Kubernetes é¡¹ç›®é‡Œï¼ŒControllerRevision å…¶å®æ˜¯ä¸€ä¸ªé€šç”¨çš„ç‰ˆæœ¬ç®¡ç†å¯¹è±¡ã€‚è¿™æ ·ï¼ŒKubernetes é¡¹ç›®å°±å·§å¦™åœ°é¿å…äº†æ¯ç§æ§åˆ¶å™¨éƒ½è¦ç»´æŠ¤ä¸€å¥—å†—ä½™çš„ä»£ç å’Œé€»è¾‘çš„é—®é¢˜ã€‚\næ€è€ƒé¢˜\næˆ‘åœ¨æ–‡ä¸­æåˆ°ï¼Œåœ¨ Kubernetes v1.11 ä¹‹å‰ï¼ŒDaemonSet æ‰€ç®¡ç†çš„ Pod çš„è°ƒåº¦è¿‡ç¨‹ï¼Œå®é™…ä¸Šéƒ½æ˜¯ç”± DaemonSet Controller è‡ªå·±è€Œä¸æ˜¯ç”±è°ƒåº¦å™¨å®Œæˆçš„ã€‚ä½ èƒ½è¯´å‡ºè¿™å…¶ä¸­æœ‰å“ªäº›åŸå› å—ï¼Ÿ\n æŸ¥äº†ä¸€ä¸‹v1.11 çš„ release notesã€‚schedulerå…³äºaffinityè°“è¯çš„æ€§èƒ½å¤§å¤§æé«˜äº†ã€‚\næŸ¥é˜…äº†Dsç”¨é»˜è®¤è°ƒåº¦å™¨ä»£æ›¿controllerçš„è®¾è®¡æ–‡æ¡£ ä¹‹å‰çš„åšæ³•æ˜¯ï¼š controlleråˆ¤æ–­è°ƒåº¦è°“è¯ï¼Œç¬¦åˆçš„è¯ç›´æ¥åœ¨controllerä¸­ç›´æ¥è®¾ç½®spec.hostNameå»è°ƒåº¦ã€‚ ç›®å‰çš„åšæ³•æ˜¯ï¼š controllerä¸å†åˆ¤æ–­è°ƒåº¦æ¡ä»¶ï¼Œç»™æ¯ä¸ªpodeè®¾ç½®NodeAffinityã€‚æ§åˆ¶å™¨æ ¹æ®NodeAffinityå»æ£€æŸ¥æ¯ä¸ªnodeä¸Šæ˜¯å¦å¯åŠ¨äº†ç›¸åº”çš„Podã€‚å¹¶ä¸”å¯ä»¥åˆ©ç”¨è°ƒåº¦ä¼˜å…ˆçº§å»ä¼˜å…ˆè°ƒåº¦å…³é”®çš„ds podsã€‚\n","date":"2021å¹´03æœˆ09æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/daemonset/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹ï¼Œæœ¬èŠ‚å†…å®¹ä¸»è¦ä»‹ç» Daemonset\u003c/p\u003e\n\u003c/blockquote\u003e","title":"å®¹å™¨åŒ–å®ˆæŠ¤è¿›ç¨‹çš„æ„ä¹‰ï¼šDaemonSet"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹ï¼Œæœ¬èŠ‚å†…å®¹ä¸»è¦ä»‹ç» StatefulSet çš„æ‹“æ‰‘çŠ¶æ€\n åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘åœ¨ç»“å°¾å¤„è®¨è®ºåˆ°äº† Deployment å®é™…ä¸Šå¹¶ä¸è¶³ä»¥è¦†ç›–æ‰€æœ‰çš„åº”ç”¨ç¼–æ’é—®é¢˜ã€‚\né€ æˆè¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œåœ¨äº Deployment å¯¹åº”ç”¨åšäº†ä¸€ä¸ªç®€å•åŒ–å‡è®¾ã€‚å®ƒè®¤ä¸ºï¼Œä¸€ä¸ªåº”ç”¨çš„æ‰€æœ‰ Podï¼Œæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚æ‰€ä»¥ï¼Œå®ƒä»¬äº’ç›¸ä¹‹é—´æ²¡æœ‰é¡ºåºï¼Œä¹Ÿæ— æ‰€è°“è¿è¡Œåœ¨å“ªå°å®¿ä¸»æœºä¸Šã€‚éœ€è¦çš„æ—¶å€™ï¼ŒDeployment å°±å¯ä»¥é€šè¿‡ Pod æ¨¡æ¿åˆ›å»ºæ–°çš„ Podï¼›ä¸éœ€è¦çš„æ—¶å€™ï¼ŒDeployment å°±å¯ä»¥â€œæ€æ‰â€ä»»æ„ä¸€ä¸ª Podã€‚\nä½†æ˜¯ï¼Œåœ¨å®é™…çš„åœºæ™¯ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„åº”ç”¨éƒ½å¯ä»¥æ»¡è¶³è¿™æ ·çš„è¦æ±‚ã€‚\nå°¤å…¶æ˜¯åˆ†å¸ƒå¼åº”ç”¨ï¼Œå®ƒçš„å¤šä¸ªå®ä¾‹ä¹‹é—´ï¼Œå¾€å¾€æœ‰ä¾èµ–å…³ç³»ï¼Œæ¯”å¦‚ï¼šä¸»ä»å…³ç³»ã€ä¸»å¤‡å…³ç³»ã€‚\nè¿˜æœ‰å°±æ˜¯æ•°æ®å­˜å‚¨ç±»åº”ç”¨ï¼Œå®ƒçš„å¤šä¸ªå®ä¾‹ï¼Œå¾€å¾€éƒ½ä¼šåœ¨æœ¬åœ°ç£ç›˜ä¸Šä¿å­˜ä¸€ä»½æ•°æ®ã€‚è€Œè¿™äº›å®ä¾‹ä¸€æ—¦è¢«æ€æ‰ï¼Œå³ä¾¿é‡å»ºå‡ºæ¥ï¼Œå®ä¾‹ä¸æ•°æ®ä¹‹é—´çš„å¯¹åº”å…³ç³»ä¹Ÿå·²ç»ä¸¢å¤±ï¼Œä»è€Œå¯¼è‡´åº”ç”¨å¤±è´¥ã€‚\næ‰€ä»¥ï¼Œè¿™ç§å®ä¾‹ä¹‹é—´æœ‰ä¸å¯¹ç­‰å…³ç³»ï¼Œä»¥åŠå®ä¾‹å¯¹å¤–éƒ¨æ•°æ®æœ‰ä¾èµ–å…³ç³»çš„åº”ç”¨ï¼Œå°±è¢«ç§°ä¸ºâ€œæœ‰çŠ¶æ€åº”ç”¨â€ï¼ˆStateful Applicationï¼‰ã€‚\nå®¹å™¨æŠ€æœ¯è¯ç”Ÿåï¼Œå¤§å®¶å¾ˆå¿«å‘ç°ï¼Œå®ƒç”¨æ¥å°è£…â€œæ— çŠ¶æ€åº”ç”¨â€ï¼ˆStateless Applicationï¼‰ï¼Œå°¤å…¶æ˜¯ Web æœåŠ¡ï¼Œéå¸¸å¥½ç”¨ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦ä½ æƒ³è¦ç”¨å®¹å™¨è¿è¡Œâ€œæœ‰çŠ¶æ€åº”ç”¨â€ï¼Œå…¶å›°éš¾ç¨‹åº¦å°±ä¼šç›´çº¿ä¸Šå‡ã€‚è€Œä¸”ï¼Œè¿™ä¸ªé—®é¢˜è§£å†³èµ·æ¥ï¼Œå•çº¯ä¾é å®¹å™¨æŠ€æœ¯æœ¬èº«å·²ç»æ— èƒ½ä¸ºåŠ›ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…ï¼Œâ€œæœ‰çŠ¶æ€åº”ç”¨â€å‡ ä¹æˆäº†å®¹å™¨æŠ€æœ¯åœˆå­çš„â€œå¿Œè®³â€ï¼Œå¤§å®¶ä¸€å¬åˆ°è¿™ä¸ªè¯ï¼Œå°±çº·çº·æ‘‡å¤´ã€‚\nä¸è¿‡ï¼ŒKubernetes é¡¹ç›®è¿˜æ˜¯æˆä¸ºäº†â€œç¬¬ä¸€ä¸ªåƒèƒèŸ¹çš„äººâ€ã€‚å¾—ç›Šäºâ€œæ§åˆ¶å™¨æ¨¡å¼â€çš„è®¾è®¡æ€æƒ³ï¼ŒKubernetes é¡¹ç›®å¾ˆæ—©å°±åœ¨ Deployment çš„åŸºç¡€ä¸Šï¼Œæ‰©å±•å‡ºäº†å¯¹â€œæœ‰çŠ¶æ€åº”ç”¨â€çš„åˆæ­¥æ”¯æŒã€‚è¿™ä¸ªç¼–æ’åŠŸèƒ½ï¼Œå°±æ˜¯ï¼šStatefulSetã€‚\nStatefulSet çš„è®¾è®¡å…¶å®éå¸¸å®¹æ˜“ç†è§£ã€‚å®ƒæŠŠçœŸå®ä¸–ç•Œé‡Œçš„åº”ç”¨çŠ¶æ€ï¼ŒæŠ½è±¡ä¸ºäº†ä¸¤ç§æƒ…å†µï¼š\n **æ‹“æ‰‘çŠ¶æ€ã€‚**è¿™ç§æƒ…å†µæ„å‘³ç€ï¼Œåº”ç”¨çš„å¤šä¸ªå®ä¾‹ä¹‹é—´ä¸æ˜¯å®Œå…¨å¯¹ç­‰çš„å…³ç³»ã€‚è¿™äº›åº”ç”¨å®ä¾‹ï¼Œå¿…é¡»æŒ‰ç…§æŸäº›é¡ºåºå¯åŠ¨ï¼Œæ¯”å¦‚åº”ç”¨çš„ä¸»èŠ‚ç‚¹ A è¦å…ˆäºä»èŠ‚ç‚¹ B å¯åŠ¨ã€‚è€Œå¦‚æœä½ æŠŠ A å’Œ B ä¸¤ä¸ª Pod åˆ é™¤æ‰ï¼Œå®ƒä»¬å†æ¬¡è¢«åˆ›å»ºå‡ºæ¥æ—¶ä¹Ÿå¿…é¡»ä¸¥æ ¼æŒ‰ç…§è¿™ä¸ªé¡ºåºæ‰è¡Œã€‚å¹¶ä¸”ï¼Œæ–°åˆ›å»ºå‡ºæ¥çš„ Podï¼Œå¿…é¡»å’ŒåŸæ¥ Pod çš„ç½‘ç»œæ ‡è¯†ä¸€æ ·ï¼Œè¿™æ ·åŸå…ˆçš„è®¿é—®è€…æ‰èƒ½ä½¿ç”¨åŒæ ·çš„æ–¹æ³•ï¼Œè®¿é—®åˆ°è¿™ä¸ªæ–° Podã€‚ **å­˜å‚¨çŠ¶æ€ã€‚**è¿™ç§æƒ…å†µæ„å‘³ç€ï¼Œåº”ç”¨çš„å¤šä¸ªå®ä¾‹åˆ†åˆ«ç»‘å®šäº†ä¸åŒçš„å­˜å‚¨æ•°æ®ã€‚å¯¹äºè¿™äº›åº”ç”¨å®ä¾‹æ¥è¯´ï¼ŒPod A ç¬¬ä¸€æ¬¡è¯»å–åˆ°çš„æ•°æ®ï¼Œå’Œéš”äº†ååˆ†é’Ÿä¹‹åå†æ¬¡è¯»å–åˆ°çš„æ•°æ®ï¼Œåº”è¯¥æ˜¯åŒä¸€ä»½ï¼Œå“ªæ€•åœ¨æ­¤æœŸé—´ Pod A è¢«é‡æ–°åˆ›å»ºè¿‡ã€‚è¿™ç§æƒ…å†µæœ€å…¸å‹çš„ä¾‹å­ï¼Œå°±æ˜¯ä¸€ä¸ªæ•°æ®åº“åº”ç”¨çš„å¤šä¸ªå­˜å‚¨å®ä¾‹ã€‚  æ‰€ä»¥ï¼ŒStatefulSet çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå°±æ˜¯é€šè¿‡æŸç§æ–¹å¼è®°å½•è¿™äº›çŠ¶æ€ï¼Œç„¶ååœ¨ Pod è¢«é‡æ–°åˆ›å»ºæ—¶ï¼Œèƒ½å¤Ÿä¸ºæ–° Pod æ¢å¤è¿™äº›çŠ¶æ€ã€‚\nåœ¨å¼€å§‹è®²è¿° StatefulSet çš„å·¥ä½œåŸç†ä¹‹å‰ï¼Œæˆ‘å°±å¿…é¡»å…ˆä¸ºä½ è®²è§£ä¸€ä¸ª Kubernetes é¡¹ç›®ä¸­éå¸¸å®ç”¨çš„æ¦‚å¿µï¼šHeadless Serviceã€‚\næˆ‘åœ¨å’Œä½ ä¸€èµ·è®¨è®º Kubernetes æ¶æ„çš„æ—¶å€™å°±æ›¾ä»‹ç»è¿‡ï¼ŒService æ˜¯ Kubernetes é¡¹ç›®ä¸­ç”¨æ¥å°†ä¸€ç»„ Pod æš´éœ²ç»™å¤–ç•Œè®¿é—®çš„ä¸€ç§æœºåˆ¶ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ª Deployment æœ‰ 3 ä¸ª Podï¼Œé‚£ä¹ˆæˆ‘å°±å¯ä»¥å®šä¹‰ä¸€ä¸ª Serviceã€‚ç„¶åï¼Œç”¨æˆ·åªè¦èƒ½è®¿é—®åˆ°è¿™ä¸ª Serviceï¼Œå®ƒå°±èƒ½è®¿é—®åˆ°æŸä¸ªå…·ä½“çš„ Podã€‚é‚£ä¹ˆï¼Œè¿™ä¸ª Service åˆæ˜¯å¦‚ä½•è¢«è®¿é—®çš„å‘¢ï¼Ÿ\n**ç¬¬ä¸€ç§æ–¹å¼ï¼Œæ˜¯ä»¥ Service çš„ VIPï¼ˆVirtual IPï¼Œå³ï¼šè™šæ‹Ÿ IPï¼‰æ–¹å¼ã€‚**æ¯”å¦‚ï¼šå½“æˆ‘è®¿é—® 10.0.23.1 è¿™ä¸ª Service çš„ IP åœ°å€æ—¶ï¼Œ10.0.23.1 å…¶å®å°±æ˜¯ä¸€ä¸ª VIPï¼Œå®ƒä¼šæŠŠè¯·æ±‚è½¬å‘åˆ°è¯¥ Service æ‰€ä»£ç†çš„æŸä¸€ä¸ª Pod ä¸Šã€‚è¿™é‡Œçš„å…·ä½“åŸç†ï¼Œæˆ‘ä¼šåœ¨åç»­çš„ Service ç« èŠ‚ä¸­è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚\n**ç¬¬äºŒç§æ–¹å¼ï¼Œå°±æ˜¯ä»¥ Service çš„ DNS æ–¹å¼ã€‚**æ¯”å¦‚ï¼šè¿™æ—¶å€™ï¼Œåªè¦æˆ‘è®¿é—®â€œmy-svc.my-namespace.svc.cluster.localâ€è¿™æ¡ DNS è®°å½•ï¼Œå°±å¯ä»¥è®¿é—®åˆ°åå« my-svc çš„ Service æ‰€ä»£ç†çš„æŸä¸€ä¸ª Podã€‚\nè€Œåœ¨ç¬¬äºŒç§ Service DNS çš„æ–¹å¼ä¸‹ï¼Œå…·ä½“è¿˜å¯ä»¥åˆ†ä¸ºä¸¤ç§å¤„ç†æ–¹æ³•ï¼š\nç¬¬ä¸€ç§å¤„ç†æ–¹æ³•ï¼Œæ˜¯ Normal Serviceã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä½ è®¿é—®â€œmy-svc.my-namespace.svc.cluster.localâ€è§£æåˆ°çš„ï¼Œæ­£æ˜¯ my-svc è¿™ä¸ª Service çš„ VIPï¼Œåé¢çš„æµç¨‹å°±è·Ÿ VIP æ–¹å¼ä¸€è‡´äº†ã€‚\nè€Œç¬¬äºŒç§å¤„ç†æ–¹æ³•ï¼Œæ­£æ˜¯ Headless Serviceã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä½ è®¿é—®â€œmy-svc.my-namespace.svc.cluster.localâ€è§£æåˆ°çš„ï¼Œç›´æ¥å°±æ˜¯ my-svc ä»£ç†çš„æŸä¸€ä¸ª Pod çš„ IP åœ°å€ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„åŒºåˆ«åœ¨äºï¼ŒHeadless Service ä¸éœ€è¦åˆ†é…ä¸€ä¸ª VIPï¼Œè€Œæ˜¯å¯ä»¥ç›´æ¥ä»¥ DNS è®°å½•çš„æ–¹å¼è§£æå‡ºè¢«ä»£ç† Pod çš„ IP åœ°å€ã€‚\né‚£ä¹ˆï¼Œè¿™æ ·çš„è®¾è®¡åˆæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿæƒ³è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä» Headless Service çš„å®šä¹‰æ–¹å¼çœ‹èµ·ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Headless Service å¯¹åº”çš„ YAML æ–‡ä»¶ï¼š\napiVersion: v1 kind: Service metadata: name: nginx labels: app: nginx spec: ports: - port: 80 name: web clusterIP: None selector: app: nginx  å¯ä»¥çœ‹åˆ°ï¼Œæ‰€è°“çš„ Headless Serviceï¼Œå…¶å®ä»æ˜¯ä¸€ä¸ªæ ‡å‡† Service çš„ YAML æ–‡ä»¶ã€‚åªä¸è¿‡ï¼Œå®ƒçš„ clusterIP å­—æ®µçš„å€¼æ˜¯ï¼šNoneï¼Œå³ï¼šè¿™ä¸ª Serviceï¼Œæ²¡æœ‰ä¸€ä¸ª VIP ä½œä¸ºâ€œå¤´â€ã€‚è¿™ä¹Ÿå°±æ˜¯ Headless çš„å«ä¹‰ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ª Service è¢«åˆ›å»ºåå¹¶ä¸ä¼šè¢«åˆ†é…ä¸€ä¸ª VIPï¼Œè€Œæ˜¯ä¼šä»¥ DNS è®°å½•çš„æ–¹å¼æš´éœ²å‡ºå®ƒæ‰€ä»£ç†çš„ Podã€‚\nè€Œå®ƒæ‰€ä»£ç†çš„ Podï¼Œä¾ç„¶æ˜¯é‡‡ç”¨æˆ‘åœ¨å‰é¢ç¬¬ 12 ç¯‡æ–‡ç« ã€Šç‰›åˆ€å°è¯•ï¼šæˆ‘çš„ç¬¬ä¸€ä¸ªå®¹å™¨åŒ–åº”ç”¨ã€‹ä¸­æåˆ°çš„ Label Selector æœºåˆ¶é€‰æ‹©å‡ºæ¥çš„ï¼Œå³ï¼šæ‰€æœ‰æºå¸¦äº† app=nginx æ ‡ç­¾çš„ Podï¼Œéƒ½ä¼šè¢«è¿™ä¸ª Service ä»£ç†èµ·æ¥ã€‚ç„¶åå…³é”®æ¥äº†ã€‚å½“ä½ æŒ‰ç…§è¿™æ ·çš„æ–¹å¼åˆ›å»ºäº†ä¸€ä¸ª Headless Service ä¹‹åï¼Œå®ƒæ‰€ä»£ç†çš„æ‰€æœ‰ Pod çš„ IP åœ°å€ï¼Œéƒ½ä¼šè¢«ç»‘å®šä¸€ä¸ªè¿™æ ·æ ¼å¼çš„ DNS è®°å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n\u0026lt;pod-name\u0026gt;.\u0026lt;svc-name\u0026gt;.\u0026lt;namespace\u0026gt;.svc.cluster.local  è¿™ä¸ª DNS è®°å½•ï¼Œæ­£æ˜¯ Kubernetes é¡¹ç›®ä¸º Pod åˆ†é…çš„å”¯ä¸€çš„â€œå¯è§£æèº«ä»½â€ï¼ˆResolvable Identityï¼‰ã€‚\næœ‰äº†è¿™ä¸ªâ€œå¯è§£æèº«ä»½â€ï¼Œåªè¦ä½ çŸ¥é“äº†ä¸€ä¸ª Pod çš„åå­—ï¼Œä»¥åŠå®ƒå¯¹åº”çš„ Service çš„åå­—ï¼Œä½ å°±å¯ä»¥éå¸¸ç¡®å®šåœ°é€šè¿‡è¿™æ¡ DNS è®°å½•è®¿é—®åˆ° Pod çš„ IP åœ°å€ã€‚\né‚£ä¹ˆï¼ŒStatefulSet åˆæ˜¯å¦‚ä½•ä½¿ç”¨è¿™ä¸ª DNS è®°å½•æ¥ç»´æŒ Pod çš„æ‹“æ‰‘çŠ¶æ€çš„å‘¢ï¼Ÿä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œç°åœ¨æˆ‘ä»¬å°±æ¥ç¼–å†™ä¸€ä¸ª StatefulSet çš„ YAML æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: apps/v1 kind: StatefulSet metadata: name: web spec: serviceName: \u0026quot;nginx\u0026quot; replicas: 2 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.9.1 ports: - containerPort: 80 name: web  è¿™ä¸ª YAML æ–‡ä»¶ï¼Œå’Œæˆ‘ä»¬åœ¨å‰é¢æ–‡ç« ä¸­ç”¨åˆ°çš„ nginx-deployment çš„å”¯ä¸€åŒºåˆ«ï¼Œå°±æ˜¯å¤šäº†ä¸€ä¸ª serviceName=nginx å­—æ®µã€‚è¿™ä¸ªå­—æ®µçš„ä½œç”¨ï¼Œå°±æ˜¯å‘Šè¯‰ StatefulSet æ§åˆ¶å™¨ï¼Œåœ¨æ‰§è¡Œæ§åˆ¶å¾ªç¯ï¼ˆControl Loopï¼‰çš„æ—¶å€™ï¼Œè¯·ä½¿ç”¨ nginx è¿™ä¸ª Headless Service æ¥ä¿è¯ Pod çš„â€œå¯è§£æèº«ä»½â€ã€‚æ‰€ä»¥ï¼Œå½“ä½ é€šè¿‡ kubectl create åˆ›å»ºäº†ä¸Šé¢è¿™ä¸ª Service å’Œ StatefulSet ä¹‹åï¼Œå°±ä¼šçœ‹åˆ°å¦‚ä¸‹ä¸¤ä¸ªå¯¹è±¡ï¼š\n$ kubectl create -f svc.yaml $ kubectl get service nginx NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx ClusterIP None \u0026lt;none\u0026gt; 80/TCP 10s $ kubectl create -f statefulset.yaml $ kubectl get statefulset web NAME DESIRED CURRENT AGE web 2 1 19s  è¿™æ—¶å€™ï¼Œå¦‚æœä½ æ‰‹æ¯”è¾ƒå¿«çš„è¯ï¼Œè¿˜å¯ä»¥é€šè¿‡ kubectl çš„ -w å‚æ•°ï¼Œå³ï¼šWatch åŠŸèƒ½ï¼Œå®æ—¶æŸ¥çœ‹ StatefulSet åˆ›å»ºä¸¤ä¸ªæœ‰çŠ¶æ€å®ä¾‹çš„è¿‡ç¨‹ï¼š\n å¤‡æ³¨ï¼šå¦‚æœæ‰‹ä¸å¤Ÿå¿«çš„è¯ï¼ŒPod å¾ˆå¿«å°±åˆ›å»ºå®Œäº†ã€‚ä¸è¿‡ï¼Œä½ ä¾ç„¶å¯ä»¥é€šè¿‡è¿™ä¸ª StatefulSet çš„ Events çœ‹åˆ°è¿™äº›ä¿¡æ¯ã€‚\n $ kubectl get pods -w -l app=nginx NAME READY STATUS RESTARTS AGE web-0 0/1 Pending 0 0s web-0 0/1 Pending 0 0s web-0 0/1 ContainerCreating 0 0s web-0 1/1 Running 0 19s web-1 0/1 Pending 0 0s web-1 0/1 Pending 0 0s web-1 0/1 ContainerCreating 0 0s web-1 1/1 Running 0 20s  é€šè¿‡ä¸Šé¢è¿™ä¸ª Pod çš„åˆ›å»ºè¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹åˆ°ï¼ŒStatefulSet ç»™å®ƒæ‰€ç®¡ç†çš„æ‰€æœ‰ Pod çš„åå­—ï¼Œè¿›è¡Œäº†ç¼–å·ï¼Œç¼–å·è§„åˆ™æ˜¯ï¼š-ã€‚\nè€Œä¸”è¿™äº›ç¼–å·éƒ½æ˜¯ä» 0 å¼€å§‹ç´¯åŠ ï¼Œä¸ StatefulSet çš„æ¯ä¸ª Pod å®ä¾‹ä¸€ä¸€å¯¹åº”ï¼Œç»ä¸é‡å¤ã€‚\næ›´é‡è¦çš„æ˜¯ï¼Œè¿™äº› Pod çš„åˆ›å»ºï¼Œä¹Ÿæ˜¯ä¸¥æ ¼æŒ‰ç…§ç¼–å·é¡ºåºè¿›è¡Œçš„ã€‚æ¯”å¦‚ï¼Œåœ¨ web-0 è¿›å…¥åˆ° Running çŠ¶æ€ã€å¹¶ä¸”ç»†åˆ†çŠ¶æ€ï¼ˆConditionsï¼‰æˆä¸º Ready ä¹‹å‰ï¼Œweb-1 ä¼šä¸€ç›´å¤„äº Pending çŠ¶æ€ã€‚\nå½“è¿™ä¸¤ä¸ª Pod éƒ½è¿›å…¥äº† Running çŠ¶æ€ä¹‹åï¼Œä½ å°±å¯ä»¥æŸ¥çœ‹åˆ°å®ƒä»¬å„è‡ªå”¯ä¸€çš„â€œç½‘ç»œèº«ä»½â€äº†ã€‚\næˆ‘ä»¬ä½¿ç”¨ kubectl exec å‘½ä»¤è¿›å…¥åˆ°å®¹å™¨ä¸­æŸ¥çœ‹å®ƒä»¬çš„ hostnameï¼š\n$ kubectl exec web-0 -- sh -c 'hostname' web-0 $ kubectl exec web-1 -- sh -c 'hostname' web-1  å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸¤ä¸ª Pod çš„ hostname ä¸ Pod åå­—æ˜¯ä¸€è‡´çš„ï¼Œéƒ½è¢«åˆ†é…äº†å¯¹åº”çš„ç¼–å·ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†è¯•ç€ä»¥ DNS çš„æ–¹å¼ï¼Œè®¿é—®ä¸€ä¸‹è¿™ä¸ª Headless Serviceï¼š\n$ kubectl run -i --tty --image busybox:1.28.4 dns-test --restart=Never --rm /bin/sh  é€šè¿‡è¿™æ¡å‘½ä»¤ï¼Œæˆ‘ä»¬å¯åŠ¨äº†ä¸€ä¸ªä¸€æ¬¡æ€§çš„ Podï¼Œå› ä¸ºâ€“rm æ„å‘³ç€ Pod é€€å‡ºåå°±ä¼šè¢«åˆ é™¤æ‰ã€‚ç„¶åï¼Œåœ¨è¿™ä¸ª Pod çš„å®¹å™¨é‡Œé¢ï¼Œæˆ‘ä»¬å°è¯•ç”¨ nslookup å‘½ä»¤ï¼Œè§£æä¸€ä¸‹ Pod å¯¹åº”çš„ Headless Serviceï¼š\n$ kubectl run -i --tty --image busybox:1.28.4 dns-test --restart=Never --rm /bin/sh $ nslookup web-0.nginx Server: 10.0.0.10 Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local Name: web-0.nginx Address 1: 10.244.1.7 $ nslookup web-1.nginx Server: 10.0.0.10 Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local Name: web-1.nginx Address 1: 10.244.2.7  ä» nslookup å‘½ä»¤çš„è¾“å‡ºç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è®¿é—® web-0.nginx çš„æ—¶å€™ï¼Œæœ€åè§£æåˆ°çš„ï¼Œæ­£æ˜¯ web-0 è¿™ä¸ª Pod çš„ IP åœ°å€ï¼›è€Œå½“è®¿é—® web-1.nginx çš„æ—¶å€™ï¼Œè§£æåˆ°çš„åˆ™æ˜¯ web-1 çš„ IP åœ°å€ã€‚\nè¿™æ—¶å€™ï¼Œå¦‚æœä½ åœ¨å¦å¤–ä¸€ä¸ª Terminal é‡ŒæŠŠè¿™ä¸¤ä¸ªâ€œæœ‰çŠ¶æ€åº”ç”¨â€çš„ Pod åˆ æ‰ï¼š\n$ kubectl delete pod -l app=nginx pod \u0026quot;web-0\u0026quot; deleted pod \u0026quot;web-1\u0026quot; deleted  ç„¶åï¼Œå†åœ¨å½“å‰ Terminal é‡Œ Watch ä¸€ä¸‹è¿™ä¸¤ä¸ª Pod çš„çŠ¶æ€å˜åŒ–ï¼Œå°±ä¼šå‘ç°ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ï¼š\n$ kubectl get pod -w -l app=nginx NAME READY STATUS RESTARTS AGE web-0 0/1 ContainerCreating 0 0s NAME READY STATUS RESTARTS AGE web-0 1/1 Running 0 2s web-1 0/1 Pending 0 0s web-1 0/1 ContainerCreating 0 0s web-1 1/1 Running 0 32s  å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬æŠŠè¿™ä¸¤ä¸ª Pod åˆ é™¤ä¹‹åï¼ŒKubernetes ä¼šæŒ‰ç…§åŸå…ˆç¼–å·çš„é¡ºåºï¼Œåˆ›å»ºå‡ºäº†ä¸¤ä¸ªæ–°çš„ Podã€‚å¹¶ä¸”ï¼ŒKubernetes ä¾ç„¶ä¸ºå®ƒä»¬åˆ†é…äº†ä¸åŸæ¥ç›¸åŒçš„â€œç½‘ç»œèº«ä»½â€ï¼šweb-0.nginx å’Œ web-1.nginxã€‚\né€šè¿‡è¿™ç§ä¸¥æ ¼çš„å¯¹åº”è§„åˆ™ï¼ŒStatefulSet å°±ä¿è¯äº† Pod ç½‘ç»œæ ‡è¯†çš„ç¨³å®šæ€§ã€‚\næ¯”å¦‚ï¼Œå¦‚æœ web-0 æ˜¯ä¸€ä¸ªéœ€è¦å…ˆå¯åŠ¨çš„ä¸»èŠ‚ç‚¹ï¼Œweb-1 æ˜¯ä¸€ä¸ªåå¯åŠ¨çš„ä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ª StatefulSet ä¸è¢«åˆ é™¤ï¼Œä½ è®¿é—® web-0.nginx æ—¶å§‹ç»ˆéƒ½ä¼šè½åœ¨ä¸»èŠ‚ç‚¹ä¸Šï¼Œè®¿é—® web-1.nginx æ—¶ï¼Œåˆ™å§‹ç»ˆéƒ½ä¼šè½åœ¨ä»èŠ‚ç‚¹ä¸Šï¼Œè¿™ä¸ªå…³ç³»ç»å¯¹ä¸ä¼šå‘ç”Ÿä»»ä½•å˜åŒ–ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬å†ç”¨ nslookup å‘½ä»¤ï¼ŒæŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–° Pod å¯¹åº”çš„ Headless Service çš„è¯ï¼š\n$ kubectl run -i --tty --image busybox dns-test --restart=Never --rm /bin/sh $ nslookup web-0.nginx Server: 10.0.0.10 Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local Name: web-0.nginx Address 1: 10.244.1.8 $ nslookup web-1.nginx Server: 10.0.0.10 Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local Name: web-1.nginx Address 1: 10.244.2.8  æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ª StatefulSet ä¸­ï¼Œè¿™ä¸¤ä¸ªæ–° Pod çš„â€œç½‘ç»œæ ‡è¯†â€ï¼ˆæ¯”å¦‚ï¼šweb-0.nginx å’Œ web-1.nginxï¼‰ï¼Œå†æ¬¡è§£æåˆ°äº†æ­£ç¡®çš„ IP åœ°å€ï¼ˆæ¯”å¦‚ï¼šweb-0 Pod çš„ IP åœ°å€ 10.244.1.8ï¼‰ã€‚\né€šè¿‡è¿™ç§æ–¹æ³•ï¼ŒKubernetes å°±æˆåŠŸåœ°å°† Pod çš„æ‹“æ‰‘çŠ¶æ€ï¼ˆæ¯”å¦‚ï¼šå“ªä¸ªèŠ‚ç‚¹å…ˆå¯åŠ¨ï¼Œå“ªä¸ªèŠ‚ç‚¹åå¯åŠ¨ï¼‰ï¼ŒæŒ‰ç…§ Pod çš„â€œåå­— + ç¼–å·â€çš„æ–¹å¼å›ºå®šäº†ä¸‹æ¥ã€‚æ­¤å¤–ï¼ŒKubernetes è¿˜ä¸ºæ¯ä¸€ä¸ª Pod æä¾›äº†ä¸€ä¸ªå›ºå®šå¹¶ä¸”å”¯ä¸€çš„è®¿é—®å…¥å£ï¼Œå³ï¼šè¿™ä¸ª Pod å¯¹åº”çš„ DNS è®°å½•ã€‚è¿™äº›çŠ¶æ€ï¼Œåœ¨ StatefulSet çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸé‡Œéƒ½ä¼šä¿æŒä¸å˜ï¼Œç»ä¸ä¼šå› ä¸ºå¯¹åº” Pod çš„åˆ é™¤æˆ–è€…é‡æ–°åˆ›å»ºè€Œå¤±æ•ˆã€‚\nä¸è¿‡ï¼Œç›¸ä¿¡ä½ ä¹Ÿå·²ç»æ³¨æ„åˆ°äº†ï¼Œå°½ç®¡ web-0.nginx è¿™æ¡è®°å½•æœ¬èº«ä¸ä¼šå˜ï¼Œä½†å®ƒè§£æåˆ°çš„ Pod çš„ IP åœ°å€ï¼Œå¹¶ä¸æ˜¯å›ºå®šçš„ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¯¹äºâ€œæœ‰çŠ¶æ€åº”ç”¨â€å®ä¾‹çš„è®¿é—®ï¼Œä½ å¿…é¡»ä½¿ç”¨ DNS è®°å½•æˆ–è€… hostname çš„æ–¹å¼ï¼Œè€Œç»ä¸åº”è¯¥ç›´æ¥è®¿é—®è¿™äº› Pod çš„ IP åœ°å€ã€‚\næ€»ç»“\nåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘é¦–å…ˆå’Œä½ åˆ†äº«äº† StatefulSet çš„åŸºæœ¬æ¦‚å¿µï¼Œè§£é‡Šäº†ä»€ä¹ˆæ˜¯åº”ç”¨çš„â€œçŠ¶æ€â€ã€‚\nç´§æ¥ç€ ï¼Œæˆ‘ä¸ºä½ åˆ†æäº† StatefulSet å¦‚ä½•ä¿è¯åº”ç”¨å®ä¾‹ä¹‹é—´â€œæ‹“æ‰‘çŠ¶æ€â€çš„ç¨³å®šæ€§ã€‚\nå¦‚æœç”¨ä¸€å¥è¯æ¥æ€»ç»“çš„è¯ï¼Œä½ å¯ä»¥è¿™ä¹ˆç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š\n StatefulSet è¿™ä¸ªæ§åˆ¶å™¨çš„ä¸»è¦ä½œç”¨ä¹‹ä¸€ï¼Œå°±æ˜¯ä½¿ç”¨ Pod æ¨¡æ¿åˆ›å»º Pod çš„æ—¶å€™ï¼Œå¯¹å®ƒä»¬è¿›è¡Œç¼–å·ï¼Œå¹¶ä¸”æŒ‰ç…§ç¼–å·é¡ºåºé€ä¸€å®Œæˆåˆ›å»ºå·¥ä½œã€‚è€Œå½“ StatefulSet çš„â€œæ§åˆ¶å¾ªç¯â€å‘ç° Pod çš„â€œå®é™…çŠ¶æ€â€ä¸â€œæœŸæœ›çŠ¶æ€â€ä¸ä¸€è‡´ï¼Œéœ€è¦æ–°å»ºæˆ–è€…åˆ é™¤ Pod è¿›è¡Œâ€œè°ƒè°â€çš„æ—¶å€™ï¼Œå®ƒä¼šä¸¥æ ¼æŒ‰ç…§è¿™äº› Pod ç¼–å·çš„é¡ºåºï¼Œé€ä¸€å®Œæˆè¿™äº›æ“ä½œã€‚\n æ‰€ä»¥ï¼ŒStatefulSet å…¶å®å¯ä»¥è®¤ä¸ºæ˜¯å¯¹ Deployment çš„æ”¹è‰¯ã€‚\nä¸æ­¤åŒæ—¶ï¼Œé€šè¿‡ Headless Service çš„æ–¹å¼ï¼ŒStatefulSet ä¸ºæ¯ä¸ª Pod åˆ›å»ºäº†ä¸€ä¸ªå›ºå®šå¹¶ä¸”ç¨³å®šçš„ DNS è®°å½•ï¼Œæ¥ä½œä¸ºå®ƒçš„è®¿é—®å…¥å£ã€‚å®é™…ä¸Šï¼Œåœ¨éƒ¨ç½²â€œæœ‰çŠ¶æ€åº”ç”¨â€çš„æ—¶å€™ï¼Œåº”ç”¨çš„æ¯ä¸ªå®ä¾‹æ‹¥æœ‰å”¯ä¸€å¹¶ä¸”ç¨³å®šçš„â€œç½‘ç»œæ ‡è¯†â€ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å‡è®¾ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä¼šç»§ç»­ä¸ºä½ å‰–æ StatefulSet å¦‚ä½•å¤„ç†å­˜å‚¨çŠ¶æ€ã€‚\n","date":"2021å¹´03æœˆ03æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/statefulset-1/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹ï¼Œæœ¬èŠ‚å†…å®¹ä¸»è¦ä»‹ç» StatefulSet çš„æ‹“æ‰‘çŠ¶æ€\u003c/p\u003e\n\u003c/blockquote\u003e","title":"æ·±å…¥ç†è§£StatefulSetï¼ˆä¸€ï¼‰ï¼šæ‹“æ‰‘çŠ¶æ€"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹\n ä½œä¸šå‰¯æœ¬ æ°´å¹³æ‰©å®¹   Deployment çœ‹ä¼¼ç®€å•ï¼Œä½†å®é™…ä¸Šï¼Œå®ƒå®ç°äº† Kubernetes é¡¹ç›®ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½ï¼šPod çš„â€œæ°´å¹³æ‰©å±• / æ”¶ç¼©â€ï¼ˆhorizontal scaling out/inï¼‰ã€‚è¿™ä¸ªåŠŸèƒ½ï¼Œæ˜¯ä» PaaS æ—¶ä»£å¼€å§‹ï¼Œä¸€ä¸ªå¹³å°çº§é¡¹ç›®å°±å¿…é¡»å…·å¤‡çš„ç¼–æ’èƒ½åŠ›ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æ›´æ–°äº† Deployment çš„ Pod æ¨¡æ¿ï¼ˆæ¯”å¦‚ï¼Œä¿®æ”¹äº†å®¹å™¨çš„é•œåƒï¼‰ï¼Œé‚£ä¹ˆ Deployment å°±éœ€è¦éµå¾ªä¸€ç§å«ä½œâ€œæ»šåŠ¨æ›´æ–°â€ï¼ˆrolling updateï¼‰çš„æ–¹å¼ï¼Œæ¥å‡çº§ç°æœ‰çš„å®¹å™¨ã€‚è€Œè¿™ä¸ªèƒ½åŠ›çš„å®ç°ï¼Œä¾èµ–çš„æ˜¯ Kubernetes é¡¹ç›®ä¸­çš„ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼ˆAPI å¯¹è±¡ï¼‰ï¼šReplicaSetã€‚\nReplicaSet çš„ç»“æ„éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ª YAML æ–‡ä»¶æŸ¥çœ‹ä¸€ä¸‹ï¼š\napiVersion: apps/v1 kind: ReplicaSet metadata: name: nginx-set labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.7.9  ä»è¿™ä¸ª YAML æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ª ReplicaSet å¯¹è±¡ï¼Œ**å…¶å®å°±æ˜¯ç”±å‰¯æœ¬æ•°ç›®çš„å®šä¹‰å’Œä¸€ä¸ª Pod æ¨¡æ¿ç»„æˆçš„ã€‚ä¸éš¾å‘ç°ï¼Œå®ƒçš„å®šä¹‰å…¶å®æ˜¯ Deployment çš„ä¸€ä¸ªå­é›†ã€‚æ›´é‡è¦çš„æ˜¯ï¼ŒDeployment æ§åˆ¶å™¨å®é™…æ“çºµçš„ï¼Œæ­£æ˜¯è¿™æ ·çš„ ReplicaSet å¯¹è±¡ï¼Œè€Œä¸æ˜¯ Pod å¯¹è±¡ã€‚**è¿˜è®°ä¸è®°å¾—æˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ã€Šç¼–æ’å…¶å®å¾ˆç®€å•ï¼šè°ˆè°ˆâ€œæ§åˆ¶å™¨â€æ¨¡å‹ã€‹ä¸­æ›¾ç»æå‡ºè¿‡è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå¯¹äºä¸€ä¸ª Deployment æ‰€ç®¡ç†çš„ Podï¼Œå®ƒçš„ ownerReference æ˜¯è°ï¼Ÿæ‰€ä»¥ï¼Œè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆå°±æ˜¯ï¼šReplicaSetã€‚\næ˜ç™½äº†è¿™ä¸ªåŸç†ï¼Œæˆ‘å†æ¥å’Œä½ ä¸€èµ·åˆ†æä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„ Deploymentï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.7.9 ports: - containerPort: 80  å¯ä»¥çœ‹åˆ°ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæˆ‘ä»¬å¸¸ç”¨çš„ nginx-deploymentï¼Œå®ƒå®šä¹‰çš„ Pod å‰¯æœ¬ä¸ªæ•°æ˜¯ 3ï¼ˆspec.replicas=3ï¼‰ã€‚é‚£ä¹ˆï¼Œåœ¨å…·ä½“çš„å®ç°ä¸Šï¼Œè¿™ä¸ª Deploymentï¼Œä¸ ReplicaSetï¼Œä»¥åŠ Pod çš„å…³ç³»æ˜¯æ€æ ·çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨ä¸€å¼ å›¾æŠŠå®ƒæè¿°å‡ºæ¥ï¼š\né€šè¿‡è¿™å¼ å›¾ï¼Œæˆ‘ä»¬å°±å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°ï¼Œä¸€ä¸ªå®šä¹‰äº† replicas=3 çš„ Deploymentï¼Œä¸å®ƒçš„ ReplicaSetï¼Œä»¥åŠ Pod çš„å…³ç³»ï¼Œå®é™…ä¸Šæ˜¯ä¸€ç§â€œå±‚å±‚æ§åˆ¶â€çš„å…³ç³»ã€‚å…¶ä¸­ï¼ŒReplicaSet è´Ÿè´£é€šè¿‡â€œæ§åˆ¶å™¨æ¨¡å¼â€ï¼Œä¿è¯ç³»ç»Ÿä¸­ Pod çš„ä¸ªæ•°æ°¸è¿œç­‰äºæŒ‡å®šçš„ä¸ªæ•°ï¼ˆæ¯”å¦‚ï¼Œ3 ä¸ªï¼‰ã€‚è¿™ä¹Ÿæ­£æ˜¯ Deployment åªå…è®¸å®¹å™¨çš„ restartPolicy=Always çš„ä¸»è¦åŸå› ï¼šåªæœ‰åœ¨å®¹å™¨èƒ½ä¿è¯è‡ªå·±å§‹ç»ˆæ˜¯ Running çŠ¶æ€çš„å‰æä¸‹ï¼ŒReplicaSet è°ƒæ•´ Pod çš„ä¸ªæ•°æ‰æœ‰æ„ä¹‰ã€‚è€Œåœ¨æ­¤åŸºç¡€ä¸Šï¼ŒDeployment åŒæ ·é€šè¿‡â€œæ§åˆ¶å™¨æ¨¡å¼â€ï¼Œæ¥æ“ä½œ ReplicaSet çš„ä¸ªæ•°å’Œå±æ€§ï¼Œè¿›è€Œå®ç°â€œæ°´å¹³æ‰©å±• / æ”¶ç¼©â€å’Œâ€œæ»šåŠ¨æ›´æ–°â€è¿™ä¸¤ä¸ªç¼–æ’åŠ¨ä½œã€‚\nå…¶ä¸­ï¼Œâ€œæ°´å¹³æ‰©å±• / æ”¶ç¼©â€éå¸¸å®¹æ˜“å®ç°ï¼ŒDeployment Controller åªéœ€è¦ä¿®æ”¹å®ƒæ‰€æ§åˆ¶çš„ ReplicaSet çš„ Pod å‰¯æœ¬ä¸ªæ•°å°±å¯ä»¥äº†ã€‚æ¯”å¦‚ï¼ŒæŠŠè¿™ä¸ªå€¼ä» 3 æ”¹æˆ 4ï¼Œé‚£ä¹ˆ Deployment æ‰€å¯¹åº”çš„ ReplicaSetï¼Œå°±ä¼šæ ¹æ®ä¿®æ”¹åçš„å€¼è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Podã€‚è¿™å°±æ˜¯â€œæ°´å¹³æ‰©å±•â€äº†ï¼›â€œæ°´å¹³æ”¶ç¼©â€åˆ™åä¹‹ã€‚è€Œç”¨æˆ·æƒ³è¦æ‰§è¡Œè¿™ä¸ªæ“ä½œçš„æŒ‡ä»¤ä¹Ÿéå¸¸ç®€å•ï¼Œå°±æ˜¯ kubectl scaleï¼Œæ¯”å¦‚ï¼š\n$ kubectl scale deployment nginx-deployment --replicas=4 deployment.apps/nginx-deployment scaled  é‚£ä¹ˆï¼Œâ€œæ»šåŠ¨æ›´æ–°â€åˆæ˜¯ä»€ä¹ˆæ„æ€ï¼Œæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ\næ¥ä¸‹æ¥ï¼Œæˆ‘è¿˜ä»¥è¿™ä¸ª Deployment ä¸ºä¾‹ï¼Œæ¥ä¸ºä½ è®²è§£â€œæ»šåŠ¨æ›´æ–°â€çš„è¿‡ç¨‹ã€‚\né¦–å…ˆï¼Œæˆ‘ä»¬æ¥åˆ›å»ºè¿™ä¸ª nginx-deploymentï¼š\n$ kubectl create -f nginx-deployment.yaml --record  ç„¶åï¼Œæˆ‘ä»¬æ¥æ£€æŸ¥ä¸€ä¸‹ nginx-deployment åˆ›å»ºåçš„çŠ¶æ€ä¿¡æ¯ï¼š\n$ kubectl get deployments NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE nginx-deployment 3 0 0 0 1s  åœ¨è¿”å›ç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å››ä¸ªçŠ¶æ€å­—æ®µï¼Œå®ƒä»¬çš„å«ä¹‰å¦‚ä¸‹æ‰€ç¤ºã€‚\n DESIREDï¼šç”¨æˆ·æœŸæœ›çš„ Pod å‰¯æœ¬ä¸ªæ•°ï¼ˆspec.replicas çš„å€¼ï¼‰ï¼› CURRENTï¼šå½“å‰å¤„äº Running çŠ¶æ€çš„ Pod çš„ä¸ªæ•°ï¼› UP-TO-DATEï¼šå½“å‰å¤„äºæœ€æ–°ç‰ˆæœ¬çš„ Pod çš„ä¸ªæ•°ï¼Œæ‰€è°“æœ€æ–°ç‰ˆæœ¬æŒ‡çš„æ˜¯ Pod çš„ Spec éƒ¨åˆ†ä¸ Deployment é‡Œ Pod æ¨¡æ¿é‡Œå®šä¹‰çš„å®Œå…¨ä¸€è‡´ï¼› AVAILABLEï¼šå½“å‰å·²ç»å¯ç”¨çš„ Pod çš„ä¸ªæ•°ï¼Œå³ï¼šæ—¢æ˜¯ Running çŠ¶æ€ï¼Œåˆæ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶ä¸”å·²ç»å¤„äº Readyï¼ˆå¥åº·æ£€æŸ¥æ­£ç¡®ï¼‰çŠ¶æ€çš„ Pod çš„ä¸ªæ•°ã€‚  å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰è¿™ä¸ª AVAILABLE å­—æ®µï¼Œæè¿°çš„æ‰æ˜¯ç”¨æˆ·æ‰€æœŸæœ›çš„æœ€ç»ˆçŠ¶æ€ã€‚è€Œ Kubernetes é¡¹ç›®è¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€æ¡æŒ‡ä»¤ï¼Œè®©æˆ‘ä»¬å¯ä»¥å®æ—¶æŸ¥çœ‹ Deployment å¯¹è±¡çš„çŠ¶æ€å˜åŒ–ã€‚è¿™ä¸ªæŒ‡ä»¤å°±æ˜¯ kubectl rollout statusï¼š\n$ kubectl rollout status deployment/nginx-deployment Waiting for rollout to finish: 2 out of 3 new replicas have been updated... deployment.apps/nginx-deployment successfully rolled out  åœ¨è¿™ä¸ªè¿”å›ç»“æœä¸­ï¼Œâ€œ2 out of 3 new replicas have been updatedâ€æ„å‘³ç€å·²ç»æœ‰ 2 ä¸ª Pod è¿›å…¥äº† UP-TO-DATE çŠ¶æ€ã€‚ç»§ç»­ç­‰å¾…ä¸€ä¼šå„¿ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°è¿™ä¸ª Deployment çš„ 3 ä¸ª Podï¼Œå°±è¿›å…¥åˆ°äº† AVAILABLE çŠ¶æ€ï¼š\nNAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE nginx-deployment 3 3 3 3 20s  æ­¤æ—¶ï¼Œä½ å¯ä»¥å°è¯•æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ª Deployment æ‰€æ§åˆ¶çš„ ReplicaSetï¼š\n$ kubectl get rs NAME DESIRED CURRENT READY AGE nginx-deployment-3167673210 3 3 3 20s  å¦‚ä¸Šæ‰€ç¤ºï¼Œåœ¨ç”¨æˆ·æäº¤äº†ä¸€ä¸ª Deployment å¯¹è±¡åï¼ŒDeployment Controller å°±ä¼šç«‹å³åˆ›å»ºä¸€ä¸ª Pod å‰¯æœ¬ä¸ªæ•°ä¸º 3 çš„ ReplicaSetã€‚è¿™ä¸ª ReplicaSet çš„åå­—ï¼Œåˆ™æ˜¯ç”± Deployment çš„åå­—å’Œä¸€ä¸ªéšæœºå­—ç¬¦ä¸²å…±åŒç»„æˆã€‚\nè¿™ä¸ªéšæœºå­—ç¬¦ä¸²å«ä½œ pod-template-hashï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­é‡Œå°±æ˜¯ï¼š3167673210ã€‚ReplicaSet ä¼šæŠŠè¿™ä¸ªéšæœºå­—ç¬¦ä¸²åŠ åœ¨å®ƒæ‰€æ§åˆ¶çš„æ‰€æœ‰ Pod çš„æ ‡ç­¾é‡Œï¼Œä»è€Œä¿è¯è¿™äº› Pod ä¸ä¼šä¸é›†ç¾¤é‡Œçš„å…¶ä»– Pod æ··æ·†ã€‚\nè€Œ ReplicaSet çš„ DESIREDã€CURRENT å’Œ READY å­—æ®µçš„å«ä¹‰ï¼Œå’Œ Deployment ä¸­æ˜¯ä¸€è‡´çš„ã€‚æ‰€ä»¥ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼ŒDeployment åªæ˜¯åœ¨ ReplicaSet çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº† UP-TO-DATE è¿™ä¸ªè·Ÿç‰ˆæœ¬æœ‰å…³çš„çŠ¶æ€å­—æ®µã€‚\nè¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬ä¿®æ”¹äº† Deployment çš„ Pod æ¨¡æ¿ï¼Œâ€œæ»šåŠ¨æ›´æ–°â€å°±ä¼šè¢«è‡ªåŠ¨è§¦å‘ã€‚ä¿®æ”¹ Deployment æœ‰å¾ˆå¤šæ–¹æ³•ã€‚æ¯”å¦‚ï¼Œæˆ‘å¯ä»¥ç›´æ¥ä½¿ç”¨ kubectl edit æŒ‡ä»¤ç¼–è¾‘ Etcd é‡Œçš„ API å¯¹è±¡ã€‚\n$ kubectl edit deployment/nginx-deployment ... spec: containers: - name: nginx image: nginx:1.9.1 # 1.7.9 -\u0026gt; 1.9.1 ports: - containerPort: 80 ... deployment.extensions/nginx-deployment edited  è¿™ä¸ª kubectl edit æŒ‡ä»¤ï¼Œä¼šå¸®ä½ ç›´æ¥æ‰“å¼€ nginx-deployment çš„ API å¯¹è±¡ã€‚ç„¶åï¼Œä½ å°±å¯ä»¥ä¿®æ”¹è¿™é‡Œçš„ Pod æ¨¡æ¿éƒ¨åˆ†äº†ã€‚æ¯”å¦‚ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘å°† nginx é•œåƒçš„ç‰ˆæœ¬å‡çº§åˆ°äº† 1.9.1ã€‚\n å¤‡æ³¨ï¼škubectl edit å¹¶ä¸ç¥ç§˜ï¼Œå®ƒä¸è¿‡æ˜¯æŠŠ API å¯¹è±¡çš„å†…å®¹ä¸‹è½½åˆ°äº†æœ¬åœ°æ–‡ä»¶ï¼Œè®©ä½ ä¿®æ”¹å®Œæˆåå†æäº¤ä¸Šå»ã€‚\n kubectl edit æŒ‡ä»¤ç¼–è¾‘å®Œæˆåï¼Œä¿å­˜é€€å‡ºï¼ŒKubernetes å°±ä¼šç«‹åˆ»è§¦å‘â€œæ»šåŠ¨æ›´æ–°â€çš„è¿‡ç¨‹ã€‚ä½ è¿˜å¯ä»¥é€šè¿‡ kubectl rollout status æŒ‡ä»¤æŸ¥çœ‹ nginx-deployment çš„çŠ¶æ€å˜åŒ–ï¼š\n$ kubectl rollout status deployment/nginx-deployment Waiting for rollout to finish: 2 out of 3 new replicas have been updated... deployment.extensions/nginx-deployment successfully rolled out  è¿™æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹ Deployment çš„ Eventsï¼Œçœ‹åˆ°è¿™ä¸ªâ€œæ»šåŠ¨æ›´æ–°â€çš„æµç¨‹ï¼š\n$ kubectl describe deployment nginx-deployment ... Events: Type Reason Age From Message ---- ------ ---- ---- ------- ... Normal ScalingReplicaSet 24s deployment-controller Scaled up replica set nginx-deployment-1764197365 to 1 Normal ScalingReplicaSet 22s deployment-controller Scaled down replica set nginx-deployment-3167673210 to 2 Normal ScalingReplicaSet 22s deployment-controller Scaled up replica set nginx-deployment-1764197365 to 2 Normal ScalingReplicaSet 19s deployment-controller Scaled down replica set nginx-deployment-3167673210 to 1 Normal ScalingReplicaSet 19s deployment-controller Scaled up replica set nginx-deployment-1764197365 to 3 Normal ScalingReplicaSet 14s deployment-controller Scaled down replica set nginx-deployment-3167673210 to 0  å¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆï¼Œå½“ä½ ä¿®æ”¹äº† Deployment é‡Œçš„ Pod å®šä¹‰ä¹‹åï¼ŒDeployment Controller ä¼šä½¿ç”¨è¿™ä¸ªä¿®æ”¹åçš„ Pod æ¨¡æ¿ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ ReplicaSetï¼ˆhash=1764197365ï¼‰ï¼Œè¿™ä¸ªæ–°çš„ ReplicaSet çš„åˆå§‹ Pod å‰¯æœ¬æ•°æ˜¯ï¼š0ã€‚ç„¶åï¼Œåœ¨ Age=24 s çš„ä½ç½®ï¼ŒDeployment Controller å¼€å§‹å°†è¿™ä¸ªæ–°çš„ ReplicaSet æ‰€æ§åˆ¶çš„ Pod å‰¯æœ¬æ•°ä» 0 ä¸ªå˜æˆ 1 ä¸ªï¼Œå³ï¼šâ€œæ°´å¹³æ‰©å±•â€å‡ºä¸€ä¸ªå‰¯æœ¬ã€‚ç´§æ¥ç€ï¼Œåœ¨ Age=22 s çš„ä½ç½®ï¼ŒDeployment Controller åˆå°†æ—§çš„ ReplicaSetï¼ˆhash=3167673210ï¼‰æ‰€æ§åˆ¶çš„æ—§ Pod å‰¯æœ¬æ•°å‡å°‘ä¸€ä¸ªï¼Œå³ï¼šâ€œæ°´å¹³æ”¶ç¼©â€æˆä¸¤ä¸ªå‰¯æœ¬ã€‚å¦‚æ­¤äº¤æ›¿è¿›è¡Œï¼Œæ–° ReplicaSet ç®¡ç†çš„ Pod å‰¯æœ¬æ•°ï¼Œä» 0 ä¸ªå˜æˆ 1 ä¸ªï¼Œå†å˜æˆ 2 ä¸ªï¼Œæœ€åå˜æˆ 3 ä¸ªã€‚è€Œæ—§çš„ ReplicaSet ç®¡ç†çš„ Pod å‰¯æœ¬æ•°åˆ™ä» 3 ä¸ªå˜æˆ 2 ä¸ªï¼Œå†å˜æˆ 1 ä¸ªï¼Œæœ€åå˜æˆ 0 ä¸ªã€‚\nè¿™æ ·ï¼Œå°±å®Œæˆäº†è¿™ä¸€ç»„ Pod çš„ç‰ˆæœ¬å‡çº§è¿‡ç¨‹ã€‚åƒè¿™æ ·ï¼Œå°†ä¸€ä¸ªé›†ç¾¤ä¸­æ­£åœ¨è¿è¡Œçš„å¤šä¸ª Pod ç‰ˆæœ¬ï¼Œäº¤æ›¿åœ°é€ä¸€å‡çº§çš„è¿‡ç¨‹ï¼Œå°±æ˜¯â€œæ»šåŠ¨æ›´æ–°â€ã€‚\nåœ¨è¿™ä¸ªâ€œæ»šåŠ¨æ›´æ–°â€è¿‡ç¨‹å®Œæˆä¹‹åï¼Œä½ å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹æ–°ã€æ—§ä¸¤ä¸ª ReplicaSet çš„æœ€ç»ˆçŠ¶æ€ï¼š\n$ kubectl get rs NAME DESIRED CURRENT READY AGE nginx-deployment-1764197365 3 3 3 6s nginx-deployment-3167673210 0 0 0 30s  å…¶ä¸­ï¼Œæ—§ ReplicaSetï¼ˆhash=3167673210ï¼‰å·²ç»è¢«â€œæ°´å¹³æ”¶ç¼©â€æˆäº† 0 ä¸ªå‰¯æœ¬ã€‚\nè¿™ç§â€œæ»šåŠ¨æ›´æ–°â€çš„å¥½å¤„æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚æ¯”å¦‚ï¼Œåœ¨å‡çº§åˆšå¼€å§‹çš„æ—¶å€™ï¼Œé›†ç¾¤é‡Œåªæœ‰ 1 ä¸ªæ–°ç‰ˆæœ¬çš„ Podã€‚å¦‚æœè¿™æ—¶ï¼Œæ–°ç‰ˆæœ¬ Pod æœ‰é—®é¢˜å¯åŠ¨ä¸èµ·æ¥ï¼Œé‚£ä¹ˆâ€œæ»šåŠ¨æ›´æ–°â€å°±ä¼šåœæ­¢ï¼Œä»è€Œå…è®¸å¼€å‘å’Œè¿ç»´äººå‘˜ä»‹å…¥ã€‚è€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç”±äºåº”ç”¨æœ¬èº«è¿˜æœ‰ä¸¤ä¸ªæ—§ç‰ˆæœ¬çš„ Pod åœ¨çº¿ï¼Œæ‰€ä»¥æœåŠ¡å¹¶ä¸ä¼šå—åˆ°å¤ªå¤§çš„å½±å“ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿå°±è¦æ±‚ä½ ä¸€å®šè¦ä½¿ç”¨ Pod çš„ Health Check æœºåˆ¶æ£€æŸ¥åº”ç”¨çš„è¿è¡ŒçŠ¶æ€ï¼Œè€Œä¸æ˜¯ç®€å•åœ°ä¾èµ–äºå®¹å™¨çš„ Running çŠ¶æ€ã€‚è¦ä¸ç„¶çš„è¯ï¼Œè™½ç„¶å®¹å™¨å·²ç»å˜æˆ Running äº†ï¼Œä½†æœåŠ¡å¾ˆæœ‰å¯èƒ½å°šæœªå¯åŠ¨ï¼Œâ€œæ»šåŠ¨æ›´æ–°â€çš„æ•ˆæœä¹Ÿå°±è¾¾ä¸åˆ°äº†ã€‚\nè€Œä¸ºäº†è¿›ä¸€æ­¥ä¿è¯æœåŠ¡çš„è¿ç»­æ€§ï¼ŒDeployment Controller è¿˜ä¼šç¡®ä¿ï¼Œåœ¨ä»»ä½•æ—¶é—´çª—å£å†…ï¼Œåªæœ‰æŒ‡å®šæ¯”ä¾‹çš„ Pod å¤„äºç¦»çº¿çŠ¶æ€ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿä¼šç¡®ä¿ï¼Œåœ¨ä»»ä½•æ—¶é—´çª—å£å†…ï¼Œåªæœ‰æŒ‡å®šæ¯”ä¾‹çš„æ–° Pod è¢«åˆ›å»ºå‡ºæ¥ã€‚è¿™ä¸¤ä¸ªæ¯”ä¾‹çš„å€¼éƒ½æ˜¯å¯ä»¥é…ç½®çš„ï¼Œé»˜è®¤éƒ½æ˜¯ DESIRED å€¼çš„ 25%ã€‚\næ‰€ä»¥ï¼Œåœ¨ä¸Šé¢è¿™ä¸ª Deployment çš„ä¾‹å­ä¸­ï¼Œå®ƒæœ‰ 3 ä¸ª Pod å‰¯æœ¬ï¼Œé‚£ä¹ˆæ§åˆ¶å™¨åœ¨â€œæ»šåŠ¨æ›´æ–°â€çš„è¿‡ç¨‹ä¸­æ°¸è¿œéƒ½ä¼šç¡®ä¿è‡³å°‘æœ‰ 2 ä¸ª Pod å¤„äºå¯ç”¨çŠ¶æ€ï¼Œè‡³å¤šåªæœ‰ 4 ä¸ª Pod åŒæ—¶å­˜åœ¨äºé›†ç¾¤ä¸­ã€‚è¿™ä¸ªç­–ç•¥ï¼Œæ˜¯ Deployment å¯¹è±¡çš„ä¸€ä¸ªå­—æ®µï¼Œåå« RollingUpdateStrategyï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: ... strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1  åœ¨ä¸Šé¢è¿™ä¸ª RollingUpdateStrategy çš„é…ç½®ä¸­ï¼ŒmaxSurge æŒ‡å®šçš„æ˜¯é™¤äº† DESIRED æ•°é‡ä¹‹å¤–ï¼Œåœ¨ä¸€æ¬¡â€œæ»šåŠ¨â€ä¸­ï¼ŒDeployment æ§åˆ¶å™¨è¿˜å¯ä»¥åˆ›å»ºå¤šå°‘ä¸ªæ–° Podï¼›è€Œ maxUnavailable æŒ‡çš„æ˜¯ï¼Œåœ¨ä¸€æ¬¡â€œæ»šåŠ¨â€ä¸­ï¼ŒDeployment æ§åˆ¶å™¨å¯ä»¥åˆ é™¤å¤šå°‘ä¸ªæ—§ Podã€‚\nåŒæ—¶ï¼Œè¿™ä¸¤ä¸ªé…ç½®è¿˜å¯ä»¥ç”¨å‰é¢æˆ‘ä»¬ä»‹ç»çš„ç™¾åˆ†æ¯”å½¢å¼æ¥è¡¨ç¤ºï¼Œæ¯”å¦‚ï¼šmaxUnavailable=50%ï¼ŒæŒ‡çš„æ˜¯æˆ‘ä»¬æœ€å¤šå¯ä»¥ä¸€æ¬¡åˆ é™¤â€œ50%*DESIRED æ•°é‡â€ä¸ª Podã€‚\nç»“åˆä»¥ä¸Šè®²è¿°ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æ‰©å±•ä¸€ä¸‹ Deploymentã€ReplicaSet å’Œ Pod çš„å…³ç³»å›¾äº†ã€‚\nå¦‚ä¸Šæ‰€ç¤ºï¼ŒDeployment çš„æ§åˆ¶å™¨ï¼Œå®é™…ä¸Šæ§åˆ¶çš„æ˜¯ ReplicaSet çš„æ•°ç›®ï¼Œä»¥åŠæ¯ä¸ª ReplicaSet çš„å±æ€§ã€‚è€Œä¸€ä¸ªåº”ç”¨çš„ç‰ˆæœ¬ï¼Œå¯¹åº”çš„æ­£æ˜¯ä¸€ä¸ª ReplicaSetï¼›è¿™ä¸ªç‰ˆæœ¬åº”ç”¨çš„ Pod æ•°é‡ï¼Œåˆ™ç”± ReplicaSet é€šè¿‡å®ƒè‡ªå·±çš„æ§åˆ¶å™¨ï¼ˆReplicaSet Controllerï¼‰æ¥ä¿è¯ã€‚é€šè¿‡è¿™æ ·çš„å¤šä¸ª ReplicaSet å¯¹è±¡ï¼ŒKubernetes é¡¹ç›®å°±å®ç°äº†å¯¹å¤šä¸ªâ€œåº”ç”¨ç‰ˆæœ¬â€çš„æè¿°ã€‚\nè€Œæ˜ç™½äº†â€œåº”ç”¨ç‰ˆæœ¬å’Œ ReplicaSet ä¸€ä¸€å¯¹åº”â€çš„è®¾è®¡æ€æƒ³ä¹‹åï¼Œæˆ‘å°±å¯ä»¥ä¸ºä½ è®²è§£ä¸€ä¸‹Deployment å¯¹åº”ç”¨è¿›è¡Œç‰ˆæœ¬æ§åˆ¶çš„å…·ä½“åŸç†äº†ã€‚\nè¿™ä¸€æ¬¡ï¼Œæˆ‘ä¼šä½¿ç”¨ä¸€ä¸ªå« kubectl set image çš„æŒ‡ä»¤ï¼Œç›´æ¥ä¿®æ”¹ nginx-deployment æ‰€ä½¿ç”¨çš„é•œåƒã€‚è¿™ä¸ªå‘½ä»¤çš„å¥½å¤„å°±æ˜¯ï¼Œä½ å¯ä»¥ä¸ç”¨åƒ kubectl edit é‚£æ ·éœ€è¦æ‰“å¼€ç¼–è¾‘å™¨ã€‚ä¸è¿‡è¿™ä¸€æ¬¡ï¼Œæˆ‘æŠŠè¿™ä¸ªé•œåƒåå­—ä¿®æ”¹æˆä¸ºäº†ä¸€ä¸ªé”™è¯¯çš„åå­—ï¼Œæ¯”å¦‚ï¼šnginx:1.91ã€‚è¿™æ ·ï¼Œè¿™ä¸ª Deployment å°±ä¼šå‡ºç°ä¸€ä¸ªå‡çº§å¤±è´¥çš„ç‰ˆæœ¬ã€‚æˆ‘ä»¬ä¸€èµ·æ¥å®è·µä¸€ä¸‹ï¼š\n$ kubectl set image deployment/nginx-deployment nginx=nginx:1.91 deployment.extensions/nginx-deployment image updated  ç”±äºè¿™ä¸ª nginx:1.91 é•œåƒåœ¨ Docker Hub ä¸­å¹¶ä¸å­˜åœ¨ï¼Œæ‰€ä»¥è¿™ä¸ª Deployment çš„â€œæ»šåŠ¨æ›´æ–°â€è¢«è§¦å‘åï¼Œä¼šç«‹åˆ»æŠ¥é”™å¹¶åœæ­¢ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬æ¥æ£€æŸ¥ä¸€ä¸‹ ReplicaSet çš„çŠ¶æ€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl get rs NAME DESIRED CURRENT READY AGE nginx-deployment-1764197365 2 2 2 24s nginx-deployment-3167673210 0 0 0 35s nginx-deployment-2156724341 2 2 0 7s  é€šè¿‡è¿™ä¸ªè¿”å›ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ–°ç‰ˆæœ¬çš„ ReplicaSetï¼ˆhash=2156724341ï¼‰çš„â€œæ°´å¹³æ‰©å±•â€å·²ç»åœæ­¢ã€‚è€Œä¸”æ­¤æ—¶ï¼Œå®ƒå·²ç»åˆ›å»ºäº†ä¸¤ä¸ª Podï¼Œä½†æ˜¯å®ƒä»¬éƒ½æ²¡æœ‰è¿›å…¥ READY çŠ¶æ€ã€‚è¿™å½“ç„¶æ˜¯å› ä¸ºè¿™ä¸¤ä¸ª Pod éƒ½æ‹‰å–ä¸åˆ°æœ‰æ•ˆçš„é•œåƒã€‚ä¸æ­¤åŒæ—¶ï¼Œæ—§ç‰ˆæœ¬çš„ ReplicaSetï¼ˆhash=1764197365ï¼‰çš„â€œæ°´å¹³æ”¶ç¼©â€ï¼Œä¹Ÿè‡ªåŠ¨åœæ­¢äº†ã€‚æ­¤æ—¶ï¼Œå·²ç»æœ‰ä¸€ä¸ªæ—§ Pod è¢«åˆ é™¤ï¼Œè¿˜å‰©ä¸‹ä¸¤ä¸ªæ—§ Podã€‚\né‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ æˆ‘ä»¬å¦‚ä½•è®©è¿™ä¸ª Deployment çš„ 3 ä¸ª Podï¼Œéƒ½å›æ»šåˆ°ä»¥å‰çš„æ—§ç‰ˆæœ¬å‘¢ï¼Ÿ\næˆ‘ä»¬åªéœ€è¦æ‰§è¡Œä¸€æ¡ kubectl rollout undo å‘½ä»¤ï¼Œå°±èƒ½æŠŠæ•´ä¸ª Deployment å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼š\n$ kubectl rollout undo deployment/nginx-deployment deployment.extensions/nginx-deployment  å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œåœ¨å…·ä½“æ“ä½œä¸Šï¼ŒDeployment çš„æ§åˆ¶å™¨ï¼Œå…¶å®å°±æ˜¯è®©è¿™ä¸ªæ—§ ReplicaSetï¼ˆhash=1764197365ï¼‰å†æ¬¡â€œæ‰©å±•â€æˆ 3 ä¸ª Podï¼Œè€Œè®©æ–°çš„ ReplicaSetï¼ˆhash=2156724341ï¼‰é‡æ–°â€œæ”¶ç¼©â€åˆ° 0 ä¸ª Podã€‚æ›´è¿›ä¸€æ­¥åœ°ï¼Œå¦‚æœæˆ‘æƒ³å›æ»šåˆ°æ›´æ—©ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¦æ€ä¹ˆåŠå‘¢ï¼Ÿ\né¦–å…ˆï¼Œæˆ‘éœ€è¦ä½¿ç”¨ kubectl rollout history å‘½ä»¤ï¼ŒæŸ¥çœ‹æ¯æ¬¡ Deployment å˜æ›´å¯¹åº”çš„ç‰ˆæœ¬ã€‚è€Œç”±äºæˆ‘ä»¬åœ¨åˆ›å»ºè¿™ä¸ª Deployment çš„æ—¶å€™ï¼ŒæŒ‡å®šäº†â€“record å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºè¿™äº›ç‰ˆæœ¬æ—¶æ‰§è¡Œçš„ kubectl å‘½ä»¤ï¼Œéƒ½ä¼šè¢«è®°å½•ä¸‹æ¥ã€‚è¿™ä¸ªæ“ä½œçš„è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl rollout history deployment/nginx-deployment deployments \u0026quot;nginx-deployment\u0026quot; REVISION CHANGE-CAUSE 1 kubectl create -f nginx-deployment.yaml --record 2 kubectl edit deployment/nginx-deployment 3 kubectl set image deployment/nginx-deployment nginx=nginx:1.91  å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å‰é¢æ‰§è¡Œçš„åˆ›å»ºå’Œæ›´æ–°æ“ä½œï¼Œåˆ†åˆ«å¯¹åº”äº†ç‰ˆæœ¬ 1 å’Œç‰ˆæœ¬ 2ï¼Œè€Œé‚£æ¬¡å¤±è´¥çš„æ›´æ–°æ“ä½œï¼Œåˆ™å¯¹åº”çš„æ˜¯ç‰ˆæœ¬ 3ã€‚\nå½“ç„¶ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡è¿™ä¸ª kubectl rollout history æŒ‡ä»¤ï¼Œçœ‹åˆ°æ¯ä¸ªç‰ˆæœ¬å¯¹åº”çš„ Deployment çš„ API å¯¹è±¡çš„ç»†èŠ‚ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl rollout history deployment/nginx-deployment --revision=2  ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ kubectl rollout undo å‘½ä»¤è¡Œæœ€åï¼ŒåŠ ä¸Šè¦å›æ»šåˆ°çš„æŒ‡å®šç‰ˆæœ¬çš„ç‰ˆæœ¬å·ï¼Œå°±å¯ä»¥å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬äº†ã€‚è¿™ä¸ªæŒ‡ä»¤çš„ç”¨æ³•å¦‚ä¸‹ï¼š\n$ kubectl rollout undo deployment/nginx-deployment --to-revision=2 deployment.extensions/nginx-deployment  è¿™æ ·ï¼ŒDeployment Controller è¿˜ä¼šæŒ‰ç…§â€œæ»šåŠ¨æ›´æ–°â€çš„æ–¹å¼ï¼Œå®Œæˆå¯¹ Deployment çš„é™çº§æ“ä½œã€‚ä¸è¿‡ï¼Œä½ å¯èƒ½å·²ç»æƒ³åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬å¯¹ Deployment è¿›è¡Œçš„æ¯ä¸€æ¬¡æ›´æ–°æ“ä½œï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ ReplicaSet å¯¹è±¡ï¼Œæ˜¯ä¸æ˜¯æœ‰äº›å¤šä½™ï¼Œç”šè‡³æµªè´¹èµ„æºå‘¢ï¼Ÿæ²¡é”™ã€‚æ‰€ä»¥ï¼ŒKubernetes é¡¹ç›®è¿˜æä¾›äº†ä¸€ä¸ªæŒ‡ä»¤ï¼Œä½¿å¾—æˆ‘ä»¬å¯¹ Deployment çš„å¤šæ¬¡æ›´æ–°æ“ä½œï¼Œæœ€å åªç”Ÿæˆä¸€ä¸ª ReplicaSetã€‚å…·ä½“çš„åšæ³•æ˜¯ï¼Œåœ¨æ›´æ–° Deployment å‰ï¼Œä½ è¦å…ˆæ‰§è¡Œä¸€æ¡ kubectl rollout pause æŒ‡ä»¤ã€‚å®ƒçš„ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl rollout pause deployment/nginx-deployment deployment.extensions/nginx-deployment paused  è¿™ä¸ª kubectl rollout pause çš„ä½œç”¨ï¼Œæ˜¯è®©è¿™ä¸ª Deployment è¿›å…¥äº†ä¸€ä¸ªâ€œæš‚åœâ€çŠ¶æ€ã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œä½ å°±å¯ä»¥éšæ„ä½¿ç”¨ kubectl edit æˆ–è€… kubectl set image æŒ‡ä»¤ï¼Œä¿®æ”¹è¿™ä¸ª Deployment çš„å†…å®¹äº†ã€‚ç”±äºæ­¤æ—¶ Deployment æ­£å¤„äºâ€œæš‚åœâ€çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹ Deployment çš„æ‰€æœ‰ä¿®æ”¹ï¼Œéƒ½ä¸ä¼šè§¦å‘æ–°çš„â€œæ»šåŠ¨æ›´æ–°â€ï¼Œä¹Ÿä¸ä¼šåˆ›å»ºæ–°çš„ ReplicaSetã€‚è€Œç­‰åˆ°æˆ‘ä»¬å¯¹ Deployment ä¿®æ”¹æ“ä½œéƒ½å®Œæˆä¹‹åï¼Œåªéœ€è¦å†æ‰§è¡Œä¸€æ¡ kubectl rollout resume æŒ‡ä»¤ï¼Œå°±å¯ä»¥æŠŠè¿™ä¸ª Deploymentâ€œæ¢å¤â€å›æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl rollout resume deployment/nginx-deployment deployment.extensions/nginx-deployment resumed  è€Œåœ¨è¿™ä¸ª kubectl rollout resume æŒ‡ä»¤æ‰§è¡Œä¹‹å‰ï¼Œåœ¨ kubectl rollout pause æŒ‡ä»¤ä¹‹åçš„è¿™æ®µæ—¶é—´é‡Œï¼Œæˆ‘ä»¬å¯¹ Deployment è¿›è¡Œçš„æ‰€æœ‰ä¿®æ”¹ï¼Œæœ€ååªä¼šè§¦å‘ä¸€æ¬¡â€œæ»šåŠ¨æ›´æ–°â€ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥ ReplicaSet çŠ¶æ€çš„å˜åŒ–ï¼Œæ¥éªŒè¯ä¸€ä¸‹ kubectl rollout pause å’Œ kubectl rollout resume æŒ‡ä»¤çš„æ‰§è¡Œæ•ˆæœï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl get rs NAME DESIRED CURRENT READY AGE nginx-1764197365 0 0 0 2m nginx-3196763511 3 3 3 28s  é€šè¿‡è¿”å›ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰ä¸€ä¸ª hash=3196763511 çš„ ReplicaSet è¢«åˆ›å»ºäº†å‡ºæ¥ã€‚ä¸è¿‡ï¼Œå³ä½¿ä½ åƒä¸Šé¢è¿™æ ·å°å¿ƒç¿¼ç¿¼åœ°æ§åˆ¶äº† ReplicaSet çš„ç”Ÿæˆæ•°é‡ï¼Œéšç€åº”ç”¨ç‰ˆæœ¬çš„ä¸æ–­å¢åŠ ï¼ŒKubernetes ä¸­è¿˜æ˜¯ä¼šä¸ºåŒä¸€ä¸ª Deployment ä¿å­˜å¾ˆå¤šå¾ˆå¤šä¸åŒçš„ ReplicaSetã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬åˆè¯¥å¦‚ä½•æ§åˆ¶è¿™äº›â€œå†å²â€ReplicaSet çš„æ•°é‡å‘¢ï¼Ÿå¾ˆç®€å•ï¼ŒDeployment å¯¹è±¡æœ‰ä¸€ä¸ªå­—æ®µï¼Œå«ä½œ spec.revisionHistoryLimitï¼Œå°±æ˜¯ Kubernetes ä¸º Deployment ä¿ç•™çš„â€œå†å²ç‰ˆæœ¬â€ä¸ªæ•°ã€‚æ‰€ä»¥ï¼Œå¦‚æœæŠŠå®ƒè®¾ç½®ä¸º 0ï¼Œä½ å°±å†ä¹Ÿä¸èƒ½åšå›æ»šæ“ä½œäº†ã€‚\næ€»ç»“\nåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ºä½ è¯¦ç»†è®²è§£äº† Deployment è¿™ä¸ª Kubernetes é¡¹ç›®ä¸­æœ€åŸºæœ¬çš„ç¼–æ’æ§åˆ¶å™¨çš„å®ç°åŸç†å’Œä½¿ç”¨æ–¹æ³•ã€‚\né€šè¿‡è¿™äº›è®²è§£ï¼Œä½ åº”è¯¥äº†è§£åˆ°ï¼šDeployment å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¸¤å±‚æ§åˆ¶å™¨ã€‚é¦–å…ˆï¼Œå®ƒé€šè¿‡ ReplicaSet çš„ä¸ªæ•°æ¥æè¿°åº”ç”¨çš„ç‰ˆæœ¬ï¼›ç„¶åï¼Œå®ƒå†é€šè¿‡ ReplicaSet çš„å±æ€§ï¼ˆæ¯”å¦‚ replicas çš„å€¼ï¼‰ï¼Œæ¥ä¿è¯ Pod çš„å‰¯æœ¬æ•°é‡ã€‚\n å¤‡æ³¨ï¼šDeployment æ§åˆ¶ ReplicaSetï¼ˆç‰ˆæœ¬ï¼‰ï¼ŒReplicaSet æ§åˆ¶ Podï¼ˆå‰¯æœ¬æ•°ï¼‰ã€‚è¿™ä¸ªä¸¤å±‚æ§åˆ¶å…³ç³»ä¸€å®šè¦ç‰¢è®°ã€‚\n ä¸è¿‡ï¼Œç›¸ä¿¡ä½ ä¹Ÿèƒ½å¤Ÿæ„Ÿå—åˆ°ï¼ŒKubernetes é¡¹ç›®å¯¹ Deployment çš„è®¾è®¡ï¼Œå®é™…ä¸Šæ˜¯ä»£æ›¿æˆ‘ä»¬å®Œæˆäº†å¯¹â€œåº”ç”¨â€çš„æŠ½è±¡ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ª Deployment å¯¹è±¡æ¥æè¿°åº”ç”¨ï¼Œä½¿ç”¨ kubectl rollout å‘½ä»¤æ§åˆ¶åº”ç”¨çš„ç‰ˆæœ¬ã€‚\nå¯æ˜¯ï¼Œåœ¨å®é™…ä½¿ç”¨åœºæ™¯ä¸­ï¼Œåº”ç”¨å‘å¸ƒçš„æµç¨‹å¾€å¾€åƒå·®ä¸‡åˆ«ï¼Œä¹Ÿå¯èƒ½æœ‰å¾ˆå¤šçš„å®šåˆ¶åŒ–éœ€æ±‚ã€‚æ¯”å¦‚ï¼Œæˆ‘çš„åº”ç”¨å¯èƒ½æœ‰ä¼šè¯é»è¿ï¼ˆsession stickyï¼‰ï¼Œè¿™å°±æ„å‘³ç€â€œæ»šåŠ¨æ›´æ–°â€çš„æ—¶å€™ï¼Œå“ªä¸ª Pod èƒ½ä¸‹çº¿ï¼Œæ˜¯ä¸èƒ½éšä¾¿é€‰æ‹©çš„ã€‚\nè¿™ç§åœºæ™¯ï¼Œå…‰é  Deployment è‡ªå·±å°±å¾ˆéš¾åº”å¯¹äº†ã€‚å¯¹äºè¿™ç§éœ€æ±‚ï¼Œæˆ‘åœ¨ä¸“æ åç»­æ–‡ç« ä¸­é‡ç‚¹ä»‹ç»çš„â€œè‡ªå®šä¹‰æ§åˆ¶å™¨â€ï¼Œå°±å¯ä»¥å¸®æˆ‘ä»¬å®ç°ä¸€ä¸ªåŠŸèƒ½æ›´åŠ å¼ºå¤§çš„ Deployment Controllerã€‚\nå½“ç„¶ï¼ŒKubernetes é¡¹ç›®æœ¬èº«ï¼Œä¹Ÿæä¾›äº†å¦å¤–ä¸€ç§æŠ½è±¡æ–¹å¼ï¼Œå¸®æˆ‘ä»¬åº”å¯¹å…¶ä»–ä¸€äº›ç”¨ Deployment æ— æ³•å¤„ç†çš„åº”ç”¨ç¼–æ’åœºæ™¯ã€‚è¿™ä¸ªè®¾è®¡ï¼Œå°±æ˜¯å¯¹æœ‰çŠ¶æ€åº”ç”¨çš„ç®¡ç†ï¼Œä¹Ÿæ˜¯æˆ‘åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è¦é‡ç‚¹è®²è§£çš„å†…å®¹ã€‚\n","date":"2021å¹´03æœˆ01æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/deployment/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eä½œä¸šå‰¯æœ¬\u003c/li\u003e\n\u003cli\u003eæ°´å¹³æ‰©å®¹\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/blockquote\u003e","title":"Deploymentï¼šä½œä¸šå‰¯æœ¬ä¸æ°´å¹³æ‰©å®¹"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹\n å®é™…ä¸Šï¼Œä½ å¯èƒ½å·²ç»æœ‰æ‰€æ„Ÿæ‚Ÿï¼šPod è¿™ä¸ªçœ‹ä¼¼å¤æ‚çš„ API å¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹å®¹å™¨çš„è¿›ä¸€æ­¥æŠ½è±¡å’Œå°è£…è€Œå·²ã€‚\nè¯´å¾—æ›´å½¢è±¡äº›ï¼Œâ€œå®¹å™¨â€é•œåƒè™½ç„¶å¥½ç”¨ï¼Œä½†æ˜¯å®¹å™¨è¿™æ ·ä¸€ä¸ªâ€œæ²™ç›’â€çš„æ¦‚å¿µï¼Œå¯¹äºæè¿°åº”ç”¨æ¥è¯´ï¼Œè¿˜æ˜¯å¤ªè¿‡ç®€å•äº†ã€‚è¿™å°±å¥½æ¯”ï¼Œé›†è£…ç®±å›ºç„¶å¥½ç”¨ï¼Œä½†æ˜¯å¦‚æœå®ƒå››é¢éƒ½å…‰ç§ƒç§ƒçš„ï¼ŒåŠè½¦è¿˜æ€ä¹ˆæŠŠè¿™ä¸ªé›†è£…ç®±åŠèµ·æ¥å¹¶æ‘†æ”¾å¥½å‘¢ï¼Ÿæ‰€ä»¥ï¼ŒPod å¯¹è±¡ï¼Œå…¶å®å°±æ˜¯å®¹å™¨çš„å‡çº§ç‰ˆã€‚å®ƒå¯¹å®¹å™¨è¿›è¡Œäº†ç»„åˆï¼Œæ·»åŠ äº†æ›´å¤šçš„å±æ€§å’Œå­—æ®µã€‚è¿™å°±å¥½æ¯”ç»™é›†è£…ç®±å››é¢å®‰è£…äº†åŠç¯ï¼Œä½¿å¾— Kubernetes è¿™æ¶â€œåŠè½¦â€ï¼Œå¯ä»¥æ›´è½»æ¾åœ°æ“ä½œå®ƒã€‚\nè€Œ Kubernetes æ“ä½œè¿™äº›â€œé›†è£…ç®±â€çš„é€»è¾‘ï¼Œéƒ½ç”±æ§åˆ¶å™¨ï¼ˆControllerï¼‰å®Œæˆã€‚åœ¨å‰é¢çš„ç¬¬ 12 ç¯‡æ–‡ç« ã€Šç‰›åˆ€å°è¯•ï¼šæˆ‘çš„ç¬¬ä¸€ä¸ªå®¹å™¨åŒ–åº”ç”¨ã€‹ä¸­ï¼Œæˆ‘ä»¬æ›¾ç»ä½¿ç”¨è¿‡ Deployment è¿™ä¸ªæœ€åŸºæœ¬çš„æ§åˆ¶å™¨å¯¹è±¡ã€‚\nç°åœ¨ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥å›é¡¾ä¸€ä¸‹è¿™ä¸ªåå« nginx-deployment çš„ä¾‹å­ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment spec: selector: matchLabels: app: nginx replicas: 2 template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.7.9 ports: - containerPort: 80  è¿™ä¸ª Deployment å®šä¹‰çš„ç¼–æ’åŠ¨ä½œéå¸¸ç®€å•ï¼Œå³ï¼šç¡®ä¿æºå¸¦äº† app=nginx æ ‡ç­¾çš„ Pod çš„ä¸ªæ•°ï¼Œæ°¸è¿œç­‰äº spec.replicas æŒ‡å®šçš„ä¸ªæ•°ï¼Œå³ 2 ä¸ªã€‚\nè¿™å°±æ„å‘³ç€ï¼Œå¦‚æœåœ¨è¿™ä¸ªé›†ç¾¤ä¸­ï¼Œæºå¸¦ app=nginx æ ‡ç­¾çš„ Pod çš„ä¸ªæ•°å¤§äº 2 çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰æ—§çš„ Pod è¢«åˆ é™¤ï¼›åä¹‹ï¼Œå°±ä¼šæœ‰æ–°çš„ Pod è¢«åˆ›å»ºã€‚\nè¿™æ—¶ï¼Œä½ ä¹Ÿè®¸å°±ä¼šå¥½å¥‡ï¼šç©¶ç«Ÿæ˜¯ Kubernetes é¡¹ç›®ä¸­çš„å“ªä¸ªç»„ä»¶ï¼Œåœ¨æ‰§è¡Œè¿™äº›æ“ä½œå‘¢ï¼Ÿ\næˆ‘åœ¨å‰é¢ä»‹ç» Kubernetes æ¶æ„çš„æ—¶å€™ï¼Œæ›¾ç»æåˆ°è¿‡ä¸€ä¸ªå«ä½œ kube-controller-manager çš„ç»„ä»¶ã€‚\nå®é™…ä¸Šï¼Œè¿™ä¸ªç»„ä»¶ï¼Œå°±æ˜¯ä¸€ç³»åˆ—æ§åˆ¶å™¨çš„é›†åˆã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ Kubernetes é¡¹ç›®çš„ pkg/controller ç›®å½•ï¼š\n$ cd kubernetes/pkg/controller/ $ ls -d */ deployment/ job/ podautoscaler/ cloud/ disruption/ namespace/ replicaset/ serviceaccount/ volume/ cronjob/ garbagecollector/ nodelifecycle/ replication/ statefulset/ daemon/ ...  è¿™ä¸ªç›®å½•ä¸‹é¢çš„æ¯ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œéƒ½ä»¥ç‹¬æœ‰çš„æ–¹å¼è´Ÿè´£æŸç§ç¼–æ’åŠŸèƒ½ã€‚è€Œæˆ‘ä»¬çš„ Deploymentï¼Œæ­£æ˜¯è¿™äº›æ§åˆ¶å™¨ä¸­çš„ä¸€ç§ã€‚\nå®é™…ä¸Šï¼Œè¿™äº›æ§åˆ¶å™¨ä¹‹æ‰€ä»¥è¢«ç»Ÿä¸€æ”¾åœ¨ pkg/controller ç›®å½•ä¸‹ï¼Œå°±æ˜¯å› ä¸ºå®ƒä»¬éƒ½éµå¾ª Kubernetes é¡¹ç›®ä¸­çš„ä¸€ä¸ªé€šç”¨ç¼–æ’æ¨¡å¼ï¼Œå³ï¼šæ§åˆ¶å¾ªç¯ï¼ˆcontrol loopï¼‰ã€‚\næ¯”å¦‚ï¼Œç°åœ¨æœ‰ä¸€ç§å¾…ç¼–æ’çš„å¯¹è±¡ Xï¼Œå®ƒæœ‰ä¸€ä¸ªå¯¹åº”çš„æ§åˆ¶å™¨ã€‚é‚£ä¹ˆï¼Œæˆ‘å°±å¯ä»¥ç”¨ä¸€æ®µ Go è¯­è¨€é£æ ¼çš„ä¼ªä»£ç ï¼Œä¸ºä½ æè¿°è¿™ä¸ªæ§åˆ¶å¾ªç¯ï¼š\nfor { å®é™…çŠ¶æ€ := è·å–é›†ç¾¤ä¸­å¯¹è±¡Xçš„å®é™…çŠ¶æ€ï¼ˆActual Stateï¼‰ æœŸæœ›çŠ¶æ€ := è·å–é›†ç¾¤ä¸­å¯¹è±¡Xçš„æœŸæœ›çŠ¶æ€ï¼ˆDesired Stateï¼‰ if å®é™…çŠ¶æ€ == æœŸæœ›çŠ¶æ€{ ä»€ä¹ˆéƒ½ä¸åš } else { æ‰§è¡Œç¼–æ’åŠ¨ä½œï¼Œå°†å®é™…çŠ¶æ€è°ƒæ•´ä¸ºæœŸæœ›çŠ¶æ€ } }  åœ¨å…·ä½“å®ç°ä¸­ï¼Œå®é™…çŠ¶æ€å¾€å¾€æ¥è‡ªäº Kubernetes é›†ç¾¤æœ¬èº«ã€‚\næ¯”å¦‚ï¼Œkubelet é€šè¿‡å¿ƒè·³æ±‡æŠ¥çš„å®¹å™¨çŠ¶æ€å’ŒèŠ‚ç‚¹çŠ¶æ€ï¼Œæˆ–è€…ç›‘æ§ç³»ç»Ÿä¸­ä¿å­˜çš„åº”ç”¨ç›‘æ§æ•°æ®ï¼Œæˆ–è€…æ§åˆ¶å™¨ä¸»åŠ¨æ”¶é›†çš„å®ƒè‡ªå·±æ„Ÿå…´è¶£çš„ä¿¡æ¯ï¼Œè¿™äº›éƒ½æ˜¯å¸¸è§çš„å®é™…çŠ¶æ€çš„æ¥æºã€‚\nè€ŒæœŸæœ›çŠ¶æ€ï¼Œä¸€èˆ¬æ¥è‡ªäºç”¨æˆ·æäº¤çš„ YAML æ–‡ä»¶ã€‚\næ¯”å¦‚ï¼ŒDeployment å¯¹è±¡ä¸­ Replicas å­—æ®µçš„å€¼ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™äº›ä¿¡æ¯å¾€å¾€éƒ½ä¿å­˜åœ¨ Etcd ä¸­ã€‚\næ¥ä¸‹æ¥ï¼Œä»¥ Deployment ä¸ºä¾‹ï¼Œæˆ‘å’Œä½ ç®€å•æè¿°ä¸€ä¸‹å®ƒå¯¹æ§åˆ¶å™¨æ¨¡å‹çš„å®ç°ï¼š\n Deployment æ§åˆ¶å™¨ä» Etcd ä¸­è·å–åˆ°æ‰€æœ‰æºå¸¦äº†â€œapp: nginxâ€æ ‡ç­¾çš„ Podï¼Œç„¶åç»Ÿè®¡å®ƒä»¬çš„æ•°é‡ï¼Œè¿™å°±æ˜¯å®é™…çŠ¶æ€ï¼› Deployment å¯¹è±¡çš„ Replicas å­—æ®µçš„å€¼å°±æ˜¯æœŸæœ›çŠ¶æ€ï¼› Deployment æ§åˆ¶å™¨å°†ä¸¤ä¸ªçŠ¶æ€åšæ¯”è¾ƒï¼Œç„¶åæ ¹æ®æ¯”è¾ƒç»“æœï¼Œç¡®å®šæ˜¯åˆ›å»º Podï¼Œè¿˜æ˜¯åˆ é™¤å·²æœ‰çš„ Podï¼ˆå…·ä½“å¦‚ä½•æ“ä½œ Pod å¯¹è±¡ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»ï¼‰ã€‚  å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ª Kubernetes å¯¹è±¡çš„ä¸»è¦ç¼–æ’é€»è¾‘ï¼Œå®é™…ä¸Šæ˜¯åœ¨ç¬¬ä¸‰æ­¥çš„â€œå¯¹æ¯”â€é˜¶æ®µå®Œæˆçš„ã€‚\nè¿™ä¸ªæ“ä½œï¼Œé€šå¸¸è¢«å«ä½œè°ƒè°ï¼ˆReconcileï¼‰ã€‚è¿™ä¸ªè°ƒè°çš„è¿‡ç¨‹ï¼Œåˆ™è¢«ç§°ä½œâ€œReconcile Loopâ€ï¼ˆè°ƒè°å¾ªç¯ï¼‰æˆ–è€…â€œSync Loopâ€ï¼ˆåŒæ­¥å¾ªç¯ï¼‰ã€‚\næ‰€ä»¥ï¼Œå¦‚æœä½ ä»¥ååœ¨æ–‡æ¡£æˆ–è€…ç¤¾åŒºä¸­ç¢°åˆ°è¿™äº›è¯ï¼Œéƒ½ä¸è¦æ‹…å¿ƒï¼Œå®ƒä»¬å…¶å®æŒ‡çš„éƒ½æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼šæ§åˆ¶å¾ªç¯ã€‚\nè€Œè°ƒè°çš„æœ€ç»ˆç»“æœï¼Œå¾€å¾€éƒ½æ˜¯å¯¹è¢«æ§åˆ¶å¯¹è±¡çš„æŸç§å†™æ“ä½œã€‚\næ¯”å¦‚ï¼Œå¢åŠ  Podï¼Œåˆ é™¤å·²æœ‰çš„ Podï¼Œæˆ–è€…æ›´æ–° Pod çš„æŸä¸ªå­—æ®µã€‚è¿™ä¹Ÿæ˜¯ Kubernetes é¡¹ç›®â€œé¢å‘ API å¯¹è±¡ç¼–ç¨‹â€çš„ä¸€ä¸ªç›´è§‚ä½“ç°ã€‚\nå…¶å®ï¼Œåƒ Deployment è¿™ç§æ§åˆ¶å™¨çš„è®¾è®¡åŸç†ï¼Œå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°è¿‡çš„ï¼Œâ€œç”¨ä¸€ç§å¯¹è±¡ç®¡ç†å¦ä¸€ç§å¯¹è±¡â€çš„â€œè‰ºæœ¯â€ã€‚\nå…¶ä¸­ï¼Œè¿™ä¸ªæ§åˆ¶å™¨å¯¹è±¡æœ¬èº«ï¼Œè´Ÿè´£å®šä¹‰è¢«ç®¡ç†å¯¹è±¡çš„æœŸæœ›çŠ¶æ€ã€‚æ¯”å¦‚ï¼ŒDeployment é‡Œçš„ replicas=2 è¿™ä¸ªå­—æ®µã€‚è€Œè¢«æ§åˆ¶å¯¹è±¡çš„å®šä¹‰ï¼Œåˆ™æ¥è‡ªäºä¸€ä¸ªâ€œæ¨¡æ¿â€ã€‚æ¯”å¦‚ï¼ŒDeployment é‡Œçš„ template å­—æ®µã€‚å¯ä»¥çœ‹åˆ°ï¼ŒDeployment è¿™ä¸ª template å­—æ®µé‡Œçš„å†…å®¹ï¼Œè·Ÿä¸€ä¸ªæ ‡å‡†çš„ Pod å¯¹è±¡çš„ API å®šä¹‰ï¼Œä¸æ¯«ä¸å·®ã€‚è€Œæ‰€æœ‰è¢«è¿™ä¸ª Deployment ç®¡ç†çš„ Pod å®ä¾‹ï¼Œå…¶å®éƒ½æ˜¯æ ¹æ®è¿™ä¸ª template å­—æ®µçš„å†…å®¹åˆ›å»ºå‡ºæ¥çš„ã€‚åƒ Deployment å®šä¹‰çš„ template å­—æ®µï¼Œåœ¨ Kubernetes é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªä¸“æœ‰çš„åå­—ï¼Œå«ä½œ PodTemplateï¼ˆPod æ¨¡æ¿ï¼‰ã€‚\nè¿™ä¸ªæ¦‚å¿µéå¸¸é‡è¦ï¼Œå› ä¸ºåé¢æˆ‘è¦è®²è§£åˆ°çš„å¤§å¤šæ•°æ§åˆ¶å™¨ï¼Œéƒ½ä¼šä½¿ç”¨ PodTemplate æ¥ç»Ÿä¸€å®šä¹‰å®ƒæ‰€è¦ç®¡ç†çš„ Podã€‚æ›´æœ‰æ„æ€çš„æ˜¯ï¼Œæˆ‘ä»¬è¿˜ä¼šçœ‹åˆ°å…¶ä»–ç±»å‹çš„å¯¹è±¡æ¨¡æ¿ï¼Œæ¯”å¦‚ Volume çš„æ¨¡æ¿ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ Deployment ä»¥åŠå…¶ä»–ç±»ä¼¼çš„æ§åˆ¶å™¨ï¼Œåšä¸€ä¸ªç®€å•æ€»ç»“äº†ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç±»ä¼¼ Deployment è¿™æ ·çš„ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œå®é™…ä¸Šéƒ½æ˜¯ç”±ä¸ŠåŠéƒ¨åˆ†çš„æ§åˆ¶å™¨å®šä¹‰ï¼ˆåŒ…æ‹¬æœŸæœ›çŠ¶æ€ï¼‰ï¼ŒåŠ ä¸Šä¸‹åŠéƒ¨åˆ†çš„è¢«æ§åˆ¶å¯¹è±¡çš„æ¨¡æ¿ç»„æˆçš„ã€‚\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼Œåœ¨æ‰€æœ‰ API å¯¹è±¡çš„ Metadata é‡Œï¼Œéƒ½æœ‰ä¸€ä¸ªå­—æ®µå«ä½œ ownerReferenceï¼Œç”¨äºä¿å­˜å½“å‰è¿™ä¸ª API å¯¹è±¡çš„æ‹¥æœ‰è€…ï¼ˆOwnerï¼‰çš„ä¿¡æ¯ã€‚\né‚£ä¹ˆï¼Œå¯¹äºæˆ‘ä»¬è¿™ä¸ª nginx-deployment æ¥è¯´ï¼Œå®ƒåˆ›å»ºå‡ºæ¥çš„ Pod çš„ ownerReference å°±æ˜¯ nginx-deployment å—ï¼Ÿæˆ–è€…è¯´ï¼Œnginx-deployment æ‰€ç›´æ¥æ§åˆ¶çš„ï¼Œå°±æ˜¯ Pod å¯¹è±¡ä¹ˆï¼Ÿè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ‘å°±ç•™åˆ°ä¸‹ä¸€ç¯‡æ–‡ç« æ—¶å†åšè¯¦ç»†è§£é‡Šå§ã€‚\næ€»ç»“\nåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¥ Deployment ä¸ºä¾‹ï¼Œå’Œä½ è¯¦ç»†åˆ†äº«äº† Kubernetes é¡¹ç›®å¦‚ä½•é€šè¿‡ä¸€ä¸ªç§°ä½œâ€œæ§åˆ¶å™¨æ¨¡å¼â€ï¼ˆcontroller patternï¼‰çš„è®¾è®¡æ–¹æ³•ï¼Œæ¥ç»Ÿä¸€åœ°å®ç°å¯¹å„ç§ä¸åŒçš„å¯¹è±¡æˆ–è€…èµ„æºè¿›è¡Œçš„ç¼–æ’æ“ä½œã€‚\nåœ¨åé¢çš„è®²è§£ä¸­ï¼Œæˆ‘è¿˜ä¼šè®²åˆ°å¾ˆå¤šä¸åŒç±»å‹çš„å®¹å™¨ç¼–æ’åŠŸèƒ½ï¼Œæ¯”å¦‚ StatefulSetã€DaemonSet ç­‰ç­‰ï¼Œå®ƒä»¬æ— ä¸€ä¾‹å¤–åœ°éƒ½æœ‰è¿™æ ·ä¸€ä¸ªç”šè‡³å¤šä¸ªæ§åˆ¶å™¨çš„å­˜åœ¨ï¼Œå¹¶éµå¾ªæ§åˆ¶å¾ªç¯ï¼ˆcontrol loopï¼‰çš„æµç¨‹ï¼Œå®Œæˆå„è‡ªçš„ç¼–æ’é€»è¾‘ã€‚\nå®é™…ä¸Šï¼Œè·Ÿ Deployment ç›¸ä¼¼ï¼Œè¿™äº›æ§åˆ¶å¾ªç¯æœ€åçš„æ‰§è¡Œç»“æœï¼Œè¦ä¹ˆå°±æ˜¯åˆ›å»ºã€æ›´æ–°ä¸€äº› Podï¼ˆæˆ–è€…å…¶ä»–çš„ API å¯¹è±¡ã€èµ„æºï¼‰ï¼Œè¦ä¹ˆå°±æ˜¯åˆ é™¤ä¸€äº›å·²ç»å­˜åœ¨çš„ Podï¼ˆæˆ–è€…å…¶ä»–çš„ API å¯¹è±¡ã€èµ„æºï¼‰ã€‚ä½†ä¹Ÿæ­£æ˜¯åœ¨è¿™ä¸ªç»Ÿä¸€çš„ç¼–æ’æ¡†æ¶ä¸‹ï¼Œä¸åŒçš„æ§åˆ¶å™¨å¯ä»¥åœ¨å…·ä½“æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè®¾è®¡ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œä»è€Œè¾¾åˆ°ä¸åŒçš„ç¼–æ’æ•ˆæœã€‚\nè¿™ä¸ªå®ç°æ€è·¯ï¼Œæ­£æ˜¯ Kubernetes é¡¹ç›®è¿›è¡Œå®¹å™¨ç¼–æ’çš„æ ¸å¿ƒåŸç†ã€‚åœ¨æ­¤åè®²è§£ Kubernetes ç¼–æ’åŠŸèƒ½çš„æ–‡ç« ä¸­ï¼Œæˆ‘éƒ½ä¼šéµå¾ªè¿™ä¸ªé€»è¾‘å±•å¼€ï¼Œå¹¶ä¸”å¸¦ä½ é€æ­¥é¢†æ‚Ÿæ§åˆ¶å™¨æ¨¡å¼åœ¨ä¸åŒçš„å®¹å™¨åŒ–ä½œä¸šä¸­çš„å®ç°æ–¹å¼ã€‚\næ€è€ƒé¢˜\nä½ èƒ½å¦è¯´å‡ºï¼ŒKubernetes ä½¿ç”¨çš„è¿™ä¸ªâ€œæ§åˆ¶å™¨æ¨¡å¼â€ï¼Œè·Ÿæˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„â€œäº‹ä»¶é©±åŠ¨â€ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»å—ï¼Ÿ\n A:\n  â€œäº‹ä»¶é©±åŠ¨â€ï¼Œå¯¹äºæ§åˆ¶å™¨æ¥è¯´æ˜¯è¢«åŠ¨ï¼Œåªè¦è§¦å‘äº‹ä»¶åˆ™æ‰§è¡Œï¼Œå¯¹æ‰§è¡Œåä¸è´Ÿè´£ï¼Œæ— è®ºæˆåŠŸä¸å¦ï¼Œæ²¡æœ‰å¯¹ä¸€æ¬¡æ“ä½œçš„åç»­è¿›è¡Œâ€œç›‘æ§â€ â€œæ§åˆ¶å™¨æ¨¡å¼â€ï¼Œå¯¹äºæ§åˆ¶å™¨æ¥è¯´æ˜¯ä¸»åŠ¨çš„ï¼Œè‡ªèº«åœ¨ä¸æ–­åœ°è·å–ä¿¡æ¯ï¼Œèµ·åˆ°äº‹åâ€œç›‘æ§â€ä½œç”¨ï¼ŒçŸ¥é“åŒæ­¥å®Œæˆï¼Œå®é™…çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€ä¸€è‡´\n  äº‹ä»¶å¾€å¾€æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œå¦‚æœæ“ä½œå¤±è´¥æ¯”è¾ƒéš¾å¤„ç†ï¼Œä½†æ˜¯æ§åˆ¶å™¨æ˜¯å¾ªç¯ä¸€ç›´åœ¨å°è¯•çš„ï¼Œæ›´ç¬¦åˆkuberneteså£°æ˜å¼APIï¼Œæœ€ç»ˆè¾¾åˆ°ä¸å£°æ˜ä¸€è‡´ã€‚\n  ","date":"2021å¹´02æœˆ28æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/controller-mode/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹\u003c/p\u003e\n\u003c/blockquote\u003e","title":"è°ˆè°ˆâ€œæ§åˆ¶å™¨â€æ¨¡å¼"},{"contents":"ä¸€. èƒŒæ™¯ å‘å¸ƒå®¹å™¨çš„æ—¶å€™ï¼Œéœ€è¦è¾“å…¥Health Checkçš„æ£€æŸ¥æ–¹å¼ï¼Œä»¥ä¾¿K8Sé›†ç¾¤èƒ½å¤Ÿç®¡ç†å®¹å™¨çš„å¥åº·çŠ¶æ€ï¼Œåšå®¹å™¨çš„åœæ­¢å’Œé‡å»ºçš„æ“ä½œã€‚å…¬å¸å‘å¸ƒçš„å®¹å™¨åº”ç”¨ç±»å‹åŒ…æ‹¬å¤šç§ï¼Œæœ‰Nginx+PHPï¼ŒOSPï¼ŒNginx+Tomcatç­‰ï¼Œè€Œæ¯ä¸ªåº”ç”¨çš„Health Checkçš„æ–¹å¼éƒ½å„å¼‚ï¼Œå› æ­¤éœ€è¦ç»Ÿä¸€å„åº”ç”¨çš„Health Checkæ£€æŸ¥æ–¹å¼ã€‚\näºŒ. Health Checkæ–¹å¼ å…ˆå½’çº³ä¸‹å„ç§åº”ç”¨Health Checkçš„ä½¿ç”¨æ–¹å¼\n Nginx+PHP å’Œ Nginx+Tomcatï¼Œä»¥åŠ ai-agent ç±»å‹åº”ç”¨å®¹å™¨ï¼Œæ˜¯é€šè¿‡è°ƒç”¨{domain-name}:port/_health_checkçš„httpæ¥å£åšHealth Checkï¼Œå„åº”ç”¨å¿…é¡»æä¾›è¿™ä¸ªurl OSPæœåŠ¡ï¼ŒSaturnæœåŠ¡ä»¥åŠai-modelç±»å‹åº”ç”¨å®¹å™¨ï¼Œæ˜¯é€šè¿‡telnetè¿æ¥æŒ‡å®šçš„ç«¯å£åšHealth Check å…¶ä»–ç±»å‹çš„å®¹å™¨ï¼Œæ˜¯é€šè¿‡å®¹å™¨è‡ªå®šä¹‰è„šæœ¬åšHealth Checkï¼Œå¦‚æœæ²¡æœ‰è‡ªå®šä¹‰è„šæœ¬ï¼Œåˆ™ç›´æ¥touch /tmp/healthï¼Œé»˜è®¤å®¹å™¨å¥åº·æ£€æŸ¥æˆåŠŸ  ä¸‰. å®¹å™¨åŒ–çš„Health Checkæœºåˆ¶ K8Sçš„Health Checkç›®çš„æ˜¯æ£€æŸ¥ä¸šåŠ¡çš„Podæ˜¯å¦å¯ç”¨\nå®¹å™¨ç»Ÿä¸€ä½¿ç”¨ExecProbeè°ƒç”¨è„šæœ¬/apps/sh/k8s_node/health_check.sh\nå®¹å™¨å¥åº·æ£€æŸ¥çš„å¼€å…³æœºåˆ¶ï¼š\n æ£€æŸ¥/apps/sh/no_health_checkæ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”å…¶ä¸­å†…å®¹ä¸ºtrueï¼Œåˆ™è·³è¿‡å¥åº·æ£€æŸ¥ï¼Œç›´æ¥è¿”å›0ã€‚è¿™ä¸ªåŠŸèƒ½é€‚ç”¨äºç¦ç”¨å•ä¸ªå®¹å™¨çš„å¥åº·æ£€æŸ¥ï¼Œå¯ä»¥é…åˆvjdumpç­‰å‘½ä»¤ä½¿ç”¨ã€‚ æ£€æŸ¥/docker/logs/\u0026lt;domain_name\u0026gt;/no_health_checkæ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”å…¶ä¸­å†…å®¹ä¸ºtrueï¼Œåˆ™è·³è¿‡å¥åº·æ£€æŸ¥ï¼Œç›´æ¥è¿”å›0ã€‚ç”±äº/docker/logs/\u0026lt;domain_name\u0026gt;ç›®å½•å¯¹åº”åˆ°å®¿ä¸»æœºçš„/apps/logs/log_receiver/\u0026lt;domain_name\u0026gt;ç›®å½•ï¼Œè¿ç»´å¯ä»¥ä¸‹å‘æ–‡ä»¶æ¥ç¦ç”¨æ•´ä¸ªåŸŸæ‰€æœ‰å®¹å™¨çš„å¥åº·æ£€æŸ¥ã€‚  1. Httpæ–¹å¼çš„Health Check K8Så¯åŠ¨çš„Nginx+PHP å’Œ Nginx+Tomcatç±»å‹åº”ç”¨å®¹å™¨ï¼Œä»¥åŠai-agentç±»å‹åº”ç”¨å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åšHealth Check\n/apps/sh/k8s_node/health_check.sh http \u0026lt;port\u0026gt; \u0026lt;timeout\u0026gt;\nlivenessProbe: exec: command: - bash - /apps/sh/k8s_node/health_check.sh - http - \u0026quot;80\u0026quot; - \u0026quot;5\u0026quot; failureThreshold: 3 initialDelaySeconds: 300 periodSeconds: 3 successThreshold: 1 timeoutSeconds: 5 name: php-k6zq82 readinessProbe: exec: command: - bash - /apps/sh/k8s_node/health_check.sh - http - \u0026quot;80\u0026quot; - \u0026quot;1\u0026quot; failureThreshold: 3 initialDelaySeconds: 10 periodSeconds: 3 successThreshold: 1 timeoutSeconds: 1  é»˜è®¤é…ç½®å®šä¹‰äº†åº”ç”¨ç±»å‹ä¸å…¶httpå¥åº·æ£€æŸ¥å¯¹åº”çš„ç«¯å£ probe.httpget.apps=${PROBE_HTTPGET_APPS:{\u0026quot;web\u0026quot;:80,\u0026quot;ai-agent\u0026quot;:8079}}\nå¯ä»¥é€šè¿‡é…ç½®ä¸­å¿ƒä¸‹å‘PROBE_HTTPGET_APPSæ¥ä¿®æ”¹\n2. Tcpæ–¹å¼çš„Health Check K8Så¯åŠ¨çš„OSPæœåŠ¡ï¼ŒSaturnæœåŠ¡ä»¥åŠai-modelç±»å‹åº”ç”¨å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åšHealth Check\n/apps/sh/k8s_node/health_check.sh tcp \u0026lt;port\u0026gt; \u0026lt;timeout\u0026gt;\nlivenessProbe: exec: command: - bash - /apps/sh/k8s_node/health_check.sh - tcp - \u0026quot;8080\u0026quot; - \u0026quot;5\u0026quot; failureThreshold: 3 initialDelaySeconds: 300 periodSeconds: 3 successThreshold: 1 timeoutSeconds: 5 name: osp-kdo8d6 readinessProbe: exec: command: - bash - /apps/sh/k8s_node/health_check.sh - tcp - \u0026quot;8080\u0026quot; - \u0026quot;1\u0026quot; failureThreshold: 3 initialDelaySeconds: 10 periodSeconds: 3 successThreshold: 1 timeoutSeconds: 1  Noahé»˜è®¤é…ç½®å®šä¹‰äº†åº”ç”¨ç±»å‹ä¸å…¶tcpå¥åº·æ£€æŸ¥å¯¹åº”çš„ç«¯å£ probe.tcpsocket.apps=${NOAH_PROBE_TCPSOCKET_APPS:{\u0026quot;osp\u0026quot;:8080,\u0026quot;saturn\u0026quot;:24500,\u0026quot;ai-model\u0026quot;:8500}}\t\nå¯ä»¥é€šè¿‡é…ç½®ä¸­å¿ƒä¸‹å‘NOAH_PROBE_TCPSOCKET_APPSæ¥ä¿®æ”¹\n3. Otheræ–¹å¼çš„Health Check å¦‚æœåº”ç”¨ç±»å‹ä¸åœ¨probe.httpget.appså’Œprobe.tcpsocket.appsçš„é…ç½®ä¸­ï¼Œåˆ™ä½¿ç”¨otherç±»å‹çš„å¥åº·æ£€æŸ¥\notherç±»å‹çš„å¥åº·æ£€æŸ¥å®ç°ä¸ºtouch /tmp/healthï¼Œå®¹å™¨å¥åº·æ£€æŸ¥é»˜è®¤æˆåŠŸã€‚\n/apps/sh/k8s_node/health_check.sh other \u0026lt;timeout\u0026gt;\nlivenessProbe: exec: command: - bash - /apps/sh/k8s_node/health_check.sh - other - \u0026quot;5\u0026quot; failureThreshold: 3 initialDelaySeconds: 300 periodSeconds: 3 successThreshold: 1 timeoutSeconds: 5 name: php-k6zq82 readinessProbe: exec: command: - bash - /apps/sh/k8s_node/health_check.sh - other - \u0026quot;1\u0026quot; failureThreshold: 3 initialDelaySeconds: 10 periodSeconds: 3 successThreshold: 1 timeoutSeconds: 1  4. è‡ªå®šä¹‰Health Check Noahå®¹å™¨è‡ªå®šä¹‰å¥åº·æ£€æŸ¥ï¼Œåœ¨æ„å»ºå®¹å™¨é•œåƒæ—¶å¯ä»¥é€šè¿‡moana extendçš„æ–¹å¼åœ¨å®¹å™¨å¯åŠ¨æ—¶å°†custom_health_check.shæ”¾åˆ°/apps/shç›®å½•ä¸‹ï¼š\nåœ¨http/tcp/otherç±»å‹çš„hcè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®¹å™¨å†…å­˜åœ¨æ–‡ä»¶/apps/sh/custom_health_check.shæ—¶ï¼Œåˆ™è°ƒç”¨/apps/sh/custom_health_check.shè„šæœ¬ï¼›å…¥å‚ä¸ºtimeoutï¼Œè„šæœ¬éœ€è¦å®ç°æ£€æŸ¥è¶…æ—¶ï¼›å¦‚æœè„šæœ¬è¾“å‡ºokï¼ˆä¸€å®šè¦å°å†™ï¼‰ï¼Œåˆ™ä»£è¡¨å¥åº·æ£€æŸ¥æˆåŠŸã€‚\nå››. å…³äºå®¹å™¨ReadinessProbeå’ŒLivenessProbeçš„è¯´æ˜  ReadinessProbeé€šè¿‡ï¼Œåˆ™å®¹å™¨è¿›å…¥ReadyçŠ¶æ€ï¼› Livenesså¦‚æœè¿ç»­å¤±è´¥failureThresholdæŒ‡å®šçš„æ¬¡æ•°ï¼Œåˆ™è®¤ä¸ºå®¹å™¨ä¸èƒ½æ­£å¸¸æœåŠ¡ï¼Œkubeletä¼šé‡å¯å®¹å™¨ï¼› initialDeplaySecondsè®¾å®šprobeçš„å»¶è¿Ÿç§’æ•°ï¼Œå³å®¹å™¨å¯åŠ¨åç­‰å¾…å¤šå°‘ç§’å¼€å§‹æ‰§è¡Œprobeï¼› periodSecondsè®¾å®šprobeçš„é—´éš”ï¼Œå³å¼€å§‹æ‰§è¡Œprobeåæ¯éš”å¤šå°‘ç§’æ‰§è¡Œä¸€æ¬¡ï¼› timeoutSecondsè®¾å®šä¸€æ¬¡probeçš„è¶…æ—¶æ—¶é—´ï¼Œç”±äºExecProbeå®é™…ä¸Šæ˜¯æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªå€¼çš„ï¼Œæ‰€ä»¥health_check.shå’Œotherç±»å‹æ‰€ç”¨åˆ°çš„custom_health_check.shéœ€è¦è‡ªå·±å®ç°è¶…æ—¶ï¼› ","date":"2021å¹´02æœˆ27æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter9/health-check/","summary":"","title":"å®¹å™¨å¥åº·æ£€æŸ¥"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹\n ProjectedVolume: Secret, ConfigMap, DownwadAPI ServiceAccount å®¹å™¨å¥åº·æ£€æŸ¥å’Œæ¢å¤æœºåˆ¶ Pod é¢„è®¾ç½®ï¼šPodPreset   ä½œä¸º Kubernetes é¡¹ç›®é‡Œæœ€æ ¸å¿ƒçš„ç¼–æ’å¯¹è±¡ï¼ŒPod æºå¸¦çš„ä¿¡æ¯éå¸¸ä¸°å¯Œã€‚å…¶ä¸­ï¼Œèµ„æºå®šä¹‰ï¼ˆæ¯”å¦‚ CPUã€å†…å­˜ç­‰ï¼‰ï¼Œä»¥åŠè°ƒåº¦ç›¸å…³çš„å­—æ®µï¼Œæˆ‘ä¼šåœ¨åé¢ä¸“é—¨è®²è§£è°ƒåº¦å™¨æ—¶å†è¿›è¡Œæ·±å…¥çš„åˆ†æã€‚åœ¨æœ¬ç¯‡ï¼Œæˆ‘ä»¬å°±å…ˆä»ä¸€ç§ç‰¹æ®Šçš„ Volume å¼€å§‹ï¼Œæ¥å¸®åŠ©ä½ æ›´åŠ æ·±å…¥åœ°ç†è§£ Pod å¯¹è±¡å„ä¸ªé‡è¦å­—æ®µçš„å«ä¹‰ã€‚\nè¿™ç§ç‰¹æ®Šçš„ Volumeï¼Œå«ä½œ Projected Volumeï¼Œä½ å¯ä»¥æŠŠå®ƒç¿»è¯‘ä¸ºâ€œæŠ•å°„æ•°æ®å·â€ã€‚\n å¤‡æ³¨ï¼šProjected Volume æ˜¯ Kubernetes v1.11 ä¹‹åçš„æ–°ç‰¹æ€§\n è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ\nåœ¨ Kubernetes ä¸­ï¼Œæœ‰å‡ ç§ç‰¹æ®Šçš„ Volumeï¼Œå®ƒä»¬å­˜åœ¨çš„æ„ä¹‰ä¸æ˜¯ä¸ºäº†å­˜æ”¾å®¹å™¨é‡Œçš„æ•°æ®ï¼Œä¹Ÿä¸æ˜¯ç”¨æ¥è¿›è¡Œå®¹å™¨å’Œå®¿ä¸»æœºä¹‹é—´çš„æ•°æ®äº¤æ¢ã€‚è¿™äº›ç‰¹æ®Š Volume çš„ä½œç”¨ï¼Œæ˜¯ä¸ºå®¹å™¨æä¾›é¢„å…ˆå®šä¹‰å¥½çš„æ•°æ®ã€‚æ‰€ä»¥ï¼Œä»å®¹å™¨çš„è§’åº¦æ¥çœ‹ï¼Œè¿™äº› Volume é‡Œçš„ä¿¡æ¯å°±æ˜¯ä»¿ä½›æ˜¯è¢« Kubernetesâ€œæŠ•å°„â€ï¼ˆProjectï¼‰è¿›å…¥å®¹å™¨å½“ä¸­çš„ã€‚è¿™æ­£æ˜¯ Projected Volume çš„å«ä¹‰ã€‚\nProjected Volume: Secret, ConfigMap, Downward API åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒKubernetes æ”¯æŒçš„ Projected Volume ä¸€å…±æœ‰å››ç§ï¼š\n Secretï¼› ConfigMapï¼› Downward APIï¼› ServiceAccountTokenã€‚  åœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘é¦–å…ˆå’Œä½ åˆ†äº«çš„æ˜¯ Secretã€‚å®ƒçš„ä½œç”¨ï¼Œæ˜¯å¸®ä½ æŠŠ Pod æƒ³è¦è®¿é—®çš„åŠ å¯†æ•°æ®ï¼Œå­˜æ”¾åˆ° Etcd ä¸­ã€‚ç„¶åï¼Œä½ å°±å¯ä»¥é€šè¿‡åœ¨ Pod çš„å®¹å™¨é‡ŒæŒ‚è½½ Volume çš„æ–¹å¼ï¼Œè®¿é—®åˆ°è¿™äº› Secret é‡Œä¿å­˜çš„ä¿¡æ¯äº†ã€‚\nSecret æœ€å…¸å‹çš„ä½¿ç”¨åœºæ™¯ï¼Œè«è¿‡äºå­˜æ”¾æ•°æ®åº“çš„ Credential ä¿¡æ¯ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\napiVersion: v1 kind: Pod metadata: name: test-projected-volume spec: containers: - name: test-secret-volume image: busybox args: - sleep - \u0026quot;86400\u0026quot; volumeMounts: - name: mysql-cred mountPath: \u0026quot;/projected-volume\u0026quot; readOnly: true volumes: - name: mysql-cred projected: sources: - secret: name: user - secret: name: pass  åœ¨è¿™ä¸ª Pod ä¸­ï¼Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„å®¹å™¨ã€‚å®ƒå£°æ˜æŒ‚è½½çš„ Volumeï¼Œå¹¶ä¸æ˜¯å¸¸è§çš„ emptyDir æˆ–è€… hostPath ç±»å‹ï¼Œè€Œæ˜¯ projected ç±»å‹ã€‚è€Œè¿™ä¸ª Volume çš„æ•°æ®æ¥æºï¼ˆsourcesï¼‰ï¼Œåˆ™æ˜¯åä¸º user å’Œ pass çš„ Secret å¯¹è±¡ï¼Œåˆ†åˆ«å¯¹åº”çš„æ˜¯æ•°æ®åº“çš„ç”¨æˆ·åå’Œå¯†ç ã€‚\nè¿™é‡Œç”¨åˆ°çš„æ•°æ®åº“çš„ç”¨æˆ·åã€å¯†ç ï¼Œæ­£æ˜¯ä»¥ Secret å¯¹è±¡çš„æ–¹å¼äº¤ç»™ Kubernetes ä¿å­˜çš„ã€‚å®Œæˆè¿™ä¸ªæ“ä½œçš„æŒ‡ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ cat ./username.txt admin $ cat ./password.txt c1oudc0w! $ kubectl create secret generic user --from-file=./username.txt $ kubectl create secret generic pass --from-file=./password.txt  å…¶ä¸­ï¼Œusername.txt å’Œ password.txt æ–‡ä»¶é‡Œï¼Œå­˜æ”¾çš„å°±æ˜¯ç”¨æˆ·åå’Œå¯†ç ï¼›è€Œ user å’Œ passï¼Œåˆ™æ˜¯æˆ‘ä¸º Secret å¯¹è±¡æŒ‡å®šçš„åå­—ã€‚è€Œæˆ‘æƒ³è¦æŸ¥çœ‹è¿™äº› Secret å¯¹è±¡çš„è¯ï¼Œåªè¦æ‰§è¡Œä¸€æ¡ kubectl get å‘½ä»¤å°±å¯ä»¥äº†ï¼š\n# kubectl get secrets NAME TYPE DATA AGE default-token-97ss5 kubernetes.io/service-account-token 3 8d pass Opaque 1 9s user Opaque 1 35s  å½“ç„¶ï¼Œé™¤äº†ä½¿ç”¨ kubectl create secret æŒ‡ä»¤å¤–ï¼Œæˆ‘ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ç¼–å†™ YAML æ–‡ä»¶çš„æ–¹å¼æ¥åˆ›å»ºè¿™ä¸ª Secret å¯¹è±¡ï¼Œæ¯”å¦‚ï¼š\napiVersion: v1 kind: Secret metadata: name: mysecret type: Opaque data: user: YWRtaW4= pass: MWYyZDFlMmU2N2Rm  å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ç¼–å†™ YAML æ–‡ä»¶åˆ›å»ºå‡ºæ¥çš„ Secret å¯¹è±¡åªæœ‰ä¸€ä¸ªã€‚ä½†å®ƒçš„ data å­—æ®µï¼Œå´ä»¥ Key-Value çš„æ ¼å¼ä¿å­˜äº†ä¸¤ä»½ Secret æ•°æ®ã€‚å…¶ä¸­ï¼Œâ€œuserâ€å°±æ˜¯ç¬¬ä¸€ä»½æ•°æ®çš„ Keyï¼Œâ€œpassâ€æ˜¯ç¬¬äºŒä»½æ•°æ®çš„ Keyã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSecret å¯¹è±¡è¦æ±‚è¿™äº›æ•°æ®å¿…é¡»æ˜¯ç»è¿‡ Base64 è½¬ç çš„ï¼Œä»¥å…å‡ºç°æ˜æ–‡å¯†ç çš„å®‰å…¨éšæ‚£ã€‚è¿™ä¸ªè½¬ç æ“ä½œä¹Ÿå¾ˆç®€å•ï¼Œæ¯”å¦‚ï¼š\n$ echo -n 'admin' | base64 YWRtaW4= $ echo -n '1f2d1e2e67df' | base64 MWYyZDFlMmU2N2Rm  è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåƒè¿™æ ·åˆ›å»ºçš„ Secret å¯¹è±¡ï¼Œå®ƒé‡Œé¢çš„å†…å®¹ä»…ä»…æ˜¯ç»è¿‡äº†è½¬ç ï¼Œè€Œå¹¶æ²¡æœ‰è¢«åŠ å¯†ã€‚åœ¨çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ éœ€è¦åœ¨ Kubernetes ä¸­å¼€å¯ Secret çš„åŠ å¯†æ’ä»¶ï¼Œå¢å¼ºæ•°æ®çš„å®‰å…¨æ€§ã€‚å…³äºå¼€å¯ Secret åŠ å¯†æ’ä»¶çš„å†…å®¹ï¼Œæˆ‘ä¼šåœ¨åç»­ä¸“é—¨è®²è§£ Secret çš„æ—¶å€™ï¼Œå†åšè¿›ä¸€æ­¥è¯´æ˜ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°è¯•ä¸€ä¸‹åˆ›å»ºè¿™ä¸ª Podï¼š\n$ kubectl create -f test-projected-volume.yaml  å½“ Pod å˜æˆ Running çŠ¶æ€ä¹‹åï¼Œæˆ‘ä»¬å†éªŒè¯ä¸€ä¸‹è¿™äº› Secret å¯¹è±¡æ˜¯ä¸æ˜¯å·²ç»åœ¨å®¹å™¨é‡Œäº†ï¼š\n$ kubectl exec -it test-projected-volume -- /bin/sh / $ ls /projected-volume/ password.txt username.txt / $ cat /projected-volume/username.txt admin / $ cat /projected-volume/password.txt cloud0w  ä»è¿”å›ç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¿å­˜åœ¨ Etcd é‡Œçš„ç”¨æˆ·åå’Œå¯†ç ä¿¡æ¯ï¼Œå·²ç»ä»¥æ–‡ä»¶çš„å½¢å¼å‡ºç°åœ¨äº†å®¹å™¨çš„ Volume ç›®å½•é‡Œã€‚è€Œè¿™ä¸ªæ–‡ä»¶çš„åå­—ï¼Œå°±æ˜¯ kubectl create secret æŒ‡å®šçš„ Keyï¼Œæˆ–è€…è¯´æ˜¯ Secret å¯¹è±¡çš„ data å­—æ®µæŒ‡å®šçš„ Keyã€‚\næ›´é‡è¦çš„æ˜¯ï¼Œåƒè¿™æ ·é€šè¿‡æŒ‚è½½æ–¹å¼è¿›å…¥åˆ°å®¹å™¨é‡Œçš„ Secretï¼Œä¸€æ—¦å…¶å¯¹åº”çš„ Etcd é‡Œçš„æ•°æ®è¢«æ›´æ–°ï¼Œè¿™äº› Volume é‡Œçš„æ–‡ä»¶å†…å®¹ï¼ŒåŒæ ·ä¹Ÿä¼šè¢«æ›´æ–°ã€‚å…¶å®ï¼Œè¿™æ˜¯ kubelet ç»„ä»¶åœ¨å®šæ—¶ç»´æŠ¤è¿™äº› Volumeã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ›´æ–°å¯èƒ½ä¼šæœ‰ä¸€å®šçš„å»¶æ—¶ã€‚æ‰€ä»¥åœ¨ç¼–å†™åº”ç”¨ç¨‹åºæ—¶ï¼Œåœ¨å‘èµ·æ•°æ®åº“è¿æ¥çš„ä»£ç å¤„å†™å¥½é‡è¯•å’Œè¶…æ—¶çš„é€»è¾‘ï¼Œç»å¯¹æ˜¯ä¸ªå¥½ä¹ æƒ¯ã€‚\nä¸ Secret ç±»ä¼¼çš„æ˜¯ ConfigMapï¼Œå®ƒä¸ Secret çš„åŒºåˆ«åœ¨äºï¼ŒConfigMap ä¿å­˜çš„æ˜¯ä¸éœ€è¦åŠ å¯†çš„ã€åº”ç”¨æ‰€éœ€çš„é…ç½®ä¿¡æ¯ã€‚è€Œ ConfigMap çš„ç”¨æ³•å‡ ä¹ä¸ Secret å®Œå…¨ç›¸åŒï¼šä½ å¯ä»¥ä½¿ç”¨ kubectl create configmap ä»æ–‡ä»¶æˆ–è€…ç›®å½•åˆ›å»º ConfigMapï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç¼–å†™ ConfigMap å¯¹è±¡çš„ YAML æ–‡ä»¶ã€‚\næ¯”å¦‚ï¼Œä¸€ä¸ª Java åº”ç”¨æ‰€éœ€çš„é…ç½®æ–‡ä»¶ï¼ˆ.properties æ–‡ä»¶ï¼‰ï¼Œå°±å¯ä»¥é€šè¿‡ä¸‹é¢è¿™æ ·çš„æ–¹å¼ä¿å­˜åœ¨ ConfigMap é‡Œï¼š\n# .propertiesæ–‡ä»¶çš„å†…å®¹ $ cat example/ui.properties color.good=purple color.bad=yellow allow.textmode=true how.nice.to.look=fairlyNice # ä».propertiesæ–‡ä»¶åˆ›å»ºConfigMap $ kubectl create configmap ui-config --from-file=example/ui.properties # æŸ¥çœ‹è¿™ä¸ªConfigMapé‡Œä¿å­˜çš„ä¿¡æ¯(data) $ kubectl get configmaps ui-config -o yaml apiVersion: v1 data: ui.properties: | color.good=purple color.bad=yellow allow.textmode=true how.nice.to.look=fairlyNice kind: ConfigMap metadata: name: ui-config ...   å¤‡æ³¨ï¼škubectl get -o yaml è¿™æ ·çš„å‚æ•°ï¼Œä¼šå°†æŒ‡å®šçš„ Pod API å¯¹è±¡ä»¥ YAML çš„æ–¹å¼å±•ç¤ºå‡ºæ¥ã€‚\n **æ¥ä¸‹æ¥æ˜¯ Downward APIï¼Œ**å®ƒçš„ä½œç”¨æ˜¯ï¼šè®© Pod é‡Œçš„å®¹å™¨èƒ½å¤Ÿç›´æ¥è·å–åˆ°è¿™ä¸ª Pod API å¯¹è±¡æœ¬èº«çš„ä¿¡æ¯ã€‚\nä¸¾ä¸ªä¾‹å­ï¼š\napiVersion: v1 kind: Pod metadata: name: test-downwardapi-volume labels: zone: us-est-coast cluster: test-cluster1 rack: rack-22 spec: containers: - name: client-container image: k8s.gcr.io/busybox command: [\u0026quot;sh\u0026quot;, \u0026quot;-c\u0026quot;] args: - while true; do if [[ -e /etc/podinfo/labels ]]; then echo -en '\\n\\n'; cat /etc/podinfo/labels; fi; sleep 5; done; volumeMounts: - name: podinfo mountPath: /etc/podinfo readOnly: false volumes: - name: podinfo projected: sources: - downwardAPI: items: - path: \u0026quot;labels\u0026quot; fieldRef: fieldPath: metadata.labels  åœ¨è¿™ä¸ª Pod çš„ YAML æ–‡ä»¶ä¸­ï¼Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„å®¹å™¨ï¼Œå£°æ˜äº†ä¸€ä¸ª projected ç±»å‹çš„ Volumeã€‚åªä¸è¿‡è¿™æ¬¡ Volume çš„æ•°æ®æ¥æºï¼Œå˜æˆäº† Downward APIã€‚è€Œè¿™ä¸ª Downward API Volumeï¼Œåˆ™å£°æ˜äº†è¦æš´éœ² Pod çš„ metadata.labels ä¿¡æ¯ç»™å®¹å™¨ã€‚\né€šè¿‡è¿™æ ·çš„å£°æ˜æ–¹å¼ï¼Œå½“å‰ Pod çš„ Labels å­—æ®µçš„å€¼ï¼Œå°±ä¼šè¢« Kubernetes è‡ªåŠ¨æŒ‚è½½æˆä¸ºå®¹å™¨é‡Œçš„ /etc/podinfo/labels æ–‡ä»¶ã€‚è€Œè¿™ä¸ªå®¹å™¨çš„å¯åŠ¨å‘½ä»¤ï¼Œåˆ™æ˜¯ä¸æ–­æ‰“å°å‡º /etc/podinfo/labels é‡Œçš„å†…å®¹ã€‚\næ‰€ä»¥ï¼Œå½“æˆ‘åˆ›å»ºäº†è¿™ä¸ª Pod ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ kubectl logs æŒ‡ä»¤ï¼ŒæŸ¥çœ‹åˆ°è¿™äº› Labels å­—æ®µè¢«æ‰“å°å‡ºæ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n$ kubectl create -f dapi-volume.yaml $ kubectl logs test-downwardapi-volume cluster=\u0026quot;test-cluster1\u0026quot; rack=\u0026quot;rack-22\u0026quot; zone=\u0026quot;us-est-coast\u0026quot;  ç›®å‰ï¼ŒDownward API æ”¯æŒçš„å­—æ®µå·²ç»éå¸¸ä¸°å¯Œäº†ï¼Œæ¯”å¦‚ï¼š\n1. ä½¿ç”¨fieldRefå¯ä»¥å£°æ˜ä½¿ç”¨: spec.nodeName - å®¿ä¸»æœºåå­— status.hostIP - å®¿ä¸»æœºIP metadata.name - Podçš„åå­— metadata.namespace - Podçš„Namespace status.podIP - Podçš„IP spec.serviceAccountName - Podçš„Service Accountçš„åå­— metadata.uid - Podçš„UID metadata.labels['\u0026lt;KEY\u0026gt;'] - æŒ‡å®š\u0026lt;KEY\u0026gt;çš„Labelå€¼ metadata.annotations['\u0026lt;KEY\u0026gt;'] - æŒ‡å®š\u0026lt;KEY\u0026gt;çš„Annotationå€¼ metadata.labels - Podçš„æ‰€æœ‰Label metadata.annotations - Podçš„æ‰€æœ‰Annotation 2. ä½¿ç”¨resourceFieldRefå¯ä»¥å£°æ˜ä½¿ç”¨: å®¹å™¨çš„CPU limit å®¹å™¨çš„CPU request å®¹å™¨çš„memory limit å®¹å™¨çš„memory request  ä¸Šé¢è¿™ä¸ªåˆ—è¡¨çš„å†…å®¹ï¼Œéšç€ Kubernetes é¡¹ç›®çš„å‘å±•è‚¯å®šè¿˜ä¼šä¸æ–­å¢åŠ ã€‚æ‰€ä»¥è¿™é‡Œåˆ—å‡ºæ¥çš„ä¿¡æ¯ä»…ä¾›å‚è€ƒï¼Œä½ åœ¨ä½¿ç”¨ Downward API æ—¶ï¼Œè¿˜æ˜¯è¦è®°å¾—å»æŸ¥é˜…ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ã€‚\nä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒDownward API èƒ½å¤Ÿè·å–åˆ°çš„ä¿¡æ¯ï¼Œ**ä¸€å®šæ˜¯ Pod é‡Œçš„å®¹å™¨è¿›ç¨‹å¯åŠ¨ä¹‹å‰å°±èƒ½å¤Ÿç¡®å®šä¸‹æ¥çš„ä¿¡æ¯ã€‚**è€Œå¦‚æœä½ æƒ³è¦è·å– Pod å®¹å™¨è¿è¡Œåæ‰ä¼šå‡ºç°çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼Œå®¹å™¨è¿›ç¨‹çš„ PIDï¼Œé‚£å°±è‚¯å®šä¸èƒ½ä½¿ç”¨ Downward API äº†ï¼Œè€Œåº”è¯¥è€ƒè™‘åœ¨ Pod é‡Œå®šä¹‰ä¸€ä¸ª sidecar å®¹å™¨ã€‚\nå…¶å®ï¼ŒSecretã€ConfigMapï¼Œä»¥åŠ Downward API è¿™ä¸‰ç§ Projected Volume å®šä¹‰çš„ä¿¡æ¯ï¼Œå¤§å¤šè¿˜å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼å‡ºç°åœ¨å®¹å™¨é‡Œã€‚ä½†æ˜¯ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡è·å–è¿™äº›ä¿¡æ¯çš„æ–¹å¼ï¼Œä¸å…·å¤‡è‡ªåŠ¨æ›´æ–°çš„èƒ½åŠ›ã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘éƒ½å»ºè®®ä½ ä½¿ç”¨ Volume æ–‡ä»¶çš„æ–¹å¼è·å–è¿™äº›ä¿¡æ¯ã€‚\nService Account åœ¨æ˜ç™½äº† Secret ä¹‹åï¼Œæˆ‘å†ä¸ºä½ è®²è§£ Pod ä¸­ä¸€ä¸ªä¸å®ƒå¯†åˆ‡ç›¸å…³çš„æ¦‚å¿µï¼šService Accountã€‚\nç›¸ä¿¡ä½ ä¸€å®šæœ‰è¿‡è¿™æ ·çš„æƒ³æ³•ï¼šæˆ‘ç°åœ¨æœ‰äº†ä¸€ä¸ª Podï¼Œæˆ‘èƒ½ä¸èƒ½åœ¨è¿™ä¸ª Pod é‡Œå®‰è£…ä¸€ä¸ª Kubernetes çš„ Clientï¼Œè¿™æ ·å°±å¯ä»¥ä»å®¹å™¨é‡Œç›´æ¥è®¿é—®å¹¶ä¸”æ“ä½œè¿™ä¸ª Kubernetes çš„ API äº†å‘¢ï¼Ÿè¿™å½“ç„¶æ˜¯å¯ä»¥çš„ã€‚ä¸è¿‡ï¼Œä½ é¦–å…ˆè¦è§£å†³ API Server çš„æˆæƒé—®é¢˜ã€‚\nService Account å¯¹è±¡çš„ä½œç”¨ï¼Œå°±æ˜¯ Kubernetes ç³»ç»Ÿå†…ç½®çš„ä¸€ç§â€œæœåŠ¡è´¦æˆ·â€ï¼Œå®ƒæ˜¯ Kubernetes è¿›è¡Œæƒé™åˆ†é…çš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼ŒService Account Aï¼Œå¯ä»¥åªè¢«å…è®¸å¯¹ Kubernetes API è¿›è¡Œ GET æ“ä½œï¼Œè€Œ Service Account Bï¼Œåˆ™å¯ä»¥æœ‰ Kubernetes API çš„æ‰€æœ‰æ“ä½œæƒé™ã€‚åƒè¿™æ ·çš„ Service Account çš„æˆæƒä¿¡æ¯å’Œæ–‡ä»¶ï¼Œå®é™…ä¸Šä¿å­˜åœ¨å®ƒæ‰€ç»‘å®šçš„ä¸€ä¸ªç‰¹æ®Šçš„ Secret å¯¹è±¡é‡Œçš„ã€‚è¿™ä¸ªç‰¹æ®Šçš„ Secret å¯¹è±¡ï¼Œå°±å«ä½œ ServiceAccountTokenã€‚ä»»ä½•è¿è¡Œåœ¨ Kubernetes é›†ç¾¤ä¸Šçš„åº”ç”¨ï¼Œéƒ½å¿…é¡»ä½¿ç”¨è¿™ä¸ª ServiceAccountToken é‡Œä¿å­˜çš„æˆæƒä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ Tokenï¼Œæ‰å¯ä»¥åˆæ³•åœ°è®¿é—® API Serverã€‚æ‰€ä»¥è¯´ï¼ŒKubernetes é¡¹ç›®çš„ Projected Volume å…¶å®åªæœ‰ä¸‰ç§ï¼Œå› ä¸ºç¬¬å››ç§ ServiceAccountTokenï¼Œåªæ˜¯ä¸€ç§ç‰¹æ®Šçš„ Secret è€Œå·²ã€‚\nå¦å¤–ï¼Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼ŒKubernetes å·²ç»ä¸ºä½ æä¾›äº†ä¸€ä¸ªé»˜è®¤â€œæœåŠ¡è´¦æˆ·â€ï¼ˆdefault Service Accountï¼‰ã€‚å¹¶ä¸”ï¼Œä»»ä½•ä¸€ä¸ªè¿è¡Œåœ¨ Kubernetes é‡Œçš„ Podï¼Œéƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªé»˜è®¤çš„ Service Accountï¼Œè€Œæ— éœ€æ˜¾ç¤ºåœ°å£°æ˜æŒ‚è½½å®ƒã€‚\nè¿™æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ\nå½“ç„¶è¿˜æ˜¯é  Projected Volume æœºåˆ¶ã€‚\nå¦‚æœä½ æŸ¥çœ‹ä¸€ä¸‹ä»»æ„ä¸€ä¸ªè¿è¡Œåœ¨ Kubernetes é›†ç¾¤é‡Œçš„ Podï¼Œå°±ä¼šå‘ç°ï¼Œæ¯ä¸€ä¸ª Podï¼Œéƒ½å·²ç»è‡ªåŠ¨å£°æ˜ä¸€ä¸ªç±»å‹æ˜¯ Secretã€åä¸º default-token-xxxx çš„ Volumeï¼Œç„¶å è‡ªåŠ¨æŒ‚è½½åœ¨æ¯ä¸ªå®¹å™¨çš„ä¸€ä¸ªå›ºå®šç›®å½•ä¸Šã€‚æ¯”å¦‚ï¼š\n# kubectl describe pod nginx-deployment-748c6fff66-2mnfj Containers: ... Mounts: /usr/share/nginx/html from nginx-vol (rw) /var/run/secrets/kubernetes.io/serviceaccount from default-token-97ss5 (ro) Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled True Volumes: nginx-vol: Type: EmptyDir (a temporary directory that shares a pod's lifetime) Medium: SizeLimit: \u0026lt;unset\u0026gt; default-token-97ss5: Type: Secret (a volume populated by a Secret) SecretName: default-token-97ss5 Optional: false ......  è¿™ä¸ª Secret ç±»å‹çš„ Volumeï¼Œæ­£æ˜¯é»˜è®¤ Service Account å¯¹åº”çš„ ServiceAccountTokenã€‚æ‰€ä»¥è¯´ï¼ŒKubernetes å…¶å®åœ¨æ¯ä¸ª Pod åˆ›å»ºçš„æ—¶å€™ï¼Œè‡ªåŠ¨åœ¨å®ƒçš„ spec.volumes éƒ¨åˆ†æ·»åŠ ä¸Šäº†é»˜è®¤ ServiceAccountToken çš„å®šä¹‰ï¼Œç„¶åè‡ªåŠ¨ç»™æ¯ä¸ªå®¹å™¨åŠ ä¸Šäº†å¯¹åº”çš„ volumeMounts å­—æ®µã€‚è¿™ä¸ªè¿‡ç¨‹å¯¹äºç”¨æˆ·æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„ã€‚è¿™æ ·ï¼Œä¸€æ—¦ Pod åˆ›å»ºå®Œæˆï¼Œå®¹å™¨é‡Œçš„åº”ç”¨å°±å¯ä»¥ç›´æ¥ä»è¿™ä¸ªé»˜è®¤ ServiceAccountToken çš„æŒ‚è½½ç›®å½•é‡Œè®¿é—®åˆ°æˆæƒä¿¡æ¯å’Œæ–‡ä»¶ã€‚\nè¿™ä¸ªå®¹å™¨å†…çš„è·¯å¾„åœ¨ Kubernetes é‡Œæ˜¯å›ºå®šçš„ï¼Œå³ï¼š/var/run/secrets/kubernetes.io/serviceaccount ï¼Œè€Œè¿™ä¸ª Secret ç±»å‹çš„ Volume é‡Œé¢çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š\n# ls /var/run/secrets/kubernetes.io/serviceaccount ca.crt namespace token  æ‰€ä»¥ï¼Œä½ çš„åº”ç”¨ç¨‹åºåªè¦ç›´æ¥åŠ è½½è¿™äº›æˆæƒæ–‡ä»¶ï¼Œå°±å¯ä»¥è®¿é—®å¹¶æ“ä½œ Kubernetes API äº†ã€‚è€Œä¸”ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Kubernetes å®˜æ–¹çš„ Client åŒ…ï¼ˆk8s.io/client-goï¼‰çš„è¯ï¼Œå®ƒè¿˜å¯ä»¥è‡ªåŠ¨åŠ è½½è¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä½ ä¸éœ€è¦åšä»»ä½•é…ç½®æˆ–è€…ç¼–ç æ“ä½œã€‚\nè¿™ç§æŠŠ Kubernetes å®¢æˆ·ç«¯ä»¥å®¹å™¨çš„æ–¹å¼è¿è¡Œåœ¨é›†ç¾¤é‡Œï¼Œç„¶åä½¿ç”¨ default Service Account è‡ªåŠ¨æˆæƒçš„æ–¹å¼ï¼Œè¢«ç§°ä½œâ€œInClusterConfigâ€ï¼Œä¹Ÿæ˜¯æˆ‘æœ€æ¨èçš„è¿›è¡Œ Kubernetes API ç¼–ç¨‹çš„æˆæƒæ–¹å¼ã€‚\nå½“ç„¶ï¼Œè€ƒè™‘åˆ°è‡ªåŠ¨æŒ‚è½½é»˜è®¤ ServiceAccountToken çš„æ½œåœ¨é£é™©ï¼ŒKubernetes å…è®¸ä½ è®¾ç½®é»˜è®¤ä¸ä¸º Pod é‡Œçš„å®¹å™¨è‡ªåŠ¨æŒ‚è½½è¿™ä¸ª Volumeã€‚\né™¤äº†è¿™ä¸ªé»˜è®¤çš„ Service Account å¤–ï¼Œæˆ‘ä»¬å¾ˆå¤šæ—¶å€™è¿˜éœ€è¦åˆ›å»ºä¸€äº›æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ Service Accountï¼Œæ¥å¯¹åº”ä¸åŒçš„æƒé™è®¾ç½®ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬çš„ Pod é‡Œçš„å®¹å™¨å°±å¯ä»¥é€šè¿‡æŒ‚è½½è¿™äº› Service Account å¯¹åº”çš„ ServiceAccountTokenï¼Œæ¥ä½¿ç”¨è¿™äº›è‡ªå®šä¹‰çš„æˆæƒä¿¡æ¯ã€‚åœ¨åé¢è®²è§£ä¸º Kubernetes å¼€å‘æ’ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†ä¼šå®è·µåˆ°è¿™ä¸ªæ“ä½œã€‚\nå®¹å™¨å¥åº·æ£€æŸ¥å’Œæ¢å¤æœºåˆ¶ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ Pod çš„å¦ä¸€ä¸ªé‡è¦çš„é…ç½®ï¼šå®¹å™¨å¥åº·æ£€æŸ¥å’Œæ¢å¤æœºåˆ¶ã€‚\nåœ¨ Kubernetes ä¸­ï¼Œä½ å¯ä»¥ä¸º Pod é‡Œçš„å®¹å™¨å®šä¹‰ä¸€ä¸ªå¥åº·æ£€æŸ¥â€œæ¢é’ˆâ€ï¼ˆProbeï¼‰ã€‚è¿™æ ·ï¼Œkubelet å°±ä¼šæ ¹æ®è¿™ä¸ª Probe çš„è¿”å›å€¼å†³å®šè¿™ä¸ªå®¹å™¨çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»¥å®¹å™¨é•œåƒæ˜¯å¦è¿è¡Œï¼ˆæ¥è‡ª Docker è¿”å›çš„ä¿¡æ¯ï¼‰ä½œä¸ºä¾æ®ã€‚è¿™ç§æœºåˆ¶ï¼Œæ˜¯ç”Ÿäº§ç¯å¢ƒä¸­ä¿è¯åº”ç”¨å¥åº·å­˜æ´»çš„é‡è¦æ‰‹æ®µã€‚\næˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸ª Kubernetes æ–‡æ¡£ä¸­çš„ä¾‹å­ã€‚\napiVersion: v1 kind: Pod metadata: labels: test: liveness name: test-liveness-exec spec: containers: - name: liveness image: busybox args: - /bin/sh - -c - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600 livenessProbe: exec: command: - cat - /tmp/healthy initialDelaySeconds: 5 periodSeconds: 5  åœ¨è¿™ä¸ª Pod ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæœ‰è¶£çš„å®¹å™¨ã€‚å®ƒåœ¨å¯åŠ¨ä¹‹ååšçš„ç¬¬ä¸€ä»¶äº‹ï¼Œå°±æ˜¯åœ¨ /tmp ç›®å½•ä¸‹åˆ›å»ºäº†ä¸€ä¸ª healthy æ–‡ä»¶ï¼Œä»¥æ­¤ä½œä¸ºè‡ªå·±å·²ç»æ­£å¸¸è¿è¡Œçš„æ ‡å¿—ã€‚è€Œ 30 s è¿‡åï¼Œå®ƒä¼šæŠŠè¿™ä¸ªæ–‡ä»¶åˆ é™¤æ‰ã€‚ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªè¿™æ ·çš„ livenessProbeï¼ˆå¥åº·æ£€æŸ¥ï¼‰ã€‚å®ƒçš„ç±»å‹æ˜¯ execï¼Œè¿™æ„å‘³ç€ï¼Œå®ƒä¼šåœ¨å®¹å™¨å¯åŠ¨åï¼Œåœ¨å®¹å™¨é‡Œé¢æ‰§è¡Œä¸€æ¡æˆ‘ä»¬æŒ‡å®šçš„å‘½ä»¤ï¼Œæ¯”å¦‚ï¼šâ€œcat /tmp/healthyâ€ã€‚è¿™æ—¶ï¼Œå¦‚æœè¿™ä¸ªæ–‡ä»¶å­˜åœ¨ï¼Œè¿™æ¡å‘½ä»¤çš„è¿”å›å€¼å°±æ˜¯ 0ï¼ŒPod å°±ä¼šè®¤ä¸ºè¿™ä¸ªå®¹å™¨ä¸ä»…å·²ç»å¯åŠ¨ï¼Œè€Œä¸”æ˜¯å¥åº·çš„ã€‚è¿™ä¸ªå¥åº·æ£€æŸ¥ï¼Œåœ¨å®¹å™¨å¯åŠ¨ 5 s åå¼€å§‹æ‰§è¡Œï¼ˆinitialDelaySeconds: 5ï¼‰ï¼Œæ¯ 5 s æ‰§è¡Œä¸€æ¬¡ï¼ˆperiodSeconds: 5ï¼‰ã€‚\nç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥å…·ä½“å®è·µä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚\né¦–å…ˆï¼Œåˆ›å»ºè¿™ä¸ª Podï¼š\n$ kubectl create -f test-liveness-exec.yaml  ç„¶åï¼ŒæŸ¥çœ‹è¿™ä¸ª Pod çš„çŠ¶æ€ï¼š\n$ kubectl get pod NAME READY STATUS RESTARTS AGE test-liveness-exec 1/1 Running 0 10s  å¯ä»¥çœ‹åˆ°ï¼Œç”±äºå·²ç»é€šè¿‡äº†å¥åº·æ£€æŸ¥ï¼Œè¿™ä¸ª Pod å°±è¿›å…¥äº† Running çŠ¶æ€ã€‚\nè€Œ 30 s ä¹‹åï¼Œæˆ‘ä»¬å†æŸ¥çœ‹ä¸€ä¸‹ Pod çš„ Eventsï¼š\nEvents: Type Reason Age From Message ---- ------ ---- ---- ------- ... Normal Killing 2m11s (x3 over 4m46s) kubelet Container liveness failed liveness probe, will be restarted Warning Unhealthy 2m11s (x9 over 4m56s) kubelet Liveness probe failed: cat: can't open '/tmp/healthy': No such file or directory ...  æ˜¾ç„¶ï¼Œè¿™ä¸ªå¥åº·æ£€æŸ¥æ¢æŸ¥åˆ° /tmp/healthy å·²ç»ä¸å­˜åœ¨äº†ï¼Œæ‰€ä»¥å®ƒæŠ¥å‘Šå®¹å™¨æ˜¯ä¸å¥åº·çš„ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ\næˆ‘ä»¬ä¸å¦¨å†æ¬¡æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ª Pod çš„çŠ¶æ€ï¼š\n# kubectl get pod test-liveness-exec NAME READY STATUS RESTARTS AGE test-liveness-exec 1/1 Running 4 6m9s  è¿™æ—¶æˆ‘ä»¬å‘ç°ï¼ŒPod å¹¶æ²¡æœ‰è¿›å…¥ Failed çŠ¶æ€ï¼Œè€Œæ˜¯ä¿æŒäº† Running çŠ¶æ€ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\nå…¶å®ï¼Œå¦‚æœä½ æ³¨æ„åˆ° RESTARTS å­—æ®µä» 0 åˆ° 1 çš„å˜åŒ–ï¼Œå°±æ˜ç™½åŸå› äº†ï¼šè¿™ä¸ªå¼‚å¸¸çš„å®¹å™¨å·²ç»è¢« Kubernetes é‡å¯äº†ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒPod ä¿æŒ Running çŠ¶æ€ä¸å˜ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼šKubernetes ä¸­å¹¶æ²¡æœ‰ Docker çš„ Stop è¯­ä¹‰ã€‚æ‰€ä»¥è™½ç„¶æ˜¯ Restartï¼ˆé‡å¯ï¼‰ï¼Œä½†å®é™…å´æ˜¯é‡æ–°åˆ›å»ºäº†å®¹å™¨ã€‚\nè¿™ä¸ªåŠŸèƒ½å°±æ˜¯ Kubernetes é‡Œçš„ Pod æ¢å¤æœºåˆ¶ï¼Œä¹Ÿå« restartPolicyã€‚å®ƒæ˜¯ Pod çš„ Spec éƒ¨åˆ†çš„ä¸€ä¸ªæ ‡å‡†å­—æ®µï¼ˆpod.spec.restartPolicyï¼‰ï¼Œé»˜è®¤å€¼æ˜¯ Alwaysï¼Œå³ï¼šä»»ä½•æ—¶å€™è¿™ä¸ªå®¹å™¨å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå®ƒä¸€å®šä¼šè¢«é‡æ–°åˆ›å»ºã€‚\nä½†ä¸€å®šè¦å¼ºè°ƒçš„æ˜¯ï¼ŒPod çš„æ¢å¤è¿‡ç¨‹ï¼Œæ°¸è¿œéƒ½æ˜¯å‘ç”Ÿåœ¨å½“å‰èŠ‚ç‚¹ä¸Šï¼Œè€Œä¸ä¼šè·‘åˆ°åˆ«çš„èŠ‚ç‚¹ä¸Šå»ã€‚äº‹å®ä¸Šï¼Œä¸€æ—¦ä¸€ä¸ª Pod ä¸ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ç»‘å®šï¼Œé™¤éè¿™ä¸ªç»‘å®šå‘ç”Ÿäº†å˜åŒ–ï¼ˆpod.spec.node å­—æ®µè¢«ä¿®æ”¹ï¼‰ï¼Œå¦åˆ™å®ƒæ°¸è¿œéƒ½ä¸ä¼šç¦»å¼€è¿™ä¸ªèŠ‚ç‚¹ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå¦‚æœè¿™ä¸ªå®¿ä¸»æœºå®•æœºäº†ï¼Œè¿™ä¸ª Pod ä¹Ÿä¸ä¼šä¸»åŠ¨è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šå»ã€‚\nè€Œå¦‚æœä½ æƒ³è®© Pod å‡ºç°åœ¨å…¶ä»–çš„å¯ç”¨èŠ‚ç‚¹ä¸Šï¼Œå°±å¿…é¡»ä½¿ç”¨ Deployment è¿™æ ·çš„â€œæ§åˆ¶å™¨â€æ¥ç®¡ç† Podï¼Œå“ªæ€•ä½ åªéœ€è¦ä¸€ä¸ª Pod å‰¯æœ¬ã€‚è¿™å°±æ˜¯æˆ‘åœ¨ç¬¬ 12 ç¯‡æ–‡ç« ã€Šç‰›åˆ€å°è¯•ï¼šæˆ‘çš„ç¬¬ä¸€ä¸ªå®¹å™¨åŒ–åº”ç”¨ã€‹æœ€åç»™ä½ ç•™çš„æ€è€ƒé¢˜çš„ç­”æ¡ˆï¼Œå³ä¸€ä¸ªå• Pod çš„ Deployment ä¸ä¸€ä¸ª Pod æœ€ä¸»è¦çš„åŒºåˆ«ã€‚\nè€Œä½œä¸ºç”¨æˆ·ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡è®¾ç½® restartPolicyï¼Œæ”¹å˜ Pod çš„æ¢å¤ç­–ç•¥ã€‚é™¤äº† Alwaysï¼Œå®ƒè¿˜æœ‰ OnFailure å’Œ Never ä¸¤ç§æƒ…å†µï¼š\n Alwaysï¼šåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œåªè¦å®¹å™¨ä¸åœ¨è¿è¡ŒçŠ¶æ€ï¼Œå°±è‡ªåŠ¨é‡å¯å®¹å™¨ï¼› OnFailure: åªåœ¨å®¹å™¨ å¼‚å¸¸æ—¶æ‰è‡ªåŠ¨é‡å¯å®¹å™¨ï¼› Never: ä»æ¥ä¸é‡å¯å®¹å™¨ã€‚  åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®åº”ç”¨è¿è¡Œçš„ç‰¹æ€§ï¼Œåˆç†è®¾ç½®è¿™ä¸‰ç§æ¢å¤ç­–ç•¥ã€‚\næ¯”å¦‚ï¼Œä¸€ä¸ª Podï¼Œå®ƒåªè®¡ç®— 1+1=2ï¼Œè®¡ç®—å®Œæˆè¾“å‡ºç»“æœåé€€å‡ºï¼Œå˜æˆ Succeeded çŠ¶æ€ã€‚è¿™æ—¶ï¼Œä½ å¦‚æœå†ç”¨ restartPolicy=Always å¼ºåˆ¶é‡å¯è¿™ä¸ª Pod çš„å®¹å™¨ï¼Œå°±æ²¡æœ‰ä»»ä½•æ„ä¹‰äº†ã€‚\nè€Œå¦‚æœä½ è¦å…³å¿ƒè¿™ä¸ªå®¹å™¨é€€å‡ºåçš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œæ¯”å¦‚å®¹å™¨é€€å‡ºåçš„æ—¥å¿—ã€æ–‡ä»¶å’Œç›®å½•ï¼Œå°±éœ€è¦å°† restartPolicy è®¾ç½®ä¸º Neverã€‚å› ä¸ºä¸€æ—¦å®¹å™¨è¢«è‡ªåŠ¨é‡æ–°åˆ›å»ºï¼Œè¿™äº›å†…å®¹å°±æœ‰å¯èƒ½ä¸¢å¤±æ‰äº†ï¼ˆè¢«åƒåœ¾å›æ”¶äº†ï¼‰ã€‚\nå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒKubernetes çš„å®˜æ–¹æ–‡æ¡£ï¼ŒæŠŠ restartPolicy å’Œ Pod é‡Œå®¹å™¨çš„çŠ¶æ€ï¼Œä»¥åŠ Pod çŠ¶æ€çš„å¯¹åº”å…³ç³»ï¼Œæ€»ç»“äº†éå¸¸å¤æ‚çš„ä¸€å¤§å †æƒ…å†µã€‚å®é™…ä¸Šï¼Œä½ æ ¹æœ¬ä¸éœ€è¦æ­»è®°ç¡¬èƒŒè¿™äº›å¯¹åº”å…³ç³»ï¼Œåªè¦è®°ä½å¦‚ä¸‹ä¸¤ä¸ªåŸºæœ¬çš„è®¾è®¡åŸç†å³å¯ï¼š\n  åªè¦ Pod çš„ restartPolicy æŒ‡å®šçš„ç­–ç•¥å…è®¸é‡å¯å¼‚å¸¸çš„å®¹å™¨ï¼ˆæ¯”å¦‚ï¼šAlwaysï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ª Pod å°±ä¼šä¿æŒ Running çŠ¶æ€ï¼Œå¹¶è¿›è¡Œå®¹å™¨é‡å¯ã€‚å¦åˆ™ï¼ŒPod å°±ä¼šè¿›å…¥ Failed çŠ¶æ€ ã€‚\n  å¯¹äºåŒ…å«å¤šä¸ªå®¹å™¨çš„ Podï¼Œåªæœ‰å®ƒé‡Œé¢æ‰€æœ‰çš„å®¹å™¨éƒ½è¿›å…¥å¼‚å¸¸çŠ¶æ€åï¼ŒPod æ‰ä¼šè¿›å…¥ Failed çŠ¶æ€ã€‚åœ¨æ­¤ä¹‹å‰ï¼ŒPod éƒ½æ˜¯ Running çŠ¶æ€ã€‚æ­¤æ—¶ï¼ŒPod çš„ READY å­—æ®µä¼šæ˜¾ç¤ºæ­£å¸¸å®¹å™¨çš„ä¸ªæ•°ï¼Œæ¯”å¦‚ï¼š\n$ kubectl get pod test-liveness-exec NAME READY STATUS RESTARTS AGE liveness-exec 0/1 Running 1 1m    æ‰€ä»¥ï¼Œå‡å¦‚ä¸€ä¸ª Pod é‡Œåªæœ‰ä¸€ä¸ªå®¹å™¨ï¼Œç„¶åè¿™ä¸ªå®¹å™¨å¼‚å¸¸é€€å‡ºäº†ã€‚é‚£ä¹ˆï¼Œåªæœ‰å½“ restartPolicy=Never æ—¶ï¼Œè¿™ä¸ª Pod æ‰ä¼šè¿›å…¥ Failed çŠ¶æ€ã€‚è€Œå…¶ä»–æƒ…å†µä¸‹ï¼Œç”±äº Kubernetes éƒ½å¯ä»¥é‡å¯è¿™ä¸ªå®¹å™¨ï¼Œæ‰€ä»¥ Pod çš„çŠ¶æ€ä¿æŒ Running ä¸å˜ã€‚\nè€Œå¦‚æœè¿™ä¸ª Pod æœ‰å¤šä¸ªå®¹å™¨ï¼Œä»…æœ‰ä¸€ä¸ªå®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œå®ƒå°±å§‹ç»ˆä¿æŒ Running çŠ¶æ€ï¼Œå“ªæ€•å³ä½¿ restartPolicy=Neverã€‚åªæœ‰å½“æ‰€æœ‰å®¹å™¨ä¹Ÿå¼‚å¸¸é€€å‡ºä¹‹åï¼Œè¿™ä¸ª Pod æ‰ä¼šè¿›å…¥ Failed çŠ¶æ€ã€‚\nå…¶ä»–æƒ…å†µï¼Œéƒ½å¯ä»¥ä»¥æ­¤ç±»æ¨å‡ºæ¥ã€‚\nç°åœ¨ï¼Œæˆ‘ä»¬ä¸€èµ·å›åˆ°å‰é¢æåˆ°çš„ livenessProbe ä¸Šæ¥ã€‚\né™¤äº†åœ¨å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤å¤–ï¼ŒlivenessProbe ä¹Ÿå¯ä»¥å®šä¹‰ä¸ºå‘èµ· HTTP æˆ–è€… TCP è¯·æ±‚çš„æ–¹å¼ï¼Œå®šä¹‰æ ¼å¼å¦‚ä¸‹ï¼š\n... livenessProbe: httpGet: path: /healthz port: 8080 httpHeaders: - name: X-Custom-Header value: Awesome initialDelaySeconds: 3 periodSeconds: 3  ... livenessProbe: tcpSocket: port: 8080 initialDelaySeconds: 15 periodSeconds: 20  æ‰€ä»¥ï¼Œä½ çš„ Pod å…¶å®å¯ä»¥æš´éœ²ä¸€ä¸ªå¥åº·æ£€æŸ¥ URLï¼ˆæ¯”å¦‚ /healthzï¼‰ï¼Œæˆ–è€…ç›´æ¥è®©å¥åº·æ£€æŸ¥å»æ£€æµ‹åº”ç”¨çš„ç›‘å¬ç«¯å£ã€‚è¿™ä¸¤ç§é…ç½®æ–¹æ³•ï¼Œåœ¨ Web æœåŠ¡ç±»çš„åº”ç”¨ä¸­éå¸¸å¸¸ç”¨ã€‚\nåœ¨ Kubernetes çš„ Pod ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªå« readinessProbe çš„å­—æ®µã€‚è™½ç„¶å®ƒçš„ç”¨æ³•ä¸ livenessProbe ç±»ä¼¼ï¼Œä½†ä½œç”¨å´å¤§ä¸ä¸€æ ·ã€‚readinessProbe æ£€æŸ¥ç»“æœçš„æˆåŠŸä¸å¦ï¼Œå†³å®šçš„è¿™ä¸ª Pod æ˜¯ä¸æ˜¯èƒ½è¢«é€šè¿‡ Service çš„æ–¹å¼è®¿é—®åˆ°ï¼Œè€Œå¹¶ä¸å½±å“ Pod çš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™éƒ¨åˆ†å†…å®¹ï¼Œæˆ‘ä¼šåœ¨è®²è§£ Service æ—¶é‡ç‚¹ä»‹ç»ã€‚\nå…³äºå®¹å™¨å¥åº·æ£€æŸ¥çš„æ–¹æ¡ˆï¼Œå¯ä»¥å‚è€ƒæœ¬åšå®¢çš„æ–‡ç« å®¹å™¨å¥åº·æ£€æŸ¥æ–¹æ¡ˆã€‚\nåœ¨è®²è§£äº†è¿™ä¹ˆå¤šå­—æ®µä¹‹åï¼Œæƒ³å¿…ä½ å¯¹ Pod å¯¹è±¡çš„è¯­ä¹‰å’Œæè¿°èƒ½åŠ›ï¼Œå·²ç»æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„æ„Ÿè§‰ã€‚\nè¿™æ—¶ï¼Œä½ æœ‰æ²¡æœ‰äº§ç”Ÿè¿™æ ·ä¸€ä¸ªæƒ³æ³•ï¼šPod çš„å­—æ®µè¿™ä¹ˆå¤šï¼Œæˆ‘åˆä¸å¯èƒ½å…¨è®°ä½ï¼ŒKubernetes èƒ½ä¸èƒ½è‡ªåŠ¨ç»™ Pod å¡«å……æŸäº›å­—æ®µå‘¢ï¼Ÿ\nPod é¢„è®¾ç½® è¿™ä¸ªéœ€æ±‚å®é™…ä¸Šéå¸¸å®ç”¨ã€‚æ¯”å¦‚ï¼Œå¼€å‘äººå‘˜åªéœ€è¦æäº¤ä¸€ä¸ªåŸºæœ¬çš„ã€éå¸¸ç®€å•çš„ Pod YAMLï¼ŒKubernetes å°±å¯ä»¥è‡ªåŠ¨ç»™å¯¹åº”çš„ Pod å¯¹è±¡åŠ ä¸Šå…¶ä»–å¿…è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ labelsï¼Œannotationsï¼Œvolumes ç­‰ç­‰ã€‚è€Œè¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥æ˜¯è¿ç»´äººå‘˜äº‹å…ˆå®šä¹‰å¥½çš„ã€‚\nè¿™ä¹ˆä¸€æ¥ï¼Œå¼€å‘äººå‘˜ç¼–å†™ Pod YAML çš„é—¨æ§›ï¼Œå°±è¢«å¤§å¤§é™ä½äº†ã€‚\næ‰€ä»¥ï¼Œè¿™ä¸ªå«ä½œ PodPresetï¼ˆPod é¢„è®¾ç½®ï¼‰çš„åŠŸèƒ½ å·²ç»å‡ºç°åœ¨äº† v1.11 ç‰ˆæœ¬çš„ Kubernetes ä¸­ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨å¼€å‘äººå‘˜ç¼–å†™äº†å¦‚ä¸‹ä¸€ä¸ª pod.yaml æ–‡ä»¶ï¼š\napiVersion: v1 kind: Pod metadata: name: website labels: app: website role: frontend spec: containers: - name: website image: nginx ports: - containerPort: 80  ä½œä¸º Kubernetes çš„åˆå­¦è€…ï¼Œä½ è‚¯å®šçœ¼å‰ä¸€äº®ï¼šè¿™ä¸å°±æ˜¯æˆ‘æœ€æ“…é•¿ç¼–å†™çš„ã€æœ€ç®€å•çš„ Pod å˜›ã€‚æ²¡é”™ï¼Œè¿™ä¸ª YAML æ–‡ä»¶é‡Œçš„å­—æ®µï¼Œæƒ³å¿…ä½ ç°åœ¨é—­ç€çœ¼ç›ä¹Ÿèƒ½å†™å‡ºæ¥ã€‚å¯æ˜¯ï¼Œå¦‚æœè¿ç»´äººå‘˜çœ‹åˆ°äº†è¿™ä¸ª Podï¼Œä»–ä¸€å®šä¼šè¿è¿æ‘‡å¤´ï¼šè¿™ç§ Pod åœ¨ç”Ÿäº§ç¯å¢ƒé‡Œæ ¹æœ¬ä¸èƒ½ç”¨å•Šï¼æ‰€ä»¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¿ç»´äººå‘˜å°±å¯ä»¥å®šä¹‰ä¸€ä¸ª PodPreset å¯¹è±¡ã€‚åœ¨è¿™ä¸ªå¯¹è±¡ä¸­ï¼Œå‡¡æ˜¯ä»–æƒ³åœ¨å¼€å‘äººå‘˜ç¼–å†™çš„ Pod é‡Œè¿½åŠ çš„å­—æ®µï¼Œéƒ½å¯ä»¥é¢„å…ˆå®šä¹‰å¥½ã€‚æ¯”å¦‚è¿™ä¸ª preset.yamlï¼š\napiVersion: settings.k8s.io/v1alpha1 kind: PodPreset metadata: name: allow-database spec: selector: matchLabels: role: frontend env: - name: DB_PORT value: \u0026quot;6379\u0026quot; volumeMounts: - mountPath: /cache name: cache-volume volumes: - name: cache-volume emptyDir: {}  åœ¨è¿™ä¸ª PodPreset çš„å®šä¹‰ä¸­ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ª selectorã€‚è¿™å°±æ„å‘³ç€åé¢è¿™äº›è¿½åŠ çš„å®šä¹‰ï¼Œåªä¼šä½œç”¨äº selector æ‰€å®šä¹‰çš„ã€å¸¦æœ‰â€œrole: frontendâ€æ ‡ç­¾çš„ Pod å¯¹è±¡ï¼Œè¿™å°±å¯ä»¥é˜²æ­¢â€œè¯¯ä¼¤â€ã€‚\nç„¶åï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ç»„ Pod çš„ Spec é‡Œçš„æ ‡å‡†å­—æ®µï¼Œä»¥åŠå¯¹åº”çš„å€¼ã€‚æ¯”å¦‚ï¼Œenv é‡Œå®šä¹‰äº† DB_PORT è¿™ä¸ªç¯å¢ƒå˜é‡ï¼ŒvolumeMounts å®šä¹‰äº†å®¹å™¨ Volume çš„æŒ‚è½½ç›®å½•ï¼Œvolumes å®šä¹‰äº†ä¸€ä¸ª emptyDir çš„ Volumeã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å‡å®šè¿ç»´äººå‘˜å…ˆåˆ›å»ºäº†è¿™ä¸ª PodPresetï¼Œç„¶åå¼€å‘äººå‘˜æ‰åˆ›å»º Podï¼š\n$ kubectl create -f preset.yaml $ kubectl create -f pod.yaml  è¿™æ—¶ï¼ŒPod è¿è¡Œèµ·æ¥ä¹‹åï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ª Pod çš„ API å¯¹è±¡ï¼š\n$ kubectl get pod website -o yaml apiVersion: v1 kind: Pod metadata: name: website labels: app: website role: frontend annotations: podpreset.admission.kubernetes.io/podpreset-allow-database: \u0026quot;resource version\u0026quot; spec: containers: - name: website image: nginx volumeMounts: - mountPath: /cache name: cache-volume ports: - containerPort: 80 env: - name: DB_PORT value: \u0026quot;6379\u0026quot; volumes: - name: cache-volume emptyDir: {}  è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œè¿™ä¸ª Pod é‡Œå¤šäº†æ–°æ·»åŠ çš„ labelsã€envã€volumes å’Œ volumeMount çš„å®šä¹‰ï¼Œå®ƒä»¬çš„é…ç½®è·Ÿ PodPreset çš„å†…å®¹ä¸€æ ·ã€‚æ­¤å¤–ï¼Œè¿™ä¸ª Pod è¿˜è¢«è‡ªåŠ¨åŠ ä¸Šäº†ä¸€ä¸ª annotation è¡¨ç¤ºè¿™ä¸ª Pod å¯¹è±¡è¢« PodPreset æ”¹åŠ¨è¿‡ã€‚\néœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒPodPreset é‡Œå®šä¹‰çš„å†…å®¹ï¼Œåªä¼šåœ¨ Pod API å¯¹è±¡è¢«åˆ›å»ºä¹‹å‰è¿½åŠ åœ¨è¿™ä¸ªå¯¹è±¡æœ¬èº«ä¸Šï¼Œè€Œä¸ä¼šå½±å“ä»»ä½• Pod çš„æ§åˆ¶å™¨çš„å®šä¹‰ã€‚\næ¯”å¦‚ï¼Œæˆ‘ä»¬ç°åœ¨æäº¤çš„æ˜¯ä¸€ä¸ª nginx-deploymentï¼Œé‚£ä¹ˆè¿™ä¸ª Deployment å¯¹è±¡æœ¬èº«æ˜¯æ°¸è¿œä¸ä¼šè¢« PodPreset æ”¹å˜çš„ï¼Œè¢«ä¿®æ”¹çš„åªæ˜¯è¿™ä¸ª Deployment åˆ›å»ºå‡ºæ¥çš„æ‰€æœ‰ Podã€‚è¿™ä¸€ç‚¹è¯·åŠ¡å¿…åŒºåˆ†æ¸…æ¥šã€‚\nè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœä½ å®šä¹‰äº†åŒæ—¶ä½œç”¨äºä¸€ä¸ª Pod å¯¹è±¡çš„å¤šä¸ª PodPresetï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿå®é™…ä¸Šï¼ŒKubernetes é¡¹ç›®ä¼šå¸®ä½ åˆå¹¶ï¼ˆMergeï¼‰è¿™ä¸¤ä¸ª PodPreset è¦åšçš„ä¿®æ”¹ã€‚è€Œå¦‚æœå®ƒä»¬è¦åšçš„ä¿®æ”¹æœ‰å†²çªçš„è¯ï¼Œè¿™äº›å†²çªå­—æ®µå°±ä¸ä¼šè¢«ä¿®æ”¹ã€‚\næ€»ç»“\nåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å’Œä½ è¯¦ç»†ä»‹ç»äº† Pod å¯¹è±¡æ›´é«˜é˜¶çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¸Œæœ›é€šè¿‡å¯¹è¿™äº›å®ä¾‹çš„è®²è§£ï¼Œä½ å¯ä»¥æ›´æ·±å…¥åœ°ç†è§£ Pod API å¯¹è±¡çš„å„ä¸ªå­—æ®µã€‚è€Œåœ¨å­¦ä¹ è¿™äº›å­—æ®µçš„åŒæ—¶ï¼Œä½ è¿˜åº”è¯¥è®¤çœŸä½“ä¼šä¸€ä¸‹ Kubernetesâ€œä¸€åˆ‡çš†å¯¹è±¡â€çš„è®¾è®¡æ€æƒ³ï¼šæ¯”å¦‚åº”ç”¨æ˜¯ Pod å¯¹è±¡ï¼Œåº”ç”¨çš„é…ç½®æ˜¯ ConfigMap å¯¹è±¡ï¼Œåº”ç”¨è¦è®¿é—®çš„å¯†ç åˆ™æ˜¯ Secret å¯¹è±¡ã€‚\næ‰€ä»¥ï¼Œä¹Ÿå°±è‡ªç„¶è€Œç„¶åœ°æœ‰äº† PodPreset è¿™æ ·ä¸“é—¨ç”¨æ¥å¯¹ Pod è¿›è¡Œæ‰¹é‡åŒ–ã€è‡ªåŠ¨åŒ–ä¿®æ”¹çš„å·¥å…·å¯¹è±¡ã€‚åœ¨åé¢çš„å†…å®¹ä¸­ï¼Œæˆ‘ä¼šä¸ºä½ è®²è§£æ›´å¤šçš„è¿™ç§å¯¹è±¡ï¼Œè¿˜ä¼šå’Œä½ ä»‹ç» Kubernetes é¡¹ç›®å¦‚ä½•å›´ç»•ç€è¿™äº›å¯¹è±¡è¿›è¡Œå®¹å™¨ç¼–æ’ã€‚\nåœ¨æœ¬ä¸“æ ä¸­ï¼ŒPod å¯¹è±¡ç›¸å…³çš„çŸ¥è¯†ç‚¹éå¸¸é‡è¦ï¼Œå®ƒæ˜¯æ¥ä¸‹æ¥ Kubernetes èƒ½å¤Ÿæè¿°å’Œç¼–æ’å„ç§å¤æ‚åº”ç”¨çš„åŸºçŸ³æ‰€åœ¨ï¼Œå¸Œæœ›ä½ èƒ½å¤Ÿç»§ç»­å¤šå®è·µã€å¤šä½“ä¼šã€‚\n","date":"2021å¹´02æœˆ27æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/pod-concept2/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æ Kubernetesã€‹è¯¾ç¨‹\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eProjectedVolume: Secret, ConfigMap, DownwadAPI\u003c/li\u003e\n\u003cli\u003eServiceAccount\u003c/li\u003e\n\u003cli\u003eå®¹å™¨å¥åº·æ£€æŸ¥å’Œæ¢å¤æœºåˆ¶\u003c/li\u003e\n\u003cli\u003ePod é¢„è®¾ç½®ï¼šPodPreset\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/blockquote\u003e","title":"æ·±å…¥è§£æPodå¯¹è±¡(äºŒ): ä½¿ç”¨è¿›é˜¶"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æKubernetesã€‹è¯¾ç¨‹ï¼Œç¬¬14è¯¾æ—¶ï¼šæ·±å…¥è§£æPodå¯¹è±¡(ä¸€)ï¼šåŸºæœ¬æ¦‚å¿µ\n ç°åœ¨ï¼Œä½ å·²ç»éå¸¸æ¸…æ¥šï¼šPodï¼Œè€Œä¸æ˜¯å®¹å™¨ï¼Œæ‰æ˜¯ Kubernetes é¡¹ç›®ä¸­çš„æœ€å°ç¼–æ’å•ä½ã€‚å°†è¿™ä¸ªè®¾è®¡è½å®åˆ° API å¯¹è±¡ä¸Šï¼Œå®¹å™¨ï¼ˆContainerï¼‰å°±æˆäº† Pod å±æ€§é‡Œçš„ä¸€ä¸ªæ™®é€šçš„å­—æ®µã€‚é‚£ä¹ˆï¼Œä¸€ä¸ªå¾ˆè‡ªç„¶çš„é—®é¢˜å°±æ˜¯ï¼šåˆ°åº•å“ªäº›å±æ€§å±äº Pod å¯¹è±¡ï¼Œè€Œåˆæœ‰å“ªäº›å±æ€§å±äº Container å‘¢ï¼Ÿ\nè¦å½»åº•ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œä½ å°±ä¸€å®šè¦ç‰¢è®°æˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„ä¸€ä¸ªç»“è®ºï¼šPod æ‰®æ¼”çš„æ˜¯ä¼ ç»Ÿéƒ¨ç½²ç¯å¢ƒé‡Œâ€œè™šæ‹Ÿæœºâ€çš„è§’è‰²ã€‚è¿™æ ·çš„è®¾è®¡ï¼Œæ˜¯ä¸ºäº†ä½¿ç”¨æˆ·ä»ä¼ ç»Ÿç¯å¢ƒï¼ˆè™šæ‹Ÿæœºç¯å¢ƒï¼‰å‘ Kubernetesï¼ˆå®¹å™¨ç¯å¢ƒï¼‰çš„è¿ç§»ï¼Œæ›´åŠ å¹³æ»‘ã€‚è€Œå¦‚æœä½ èƒ½æŠŠ Pod çœ‹æˆä¼ ç»Ÿç¯å¢ƒé‡Œçš„â€œæœºå™¨â€ã€æŠŠå®¹å™¨çœ‹ä½œæ˜¯è¿è¡Œåœ¨è¿™ä¸ªâ€œæœºå™¨â€é‡Œçš„â€œç”¨æˆ·ç¨‹åºâ€ï¼Œé‚£ä¹ˆå¾ˆå¤šå…³äº Pod å¯¹è±¡çš„è®¾è®¡å°±éå¸¸å®¹æ˜“ç†è§£äº†ã€‚\næ¯”å¦‚ï¼Œå‡¡æ˜¯è°ƒåº¦ã€ç½‘ç»œã€å­˜å‚¨ï¼Œä»¥åŠå®‰å…¨ç›¸å…³çš„å±æ€§ï¼ŒåŸºæœ¬ä¸Šæ˜¯ Pod çº§åˆ«çš„ã€‚\nè¿™äº›å±æ€§çš„å…±åŒç‰¹å¾æ˜¯ï¼Œå®ƒä»¬æè¿°çš„æ˜¯â€œæœºå™¨â€è¿™ä¸ªæ•´ä½“ï¼Œè€Œä¸æ˜¯é‡Œé¢è¿è¡Œçš„â€œç¨‹åºâ€ã€‚æ¯”å¦‚ï¼Œé…ç½®è¿™ä¸ªâ€œæœºå™¨â€çš„ç½‘å¡ï¼ˆå³ï¼šPod çš„ç½‘ç»œå®šä¹‰ï¼‰ï¼Œé…ç½®è¿™ä¸ªâ€œæœºå™¨â€çš„ç£ç›˜ï¼ˆå³ï¼šPod çš„å­˜å‚¨å®šä¹‰ï¼‰ï¼Œé…ç½®è¿™ä¸ªâ€œæœºå™¨â€çš„é˜²ç«å¢™ï¼ˆå³ï¼šPod çš„å®‰å…¨å®šä¹‰ï¼‰ã€‚æ›´ä¸ç”¨è¯´ï¼Œè¿™å°â€œæœºå™¨â€è¿è¡Œåœ¨å“ªä¸ªæœåŠ¡å™¨ä¹‹ä¸Šï¼ˆå³ï¼šPod çš„è°ƒåº¦ï¼‰ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘å°±å…ˆä¸ºä½ ä»‹ç» Pod ä¸­å‡ ä¸ªé‡è¦å­—æ®µçš„å«ä¹‰å’Œç”¨æ³•ã€‚\nNodeSelectorï¼šæ˜¯ä¸€ä¸ªä¾›ç”¨æˆ·å°† Pod ä¸ Node è¿›è¡Œç»‘å®šçš„å­—æ®µï¼Œç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: v1 kind: Pod ... spec: nodeSelector: disktype: ssd  è¿™æ ·çš„ä¸€ä¸ªé…ç½®ï¼Œæ„å‘³ç€è¿™ä¸ª Pod æ°¸è¿œåªèƒ½è¿è¡Œåœ¨æºå¸¦äº†â€œdisktype: ssdâ€æ ‡ç­¾ï¼ˆLabelï¼‰çš„èŠ‚ç‚¹ä¸Šï¼›å¦åˆ™ï¼Œå®ƒå°†è°ƒåº¦å¤±è´¥ã€‚\nNodeNameï¼šä¸€æ—¦ Pod çš„è¿™ä¸ªå­—æ®µè¢«èµ‹å€¼ï¼ŒKubernetes é¡¹ç›®å°±ä¼šè¢«è®¤ä¸ºè¿™ä¸ª Pod å·²ç»ç»è¿‡äº†è°ƒåº¦ï¼Œè°ƒåº¦çš„ç»“æœå°±æ˜¯èµ‹å€¼çš„èŠ‚ç‚¹åå­—ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªå­—æ®µä¸€èˆ¬ç”±è°ƒåº¦å™¨è´Ÿè´£è®¾ç½®ï¼Œä½†ç”¨æˆ·ä¹Ÿå¯ä»¥è®¾ç½®å®ƒæ¥â€œéª—è¿‡â€è°ƒåº¦å™¨ï¼Œå½“ç„¶è¿™ä¸ªåšæ³•ä¸€èˆ¬æ˜¯åœ¨æµ‹è¯•æˆ–è€…è°ƒè¯•çš„æ—¶å€™æ‰ä¼šç”¨åˆ°ã€‚\nHostAliasesï¼šå®šä¹‰äº† Pod çš„ hosts æ–‡ä»¶ï¼ˆæ¯”å¦‚ /etc/hostsï¼‰é‡Œçš„å†…å®¹ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Pod ... spec: hostAliases: - ip: \u0026quot;10.1.2.3\u0026quot; hostnames: - \u0026quot;foo.remote\u0026quot; - \u0026quot;bar.remote\u0026quot; ...  åœ¨è¿™ä¸ª Pod çš„ YAML æ–‡ä»¶ä¸­ï¼Œæˆ‘è®¾ç½®äº†ä¸€ç»„ IP å’Œ hostname çš„æ•°æ®ã€‚è¿™æ ·ï¼Œè¿™ä¸ª Pod å¯åŠ¨åï¼Œ/etc/hosts æ–‡ä»¶çš„å†…å®¹å°†å¦‚ä¸‹æ‰€ç¤ºï¼š\ncat /etc/hosts # Kubernetes-managed hosts file. 127.0.0.1 localhost ... 10.244.135.10 hostaliases-pod 10.1.2.3 foo.remote 10.1.2.3 bar.remote  å…¶ä¸­ï¼Œæœ€ä¸‹é¢ä¸¤è¡Œè®°å½•ï¼Œå°±æ˜¯æˆ‘é€šè¿‡ HostAliases å­—æ®µä¸º Pod è®¾ç½®çš„ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œåœ¨ Kubernetes é¡¹ç›®ä¸­ï¼Œå¦‚æœè¦è®¾ç½® hosts æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œä¸€å®šè¦é€šè¿‡è¿™ç§æ–¹æ³•ã€‚å¦åˆ™ï¼Œå¦‚æœç›´æ¥ä¿®æ”¹äº† hosts æ–‡ä»¶çš„è¯ï¼Œåœ¨ Pod è¢«åˆ é™¤é‡å»ºä¹‹åï¼Œkubelet ä¼šè‡ªåŠ¨è¦†ç›–æ‰è¢«ä¿®æ”¹çš„å†…å®¹ã€‚\né™¤äº†ä¸Šè¿°è·Ÿâ€œæœºå™¨â€ç›¸å…³çš„é…ç½®å¤–ï¼Œä½ å¯èƒ½ä¹Ÿä¼šå‘ç°ï¼Œå‡¡æ˜¯è·Ÿå®¹å™¨çš„ Linux Namespace ç›¸å…³çš„å±æ€§ï¼Œä¹Ÿä¸€å®šæ˜¯ Pod çº§åˆ«çš„ã€‚è¿™ä¸ªåŸå› ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼šPod çš„è®¾è®¡ï¼Œå°±æ˜¯è¦è®©å®ƒé‡Œé¢çš„å®¹å™¨å°½å¯èƒ½å¤šåœ°å…±äº« Linux Namespaceï¼Œä»…ä¿ç•™å¿…è¦çš„éš”ç¦»å’Œé™åˆ¶èƒ½åŠ›ã€‚è¿™æ ·ï¼ŒPod æ¨¡æ‹Ÿå‡ºçš„æ•ˆæœï¼Œå°±è·Ÿè™šæ‹Ÿæœºé‡Œç¨‹åºé—´çš„å…³ç³»éå¸¸ç±»ä¼¼äº†ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸‹é¢è¿™ä¸ª Pod çš„ YAML æ–‡ä»¶ä¸­ï¼Œæˆ‘å®šä¹‰äº† shareProcessNamespace=trueï¼š\napiVersion: v1 kind: Pod metadata: name: nginx spec: shareProcessNamespace: true containers: - name: nginx image: nginx - name: shell image: busybox stdin: true tty: true  è¿™å°±æ„å‘³ç€è¿™ä¸ª Pod é‡Œçš„å®¹å™¨è¦å…±äº« PID Namespaceã€‚\nè€Œåœ¨è¿™ä¸ª YAML æ–‡ä»¶ä¸­ï¼Œæˆ‘è¿˜å®šä¹‰äº†ä¸¤ä¸ªå®¹å™¨ï¼šä¸€ä¸ªæ˜¯ nginx å®¹å™¨ï¼Œä¸€ä¸ªæ˜¯å¼€å¯äº† tty å’Œ stdin çš„ shell å®¹å™¨ã€‚æˆ‘åœ¨å‰é¢ä»‹ç»å®¹å™¨åŸºç¡€æ—¶ï¼Œæ›¾ç»è®²è§£è¿‡ä»€ä¹ˆæ˜¯ tty å’Œ stdinã€‚è€Œåœ¨ Pod çš„ YAML æ–‡ä»¶é‡Œå£°æ˜å¼€å¯å®ƒä»¬ä¿©ï¼Œå…¶å®ç­‰åŒäºè®¾ç½®äº† docker run é‡Œçš„ -itï¼ˆ-i å³ stdinï¼Œ-t å³ ttyï¼‰å‚æ•°ã€‚*å¦‚æœä½ è¿˜æ˜¯ä¸å¤ªç†è§£å®ƒä»¬ä¿©çš„ä½œç”¨çš„è¯ï¼Œå¯ä»¥ç›´æ¥è®¤ä¸º tty å°±æ˜¯ Linux ç»™ç”¨æˆ·æä¾›çš„ä¸€ä¸ªå¸¸é©»å°ç¨‹åºï¼Œç”¨äºæ¥æ”¶ç”¨æˆ·çš„æ ‡å‡†è¾“å…¥ï¼Œè¿”å›æ“ä½œç³»ç»Ÿçš„æ ‡å‡†è¾“å‡ºã€‚*å½“ç„¶ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨ tty ä¸­è¾“å…¥ä¿¡æ¯ï¼Œä½ è¿˜éœ€è¦åŒæ—¶å¼€å¯ stdinï¼ˆæ ‡å‡†è¾“å…¥æµï¼‰ã€‚\näºæ˜¯ï¼Œè¿™ä¸ª Pod è¢«åˆ›å»ºåï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ shell å®¹å™¨çš„ tty è·Ÿè¿™ä¸ªå®¹å™¨è¿›è¡Œäº¤äº’äº†ã€‚æˆ‘ä»¬ä¸€èµ·å®è·µä¸€ä¸‹ï¼š\n$ kubectl create -f nginx.yaml  æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ kubectl attach å‘½ä»¤ï¼Œè¿æ¥åˆ° shell å®¹å™¨çš„ tty ä¸Šï¼š\n$ kubectl attach -it nginx -c shell  è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ shell å®¹å™¨é‡Œæ‰§è¡Œ ps æŒ‡ä»¤ï¼ŒæŸ¥çœ‹æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼š\n$ kubectl attach -it nginx -c shell / # ps ax PID USER TIME COMMAND 1 root 0:00 /pause 8 root 0:00 nginx: master process nginx -g daemon off; 14 101 0:00 nginx: worker process 15 root 0:00 sh 21 root 0:00 ps ax  å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªå®¹å™¨é‡Œï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥çœ‹åˆ°å®ƒæœ¬èº«çš„ ps ax æŒ‡ä»¤ï¼Œè¿˜å¯ä»¥çœ‹åˆ° nginx å®¹å™¨çš„è¿›ç¨‹ï¼Œä»¥åŠ Infra å®¹å™¨çš„ /pause è¿›ç¨‹ã€‚è¿™å°±æ„å‘³ç€ï¼Œæ•´ä¸ª Pod é‡Œçš„æ¯ä¸ªå®¹å™¨çš„è¿›ç¨‹ï¼Œå¯¹äºæ‰€æœ‰å®¹å™¨æ¥è¯´éƒ½æ˜¯å¯è§çš„ï¼šå®ƒä»¬å…±äº«äº†åŒä¸€ä¸ª PID Namespaceã€‚\nç±»ä¼¼åœ°ï¼Œå‡¡æ˜¯ Pod ä¸­çš„å®¹å™¨è¦å…±äº«å®¿ä¸»æœºçš„ Namespaceï¼Œä¹Ÿä¸€å®šæ˜¯ Pod çº§åˆ«çš„å®šä¹‰ï¼Œæ¯”å¦‚ï¼š\napiVersion: v1 kind: Pod metadata: name: nginx spec: hostNetwork: true hostIPC: true hostPID: true containers: - name: nginx image: nginx - name: shell image: busybox stdin: true tty: true  åœ¨è¿™ä¸ª Pod ä¸­ï¼Œæˆ‘å®šä¹‰äº†å…±äº«å®¿ä¸»æœºçš„ Networkã€IPC å’Œ PID Namespaceã€‚è¿™å°±æ„å‘³ç€ï¼Œè¿™ä¸ª Pod é‡Œçš„æ‰€æœ‰å®¹å™¨ï¼Œä¼šç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œã€ç›´æ¥ä¸å®¿ä¸»æœºè¿›è¡Œ IPC é€šä¿¡ã€çœ‹åˆ°å®¿ä¸»æœºé‡Œæ­£åœ¨è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹ã€‚\nå½“ç„¶ï¼Œé™¤äº†è¿™äº›å±æ€§ï¼ŒPod é‡Œæœ€é‡è¦çš„å­—æ®µå½“å±â€œContainersâ€äº†ã€‚è€Œåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è¿˜ä»‹ç»è¿‡â€œInit Containersâ€ã€‚å…¶å®ï¼Œè¿™ä¸¤ä¸ªå­—æ®µéƒ½å±äº Pod å¯¹å®¹å™¨çš„å®šä¹‰ï¼Œå†…å®¹ä¹Ÿå®Œå…¨ç›¸åŒï¼Œåªæ˜¯ Init Containers çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¼šå…ˆäºæ‰€æœ‰çš„ Containersï¼Œå¹¶ä¸”ä¸¥æ ¼æŒ‰ç…§å®šä¹‰çš„é¡ºåºæ‰§è¡Œã€‚\nKubernetes é¡¹ç›®ä¸­å¯¹ Container çš„å®šä¹‰ï¼Œå’Œ Docker ç›¸æ¯”å¹¶æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§åŒºåˆ«ã€‚æˆ‘åœ¨å‰é¢çš„å®¹å™¨æŠ€æœ¯æ¦‚å¿µå…¥é—¨ç³»åˆ—æ–‡ç« ä¸­ï¼Œå’Œä½ åˆ†äº«çš„ Imageï¼ˆé•œåƒï¼‰ã€Commandï¼ˆå¯åŠ¨å‘½ä»¤ï¼‰ã€workingDirï¼ˆå®¹å™¨çš„å·¥ä½œç›®å½•ï¼‰ã€Portsï¼ˆå®¹å™¨è¦å¼€æ”¾çš„ç«¯å£ï¼‰ï¼Œä»¥åŠ *volumeMountsï¼ˆå®¹å™¨è¦æŒ‚è½½çš„ Volumeï¼‰*éƒ½æ˜¯æ„æˆ Kubernetes é¡¹ç›®ä¸­ Container çš„ä¸»è¦å­—æ®µã€‚ä¸è¿‡åœ¨è¿™é‡Œï¼Œè¿˜æœ‰è¿™ä¹ˆå‡ ä¸ªå±æ€§å€¼å¾—ä½ é¢å¤–å…³æ³¨ã€‚\n**é¦–å…ˆï¼Œæ˜¯ ImagePullPolicy å­—æ®µã€‚**å®ƒå®šä¹‰äº†é•œåƒæ‹‰å–çš„ç­–ç•¥ã€‚è€Œå®ƒä¹‹æ‰€ä»¥æ˜¯ä¸€ä¸ª Container çº§åˆ«çš„å±æ€§ï¼Œæ˜¯å› ä¸ºå®¹å™¨é•œåƒæœ¬æ¥å°±æ˜¯ Container å®šä¹‰ä¸­çš„ä¸€éƒ¨åˆ†ã€‚\nImagePullPolicy çš„å€¼é»˜è®¤æ˜¯ Alwaysï¼Œå³æ¯æ¬¡åˆ›å»º Pod éƒ½é‡æ–°æ‹‰å–ä¸€æ¬¡é•œåƒã€‚å¦å¤–ï¼Œå½“å®¹å™¨çš„é•œåƒæ˜¯ç±»ä¼¼äº nginx æˆ–è€… nginx:latest è¿™æ ·çš„åå­—æ—¶ï¼ŒImagePullPolicy ä¹Ÿä¼šè¢«è®¤ä¸º Alwaysã€‚\nè€Œå¦‚æœå®ƒçš„å€¼è¢«å®šä¹‰ä¸º Never æˆ–è€… IfNotPresentï¼Œåˆ™æ„å‘³ç€ Pod æ°¸è¿œä¸ä¼šä¸»åŠ¨æ‹‰å–è¿™ä¸ªé•œåƒï¼Œæˆ–è€…åªåœ¨å®¿ä¸»æœºä¸Šä¸å­˜åœ¨è¿™ä¸ªé•œåƒæ—¶æ‰æ‹‰å–ã€‚\nå…¶æ¬¡ï¼Œæ˜¯ Lifecycle å­—æ®µã€‚å®ƒå®šä¹‰çš„æ˜¯ Container Lifecycle Hooksã€‚é¡¾åæ€ä¹‰ï¼ŒContainer Lifecycle Hooks çš„ä½œç”¨ï¼Œæ˜¯åœ¨å®¹å™¨çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘ä¸€ç³»åˆ—â€œé’©å­â€ã€‚æˆ‘ä»¬æ¥çœ‹è¿™æ ·ä¸€ä¸ªä¾‹å­ï¼š\napiVersion: v1 kind: Pod metadata: name: lifecycle-demo spec: containers: - name: lifecycle-demo-container image: nginx lifecycle: postStart: exec: command: [\u0026quot;/bin/sh\u0026quot;, \u0026quot;-c\u0026quot;, \u0026quot;echo Hello from the postStart handler \u0026gt; /usr/share/message\u0026quot;] preStop: exec: command: [\u0026quot;/usr/sbin/nginx\u0026quot;,\u0026quot;-s\u0026quot;,\u0026quot;quit\u0026quot;]  è¿™æ˜¯ä¸€ä¸ªæ¥è‡ª Kubernetes å®˜æ–¹æ–‡æ¡£çš„ Pod çš„ YAML æ–‡ä»¶ã€‚å®ƒå…¶å®éå¸¸ç®€å•ï¼Œåªæ˜¯å®šä¹‰äº†ä¸€ä¸ª nginx é•œåƒçš„å®¹å™¨ã€‚ä¸è¿‡ï¼Œåœ¨è¿™ä¸ª YAML æ–‡ä»¶çš„å®¹å™¨ï¼ˆContainersï¼‰éƒ¨åˆ†ï¼Œä½ ä¼šçœ‹åˆ°è¿™ä¸ªå®¹å™¨åˆ†åˆ«è®¾ç½®äº†ä¸€ä¸ª postStart å’Œ preStop å‚æ•°ã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ\nå…ˆè¯´ postStart å§ã€‚å®ƒæŒ‡çš„æ˜¯ï¼Œåœ¨å®¹å™¨å¯åŠ¨åï¼Œç«‹åˆ»æ‰§è¡Œä¸€ä¸ªæŒ‡å®šçš„æ“ä½œã€‚éœ€è¦æ˜ç¡®çš„æ˜¯ï¼ŒpostStart å®šä¹‰çš„æ“ä½œï¼Œè™½ç„¶æ˜¯åœ¨ Docker å®¹å™¨ ENTRYPOINT æ‰§è¡Œä¹‹åï¼Œä½†å®ƒå¹¶ä¸ä¸¥æ ¼ä¿è¯é¡ºåºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ postStart å¯åŠ¨æ—¶ï¼ŒENTRYPOINT æœ‰å¯èƒ½è¿˜æ²¡æœ‰ç»“æŸã€‚\nå½“ç„¶ï¼Œå¦‚æœ postStart æ‰§è¡Œè¶…æ—¶æˆ–è€…é”™è¯¯ï¼ŒKubernetes ä¼šåœ¨è¯¥ Pod çš„ Events ä¸­æŠ¥å‡ºè¯¥å®¹å™¨å¯åŠ¨å¤±è´¥çš„é”™è¯¯ä¿¡æ¯ï¼Œå¯¼è‡´ Pod ä¹Ÿå¤„äºå¤±è´¥çš„çŠ¶æ€ã€‚\nè€Œç±»ä¼¼åœ°ï¼ŒpreStop å‘ç”Ÿçš„æ—¶æœºï¼Œåˆ™æ˜¯å®¹å™¨è¢«æ€æ­»ä¹‹å‰ï¼ˆæ¯”å¦‚ï¼Œæ”¶åˆ°äº† SIGKILL ä¿¡å·ï¼‰ã€‚è€Œéœ€è¦æ˜ç¡®çš„æ˜¯ï¼ŒpreStop æ“ä½œçš„æ‰§è¡Œï¼Œæ˜¯åŒæ­¥çš„ã€‚æ‰€ä»¥ï¼Œå®ƒä¼šé˜»å¡å½“å‰çš„å®¹å™¨æ€æ­»æµç¨‹ï¼Œç›´åˆ°è¿™ä¸ª Hook å®šä¹‰æ“ä½œå®Œæˆä¹‹åï¼Œæ‰å…è®¸å®¹å™¨è¢«æ€æ­»ï¼Œè¿™è·Ÿ postStart ä¸ä¸€æ ·ã€‚\næ‰€ä»¥ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨å®¹å™¨æˆåŠŸå¯åŠ¨ä¹‹åï¼Œåœ¨ /usr/share/message é‡Œå†™å…¥äº†ä¸€å¥â€œæ¬¢è¿ä¿¡æ¯â€ï¼ˆå³ postStart å®šä¹‰çš„æ“ä½œï¼‰ã€‚è€Œåœ¨è¿™ä¸ªå®¹å™¨è¢«åˆ é™¤ä¹‹å‰ï¼Œæˆ‘ä»¬åˆ™å…ˆè°ƒç”¨äº† nginx çš„é€€å‡ºæŒ‡ä»¤ï¼ˆå³ preStop å®šä¹‰çš„æ“ä½œï¼‰ï¼Œä»è€Œå®ç°äº†å®¹å™¨çš„â€œä¼˜é›…é€€å‡ºâ€ã€‚\nåœ¨ç†Ÿæ‚‰äº† Pod ä»¥åŠå®ƒçš„ Container éƒ¨åˆ†çš„ä¸»è¦å­—æ®µä¹‹åï¼Œæˆ‘å†å’Œä½ åˆ†äº«ä¸€ä¸‹è¿™æ ·ä¸€ä¸ªçš„ Pod å¯¹è±¡åœ¨ Kubernetes ä¸­çš„ç”Ÿå‘½å‘¨æœŸã€‚\nPod ç”Ÿå‘½å‘¨æœŸçš„å˜åŒ–ï¼Œä¸»è¦ä½“ç°åœ¨ Pod API å¯¹è±¡çš„ Status éƒ¨åˆ†ï¼Œè¿™æ˜¯å®ƒé™¤äº† Metadata å’Œ Spec ä¹‹å¤–çš„ç¬¬ä¸‰ä¸ªé‡è¦å­—æ®µã€‚å…¶ä¸­ï¼Œpod.status.phaseï¼Œå°±æ˜¯ Pod çš„å½“å‰çŠ¶æ€ï¼Œå®ƒæœ‰å¦‚ä¸‹å‡ ç§å¯èƒ½çš„æƒ…å†µï¼š\n Pendingã€‚è¿™ä¸ªçŠ¶æ€æ„å‘³ç€ï¼ŒPod çš„ YAML æ–‡ä»¶å·²ç»æäº¤ç»™äº† Kubernetesï¼ŒAPI å¯¹è±¡å·²ç»è¢«åˆ›å»ºå¹¶ä¿å­˜åœ¨ Etcd å½“ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ª Pod é‡Œæœ‰äº›å®¹å™¨å› ä¸ºæŸç§åŸå› è€Œä¸èƒ½è¢«é¡ºåˆ©åˆ›å»ºã€‚æ¯”å¦‚ï¼Œè°ƒåº¦ä¸æˆåŠŸã€‚ Runningã€‚è¿™ä¸ªçŠ¶æ€ä¸‹ï¼ŒPod å·²ç»è°ƒåº¦æˆåŠŸï¼Œè·Ÿä¸€ä¸ªå…·ä½“çš„èŠ‚ç‚¹ç»‘å®šã€‚å®ƒåŒ…å«çš„å®¹å™¨éƒ½å·²ç»åˆ›å»ºæˆåŠŸï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œä¸­ã€‚ Succeededã€‚è¿™ä¸ªçŠ¶æ€æ„å‘³ç€ï¼ŒPod é‡Œçš„æ‰€æœ‰å®¹å™¨éƒ½æ­£å¸¸è¿è¡Œå®Œæ¯•ï¼Œå¹¶ä¸”å·²ç»é€€å‡ºäº†ã€‚è¿™ç§æƒ…å†µåœ¨è¿è¡Œä¸€æ¬¡æ€§ä»»åŠ¡æ—¶æœ€ä¸ºå¸¸è§ã€‚ Failedã€‚è¿™ä¸ªçŠ¶æ€ä¸‹ï¼ŒPod é‡Œè‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ä»¥ä¸æ­£å¸¸çš„çŠ¶æ€ï¼ˆé 0 çš„è¿”å›ç ï¼‰é€€å‡ºã€‚è¿™ä¸ªçŠ¶æ€çš„å‡ºç°ï¼Œæ„å‘³ç€ä½ å¾—æƒ³åŠæ³• Debug è¿™ä¸ªå®¹å™¨çš„åº”ç”¨ï¼Œæ¯”å¦‚æŸ¥çœ‹ Pod çš„ Events å’Œæ—¥å¿—ã€‚ Unknownã€‚è¿™æ˜¯ä¸€ä¸ªå¼‚å¸¸çŠ¶æ€ï¼Œæ„å‘³ç€ Pod çš„çŠ¶æ€ä¸èƒ½æŒç»­åœ°è¢« kubelet æ±‡æŠ¥ç»™ kube-apiserverï¼Œè¿™å¾ˆæœ‰å¯èƒ½æ˜¯ä¸»ä»èŠ‚ç‚¹ï¼ˆMaster å’Œ Kubeletï¼‰é—´çš„é€šä¿¡å‡ºç°äº†é—®é¢˜ã€‚  æ›´è¿›ä¸€æ­¥åœ°ï¼ŒPod å¯¹è±¡çš„ Status å­—æ®µï¼Œè¿˜å¯ä»¥å†ç»†åˆ†å‡ºä¸€ç»„ Conditionsã€‚è¿™äº›ç»†åˆ†çŠ¶æ€çš„å€¼åŒ…æ‹¬ï¼šPodScheduledã€Readyã€Initializedï¼Œä»¥åŠ Unschedulableã€‚å®ƒä»¬ä¸»è¦ç”¨äºæè¿°é€ æˆå½“å‰ Status çš„å…·ä½“åŸå› æ˜¯ä»€ä¹ˆã€‚\næ¯”å¦‚ï¼ŒPod å½“å‰çš„ Status æ˜¯ Pendingï¼Œå¯¹åº”çš„ Condition æ˜¯ Unschedulableï¼Œè¿™å°±æ„å‘³ç€å®ƒçš„è°ƒåº¦å‡ºç°äº†é—®é¢˜ã€‚\nè€Œå…¶ä¸­ï¼ŒReady è¿™ä¸ªç»†åˆ†çŠ¶æ€éå¸¸å€¼å¾—æˆ‘ä»¬å…³æ³¨ï¼šå®ƒæ„å‘³ç€ Pod ä¸ä»…å·²ç»æ­£å¸¸å¯åŠ¨ï¼ˆRunning çŠ¶æ€ï¼‰ï¼Œè€Œä¸”å·²ç»å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡äº†ã€‚è¿™ä¸¤è€…ä¹‹é—´ï¼ˆRunning å’Œ Readyï¼‰æ˜¯æœ‰åŒºåˆ«çš„ï¼Œä½ ä¸å¦¨ä»”ç»†æ€è€ƒä¸€ä¸‹ã€‚\nPod çš„è¿™äº›çŠ¶æ€ä¿¡æ¯ï¼Œæ˜¯æˆ‘ä»¬åˆ¤æ–­åº”ç”¨è¿è¡Œæƒ…å†µçš„é‡è¦æ ‡å‡†ï¼Œå°¤å…¶æ˜¯ Pod è¿›å…¥äº†éâ€œRunningâ€çŠ¶æ€åï¼Œä½ ä¸€å®šè¦èƒ½è¿…é€Ÿåšå‡ºååº”ï¼Œæ ¹æ®å®ƒæ‰€ä»£è¡¨çš„å¼‚å¸¸æƒ…å†µå¼€å§‹è·Ÿè¸ªå’Œå®šä½ï¼Œè€Œä¸æ˜¯å»æ‰‹å¿™è„šä¹±åœ°æŸ¥é˜…æ–‡æ¡£ã€‚\næ€»ç»“\nåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è¯¦ç»†è®²è§£äº† Pod API å¯¹è±¡ï¼Œä»‹ç»äº† Pod çš„æ ¸å¿ƒä½¿ç”¨æ–¹æ³•ï¼Œå¹¶åˆ†æäº† Pod å’Œ Container åœ¨å­—æ®µä¸Šçš„å¼‚åŒã€‚å¸Œæœ›è¿™äº›è®²è§£èƒ½å¤Ÿå¸®ä½ æ›´å¥½åœ°ç†è§£å’Œè®°å¿† Pod YAML ä¸­çš„æ ¸å¿ƒå­—æ®µï¼Œä»¥åŠè¿™äº›å­—æ®µçš„å‡†ç¡®å«ä¹‰ã€‚å®é™…ä¸Šï¼ŒPod API å¯¹è±¡æ˜¯æ•´ä¸ª Kubernetes ä½“ç³»ä¸­æœ€æ ¸å¿ƒçš„ä¸€ä¸ªæ¦‚å¿µï¼Œä¹Ÿæ˜¯åé¢æˆ‘è®²è§£å„ç§æ§åˆ¶å™¨æ—¶éƒ½è¦ç”¨åˆ°çš„ã€‚åœ¨å­¦ä¹ å®Œè¿™ç¯‡æ–‡ç« åï¼Œæˆ‘å¸Œæœ›ä½ èƒ½ä»”ç»†é˜…è¯» $GOPATH/src/k8s.io/kubernetes/pkg/apis/core/types.go é‡Œï¼Œtype Pod struct ï¼Œå°¤å…¶æ˜¯ PodSpec éƒ¨åˆ†çš„å†…å®¹ã€‚äº‰å–åšåˆ°ä¸‹æ¬¡çœ‹åˆ°ä¸€ä¸ª Pod çš„ YAML æ–‡ä»¶æ—¶ï¼Œä¸å†éœ€è¦æŸ¥é˜…æ–‡æ¡£ï¼Œå°±èƒ½åšåˆ°æŠŠå¸¸ç”¨å­—æ®µåŠå…¶ä½œç”¨ä¿¡æ‰‹æ‹ˆæ¥ã€‚è€Œåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šé€šè¿‡å¤§é‡çš„å®è·µï¼Œå¸®åŠ©ä½ å·©å›ºå’Œè¿›é˜¶å…³äº Pod API å¯¹è±¡æ ¸å¿ƒå­—æ®µçš„ä½¿ç”¨æ–¹æ³•ï¼Œæ•¬è¯·æœŸå¾…å§ã€‚\n","date":"2021å¹´02æœˆ26æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/pod-concept1/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æKubernetesã€‹è¯¾ç¨‹ï¼Œç¬¬14è¯¾æ—¶ï¼šæ·±å…¥è§£æPodå¯¹è±¡(ä¸€)ï¼šåŸºæœ¬æ¦‚å¿µ\u003c/p\u003e\n\u003c/blockquote\u003e","title":"æ·±å…¥è§£æPodå¯¹è±¡(ä¸€)ï¼šåŸºæœ¬æ¦‚å¿µ"},{"contents":" æœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æKubernetesã€‹è¯¾ç¨‹ï¼Œç¬¬13è¯¾æ—¶ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ Pod?\n Podï¼Œæ˜¯ Kubernetes é¡¹ç›®ä¸­æœ€å°çš„ API å¯¹è±¡ã€‚å¦‚æœæ¢ä¸€ä¸ªæ›´ä¸“ä¸šçš„è¯´æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æè¿°ï¼šPodï¼Œæ˜¯ Kubernetes é¡¹ç›®çš„åŸå­è°ƒåº¦å•ä½ã€‚\nä¸è¿‡ï¼Œæˆ‘ç›¸ä¿¡ä½ åœ¨å­¦ä¹ å’Œä½¿ç”¨ Kubernetes é¡¹ç›®çš„è¿‡ç¨‹ä¸­ï¼Œå·²ç»ä¸æ­¢ä¸€æ¬¡åœ°æƒ³è¦é—®è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šéœ€è¦ Podï¼Ÿ\næ˜¯å•Šï¼Œæˆ‘ä»¬åœ¨å‰é¢å·²ç»èŠ±äº†å¾ˆå¤šç²¾åŠ›å»è§£è¯» Linux å®¹å™¨çš„åŸç†ã€åˆ†æäº† Docker å®¹å™¨çš„æœ¬è´¨ï¼Œç»ˆäºï¼Œâ€œNamespace åšéš”ç¦»ï¼ŒCgroups åšé™åˆ¶ï¼Œrootfs åšæ–‡ä»¶ç³»ç»Ÿâ€è¿™æ ·çš„â€œä¸‰å¥ç®´è¨€â€å¯ä»¥æœ—æœ—ä¸Šå£äº†ï¼Œä¸ºä»€ä¹ˆ Kubernetes é¡¹ç›®åˆçªç„¶æå‡ºä¸€ä¸ª Pod æ¥å‘¢ï¼Ÿ\nè¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦ä¸€èµ·å›å¿†ä¸€ä¸‹æˆ‘æ›¾ç»åå¤å¼ºè°ƒçš„ä¸€ä¸ªé—®é¢˜ï¼šå®¹å™¨çš„æœ¬è´¨åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ\nä½ ç°åœ¨åº”è¯¥å¯ä»¥ä¸å‡æ€ç´¢åœ°å›ç­”å‡ºæ¥ï¼šå®¹å™¨çš„æœ¬è´¨æ˜¯è¿›ç¨‹ã€‚æ²¡é”™ã€‚å®¹å™¨ï¼Œå°±æ˜¯æœªæ¥äº‘è®¡ç®—ç³»ç»Ÿä¸­çš„è¿›ç¨‹ï¼›å®¹å™¨é•œåƒå°±æ˜¯è¿™ä¸ªç³»ç»Ÿé‡Œçš„â€œ.exeâ€å®‰è£…åŒ…ã€‚é‚£ä¹ˆ Kubernetes å‘¢ï¼Ÿä½ åº”è¯¥ä¹Ÿèƒ½ç«‹åˆ»å›ç­”ä¸Šæ¥ï¼šKubernetes å°±æ˜¯æ“ä½œç³»ç»Ÿï¼\nç°åœ¨ï¼Œå°±è®©æˆ‘ä»¬ç™»å½•åˆ°ä¸€å° Linux æœºå™¨é‡Œï¼Œæ‰§è¡Œä¸€æ¡å¦‚ä¸‹æ‰€ç¤ºçš„å‘½ä»¤ï¼š\n$ pstree -g  è¿™æ¡å‘½ä»¤çš„ä½œç”¨ï¼Œæ˜¯å±•ç¤ºå½“å‰ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„æ ‘çŠ¶ç»“æ„ã€‚å®ƒçš„è¿”å›ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š\nsystemd(1)-+-accounts-daemon(1984)-+-{gdbus}(1984) | `-{gmain}(1984) |-acpid(2044) ... |-lxcfs(1936)-+-{lxcfs}(1936) | `-{lxcfs}(1936) |-mdadm(2135) |-ntpd(2358) |-polkitd(2128)-+-{gdbus}(2128) | `-{gmain}(2128) |-rsyslogd(1632)-+-{in:imklog}(1632) | |-{in:imuxsock) S 1(1632) | `-{rs:main Q:Reg}(1632) |-snapd(1942)-+-{snapd}(1942) | |-{snapd}(1942) | |-{snapd}(1942) | |-{snapd}(1942) | |-{snapd}(1942)  ä¸éš¾å‘ç°ï¼Œåœ¨ä¸€ä¸ªçœŸæ­£çš„æ“ä½œç³»ç»Ÿé‡Œï¼Œè¿›ç¨‹å¹¶ä¸æ˜¯â€œå­¤è‹¦ä¼¶ä»ƒâ€åœ°ç‹¬è‡ªè¿è¡Œçš„ï¼Œè€Œæ˜¯ä»¥è¿›ç¨‹ç»„çš„æ–¹å¼ï¼Œâ€œæœ‰åŸåˆ™åœ°â€ç»„ç»‡åœ¨ä¸€èµ·ã€‚æ¯”å¦‚ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå«ä½œ rsyslogd çš„ç¨‹åºï¼Œå®ƒè´Ÿè´£çš„æ˜¯ Linux æ“ä½œç³»ç»Ÿé‡Œçš„æ—¥å¿—å¤„ç†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œrsyslogd çš„ä¸»ç¨‹åº mainï¼Œå’Œå®ƒè¦ç”¨åˆ°çš„å†…æ ¸æ—¥å¿—æ¨¡å— imklog ç­‰ï¼ŒåŒå±äº 1632 è¿›ç¨‹ç»„ã€‚è¿™äº›è¿›ç¨‹ç›¸äº’åä½œï¼Œå…±åŒå®Œæˆ rsyslogd ç¨‹åºçš„èŒè´£ã€‚\n æ³¨æ„ï¼šæˆ‘åœ¨æœ¬ç¯‡ä¸­æåˆ°çš„â€œè¿›ç¨‹â€ï¼Œæ¯”å¦‚ï¼Œrsyslogd å¯¹åº”çš„ imklogï¼Œimuxsock å’Œ mainï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ï¼Œå…¶å®æ˜¯ Linux æ“ä½œç³»ç»Ÿè¯­å¢ƒä¸‹çš„â€œçº¿ç¨‹â€ã€‚è¿™äº›çº¿ç¨‹ï¼Œæˆ–è€…è¯´ï¼Œè½»é‡çº§è¿›ç¨‹ä¹‹é—´ï¼Œå¯ä»¥å…±äº«æ–‡ä»¶ã€ä¿¡å·ã€æ•°æ®å†…å­˜ã€ç”šè‡³éƒ¨åˆ†ä»£ç ï¼Œä»è€Œç´§å¯†åä½œå…±åŒå®Œæˆä¸€ä¸ªç¨‹åºçš„èŒè´£ã€‚æ‰€ä»¥åŒç†ï¼Œæˆ‘æåˆ°çš„â€œè¿›ç¨‹ç»„â€ï¼Œå¯¹åº”çš„ä¹Ÿæ˜¯ Linux æ“ä½œç³»ç»Ÿè¯­å¢ƒä¸‹çš„â€œçº¿ç¨‹ç»„â€ã€‚è¿™ç§å‘½åå…³ç³»ä¸å®é™…æƒ…å†µçš„ä¸ä¸€è‡´ï¼Œæ˜¯ Linux å‘å±•å†å²ä¸­çš„ä¸€ä¸ªé—ç•™é—®é¢˜ã€‚å¯¹è¿™ä¸ªè¯é¢˜æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡æŠ€æœ¯æ–‡ç« æ¥äº†è§£ä¸€ä¸‹ã€‚\n è€Œ Kubernetes é¡¹ç›®æ‰€åšçš„ï¼Œå…¶å®å°±æ˜¯å°†â€œè¿›ç¨‹ç»„â€çš„æ¦‚å¿µæ˜ å°„åˆ°äº†å®¹å™¨æŠ€æœ¯ä¸­ï¼Œå¹¶ä½¿å…¶æˆä¸ºäº†è¿™ä¸ªäº‘è®¡ç®—â€œæ“ä½œç³»ç»Ÿâ€é‡Œçš„â€œä¸€ç­‰å…¬æ°‘â€ã€‚\nKubernetes é¡¹ç›®ä¹‹æ‰€ä»¥è¦è¿™ä¹ˆåšçš„åŸå› ï¼Œæˆ‘åœ¨å‰é¢ä»‹ç» Kubernetes å’Œ Borg çš„å…³ç³»æ—¶æ›¾ç»æåˆ°è¿‡ï¼šåœ¨ Borg é¡¹ç›®çš„å¼€å‘å’Œå®è·µè¿‡ç¨‹ä¸­ï¼ŒGoogle å…¬å¸çš„å·¥ç¨‹å¸ˆä»¬å‘ç°ï¼Œä»–ä»¬éƒ¨ç½²çš„åº”ç”¨ï¼Œå¾€å¾€éƒ½å­˜åœ¨ç€ç±»ä¼¼äºâ€œè¿›ç¨‹å’Œè¿›ç¨‹ç»„â€çš„å…³ç³»ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œå°±æ˜¯è¿™äº›åº”ç”¨ä¹‹é—´æœ‰ç€å¯†åˆ‡çš„åä½œå…³ç³»ï¼Œä½¿å¾—å®ƒä»¬å¿…é¡»éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šã€‚\nè€Œå¦‚æœäº‹å…ˆæ²¡æœ‰â€œç»„â€çš„æ¦‚å¿µï¼Œåƒè¿™æ ·çš„è¿ç»´å…³ç³»å°±ä¼šéå¸¸éš¾ä»¥å¤„ç†ã€‚\næˆ‘è¿˜æ˜¯ä»¥å‰é¢çš„ rsyslogd ä¸ºä¾‹å­ã€‚å·²çŸ¥ rsyslogd ç”±ä¸‰ä¸ªè¿›ç¨‹ç»„æˆï¼šä¸€ä¸ª imklog æ¨¡å—ï¼Œä¸€ä¸ª imuxsock æ¨¡å—ï¼Œä¸€ä¸ª rsyslogd è‡ªå·±çš„ main å‡½æ•°ä¸»è¿›ç¨‹ã€‚è¿™ä¸‰ä¸ªè¿›ç¨‹ä¸€å®šè¦è¿è¡Œåœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå¦åˆ™ï¼Œå®ƒä»¬ä¹‹é—´åŸºäº Socket çš„é€šä¿¡å’Œæ–‡ä»¶äº¤æ¢ï¼Œéƒ½ä¼šå‡ºç°é—®é¢˜ã€‚\nç°åœ¨ï¼Œæˆ‘è¦æŠŠ rsyslogd è¿™ä¸ªåº”ç”¨ç»™å®¹å™¨åŒ–ï¼Œç”±äºå—é™äºå®¹å™¨çš„â€œå•è¿›ç¨‹æ¨¡å‹â€ï¼Œè¿™ä¸‰ä¸ªæ¨¡å—å¿…é¡»è¢«åˆ†åˆ«åˆ¶ä½œæˆä¸‰ä¸ªä¸åŒçš„å®¹å™¨ã€‚è€Œåœ¨è¿™ä¸‰ä¸ªå®¹å™¨è¿è¡Œçš„æ—¶å€™ï¼Œå®ƒä»¬è®¾ç½®çš„å†…å­˜é…é¢éƒ½æ˜¯ 1 GBã€‚\n å†æ¬¡å¼ºè°ƒä¸€ä¸‹ï¼š**å®¹å™¨çš„â€œå•è¿›ç¨‹æ¨¡å‹â€ï¼Œå¹¶ä¸æ˜¯æŒ‡å®¹å™¨é‡Œåªèƒ½è¿è¡Œâ€œä¸€ä¸ªâ€è¿›ç¨‹ï¼Œè€Œæ˜¯æŒ‡å®¹å™¨æ²¡æœ‰ç®¡ç†å¤šä¸ªè¿›ç¨‹çš„èƒ½åŠ›ã€‚**è¿™æ˜¯å› ä¸ºå®¹å™¨é‡Œ PID=1 çš„è¿›ç¨‹å°±æ˜¯åº”ç”¨æœ¬èº«ï¼Œå…¶ä»–çš„è¿›ç¨‹éƒ½æ˜¯è¿™ä¸ª PID=1 è¿›ç¨‹çš„å­è¿›ç¨‹ã€‚å¯æ˜¯ï¼Œç”¨æˆ·ç¼–å†™çš„åº”ç”¨ï¼Œå¹¶ä¸èƒ½å¤Ÿåƒæ­£å¸¸æ“ä½œç³»ç»Ÿé‡Œçš„ init è¿›ç¨‹æˆ–è€… systemd é‚£æ ·æ‹¥æœ‰è¿›ç¨‹ç®¡ç†çš„åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œä½ çš„åº”ç”¨æ˜¯ä¸€ä¸ª Java Web ç¨‹åºï¼ˆPID=1ï¼‰ï¼Œç„¶åä½ æ‰§è¡Œ docker exec åœ¨åå°å¯åŠ¨äº†ä¸€ä¸ª Nginx è¿›ç¨‹ï¼ˆPID=3ï¼‰ã€‚å¯æ˜¯ï¼Œå½“è¿™ä¸ª Nginx è¿›ç¨‹å¼‚å¸¸é€€å‡ºçš„æ—¶å€™ï¼Œä½ è¯¥æ€ä¹ˆçŸ¥é“å‘¢ï¼Ÿè¿™ä¸ªè¿›ç¨‹é€€å‡ºåçš„åƒåœ¾æ”¶é›†å·¥ä½œï¼Œåˆåº”è¯¥ç”±è°å»åšå‘¢ï¼Ÿ\nè¿™é‡Œå…¶å®æœ‰ä¸€äº›å¼€æºçš„è½¯ä»¶åšäº†è¿™äº›äº‹æƒ…ï¼Œä¾‹å¦‚å…·æœ‰ç®¡ç†å­è¿›ç¨‹èƒ½åŠ›çš„dumb-initï¼Œå…·æœ‰æœåŠ¡ç®¡ç†èƒ½åŠ›çš„ runitã€‚ä½¿ç”¨è¿™äº›å·¥å…·æˆ‘ä»¬ä¹Ÿèƒ½å®ç°ä¸€ä¸ªå®¹å™¨å†…è¿è¡Œå¤šä¸ªè¿›ç¨‹çš„èƒ½åŠ›ã€‚\n å‡è®¾æˆ‘ä»¬çš„ Kubernetes é›†ç¾¤ä¸Šæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼šnode-1 ä¸Šæœ‰ 3 GB å¯ç”¨å†…å­˜ï¼Œnode-2 æœ‰ 2.5 GB å¯ç”¨å†…å­˜ã€‚\nè¿™æ—¶ï¼Œå‡è®¾æˆ‘è¦ç”¨ Docker Swarm æ¥è¿è¡Œè¿™ä¸ª rsyslogd ç¨‹åºã€‚ä¸ºäº†èƒ½å¤Ÿè®©è¿™ä¸‰ä¸ªå®¹å™¨éƒ½è¿è¡Œåœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œæˆ‘å°±å¿…é¡»åœ¨å¦å¤–ä¸¤ä¸ªå®¹å™¨ä¸Šè®¾ç½®ä¸€ä¸ª affinity=mainï¼ˆä¸ main å®¹å™¨æœ‰äº²å¯†æ€§ï¼‰çš„çº¦æŸï¼Œå³ï¼šå®ƒä»¬ä¿©å¿…é¡»å’Œ main å®¹å™¨è¿è¡Œåœ¨åŒä¸€å°æœºå™¨ä¸Šã€‚\nç„¶åï¼Œæˆ‘é¡ºåºæ‰§è¡Œï¼šâ€œdocker run mainâ€â€œdocker run imklogâ€å’Œâ€œdocker run imuxsockâ€ï¼Œåˆ›å»ºè¿™ä¸‰ä¸ªå®¹å™¨ã€‚\nè¿™æ ·ï¼Œè¿™ä¸‰ä¸ªå®¹å™¨éƒ½ä¼šè¿›å…¥ Swarm çš„å¾…è°ƒåº¦é˜Ÿåˆ—ã€‚ç„¶åï¼Œmain å®¹å™¨å’Œ imklog å®¹å™¨éƒ½å…ˆåå‡ºé˜Ÿå¹¶è¢«è°ƒåº¦åˆ°äº† node-2 ä¸Šï¼ˆè¿™ä¸ªæƒ…å†µæ˜¯å®Œå…¨æœ‰å¯èƒ½çš„ï¼‰\nå¯æ˜¯ï¼Œå½“ imuxsock å®¹å™¨å‡ºé˜Ÿå¼€å§‹è¢«è°ƒåº¦æ—¶ï¼ŒSwarm å°±æœ‰ç‚¹æ‡µäº†ï¼šnode-2 ä¸Šçš„å¯ç”¨èµ„æºåªæœ‰ 0.5 GB äº†ï¼Œå¹¶ä¸è¶³ä»¥è¿è¡Œ imuxsock å®¹å™¨ï¼›å¯æ˜¯ï¼Œæ ¹æ® affinity=main çš„çº¦æŸï¼Œimuxsock å®¹å™¨åˆåªèƒ½è¿è¡Œåœ¨ node-2 ä¸Šã€‚\nè¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„æˆç»„è°ƒåº¦ï¼ˆgang schedulingï¼‰æ²¡æœ‰è¢«å¦¥å–„å¤„ç†çš„ä¾‹å­ã€‚\nåœ¨å·¥ä¸šç•Œå’Œå­¦æœ¯ç•Œï¼Œå…³äºè¿™ä¸ªé—®é¢˜çš„è®¨è®ºå¯è°“æ—·æ—¥æŒä¹…ï¼Œä¹Ÿäº§ç”Ÿäº†å¾ˆå¤šå¯ä¾›é€‰æ‹©çš„è§£å†³æ–¹æ¡ˆã€‚\næ¯”å¦‚ï¼ŒMesos ä¸­å°±æœ‰ä¸€ä¸ªèµ„æºå›¤ç§¯ï¼ˆresource hoardingï¼‰çš„æœºåˆ¶ï¼Œ*ä¼šåœ¨æ‰€æœ‰è®¾ç½®äº† Affinity çº¦æŸçš„ä»»åŠ¡éƒ½è¾¾åˆ°æ—¶ï¼Œæ‰å¼€å§‹å¯¹å®ƒä»¬ç»Ÿä¸€è¿›è¡Œè°ƒåº¦ã€‚*è€Œåœ¨ Google Omega è®ºæ–‡ä¸­ï¼Œåˆ™æå‡ºäº†ä½¿ç”¨ä¹è§‚è°ƒåº¦å¤„ç†å†²çªçš„æ–¹æ³•ï¼Œå³ï¼šå…ˆä¸ç®¡è¿™äº›å†²çªï¼Œè€Œæ˜¯é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„å›æ»šæœºåˆ¶åœ¨å‡ºç°äº†å†²çªä¹‹åè§£å†³é—®é¢˜ã€‚\nä½†æ˜¯ï¼Œåˆ°äº† Kubernetes é¡¹ç›®é‡Œï¼Œè¿™æ ·çš„é—®é¢˜å°±è¿åˆƒè€Œè§£äº†ï¼šPod æ˜¯ Kubernetes é‡Œçš„åŸå­è°ƒåº¦å•ä½ã€‚è¿™å°±æ„å‘³ç€ï¼ŒKubernetes é¡¹ç›®çš„è°ƒåº¦å™¨ï¼Œæ˜¯ç»Ÿä¸€æŒ‰ç…§ Pod è€Œéå®¹å™¨çš„èµ„æºéœ€æ±‚è¿›è¡Œè®¡ç®—çš„ã€‚\næ‰€ä»¥ï¼Œåƒ imklogã€imuxsock å’Œ main å‡½æ•°ä¸»è¿›ç¨‹è¿™æ ·çš„ä¸‰ä¸ªå®¹å™¨ï¼Œæ­£æ˜¯ä¸€ä¸ªå…¸å‹çš„ç”±ä¸‰ä¸ªå®¹å™¨ç»„æˆçš„ Podã€‚Kubernetes é¡¹ç›®åœ¨è°ƒåº¦æ—¶ï¼Œè‡ªç„¶å°±ä¼šå»é€‰æ‹©å¯ç”¨å†…å­˜ç­‰äº 3 GB çš„ node-1 èŠ‚ç‚¹è¿›è¡Œç»‘å®šï¼Œè€Œæ ¹æœ¬ä¸ä¼šè€ƒè™‘ node-2ã€‚\nåƒè¿™æ ·å®¹å™¨é—´çš„ç´§å¯†åä½œï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¸º**â€œè¶…äº²å¯†å…³ç³»â€**ã€‚è¿™äº›å…·æœ‰â€œè¶…äº²å¯†å…³ç³»â€å®¹å™¨çš„å…¸å‹ç‰¹å¾åŒ…æ‹¬ä½†ä¸é™äºï¼šäº’ç›¸ä¹‹é—´ä¼šå‘ç”Ÿç›´æ¥çš„æ–‡ä»¶äº¤æ¢ã€ä½¿ç”¨ localhost æˆ–è€… Socket æ–‡ä»¶è¿›è¡Œæœ¬åœ°é€šä¿¡ã€ä¼šå‘ç”Ÿéå¸¸é¢‘ç¹çš„è¿œç¨‹è°ƒç”¨ã€éœ€è¦å…±äº«æŸäº› Linux Namespaceï¼ˆæ¯”å¦‚ï¼Œä¸€ä¸ªå®¹å™¨è¦åŠ å…¥å¦ä¸€ä¸ªå®¹å™¨çš„ Network Namespaceï¼‰ç­‰ç­‰ã€‚\nè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æœ‰â€œå…³ç³»â€çš„å®¹å™¨éƒ½å±äºåŒä¸€ä¸ª Podã€‚æ¯”å¦‚ï¼ŒPHP åº”ç”¨å®¹å™¨å’Œ MySQL è™½ç„¶ä¼šå‘ç”Ÿè®¿é—®å…³ç³»ï¼Œä½†å¹¶æ²¡æœ‰å¿…è¦ã€ä¹Ÿä¸åº”è¯¥éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå®ƒä»¬æ›´é€‚åˆåšæˆä¸¤ä¸ª Podã€‚\nä¸è¿‡ï¼Œç›¸ä¿¡æ­¤æ—¶ä½ å¯èƒ½ä¼šæœ‰ç¬¬äºŒä¸ªç–‘é—®ï¼š\nå¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œä¸€èˆ¬éƒ½æ˜¯å…ˆå­¦ä¼šäº†ç”¨ Docker è¿™ç§å•å®¹å™¨çš„å·¥å…·ï¼Œæ‰ä¼šå¼€å§‹æ¥è§¦ Podã€‚\nè€Œå¦‚æœ Pod çš„è®¾è®¡åªæ˜¯å‡ºäºè°ƒåº¦ä¸Šçš„è€ƒè™‘ï¼Œé‚£ä¹ˆ Kubernetes é¡¹ç›®ä¼¼ä¹å®Œå…¨æ²¡æœ‰å¿…è¦éå¾—æŠŠ Pod ä½œä¸ºâ€œä¸€ç­‰å…¬æ°‘â€å§ï¼Ÿè¿™ä¸æ˜¯æ•…æ„å¢åŠ ç”¨æˆ·çš„å­¦ä¹ é—¨æ§›å—ï¼Ÿæ²¡é”™ï¼Œå¦‚æœåªæ˜¯å¤„ç†â€œè¶…äº²å¯†å…³ç³»â€è¿™æ ·çš„è°ƒåº¦é—®é¢˜ï¼Œæœ‰ Borg å’Œ Omega è®ºæ–‡ç ç‰åœ¨å‰ï¼ŒKubernetes é¡¹ç›®è‚¯å®šå¯ä»¥åœ¨è°ƒåº¦å™¨å±‚é¢ç»™å®ƒè§£å†³æ‰ã€‚\nä¸è¿‡ï¼ŒPod åœ¨ Kubernetes é¡¹ç›®é‡Œè¿˜æœ‰æ›´é‡è¦çš„æ„ä¹‰ï¼Œé‚£å°±æ˜¯ï¼šå®¹å™¨è®¾è®¡æ¨¡å¼ã€‚\nä¸ºäº†ç†è§£è¿™ä¸€å±‚å«ä¹‰ï¼Œæˆ‘å°±å¿…é¡»å…ˆç»™ä½ ä»‹ç»ä¸€ä¸‹Pod çš„å®ç°åŸç†ã€‚\né¦–å…ˆï¼Œå…³äº Pod æœ€é‡è¦çš„ä¸€ä¸ªäº‹å®æ˜¯ï¼šå®ƒåªæ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼ŒKubernetes çœŸæ­£å¤„ç†çš„ï¼Œè¿˜æ˜¯å®¿ä¸»æœºæ“ä½œç³»ç»Ÿä¸Š Linux å®¹å™¨çš„ Namespace å’Œ Cgroupsï¼Œè€Œå¹¶ä¸å­˜åœ¨ä¸€ä¸ªæ‰€è°“çš„ Pod çš„è¾¹ç•Œæˆ–è€…éš”ç¦»ç¯å¢ƒã€‚é‚£ä¹ˆï¼ŒPod åˆæ˜¯æ€ä¹ˆè¢«â€œåˆ›å»ºâ€å‡ºæ¥çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šPodï¼Œå…¶å®æ˜¯ä¸€ç»„å…±äº«äº†æŸäº›èµ„æºçš„å®¹å™¨ã€‚\nå…·ä½“çš„è¯´ï¼šPod é‡Œçš„æ‰€æœ‰å®¹å™¨ï¼Œå…±äº«çš„æ˜¯åŒä¸€ä¸ª Network Namespaceï¼Œå¹¶ä¸”å¯ä»¥å£°æ˜å…±äº«åŒä¸€ä¸ª Volumeã€‚\né‚£è¿™ä¹ˆæ¥çœ‹çš„è¯ï¼Œä¸€ä¸ªæœ‰ Aã€B ä¸¤ä¸ªå®¹å™¨çš„ Podï¼Œä¸å°±æ˜¯ç­‰åŒäºä¸€ä¸ªå®¹å™¨ï¼ˆå®¹å™¨ Aï¼‰å…±äº«å¦å¤–ä¸€ä¸ªå®¹å™¨ï¼ˆå®¹å™¨ Bï¼‰çš„ç½‘ç»œå’Œ Volume çš„ç©å„¿æ³•ä¹ˆï¼Ÿ\nè¿™å¥½åƒé€šè¿‡ docker run \u0026ndash;net \u0026ndash;volumes-from è¿™æ ·çš„å‘½ä»¤å°±èƒ½å®ç°å˜›ï¼Œæ¯”å¦‚ï¼š\n$ docker run --net=B --volumes-from=B --name=A image-A ...  ä½†æ˜¯ï¼Œä½ æœ‰æ²¡æœ‰è€ƒè™‘è¿‡ï¼Œå¦‚æœçœŸè¿™æ ·åšçš„è¯ï¼Œå®¹å™¨ B å°±å¿…é¡»æ¯”å®¹å™¨ A å…ˆå¯åŠ¨ï¼Œè¿™æ ·ä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨å°±ä¸æ˜¯å¯¹ç­‰å…³ç³»ï¼Œè€Œæ˜¯æ‹“æ‰‘å…³ç³»äº†ã€‚\næ‰€ä»¥ï¼Œåœ¨ Kubernetes é¡¹ç›®é‡Œï¼ŒPod çš„å®ç°éœ€è¦ä½¿ç”¨ä¸€ä¸ªä¸­é—´å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨å«ä½œ Infra å®¹å™¨ã€‚åœ¨è¿™ä¸ª Pod ä¸­ï¼ŒInfra å®¹å™¨æ°¸è¿œéƒ½æ˜¯ç¬¬ä¸€ä¸ªè¢«åˆ›å»ºçš„å®¹å™¨ï¼Œè€Œå…¶ä»–ç”¨æˆ·å®šä¹‰çš„å®¹å™¨ï¼Œåˆ™é€šè¿‡ Join Network Namespace çš„æ–¹å¼ï¼Œä¸ Infra å®¹å™¨å…³è”åœ¨ä¸€èµ·ã€‚è¿™æ ·çš„ç»„ç»‡å…³ç³»ï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™æ ·ä¸€ä¸ªç¤ºæ„å›¾æ¥è¡¨è¾¾ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™ä¸ª Pod é‡Œæœ‰ä¸¤ä¸ªç”¨æˆ·å®¹å™¨ A å’Œ Bï¼Œè¿˜æœ‰ä¸€ä¸ª Infra å®¹å™¨ã€‚å¾ˆå®¹æ˜“ç†è§£ï¼Œåœ¨ Kubernetes é¡¹ç›®é‡Œï¼ŒInfra å®¹å™¨ä¸€å®šè¦å ç”¨æå°‘çš„èµ„æºï¼Œæ‰€ä»¥å®ƒä½¿ç”¨çš„æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„é•œåƒï¼Œå«ä½œï¼šk8s.gcr.io/pauseã€‚è¿™ä¸ªé•œåƒæ˜¯ä¸€ä¸ªç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ã€æ°¸è¿œå¤„äºâ€œæš‚åœâ€çŠ¶æ€çš„å®¹å™¨ï¼Œè§£å‹åçš„å¤§å°ä¹Ÿåªæœ‰ 100~200 KB å·¦å³ã€‚\nè€Œåœ¨ Infra å®¹å™¨â€œHold ä½â€Network Namespace åï¼Œç”¨æˆ·å®¹å™¨å°±å¯ä»¥åŠ å…¥åˆ° Infra å®¹å™¨çš„ Network Namespace å½“ä¸­äº†ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æŸ¥çœ‹è¿™äº›å®¹å™¨åœ¨å®¿ä¸»æœºä¸Šçš„ Namespace æ–‡ä»¶ï¼ˆè¿™ä¸ª Namespace æ–‡ä»¶çš„è·¯å¾„ï¼Œæˆ‘å·²ç»åœ¨å‰é¢çš„å†…å®¹ä¸­ä»‹ç»è¿‡ï¼‰ï¼Œå®ƒä»¬æŒ‡å‘çš„å€¼ä¸€å®šæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚\nè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå¯¹äº Pod é‡Œçš„å®¹å™¨ A å’Œå®¹å™¨ B æ¥è¯´ï¼š\n å®ƒä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ localhost è¿›è¡Œé€šä¿¡ï¼› å®ƒä»¬çœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡è·Ÿ Infra å®¹å™¨çœ‹åˆ°çš„å®Œå…¨ä¸€æ ·ï¼› ä¸€ä¸ª Pod åªæœ‰ä¸€ä¸ª IP åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª Pod çš„ Network Namespace å¯¹åº”çš„ IP åœ°å€ï¼› å½“ç„¶ï¼Œå…¶ä»–çš„æ‰€æœ‰ç½‘ç»œèµ„æºï¼Œéƒ½æ˜¯ä¸€ä¸ª Pod ä¸€ä»½ï¼Œå¹¶ä¸”è¢«è¯¥ Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å…±äº«ï¼› Pod çš„ç”Ÿå‘½å‘¨æœŸåªè·Ÿ Infra å®¹å™¨ä¸€è‡´ï¼Œè€Œä¸å®¹å™¨ A å’Œ B æ— å…³ã€‚  è€Œå¯¹äºåŒä¸€ä¸ª Pod é‡Œé¢çš„æ‰€æœ‰ç”¨æˆ·å®¹å™¨æ¥è¯´ï¼Œå®ƒä»¬çš„è¿›å‡ºæµé‡ï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºéƒ½æ˜¯é€šè¿‡ Infra å®¹å™¨å®Œæˆçš„ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºå°†æ¥å¦‚æœä½ è¦ä¸º Kubernetes å¼€å‘ä¸€ä¸ªç½‘ç»œæ’ä»¶æ—¶ï¼Œåº”è¯¥é‡ç‚¹è€ƒè™‘çš„æ˜¯å¦‚ä½•é…ç½®è¿™ä¸ª Pod çš„ Network Namespaceï¼Œè€Œä¸æ˜¯æ¯ä¸€ä¸ªç”¨æˆ·å®¹å™¨å¦‚ä½•ä½¿ç”¨ä½ çš„ç½‘ç»œé…ç½®ï¼Œè¿™æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚\nè¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ çš„ç½‘ç»œæ’ä»¶éœ€è¦åœ¨å®¹å™¨é‡Œå®‰è£…æŸäº›åŒ…æˆ–è€…é…ç½®æ‰èƒ½å®Œæˆçš„è¯ï¼Œæ˜¯ä¸å¯å–çš„ï¼šInfra å®¹å™¨é•œåƒçš„ rootfs é‡Œå‡ ä¹ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œæ²¡æœ‰ä½ éšæ„å‘æŒ¥çš„ç©ºé—´ã€‚å½“ç„¶ï¼Œè¿™åŒæ—¶ä¹Ÿæ„å‘³ç€ä½ çš„ç½‘ç»œæ’ä»¶å®Œå…¨ä¸å¿…å…³å¿ƒç”¨æˆ·å®¹å™¨çš„å¯åŠ¨ä¸å¦ï¼Œè€Œåªéœ€è¦å…³æ³¨å¦‚ä½•é…ç½® Podï¼Œä¹Ÿå°±æ˜¯ Infra å®¹å™¨çš„ Network Namespace å³å¯ã€‚\næœ‰äº†è¿™ä¸ªè®¾è®¡ä¹‹åï¼Œå…±äº« Volume å°±ç®€å•å¤šäº†ï¼šKubernetes é¡¹ç›®åªè¦æŠŠæ‰€æœ‰ Volume çš„å®šä¹‰éƒ½è®¾è®¡åœ¨ Pod å±‚çº§å³å¯ã€‚\nè¿™æ ·ï¼Œä¸€ä¸ª Volume å¯¹åº”çš„å®¿ä¸»æœºç›®å½•å¯¹äº Pod æ¥è¯´å°±åªæœ‰ä¸€ä¸ªï¼ŒPod é‡Œçš„å®¹å™¨åªè¦å£°æ˜æŒ‚è½½è¿™ä¸ª Volumeï¼Œå°±ä¸€å®šå¯ä»¥å…±äº«è¿™ä¸ª Volume å¯¹åº”çš„å®¿ä¸»æœºç›®å½•ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\napiVersion: v1 kind: Pod metadata: name: two-containers spec: restartPolicy: Never volumes: - name: shared-data hostPath: path: /data containers: - name: nginx-container image: nginx volumeMounts: - name: shared-data mountPath: /usr/share/nginx/html - name: debian-container image: debian volumeMounts: - name: shared-data mountPath: /pod-data command: [\u0026quot;/bin/sh\u0026quot;] args: [\u0026quot;-c\u0026quot;, \u0026quot;echo Hello from the debian container \u0026gt; /pod-data/admin.html\u0026quot;]  åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œdebian-container å’Œ nginx-container éƒ½å£°æ˜æŒ‚è½½äº† shared-data è¿™ä¸ª Volumeã€‚è€Œ shared-data æ˜¯ hostPath ç±»å‹ã€‚æ‰€ä»¥ï¼Œå®ƒå¯¹åº”åœ¨å®¿ä¸»æœºä¸Šçš„ç›®å½•å°±æ˜¯ï¼š/dataã€‚è€Œè¿™ä¸ªç›®å½•ï¼Œå…¶å®å°±è¢«åŒæ—¶ç»‘å®šæŒ‚è½½è¿›äº†ä¸Šè¿°ä¸¤ä¸ªå®¹å™¨å½“ä¸­ã€‚\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼Œnginx-container å¯ä»¥ä»å®ƒçš„ /usr/share/nginx/html ç›®å½•ä¸­ï¼Œè¯»å–åˆ° debian-container ç”Ÿæˆçš„ index.html æ–‡ä»¶çš„åŸå› ã€‚\næ˜ç™½äº† Pod çš„å®ç°åŸç†åï¼Œæˆ‘ä»¬å†æ¥è®¨è®ºâ€œå®¹å™¨è®¾è®¡æ¨¡å¼â€ï¼Œå°±å®¹æ˜“å¤šäº†ã€‚\nPod è¿™ç§â€œè¶…äº²å¯†å…³ç³»â€å®¹å™¨çš„è®¾è®¡æ€æƒ³ï¼Œå®é™…ä¸Šå°±æ˜¯å¸Œæœ›ï¼Œå½“ç”¨æˆ·æƒ³åœ¨ä¸€ä¸ªå®¹å™¨é‡Œè·‘å¤šä¸ªåŠŸèƒ½å¹¶ä¸ç›¸å…³çš„åº”ç”¨æ—¶ï¼Œåº”è¯¥ä¼˜å…ˆè€ƒè™‘å®ƒä»¬æ˜¯ä¸æ˜¯æ›´åº”è¯¥è¢«æè¿°æˆä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨ã€‚ä¸ºäº†èƒ½å¤ŸæŒæ¡è¿™ç§æ€è€ƒæ–¹å¼ï¼Œä½ å°±åº”è¯¥å°½é‡å°è¯•ä½¿ç”¨å®ƒæ¥æè¿°ä¸€äº›ç”¨å•ä¸ªå®¹å™¨éš¾ä»¥è§£å†³çš„é—®é¢˜ã€‚\nç¬¬ä¸€ä¸ªæœ€å…¸å‹çš„ä¾‹å­æ˜¯ï¼šWAR åŒ…ä¸ Web æœåŠ¡å™¨ã€‚\næˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ª Java Web åº”ç”¨çš„ WAR åŒ…ï¼Œå®ƒéœ€è¦è¢«æ”¾åœ¨ Tomcat çš„ webapps ç›®å½•ä¸‹è¿è¡Œèµ·æ¥ã€‚\nå‡å¦‚ï¼Œä½ ç°åœ¨åªèƒ½ç”¨ Docker æ¥åšè¿™ä»¶äº‹æƒ…ï¼Œé‚£è¯¥å¦‚ä½•å¤„ç†è¿™ä¸ªç»„åˆå…³ç³»å‘¢ï¼Ÿ\n ä¸€ç§æ–¹æ³•æ˜¯ï¼ŒæŠŠ WAR åŒ…ç›´æ¥æ”¾åœ¨ Tomcat é•œåƒçš„ webapps ç›®å½•ä¸‹ï¼Œåšæˆä¸€ä¸ªæ–°çš„é•œåƒè¿è¡Œèµ·æ¥ã€‚å¯æ˜¯ï¼Œè¿™æ—¶å€™ï¼Œå¦‚æœä½ è¦æ›´æ–° WAR åŒ…çš„å†…å®¹ï¼Œæˆ–è€…è¦å‡çº§ Tomcat é•œåƒï¼Œå°±è¦é‡æ–°åˆ¶ä½œä¸€ä¸ªæ–°çš„å‘å¸ƒé•œåƒï¼Œéå¸¸éº»çƒ¦ã€‚ å¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œä½ å‹æ ¹å„¿ä¸ç®¡ WAR åŒ…ï¼Œæ°¸è¿œåªå‘å¸ƒä¸€ä¸ª Tomcat å®¹å™¨ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªå®¹å™¨çš„ webapps ç›®å½•ï¼Œå°±å¿…é¡»å£°æ˜ä¸€ä¸ª hostPath ç±»å‹çš„ Volumeï¼Œä»è€ŒæŠŠå®¿ä¸»æœºä¸Šçš„ WAR åŒ…æŒ‚è½½è¿› Tomcat å®¹å™¨å½“ä¸­è¿è¡Œèµ·æ¥ã€‚ä¸è¿‡ï¼Œè¿™æ ·ä½ å°±å¿…é¡»è¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œå³ï¼šå¦‚ä½•è®©æ¯ä¸€å°å®¿ä¸»æœºï¼Œéƒ½é¢„å…ˆå‡†å¤‡å¥½è¿™ä¸ªå­˜å‚¨æœ‰ WAR åŒ…çš„ç›®å½•å‘¢ï¼Ÿè¿™æ ·æ¥çœ‹ï¼Œä½ åªèƒ½ç‹¬ç«‹ç»´æŠ¤ä¸€å¥—åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿäº†ã€‚  å®é™…ä¸Šï¼Œæœ‰äº† Pod ä¹‹åï¼Œè¿™æ ·çš„é—®é¢˜å°±å¾ˆå®¹æ˜“è§£å†³äº†ã€‚æˆ‘ä»¬å¯ä»¥æŠŠ WAR åŒ…å’Œ Tomcat åˆ†åˆ«åšæˆé•œåƒï¼Œç„¶åæŠŠå®ƒä»¬ä½œä¸ºä¸€ä¸ª Pod é‡Œçš„ä¸¤ä¸ªå®¹å™¨â€œç»„åˆâ€åœ¨ä¸€èµ·ã€‚è¿™ä¸ª Pod çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: v1 kind: Pod metadata: name: javaweb-2 spec: initContainers: - image: geektime/sample:v2 name: war command: [\u0026quot;cp\u0026quot;, \u0026quot;/sample.war\u0026quot;, \u0026quot;/app\u0026quot;] volumeMounts: - mountPath: /app name: app-volume containers: - image: geektime/tomcat:7.0 name: tomcat command: [\u0026quot;sh\u0026quot;,\u0026quot;-c\u0026quot;,\u0026quot;/root/apache-tomcat-7.0.42-v2/bin/start.sh\u0026quot;] volumeMounts: - mountPath: /root/apache-tomcat-7.0.42-v2/webapps name: app-volume ports: - containerPort: 8080 hostPort: 8001 volumes: - name: app-volume emptyDir: {}  åœ¨è¿™ä¸ª Pod ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå®¹å™¨ï¼Œç¬¬ä¸€ä¸ªå®¹å™¨ä½¿ç”¨çš„é•œåƒæ˜¯ geektime/sample:v2ï¼Œè¿™ä¸ªé•œåƒé‡Œåªæœ‰ä¸€ä¸ª WAR åŒ…ï¼ˆsample.warï¼‰æ”¾åœ¨æ ¹ç›®å½•ä¸‹ã€‚è€Œç¬¬äºŒä¸ªå®¹å™¨åˆ™ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Tomcat é•œåƒã€‚\nä¸è¿‡ï¼Œä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼ŒWAR åŒ…å®¹å™¨çš„ç±»å‹ä¸å†æ˜¯ä¸€ä¸ªæ™®é€šå®¹å™¨ï¼Œè€Œæ˜¯ä¸€ä¸ª Init Container ç±»å‹çš„å®¹å™¨ã€‚\nåœ¨ Pod ä¸­ï¼Œæ‰€æœ‰ Init Container å®šä¹‰çš„å®¹å™¨ï¼Œéƒ½ä¼šæ¯” spec.containers å®šä¹‰çš„ç”¨æˆ·å®¹å™¨å…ˆå¯åŠ¨ã€‚å¹¶ä¸”ï¼ŒInit Container å®¹å™¨ä¼šæŒ‰é¡ºåºé€ä¸€å¯åŠ¨ï¼Œè€Œç›´åˆ°å®ƒä»¬éƒ½å¯åŠ¨å¹¶ä¸”é€€å‡ºäº†ï¼Œç”¨æˆ·å®¹å™¨æ‰ä¼šå¯åŠ¨ã€‚\næ‰€ä»¥ï¼Œè¿™ä¸ª Init Container ç±»å‹çš„ WAR åŒ…å®¹å™¨å¯åŠ¨åï¼Œæˆ‘æ‰§è¡Œäº†ä¸€å¥\u0026quot;cp /sample.war /app\u0026quot;ï¼ŒæŠŠåº”ç”¨çš„ WAR åŒ…æ‹·è´åˆ° /app ç›®å½•ä¸‹ï¼Œç„¶åé€€å‡ºã€‚è€Œåè¿™ä¸ª /app ç›®å½•ï¼Œå°±æŒ‚è½½äº†ä¸€ä¸ªåå« app-volume çš„ Volumeã€‚æ¥ä¸‹æ¥å°±å¾ˆå…³é”®äº†ã€‚Tomcat å®¹å™¨ï¼ŒåŒæ ·å£°æ˜äº†æŒ‚è½½ app-volume åˆ°è‡ªå·±çš„ webapps ç›®å½•ä¸‹ã€‚æ‰€ä»¥ï¼Œç­‰ Tomcat å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒçš„ webapps ç›®å½•ä¸‹å°±ä¸€å®šä¼šå­˜åœ¨ sample.war æ–‡ä»¶ï¼šè¿™ä¸ªæ–‡ä»¶æ­£æ˜¯ WAR åŒ…å®¹å™¨å¯åŠ¨æ—¶æ‹·è´åˆ°è¿™ä¸ª Volume é‡Œé¢çš„ï¼Œè€Œè¿™ä¸ª Volume æ˜¯è¢«è¿™ä¸¤ä¸ªå®¹å™¨å…±äº«çš„ã€‚\nåƒè¿™æ ·ï¼Œæˆ‘ä»¬å°±ç”¨ä¸€ç§â€œç»„åˆâ€æ–¹å¼ï¼Œè§£å†³äº† WAR åŒ…ä¸ Tomcat å®¹å™¨ä¹‹é—´è€¦åˆå…³ç³»çš„é—®é¢˜ã€‚\nå®é™…ä¸Šï¼Œè¿™ä¸ªæ‰€è°“çš„â€œç»„åˆâ€æ“ä½œï¼Œæ­£æ˜¯å®¹å™¨è®¾è®¡æ¨¡å¼é‡Œæœ€å¸¸ç”¨çš„ä¸€ç§æ¨¡å¼ï¼Œå®ƒçš„åå­—å«ï¼šsidecarã€‚\né¡¾åæ€ä¹‰ï¼Œsidecar æŒ‡çš„å°±æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ª Pod ä¸­ï¼Œå¯åŠ¨ä¸€ä¸ªè¾…åŠ©å®¹å™¨ï¼Œæ¥å®Œæˆä¸€äº›ç‹¬ç«‹äºä¸»è¿›ç¨‹ï¼ˆä¸»å®¹å™¨ï¼‰ä¹‹å¤–çš„å·¥ä½œã€‚\næ¯”å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„è¿™ä¸ªåº”ç”¨ Pod ä¸­ï¼ŒTomcat å®¹å™¨æ˜¯æˆ‘ä»¬è¦ä½¿ç”¨çš„ä¸»å®¹å™¨ï¼Œè€Œ WAR åŒ…å®¹å™¨çš„å­˜åœ¨ï¼Œåªæ˜¯ä¸ºäº†ç»™å®ƒæä¾›ä¸€ä¸ª WAR åŒ…è€Œå·²ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ç”¨ Init Container çš„æ–¹å¼ä¼˜å…ˆè¿è¡Œ WAR åŒ…å®¹å™¨ï¼Œæ‰®æ¼”äº†ä¸€ä¸ª sidecar çš„è§’è‰²ã€‚\nç¬¬äºŒä¸ªä¾‹å­ï¼Œåˆ™æ˜¯å®¹å™¨çš„æ—¥å¿—æ”¶é›†ã€‚\næ¯”å¦‚ï¼Œæˆ‘ç°åœ¨æœ‰ä¸€ä¸ªåº”ç”¨ï¼Œéœ€è¦ä¸æ–­åœ°æŠŠæ—¥å¿—æ–‡ä»¶è¾“å‡ºåˆ°å®¹å™¨çš„ /var/log ç›®å½•ä¸­ã€‚\nè¿™æ—¶ï¼Œæˆ‘å°±å¯ä»¥æŠŠä¸€ä¸ª Pod é‡Œçš„ Volume æŒ‚è½½åˆ°åº”ç”¨å®¹å™¨çš„ /var/log ç›®å½•ä¸Šã€‚ç„¶åï¼Œæˆ‘åœ¨è¿™ä¸ª Pod é‡ŒåŒæ—¶è¿è¡Œä¸€ä¸ª sidecar å®¹å™¨ï¼Œå®ƒä¹Ÿå£°æ˜æŒ‚è½½åŒä¸€ä¸ª Volume åˆ°è‡ªå·±çš„ /var/log ç›®å½•ä¸Šã€‚è¿™æ ·ï¼Œæ¥ä¸‹æ¥ sidecar å®¹å™¨å°±åªéœ€è¦åšä¸€ä»¶äº‹å„¿ï¼Œé‚£å°±æ˜¯ä¸æ–­åœ°ä»è‡ªå·±çš„ /var/log ç›®å½•é‡Œè¯»å–æ—¥å¿—æ–‡ä»¶ï¼Œè½¬å‘åˆ° MongoDB æˆ–è€… Elasticsearch ä¸­å­˜å‚¨èµ·æ¥ã€‚è¿™æ ·ï¼Œä¸€ä¸ªæœ€åŸºæœ¬çš„æ—¥å¿—æ”¶é›†å·¥ä½œå°±å®Œæˆäº†ã€‚è·Ÿç¬¬ä¸€ä¸ªä¾‹å­ä¸€æ ·ï¼Œè¿™ä¸ªä¾‹å­ä¸­çš„ sidecar çš„ä¸»è¦å·¥ä½œä¹Ÿæ˜¯ä½¿ç”¨å…±äº«çš„ Volume æ¥å®Œæˆå¯¹æ–‡ä»¶çš„æ“ä½œã€‚\nä½†ä¸è¦å¿˜è®°ï¼ŒPod çš„å¦ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯ï¼Œå®ƒçš„æ‰€æœ‰å®¹å™¨éƒ½å…±äº«åŒä¸€ä¸ª Network Namespaceã€‚è¿™å°±ä½¿å¾—å¾ˆå¤šä¸ Pod ç½‘ç»œç›¸å…³çš„é…ç½®å’Œç®¡ç†ï¼Œä¹Ÿéƒ½å¯ä»¥äº¤ç»™ sidecar å®Œæˆï¼Œè€Œå®Œå…¨æ— é¡»å¹²æ¶‰ç”¨æˆ·å®¹å™¨ã€‚è¿™é‡Œæœ€å…¸å‹çš„ä¾‹å­è«è¿‡äº Istio è¿™ä¸ªå¾®æœåŠ¡æ²»ç†é¡¹ç›®äº†ã€‚\næ€»ç»“\nåœ¨æœ¬ç¯‡æ–‡ç« ä¸­æˆ‘é‡ç‚¹åˆ†äº«äº† Kubernetes é¡¹ç›®ä¸­ Pod çš„å®ç°åŸç†ã€‚\nPod æ˜¯ Kubernetes é¡¹ç›®ä¸å…¶ä»–å•å®¹å™¨é¡¹ç›®ç›¸æ¯”æœ€å¤§çš„ä¸åŒï¼Œä¹Ÿæ˜¯ä¸€ä½å®¹å™¨æŠ€æœ¯åˆå­¦è€…éœ€è¦é¢å¯¹çš„ç¬¬ä¸€ä¸ªä¸å¸¸è§„è®¤çŸ¥ä¸ä¸€è‡´çš„çŸ¥è¯†ç‚¹ã€‚äº‹å®ä¸Šï¼Œç›´åˆ°ç°åœ¨ï¼Œä»æœ‰å¾ˆå¤šäººæŠŠå®¹å™¨è·Ÿè™šæ‹Ÿæœºç›¸æå¹¶è®ºï¼Œä»–ä»¬æŠŠå®¹å™¨å½“åšæ€§èƒ½æ›´å¥½çš„è™šæ‹Ÿæœºï¼Œå–œæ¬¢è®¨è®ºå¦‚ä½•æŠŠåº”ç”¨ä»è™šæ‹Ÿæœºæ— ç¼åœ°è¿ç§»åˆ°å®¹å™¨ä¸­ã€‚ä½†å®é™…ä¸Šï¼Œæ— è®ºæ˜¯ä»å…·ä½“çš„å®ç°åŸç†ï¼Œè¿˜æ˜¯ä»ä½¿ç”¨æ–¹æ³•ã€ç‰¹æ€§ã€åŠŸèƒ½ç­‰æ–¹é¢ï¼Œå®¹å™¨ä¸è™šæ‹Ÿæœºå‡ ä¹æ²¡æœ‰ä»»ä½•ç›¸ä¼¼çš„åœ°æ–¹ï¼›ä¹Ÿä¸å­˜åœ¨ä¸€ç§æ™®éçš„æ–¹æ³•ï¼Œèƒ½å¤ŸæŠŠè™šæ‹Ÿæœºé‡Œçš„åº”ç”¨æ— ç¼è¿ç§»åˆ°å®¹å™¨ä¸­ã€‚å› ä¸ºï¼Œå®¹å™¨çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œå¿…ç„¶ä¼´éšç€ç›¸åº”ç¼ºé™·ï¼Œå³ï¼šå®ƒä¸èƒ½åƒè™šæ‹Ÿæœºé‚£æ ·ï¼Œå®Œå…¨æ¨¡æ‹Ÿæœ¬åœ°ç‰©ç†æœºç¯å¢ƒä¸­çš„éƒ¨ç½²æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªâ€œä¸Šäº‘â€å·¥ä½œçš„å®Œæˆï¼Œæœ€ç»ˆè¿˜æ˜¯è¦é æ·±å…¥ç†è§£å®¹å™¨çš„æœ¬è´¨ï¼Œå³ï¼šè¿›ç¨‹ã€‚\nå®é™…ä¸Šï¼Œä¸€ä¸ªè¿è¡Œåœ¨è™šæ‹Ÿæœºé‡Œçš„åº”ç”¨ï¼Œå“ªæ€•å†ç®€å•ï¼Œä¹Ÿæ˜¯è¢«ç®¡ç†åœ¨ systemd æˆ–è€… supervisord ä¹‹ä¸‹çš„ä¸€ç»„è¿›ç¨‹ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚è¿™è·Ÿæœ¬åœ°ç‰©ç†æœºä¸Šåº”ç”¨çš„è¿è¡Œæ–¹å¼å…¶å®æ˜¯ä¸€æ ·çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œä»ç‰©ç†æœºåˆ°è™šæ‹Ÿæœºä¹‹é—´çš„åº”ç”¨è¿ç§»ï¼Œå¾€å¾€å¹¶ä¸å›°éš¾ã€‚\nå¯æ˜¯å¯¹äºå®¹å™¨æ¥è¯´ï¼Œä¸€ä¸ªå®¹å™¨æ°¸è¿œåªèƒ½ç®¡ç†ä¸€ä¸ªè¿›ç¨‹ã€‚æ›´ç¡®åˆ‡åœ°è¯´ï¼Œä¸€ä¸ªå®¹å™¨ï¼Œå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚è¿™æ˜¯å®¹å™¨æŠ€æœ¯çš„â€œå¤©æ€§â€ï¼Œä¸å¯èƒ½è¢«ä¿®æ”¹ã€‚æ‰€ä»¥ï¼Œå°†ä¸€ä¸ªåŸæœ¬è¿è¡Œåœ¨è™šæ‹Ÿæœºé‡Œçš„åº”ç”¨ï¼Œâ€œæ— ç¼è¿ç§»â€åˆ°å®¹å™¨ä¸­çš„æƒ³æ³•ï¼Œå®é™…ä¸Šè·Ÿå®¹å™¨çš„æœ¬è´¨æ˜¯ç›¸æ‚–çš„ã€‚\nè¿™ä¹Ÿæ˜¯å½“åˆ Swarm é¡¹ç›®æ— æ³•æˆé•¿èµ·æ¥çš„é‡è¦åŸå› ä¹‹ä¸€ï¼šä¸€æ—¦åˆ°äº†çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒä¸Šï¼ŒSwarm è¿™ç§å•å®¹å™¨çš„å·¥ä½œæ–¹å¼ï¼Œå°±éš¾ä»¥æè¿°çœŸå®ä¸–ç•Œé‡Œå¤æ‚çš„åº”ç”¨æ¶æ„äº†ã€‚\næ‰€ä»¥ï¼Œä½ ç°åœ¨å¯ä»¥è¿™ä¹ˆç†è§£ Pod çš„æœ¬è´¨ï¼š\n Podï¼Œå®é™…ä¸Šæ˜¯åœ¨æ‰®æ¼”ä¼ ç»ŸåŸºç¡€è®¾æ–½é‡Œâ€œè™šæ‹Ÿæœºâ€çš„è§’è‰²ï¼›è€Œå®¹å™¨ï¼Œåˆ™æ˜¯è¿™ä¸ªè™šæ‹Ÿæœºé‡Œè¿è¡Œçš„ç”¨æˆ·ç¨‹åºã€‚\n æ‰€ä»¥ä¸‹ä¸€æ¬¡ï¼Œå½“ä½ éœ€è¦æŠŠä¸€ä¸ªè¿è¡Œåœ¨è™šæ‹Ÿæœºé‡Œçš„åº”ç”¨è¿ç§»åˆ° Docker å®¹å™¨ä¸­æ—¶ï¼Œä¸€å®šè¦ä»”ç»†åˆ†æåˆ°åº•æœ‰å“ªäº›è¿›ç¨‹ï¼ˆç»„ä»¶ï¼‰è¿è¡Œåœ¨è¿™ä¸ªè™šæ‹Ÿæœºé‡Œã€‚\nç„¶åï¼Œä½ å°±å¯ä»¥æŠŠæ•´ä¸ªè™šæ‹Ÿæœºæƒ³è±¡æˆä¸ºä¸€ä¸ª Podï¼ŒæŠŠè¿™äº›è¿›ç¨‹åˆ†åˆ«åšæˆå®¹å™¨é•œåƒï¼ŒæŠŠæœ‰é¡ºåºå…³ç³»çš„å®¹å™¨ï¼Œå®šä¹‰ä¸º Init Containerã€‚è¿™æ‰æ˜¯æ›´åŠ åˆç†çš„ã€æ¾è€¦åˆçš„å®¹å™¨ç¼–æ’è¯€çªï¼Œä¹Ÿæ˜¯ä»ä¼ ç»Ÿåº”ç”¨æ¶æ„ï¼Œåˆ°â€œå¾®æœåŠ¡æ¶æ„â€æœ€è‡ªç„¶çš„è¿‡æ¸¡æ–¹å¼ã€‚\n æ³¨æ„ï¼šPod è¿™ä¸ªæ¦‚å¿µï¼Œæä¾›çš„æ˜¯ä¸€ç§ç¼–æ’æ€æƒ³ï¼Œè€Œä¸æ˜¯å…·ä½“çš„æŠ€æœ¯æ–¹æ¡ˆã€‚æ‰€ä»¥ï¼Œå¦‚æœæ„¿æ„çš„è¯ï¼Œä½ å®Œå…¨å¯ä»¥ä½¿ç”¨è™šæ‹Ÿæœºæ¥ä½œä¸º Pod çš„å®ç°ï¼Œç„¶åæŠŠç”¨æˆ·å®¹å™¨éƒ½è¿è¡Œåœ¨è¿™ä¸ªè™šæ‹Ÿæœºé‡Œã€‚æ¯”å¦‚ï¼ŒMirantis å…¬å¸çš„virtlet é¡¹ç›®å°±åœ¨å¹²è¿™ä¸ªäº‹æƒ…ã€‚ç”šè‡³ï¼Œä½ å¯ä»¥å»å®ç°ä¸€ä¸ªå¸¦æœ‰ Init è¿›ç¨‹çš„å®¹å™¨é¡¹ç›®ï¼Œæ¥æ¨¡æ‹Ÿä¼ ç»Ÿåº”ç”¨çš„è¿è¡Œæ–¹å¼ã€‚è¿™äº›å·¥ä½œï¼Œåœ¨ Kubernetes ä¸­éƒ½æ˜¯éå¸¸è½»æ¾çš„ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬åé¢è®²è§£ CRI æ—¶ä¼šæåˆ°çš„å†…å®¹ã€‚\n ç›¸åçš„ï¼Œå¦‚æœå¼ºè¡ŒæŠŠæ•´ä¸ªåº”ç”¨å¡åˆ°ä¸€ä¸ªå®¹å™¨é‡Œï¼Œç”šè‡³ä¸æƒœä½¿ç”¨ Docker In Docker è¿™ç§åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åæ‚£æ— ç©·çš„è§£å†³æ–¹æ¡ˆï¼Œææ€•æœ€åå¾€å¾€ä¼šå¾—ä¸å¿å¤±ã€‚\nè¡¥å……å†…å®¹\n1ã€ç»‘å®šæŒ‚è½½ï¼ˆbind mountï¼‰\n å…è®¸ç”¨æˆ·å°†ä¸€ä¸ªç›®å½•æˆ–è€…æ–‡ä»¶ï¼ŒæŒ‚è½½åˆ°ä¸€ä¸ªæŒ‡å®šçš„ç›®å½•ä¸Šï¼Œå¹¶ä¸”ï¼Œä¹‹ååœ¨è¿™ä¸ªæŒ‚è½½ç‚¹ä¸Šçš„æ“ä½œï¼Œåªå‘ç”Ÿåœ¨è¢«æŒ‚è½½çš„ç›®å½•æˆ–è€…æ–‡ä»¶ä¸Šï¼Œè€ŒåŸæ¥æŒ‚è½½ç‚¹çš„å†…å®¹ä¼šè¢«éšè—èµ·æ¥ä¸å—å½±å“ã€‚\n å®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯ï¼Œå…è®¸ä½ å°†ä¸€ä¸ªç›®å½•æˆ–è€…æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ•´ä¸ªè®¾å¤‡ï¼ŒæŒ‚è½½åˆ°ä¸€ä¸ªæŒ‡å®šçš„ç›®å½•ä¸Šã€‚å¹¶ä¸”ï¼Œè¿™æ—¶ä½ åœ¨è¯¥æŒ‚è½½ç‚¹ä¸Šè¿›è¡Œçš„ä»»ä½•æ“ä½œï¼Œåªæ˜¯å‘ç”Ÿåœ¨è¢«æŒ‚è½½çš„ç›®å½•æˆ–è€…æ–‡ä»¶ä¸Šï¼Œè€ŒåŸæŒ‚è½½ç‚¹çš„å†…å®¹åˆ™ä¼šè¢«éšè—èµ·æ¥ä¸”ä¸å—å½±å“ã€‚\nç»‘å®šæŒ‚è½½å…¶å®æ˜¯ä¸€ä¸ªinodeæ›¿æ¢çš„è¿‡ç¨‹ï¼Œåœ¨Linuxæ“ä½œç³»ç»Ÿä¸­ï¼Œinodeå¯ä»¥ç†è§£ä¸ºå­˜æ”¾æ–‡ä»¶å†…å®¹çš„å¯¹è±¡ï¼Œè€Œdentryï¼Œä¹Ÿå«ç›®å½•é¡¹ï¼Œå°±æ˜¯è®¿é—®è¿™ä¸ªinodeæ‰€ä½¿ç”¨çš„â€œæŒ‡é’ˆâ€ã€‚ åœ¨ä¸‹å›¾ä¸­ï¼Œmount \u0026ndash;bind /home /test ï¼Œä¼šæŠŠ/homeæŒ‚è½½åˆ°/testä¸Šï¼Œå®é™…ä¸Šç›¸å½“äºå§/testçš„/dentryï¼ŒæŒ‡å‘ä¿®æ”¹ä¸º/homeçš„inodeï¼Œè¿™æ ·ä¿®æ”¹/testï¼Œå®é™…ä¸Šä¿®æ”¹çš„æ˜¯/homeå¯¹åº”çš„inodeã€‚\næ­£å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œmount \u0026ndash;bind /home /testï¼Œä¼šå°† /home æŒ‚è½½åˆ° /test ä¸Šã€‚å…¶å®ç›¸å½“äºå°† /test çš„ dentryï¼Œé‡å®šå‘åˆ°äº† /home çš„ inodeã€‚è¿™æ ·å½“æˆ‘ä»¬ä¿®æ”¹ /test ç›®å½•æ—¶ï¼Œå®é™…ä¿®æ”¹çš„æ˜¯ /home ç›®å½•çš„ inodeã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä½•ï¼Œä¸€æ—¦æ‰§è¡Œ umount å‘½ä»¤ï¼Œ/test ç›®å½•åŸå…ˆçš„å†…å®¹å°±ä¼šæ¢å¤ï¼šå› ä¸ºä¿®æ”¹çœŸæ­£å‘ç”Ÿåœ¨çš„ï¼Œæ˜¯ /home ç›®å½•é‡Œã€‚\næ‰€ä»¥ï¼Œåœ¨ä¸€ä¸ªæ­£ç¡®çš„æ—¶æœºï¼Œè¿›è¡Œä¸€æ¬¡ç»‘å®šæŒ‚è½½ï¼ŒDocker å°±å¯ä»¥æˆåŠŸåœ°å°†ä¸€ä¸ªå®¿ä¸»æœºä¸Šçš„ç›®å½•æˆ–æ–‡ä»¶ï¼Œä¸åŠ¨å£°è‰²åœ°æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚\nè¿™æ ·ï¼Œè¿›ç¨‹åœ¨å®¹å™¨é‡Œå¯¹è¿™ä¸ª /test ç›®å½•è¿›è¡Œçš„æ‰€æœ‰æ“ä½œï¼Œéƒ½å®é™…å‘ç”Ÿåœ¨å®¿ä¸»æœºçš„å¯¹åº”ç›®å½•ï¼ˆæ¯”å¦‚ï¼Œ/homeï¼Œæˆ–è€… /var/lib/docker/volumes/[VOLUME_ID]/_dataï¼‰é‡Œï¼Œè€Œä¸ä¼šå½±å“å®¹å™¨é•œåƒçš„å†…å®¹ã€‚\nå‚è€ƒè¿™ç¯‡æ–‡ç« docker ä¹‹æŒ‚è½½\n2ã€Pause container\nalmighty-pause-container\n","date":"2021å¹´02æœˆ26æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter3/why-pod/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡è½¬è‡ªå¼ ç£Šè€å¸ˆçš„ã€Šæ·±å…¥å‰–æKubernetesã€‹è¯¾ç¨‹ï¼Œç¬¬13è¯¾æ—¶ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ Pod?\u003c/p\u003e\n\u003c/blockquote\u003e","title":"ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦Pod"},{"contents":"1. yaml æ–‡ä»¶ 1.1 åˆ›å»º $ kubectl create -f æˆ‘çš„é…ç½®æ–‡ä»¶  1.2 ä¿®æ”¹ æ›´æ–° yaml æ–‡ä»¶ï¼š\n$ kubectl replace -f nginx-deployment.yaml  å£°æ˜å¼çš„è¡¨è¾¾æ–¹å¼ï¼Œä½¿ç”¨ apply å‘½ä»¤ï¼š\n$ kubectl apply -f nginx-deployment.yaml  2. Pod 2.1 æŸ¥è¯¢ è·å– pod çš„ä¿¡æ¯\nkubectl get pods -n ${namespace}  **æ ¹æ® pod çš„æ ‡ç­¾è¿‡æ»¤ **\nkubectl get pods -l app=nginx  æ³¨æ„çš„æ˜¯ï¼Œåœ¨å‘½ä»¤è¡Œä¸­ï¼Œæ‰€æœ‰ key-value æ ¼å¼çš„å‚æ•°ï¼Œéƒ½ä½¿ç”¨â€œ=â€è€Œéâ€œ:â€è¡¨ç¤ºã€‚\nè·å– pod çš„æè¿°ä¿¡æ¯\n$ kubectl describe pod \u0026lt;pod-name\u0026gt;  2.2 ç™»å½• è¿›å…¥åˆ° Pod ä¸­ï¼š\n$ kubectl exec -it nginx-deployment-5c678cfb6d-lg9lw -- /bin/bash  2.3 åˆ é™¤ åˆ é™¤ Podï¼š\n$ kubectl delete -f nginx-deployment.yaml  2.4. æ›´æ–° é€šè¿‡ä¿®æ”¹yamlæ–‡ä»¶æ›´æ–°pod\n... spec: containers: - name: nginx image: nginx:1.8 #è¿™é‡Œè¢«ä»1.7.9ä¿®æ”¹ä¸º1.8 ports: - containerPort: 80  æ‰§è¡Œ kubectl replace å‘½ä»¤\n$ kubectl replace -f nginx-deployment.yaml  è¿™é‡Œæ›´æ¨èç”¨ kubectl apply å‘½ä»¤ï¼Œæ¥ç»Ÿä¸€è¿›è¡Œ Kubernetes å¯¹è±¡çš„åˆ›å»ºå’Œæ›´æ–°æ“ä½œ\n# ä¿®æ”¹nginx-deployment.yamlçš„å†…å®¹ $ kubectl apply -f nginx-deployment.yaml  2.5 åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„Pod $ kubectl run -i --tty --image busybox:1.28.4 dns-test --restart=Never --rm /bin/sh  é€šè¿‡è¿™æ¡å‘½ä»¤ï¼Œæˆ‘ä»¬å¯åŠ¨äº†ä¸€ä¸ªä¸€æ¬¡æ€§çš„ Podï¼Œå› ä¸ºâ€“rm æ„å‘³ç€ Pod é€€å‡ºåå°±ä¼šè¢«åˆ é™¤æ‰ã€‚\n3. æ—¥å¿— 3.1. kube-apiserver æ—¥å¿— PODNAME=$(kubectl -n kube-system get pod -l component=kube-apiserver -o jsonpath='{.items[0].metadata.name}') kubectl -n kube-system logs $PODNAME --tail 100  ä»¥ä¸Šå‘½ä»¤æ“ä½œå‡è®¾æ§åˆ¶å¹³é¢ä»¥ Kubernetes é™æ€ Pod çš„å½¢å¼æ¥è¿è¡Œã€‚å¦‚æœ kube-apiserver æ˜¯ç”¨ systemd ç®¡ç†çš„ï¼Œåˆ™éœ€è¦ç™»å½•åˆ° master èŠ‚ç‚¹ä¸Šï¼Œç„¶åä½¿ç”¨ journalctl -u kube-apiserver æŸ¥çœ‹å…¶æ—¥å¿—ã€‚\n3.2. kube-controller-manager æ—¥å¿— PODNAME=$(kubectl -n kube-system get pod -l component=kube-controller-manager -o jsonpath='{.items[0].metadata.name}') kubectl -n kube-system logs $PODNAME --tail 100  ä»¥ä¸Šå‘½ä»¤æ“ä½œå‡è®¾æ§åˆ¶å¹³é¢ä»¥ Kubernetes é™æ€ Pod çš„å½¢å¼æ¥è¿è¡Œã€‚å¦‚æœ kube-controller-manager æ˜¯ç”¨ systemd ç®¡ç†çš„ï¼Œåˆ™éœ€è¦ç™»å½•åˆ° master èŠ‚ç‚¹ä¸Šï¼Œç„¶åä½¿ç”¨ journalctl -u kube-controller-manager æŸ¥çœ‹å…¶æ—¥å¿—ã€‚\n3.3. kube-scheduler æ—¥å¿— PODNAME=$(kubectl -n kube-system get pod -l component=kube-scheduler -o jsonpath='{.items[0].metadata.name}') kubectl -n kube-system logs $PODNAME --tail 100  ä»¥ä¸Šå‘½ä»¤æ“ä½œå‡è®¾æ§åˆ¶å¹³é¢ä»¥ Kubernetes é™æ€ Pod çš„å½¢å¼æ¥è¿è¡Œã€‚å¦‚æœ kube-scheduler æ˜¯ç”¨ systemd ç®¡ç†çš„ï¼Œåˆ™éœ€è¦ç™»å½•åˆ° master èŠ‚ç‚¹ä¸Šï¼Œç„¶åä½¿ç”¨ journalctl -u kube-scheduler æŸ¥çœ‹å…¶æ—¥å¿—ã€‚\n3.4. kubelet æ—¥å¿— journalctl -l -u kubelet  3.5. Pod æ—¥å¿— æŸ¥çœ‹æŒ‡å®šPodçš„æ—¥å¿—\nkubectl logs \u0026lt;pod-name\u0026gt; -n \u0026lt;namespace\u0026gt; # ç±»ä¼¼ tail -f çš„æ—¥å¿— kubectl logs -f \u0026lt;pod-name\u0026gt; -n \u0026lt;namespace\u0026gt;  ä¾‹å­ï¼š\n# Return snapshot logs from pod nginx with only one container kubectl logs nginx # Return snapshot logs from pod nginx with multi containers kubectl logs nginx --all-containers=true # Return snapshot logs from all containers in pods defined by label app=nginx kubectl logs -lapp=nginx --all-containers=true # Return snapshot of previous terminated ruby container logs from pod web-1 kubectl logs -p -c ruby web-1 # Begin streaming the logs of the ruby container in pod web-1 kubectl logs -f -c ruby web-1 # Begin streaming the logs from all containers in pods defined by label app=nginx kubectl logs -f -lapp=nginx --all-containers=true # Display only the most recent 20 lines of output in pod nginx kubectl logs --tail=20 nginx # Show all logs from pod nginx written in the last hour kubectl logs --since=1h nginx # Show logs from a kubelet with an expired serving certificate kubectl logs --insecure-skip-tls-verify-backend nginx # Return snapshot logs from first container of a job named hello kubectl logs job/hello # Return snapshot logs from container nginx-1 of a deployment named nginx kubectl logs deployment/nginx -c nginx-1  4. æ±¡ç‚¹ ä¸€æ—¦æŸä¸ªèŠ‚ç‚¹è¢«åŠ ä¸Šäº†ä¸€ä¸ª Taintï¼Œå³è¢«â€œæ‰“ä¸Šäº†æ±¡ç‚¹â€ï¼Œé‚£ä¹ˆæ‰€æœ‰ Pod å°±éƒ½ä¸èƒ½åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå› ä¸º Kubernetes çš„ Pod éƒ½æœ‰â€œæ´ç™–â€ã€‚\né™¤éï¼Œæœ‰ä¸ªåˆ«çš„ Pod å£°æ˜è‡ªå·±èƒ½â€œå®¹å¿â€è¿™ä¸ªâ€œæ±¡ç‚¹â€ï¼Œå³å£°æ˜äº† Tolerationï¼Œå®ƒæ‰å¯ä»¥åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚\nä¸ºèŠ‚ç‚¹æ‰“æ±¡ç‚¹(Taint)çš„å‘½ä»¤æ˜¯ï¼š\n$ kubectl taint nodes node1 foo=bar:NoSchedule  è¿™æ—¶ï¼Œè¯¥ node1 èŠ‚ç‚¹ä¸Šå°±ä¼šå¢åŠ ä¸€ä¸ªé”®å€¼å¯¹æ ¼å¼çš„ Taintï¼Œå³ï¼šfoo=bar:NoScheduleã€‚å…¶ä¸­å€¼é‡Œé¢çš„ NoScheduleï¼Œæ„å‘³ç€è¿™ä¸ª Taint åªä¼šåœ¨è°ƒåº¦æ–° Pod æ—¶äº§ç”Ÿä½œç”¨ï¼Œè€Œä¸ä¼šå½±å“å·²ç»åœ¨ node1 ä¸Šè¿è¡Œçš„ Podï¼Œå“ªæ€•å®ƒä»¬æ²¡æœ‰ Tolerationã€‚\né‚£ä¹ˆ Pod åˆå¦‚ä½•å£°æ˜ Toleration å‘¢ï¼Ÿ\næˆ‘ä»¬åªè¦åœ¨ Pod çš„.yaml æ–‡ä»¶ä¸­çš„ spec éƒ¨åˆ†ï¼ŒåŠ å…¥ tolerations å­—æ®µå³å¯ï¼š\napiVersion: v1 kind: Pod ... spec: tolerations: - key: \u0026quot;foo\u0026quot; operator: \u0026quot;Equal\u0026quot; value: \u0026quot;bar\u0026quot; effect: \u0026quot;NoSchedule\u0026quot;  è¿™ä¸ª Toleration çš„å«ä¹‰æ˜¯ï¼Œè¿™ä¸ª Pod èƒ½â€œå®¹å¿â€æ‰€æœ‰é”®å€¼å¯¹ä¸º foo=bar çš„ Taintï¼ˆ operator: â€œEqualâ€ï¼Œâ€œç­‰äºâ€æ“ä½œï¼‰ã€‚\né€šå¸¸ï¼Œmaster èŠ‚ç‚¹ä¸Šä¼šè‡ªå¸¦ä¸€ä¸ªæ±¡ç‚¹ï¼š\n$ kubectl describe node master Name: master Roles: master Taints: node-role.kubernetes.io/master:NoSchedule  å¯ä»¥çœ‹åˆ°ï¼ŒMaster èŠ‚ç‚¹é»˜è®¤è¢«åŠ ä¸Šäº†node-role.kubernetes.io/master:NoScheduleè¿™æ ·ä¸€ä¸ªâ€œæ±¡ç‚¹â€ï¼Œå…¶ä¸­â€œé”®â€æ˜¯node-role.kubernetes.io/masterï¼Œè€Œæ²¡æœ‰æä¾›â€œå€¼â€ã€‚\næ­¤æ—¶ï¼Œä½ å°±éœ€è¦åƒä¸‹é¢è¿™æ ·ç”¨â€œExistsâ€æ“ä½œç¬¦ï¼ˆoperator: â€œExistsâ€ï¼Œâ€œå­˜åœ¨â€å³å¯ï¼‰æ¥è¯´æ˜ï¼Œè¯¥ Pod èƒ½å¤Ÿå®¹å¿æ‰€æœ‰ä»¥ foo ä¸ºé”®çš„ Taintï¼Œæ‰èƒ½è®©è¿™ä¸ª Pod è¿è¡Œåœ¨è¯¥ Master èŠ‚ç‚¹ä¸Šï¼š\napiVersion: v1 kind: Pod ... spec: tolerations: - key: \u0026quot;foo\u0026quot; operator: \u0026quot;Exists\u0026quot; effect: \u0026quot;NoSchedule\u0026quot;  å½“ç„¶ï¼Œå¦‚æœä½ å°±æ˜¯æƒ³è¦ä¸€ä¸ªå•èŠ‚ç‚¹çš„ Kubernetesï¼Œåˆ é™¤è¿™ä¸ª Taint æ‰æ˜¯æ­£ç¡®çš„é€‰æ‹©ï¼š\n$ kubectl taint nodes --all node-role.kubernetes.io/master-  å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨â€œnode-role.kubernetes.io/masterâ€è¿™ä¸ªé”®åé¢åŠ ä¸Šäº†ä¸€ä¸ªçŸ­æ¨ªçº¿â€œ-â€ï¼Œè¿™ä¸ªæ ¼å¼å°±æ„å‘³ç€ç§»é™¤æ‰€æœ‰ä»¥â€œnode-role.kubernetes.io/masterâ€ä¸ºé”®çš„ Taintã€‚\n5. ProjectedVolume 5.1 Secret 5.1.1. åˆ›å»º kubectl create secret generic user --from-file=./username.txt  5.1.2 æŸ¥è¯¢ kubectl get secrets  5.2. ConfigMap 5.2.1. åˆ›å»º $ kubectl create configmap \u0026lt;configmap-na,e\u0026gt; --from-file=\u0026lt;file-name\u0026gt;  5.22. æŸ¥è¯¢ kubectl get configmaps \u0026lt;configmap-name\u0026gt; -o yaml  ","date":"2021å¹´02æœˆ25æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter9/commands/","summary":"1. yaml æ–‡ä»¶ 1.1 åˆ›å»º $ kubectl create -f æˆ‘çš„é…ç½®æ–‡ä»¶  1.2 ä¿®æ”¹ æ›´æ–° yaml æ–‡ä»¶ï¼š\n$ kubectl replace -f nginx-deployment.","title":"å¸¸ç”¨çš„k8så‘½ä»¤"},{"contents":"1. å‡†å¤‡å·¥ä½œ æœºå™¨é…ç½®  8æ ¸CPUã€8GBå†…å­˜ï¼› 40GBç£ç›˜ centos 7.9 å†…ç½‘äº’åŒ å¤–ç½‘è®¿é—®ä¸å—é™åˆ¶  ç»„ä»¶ä¿¡æ¯    ç»„ä»¶ ç‰ˆæœ¬     ç³»ç»Ÿ Centos 7.9   Dockerç‰ˆæœ¬ 18.09.9   k8s ç‰ˆæœ¬ 1.20.0   Pod ç½‘æ®µ 10.32.0.0/    å®è·µç›®æ ‡  åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰è£… Docker å’Œ kubeadmï¼› éƒ¨ç½² Kubernetes Masterï¼› éƒ¨ç½²å®¹å™¨ç½‘ç»œæ’ä»¶ï¼› éƒ¨ç½² Kubernetes Workerï¼› éƒ¨ç½² Dashboard å¯è§†åŒ–æ’ä»¶ï¼› éƒ¨ç½²å®¹å™¨å­˜å‚¨æ’ä»¶  åŸºæœ¬é…ç½® å¼€å§‹å®‰è£…ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹ç³»ç»Ÿåšä¸€äº›åŸºæœ¬çš„é…ç½®ã€‚\næ‰€æœ‰èŠ‚ç‚¹é…ç½® hosts\n# cat /etc/hosts 10.186.4.100 master 10.186.4.167 node1 10.186.4.168 node2 10.186.4.169 node3  æ‰€æœ‰èŠ‚ç‚¹å…³é—­é˜²ç«å¢™ã€selinuxã€dnsmasq\nsystemctl disable --now firewalld #å…³é—­dnsmasq(å¦åˆ™å¯èƒ½å¯¼è‡´dockerå®¹å™¨æ— æ³•è§£æåŸŸå) systemctl disable --now dnsmasq systemctl disable --now NetworkManager # Set SELinux in permissive mode (effectively disabling it) sudo setenforce 0 sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config  å…³é—­swap\nswapoff -a \u0026amp;\u0026amp; sysctl -w vm.swappiness=0 sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab  å…è®¸iptalesæŸ¥çœ‹ç½‘æ¡¥æµé‡\ncat \u0026lt;\u0026lt;EOF | sudo tee /etc/modules-load.d/k8s.conf br_netfilter EOF cat \u0026lt;\u0026lt;EOF | sudo tee /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sudo sysctl --system  å®‰è£…ntpdate\nrpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm yum install ntpdate -y  åŒæ­¥æ—¶é—´\nln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime echo 'Asia/Shanghai' \u0026gt;/etc/timezone ntpdate time2.aliyun.com  åŠ å…¥åˆ° crontab\n*/5 * * * * ntpdate time2.aliyun.com  èŠ‚ç‚¹ä¹‹é—´å…å¯†ç™»å½•\nssh-keygen -t rsa for i in master node1 node2 node3;do ssh-copy-id -i .ssh/id_rsa.pub $i;done  å¼€æ”¾ç«¯å£\nç½‘ç»œæ’ä»¶weaveçš„ç«¯å£æ˜¯6783ã€‚\n2. å®‰è£… kubeadm å’Œ docker docker å®‰è£…  å®‰è£…è¿‡ç¨‹å‚è€ƒdocker install\n yumæºé…ç½®\nyum install -y yum-utils # å®˜æ–¹æº sudo yum-config-manager \\ --add-repo \\ https://download.docker.com/linux/centos/docker-ce.repo # é˜¿é‡Œäº‘æº yum-config-manager \\ --add-repo \\ https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo  å¦‚æœæ˜¯å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ dockerï¼Œå¯ä»¥ç›´æ¥å®‰è£…:\n$ sudo yum install docker-ce docker-ce-cli containerd.io  æŒ‡å®šç‰ˆæœ¬å®‰è£…çš„è¯ï¼Œå…ˆæŸ¥çœ‹æºä¸­å¯ç”¨çš„dockerç‰ˆæœ¬ï¼š\n$ yum list docker-ce --showduplicates | sort -r docker-ce.x86_64 3:18.09.1-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.0-3.el7 docker-ce-stable docker-ce.x86_64 18.06.1.ce-3.el7 docker-ce-stable docker-ce.x86_64 18.06.0.ce-3.el7 docker-ce-stable  é€šè¿‡è½¯ä»¶åŒ…åç§°å®‰è£…ç‰¹å®šç‰ˆæœ¬ï¼Œè½¯ä»¶åŒ…åç§°æ˜¯è½¯ä»¶åŒ…åç§°ï¼ˆdocker-ceï¼‰åŠ ä¸Šç‰ˆæœ¬å­—ç¬¦ä¸²ï¼ˆç¬¬äºŒåˆ—ï¼‰ï¼Œä»ç¬¬ä¸€ä¸ªå†’å·ï¼ˆ:)å¼€å§‹ï¼Œç›´è‡³ç¬¬ä¸€ä¸ªè¿å­—ç¬¦ï¼Œå¹¶ç”¨è¿å­—ç¬¦ï¼ˆ-ï¼‰è¿æ¥ã€‚ä¾‹å¦‚docker-ce-18.09.9ã€‚\n$ sudo yum install -y docker-ce-\u0026lt;VERSION_STRING\u0026gt; docker-ce-cli-\u0026lt;VERSION_STRING\u0026gt; containerd.io  è®¾ç½®å¼€æœºå¯åŠ¨\n$ sudo systemctl start docker $ systemctl daemon-reload \u0026amp;\u0026amp; systemctl enable --now docker  kubeadm  å®‰è£…è¿‡ç¨‹å‚è€ƒ Installing kubeadm\n æ·»åŠ  yum æºï¼Œæ‰§è¡Œå®‰è£…å‘½ä»¤ã€‚\ncat \u0026lt;\u0026lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\\$basearch enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg exclude=kubelet kubeadm kubectl EOF # é˜¿é‡Œäº‘æº cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes sudo systemctl enable --now kubelet  åœ¨ä¸Šè¿°å®‰è£… kubeadm çš„è¿‡ç¨‹ä¸­ï¼Œkubeadm å’Œ kubeletã€kubectlã€kubernetes-cni è¿™å‡ ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶éƒ½ä¼šè¢«è‡ªåŠ¨å®‰è£…å¥½ã€‚\nå®‰è£…çš„æ—¶å€™æŒ‡å®šç‰ˆæœ¬ï¼š\nsudo yum install -y kubelet-1.20.0-0 kubeadm-1.20.0-0 kubectl-1.20.0-0 --disableexcludes=kubernetes  kubectl å‘½ä»¤å¯ç”¨ shell è‡ªåŠ¨è¡¥é½åŠŸèƒ½\n# 1.å®‰è£…bash-completion yum install bash-completion # é‡æ–°åŠ è½½ä½ çš„ Shell å¹¶è¿è¡Œ type _init_completion type _init_completion # 2.å¯åŠ¨ kubectl è‡ªåŠ¨è¡¥é½ echo 'source \u0026lt;(kubectl completion bash)' \u0026gt;\u0026gt;~/.bashrc source ~/.bashrc  å¼€æœºè‡ªå¯åŠ¨\nsystemctl daemon-reload \u0026amp;\u0026amp; systemctl enable --now kubelet  3. éƒ¨ç½²kubernetes çš„masterèŠ‚ç‚¹ kubeadm åˆå§‹åŒ–çš„æ—¶å€™å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æˆ–è€…é…ç½®æ–‡ä»¶çš„æ–¹å¼è¿›è¡Œã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ kubeadm config å‘½ä»¤æ¥æŸ¥çœ‹ kubeadm çš„é…ç½®ã€‚\nåˆå§‹åŒ–éœ€è¦çš„é•œåƒå¯ä»¥é€šè¿‡kubeadm config images list æ¥æŸ¥çœ‹ï¼š\n# kubeadm config images list k8s.gcr.io/kube-apiserver:v1.20.4 k8s.gcr.io/kube-controller-manager:v1.20.4 k8s.gcr.io/kube-scheduler:v1.20.4 k8s.gcr.io/kube-proxy:v1.20.4 k8s.gcr.io/pause:3.2 k8s.gcr.io/etcd:3.4.13-0 k8s.gcr.io/coredns:1.7.0  ä¸ºäº†å‡å°‘åˆå§‹åŒ–çš„æ—¶é—´ï¼Œå¯ä»¥ç”¨ kubeadm config images pull å‘½ä»¤æå‰æ‹‰å–é•œåƒï¼Œè·å–é•œåƒçš„æ—¶å€™ï¼Œé»˜è®¤ä½¿ç”¨çš„ k8s.gcr.io è¿™ä¸ªé•œåƒæºï¼Œå›½å†…æ˜¯ä¸‹è½½ä¸äº†çš„ã€‚æœ‰ä¸¤ä¸ªè§£å†³åŠæ³•ï¼š\n  ä½¿ç”¨å›½å†…çš„é˜¿é‡Œäº‘é•œåƒæºï¼š\ncat \u0026gt;/etc/sysconfig/kubelet\u0026lt;\u0026lt;EOF KUBELET_EXTRA_ARGS=\u0026quot;--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2\u0026quot; EOF # æˆ–è€…é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®š image repo kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers    è®¾ç½®ä»£ç†ï¼Œdocker pull çš„ä»£ç†é…ç½®å‚è€ƒDockerçš„ä¸‰ç§ç½‘ç»œä»£ç†é…ç½®\n  kubeadm çš„åˆå§‹åŒ–è¿™é‡Œé‡‡ç”¨äº†é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œkubeadm å¯¹äºä½ç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶æ˜¯ä¸å…¼å®¹çš„ï¼Œæˆ‘ä»¬é€šè¿‡ kubeadm config migrate --new-config ${new-file} --old config ${old-file} å‘½ä»¤æ¥è½¬æ¢ã€‚\n# kubeadm.yml apiVersion: kubeadm.k8s.io/v1beta2 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: bw4tlw.owb266appoos6afw ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 10.186.4.100 bindPort: 6443 nodeRegistration: criSocket: /var/run/dockershim.sock name: yxj-test taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiServer: extraArgs: runtime-config: api/all=true timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: extraArgs: horizontal-pod-autoscaler-sync-period: 10s horizontal-pod-autoscaler-use-rest-clients: \u0026quot;true\u0026quot; node-monitor-grace-period: 10s dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: k8s.gcr.io kind: ClusterConfiguration kubernetesVersion: v1.20.3 imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers networking: dnsDomain: cluster.local podSubnet: 10.32.0.0/12 serviceSubnet: 10.96.0.0/12 scheduler: {}  è¿™ä¸ªé…ç½®ä¸­ï¼Œç»™kube-controller-manager è®¾ç½®äº†\nhorizontal-pod-autoscaler-use-rest-clients: \u0026quot;true\u0026quot;  è¿™æ„å‘³ç€ï¼Œå°†æ¥éƒ¨ç½²çš„ kube-controller-manager èƒ½å¤Ÿä½¿ç”¨è‡ªå®šä¹‰èµ„æºï¼ˆCustom Metricsï¼‰è¿›è¡Œè‡ªåŠ¨æ°´å¹³æ‰©å±•ã€‚\nç”±äºæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„ç½‘ç»œæ’ä»¶æ˜¯waveï¼Œè‡ªå®šä¹‰Pod çš„ cidr ç½‘ç»œä¸ºï¼š\npodSubnet: 10.32.0.0/12  ç„¶åï¼Œæ‰§è¡Œä¸€å¥æŒ‡ä»¤ï¼š\n$ kubeadm init --config kubeadm.yaml [init] Using Kubernetes version: v1.20.0 [preflight] Running pre-flight checks [WARNING IsDockerSystemdCheck]: detected \u0026quot;cgroupfs\u0026quot; as the Docker cgroup driver. The recommended driver is \u0026quot;systemd\u0026quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/ [preflight] Pulling images required for setting up a Kubernetes cluster [preflight] This might take a minute or two, depending on the speed of your internet connection [preflight] You can also perform this action in beforehand using 'kubeadm config images pull' [certs] Using certificateDir folder \u0026quot;/etc/kubernetes/pki\u0026quot; [certs] Generating \u0026quot;ca\u0026quot; certificate and key [certs] Generating \u0026quot;apiserver\u0026quot; certificate and key [certs] apiserver serving cert is signed for DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local yxj-test] and IPs [10.96.0.1 10.186.4.100] [certs] Generating \u0026quot;apiserver-kubelet-client\u0026quot; certificate and key [certs] Generating \u0026quot;front-proxy-ca\u0026quot; certificate and key [certs] Generating \u0026quot;front-proxy-client\u0026quot; certificate and key [certs] Generating \u0026quot;etcd/ca\u0026quot; certificate and key [certs] Generating \u0026quot;etcd/server\u0026quot; certificate and key [certs] etcd/server serving cert is signed for DNS names [localhost yxj-test] and IPs [10.186.4.100 127.0.0.1 ::1] [certs] Generating \u0026quot;etcd/peer\u0026quot; certificate and key [certs] etcd/peer serving cert is signed for DNS names [localhost yxj-test] and IPs [10.186.4.100 127.0.0.1 ::1] [certs] Generating \u0026quot;etcd/healthcheck-client\u0026quot; certificate and key [certs] Generating \u0026quot;apiserver-etcd-client\u0026quot; certificate and key [certs] Generating \u0026quot;sa\u0026quot; key and public key [kubeconfig] Using kubeconfig folder \u0026quot;/etc/kubernetes\u0026quot; [kubeconfig] Writing \u0026quot;admin.conf\u0026quot; kubeconfig file [kubeconfig] Writing \u0026quot;kubelet.conf\u0026quot; kubeconfig file [kubeconfig] Writing \u0026quot;controller-manager.conf\u0026quot; kubeconfig file [kubeconfig] Writing \u0026quot;scheduler.conf\u0026quot; kubeconfig file [kubelet-start] Writing kubelet environment file with flags to file \u0026quot;/var/lib/kubelet/kubeadm-flags.env\u0026quot; [kubelet-start] Writing kubelet configuration to file \u0026quot;/var/lib/kubelet/config.yaml\u0026quot; [kubelet-start] Starting the kubelet [control-plane] Using manifest folder \u0026quot;/etc/kubernetes/manifests\u0026quot; [control-plane] Creating static Pod manifest for \u0026quot;kube-apiserver\u0026quot; [control-plane] Creating static Pod manifest for \u0026quot;kube-controller-manager\u0026quot; [control-plane] Creating static Pod manifest for \u0026quot;kube-scheduler\u0026quot; [etcd] Creating static Pod manifest for local etcd in \u0026quot;/etc/kubernetes/manifests\u0026quot; [wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \u0026quot;/etc/kubernetes/manifests\u0026quot;. This can take up to 4m0s [apiclient] All control plane components are healthy after 15.004566 seconds [upload-config] Storing the configuration used in ConfigMap \u0026quot;kubeadm-config\u0026quot; in the \u0026quot;kube-system\u0026quot; Namespace [kubelet] Creating a ConfigMap \u0026quot;kubelet-config-1.20\u0026quot; in namespace kube-system with the configuration for the kubelets in the cluster [upload-certs] Skipping phase. Please see --upload-certs [mark-control-plane] Marking the node yxj-test as control-plane by adding the labels \u0026quot;node-role.kubernetes.io/master=''\u0026quot; and \u0026quot;node-role.kubernetes.io/control-plane='' (deprecated)\u0026quot; [mark-control-plane] Marking the node yxj-test as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule] [bootstrap-token] Using token: bw4tlw.owb266appoos6afw [bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials [bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token [bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster [bootstrap-token] Creating the \u0026quot;cluster-info\u0026quot; ConfigMap in the \u0026quot;kube-public\u0026quot; namespace [kubelet-finalize] Updating \u0026quot;/etc/kubernetes/kubelet.conf\u0026quot; to point to a rotatable kubelet client certificate and key [addons] Applied essential addon: CoreDNS [addons] Applied essential addon: kube-proxy Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Alternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.conf You should now deploy a pod network to the cluster. Run \u0026quot;kubectl apply -f [podnetwork].yaml\u0026quot; with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: kubeadm join 10.186.4.100:6443 --token bw4tlw.owb266appoos6afw \\ --discovery-token-ca-cert-hash sha256:67c5b1f31669be60c07280f52b9aab867af54d2d4bb679490216028f858c7fb6  å°±å¯ä»¥å®Œæˆ Kubernetes Master çš„éƒ¨ç½²äº†ï¼Œè¿™ä¸ªè¿‡ç¨‹åªéœ€è¦å‡ åˆ†é’Ÿã€‚éƒ¨ç½²å®Œæˆåï¼Œkubeadm ä¼šç”Ÿæˆä¸€è¡ŒæŒ‡ä»¤\nkubeadm join 10.186.4.100:6443 --token bw4tlw.owb266appoos6afw \\ --discovery-token-ca-cert-hash sha256:67c5b1f31669be60c07280f52b9aab867af54d2d4bb679490216028f858c7fb6  è¿™ä¸ª kubeadm join å‘½ä»¤ï¼Œå°±æ˜¯ç”¨æ¥ç»™è¿™ä¸ª Master èŠ‚ç‚¹æ·»åŠ æ›´å¤šå·¥ä½œèŠ‚ç‚¹ï¼ˆWorkerï¼‰çš„å‘½ä»¤ã€‚æˆ‘ä»¬åœ¨åé¢éƒ¨ç½² Worker èŠ‚ç‚¹çš„æ—¶å€™é©¬ä¸Šä¼šç”¨åˆ°å®ƒï¼Œæ‰€ä»¥æ‰¾ä¸€ä¸ªåœ°æ–¹æŠŠè¿™æ¡å‘½ä»¤è®°å½•ä¸‹æ¥ã€‚\næ­¤å¤–ï¼Œkubeadm è¿˜ä¼šæç¤ºæˆ‘ä»¬ç¬¬ä¸€æ¬¡ä½¿ç”¨ Kubernetes é›†ç¾¤æ‰€éœ€è¦çš„é…ç½®å‘½ä»¤ï¼š\nmkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config  è€Œéœ€è¦è¿™äº›é…ç½®å‘½ä»¤çš„åŸå› æ˜¯ï¼šKubernetes é›†ç¾¤é»˜è®¤éœ€è¦åŠ å¯†æ–¹å¼è®¿é—®ã€‚æ‰€ä»¥ï¼Œè¿™å‡ æ¡å‘½ä»¤ï¼Œå°±æ˜¯å°†åˆšåˆšéƒ¨ç½²ç”Ÿæˆçš„ Kubernetes é›†ç¾¤çš„å®‰å…¨é…ç½®æ–‡ä»¶ï¼Œä¿å­˜åˆ°å½“å‰ç”¨æˆ·çš„.kube ç›®å½•ä¸‹ï¼Œkubectl é»˜è®¤ä¼šä½¿ç”¨è¿™ä¸ªç›®å½•ä¸‹çš„æˆæƒä¿¡æ¯è®¿é—® Kubernetes é›†ç¾¤ã€‚å¦‚æœä¸è¿™ä¹ˆåšçš„è¯ï¼Œæˆ‘ä»¬æ¯æ¬¡éƒ½éœ€è¦é€šè¿‡ export KUBECONFIG ç¯å¢ƒå˜é‡å‘Šè¯‰ kubectl è¿™ä¸ªå®‰å…¨é…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ kubectl get å‘½ä»¤æ¥æŸ¥çœ‹å½“å‰å”¯ä¸€ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€äº†ï¼š\n# kubectl get nodes NAME STATUS ROLES AGE VERSION yxj-test Ready control-plane,master 3h14m v1.20.0  é»˜è®¤æƒ…å†µä¸‹ï¼Œå‡ºäºå®‰å…¨åŸå› ï¼Œä¸ä¼šåœ¨masterèŠ‚ç‚¹ä¸Šè°ƒåº¦Podã€‚å¦‚æœå¸Œæœ›èƒ½å¤Ÿåœ¨masterèŠ‚ç‚¹ä¸Šè°ƒåº¦Podï¼Œå°±å¯ä»¥è¿è¡Œå¦‚ä¸‹çš„å‘½ä»¤ï¼š\n# kubectl taint nodes --all node-role.kubernetes.io/master- node/yxj-test untainted taint \u0026quot;node-role.kubernetes.io/master\u0026quot; not found taint \u0026quot;node-role.kubernetes.io/master\u0026quot; not found taint \u0026quot;node-role.kubernetes.io/master\u0026quot; not found  è¿™æ ·å°±åˆ é™¤ä¸»èŠ‚ç‚¹ä¸Šçš„ node-role.kubernetes.io/master  æ±¡ç‚¹ï¼Œè°ƒåº¦å™¨å°±èƒ½å°†Podè°ƒåº¦åˆ° master èŠ‚ç‚¹ä¸Šã€‚\nä¿®æ”¹ç»„ä»¶å‚æ•°\nå¦‚æœæˆ‘ä»¬éœ€è¦ä¿®æ”¹ k8s ç»„ä»¶çš„å‚æ•°ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ /etc/kubernetes/manifests/ è¿™ä¸ªç›®å½•ä¸‹ç¼–è¾‘ç»„ä»¶çš„yamlæ–‡ä»¶ï¼Œä¿å­˜åä¼šé‡å¯å¯¹åº”çš„ç»„ä»¶ã€‚\n4. éƒ¨ç½²ç½‘ç»œæ’ä»¶ ä»¥weaveä¸ºä¾‹å­ï¼š\nkubectl apply -f \u0026quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\u0026quot;  éƒ¨ç½²å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ kubectl get é‡æ–°æ£€æŸ¥ Pod çš„çŠ¶æ€ï¼š\n# kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE coredns-74ff55c5b-f95sj 1/1 Running 0 131m coredns-74ff55c5b-zvjdz 1/1 Running 0 131m etcd-yxj-test 1/1 Running 0 131m kube-apiserver-yxj-test 1/1 Running 0 131m kube-controller-manager-yxj-test 1/1 Running 0 131m kube-proxy-nm4tt 1/1 Running 0 131m kube-scheduler-yxj-test 1/1 Running 0 131m weave-net-pl4qp 2/2 Running 1 126m  å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰çš„ç³»ç»Ÿ Pod éƒ½æˆåŠŸå¯åŠ¨äº†ï¼Œè€Œåˆšåˆšéƒ¨ç½²çš„ Weave ç½‘ç»œæ’ä»¶åˆ™åœ¨ kube-system ä¸‹é¢æ–°å»ºäº†ä¸€ä¸ªåå« weave-net-pl4qp çš„ Podï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº› Pod å°±æ˜¯å®¹å™¨ç½‘ç»œæ’ä»¶åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„æ§åˆ¶ç»„ä»¶ã€‚\nKubernetes æ”¯æŒå®¹å™¨ç½‘ç»œæ’ä»¶ï¼Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ªåå« CNI çš„é€šç”¨æ¥å£ï¼Œå®ƒä¹Ÿæ˜¯å½“å‰å®¹å™¨ç½‘ç»œçš„äº‹å®æ ‡å‡†ï¼Œå¸‚é¢ä¸Šçš„æ‰€æœ‰å®¹å™¨ç½‘ç»œå¼€æºé¡¹ç›®éƒ½å¯ä»¥é€šè¿‡ CNI æ¥å…¥ Kubernetesï¼Œæ¯”å¦‚ Flannelã€Calicoã€Canalã€Romana ç­‰ç­‰ï¼Œå®ƒä»¬çš„éƒ¨ç½²æ–¹å¼ä¹Ÿéƒ½æ˜¯ç±»ä¼¼çš„â€œä¸€é”®éƒ¨ç½²â€ã€‚\n weave æ’ä»¶éƒ¨ç½²æŠ¥é”™ï¼šweave Inconsistent bridge state detected. Please do \u0026lsquo;weave reset\u0026rsquo; and try again\nè§£å†³ï¼šå®‰è£…weave\nsudo curl -L git.io/weave -o /usr/local/bin/weave sudo chmod a+x /usr/local/bin/weave   5. éƒ¨ç½² k8s çš„ worker èŠ‚ç‚¹ Kubernetes çš„ Worker èŠ‚ç‚¹è·Ÿ Master èŠ‚ç‚¹å‡ ä¹æ˜¯ç›¸åŒçš„ï¼Œå®ƒä»¬è¿è¡Œç€çš„éƒ½æ˜¯ä¸€ä¸ª kubelet ç»„ä»¶ã€‚å”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼Œåœ¨ kubeadm init çš„è¿‡ç¨‹ä¸­ï¼Œkubelet å¯åŠ¨åï¼ŒMaster èŠ‚ç‚¹ä¸Šè¿˜ä¼šè‡ªåŠ¨è¿è¡Œ kube-apiserverã€kube-schedulerã€kube-controller-manger è¿™ä¸‰ä¸ªç³»ç»Ÿ Podã€‚\næ‰€ä»¥ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œéƒ¨ç½² Worker èŠ‚ç‚¹åè€Œæ˜¯æœ€ç®€å•çš„ï¼Œåªéœ€è¦ä¸¤æ­¥å³å¯å®Œæˆã€‚\n  ç¬¬ä¸€æ­¥ï¼Œåœ¨æ‰€æœ‰ Worker èŠ‚ç‚¹ä¸Šæ‰§è¡Œâ€œå®‰è£… kubeadm å’Œ Dockerâ€ä¸€èŠ‚çš„æ‰€æœ‰æ­¥éª¤ã€‚\n  ç¬¬äºŒæ­¥ï¼Œæ‰§è¡Œéƒ¨ç½² Master èŠ‚ç‚¹æ—¶ç”Ÿæˆçš„ kubeadm join æŒ‡ä»¤ï¼š\nkubeadm join 10.186.4.100:6443 --token bw4tlw.owb266appoos6afw \\ --discovery-token-ca-cert-hash sha256:36f6f60943015fadcc0fc9824611af4d594b7c4b43ab264c2113342fbd1e3994    é€šè¿‡ Taint/Toleration è°ƒæ•´ Master æ‰§è¡Œ Pod çš„ç­–ç•¥\næˆ‘åœ¨å‰é¢æåˆ°è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹ Master èŠ‚ç‚¹æ˜¯ä¸å…è®¸è¿è¡Œç”¨æˆ· Pod çš„ã€‚è€Œ Kubernetes åšåˆ°è¿™ä¸€ç‚¹ï¼Œä¾é çš„æ˜¯ Kubernetes çš„ Taint/Toleration æœºåˆ¶ã€‚\nå®ƒçš„åŸç†éå¸¸ç®€å•ï¼šä¸€æ—¦æŸä¸ªèŠ‚ç‚¹è¢«åŠ ä¸Šäº†ä¸€ä¸ª Taintï¼Œå³è¢«â€œæ‰“ä¸Šäº†æ±¡ç‚¹â€ï¼Œé‚£ä¹ˆæ‰€æœ‰ Pod å°±éƒ½ä¸èƒ½åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå› ä¸º Kubernetes çš„ Pod éƒ½æœ‰â€œæ´ç™–â€ã€‚é™¤éï¼Œæœ‰ä¸ªåˆ«çš„ Pod å£°æ˜è‡ªå·±èƒ½â€œå®¹å¿â€è¿™ä¸ªâ€œæ±¡ç‚¹â€ï¼Œå³å£°æ˜äº† Tolerationï¼Œå®ƒæ‰å¯ä»¥åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚\nå…¶ä¸­ï¼Œä¸ºèŠ‚ç‚¹æ‰“ä¸Šâ€œæ±¡ç‚¹â€ï¼ˆTaintï¼‰çš„å‘½ä»¤æ˜¯ï¼š\n$ kubectl taint nodes node1 foo=bar:NoSchedule  è¿™æ—¶ï¼Œè¯¥ node1 èŠ‚ç‚¹ä¸Šå°±ä¼šå¢åŠ ä¸€ä¸ªé”®å€¼å¯¹æ ¼å¼çš„ Taintï¼Œå³ï¼šfoo=bar:NoScheduleã€‚å…¶ä¸­å€¼é‡Œé¢çš„ NoScheduleï¼Œæ„å‘³ç€è¿™ä¸ª Taint åªä¼šåœ¨è°ƒåº¦æ–° Pod æ—¶äº§ç”Ÿä½œç”¨ï¼Œè€Œä¸ä¼šå½±å“å·²ç»åœ¨ node1 ä¸Šè¿è¡Œçš„ Podï¼Œå“ªæ€•å®ƒä»¬æ²¡æœ‰ Tolerationã€‚\né‚£ä¹ˆ Pod åˆå¦‚ä½•å£°æ˜ Toleration å‘¢ï¼Ÿ\næˆ‘ä»¬åªè¦åœ¨ Pod çš„.yaml æ–‡ä»¶ä¸­çš„ spec éƒ¨åˆ†ï¼ŒåŠ å…¥ tolerations å­—æ®µå³å¯ï¼š\napiVersion: v1 kind: Pod ... spec: tolerations: - key: \u0026quot;foo\u0026quot; operator: \u0026quot;Equal\u0026quot; value: \u0026quot;bar\u0026quot; effect: \u0026quot;NoSchedule\u0026quot;  è¿™ä¸ª Toleration çš„å«ä¹‰æ˜¯ï¼Œè¿™ä¸ª Pod èƒ½â€œå®¹å¿â€æ‰€æœ‰é”®å€¼å¯¹ä¸º foo=bar çš„ Taintï¼ˆ operator: â€œEqualâ€ï¼Œâ€œç­‰äºâ€æ“ä½œï¼‰ã€‚\nç°åœ¨å›åˆ°æˆ‘ä»¬å·²ç»æ­å»ºçš„é›†ç¾¤ä¸Šæ¥ã€‚è¿™æ—¶ï¼Œå¦‚æœä½ é€šè¿‡ kubectl describe æ£€æŸ¥ä¸€ä¸‹ Master èŠ‚ç‚¹çš„ Taint å­—æ®µï¼Œå°±ä¼šæœ‰æ‰€å‘ç°äº†ï¼š\n$ kubectl describe node master Name: master Roles: master Taints: node-role.kubernetes.io/master:NoSchedule  å¯ä»¥çœ‹åˆ°ï¼ŒMaster èŠ‚ç‚¹é»˜è®¤è¢«åŠ ä¸Šäº†node-role.kubernetes.io/master:NoScheduleè¿™æ ·ä¸€ä¸ªâ€œæ±¡ç‚¹â€ï¼Œå…¶ä¸­â€œé”®â€æ˜¯node-role.kubernetes.io/masterï¼Œè€Œæ²¡æœ‰æä¾›â€œå€¼â€ã€‚\næ­¤æ—¶ï¼Œä½ å°±éœ€è¦åƒä¸‹é¢è¿™æ ·ç”¨â€œExistsâ€æ“ä½œç¬¦ï¼ˆoperator: â€œExistsâ€ï¼Œâ€œå­˜åœ¨â€å³å¯ï¼‰æ¥è¯´æ˜ï¼Œè¯¥ Pod èƒ½å¤Ÿå®¹å¿æ‰€æœ‰ä»¥ foo ä¸ºé”®çš„ Taintï¼Œæ‰èƒ½è®©è¿™ä¸ª Pod è¿è¡Œåœ¨è¯¥ Master èŠ‚ç‚¹ä¸Šï¼š\napiVersion: v1 kind: Pod ... spec: tolerations: - key: \u0026quot;foo\u0026quot; operator: \u0026quot;Exists\u0026quot; effect: \u0026quot;NoSchedule\u0026quot;  å½“ç„¶ï¼Œå¦‚æœä½ å°±æ˜¯æƒ³è¦ä¸€ä¸ªå•èŠ‚ç‚¹çš„ Kubernetesï¼Œåˆ é™¤è¿™ä¸ª Taint æ‰æ˜¯æ­£ç¡®çš„é€‰æ‹©ï¼š\n$ kubectl taint nodes --all node-role.kubernetes.io/master-  å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨â€œnode-role.kubernetes.io/masterâ€è¿™ä¸ªé”®åé¢åŠ ä¸Šäº†ä¸€ä¸ªçŸ­æ¨ªçº¿â€œ-â€ï¼Œè¿™ä¸ªæ ¼å¼å°±æ„å‘³ç€ç§»é™¤æ‰€æœ‰ä»¥â€œnode-role.kubernetes.io/masterâ€ä¸ºé”®çš„ Taintã€‚åˆ°äº†è¿™ä¸€æ­¥ï¼Œä¸€ä¸ªåŸºæœ¬å®Œæ•´çš„ Kubernetes é›†ç¾¤å°±éƒ¨ç½²å®Œæ¯•äº†ã€‚æ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ï¼Ÿæœ‰äº† kubeadm è¿™æ ·çš„åŸç”Ÿç®¡ç†å·¥å…·ï¼ŒKubernetes çš„éƒ¨ç½²å·²ç»è¢«å¤§å¤§ç®€åŒ–ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œåƒè¯ä¹¦ã€æˆæƒã€å„ä¸ªç»„ä»¶çš„é…ç½®ç­‰éƒ¨ç½²ä¸­æœ€éº»çƒ¦çš„æ“ä½œï¼Œkubeadm éƒ½å·²ç»å¸®ä½ å®Œæˆäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†åœ¨è¿™ä¸ª Kubernetes é›†ç¾¤ä¸Šå®‰è£…ä¸€äº›å…¶ä»–çš„è¾…åŠ©æ’ä»¶ï¼Œæ¯”å¦‚ Dashboard å’Œå­˜å‚¨æ’ä»¶ã€‚\n6. éƒ¨ç½² Dashboard å¯è§†åŒ–æ’ä»¶ åœ¨ Kubernetes ç¤¾åŒºä¸­ï¼Œæœ‰ä¸€ä¸ªå¾ˆå—æ¬¢è¿çš„ Dashboard é¡¹ç›®ï¼Œå®ƒå¯ä»¥ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªå¯è§†åŒ–çš„ Web ç•Œé¢æ¥æŸ¥çœ‹å½“å‰é›†ç¾¤çš„å„ç§ä¿¡æ¯ã€‚æ¯«ä¸æ„å¤–ï¼Œå®ƒçš„éƒ¨ç½²ä¹Ÿç›¸å½“ç®€å•ï¼š\nkubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml  è¿™é‡Œé€šè¿‡æš´éœ²NodePortçš„æ–¹å¼æ¥æä¾›æœåŠ¡ï¼Œéœ€è¦ä¿®æ”¹é»˜è®¤çš„yamlæ–‡ä»¶ï¼š\n... kind: Service apiVersion: v1 metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kubernetes-dashboard spec: type: NodePort ports: - port: 443 targetPort: 8443 nodePort: 30000 selector: k8s-app: kubernetes-dashboard ...  éƒ¨ç½²å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æŸ¥çœ‹ Dashboard å¯¹åº”çš„ Pod çš„çŠ¶æ€äº†ï¼š\n# kubectl get pods -n kubernetes-dashboard NAME READY STATUS RESTARTS AGE dashboard-metrics-scraper-79c5968bdc-wwhns 1/1 Running 0 12m kubernetes-dashboard-9f9799597-pkc76 1/1 Running 0 12m  éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº Dashboard æ˜¯ä¸€ä¸ª Web Serverï¼Œå¾ˆå¤šäººç»å¸¸ä¼šåœ¨è‡ªå·±çš„å…¬æœ‰äº‘ä¸Šæ— æ„åœ°æš´éœ² Dashboard çš„ç«¯å£ï¼Œä»è€Œé€ æˆå®‰å…¨éšæ‚£ã€‚æ‰€ä»¥ï¼Œ1.7 ç‰ˆæœ¬ä¹‹åçš„ Dashboard é¡¹ç›®éƒ¨ç½²å®Œæˆåï¼Œé»˜è®¤åªèƒ½é€šè¿‡ Proxy çš„æ–¹å¼åœ¨æœ¬åœ°è®¿é—®ã€‚å…·ä½“çš„æ“ä½œï¼Œä½ å¯ä»¥æŸ¥çœ‹ Dashboard é¡¹ç›®çš„å®˜æ–¹æ–‡æ¡£ã€‚\nåˆ›å»ºdashboardç®¡ç†å‘˜ [root@fztelecom3-34 dashboard]# vim dashboard-admin.yaml apiVersion: v1 kind: ServiceAccount metadata: labels: k8s-app: kubernetes-dashboard name: dashboard-admin namespace: kubernetes-dashboard [root@fztelecom3-34 dashboard]# kubectl create -f ./dashboard-admin.yaml  6.2. ä¸ºç”¨æˆ·åˆ†é…æƒé™ [root@fztelecom3-34 dashboard]# vim dashboard-admin-bind-cluster-role.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: dashboard-admin-bind-cluster-role labels: k8s-app: kubernetes-dashboard roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: ServiceAccount name: dashboard-admin namespace: kubernetes-dashboard [root@fztelecom3-34 dashboard]# kubectl create -f ./dashboard-admin-bind-cluster-role.yaml  6.3. æŸ¥çœ‹ç™»å½•çš„token [root@fztelecom3-34 dashboard]# kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep dashboard-admin | awk '{print $1}')  æ‰“å¼€nodeip:portè®¿é—®\n7. éƒ¨ç½²å®¹å™¨å­˜å‚¨æ’ä»¶ å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦ç”¨æ•°æ®å·ï¼ˆVolumeï¼‰æŠŠå¤–é¢å®¿ä¸»æœºä¸Šçš„ç›®å½•æˆ–è€…æ–‡ä»¶æŒ‚è½½è¿›å®¹å™¨çš„ Mount Namespace ä¸­ï¼Œä»è€Œè¾¾åˆ°å®¹å™¨å’Œå®¿ä¸»æœºå…±äº«è¿™äº›ç›®å½•æˆ–è€…æ–‡ä»¶çš„ç›®çš„ã€‚å®¹å™¨é‡Œçš„åº”ç”¨ï¼Œä¹Ÿå°±å¯ä»¥åœ¨è¿™äº›æ•°æ®å·ä¸­æ–°å»ºå’Œå†™å…¥æ–‡ä»¶ã€‚\nå¯æ˜¯ï¼Œå¦‚æœä½ åœ¨æŸä¸€å°æœºå™¨ä¸Šå¯åŠ¨çš„ä¸€ä¸ªå®¹å™¨ï¼Œæ˜¾ç„¶æ— æ³•çœ‹åˆ°å…¶ä»–æœºå™¨ä¸Šçš„å®¹å™¨åœ¨å®ƒä»¬çš„æ•°æ®å·é‡Œå†™å…¥çš„æ–‡ä»¶ã€‚è¿™æ˜¯å®¹å™¨æœ€å…¸å‹çš„ç‰¹å¾ä¹‹ä¸€ï¼šæ— çŠ¶æ€ã€‚\nè€Œå®¹å™¨çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå°±æ˜¯ç”¨æ¥ä¿å­˜å®¹å™¨å­˜å‚¨çŠ¶æ€çš„é‡è¦æ‰‹æ®µï¼šå­˜å‚¨æ’ä»¶ä¼šåœ¨å®¹å™¨é‡ŒæŒ‚è½½ä¸€ä¸ªåŸºäºç½‘ç»œæˆ–è€…å…¶ä»–æœºåˆ¶çš„è¿œç¨‹æ•°æ®å·ï¼Œä½¿å¾—åœ¨å®¹å™¨é‡Œåˆ›å»ºçš„æ–‡ä»¶ï¼Œå®é™…ä¸Šæ˜¯ä¿å­˜åœ¨è¿œç¨‹å­˜å‚¨æœåŠ¡å™¨ä¸Šï¼Œæˆ–è€…ä»¥åˆ†å¸ƒå¼çš„æ–¹å¼ä¿å­˜åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œä¸å½“å‰å®¿ä¸»æœºæ²¡æœ‰ä»»ä½•ç»‘å®šå…³ç³»ã€‚è¿™æ ·ï¼Œæ— è®ºä½ åœ¨å…¶ä»–å“ªä¸ªå®¿ä¸»æœºä¸Šå¯åŠ¨æ–°çš„å®¹å™¨ï¼Œéƒ½å¯ä»¥è¯·æ±‚æŒ‚è½½æŒ‡å®šçš„æŒä¹…åŒ–å­˜å‚¨å·ï¼Œä»è€Œè®¿é—®åˆ°æ•°æ®å·é‡Œä¿å­˜çš„å†…å®¹ã€‚è¿™å°±æ˜¯â€œæŒä¹…åŒ–â€çš„å«ä¹‰ã€‚\nç”±äº Kubernetes æœ¬èº«çš„æ¾è€¦åˆè®¾è®¡ï¼Œç»å¤§å¤šæ•°å­˜å‚¨é¡¹ç›®ï¼Œæ¯”å¦‚ Cephã€GlusterFSã€NFS ç­‰ï¼Œéƒ½å¯ä»¥ä¸º Kubernetes æä¾›æŒä¹…åŒ–å­˜å‚¨èƒ½åŠ›ã€‚åœ¨è¿™æ¬¡çš„éƒ¨ç½²å®æˆ˜ä¸­ï¼Œæˆ‘ä¼šé€‰æ‹©éƒ¨ç½²ä¸€ä¸ªå¾ˆé‡è¦çš„ Kubernetes å­˜å‚¨æ’ä»¶é¡¹ç›®ï¼šRookã€‚\nRook é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº Ceph çš„ Kubernetes å­˜å‚¨æ’ä»¶ï¼ˆå®ƒåæœŸä¹Ÿåœ¨åŠ å…¥å¯¹æ›´å¤šå­˜å‚¨å®ç°çš„æ”¯æŒï¼‰ã€‚ä¸è¿‡ï¼Œä¸åŒäºå¯¹ Ceph çš„ç®€å•å°è£…ï¼ŒRook åœ¨è‡ªå·±çš„å®ç°ä¸­åŠ å…¥äº†æ°´å¹³æ‰©å±•ã€è¿ç§»ã€ç¾éš¾å¤‡ä»½ã€ç›‘æ§ç­‰å¤§é‡çš„ä¼ä¸šçº§åŠŸèƒ½ï¼Œä½¿å¾—è¿™ä¸ªé¡¹ç›®å˜æˆäº†ä¸€ä¸ªå®Œæ•´çš„ã€ç”Ÿäº§çº§åˆ«å¯ç”¨çš„å®¹å™¨å­˜å‚¨æ’ä»¶ã€‚\nå¾—ç›Šäºå®¹å™¨åŒ–æŠ€æœ¯ï¼Œç”¨å‡ æ¡æŒ‡ä»¤ï¼ŒRook å°±å¯ä»¥æŠŠå¤æ‚çš„ Ceph å­˜å‚¨åç«¯éƒ¨ç½²èµ·æ¥ï¼š\nhttps://rook.io/docs/rook/v1.5/ceph-quickstart.html#ceph-storage-quickstart\ngit clone --single-branch --branch v1.5.8 https://github.com/rook/rook.git cd rook/cluster/examples/kubernetes/ceph kubectl create -f crds.yaml -f common.yaml -f operator.yaml kubectl create -f cluster.yaml # æ‰€æœ‰çš„é•œåƒï¼Œéœ€è¦é€šè¿‡å¤–ç½‘æ¥æ‹‰å– ceph/ceph:v15.2.9 k8s.gcr.io/sig-storage/csi-node-driver-registrar:v2.0.1 k8s.gcr.io/sig-storage/csi-attacher:v3.0.0 k8s.gcr.io/sig-storage/csi-snapshotter:v3.0.0 k8s.gcr.io/sig-storage/csi-resizer:v1.0.0 k8s.gcr.io/sig-storage/csi-provisioner:v2.0.0 quay.io/cephcsi/cephcsi:v3.2.0 ceph/ceph:v15.2.9  åœ¨éƒ¨ç½²å®Œæˆåï¼Œä½ å°±å¯ä»¥çœ‹åˆ° Rook é¡¹ç›®ä¼šå°†è‡ªå·±çš„ Pod æ”¾ç½®åœ¨ç”±å®ƒè‡ªå·±ç®¡ç†çš„ä¸¤ä¸ª Namespace å½“ä¸­ï¼š\n$ kubectl get pods -n rook-ceph-system NAME READY STATUS RESTARTS AGE rook-ceph-agent-7cv62 1/1 Running 0 15s rook-ceph-operator-78d498c68c-7fj72 1/1 Running 0 44s rook-discover-2ctcv 1/1 Running 0 15s $ kubectl get pods -n rook-ceph NAME READY STATUS RESTARTS AGE rook-ceph-mon0-kxnzh 1/1 Running 0 13s rook-ceph-mon1-7dn2t 1/1 Running 0 2s  è¿™æ ·ï¼Œä¸€ä¸ªåŸºäº Rook æŒä¹…åŒ–å­˜å‚¨é›†ç¾¤å°±ä»¥å®¹å™¨çš„æ–¹å¼è¿è¡Œèµ·æ¥äº†ï¼Œè€Œæ¥ä¸‹æ¥åœ¨ Kubernetes é¡¹ç›®ä¸Šåˆ›å»ºçš„æ‰€æœ‰ Pod å°±èƒ½å¤Ÿé€šè¿‡ Persistent Volumeï¼ˆPVï¼‰å’Œ Persistent Volume Claimï¼ˆPVCï¼‰çš„æ–¹å¼ï¼Œåœ¨å®¹å™¨é‡ŒæŒ‚è½½ç”± Ceph æä¾›çš„æ•°æ®å·äº†ã€‚\nè¿™æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šæœ‰ä¸ªç–‘é—®ï¼šä¸ºä»€ä¹ˆæˆ‘è¦é€‰æ‹© Rook é¡¹ç›®å‘¢ï¼Ÿå…¶å®ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªé¡¹ç›®å¾ˆæœ‰å‰é€”\nå¦‚æœä½ å»ç ”ç©¶ä¸€ä¸‹ Rook é¡¹ç›®çš„å®ç°ï¼Œå°±ä¼šå‘ç°å®ƒå·§å¦™åœ°ä¾èµ–äº† Kubernetes æä¾›çš„ç¼–æ’èƒ½åŠ›ï¼Œåˆç†çš„ä½¿ç”¨äº†å¾ˆå¤šè¯¸å¦‚ Operatorã€CRD ç­‰é‡è¦çš„æ‰©å±•ç‰¹æ€§ï¼ˆè¿™äº›ç‰¹æ€§æˆ‘éƒ½ä¼šåœ¨åé¢çš„æ–‡ç« ä¸­é€ä¸€è®²è§£åˆ°ï¼‰ã€‚è¿™ä½¿å¾— Rook é¡¹ç›®ï¼Œæˆä¸ºäº†ç›®å‰ç¤¾åŒºä¸­åŸºäº Kubernetes API æ„å»ºçš„æœ€å®Œå–„ä¹Ÿæœ€æˆç†Ÿçš„å®¹å™¨å­˜å‚¨æ’ä»¶ã€‚æˆ‘ç›¸ä¿¡ï¼Œè¿™æ ·çš„å‘å±•è·¯çº¿ï¼Œå¾ˆå¿«å°±ä¼šå¾—åˆ°æ•´ä¸ªç¤¾åŒºçš„æ¨å´‡ã€‚\n å¤‡æ³¨ï¼šå…¶å®ï¼Œåœ¨å¾ˆå¤šæ—¶å€™ï¼Œå¤§å®¶è¯´çš„æ‰€è°“â€œäº‘åŸç”Ÿâ€ï¼Œå°±æ˜¯â€œKubernetes åŸç”Ÿâ€çš„æ„æ€ã€‚è€Œåƒ Rookã€Istio è¿™æ ·çš„é¡¹ç›®ï¼Œæ­£æ˜¯è´¯å½»è¿™ä¸ªæ€è·¯çš„å…¸èŒƒã€‚åœ¨æˆ‘ä»¬åé¢è®²è§£äº†å£°æ˜å¼ API ä¹‹åï¼Œç›¸ä¿¡ä½ å¯¹è¿™äº›é¡¹ç›®çš„è®¾è®¡æ€æƒ³ä¼šæœ‰æ›´æ·±åˆ»çš„ä½“ä¼šã€‚\n 8. å¸è½½é›†ç¾¤ 8.1 Master kubeadm reset\nåœæ­¢docker\nsudo systemctl stop docker kubelet  åˆ é™¤ç›¸å…³é…ç½®æ–‡ä»¶ï¼š\nrm -rf ~/.kube/  Node\n[root@test-2 ~]# kubeadm reset [reset] WARNING: Changes made to this host by 'kubeadm init' or 'kubeadm join' will be reverted. [reset] Are you sure you want to proceed? [y/N]: y [preflight] Running pre-flight checks W0305 11:09:18.394192 10467 removeetcdmember.go:79] [reset] No kubeadm config, using etcd pod spec to get data directory [reset] No etcd config found. Assuming external etcd [reset] Please, manually reset etcd to prevent further issues [reset] Stopping the kubelet service [reset] Unmounting mounted directories in \u0026quot;/var/lib/kubelet\u0026quot; [reset] Deleting contents of config directories: [/etc/kubernetes/manifests /etc/kubernetes/pki] [reset] Deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf] [reset] Deleting contents of stateful directories: [/var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni] The reset process does not clean CNI configuration. To do so, you must remove /etc/cni/net.d The reset process does not reset or clean up iptables rules or IPVS tables. If you wish to reset iptables, you must do so manually by using the \u0026quot;iptables\u0026quot; command. If your cluster was setup to utilize IPVS, run ipvsadm --clear (or similar) to reset your system's IPVS tables. The reset process does not clean your kubeconfig files and you must remove them manually. Please, check the contents of the $HOME/.kube/config file.  åœæ­¢ç›¸å…³çš„æœåŠ¡\nsudo systemctl stop docker \u0026amp;\u0026amp; yum remove docker-ce docker-ce-cli containerd.io -y  åˆ é™¤ç›¸å…³é…ç½®æ–‡ä»¶ï¼š\n# æ¸…é™¤ç½‘ç»œæ’ä»¶çš„é…ç½® rm -rf /etc/cni/net.d/ # æ¸…é™¤iptablesè§„åˆ™æˆ–è€… IPVS è¡¨ # æŸ¥çœ‹è§„åˆ™ä»¥numberçš„æ–¹å¼ï¼Œä¸€æ¡ä¸€æ¡çš„å‡ºæ¥ï¼Œç„¶åæˆ‘ä»¬æ ¹æ®å·ç æ¥åˆ é™¤å“ªä¸€æ¡è§„åˆ™ iptables -L INPUT --line-numbers # åˆ é™¤ç¬¬ä¸ƒæ¡è§„åˆ™ iptables -D INPUT 7 # åˆ é™¤æ‰€æœ‰è§„åˆ™ sudo iptables -F \u0026amp;\u0026amp; sudo iptables -X \u0026amp;\u0026amp; sudo iptables -F -t nat \u0026amp;\u0026amp; sudo iptables -X -t nat # å¦‚æœå¼€å¯äº†ipvsï¼Œé€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¸…é™¤ ipvsadm --clear # æ¸…é™¤ç½‘æ¡¥ ip link del weave ip link del docker0 ip link del vethwe-bridge ip link del vxlan-6784 # åˆ é™¤kubeconfigæ–‡ä»¶ rm -rf ~/.kube/  å‚è€ƒæ–‡æ¡£ï¼š [1] kubeadm\n[2] Kuberneteså®æˆ˜æŒ‡å—ï¼ˆä¸‰åå››ï¼‰ï¼š é«˜å¯ç”¨å®‰è£…K8sé›†ç¾¤1.20.x\n[3] kubeadmå®‰è£…æœ€æ–°é«˜å¯ç”¨K8Sé›†ç¾¤v1.20.2\n[4] k8s 1.20.0 åœ¨centos7 ä½¿ç”¨ kubeadm å®‰è£…\n[5] Creating a cluster with kubeadm\n","date":"2021å¹´02æœˆ20æ—¥","permalink":"https://ahamoment.cn/docs/k8s-doc/chapter2/kubeadm/","summary":"1. å‡†å¤‡å·¥ä½œ æœºå™¨é…ç½®  8æ ¸CPUã€8GBå†…å­˜ï¼› 40GBç£ç›˜ centos 7.9 å†…ç½‘äº’åŒ å¤–ç½‘è®¿é—®ä¸å—é™åˆ¶  ç»„ä»¶ä¿¡æ¯    ç»„ä»¶ ç‰ˆæœ¬     ç³»ç»Ÿ Centos 7.","title":"ä½¿ç”¨kubeadm å®‰è£…k8sé›†ç¾¤"},{"contents":"bazel ç®€ä»‹ å®‰è£… centos7ï¼šhttps://docs.bazel.build/versions/4.0.0/install-redhat.html\nStep1ï¼š\nä» Fedora COPR ä¸‹è½½ .repo æ–‡ä»¶å¹¶å¤åˆ¶åˆ° /etc/yum.repos.d/ ç›®å½•ã€‚\nStep2:\nè¿è¡Œ yum install bazel3 å‘½ä»¤å®‰è£…ã€‚\næ•™ç¨‹ java / c++\nå¸¸ç”¨å‘½ä»¤ å‘½ä»¤æ–‡æ¡£ï¼šhttps://docs.bazel.build/versions/master/command-line-reference.html#fetch-options\næŸ¥è¯¢ä¾èµ–å…³ç³»ï¼š\nbazel query --notool_deps --noimplicit_deps \u0026quot;deps(//:ProjectRunner)\u0026quot; --output graph  å¯è§†åŒ–ç½‘ç«™ï¼š\nhttp://www.webgraphviz.com/\nç¼–è¯‘å‘½ä»¤ï¼š\nbazel build //:ProjectRunner  æ¸…é™¤å‘½ä»¤ï¼š\nbazel clean  bazel cleanåœ¨ outputPathå’Œaction_cacheç›®å½•ä¸Šæ‰§è¡Œrm -rfã€‚å®ƒè¿˜ä¼šåˆ é™¤å·¥ä½œç©ºé—´ç¬¦å·é“¾æ¥ã€‚ --expungeé€‰é¡¹å°†æ¸…é™¤æ•´ä¸ªoutputBaseã€‚\nè¾“å‡ºç›®å½• https://docs.bazel.build/versions/master/output_directories.html\n å¿…é¡»ä»åŒ…å«WORKSPACEæ–‡ä»¶çš„ç›®å½•ï¼ˆâ€œå·¥ä½œåŒºç›®å½•â€ï¼‰æˆ–å…¶å­ç›®å½•ä¸­è°ƒç”¨Bazelã€‚å¦‚æœä¸æ˜¯ï¼Œå®ƒå°†æŠ¥å‘Šé”™è¯¯ã€‚ outputRootç›®å½•åœ¨Linuxä¸Šé»˜è®¤ä¸ºã€œ/.cache/bazelï¼Œåœ¨macOSä¸Šé»˜è®¤ä¸º/ private/var/tmpï¼Œåœ¨Windowsä¸Šé»˜è®¤ä¸ºï¼…HOMEï¼…ï¼ˆå¦‚æœè®¾ç½®ï¼‰ï¼Œå¦åˆ™é»˜è®¤ä¸ºï¼…USERPROFILEï¼…ï¼Œå¦åˆ™è°ƒç”¨SHGetKnownFolderPath()çš„ç»“æœè®¾ç½®äº†FOLDERID_Profileæ ‡å¿—ã€‚å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡$ TEST_TMPDIRï¼ˆå¦‚æµ‹è¯•bazelæœ¬èº«ï¼‰ï¼Œåˆ™è¯¥å€¼å°†è¦†ç›–é»˜è®¤å€¼ã€‚ æˆ‘ä»¬å°†Bazelç”¨æˆ·çš„æ„å»ºçŠ¶æ€ä¿ç•™åœ¨outputRoot/_bazel_$USERä¸‹ã€‚è¿™ç§°ä¸º outputUserRoot ç›®å½•ã€‚ åœ¨outputUserRootç›®å½•ä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªinstallBaseç›®å½•ï¼Œå…¶åç§°ä¸º installåŠ ä¸ŠBazelå®‰è£…æ¸…å•çš„MD5å“ˆå¸Œã€‚ åœ¨outputUserRootç›®å½•ä¸‹ï¼Œæˆ‘ä»¬è¿˜åˆ›å»ºäº†ä¸€ä¸ªoutputBaseç›®å½•ï¼Œè¯¥ç›®å½•çš„åç§°æ˜¯å·¥ä½œåŒºç›®å½•çš„è·¯å¾„åçš„MD5å“ˆå¸Œã€‚å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¦‚æœBazelåœ¨å·¥ä½œç©ºé—´ç›®å½•/ home/user/src/my-projectä¸­ï¼ˆæˆ–åœ¨ä¸è¯¥ç›®å½•ç¬¦å·é“¾æ¥çš„ç›®å½•ä¸­ï¼‰è¿è¡Œï¼Œåˆ™æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè¾“å‡ºåŸºæœ¬ç›®å½•ï¼Œåä¸ºï¼š/home/user/.cache/bazel/ _bazel_user/7ffd56a6e4cb724ea575aba15733d113ã€‚ ç”¨æˆ·å¯ä»¥ä½¿ç”¨Bazelçš„--output_baseå¯åŠ¨é€‰é¡¹æ¥è¦†ç›–é»˜è®¤çš„è¾“å‡ºåŸºæœ¬ç›®å½•ã€‚ä¾‹å¦‚ï¼Œbazel --output_base = /tmp/bazel/output build x/y:zã€‚ ç”¨æˆ·è¿˜å¯ä»¥ä½¿ç”¨Bazelçš„--output_user_rootå¯åŠ¨é€‰é¡¹æ¥è¦†ç›–é»˜è®¤çš„å®‰è£…åŸºç¡€ç›®å½•å’Œè¾“å‡ºåŸºç¡€ç›®å½•ã€‚ä¾‹å¦‚ï¼šbazel --output_user_root=/tmp/bazel build x/y:zã€‚  æˆ‘ä»¬åœ¨å·¥ä½œåŒºç›®å½•ä¸­æ”¾ç½®äº†ç¬¦å·é“¾æ¥â€œbazel-â€, â€œbazel-outâ€, â€œbazel-testlogsâ€, and â€œbazel-binâ€ ã€‚è¿™äº›ç¬¦å·é“¾æ¥æŒ‡å‘è¾“å‡ºç›®å½•å†…ç‰¹å®šäºç›®æ ‡çš„ç›®å½•å†…çš„æŸäº›ç›®å½•ã€‚è¿™äº›ç¬¦å·é“¾æ¥åªæ˜¯ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·ï¼Œå› ä¸ºBazelæœ¬èº«å¹¶ä¸ä½¿ç”¨å®ƒä»¬ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä»…åœ¨å·¥ä½œç©ºé—´ç›®å½•å¯å†™æ—¶æ‰è¿™æ ·åšã€‚\n#æœºå™¨ä¸Šæ‰€æœ‰Bazelè¾“å‡ºçš„æ ¹ç›®å½•ï¼šoutputRoot /home/user/.cache/bazel/ #ç»™å®šç”¨æˆ·çš„é¡¶çº§ç›®å½•å–å†³äºç”¨æˆ·åï¼šoutputUserRoot _bazel_$USER/ #Bazelå®‰è£…æ¸…å•çš„å“ˆå¸Œï¼šinstallBase install/ fba9a2c87ee9589d72889caf082f1029/ #åŒ…å«ä»çš„æ•°æ®éƒ¨åˆ†è§£å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œè„šæœ¬é¦–æ¬¡è¿è¡Œæ—¶çš„bazelå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¾‹å¦‚å¸®åŠ©ç¨‹åºè„šæœ¬å’Œä¸»Javaæ–‡ä»¶BazelServer_deploy.jarï¼‰ _embedded_binaries/ #å®¢æˆ·ç«¯å·¥ä½œåŒºç›®å½•çš„å“ˆå¸Œ(/home/some-user/src/my-project):outputBase 7ffd56a6e4cb724ea575aba15733d113/  ç¼“å­˜ å¤–éƒ¨ä¾èµ–ç¼“å­˜ ä½¿ç”¨ bazel fetch //repo:...ï¼Œå¯ä»¥ä»å…·æœ‰å­˜å‚¨åº“åŠŸèƒ½çš„è¿œç¨‹æºï¼ˆä¾‹å¦‚http_archive()æˆ–maven_jar())ä¸‹è½½å¤–éƒ¨å­˜å‚¨åº“å’Œå·¥ä»¶ã€‚æœ‰æ—¶ï¼Œç½‘ç»œè®¿é—®ä¸å¯ç”¨ï¼Œæˆ–è€…é‡æ–°ä¸‹è½½å·²ä¸‹è½½çš„å­˜å‚¨åº“æ˜¯æµªè´¹çš„ã€‚\nä½¿ç”¨ä¸­å¤®ç¼“å­˜ï¼ŒBazelå¯ä»¥åœ¨è®¿é—®ç½‘ç»œä¹‹å‰æ£€æŸ¥å®ƒæ˜¯å¦åŒ…å«è¯·æ±‚çš„å­˜å‚¨åº“ã€‚å…è®¸å¤šä¸ªå·¥ä½œç©ºé—´å…±äº«åŒä¸€å­˜å‚¨åº“é«˜é€Ÿç¼“å­˜ï¼Œå¹¶ä¸”ç¼“å­˜ä¹Ÿæ˜¯å¯ç§»æ¤çš„ã€‚\nç›¸å…³è”çš„issueï¼š\nMake maven_jar and friends smarter by re-using previously fetched artifacts across different projectsï¼ƒ1752\nç¼“å­˜é€‰é¡¹\n--experimental_repository_cache\n--repository_cache\n  å‚è€ƒæ–‡æ¡£ï¼š\nhttps://bazel.build/designs/2016/09/30/repository-cache.html\nhttps://github.com/bazelbuild/bazel/issues/1752\n ","date":"2021å¹´02æœˆ10æ—¥","permalink":"https://ahamoment.cn/posts/tool/tool-bazel/","summary":"bazel ç®€ä»‹ å®‰è£… centos7ï¼šhttps://docs.bazel.build/versions/4.0.0/install-redhat.html\nStep1ï¼š\nä» Fedora COPR ä¸‹è½½ .repo æ–‡ä»¶å¹¶å¤åˆ¶åˆ° /etc/yum.repos.d/ ç›®å½•ã€‚\nStep2:\nè¿è¡Œ yum install bazel3 å‘½ä»¤å®‰è£…ã€‚\næ•™ç¨‹ java / c++","title":"bazel å¤–éƒ¨å­˜å‚¨åº“ç¼“å­˜"},{"contents":"è®¾ç½® JAVA_HOME\nexport JAVA_HOME=\u0026quot;$(dirname $(dirname $(realpath $(which javac))))\u0026quot;  tee Linux teeå‘½ä»¤ç”¨äºè¯»å–æ ‡å‡†è¾“å…¥çš„æ•°æ®ï¼Œå¹¶å°†å…¶å†…å®¹è¾“å‡ºæˆæ–‡ä»¶ã€‚\nè¯­æ³• tee [OPTION]... [FILE]...  è¯´æ˜ -a, --append æ·»åŠ å†…å®¹åˆ°æŒ‡å®šæ–‡ä»¶ï¼Œä¸ä¼šè¦†ç›–æºæ–‡ä»¶å†…å®¹ -i, --ignore-interrupts å¿½ç•¥è¾“å…¥  awk ç”¨æ³•ç¤ºä¾‹\n   å‘½ä»¤ è¯´æ˜     awkÂ '{print}'Â c.txt æ‰“å°æ•´ä¸ªæ–‡ä»¶çš„å†…å®¹   awkÂ '{print $1}'Â c.txt æ‰“å°æ–‡æœ¬çš„ç¬¬ä¸€åˆ—çš„å†…å®¹   awkÂ '{print $1, $2, $3}'Â c.txt æ‰“å°æ–‡æœ¬çš„ç¬¬ä¸€åˆ—åˆ°ç¬¬ä¸‰åˆ—çš„å†…å®¹   awk '{print $1 \u0026quot;\\t\u0026quot; $2 \u0026quot;\\t\u0026quot; $3}' c.txt æ‰“å°æ–‡æœ¬çš„ç¬¬ä¸€åˆ—åˆ°ç¬¬ä¸‰åˆ—çš„å†…å®¹ï¼Œå¹¶æŒ‰ç…§åˆ¶è¡¨ç¬¦é—´éš”   awk '{print NR \u0026quot;\\t\u0026quot; $1 \u0026quot;\\t\u0026quot; $2 \u0026quot;\\t\u0026quot; $3}' c.txt æ‰“å°æ–‡æœ¬çš„ç¬¬ä¸€åˆ—åˆ°ç¬¬ä¸‰åˆ—çš„å†…å®¹å’Œè¡Œå·ï¼Œå¹¶æŒ‰ç…§åˆ¶è¡¨ç¬¦é—´éš”ã€‚ï¼ˆNRï¼šnumber of recordï¼‰                ","date":"2021å¹´02æœˆ10æ—¥","permalink":"https://ahamoment.cn/posts/linux/linux-commands/","summary":"è®¾ç½® JAVA_HOME\nexport JAVA_HOME=\u0026quot;$(dirname $(dirname $(realpath $(which javac))))\u0026quot;  tee Linux teeå‘½ä»¤ç”¨äºè¯»å–æ ‡å‡†è¾“å…¥çš„æ•°æ®ï¼Œå¹¶å°†å…¶å†…å®¹è¾“å‡ºæˆæ–‡ä»¶ã€‚\nè¯­æ³• tee [OPTION]... [FILE]...  è¯´æ˜ -a, --append æ·»åŠ å†…å®¹åˆ°æŒ‡å®šæ–‡ä»¶ï¼Œä¸ä¼šè¦†ç›–æºæ–‡ä»¶å†…å®¹ -i, --ignore-interrupts å¿½ç•¥è¾“å…¥  awk ç”¨æ³•ç¤ºä¾‹","title":"Linux å¸¸ç”¨å‘½ä»¤"},{"contents":"è¿™ä¸¤å¤©åœ¨çœ‹ä¸€ä¸ªå¼€æºçš„å°è¯´ç®¡ç†å¹³å°çš„ä»£ç ï¼Œå‘ç°å®ƒçš„é¡¹ç›®ä½¿ç”¨äº†MyBatis Generatoræ¥ç”Ÿæˆä»£ç æ“ä½œæ•°æ®åº“ï¼ŒèŠ±äº†ä¸¤ä¸ªæ—©ä¸Šçš„æ—¶é—´ç ”ç©¶äº†ä¸€ä¸‹ï¼Œç¡®å®æ˜¯å¾ˆä¸é”™çš„å·¥å…·ï¼Œèƒ½åœ¨æˆ‘ä»¬çš„å¼€å‘è¿‡ç¨‹ä¸­çœæ‰ä¸å°‘çš„å·¥ä½œã€‚\nmybatis generator çš„ä½¿ç”¨å¤§è‡´åˆ†æˆå‡ æ­¥ï¼š\n åˆ›å»ºé…ç½®æ–‡ä»¶ ä¿å­˜é…ç½®æ–‡ä»¶åˆ°æœ¬åœ° æ‰§è¡Œ MyBatis Generator  æˆ‘ä»¬ä»¥ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨ MyBaits Generatorï¼Œé¡¹ç›®çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š\nâ”œâ”€â”€ pom.xml â”œâ”€â”€ README.md â”œâ”€â”€ src â”‚Â â”œâ”€â”€ main â”‚Â â”‚Â â”œâ”€â”€ java â”‚Â â”‚Â â”‚Â â””â”€â”€ com â”‚Â â”‚Â â”‚Â â””â”€â”€ xueqiang â”‚Â â”‚Â â”‚Â â””â”€â”€ footmark â”‚Â â”‚Â â”‚Â â”œâ”€â”€ controller â”‚Â â”‚Â â”‚Â â”œâ”€â”€ FootmarkApplication.java â”‚Â â”‚Â â”‚Â â”œâ”€â”€ model â”‚Â â”‚Â â”‚Â â”œâ”€â”€ service â”‚Â â”‚Â â”‚Â â””â”€â”€ utils â”‚Â â”‚Â â””â”€â”€ resources â”‚Â â”‚Â â”œâ”€â”€ application.properties â”‚Â â”‚Â â”œâ”€â”€ log4j.properties â”‚Â â”‚Â â”œâ”€â”€ mybatis â”‚Â â”‚Â â”‚Â â””â”€â”€ generator-configuration.xml â”‚Â â””â”€â”€ test  1. é…ç½®æ–‡ä»¶ åœ¨ resources/mybatis/ ç›®å½•ä¸‹åˆ›å»ºé…ç½®æ–‡ä»¶ generator-configuration.xmlï¼Œè¯¥æ–‡ä»¶çš„å…·ä½“å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot; encoding=\u0026quot;UTF-8\u0026quot;?\u0026gt; \u0026lt;!DOCTYPE generatorConfiguration PUBLIC \u0026quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN\u0026quot; \u0026quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd\u0026quot;\u0026gt; \u0026lt;generatorConfiguration\u0026gt; \u0026lt;!-- å…¨å±€é…ç½®æ–‡ä»¶ï¼Œä¸‹é¢å¯ä»¥é€šè¿‡å ä½ç¬¦çš„å½¢å¼è¯»å–æ–‡ä»¶ä¸­çš„å€¼ --\u0026gt; \u0026lt;!-- \u0026lt;properties resource=\u0026quot;db.properties\u0026quot;/\u0026gt;--\u0026gt; \u0026lt;!-- ç”¨æ¥æŒ‡å®šæ•°æ®æºé©±åŠ¨åŒ…ï¼ˆjar/zipï¼‰çš„ç»å¯¹è·¯å¾„ --\u0026gt; \u0026lt;classPathEntry location=\u0026quot;D:\\Users\\xueqiang.chen\\.m2\\repository\\mysql\\mysql-connector-java\\8.0.11\\mysql-connector-java-8.0.11.jar\u0026quot;/\u0026gt; \u0026lt;!-- ç”¨äºè¿è¡Œæ—¶çš„è§£ææ¨¡å¼å’Œå…·ä½“çš„ä»£ç ç”Ÿæˆè¡Œä¸ºï¼Œå¯¹åº”org.mybatis.generator.config.Contextç±» --\u0026gt; \u0026lt;!-- id:Contextç¤ºä¾‹çš„å”¯ä¸€IDï¼Œç”¨äºè¾“å‡ºé”™è¯¯ä¿¡æ¯æ—¶å€™ä½œä¸ºå”¯ä¸€æ ‡è®° targetRuntime:ç”¨äºæ‰§è¡Œä»£ç ç”Ÿæˆæ¨¡å¼ã€‚å¯é€‰å€¼ï¼š MyBatis3DynamicSqlï¼šåŠ¨æ€SQL MyBatis3Kotlinï¼šåŸºäºKotlinç”Ÿæˆ MyBatis3ï¼šæä¾›åŸºæœ¬çš„åŸºäºåŠ¨æ€SQLçš„CRUDæ–¹æ³•å’ŒXXXByExampleæ–¹æ³•ï¼Œä¼šç”ŸæˆXMLæ˜ å°„æ–‡ä»¶ MyBatis3Simpleï¼šæä¾›åŸºæœ¬çš„åŸºäºåŠ¨æ€SQLçš„CRUDæ–¹æ³•ï¼Œä¼šç”ŸæˆXMLæ˜ å°„æ–‡ä»¶ MyBatis3DynamicSqlV1ï¼šå·²ç»è¿‡æ—¶ï¼Œä¸æ¨èä½¿ç”¨ defaultModeType:æ§åˆ¶Domainç±»çš„ç”Ÿæˆè¡Œä¸ºã€‚æ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½®ï¼Œå¯é€‰å€¼ï¼š conditionalï¼šé»˜è®¤å€¼ï¼Œç±»ä¼¼hierarchicalï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªä¸»é”®çš„æ—¶å€™ä¼šåˆå¹¶æ‰€æœ‰å±æ€§ç”Ÿæˆåœ¨åŒä¸€ä¸ªç±»ã€‚ flatï¼šæ‰€æœ‰å†…å®¹å…¨éƒ¨ç”Ÿæˆåœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚ hierarchicalï¼šé”®ç”Ÿæˆä¸€ä¸ªXXKeyå¯¹è±¡ï¼ŒBlobç­‰å•ç‹¬ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä»–ç®€å•å±æ€§åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ --\u0026gt; \u0026lt;!-- contextçš„å†…å®¹éœ€è¦æŒ‰ç…§é¡ºåºæ’åˆ—,å¦åˆ™ä¼šæŠ¥é”™ï¼š property-\u0026gt;plugin-\u0026gt;commentGenerator-\u0026gt;connectionFactory|jdbcConnection-\u0026gt;javaTypeResolver-\u0026gt;javaModelGenerator-\u0026gt;sqlMapGenerator-\u0026gt;javaClientGenerator-\u0026gt;table --\u0026gt; \u0026lt;context id=\u0026quot;default\u0026quot; targetRuntime=\u0026quot;MyBatis3DynamicSql\u0026quot;\u0026gt; \u0026lt;property name=\u0026quot;javaFileEncoding\u0026quot; value=\u0026quot;UTF-8\u0026quot;/\u0026gt; \u0026lt;!-- \u0026lt;plugin type=\u0026quot;org.mybatis.generator.plugins.SerializablePlugin\u0026quot;/\u0026gt;--\u0026gt; \u0026lt;!--ç”¨äºæ§åˆ¶ç”Ÿæˆçš„å®ä½“çš„æ³¨é‡Šå†…å®¹ suppressAllComments:æ˜¯å¦ç”Ÿæˆæ³¨é‡Š suppressDate:æ˜¯å¦åœ¨æ³¨é‡Šä¸­æ·»åŠ ç”Ÿæˆçš„æ—¶é—´æˆ³ dateFormat:é…åˆsuppressDateä½¿ç”¨ï¼ŒæŒ‡å®šè¾“å‡ºæ—¶é—´æˆ³çš„æ ¼å¼ addRemarkComments:æ˜¯å¦è¾“å‡ºè¡¨å’Œåˆ—çš„Commentä¿¡æ¯--\u0026gt; \u0026lt;commentGenerator\u0026gt; \u0026lt;property name=\u0026quot;suppressDate\u0026quot; value=\u0026quot;true\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;suppressAllComments\u0026quot; value=\u0026quot;true\u0026quot;/\u0026gt; \u0026lt;/commentGenerator\u0026gt; \u0026lt;!--ç”¨äºæŒ‡å®šæ•°æ®æºçš„è¿æ¥ä¿¡æ¯ï¼Œå¯¹åº”çš„ç±»ä¸ºorg.mybatis.generator.config.JDBCConnectionConfiguration driverClass:æ•°æ®æºé©±åŠ¨çš„å…¨ç±»å connectionURL:JDBCçš„è¿æ¥URL userId:ç”¨æˆ·å password:å¯†ç --\u0026gt; \u0026lt;jdbcConnection driverClass=\u0026quot;com.mysql.jdbc.Driver\u0026quot; connectionURL=\u0026quot;jdbc:mysql://127.0.0.1:3306/footmark\u0026quot; userId=\u0026quot;root\u0026quot; password=\u0026quot;mysql\u0026quot;\u0026gt; \u0026lt;/jdbcConnection\u0026gt; \u0026lt;!--ç”¨äºè§£æå’Œè®¡ç®—æ•°æ®åº“åˆ—ç±»å‹å’ŒJavaç±»å‹çš„æ˜ å°„å…³ç³»ï¼Œè¯¥æ ‡ç­¾åªåŒ…å«ä¸€ä¸ªtypeå±æ€§ï¼Œç”¨äºæŒ‡å®šorg.mybatis.generator.api.JavaTypeResolveræ¥å£çš„å®ç°ç±» forceBigDecimals:æ˜¯å¦å¼ºåˆ¶æŠŠæ‰€æœ‰çš„æ•°å­—ç±»å‹å¼ºåˆ¶ä½¿ç”¨java.math.BigDecimalç±»å‹è¡¨ç¤º useJSR310Types:æ˜¯å¦æ”¯æŒJSR310ï¼Œä¸»è¦æ˜¯JSR310çš„æ–°æ—¥æœŸç±»å‹ æ•°æ®åº“JDBCç±»å‹ Javaç±»å‹ DATE\tjava.time.LocalDate TIME\tjava.time.LocalTime TIMESTAMP\tjava.time.LocalDateTime TIME_WITH_TIMEZONE\tjava.time.OffsetTime TIMESTAMP_WITH_TIMEZONE\tjava.time.OffsetDateTime--\u0026gt; \u0026lt;javaTypeResolver\u0026gt; \u0026lt;!-- ä¸å¼ºåˆ¶æŠŠæ‰€æœ‰çš„æ•°å­—ç±»å‹è½¬åŒ–ä¸ºBigDecimal --\u0026gt; \u0026lt;property name=\u0026quot;forceBigDecimals\u0026quot; value=\u0026quot;false\u0026quot; /\u0026gt; \u0026lt;/javaTypeResolver\u0026gt; \u0026lt;!--ä¸»è¦ç”¨äºæ§åˆ¶å®ä½“ï¼ˆModelï¼‰ç±»çš„ä»£ç ç”Ÿæˆè¡Œä¸º targetPackage:ç”Ÿæˆçš„å®ä½“ç±»çš„åŒ…å targetProject:ç”Ÿæˆçš„å®ä½“ç±»æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½® property: constructorBased:æ˜¯å¦ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æ‰€æœ‰å­—æ®µå±æ€§çš„æ„é€ å‡½æ•° enableSubPackages:æ˜¯å¦å…è®¸é€šè¿‡Schemaç”Ÿæˆå­åŒ… exampleTargetPackage:ç”Ÿæˆçš„ä¼´éšå®ä½“ç±»çš„Exampleç±»çš„åŒ…å exampleTargetProject:ç”Ÿæˆçš„ä¼´éšå®ä½“ç±»çš„Exampleç±»æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½® immutable:æ˜¯å¦ä¸å¯å˜ rootClass:ä¸ºç”Ÿæˆçš„å®ä½“ç±»æ·»åŠ çˆ¶ç±» trimStrings:Setteræ–¹æ³•æ˜¯å¦å¯¹å­—ç¬¦ä¸²ç±»å‹è¿›è¡Œä¸€æ¬¡trimæ“ä½œ--\u0026gt; \u0026lt;javaModelGenerator targetPackage=\u0026quot;com.xueqiang.footmark.model.entity\u0026quot; targetProject=\u0026quot;src/main/java\u0026quot;\u0026gt; \u0026lt;property name=\u0026quot;enableSubPackages\u0026quot; value=\u0026quot;true\u0026quot; /\u0026gt; \u0026lt;property name=\u0026quot;trimStrings\u0026quot; value=\u0026quot;true\u0026quot; /\u0026gt; \u0026lt;/javaModelGenerator\u0026gt; \u0026lt;!--ä¸»è¦ç”¨äºæ§åˆ¶XMLæ˜ å°„æ–‡ä»¶çš„ä»£ç ç”Ÿæˆè¡Œä¸º targetPackage:ç”Ÿæˆçš„XMLæ˜ å°„æ–‡ä»¶çš„åŒ…å targetProject:ç”Ÿæˆçš„XMLæ˜ å°„æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½®,ä¾‹å¦‚:src/main/resources property: enableSubPackages:æ˜¯å¦å…è®¸é€šè¿‡Schemaç”Ÿæˆå­åŒ…--\u0026gt; \u0026lt;sqlMapGenerator targetPackage=\u0026quot;mapper\u0026quot; targetProject=\u0026quot;src/main/resources\u0026quot;\u0026gt; \u0026lt;property name=\u0026quot;enableSubPackages\u0026quot; value=\u0026quot;true\u0026quot; /\u0026gt; \u0026lt;/sqlMapGenerator\u0026gt; \u0026lt;!--ä¸»è¦ç”¨äºæ§åˆ¶Mapperæ¥å£çš„ä»£ç ç”Ÿæˆè¡Œä¸º type:Mapperæ¥å£ç”Ÿæˆç­–ç•¥.(\u0026lt;context\u0026gt;æ ‡ç­¾çš„targetRuntimeå±æ€§ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶æ­¤å±æ€§é…ç½®å¿½ç•¥) ANNOTATEDMAPPER:Mapperæ¥å£ç”Ÿæˆçš„æ—¶å€™ä¾èµ–äºæ³¨è§£å’ŒSqlProvidersï¼ˆä¹Ÿå°±æ˜¯çº¯æ³¨è§£å®ç°ï¼‰ï¼Œä¸ä¼šç”ŸæˆXMLæ˜ å°„æ–‡ä»¶ã€‚ XMLMAPPER:Mapperæ¥å£ç”Ÿæˆæ¥å£æ–¹æ³•ï¼Œå¯¹åº”çš„å®ç°ä»£ç ç”Ÿæˆåœ¨XMLæ˜ å°„æ–‡ä»¶ä¸­ï¼ˆä¹Ÿå°±æ˜¯çº¯æ˜ å°„æ–‡ä»¶å®ç°ï¼‰ MIXEDMAPPER:Mapperæ¥å£ç”Ÿæˆçš„æ—¶å€™å¤æ‚çš„æ–¹æ³•å®ç°ç”Ÿæˆåœ¨XMLæ˜ å°„æ–‡ä»¶ä¸­ï¼Œè€Œç®€å•çš„å®ç°é€šè¿‡æ³¨è§£å’ŒSqlProviderså®ç°ï¼ˆä¹Ÿå°±æ˜¯æ³¨è§£å’Œæ˜ å°„æ–‡ä»¶æ··åˆå®ç°ï¼‰ã€‚ targetPackage:ç”Ÿæˆçš„Mapperæ¥å£çš„åŒ…å targetProject:ç”Ÿæˆçš„Mapperæ¥å£æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½®--\u0026gt; \u0026lt;!--propertyå±æ€§ï¼š enableSubPackages:æ˜¯å¦å…è®¸é€šè¿‡Schemaç”Ÿæˆå­åŒ… useLegacyBuilder:æ˜¯å¦é€šè¿‡SQL Builderç”ŸæˆåŠ¨æ€SQL rootInterface:ä¸ºç”Ÿæˆçš„Mapperæ¥å£æ·»åŠ çˆ¶æ¥å£--\u0026gt; \u0026lt;javaClientGenerator type=\u0026quot;ANNOTATEDMAPPER\u0026quot; targetPackage=\u0026quot;com.xueqiang.footmark.model.mapper\u0026quot; targetProject=\u0026quot;src/main/java\u0026quot;\u0026gt; \u0026lt;property name=\u0026quot;enableSubPackages\u0026quot; value=\u0026quot;true\u0026quot; /\u0026gt; \u0026lt;/javaClientGenerator\u0026gt; \u0026lt;!--enableInsert åŠ¨æ€SQLæä¾›ç±»SqlProviderçš„ç±»åç§° enableSelectByPrimaryKey æ˜¯å¦å…è®¸ç”ŸæˆselectByPrimaryKeyæ–¹æ³• enableSelectByExample æ˜¯å¦å…è®¸ç”ŸæˆselectByExampleæ–¹æ³• enableUpdateByPrimaryKey æ˜¯å¦å…è®¸ç”ŸæˆupdateByPrimaryKeyæ–¹æ³• enableDeleteByPrimaryKey æ˜¯å¦å…è®¸ç”ŸæˆdeleteByPrimaryKeyæ–¹æ³• enableDeleteByExample æ˜¯å¦å…è®¸ç”ŸæˆdeleteByExampleæ–¹æ³• enableCountByExample æ˜¯å¦å…è®¸ç”ŸæˆcountByExampleæ–¹æ³• enableUpdateByExample æ˜¯å¦å…è®¸ç”ŸæˆupdateByExampleæ–¹æ³• selectByPrimaryKeyQueryId valueæŒ‡å®šå¯¹åº”çš„ä¸»é”®åˆ—æä¾›åˆ—è¡¨æŸ¥è¯¢åŠŸèƒ½ selectByExampleQueryId valueæŒ‡å®šå¯¹åº”çš„æŸ¥è¯¢IDæä¾›åˆ—è¡¨æŸ¥è¯¢åŠŸèƒ½--\u0026gt; \u0026lt;table tableName=\u0026quot;t_order\u0026quot; enableCountByExample=\u0026quot;false\u0026quot; enableDeleteByExample=\u0026quot;false\u0026quot; enableSelectByExample=\u0026quot;true\u0026quot; enableUpdateByExample=\u0026quot;false\u0026quot; domainObjectName=\u0026quot;Order\u0026quot; mapperName=\u0026quot;OrderMapper\u0026quot;\u0026gt; \u0026lt;generatedKey column=\u0026quot;id\u0026quot; sqlStatement=\u0026quot;MySql\u0026quot;/\u0026gt; \u0026lt;/table\u0026gt; \u0026lt;/context\u0026gt; \u0026lt;/generatorConfiguration\u0026gt;  ä¸Šé¢çš„è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸»è¦æ˜¯æŒ‰t_orderè¿™ä¸ªæ•°æ®åº“è¡¨çš„å±æ€§ç”Ÿæˆæ•´ä¸ª xml é…ç½®æ–‡ä»¶çš„å…ƒç´ æ„ä¹‰æˆ‘ä»¬å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£çš„ä»‹ç»ã€‚\n","date":"2021å¹´01æœˆ26æ—¥","permalink":"https://ahamoment.cn/posts/java/framework-mybatis-generator/","summary":"","title":"MyBatis Generator ä½¿ç”¨ä¸åŸç†(ä¸Š)"},{"contents":"1. Docker é—®é¢˜ 1.1. docker åç«¯å­˜å‚¨é©±åŠ¨ devicemapperã€overlay å‡ ç§çš„åŒºåˆ«ï¼Ÿ åˆšå¼€å§‹æ‹¿åˆ°è¿™é“é¢˜æˆ‘æœ‰ç‚¹è’™ï¼Œå› ä¸ºæˆ‘åªçŸ¥é“ç›®å‰æˆ‘ä»¬ç”¨çš„æ˜¯vg-pool devicemapper æ¥å­˜å‚¨é•œåƒå’Œå®¹å™¨ï¼Œåæ¥é¢è¯•å®˜é—®æˆ‘é•œåƒåˆ†å±‚çš„æŠ€æœ¯çŸ¥é“å—ï¼Ÿæˆ‘è¯´çŸ¥é“ï¼Œå°±æ˜¯**è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œå¤šå±‚æ–‡ä»¶ç³»ç»Ÿè”åˆç»„æˆä¸€ä¸ªç»Ÿä¸€çš„æ–‡ä»¶ç³»ç»Ÿè§†è§’ï¼Œå½“éœ€è¦ä¿®æ”¹æ–‡ä»¶æ—¶é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼ˆCopyWï¼‰çš„æŠ€æœ¯ä»ä¸Šå¾€ä¸‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°ä¹‹åå¤åˆ¶åˆ°å¯å†™çš„å®¹å™¨å±‚ï¼Œè¿›è¡Œä¿®æ”¹å¹¶ä¿å­˜è‡³å®¹å™¨å±‚ï¼Œ**è¯´å®Œä¹‹åé¢è¯•å®˜å†é—®æˆ‘ï¼Œé‚£æ¯æ¬¡ä¿®æ”¹æ–‡ä»¶éƒ½éœ€è¦ä»ä¸Šå¾€ä¸‹æŸ¥æ‰¾ï¼Œå±‚æ•°åˆé‚£ä¹ˆå¤šï¼Œæ€§èƒ½æ˜¯å¦æ¯”è¾ƒå·®ï¼Œç°åœ¨æ‰ååº”å›æ¥ï¼ŒåŸå…ˆé¢è¯•å®˜æƒ³è€ƒå¯Ÿæˆ‘aufsã€overlay æˆ–è€…æ˜¯ devicemapper ç­‰å‡ ç§å­˜å‚¨é©±åŠ¨çš„åŒºåˆ«ã€‚\nAUFS\nAUFS ï¼ˆAnother UnionFSï¼‰æ˜¯ä¸€ç§ Union FSï¼Œæ˜¯æ–‡ä»¶çº§çš„å­˜å‚¨é©±åŠ¨ï¼ŒAUFS ç®€å•ç†è§£å°±æ˜¯å°†å¤šå±‚çš„æ–‡ä»¶ç³»ç»Ÿè”åˆæŒ‚è½½æˆç»Ÿä¸€çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ç§æ–‡ä»¶ç³»ç»Ÿå¯ä»¥ä¸€å±‚ä¸€å±‚åœ°å åŠ ä¿®æ”¹æ–‡ä»¶ï¼Œåªæœ‰æœ€ä¸Šå±‚æ˜¯å¯å†™å±‚ï¼Œåº•ä¸‹æ‰€æœ‰å±‚éƒ½æ˜¯åªè¯»å±‚ï¼Œå¯¹åº”åˆ° Dockerï¼Œæœ€ä¸Šå±‚å°±æ˜¯ container å±‚ï¼Œåº•å±‚å°±æ˜¯ image å±‚ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nOverlay\nOverlay ä¹Ÿæ˜¯ä¸€ç§ Union FSï¼Œå’Œ AUFS å¤šå±‚ç›¸æ¯”ï¼ŒOverlay åªæœ‰ä¸¤å±‚ï¼šä¸€ä¸ª upper æ–‡ä»¶ç³»ç»Ÿå’Œä¸€ä¸ª lower æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ†åˆ«ä»£è¡¨ Docker çš„å®¹å™¨å±‚ï¼ˆupperï¼‰å’Œé•œåƒå±‚ï¼ˆlowerï¼‰ã€‚å½“éœ€è¦ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œä½¿ç”¨ CopyW å°†æ–‡ä»¶ä»åªè¯»çš„ lower å±‚å¤åˆ¶åˆ°å¯å†™å±‚ upperï¼Œç»“æœä¹Ÿä¿å­˜åœ¨ upper å±‚ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nDevicemapper\nDevice mapperï¼Œæä¾›çš„æ˜¯ä¸€ç§ä»é€»è¾‘è®¾å¤‡åˆ°ç‰©ç†è®¾å¤‡çš„æ˜ å°„æ¡†æ¶æœºåˆ¶ï¼Œå‰é¢è®²çš„ AUFS å’Œ OverlayFS éƒ½æ˜¯æ–‡ä»¶çº§å­˜å‚¨ï¼Œè€Œ Device mapper æ˜¯å—çº§å­˜å‚¨ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯ç›´æ¥å¯¹å—è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯æ–‡ä»¶ã€‚Device mapper é©±åŠ¨ä¼šå…ˆåœ¨å—è®¾å¤‡ä¸Šåˆ›å»ºä¸€ä¸ªèµ„æºæ± ï¼Œç„¶ååœ¨èµ„æºæ± ä¸Šåˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬è®¾å¤‡ï¼Œæ‰€æœ‰é•œåƒéƒ½æ˜¯è¿™ä¸ªåŸºæœ¬è®¾å¤‡çš„å¿«ç…§ï¼Œè€Œå®¹å™¨åˆ™æ˜¯é•œåƒçš„å¿«ç…§ã€‚æ‰€ä»¥åœ¨å®¹å™¨é‡Œçœ‹åˆ°æ–‡ä»¶ç³»ç»Ÿæ˜¯èµ„æºæ± ä¸ŠåŸºæœ¬è®¾å¤‡çš„æ–‡ä»¶ç³»ç»Ÿçš„å¿«ç…§ã€‚å½“è¦å†™å…¥ä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ï¼Œåœ¨å®¹å™¨çš„é•œåƒå†…ä¸ºå…¶åˆ†é…æ–°çš„å—å¹¶å†™å…¥æ•°æ®ï¼Œè¿™ä¸ªå«ç”¨æ—¶åˆ†é…ã€‚å½“è¦ä¿®æ”¹å·²æœ‰æ–‡ä»¶æ—¶ï¼Œå†ä½¿ç”¨CoWä¸ºå®¹å™¨å¿«ç…§åˆ†é…å—ç©ºé—´ï¼Œå°†è¦ä¿®æ”¹çš„æ•°æ®å¤åˆ¶åˆ°åœ¨å®¹å™¨å¿«ç…§ä¸­æ–°çš„å—é‡Œå†è¿›è¡Œä¿®æ”¹ã€‚Devicemapper é©±åŠ¨é»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ª100G çš„æ–‡ä»¶åŒ…å«é•œåƒå’Œå®¹å™¨ã€‚æ¯ä¸€ä¸ªå®¹å™¨è¢«é™åˆ¶åœ¨ 10G å¤§å°çš„å·å†…ï¼Œå¯ä»¥è‡ªå·±é…ç½®è°ƒæ•´ã€‚ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nè¯¦ç»†å†…å®¹è¯·å‚è€ƒï¼š\n  Docker äº”ç§å­˜å‚¨é©±åŠ¨\n  æ·±å…¥äº†è§£ Docker å­˜å‚¨é©±åŠ¨\n  1.2. å®¹å™¨éš”ç¦»ä¸å½»åº•ï¼ŒMemory å’Œ CPU éš”ç¦»ä¸å½»åº•ï¼Œæ€ä¹ˆå¤„ç†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ ç”±äº /proc æ–‡ä»¶ç³»ç»Ÿæ˜¯ä»¥åªè¯»çš„æ–¹å¼æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ï¼Œæ‰€ä»¥åœ¨å®¹å™¨å†…çœ‹åˆ°çš„éƒ½æ˜¯å®¿ä¸»æœºçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ CPU å’Œ Memoryï¼Œdocker æ˜¯ä»¥ cgroups æ¥è¿›è¡Œèµ„æºé™åˆ¶çš„ï¼Œè€Œ jdk1.9 ä»¥ä¸‹ç‰ˆæœ¬ç›®å‰æ— æ³•è‡ªåŠ¨è¯†åˆ«å®¹å™¨çš„èµ„æºé…é¢ï¼Œ1.9ä»¥ä¸Šç‰ˆæœ¬ä¼šè‡ªåŠ¨è¯†åˆ«å’Œæ­£å¸¸è¯»å– cgroups ä¸­ä¸ºå®¹å™¨é™åˆ¶çš„èµ„æºå¤§å°ã€‚\nMemory éš”ç¦»ä¸å½»åº•\n Docker é€šè¿‡ cgroups å®Œæˆå¯¹å†…å­˜çš„é™åˆ¶ï¼Œè€Œ /proc æ–‡ä»¶ç›®å½•æ˜¯ä»¥åªè¯»çš„å½¢å¼æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œç”±äºé»˜è®¤æƒ…å†µä¸‹ï¼ŒJava å‹æ ¹å°±çœ‹ä¸åˆ° cgroups é™åˆ¶çš„å†…å®¹çš„å¤§å°ï¼Œè€Œé»˜è®¤ä½¿ç”¨ /proc/meminfo ä¸­çš„ä¿¡æ¯ä½œä¸ºå†…å­˜ä¿¡æ¯è¿›è¡Œå¯åŠ¨ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒJVM åˆå§‹å †å¤§å°ä¸ºå†…å­˜æ€»é‡çš„ 1/4ï¼Œè¿™ç§æƒ…å†µä¼šå¯¼è‡´ï¼Œå¦‚æœå®¹å™¨åˆ†é…çš„å†…å­˜å°äº JVM çš„å†…å­˜ï¼Œ JVM è¿›ç¨‹ä¼šè¢« linux killer æ€æ­»ã€‚\né‚£ä¹ˆç›®å‰æœ‰å‡ ç§è§£å†³æ–¹å¼ï¼š\nï¼ˆ1ï¼‰å‡çº§ JDK ç‰ˆæœ¬åˆ°1.9ä»¥ä¸Šï¼Œè®© JVM èƒ½è‡ªåŠ¨è¯†åˆ« cgroups å¯¹å®¹å™¨çš„èµ„æºé™åˆ¶ï¼Œä»è€Œè‡ªåŠ¨è°ƒæ•´ JVM çš„å‚æ•°å¹¶å¯åŠ¨ JVM è¿›ç¨‹ã€‚\nï¼ˆ2ï¼‰å¯¹äºè¾ƒä½ç‰ˆæœ¬çš„JDKï¼Œä¸€å®šè¦è®¾ç½® JVM åˆå§‹å †å¤§å°ï¼Œå¹¶ä¸”JVM çš„æœ€å¤§å †å†…å­˜ä¸èƒ½è¶…è¿‡å®¹å™¨çš„æœ€å¤§å†…å­˜å€¼ï¼Œæ­£å¸¸ç†è®ºå€¼åº”è¯¥æ˜¯ï¼šå®¹å™¨ limit-memory = JVM æœ€å¤§å †å†…å­˜ + 750MBã€‚\nï¼ˆ3ï¼‰ä½¿ç”¨ lxcfs ï¼Œè¿™æ˜¯ä¸€ç§ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨æ¥æ”¯æŒLXC å®¹å™¨ï¼Œlxcfs é€šè¿‡ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨å®¹å™¨ä¸­æä¾›ä¸‹åˆ— procfs çš„æ–‡ä»¶ï¼Œå¯åŠ¨æ—¶ï¼ŒæŠŠå®¿ä¸»æœºå¯¹åº”çš„ç›®å½• /var/lib/lxcfu/proc/meminfo æ–‡ä»¶æŒ‚è½½åˆ° Docker å®¹å™¨çš„ /proc/meminfo ä½ç½®åï¼Œå®¹å™¨ä¸­è¿›ç¨‹ï¼ˆJVMï¼‰è¯»å–ç›¸åº”æ–‡ä»¶å†…å®¹æ—¶ï¼Œlxcfs çš„ fuse å°†ä¼šä»å®¹å™¨å¯¹åº”çš„ cgroups ä¸­è¯»å–æ­£ç¡®çš„å†…å­˜é™åˆ¶ï¼Œä»è€Œè·å¾—æ­£ç¡®çš„èµ„æºçº¦æŸè®¾å®šã€‚\nCPU éš”ç¦»ä¸å½»åº•\n JVM GC ï¼ˆåƒåœ¾å›æ”¶ï¼‰å¯¹äº java ç¨‹åºæ‰§è¡Œæ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ï¼Œé»˜è®¤çš„ JVM ä½¿ç”¨å¦‚ä¸‹å…¬å¼ï¼š ParallelGCThreads = ( ncpu \u0026lt;= 8 ) ? ncpuï¼š3 + ï¼ˆncpu * 5ï¼‰/ 8 æ¥è®¡ç®—å¹¶è¡Œ GC çš„çº¿ç¨‹æ•°ï¼Œä½†æ˜¯åœ¨å®¹å™¨é‡Œé¢ï¼Œncpu è·å–çš„å°±æ˜¯æ‰€åœ¨å®¿ä¸»æœºçš„ cpu ä¸ªæ•°ï¼Œè¿™ä¼šå¯¼è‡´ JVM å¯åŠ¨è¿‡å¤šçš„ GC çº¿ç¨‹ï¼Œç›´æ¥çš„ç»“æœå°±æ˜¯ GC çš„æ€§èƒ½ä¸‹é™ï¼Œjava æœåŠ¡çš„æ„Ÿå—å°±æ˜¯ï¼šå»¶æ—¶å¢åŠ ï¼Œ TPS ååº¦é‡ä¸‹é™ï¼Œé’ˆå¯¹è¿™ç§é—®é¢˜ï¼Œä¹Ÿæœ‰ä»¥ä¸‹å‡ ç§è§£å†³æ–¹æ¡ˆï¼š\nï¼ˆ1ï¼‰æ˜¾ç¤ºä¼ é€’ JVM å¯åŠ¨å‚æ•°ï¼šâ€œ-XX: ParallelGCThreads\u0026quot; å‘Šè¯‰ JVM åº”è¯¥å¯åŠ¨å¤šå°‘ä¸ªå¹¶è¡Œ GC çº¿ç¨‹ï¼Œç¼ºç‚¹æ˜¯éœ€è¦ä¸šåŠ¡æ„ŸçŸ¥ï¼Œè€Œä¸”éœ€è¦ä¸ºä¸åŒé…ç½®çš„å®¹å™¨ä¼ é€’ä¸åŒçš„ JVM å‚æ•°ã€‚\nï¼ˆ2ï¼‰åœ¨å®¹å™¨å†…ä½¿ç”¨ Hack è¿‡çš„ glibc ï¼Œä½¿ JVM é€šè¿‡ sysconf ç³»ç»Ÿè°ƒç”¨èƒ½æ­£ç¡®è·å–å®¹å™¨å†… CPU èµ„æºæ ¸æ•°ï¼Œä¼˜ç‚¹æ˜¯ä¸šåŠ¡æ— æ„ŸçŸ¥ï¼Œå¹¶ä¸”èƒ½è‡ªåŠ¨é€‚é…ä¸åŒé…ç½®çš„å®¹å™¨ï¼Œç¼ºç‚¹æ˜¯æœ‰ä¸€å®šçš„ç»´æŠ¤æˆæœ¬ã€‚å…·ä½“å‚è€ƒï¼šå®¹å™¨å†…è·å– CPU æ ¸æ•°é—®é¢˜\n1.3. ä»‹ç»ä¸€ä¸‹å®¹å™¨å®ç°çš„åŸºç¡€: Namespace and Cgroups ä¸»è¦ç”¨åˆ°äº†Linuxçš„ä¸¤ç§æŠ€æœ¯ï¼šNamespace å’Œ CGroupã€‚Namespace åšéš”ç¦»ï¼ŒCgroups åšé™åˆ¶ã€‚\nNamespace æŠ€æœ¯å®é™…ä¸Šä¿®æ”¹äº†åº”ç”¨è¿›ç¨‹çœ‹å¾…æ•´ä¸ªè®¡ç®—æœºâ€œè§†å›¾â€ï¼Œå³å®ƒçš„â€œè§†çº¿â€è¢«æ“ä½œç³»ç»Ÿåšäº†é™åˆ¶ï¼Œåªèƒ½â€œçœ‹åˆ°â€æŸäº›æŒ‡å®šçš„å†…å®¹ã€‚åœ¨åˆ›å»ºè¿›ç¨‹çš„æ—¶å€™ï¼ŒLinux ç³»ç»Ÿæä¾›äº†Mountã€UTSã€IPCã€Networkå’ŒUserè¿™äº›Namespaceï¼Œç”¨æ¥å¯¹å„ç§ä¸åŒçš„è¿›ç¨‹ä¸Šä¸‹æ–‡è¿›è¡Œéš”ç¦»æ“ä½œã€‚æ‰€ä»¥ï¼ŒDocker å®¹å™¨å®é™…ä¸Šæ˜¯åœ¨åˆ›å»ºå®¹å™¨è¿›ç¨‹æ—¶ï¼ŒæŒ‡å®šäº†è¿™ä¸ªè¿›ç¨‹æ‰€éœ€è¦å¯ç”¨çš„ä¸€ç»„ Namespace å‚æ•°ã€‚è¿™æ ·ï¼Œå®¹å™¨å°±åªèƒ½â€œçœ‹â€åˆ°å½“å‰ Namespace æ‰€é™å®šçš„èµ„æºã€æ–‡ä»¶ã€è®¾å¤‡ã€çŠ¶æ€ï¼Œæˆ–è€…é…ç½®ã€‚è€Œå¯¹äºå®¿ä¸»æœºä»¥åŠå…¶ä»–ä¸ç›¸å…³çš„ç¨‹åºï¼Œå®ƒå°±å®Œå…¨çœ‹ä¸åˆ°äº†ã€‚æ‰€ä»¥è¯´ï¼Œå®¹å™¨ï¼Œå…¶å®æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¿›ç¨‹è€Œå·²ã€‚\nLinux Cgroups å°±æ˜¯ Linux å†…æ ¸ä¸­ç”¨æ¥ä¸ºè¿›ç¨‹è®¾ç½®èµ„æºé™åˆ¶çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½ã€‚å®ƒæœ€ä¸»è¦çš„ä½œç”¨ï¼Œå°±æ˜¯é™åˆ¶ä¸€ä¸ªè¿›ç¨‹ç»„èƒ½å¤Ÿä½¿ç”¨çš„èµ„æºä¸Šé™ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œå¸¦å®½ç­‰ç­‰ã€‚\nä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Docker å®¹å™¨ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¯ç”¨äº†å¤šä¸ª Linux Namespace çš„åº”ç”¨è¿›ç¨‹ï¼Œè€Œè¿™ä¸ªè¿›ç¨‹èƒ½å¤Ÿä½¿ç”¨çš„èµ„æºé‡ï¼Œåˆ™å— Cgroups é…ç½®çš„é™åˆ¶ã€‚\nè¯¦æƒ…è¯·å‚è€ƒï¼šhttps://coolshell.cn/articles/17049.html\n1.4. docker load åŠ è½½ä¸€ä¸ªé•œåƒï¼Œ docker images æŸ¥çœ‹ä¸åˆ°ï¼Œæ˜¯å“ªäº›åŸå› ï¼Ÿ 1.4 æœ‰æ²¡æœ‰é‡åˆ°å®¹å™¨ OOM çš„é—®é¢˜ï¼Ÿæ€ä¹ˆå¤„ç†çš„ï¼Ÿ OOM å¯èƒ½çš„åŸå› ï¼š\n  å®¹å™¨éš”ç¦»ä¸å½»åº•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒJVM åˆå§‹å †å¤§å°ä¸ºå†…å­˜æ€»é‡çš„ 1/4ï¼Œä¾‹å¦‚è¿™å°å®¿ä¸»æœºçš„å†…å­˜ä¸º32Gï¼Œé‚£ä¹ˆåˆå§‹å †çš„å¤§å°ä¸º8Gï¼Œè¿™ç§æƒ…å†µä¼šå¯¼è‡´ï¼Œå¦‚æœå®¹å™¨åˆ†é…çš„å†…å­˜å°äº JVM çš„å†…å­˜ï¼Œ JVM è¿›ç¨‹ä¼šè¢« linux killer æ€æ­»ã€‚\n   å¤„ç†æ–¹æ³•ï¼š\n å‡çº§jdkç‰ˆæœ¬æˆ–è€…è®¾ç½®åˆå§‹å †å¤§å°å’Œå †å†…å­˜æœ€å¤§å€¼ï¼Œå³-Xms å’Œ -Xmxã€‚  2. Kubernetes é—®é¢˜ 2.1. k8s çš„æ¶æ„ä½“ç³»äº†è§£å—ï¼Ÿç®€å•æè¿°ä¸€ä¸‹ è¿™é“é¢˜ä¸»è¦è€ƒå¯Ÿ k8s ä½“ç³»ï¼Œæ¶‰åŠçš„èŒƒå›´å…¶å®å¤ªå¹¿æ³›ï¼Œå¯ä»¥ä»æœ¬èº« k8s ç»„ä»¶ã€å­˜å‚¨ã€ç½‘ç»œã€ç›‘æ§ç­‰æ–¹é¢é˜è¿°ï¼Œå½“æ—¶æˆ‘ä¸»è¦å°† k8s çš„æ¯ä¸ªç»„ä»¶åŠŸèƒ½éƒ½å¤§æ¦‚è¯´äº†ä¸€ä¸‹ã€‚\nMasterèŠ‚ç‚¹\nMasterèŠ‚ç‚¹ä¸»è¦æœ‰å››ä¸ªç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ï¼šapi-serverã€controller-managerã€kube-scheduler å’Œ etcdã€‚\n api-server\nè´Ÿè´£APIæœåŠ¡ã€‚kube-apiserver ä½œä¸º k8s é›†ç¾¤çš„æ ¸å¿ƒï¼Œè´Ÿè´£æ•´ä¸ªé›†ç¾¤åŠŸèƒ½æ¨¡å—çš„äº¤äº’å’Œé€šä¿¡ï¼Œé›†ç¾¤å†…çš„å„ä¸ªåŠŸèƒ½æ¨¡å—å¦‚ kubeletã€controllerã€scheduler ç­‰éƒ½é€šè¿‡ api-server æä¾›çš„æ¥å£å°†ä¿¡æ¯å­˜å…¥åˆ° etcd ä¸­ï¼Œå½“éœ€è¦è¿™äº›ä¿¡æ¯æ—¶ï¼Œåˆé€šè¿‡ api-server æä¾›çš„ restful æ¥å£ï¼Œå¦‚getã€watch æ¥å£æ¥è·å–ï¼Œä»è€Œå®ç°æ•´ä¸ª k8s é›†ç¾¤åŠŸèƒ½æ¨¡å—çš„æ•°æ®äº¤äº’ã€‚\ncontroller-manager\nè´Ÿè´£å®¹å™¨ç¼–æ’ã€‚controller-manager ä½œä¸º k8s é›†ç¾¤çš„ç®¡ç†æ§åˆ¶ä¸­å¿ƒï¼Œè´Ÿè´£é›†ç¾¤å†… Nodeã€Namespaceã€Serviceã€Tokenã€Replication ç­‰èµ„æºå¯¹è±¡çš„ç®¡ç†ï¼Œä½¿é›†ç¾¤å†…çš„èµ„æºå¯¹è±¡ç»´æŒåœ¨é¢„æœŸçš„å·¥ä½œçŠ¶æ€ã€‚\næ¯ä¸€ä¸ª controller é€šè¿‡ api-server æä¾›çš„ restful æ¥å£å®æ—¶ç›‘æ§é›†ç¾¤å†…æ¯ä¸ªèµ„æºå¯¹è±¡çš„çŠ¶æ€ï¼Œå½“å‘ç”Ÿæ•…éšœï¼Œå¯¼è‡´èµ„æºå¯¹è±¡çš„å·¥ä½œçŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå°±è¿›è¡Œå¹²é¢„ï¼Œå°è¯•å°†èµ„æºå¯¹è±¡ä»å½“å‰çŠ¶æ€æ¢å¤ä¸ºé¢„æœŸçš„å·¥ä½œçŠ¶æ€ï¼Œå¸¸è§çš„ controller æœ‰ Namespace Controllerã€Node Controllerã€Service Controllerã€ServiceAccount Controllerã€Token Controllerã€ResourceQuote Controllerã€Replication Controllerç­‰ã€‚\nkube-scheduler\nkube-scheduler ç®€å•ç†è§£ä¸ºé€šè¿‡ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œç­–ç•¥ä¸ºå¾…è°ƒåº¦çš„ Pod åˆ—è¡¨ä¸­çš„æ¯ä¸ª Pod é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„èŠ‚ç‚¹è¿›è¡Œè°ƒåº¦ï¼Œè°ƒåº¦ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œé¢„é€‰é˜¶æ®µå’Œä¼˜é€‰é˜¶æ®µï¼Œå…¶ä¸­é¢„é€‰é˜¶æ®µæ˜¯éå†æ‰€æœ‰çš„ node èŠ‚ç‚¹ï¼Œæ ¹æ®ç­–ç•¥å’Œé™åˆ¶ç­›é€‰å‡ºå€™é€‰èŠ‚ç‚¹ï¼Œä¼˜é€‰é˜¶æ®µæ˜¯åœ¨ç¬¬ä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡ç›¸åº”çš„ç­–ç•¥ä¸ºæ¯ä¸€ä¸ªå€™é€‰èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ï¼Œåˆ†æ•°æœ€é«˜è€…èƒœå‡ºï¼Œéšåç›®æ ‡èŠ‚ç‚¹çš„ kubelet è¿›ç¨‹é€šè¿‡ api-server æä¾›çš„æ¥å£ç›‘æ§åˆ° kube-scheduler äº§ç”Ÿçš„ pod ç»‘å®šäº‹ä»¶ï¼Œä» etcd ä¸­è·å– Pod çš„æ¸…å•ï¼Œç„¶åä¸‹è½½é•œåƒï¼Œå¯åŠ¨å®¹å™¨ã€‚\né¢„é€‰é˜¶æ®µçš„ç­–ç•¥æœ‰ï¼š\n(1) MatchNodeSelectorï¼šåˆ¤æ–­èŠ‚ç‚¹çš„ label æ˜¯å¦æ»¡è¶³ Pod çš„ nodeSelector å±æ€§å€¼ã€‚\n(2) PodFitResourceï¼šåˆ¤æ–­èŠ‚ç‚¹çš„èµ„æºæ˜¯å¦æ»¡è¶³ Pod çš„éœ€æ±‚ï¼Œæ‰¹åˆ¤çš„æ ‡å‡†æ˜¯ï¼šå½“å‰èŠ‚ç‚¹å·²è¿è¡Œçš„æ‰€æœ‰ Pod çš„ requestå€¼ + å¾…è°ƒåº¦çš„ Pod çš„ request å€¼æ˜¯å¦è¶…è¿‡èŠ‚ç‚¹çš„èµ„æºå®¹é‡ã€‚\n(3) PodFitHostNameï¼šåˆ¤æ–­èŠ‚ç‚¹çš„ä¸»æœºåç§°æ˜¯å¦æ»¡è¶³ Pod çš„ nodeName å±æ€§å€¼ã€‚\n(4) PodFitHostPortï¼šåˆ¤æ–­ Pod çš„ç«¯å£æ‰€æ˜ å°„çš„èŠ‚ç‚¹ç«¯å£æ˜¯å¦è¢«èŠ‚ç‚¹å…¶ä»– Pod æ‰€å ç”¨ã€‚\n(5) CheckNodeMemoryPressureï¼šåˆ¤æ–­ Pod æ˜¯å¦å¯ä»¥è°ƒåº¦åˆ°å†…å­˜æœ‰å‹åŠ›çš„èŠ‚ç‚¹ï¼Œè¿™å–å†³äº Pod çš„ Qos é…ç½®ï¼Œå¦‚æœæ˜¯ BestEffortï¼ˆå°½é‡æ»¡è¶³ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼‰ï¼Œåˆ™ä¸å…è®¸è°ƒåº¦ã€‚\n(6) CheckNodeDiskPressureï¼šå¦‚æœå½“å‰èŠ‚ç‚¹ç£ç›˜æœ‰å‹åŠ›ï¼Œåˆ™ä¸å…è®¸è°ƒåº¦ã€‚\nä¼˜é€‰é˜¶æ®µçš„ç­–ç•¥æœ‰ï¼š\n(1) SelectorSpreadPriorityï¼šå°½é‡å‡å°‘èŠ‚ç‚¹ä¸ŠåŒå±ä¸€ä¸ª SVC/RC/RS çš„ Pod å‰¯æœ¬æ•°ï¼Œä¸ºäº†æ›´å¥½çš„å®ç°å®¹ç¾ï¼Œå¯¹äºåŒå±ä¸€ä¸ª SVC/RC/RS çš„ Pod å®ä¾‹ï¼Œåº”å°½é‡è°ƒåº¦åˆ°ä¸åŒçš„ node èŠ‚ç‚¹ã€‚\n(2) LeastRequestPriorityï¼šä¼˜å…ˆè°ƒåº¦åˆ°è¯·æ±‚èµ„æºè¾ƒå°‘çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„ä¼˜å…ˆçº§ç”±èŠ‚ç‚¹çš„ç©ºé—²èµ„æºä¸èŠ‚ç‚¹æ€»å®¹é‡çš„æ¯”å€¼å†³å®šçš„ï¼Œå³ï¼ˆèŠ‚ç‚¹æ€»å®¹é‡ - å·²ç»è¿è¡Œçš„ Pod æ‰€éœ€èµ„æºï¼‰/ èŠ‚ç‚¹æ€»å®¹é‡ï¼ŒCPU å’Œ Memory å…·æœ‰ç›¸åŒçš„æƒé‡ï¼Œæœ€ç»ˆçš„å€¼ç”±è¿™ä¸¤éƒ¨åˆ†ç»„æˆã€‚\n(3) BalancedResourceAllocationï¼šè¯¥ç­–ç•¥ä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œå¿…é¡»å’Œ LeaseRequestPriority ç­–ç•¥ä¸€èµ·ç»“åˆä½¿ç”¨ï¼Œå°½é‡è°ƒåº¦åˆ° CPU å’Œ Memory ä½¿ç”¨å‡è¡¡çš„èŠ‚ç‚¹ä¸Šã€‚\nETCD\nå¼ºä¸€è‡´æ€§çš„é”®å€¼å¯¹å­˜å‚¨ï¼Œk8s é›†ç¾¤ä¸­çš„æ‰€æœ‰èµ„æºå¯¹è±¡éƒ½å­˜å‚¨åœ¨ etcd ä¸­ã€‚\nNodeèŠ‚ç‚¹\n åœ¨ Kubernetes é¡¹ç›®ä¸­ï¼Œkubelet ä¸»è¦è´Ÿè´£åŒå®¹å™¨è¿è¡Œæ—¶ï¼ˆæ¯”å¦‚ Docker é¡¹ç›®ï¼‰æ‰“äº¤é“ã€‚è€Œè¿™ä¸ªäº¤äº’æ‰€ä¾èµ–çš„ï¼Œæ˜¯ä¸€ä¸ªç§°ä½œ CRIï¼ˆContainer Runtime Interfaceï¼‰çš„è¿œç¨‹è°ƒç”¨æ¥å£ï¼Œè¿™ä¸ªæ¥å£å®šä¹‰äº†å®¹å™¨è¿è¡Œæ—¶çš„å„é¡¹æ ¸å¿ƒæ“ä½œã€‚è€Œå…·ä½“çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œæ¯”å¦‚ Docker é¡¹ç›®ï¼Œåˆ™ä¸€èˆ¬é€šè¿‡ OCI è¿™ä¸ªå®¹å™¨è¿è¡Œæ—¶è§„èŒƒåŒåº•å±‚çš„ Linux æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚æ­¤å¤–ï¼Œkubelet è¿˜é€šè¿‡ gRPC åè®®åŒä¸€ä¸ªå«ä½œ Device Plugin çš„æ’ä»¶è¿›è¡Œäº¤äº’ã€‚è¿™ä¸ªæ’ä»¶ï¼Œæ˜¯ Kubernetes é¡¹ç›®ç”¨æ¥ç®¡ç† GPU ç­‰å®¿ä¸»æœºç‰©ç†è®¾å¤‡çš„ä¸»è¦ç»„ä»¶ï¼Œä¹Ÿæ˜¯åŸºäº Kubernetes é¡¹ç›®è¿›è¡Œæœºå™¨å­¦ä¹ è®­ç»ƒã€é«˜æ€§èƒ½ä½œä¸šæ”¯æŒç­‰å·¥ä½œå¿…é¡»å…³æ³¨çš„åŠŸèƒ½ã€‚è€Œ kubelet çš„å¦ä¸€ä¸ªé‡è¦åŠŸèƒ½ï¼Œåˆ™æ˜¯è°ƒç”¨ç½‘ç»œæ’ä»¶å’Œå­˜å‚¨æ’ä»¶ä¸ºå®¹å™¨é…ç½®ç½‘ç»œå’ŒæŒä¹…åŒ–å­˜å‚¨ã€‚è¿™ä¸¤ä¸ªæ’ä»¶ä¸ kubelet è¿›è¡Œäº¤äº’çš„æ¥å£ï¼Œåˆ†åˆ«æ˜¯ CNIï¼ˆContainer Networking Interfaceï¼‰å’Œ CSIï¼ˆContainer Storage Interfaceï¼‰ã€‚\nNodeèŠ‚ç‚¹ä¸»è¦æœ‰ä¸‰ä¸ªç»„ä»¶ï¼šåˆ†åˆ«æ˜¯ kubeletã€kube-proxy å’Œ å®¹å™¨è¿è¡Œæ—¶ docker æˆ–è€… rktã€‚\nkubelet\nåœ¨ k8s é›†ç¾¤ä¸­ï¼Œæ¯ä¸ª node èŠ‚ç‚¹éƒ½ä¼šè¿è¡Œä¸€ä¸ª kubelet è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹ç”¨æ¥å¤„ç† Master èŠ‚ç‚¹ä¸‹è¾¾åˆ°è¯¥èŠ‚ç‚¹çš„ä»»åŠ¡ï¼ŒåŒæ—¶ï¼Œé€šè¿‡ api-server æä¾›çš„æ¥å£å®šæœŸå‘ Master èŠ‚ç‚¹æŠ¥å‘Šè‡ªèº«çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¹¶é€šè¿‡ cadvisor ç»„ä»¶ç›‘æ§èŠ‚ç‚¹å’Œå®¹å™¨çš„ä½¿ç”¨æƒ…å†µã€‚\nkube-proxy\nkube-proxy å°±æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„è½¯ä»¶è´Ÿè½½å‡è¡¡å™¨ï¼Œå°† service çš„è¯·æ±‚è½¬å‘åˆ°åç«¯å…·ä½“çš„ Pod å®ä¾‹ä¸Šï¼Œå¹¶æä¾›è´Ÿè½½å‡è¡¡å’Œä¼šè¯ä¿æŒæœºåˆ¶ï¼Œç›®å‰æœ‰ä¸‰ç§å·¥ä½œæ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ï¼šç”¨æˆ·æ¨¡å¼ï¼ˆuserspaceï¼‰ã€iptables æ¨¡å¼å’Œ IPVS æ¨¡å¼ã€‚\nå®¹å™¨è¿è¡Œæ—¶â€”â€”docker\nè´Ÿè´£ç®¡ç† node èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å®¹å™¨å’Œå®¹å™¨ IP çš„åˆ†é…ã€‚\n2.2. k8s åˆ›å»ºä¸€ä¸ªpodçš„è¯¦ç»†æµç¨‹ï¼Œæ¶‰åŠçš„ç»„ä»¶æ€ä¹ˆé€šä¿¡çš„ï¼Ÿ k8s åˆ›å»ºä¸€ä¸ª Pod çš„è¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š\n(1) å®¢æˆ·ç«¯æäº¤åˆ›å»ºè¯·æ±‚ï¼Œå¯ä»¥é€šè¿‡ api-server æä¾›çš„ restful æ¥å£ï¼Œæˆ–è€…æ˜¯é€šè¿‡ kubectl å‘½ä»¤è¡Œå·¥å…·ï¼Œæ”¯æŒçš„æ•°æ®ç±»å‹åŒ…æ‹¬ JSON å’Œ YAMLã€‚\n(2) api-server å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œå°† pod ä¿¡æ¯å­˜å‚¨è‡³ etcd ä¸­ã€‚\n(3) kube-scheduler é€šè¿‡ api-server æä¾›çš„æ¥å£ç›‘æ§åˆ°æœªç»‘å®šçš„ podï¼Œå°è¯•ä¸º pod åˆ†é… node èŠ‚ç‚¹ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œé¢„é€‰é˜¶æ®µå’Œä¼˜é€‰é˜¶æ®µï¼Œå…¶ä¸­é¢„é€‰é˜¶æ®µæ˜¯éå†æ‰€æœ‰çš„ node èŠ‚ç‚¹ï¼Œæ ¹æ®ç­–ç•¥ç­›é€‰å‡ºå€™é€‰èŠ‚ç‚¹ï¼Œè€Œä¼˜é€‰é˜¶æ®µæ˜¯åœ¨ç¬¬ä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œä¸ºæ¯ä¸€ä¸ªå€™é€‰èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ï¼Œåˆ†æ•°æœ€é«˜è€…èƒœå‡ºã€‚\n(4) é€‰æ‹©åˆ†æ•°æœ€é«˜çš„èŠ‚ç‚¹ï¼Œè¿›è¡Œ pod binding æ“ä½œï¼Œå¹¶å°†ç»“æœå­˜å‚¨è‡³ etcd ä¸­ã€‚\n(5) éšåç›®æ ‡èŠ‚ç‚¹çš„ kubelet è¿›ç¨‹é€šè¿‡ api-server æä¾›çš„æ¥å£ç›‘æµ‹åˆ° kube-scheduler äº§ç”Ÿçš„ pod ç»‘å®šäº‹ä»¶ï¼Œç„¶åä» etcd è·å– pod æ¸…å•ï¼Œä¸‹è½½é•œåƒå¹¶å¯åŠ¨å®¹å™¨ã€‚\n æ•´ä¸ªäº‹ä»¶æµå¯ä»¥å‚è€ƒä¸‹å›¾ï¼š\nå‚è€ƒæ–‡ç« ï¼škubectl åˆ›å»º Pod èƒŒååˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ\n2.3. k8s ä¸­æœåŠ¡çº§åˆ«ï¼Œæ€æ ·è®¾ç½®æœåŠ¡çš„çº§åˆ«æ‰æ˜¯æœ€é«˜çš„ è¿™é“é¢˜ä¸»è¦è€ƒå¯Ÿ k8s Qos ç±»åˆ«ã€‚åœ¨ k8s ä¸­ï¼ŒQos ä¸»è¦æœ‰ä¸‰ç§ç±»åˆ«ï¼Œåˆ†åˆ«æ˜¯ BestEffortã€Burstable å’Œ Guaranteedï¼Œä¸‰ç§ç±»åˆ«åŒºåˆ«å¦‚ä¸‹ï¼š\nBestEffort\nä»€ä¹ˆéƒ½ä¸è®¾ç½®ï¼ˆCPU or Memoryï¼‰ï¼Œä½›ç³»ç”³è¯·èµ„æºã€‚\nBurstable\nPod ä¸­çš„å®¹å™¨è‡³å°‘ä¸€ä¸ªè®¾ç½®äº†CPU æˆ–è€… Memory çš„è¯·æ±‚\nGuaranteed\nPod ä¸­çš„æ‰€æœ‰å®¹å™¨å¿…é¡»è®¾ç½® CPU å’Œ Memoryï¼Œå¹¶ä¸” request å’Œ limit å€¼ç›¸ç­‰ã€‚\nè¯¦æƒ…å¯ä»¥å‚è€ƒè¿™ç¯‡åšå®¢ï¼šK8s Qos\n2.4. æœ‰çŠ¶æ€çš„å®¹å™¨å¦‚ä½•ä¸Šäº‘ï¼Ÿ 2.5. è§£é‡Šä¸€ä¸‹CRDå’ŒOperatorï¼Ÿæœ‰æ²¡æœ‰è‡ªå·±å¼€å‘è¿‡CRDæˆ–è€…Operatorï¼Ÿ 2.6. ä»€ä¹ˆæ˜¯ CNI? å¹³æ—¶ K8S é›†ç¾¤ç”¨çš„æ˜¯å“ªä¸ªç½‘ç»œæ’ä»¶ï¼Ÿ 2.7. ä¸ºä»€ä¹ˆ Pod ä¸­å…³äºèµ„æºæœ‰ request å’Œ limit ä¸¤ä¸ªå­—æ®µï¼Ÿæœ‰æƒ³è¿‡è¿™ä¹ˆè®¾è®¡çš„åŸå› å—ï¼Ÿ 2.8. Podè¢«è°ƒåº¦åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„å…·ä½“è¿‡ç¨‹ï¼Ÿ 2.9. ä¸€ä¸ªè¯·æ±‚åˆ° Pod æ¥æ”¶å“åº”ï¼Œä¸­é—´ç»å†äº†å“ªäº›è¿‡ç¨‹ï¼Ÿ 3. å‚è€ƒèµ„æ–™ [1] docker \u0026amp; kubernetes é¢è¯•\n","date":"2020å¹´12æœˆ28æ—¥","permalink":"https://ahamoment.cn/posts/interview/interview-docker-k8s/","summary":"1. Docker é—®é¢˜ 1.1. docker åç«¯å­˜å‚¨é©±åŠ¨ devicemapperã€overlay å‡ ç§çš„åŒºåˆ«ï¼Ÿ åˆšå¼€å§‹æ‹¿åˆ°è¿™é“é¢˜æˆ‘æœ‰ç‚¹è’™ï¼Œå› ä¸ºæˆ‘åªçŸ¥é“ç›®å‰æˆ‘ä»¬ç”¨çš„æ˜¯vg-pool devicemapper æ¥å­˜å‚¨é•œåƒå’Œå®¹å™¨ï¼Œåæ¥é¢è¯•å®˜é—®æˆ‘é•œåƒåˆ†å±‚çš„æŠ€æœ¯çŸ¥é“å—ï¼Ÿæˆ‘è¯´çŸ¥é“ï¼Œå°±æ˜¯**è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œå¤šå±‚æ–‡ä»¶ç³»ç»Ÿè”åˆç»„æˆä¸€ä¸ªç»Ÿä¸€çš„æ–‡ä»¶ç³»ç»Ÿè§†è§’ï¼Œå½“éœ€è¦ä¿®æ”¹æ–‡ä»¶æ—¶é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼ˆCopyWï¼‰çš„æŠ€æœ¯ä»ä¸Šå¾€ä¸‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°ä¹‹åå¤åˆ¶åˆ°å¯å†™çš„å®¹å™¨å±‚ï¼Œè¿›è¡Œä¿®æ”¹å¹¶ä¿å­˜è‡³å®¹å™¨å±‚ï¼Œ**è¯´å®Œä¹‹åé¢è¯•å®˜å†é—®æˆ‘ï¼Œé‚£æ¯æ¬¡ä¿®æ”¹æ–‡ä»¶éƒ½éœ€è¦ä»ä¸Šå¾€ä¸‹æŸ¥æ‰¾ï¼Œå±‚æ•°åˆé‚£ä¹ˆå¤šï¼Œæ€§èƒ½æ˜¯å¦æ¯”è¾ƒå·®ï¼Œç°åœ¨æ‰ååº”å›æ¥ï¼ŒåŸå…ˆé¢è¯•å®˜æƒ³è€ƒå¯Ÿæˆ‘aufsã€overlay æˆ–è€…æ˜¯ devicemapper ç­‰å‡ ç§å­˜å‚¨é©±åŠ¨çš„åŒºåˆ«ã€‚\nAUFS\nAUFS ï¼ˆAnother UnionFSï¼‰æ˜¯ä¸€ç§ Union FSï¼Œæ˜¯æ–‡ä»¶çº§çš„å­˜å‚¨é©±åŠ¨ï¼ŒAUFS ç®€å•ç†è§£å°±æ˜¯å°†å¤šå±‚çš„æ–‡ä»¶ç³»ç»Ÿè”åˆæŒ‚è½½æˆç»Ÿä¸€çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ç§æ–‡ä»¶ç³»ç»Ÿå¯ä»¥ä¸€å±‚ä¸€å±‚åœ°å åŠ ä¿®æ”¹æ–‡ä»¶ï¼Œåªæœ‰æœ€ä¸Šå±‚æ˜¯å¯å†™å±‚ï¼Œåº•ä¸‹æ‰€æœ‰å±‚éƒ½æ˜¯åªè¯»å±‚ï¼Œå¯¹åº”åˆ° Dockerï¼Œæœ€ä¸Šå±‚å°±æ˜¯ container å±‚ï¼Œåº•å±‚å°±æ˜¯ image å±‚ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š","title":"Docker å’Œ Kubernetes é¢è¯•é¢˜"},{"contents":" é¢è¯•é¢˜ç›®å½•\n 1. æ•°æ®ç»“æ„  æ’åºç®—æ³• é“¾è¡¨å’Œæ•°ç»„çš„åŒºåˆ«ï¼Ÿè·³è¡¨çš„å®ç° äºŒåˆ†æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦å’Œä¼˜ç‚¹ï¼Ÿ å“ˆå¸Œè¡¨ï¼Œè§£å†³å†²çªçš„æ–¹å¼ äºŒå‰æ ‘å’ŒB+æ ‘ äºŒä¸ªäº¿çš„æ— åºæ•´æ•°ï¼Œå¦‚ä½•æ‰¾åˆ°ä¸­é—´å€¼  å¸¸è§çš„ç¼–ç¨‹é¢˜ï¼šé“¾è¡¨åè½¬ã€åŠ¨æ€è§„åˆ’ã€äºŒå‰æ ‘éå†\n2. æ“ä½œç³»ç»Ÿ   è¿›ç¨‹ä¸çº¿ç¨‹\n  è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼\n  è¿›ç¨‹è°ƒåº¦\n  æ­»é”çš„æ¡ä»¶ä¸è§£é™¤\n  åƒµå°¸è¿›ç¨‹æ˜¯ä»€ä¹ˆ\n  ç”¨æˆ·æ€ä¸å†…æ ¸æ€\n  3. Linux  select ä¸ epoll çš„åŒºåˆ« forkçš„åº•å±‚åŸç† æŸ¥çœ‹æ–‡ä»¶ä¸­çš„100-200è¡Œï¼Œå…¶ä¸­æœ‰errorç›¸å…³çš„é™„è¿‘æ—¥å¿— topåˆ†æ æŸ¥çœ‹ç«¯å£å ç”¨ æŸ¥çœ‹æ‰“å¼€çš„æ–‡ä»¶ tcpdump æŠ“åŒ… awkï¼Œgrepçš„ä½¿ç”¨  4. è®¡ç®—æœºç½‘ç»œ  ä¸ƒå±‚åè®®ä¸tcpå››å±‚åè®®ï¼Ÿäº”å±‚åè®®  4.1. TCP  tcpä¸udpçš„åŒºåˆ« tcpçš„ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ synåŒ…ä¸¢äº†æœ€å¤šä¼šé‡ä¼ å¤šå°‘æ¬¡ time_wait çš„ä½œç”¨ä¸å±å®³ï¼Œtcp_reuse çš„æœºåˆ¶ TCP å¦‚ä½•ç¡®ä¿å¯é ä¼ è¾“ TCP æ‹¥å¡æ§åˆ¶å’Œæµé‡æ§åˆ¶ TCP çš„neglaç®—æ³•ï¼Œå¦‚ä½•è§£å†³ç²˜åŒ…å’ŒåŠåŒ…(ä¸¢åŒ…ï¼Ÿ)é—®é¢˜ TCPçš„é“¾æ¥ä¿æ´»è®¡æ—¶å™¨ åŸºäºUDPè®¾è®¡ä¸€ä¸ªå¯é çš„ä¼ è¾“åè®®(å‚è€ƒquic)  4.2. HTTP  ä¸€æ¬¡urlè®¿é—®ä¼šç»è¿‡ä»€ä¹ˆè¿‡ç¨‹ GET å’Œ POST çš„åŒºåˆ«ï¼ŒPUT å’Œ POST çš„åŒºåˆ« http å¸¸è§é”™è¯¯ç  httpä¸httpsï¼Œhttpsçš„åŸç† sessionä¸cookie  5. æ•°æ®åº“ 5.1. MySQL  å¸¸è§çš„å­˜å‚¨å¼•æ“æœ‰å“ªäº›ï¼Œä»–ä»¬æœ‰ä»€ä¹ˆåŒºåˆ« å¸¸è§çš„ç´¢å¼•å®ç°æ–¹å¼ï¼ŒB+æ ‘ç´¢å¼•ï¼Œå“ˆå¸Œç´¢å¼•ä»–ä»¬åˆ†åˆ«é€‚ç”¨ä»€ä¹ˆåœºæ™¯ Innodb å¼•æ“çš„ç´¢å¼•å­˜å‚¨æ–¹å¼ï¼Œèšç°‡ç´¢å¼•ä¸éèšç°‡ç´¢å¼• ä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¸å‘½ä¸­ï¼ŸMySQL å¦‚ä½•ä¼˜åŒ–è”åˆç´¢å¼•ä¸æ»¡è¶³æœ€å·¦è§„åˆ™çš„æŸ¥è¯¢(ç´¢å¼•ä¸‹æ¨) ä¸€çº§ç´¢å¼•ä¸äºŒçº§ç´¢å¼•çš„æŸ¥è¯¢æ–¹å¼ï¼Œå¦‚ä½•ä¼˜åŒ–(è¦†ç›–ç´¢å¼•) å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢(explain åˆ†æ) äº‹åŠ¡çš„éš”ç¦»çº§åˆ« innodb å¼•æ“æ˜¯å¦‚ä½•è§£å†³RRçº§åˆ«ä¸‹çš„å¹»è¯»é—®é¢˜(mvcc,next-key) MySQLä¸ºä»€ä¹ˆRCçº§åˆ«ä¸‹ä¼šå‡ºç°ä¸å¯é‡å¤åº¦çš„é—®é¢˜ï¼Œè€ŒRRä¸ä¼šï¼ˆread Viewï¼‰ ä¹è§‚é”ä¸æ‚²è§‚é” mysqlçš„é”æœºåˆ¶ï¼ˆå¯¹ç´¢å¼•åŠ é”ï¼‰ï¼ˆå…±äº«é”ï¼Œæ’ä»–é”ï¼Œæ„å‘é”ï¼Œgapé”ï¼‰ mysqlå¦‚ä½•ä¿è¯äº‹åŠ¡çš„æ­£ç¡®æ€§ï¼ˆredologï¼Œundo logï¼‰ mysqlæ˜¯æ€ä¹ˆä¿è¯æ•°æ®æŒä¹…ï¼Œä¸ä¸¢å¤±çš„ï¼ˆbinlogï¼‰ mysqlä¸»ä»å¤åˆ¶çš„æ–¹å¼ï¼ˆåŒæ­¥å¤åˆ¶ï¼ŒåŠåŒæ­¥å¤åˆ¶ï¼Œå¼‚æ­¥å¤åˆ¶ï¼‰ï¼Œå¦‚ä½•è§£å†³ä¸»ä»å»¶è¿Ÿï¼ˆå¤šçº¿ç¨‹æ‰§è¡Œï¼Œç»„æäº¤ï¼‰ MySQL æŸ¥è¯¢çš„INå’ŒEXISTæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ MySQL æ­»é”æ˜¯å¦‚ä½•å½¢æˆçš„ï¼ŸMySQLæ˜¯å¦‚ä½•è§£å†³æ­»é”é—®é¢˜çš„ï¼Ÿ  5.2. Redis  å¸¸è§çš„æ•°æ®ç±»å‹(String, List, Hash, Set, Sort Set) å­—ç¬¦ä¸²ç±»å‹æ˜¯æ€ä¹ˆå®ç°(sdsç»“æ„) hash æ˜¯æ€ä¹ˆå®ç°ï¼ˆæ¸è¿›æ€§hashï¼‰ sort set æ˜¯æ€ä¹ˆå®ç°çš„ï¼ˆè·³è¡¨ï¼‰ redis å®ç°åˆ†å¸ƒå¼é”ï¼Œå®ç°å¯é‡å…¥é”ï¼ˆlua,setnxexï¼‰ï¼Œå¦‚ä½•è§£å†³å®¿ä¸»æœºå®•æœºåï¼Œä¸»ä»åˆ‡æ¢å¯èƒ½ä¼šå¯¼è‡´åŒæ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹è·å–é”ï¼ˆçº¢é”ï¼‰ rediså®ç°ä¹è§‚é”ï¼ˆMultiï¼Œwatchï¼ŒExecï¼‰ redis æŒä¹…åŒ–æœºåˆ¶ redis ä¸»ä»å¤åˆ¶ï¼ˆå…¨é‡å¤åˆ¶ï¼Œå¢é‡å¤åˆ¶ï¼Œrunidï¼Œå¤åˆ¶ç¼“å†²åŒºï¼Œå¤åˆ¶åç§»é‡ï¼‰ sentinelæ˜¯å¦‚ä½•åšåˆ°é«˜å¯ç”¨çš„ï¼ˆä¸»è§‚ä¸‹çº¿ï¼Œå®¢è§‚ä¸‹çº¿ï¼Œrafté€‰ä¸»ï¼Œä¸»ä»åˆ‡æ¢ï¼‰ redis clusteræ˜¯å¦‚ä½•åšåˆ°é«˜å¯ç”¨çš„  6. Java 6.1. åŸºç¡€ 6.2. å¤šçº¿ç¨‹  ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ å®ç°å¤šçº¿ç¨‹çš„å‡ ç§æ–¹å¼ï¼Ÿ çº¿ç¨‹æ± çš„å…³é—­æ–¹å¼æœ‰å“ªäº›ï¼Ÿ  7. å¸¸ç”¨æ¡†æ¶ä¸ç¬¬ä¸‰æ–¹ç»„ä»¶ 7.1. Spring  Spring AOPçš„å®ç°åŸç† spring IOC çš„å¥½å¤„ spring ç”¨äº†ä»€ä¹ˆè®¾è®¡æ¨¡å¼ Transaction ä»€ä¹ˆæ—¶å€™ä¼šç”Ÿæ•ˆï¼Ÿäº‹åŠ¡çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ spring mvcçš„controllerå‚æ•°æ˜¯å¦‚ä½•æ˜ å°„çš„ï¼Ÿ å¤šä¾‹æ³¨å…¥çš„å®ç°åŸç†åŠå…¶ç”Ÿå‘½å‘¨æœŸ Spring ä¸­çš„ Controller æ³¨è§£æ˜¯å•ä¾‹çš„è¿˜æ˜¯å¤šä¾‹çš„ï¼Ÿä¼šä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ï¼Ÿ  7.2. SpringBoot  å¸¸ç”¨çš„SpringBootçš„æ³¨è§£æœ‰å“ªäº›ï¼Ÿ  7.3 Mybatis  Mybatis çš„ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ Mybatis æ’ä»¶çš„åŸç†ï¼Œç”¨åˆ°äº†ä»€ä¹ˆè®¾è®¡æ¨¡å¼ Mybatis æ˜¯æ€ä¹ˆæ‰¾åˆ°æŒ‡å®šçš„mapperçš„  7.4. æœ¬åœ°ç¼“å­˜  guavaï¼Œcaffeineï¼Œohc  8. åˆ†å¸ƒå¼  CAPç†è®º BASEç†è®º  8.1. ç¼“å­˜  ç©¿é€ï¼Œå‡»ç©¿ï¼Œé›ªå´©æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•é¿å…ï¼ˆéšæœºè¿‡æœŸæ—¶é—´ï¼Œå¼‚æ­¥åˆ·æ–°ï¼Œå•çº¿ç¨‹å›æºï¼‰  8.2. ä¸€è‡´æ€§åè®®  raftåè®®åŸç† Paxos ç®—æ³• å¦‚ä½•è§£å†³è„‘è£‚é—®é¢˜ å¤šä¸»ä¸€è‡´æ€§åè®® gossip åŸç†  8.3. è´Ÿè½½å‡è¡¡  å¸¸è§çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆè½®è¯¢ï¼ŒåŠ æƒè½®è¯¢ï¼Œå“ˆå¸Œï¼Œä¸€è‡´æ€§å“ˆå¸Œï¼‰ ä¸€è‡´æ€§å“ˆå¸Œ  8.4 åˆ†å¸ƒå¼é”  ä½¿ç”¨zkæ€ä¹ˆå®ç°åˆ†å¸ƒå¼é” ä½¿ç”¨redisæ€ä¹ˆå®ç°åˆ†å¸ƒå¼é”  8.5. åˆ†å¸ƒå¼äº‹åŠ¡  2pcï¼Œ3pcæäº¤  8.6. åˆ†å¸ƒå¼ä¼šè¯  åˆ†å¸ƒå¼ session å¦‚ä½•è®¾è®¡ï¼ˆé›†æˆredisï¼‰  8.7 åˆ†å¸ƒå¼ID 8.8 Zookeeper 9. å¼€å‘ç›¸å…³  å¸¸è§çš„è®¾è®¡æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼ï¼Ÿ  10. å¾®æœåŠ¡ 11. ç³»ç»Ÿè®¾è®¡ 11.1. é«˜å¹¶å‘  æ¶ˆæ¯é˜Ÿåˆ— è¯»å†™åˆ†ç¦» åˆ†åº“åˆ†è¡¨ è´Ÿè½½å‡è¡¡  11.2. é«˜å¯ç”¨  é™æµ é™çº§ ç†”æ–­ æ’é˜Ÿ  12. æ¶ˆæ¯ä¸­é—´ä»¶  Kafkaæ˜¯å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„æœ‰æ•ˆæ€§çš„ï¼Ÿ ä½¿ç”¨ Kafka çš„è¿‡ç¨‹ä¸­æœ‰æ²¡æœ‰é‡åˆ°è¿‡ä»€ä¹ˆé—®é¢˜?å¦‚ä½•è§£å†³ï¼Ÿ  13. å®¹å™¨äº‘   ","date":"2020å¹´12æœˆ22æ—¥","permalink":"https://ahamoment.cn/posts/interview/interview-questions/","summary":"\u003cblockquote\u003e\n\u003cp\u003eé¢è¯•é¢˜ç›®å½•\u003c/p\u003e\n\u003c/blockquote\u003e","title":"é¢è¯•é¢˜ç›®å½•"},{"contents":" æœ¬æ–‡æ”¶é›†æœ‰å…³åˆ†å¸ƒå¼é¢è¯•é¢˜çš„å†…å®¹\n 1. åˆ†å¸ƒå¼ç†è®º   CAP ç†è®ºå’Œ BASE ç†è®º\nä»»ä½•ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿéƒ½æ— æ³•åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰å’Œåˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤é¡¹ã€‚\n  ä¸€è‡´æ€§åè®®\nraft åè®®ã€paxos ç®—æ³•\n  å¦‚ä½•è§£å†³è„‘è£‚é—®é¢˜\n  gossip åŸç†\n  2. åˆ†å¸ƒå¼é” 3. åˆ†å¸ƒå¼äº‹åŠ¡ 4. åˆ†å¸ƒå¼ä¼šè¯ 5. åˆ†å¸ƒå¼id 6. è´Ÿè½½å‡è¡¡ 7. zookeeper vs etcd å­˜å‚¨æ•°æ®æ—¶ï¼Œzookeeper ä½¿ç”¨æ ‘å½¢ç»“æ„ï¼Œå…¶ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ç§°ä½œ ZNodeï¼Œè®¿é—®ä¸€ä¸ª ZNode æ—¶ï¼Œéœ€è¦æä¾›ä» root å¼€å§‹çš„ç»å¯¹è·¯å¾„ã€‚\nhttps://zhuanlan.zhihu.com/p/96690890\nhttps://imesha.me/apache-curator-vs-etcd3-9c1362600b26\n","date":"2020å¹´12æœˆ18æ—¥","permalink":"https://ahamoment.cn/posts/interview/interview-distributed-system/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡æ”¶é›†æœ‰å…³åˆ†å¸ƒå¼é¢è¯•é¢˜çš„å†…å®¹\u003c/p\u003e\n\u003c/blockquote\u003e","title":"åˆ†å¸ƒå¼é¢è¯•é¢˜"},{"contents":" æœ¬æ–‡åŒ…å«spring, spring boot, spring mvc ä»¥åŠ mybatisçš„é¢è¯•é¢˜\n 1. Spring 2. SpringBoot 2.1. SpringBoot çš„å¸¸ç”¨æ³¨è§£æœ‰å“ªäº›ï¼Ÿ @SpringBootApplication: æ ‡è¯†springbooté¡¹ç›®çš„å¯åŠ¨ç±»ã€‚\n@Configuration: ç”¨äºå®šä¹‰é…ç½®ç±»ï¼ŒæŒ‡å‡ºè¯¥ç±»æ˜¯ Bean é…ç½®çš„ä¿¡æ¯æºï¼Œç›¸å½“äºä¼ ç»Ÿçš„xmlé…ç½®æ–‡ä»¶ï¼Œä¸€èˆ¬åŠ åœ¨ä¸»ç±»ä¸Šã€‚å¦‚æœæœ‰äº›ç¬¬ä¸‰æ–¹åº“éœ€è¦ç”¨åˆ°xmlæ–‡ä»¶ï¼Œå»ºè®®ä»ç„¶é€šè¿‡@Configurationç±»ä½œä¸ºé¡¹ç›®çš„é…ç½®ä¸»ç±»â€”â€”å¯ä»¥ä½¿ç”¨@ImportResourceæ³¨è§£åŠ è½½xmlé…ç½®æ–‡ä»¶ã€‚\n@ComponentScan: ç»„ä»¶æ‰«æã€‚è®©spring Bootæ‰«æåˆ°Configurationç±»å¹¶æŠŠå®ƒåŠ å…¥åˆ°ç¨‹åºä¸Šä¸‹æ–‡ã€‚é»˜è®¤å°±ä¼šè£…é…æ ‡è¯†äº†@Controllerï¼Œ@Serviceï¼Œ@Repositoryï¼Œ@Componentæ³¨è§£çš„ç±»åˆ°springå®¹å™¨ä¸­ã€‚\n@EnableAutoConfiguration: å…è®¸ Spring Boot è‡ªåŠ¨é…ç½®æ³¨è§£ï¼Œå¼€å¯è¿™ä¸ªæ³¨è§£ä¹‹åï¼ŒSpring Boot å°±èƒ½æ ¹æ®å½“å‰ç±»è·¯å¾„ä¸‹çš„åŒ…æˆ–è€…ç±»æ¥é…ç½® Spring Beanã€‚\n@RestController: ç”¨äºæ ‡æ³¨æ§åˆ¶å±‚ç»„ä»¶ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸ªæ§åˆ¶å™¨beanï¼Œå¹¶ä¸”æ˜¯å°†å‡½æ•°çš„è¿”å›å€¼ç›´æ¥å¡«å…¥HTTPå“åº”ä½“ä¸­ï¼Œæ˜¯RESTé£æ ¼çš„æ§åˆ¶å™¨ï¼›å®ƒæ˜¯@Controllerå’Œ@ResponseBodyçš„åˆé›†ã€‚\n@ResponseBody: è¡¨ç¤ºè¯¥æ–¹æ³•çš„è¿”å›ç»“æœç›´æ¥å†™å…¥HTTP response bodyä¸­ã€‚ä¸€èˆ¬åœ¨å¼‚æ­¥è·å–æ•°æ®æ—¶ä½¿ç”¨ï¼Œåœ¨ä½¿ç”¨@RequestMappingåï¼Œè¿”å›å€¼é€šå¸¸è§£æä¸ºè·³è½¬è·¯å¾„ï¼ŒåŠ ä¸Š@responsebodyåè¿”å›ç»“æœä¸ä¼šè¢«è§£æä¸ºè·³è½¬è·¯å¾„ï¼Œè€Œæ˜¯ç›´æ¥å†™å…¥HTTP response bodyä¸­ã€‚æ¯”å¦‚å¼‚æ­¥è·å–jsonæ•°æ®ï¼ŒåŠ ä¸Š@Responsebodyåï¼Œä¼šç›´æ¥è¿”å›jsonæ•°æ®ã€‚\n@RequestMapping: RequestMappingæ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†è¯·æ±‚åœ°å€æ˜ å°„çš„æ³¨è§£ï¼›æä¾›è·¯ç”±ä¿¡æ¯ï¼Œè´Ÿè´£URLåˆ°Controllerä¸­çš„å…·ä½“å‡½æ•°çš„æ˜ å°„ï¼Œå¯ç”¨äºç±»æˆ–æ–¹æ³•ä¸Šã€‚ç”¨äºç±»ä¸Šï¼Œè¡¨ç¤ºç±»ä¸­çš„æ‰€æœ‰å“åº”è¯·æ±‚çš„æ–¹æ³•éƒ½æ˜¯ä»¥è¯¥åœ°å€ä½œä¸ºçˆ¶è·¯å¾„ã€‚\n@AutoWired: æŠŠé…ç½®å¥½çš„Beanæ‹¿æ¥ç”¨ï¼Œå®Œæˆå±æ€§ã€æ–¹æ³•çš„ç»„è£…ï¼Œå®ƒå¯ä»¥å¯¹ç±»æˆå‘˜å˜é‡ã€æ–¹æ³•åŠæ„é€ å‡½æ•°è¿›è¡Œæ ‡æ³¨ï¼Œå®Œæˆè‡ªåŠ¨è£…é…çš„å·¥ä½œã€‚\n@Qualifier: å½“æœ‰å¤šä¸ªåŒä¸€ç±»å‹çš„Beanæ—¶ï¼Œå¯ä»¥ç”¨@Qualifier(\u0026ldquo;name\u0026rdquo;)æ¥æŒ‡å®šã€‚ä¸@Autowiredé…åˆä½¿ç”¨ã€‚\n@Bean: æ”¾åœ¨æ–¹æ³•ä¸Šé¢ï¼Œè€Œä¸æ˜¯ç±»ä¸Šé¢ï¼Œæ„æ€æ˜¯è¯¥æ–¹æ³•äº§ç”Ÿçš„Beanï¼Œäº¤ç»™ Spring æ¥ç®¡ç†ã€‚\n@Component: æ³›æŒ‡ç»„ä»¶ï¼Œå½“ç»„ä»¶ä¸å¥½å½’ç±»çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ³¨è§£æ¥æ ‡æ³¨ã€‚\n@Service: ä¸€èˆ¬ä½œç”¨äº service å±‚çš„ç»„ä»¶ã€‚\n@Repository: ç”¨äºæ ‡æ³¨æ•°æ®è®¿é—®ç»„ä»¶ï¼Œå³DAOç»„ä»¶ã€‚\n2.2. SpringBoot å¼‚å¸¸å¤„ç† é€šè¿‡@ControllerAdviceå’Œ@ExceptionHandleræ¥å¤„ç†å…¨å±€å¼‚å¸¸ã€‚\nè¯¦ç»†å†…å®¹å‚è€ƒæ–‡ç« ï¼šã€ŠSpringBootå¼‚å¸¸å¤„ç†ã€‹\n2.3. SpringBoot ä¸­å¦‚ä½•å®ç°è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨ï¼Ÿ ï¼ˆ1ï¼‰è¿‡æ»¤å™¨\nspring boot ä¸­è‡ªå®šä¹‰è¿‡æ»¤å™¨åªéœ€è¦å®ç° Filter æ¥å£ï¼Œé‡å†™é‡Œé¢çš„init() ,doFilter(),destroy()æ–¹æ³•å³å¯ã€‚\npublic interface Filter { //åˆå§‹åŒ–è¿‡æ»¤å™¨åæ‰§è¡Œçš„æ“ä½œ default void init(FilterConfig filterConfig) throws ServletException { } // å¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤ void doFilter(ServletRequest var1, ServletResponse var2, FilterChain var3) throws IOException, ServletException; // é”€æ¯è¿‡æ»¤å™¨åæ‰§è¡Œçš„æ“ä½œï¼Œä¸»è¦ç”¨æˆ·å¯¹æŸäº›èµ„æºçš„å›æ”¶ default void destroy() { } }  åœ¨é…ç½®ä¸­æ³¨å†Œè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ã€‚\n@Configuration public class MyFilterConfig { @Autowired MyFilter myFilter; @Bean public FilterRegistrationBean\u0026lt;MyFilter\u0026gt; thirdFilter() { FilterRegistrationBean\u0026lt;MyFilter\u0026gt; filterRegistrationBean = new FilterRegistrationBean\u0026lt;\u0026gt;(); filterRegistrationBean.setFilter(myFilter); filterRegistrationBean.setUrlPatterns(new ArrayList\u0026lt;\u0026gt;(Arrays.asList(\u0026quot;/api/*\u0026quot;))); return filterRegistrationBean; } }  å¦‚æœæœ‰å¤šä¸ªè¿‡æ»¤å™¨ï¼Œå¯ä»¥åœ¨é…ç½®ä¸­è®¾ç½®ä¸€ä¸‹é¡ºåºï¼ŒfilterRegistrationBean.setOrder(xx);\nè¯¦æƒ…å¯ä»¥å‚è€ƒæ–‡ç« ï¼šã€ŠSpringBoot å®ç°è¿‡æ»¤å™¨ã€‹\nï¼ˆ2ï¼‰æ‹¦æˆªå™¨\nå¦‚æœä½ éœ€è¦è‡ªå®šä¹‰ Interceptor çš„è¯å¿…é¡»å®ç° org.springframework.web.servlet.HandlerInterceptoræ¥å£æˆ–ç»§æ‰¿ org.springframework.web.servlet.handler.HandlerInterceptorAdapterç±»ï¼Œå¹¶ä¸”éœ€è¦é‡å†™ä¸‹é¢ä¸‹é¢3ä¸ªæ–¹æ³•ï¼š\npublic boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)  æ³¨æ„ï¼š preHandleæ–¹æ³•è¿”å› trueæˆ– falseã€‚å¦‚æœè¿”å› trueï¼Œåˆ™æ„å‘³ç€è¯·æ±‚å°†ç»§ç»­åˆ°è¾¾ Controller è¢«å¤„ç†ã€‚\n3. MyBatis","date":"2020å¹´12æœˆ17æ—¥","permalink":"https://ahamoment.cn/posts/interview/interview-spring/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡åŒ…å«spring, spring boot, spring mvc ä»¥åŠ mybatisçš„é¢è¯•é¢˜\u003c/p\u003e\n\u003c/blockquote\u003e","title":"Springç³»åˆ—é¢è¯•é¢˜"},{"contents":" æœ¬æ–‡æ”¶é›†JavaåŸºç¡€çŸ¥è¯†ç‚¹ç›¸å…³çš„é¢è¯•é¢˜ç›®\n 1. Java åŸºç¡€ 1.1. è¯­æ³• 1.1.1 Java æ³›å‹äº†è§£ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯ç±»å‹æ“¦é™¤ï¼Ÿä»‹ç»ä¸€ä¸‹å¸¸ç”¨çš„é€šé…ç¬¦ï¼Ÿ Java æ³›å‹ï¼ˆgenericsï¼‰æ˜¯ JDK 5 ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§, æ³›å‹æä¾›äº†ç¼–è¯‘æ—¶ç±»å‹å®‰å…¨æ£€æµ‹æœºåˆ¶ï¼Œè¯¥æœºåˆ¶å…è®¸å¼€å‘è€…åœ¨ç¼–è¯‘æ—¶æ£€æµ‹åˆ°éæ³•çš„ç±»å‹ã€‚æ³›å‹çš„æœ¬è´¨æ˜¯å‚æ•°åŒ–ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æ“ä½œçš„æ•°æ®ç±»å‹è¢«æŒ‡å®šä¸ºä¸€ä¸ªå‚æ•°ã€‚\nJava çš„æ³›å‹æ˜¯ä¼ªæ³›å‹ï¼Œè¿™æ˜¯å› ä¸º Java åœ¨ç¼–è¯‘æœŸé—´ï¼Œæ‰€æœ‰çš„æ³›å‹ä¿¡æ¯éƒ½ä¼šè¢«æ“¦æ‰ï¼Œè¿™ä¹Ÿå°±æ˜¯é€šå¸¸æ‰€è¯´ç±»å‹æ“¦é™¤ ã€‚ æ›´å¤šå…³äºç±»å‹æ“¦é™¤çš„é—®é¢˜ï¼Œå¯ä»¥æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ï¼šã€ŠJava æ³›å‹ç±»å‹æ“¦é™¤ä»¥åŠç±»å‹æ“¦é™¤å¸¦æ¥çš„é—®é¢˜ã€‹ ã€‚\nList\u0026lt;Integer\u0026gt; list = new ArrayList\u0026lt;\u0026gt;(); list.add(12); //è¿™é‡Œç›´æ¥æ·»åŠ ä¼šæŠ¥é”™ list.add(\u0026quot;a\u0026quot;); Class\u0026lt;? extends List\u0026gt; clazz = list.getClass(); Method add = clazz.getDeclaredMethod(\u0026quot;add\u0026quot;, Object.class); //ä½†æ˜¯é€šè¿‡åå°„æ·»åŠ ï¼Œæ˜¯å¯ä»¥çš„ add.invoke(list, \u0026quot;kl\u0026quot;); System.out.println(list)  æ³›å‹ä¸€èˆ¬æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼:æ³›å‹ç±»ã€æ³›å‹æ¥å£ã€æ³›å‹æ–¹æ³•ã€‚\n1.æ³›å‹ç±»ï¼š\n//æ­¤å¤„Tå¯ä»¥éšä¾¿å†™ä¸ºä»»æ„æ ‡è¯†ï¼Œå¸¸è§çš„å¦‚Tã€Eã€Kã€Vç­‰å½¢å¼çš„å‚æ•°å¸¸ç”¨äºè¡¨ç¤ºæ³›å‹ //åœ¨å®ä¾‹åŒ–æ³›å‹ç±»æ—¶ï¼Œå¿…é¡»æŒ‡å®šTçš„å…·ä½“ç±»å‹ public class Generic\u0026lt;T\u0026gt;{ private T key; public Generic(T key) { this.key = key; } public T getKey(){ return key; } }  å¦‚ä½•å®ä¾‹åŒ–æ³›å‹ç±»ï¼š\nGeneric\u0026lt;Integer\u0026gt; genericInteger = new Generic\u0026lt;Integer\u0026gt;(123456);  2.æ³›å‹æ¥å£ ï¼š\npublic interface Generator\u0026lt;T\u0026gt; { public T method(); }  å®ç°æ³›å‹æ¥å£ï¼Œä¸æŒ‡å®šç±»å‹ï¼š\nclass GeneratorImpl\u0026lt;T\u0026gt; implements Generator\u0026lt;T\u0026gt;{ @Override public T method() { return null; } }  å®ç°æ³›å‹æ¥å£ï¼ŒæŒ‡å®šç±»å‹ï¼š\nclass GeneratorImpl\u0026lt;T\u0026gt; implements Generator\u0026lt;String\u0026gt;{ @Override public String method() { return \u0026quot;hello\u0026quot;; } }  3.æ³›å‹æ–¹æ³• ï¼š\npublic static \u0026lt; E \u0026gt; void printArray( E[] inputArray ) { for ( E element : inputArray ){ System.out.printf( \u0026quot;%s \u0026quot;, element ); } System.out.println(); }  ä½¿ç”¨ï¼š\n// åˆ›å»ºä¸åŒç±»å‹æ•°ç»„ï¼š Integer, Double å’Œ Character Integer[] intArray = { 1, 2, 3 }; String[] stringArray = { \u0026quot;Hello\u0026quot;, \u0026quot;World\u0026quot; }; printArray( intArray ); printArray( stringArray );  å¸¸ç”¨çš„é€šé…ç¬¦ä¸ºï¼š Tï¼ŒEï¼ŒKï¼ŒVï¼Œï¼Ÿ\n ï¼Ÿ è¡¨ç¤ºä¸ç¡®å®šçš„ java ç±»å‹ T (type) è¡¨ç¤ºå…·ä½“çš„ä¸€ä¸ª java ç±»å‹ K V (key value) åˆ†åˆ«ä»£è¡¨ java é”®å€¼ä¸­çš„ Key Value E (element) ä»£è¡¨ Element  æ›´å¤šå…³äº Java æ³›å‹ä¸­çš„é€šé…ç¬¦å¯ä»¥æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ï¼šã€ŠèŠä¸€èŠ-JAVA æ³›å‹ä¸­çš„é€šé…ç¬¦ Tï¼ŒEï¼ŒKï¼ŒVï¼Œï¼Ÿã€‹\n1.1.2. == å’Œ equals çš„åŒºåˆ« == : å®ƒçš„ä½œç”¨æ˜¯åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡çš„åœ°å€æ˜¯ä¸æ˜¯ç›¸ç­‰ã€‚å³åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚(åŸºæœ¬æ•°æ®ç±»å‹==æ¯”è¾ƒçš„æ˜¯å€¼ï¼Œå¼•ç”¨æ•°æ®ç±»å‹==æ¯”è¾ƒçš„æ˜¯å†…å­˜åœ°å€)\n å› ä¸º Java åªæœ‰å€¼ä¼ é€’ï¼Œæ‰€ä»¥ï¼Œå¯¹äº == æ¥è¯´ï¼Œä¸ç®¡æ˜¯æ¯”è¾ƒåŸºæœ¬æ•°æ®ç±»å‹ï¼Œè¿˜æ˜¯å¼•ç”¨æ•°æ®ç±»å‹çš„å˜é‡ï¼Œå…¶æœ¬è´¨æ¯”è¾ƒçš„éƒ½æ˜¯å€¼ï¼Œåªæ˜¯å¼•ç”¨ç±»å‹å˜é‡å­˜çš„å€¼æ˜¯å¯¹è±¡çš„åœ°å€ã€‚\n equals() : å®ƒçš„ä½œç”¨ä¹Ÿæ˜¯åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ï¼Œå®ƒä¸èƒ½ç”¨äºæ¯”è¾ƒåŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡ã€‚equals()æ–¹æ³•å­˜åœ¨äºObjectç±»ä¸­ï¼Œè€ŒObjectç±»æ˜¯æ‰€æœ‰ç±»çš„ç›´æ¥æˆ–é—´æ¥çˆ¶ç±»ã€‚\nObjectç±»equals()æ–¹æ³•ï¼š\npublic boolean equals(Object obj) { return (this == obj); }  equals() æ–¹æ³•å­˜åœ¨ä¸¤ç§ä½¿ç”¨æƒ…å†µï¼š\n æƒ…å†µ 1ï¼šç±»æ²¡æœ‰è¦†ç›– equals()æ–¹æ³•ã€‚åˆ™é€šè¿‡equals()æ¯”è¾ƒè¯¥ç±»çš„ä¸¤ä¸ªå¯¹è±¡æ—¶ï¼Œç­‰ä»·äºé€šè¿‡â€œ==â€æ¯”è¾ƒè¿™ä¸¤ä¸ªå¯¹è±¡ã€‚ä½¿ç”¨çš„é»˜è®¤æ˜¯ Objectç±»equals()æ–¹æ³•ã€‚ æƒ…å†µ 2ï¼šç±»è¦†ç›–äº† equals()æ–¹æ³•ï¼Œæ˜¯å¯¹å¯¹è±¡å†…å®¹çš„æ¯”è¾ƒã€‚ä¸€èˆ¬ï¼Œæˆ‘ä»¬éƒ½è¦†ç›– equals()æ–¹æ³•æ¥ä¸¤ä¸ªå¯¹è±¡çš„å†…å®¹ç›¸ç­‰ï¼›è‹¥å®ƒä»¬çš„å†…å®¹ç›¸ç­‰ï¼Œåˆ™è¿”å› true(å³ï¼Œè®¤ä¸ºè¿™ä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰)ã€‚  ä¸¾ä¸ªä¾‹å­ï¼š\npublic class test1 { public static void main(String[] args) { String a = new String(\u0026quot;ab\u0026quot;); // a ä¸ºä¸€ä¸ªå¼•ç”¨ String b = new String(\u0026quot;ab\u0026quot;); // bä¸ºå¦ä¸€ä¸ªå¼•ç”¨,å¯¹è±¡çš„å†…å®¹ä¸€æ · String aa = \u0026quot;ab\u0026quot;; // æ”¾åœ¨å¸¸é‡æ± ä¸­ String bb = \u0026quot;ab\u0026quot;; // ä»å¸¸é‡æ± ä¸­æŸ¥æ‰¾ if (aa == bb) // true System.out.println(\u0026quot;aa==bb\u0026quot;); if (a == b) // falseï¼ŒéåŒä¸€å¯¹è±¡ System.out.println(\u0026quot;a==b\u0026quot;); if (a.equals(b)) // true System.out.println(\u0026quot;aEQb\u0026quot;); if (42 == 42.0) { // true System.out.println(\u0026quot;true\u0026quot;); } } }  è¯´æ˜ï¼š\n String ä¸­çš„ equals æ–¹æ³•æ˜¯è¢«é‡å†™è¿‡çš„ï¼Œå› ä¸º Object çš„ equals æ–¹æ³•æ˜¯æ¯”è¾ƒçš„å¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œè€Œ String çš„ equals æ–¹æ³•æ¯”è¾ƒçš„æ˜¯å¯¹è±¡çš„å€¼ã€‚ å½“åˆ›å»º String ç±»å‹çš„å¯¹è±¡æ—¶ï¼Œè™šæ‹Ÿæœºä¼šåœ¨å¸¸é‡æ± ä¸­æŸ¥æ‰¾æœ‰æ²¡æœ‰å·²ç»å­˜åœ¨çš„å€¼å’Œè¦åˆ›å»ºçš„å€¼ç›¸åŒçš„å¯¹è±¡ï¼Œå¦‚æœæœ‰å°±æŠŠå®ƒèµ‹ç»™å½“å‰å¼•ç”¨ã€‚å¦‚æœæ²¡æœ‰å°±åœ¨å¸¸é‡æ± ä¸­é‡æ–°åˆ›å»ºä¸€ä¸ª String å¯¹è±¡ã€‚  Stringç±»equals()æ–¹æ³•ï¼š\npublic boolean equals(Object anObject) { if (this == anObject) { return true; } if (anObject instanceof String) { String anotherString = (String)anObject; int n = value.length; if (n == anotherString.value.length) { char v1[] = value; char v2[] = anotherString.value; int i = 0; while (n-- != 0) { if (v1[i] != v2[i]) return false; i++; } return true; } } return false; }  1.1.3. hashCode() ä¸ equals() é¢è¯•å®˜å¯èƒ½ä¼šé—®ä½ ï¼šâ€œä½ é‡å†™è¿‡ hashcode å’Œ equalsä¹ˆï¼Œä¸ºä»€ä¹ˆé‡å†™ equals æ—¶å¿…é¡»é‡å†™ hashCode æ–¹æ³•ï¼Ÿâ€\n1)hashCode()ä»‹ç»:\nhashCode() çš„ä½œç”¨æ˜¯è·å–å“ˆå¸Œç ï¼Œä¹Ÿç§°ä¸ºæ•£åˆ—ç ï¼›å®ƒå®é™…ä¸Šæ˜¯è¿”å›ä¸€ä¸ª int æ•´æ•°ã€‚è¿™ä¸ªå“ˆå¸Œç çš„ä½œç”¨æ˜¯ç¡®å®šè¯¥å¯¹è±¡åœ¨å“ˆå¸Œè¡¨ä¸­çš„ç´¢å¼•ä½ç½®ã€‚hashCode()å®šä¹‰åœ¨ JDK çš„ Object ç±»ä¸­ï¼Œè¿™å°±æ„å‘³ç€ Java ä¸­çš„ä»»ä½•ç±»éƒ½åŒ…å«æœ‰ hashCode() å‡½æ•°ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼š Object çš„ hashcode æ–¹æ³•æ˜¯æœ¬åœ°æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç”¨ c è¯­è¨€æˆ– c++ å®ç°çš„ï¼Œè¯¥æ–¹æ³•é€šå¸¸ç”¨æ¥å°†å¯¹è±¡çš„ å†…å­˜åœ°å€ è½¬æ¢ä¸ºæ•´æ•°ä¹‹åè¿”å›ã€‚\npublic native int hashCode();  æ•£åˆ—è¡¨å­˜å‚¨çš„æ˜¯é”®å€¼å¯¹(key-value)ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯ï¼šèƒ½æ ¹æ®â€œé”®â€å¿«é€Ÿçš„æ£€ç´¢å‡ºå¯¹åº”çš„â€œå€¼â€ã€‚è¿™å…¶ä¸­å°±åˆ©ç”¨åˆ°äº†æ•£åˆ—ç ï¼ï¼ˆå¯ä»¥å¿«é€Ÿæ‰¾åˆ°æ‰€éœ€è¦çš„å¯¹è±¡ï¼‰\n2)ä¸ºä»€ä¹ˆè¦æœ‰ hashCodeï¼Ÿ\næˆ‘ä»¬ä»¥HashSet å¦‚ä½•æ£€æŸ¥é‡å¤â€ä¸ºä¾‹å­æ¥è¯´æ˜ä¸ºä»€ä¹ˆè¦æœ‰ hashCodeï¼Ÿ\nå½“ä½ æŠŠå¯¹è±¡åŠ å…¥ HashSet æ—¶ï¼ŒHashSet ä¼šå…ˆè®¡ç®—å¯¹è±¡çš„ hashcode å€¼æ¥åˆ¤æ–­å¯¹è±¡åŠ å…¥çš„ä½ç½®ï¼ŒåŒæ—¶ä¹Ÿä¼šä¸å…¶ä»–å·²ç»åŠ å…¥çš„å¯¹è±¡çš„ hashcode å€¼ä½œæ¯”è¾ƒï¼Œå¦‚æœæ²¡æœ‰ç›¸ç¬¦çš„ hashcodeï¼ŒHashSet ä¼šå‡è®¾å¯¹è±¡æ²¡æœ‰é‡å¤å‡ºç°ã€‚ä½†æ˜¯å¦‚æœå‘ç°æœ‰ç›¸åŒ hashcode å€¼çš„å¯¹è±¡ï¼Œè¿™æ—¶ä¼šè°ƒç”¨ equals() æ–¹æ³•æ¥æ£€æŸ¥ hashcode ç›¸ç­‰çš„å¯¹è±¡æ˜¯å¦çœŸçš„ç›¸åŒã€‚å¦‚æœä¸¤è€…ç›¸åŒï¼ŒHashSet å°±ä¸ä¼šè®©å…¶åŠ å…¥æ“ä½œæˆåŠŸã€‚å¦‚æœä¸åŒçš„è¯ï¼Œå°±ä¼šé‡æ–°æ•£åˆ—åˆ°å…¶ä»–ä½ç½®ã€‚è¿™æ ·æˆ‘ä»¬å°±å¤§å¤§å‡å°‘äº† equals çš„æ¬¡æ•°ï¼Œç›¸åº”å°±å¤§å¤§æé«˜äº†æ‰§è¡Œé€Ÿåº¦ã€‚\n3) ä¸ºä»€ä¹ˆé‡å†™ equals æ—¶å¿…é¡»é‡å†™ hashCode æ–¹æ³•ï¼Ÿ\nå¦‚æœä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰ï¼Œåˆ™ hashcode ä¸€å®šä¹Ÿæ˜¯ç›¸åŒçš„ã€‚ä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰ï¼Œå¯¹ä¸¤ä¸ªå¯¹è±¡åˆ†åˆ«è°ƒç”¨ equals æ–¹æ³•éƒ½è¿”å› trueã€‚ä½†æ˜¯ï¼Œä¸¤ä¸ªå¯¹è±¡æœ‰ç›¸åŒçš„ hashcode å€¼ï¼Œå®ƒä»¬ä¹Ÿä¸ä¸€å®šæ˜¯ç›¸ç­‰çš„ ã€‚å› æ­¤ï¼Œequals æ–¹æ³•è¢«è¦†ç›–è¿‡ï¼Œåˆ™ hashCode æ–¹æ³•ä¹Ÿå¿…é¡»è¢«è¦†ç›–ã€‚\n hashCode()çš„é»˜è®¤è¡Œä¸ºæ˜¯å¯¹å †ä¸Šçš„å¯¹è±¡äº§ç”Ÿç‹¬ç‰¹å€¼ã€‚å¦‚æœæ²¡æœ‰é‡å†™ hashCode()ï¼Œåˆ™è¯¥ class çš„ä¸¤ä¸ªå¯¹è±¡æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šç›¸ç­‰ï¼ˆå³ä½¿è¿™ä¸¤ä¸ªå¯¹è±¡æŒ‡å‘ç›¸åŒçš„æ•°æ®ï¼‰\n 4)ä¸ºä»€ä¹ˆä¸¤ä¸ªå¯¹è±¡æœ‰ç›¸åŒçš„ hashcode å€¼ï¼Œå®ƒä»¬ä¹Ÿä¸ä¸€å®šæ˜¯ç›¸ç­‰çš„ï¼Ÿ\nåœ¨è¿™é‡Œè§£é‡Šä¸€ä½å°ä¼™ä¼´çš„é—®é¢˜ã€‚ä»¥ä¸‹å†…å®¹æ‘˜è‡ªã€ŠHead Fisrt Javaã€‹ã€‚\nå› ä¸º hashCode() æ‰€ä½¿ç”¨çš„æ‚å‡‘ç®—æ³•ä¹Ÿè®¸åˆšå¥½ä¼šè®©å¤šä¸ªå¯¹è±¡ä¼ å›ç›¸åŒçš„æ‚å‡‘å€¼ã€‚è¶Šç³Ÿç³•çš„æ‚å‡‘ç®—æ³•è¶Šå®¹æ˜“ç¢°æ’ï¼Œä½†è¿™ä¹Ÿä¸æ•°æ®å€¼åŸŸåˆ†å¸ƒçš„ç‰¹æ€§æœ‰å…³ï¼ˆæ‰€è°“ç¢°æ’ä¹Ÿå°±æ˜¯æŒ‡çš„æ˜¯ä¸åŒçš„å¯¹è±¡å¾—åˆ°ç›¸åŒçš„ hashCodeã€‚\næˆ‘ä»¬åˆšåˆšä¹Ÿæåˆ°äº† HashSet,å¦‚æœ HashSet åœ¨å¯¹æ¯”çš„æ—¶å€™ï¼ŒåŒæ ·çš„ hashcode æœ‰å¤šä¸ªå¯¹è±¡ï¼Œå®ƒä¼šä½¿ç”¨ equals() æ¥åˆ¤æ–­æ˜¯å¦çœŸçš„ç›¸åŒã€‚ä¹Ÿå°±æ˜¯è¯´ hashcode åªæ˜¯ç”¨æ¥ç¼©å°æŸ¥æ‰¾æˆæœ¬ã€‚\næ›´å¤šå…³äº hashcode() å’Œ equals() çš„å†…å®¹å¯ä»¥æŸ¥çœ‹ï¼šJava hashCode() å’Œ equals()çš„è‹¥å¹²é—®é¢˜è§£ç­”\n1.2. æ•°æ®ç±»å‹ 1.2.1 String StringBuffer å’Œ StringBuilder çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ? String ä¸ºä»€ä¹ˆæ˜¯ä¸å¯å˜çš„? ç®€å•çš„æ¥è¯´ï¼šString ç±»ä¸­ä½¿ç”¨ final å…³é”®å­—ä¿®é¥°å­—ç¬¦æ•°ç»„æ¥ä¿å­˜å­—ç¬¦ä¸²ï¼Œprivate final char value[]ï¼Œæ‰€ä»¥String å¯¹è±¡æ˜¯ä¸å¯å˜çš„ã€‚\n åœ¨ Java 9 ä¹‹åï¼ŒString ç±»çš„å®ç°æ”¹ç”¨ byte æ•°ç»„å­˜å‚¨å­—ç¬¦ä¸² private final byte[] value;\n è€Œ StringBuilder ä¸ StringBuffer éƒ½ç»§æ‰¿è‡ª AbstractStringBuilder ç±»ï¼Œåœ¨ AbstractStringBuilder ä¸­ä¹Ÿæ˜¯ä½¿ç”¨å­—ç¬¦æ•°ç»„ä¿å­˜å­—ç¬¦ä¸²char[] value ä½†æ˜¯æ²¡æœ‰ç”¨ final å…³é”®å­—ä¿®é¥°ï¼Œæ‰€ä»¥è¿™ä¸¤ç§å¯¹è±¡éƒ½æ˜¯å¯å˜çš„ã€‚\nçº¿ç¨‹å®‰å…¨æ€§\nString ä¸­çš„å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œä¹Ÿå°±å¯ä»¥ç†è§£ä¸ºå¸¸é‡ï¼Œçº¿ç¨‹å®‰å…¨ã€‚\nStringBuffer å¯¹æ–¹æ³•åŠ äº†åŒæ­¥é”æˆ–è€…å¯¹è°ƒç”¨çš„æ–¹æ³•åŠ äº†åŒæ­¥é”ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚\nStringBuilder å¹¶æ²¡æœ‰å¯¹æ–¹æ³•è¿›è¡ŒåŠ åŒæ­¥é”ï¼Œæ‰€ä»¥æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚\næ€§èƒ½\næ¯æ¬¡å¯¹ String ç±»å‹è¿›è¡Œæ”¹å˜çš„æ—¶å€™ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ String å¯¹è±¡ï¼Œç„¶åå°†æŒ‡é’ˆæŒ‡å‘æ–°çš„ String å¯¹è±¡ã€‚StringBuffer æ¯æ¬¡éƒ½ä¼šå¯¹ StringBuffer å¯¹è±¡æœ¬èº«è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯ç”Ÿæˆæ–°çš„å¯¹è±¡å¹¶æ”¹å˜å¯¹è±¡å¼•ç”¨ã€‚ç›¸åŒæƒ…å†µä¸‹ä½¿ç”¨ StringBuilder ç›¸æ¯”ä½¿ç”¨ StringBuffer ä»…èƒ½è·å¾— 10%~15% å·¦å³çš„æ€§èƒ½æå‡ï¼Œä½†å´è¦å†’å¤šçº¿ç¨‹ä¸å®‰å…¨çš„é£é™©ã€‚\nå¯¹äºä¸‰è€…ä½¿ç”¨çš„æ€»ç»“ï¼š\n æ“ä½œå°‘é‡çš„æ•°æ®: é€‚ç”¨ String å•çº¿ç¨‹æ“ä½œå­—ç¬¦ä¸²ç¼“å†²åŒºä¸‹æ“ä½œå¤§é‡æ•°æ®: é€‚ç”¨ StringBuilder å¤šçº¿ç¨‹æ“ä½œå­—ç¬¦ä¸²ç¼“å†²åŒºä¸‹æ“ä½œå¤§é‡æ•°æ®: é€‚ç”¨ StringBuffer  1.3. æ–¹æ³• 1.3.1 é‡è½½å’Œé‡å†™çš„åŒºåˆ« é‡è½½å°±æ˜¯åŒæ ·çš„ä¸€ä¸ªæ–¹æ³•èƒ½å¤Ÿæ ¹æ®è¾“å…¥æ•°æ®çš„ä¸åŒï¼Œåšå‡ºä¸åŒçš„å¤„ç†ã€‚\né‡å†™å°±æ˜¯å½“å­ç±»ç»§æ‰¿è‡ªçˆ¶ç±»çš„ç›¸åŒæ–¹æ³•ï¼Œè¾“å…¥æ•°æ®ä¸€æ ·ï¼Œä½†è¦åšå‡ºæœ‰åˆ«äºçˆ¶ç±»çš„å“åº”æ—¶ï¼Œä½ å°±è¦è¦†ç›–çˆ¶ç±»æ–¹æ³•ã€‚\n   åŒºåˆ«ç‚¹ é‡è½½æ–¹æ³• é‡å†™æ–¹æ³•     å‘ç”ŸèŒƒå›´ åŒä¸€ä¸ªç±» å­ç±»   å‚æ•°åˆ—è¡¨ å¿…é¡»ä¿®æ”¹ ä¸€å®šä¸èƒ½ä¿®æ”¹   è¿”å›ç±»å‹ å¯ä¿®æ”¹ å­ç±»æ–¹æ³•è¿”å›å€¼ç±»å‹åº”æ¯”çˆ¶ç±»æ–¹æ³•è¿”å›å€¼ç±»å‹æ›´å°æˆ–ç›¸ç­‰   å¼‚å¸¸ å¯ä¿®æ”¹ å­ç±»æ–¹æ³•å£°æ˜æŠ›å‡ºçš„å¼‚å¸¸ç±»åº”æ¯”çˆ¶ç±»æ–¹æ³•å£°æ˜æŠ›å‡ºçš„å¼‚å¸¸ç±»æ›´å°æˆ–ç›¸ç­‰ï¼›   è®¿é—®ä¿®é¥°ç¬¦ å¯ä¿®æ”¹ ä¸€å®šä¸èƒ½åšæ›´ä¸¥æ ¼çš„é™åˆ¶ï¼ˆå¯ä»¥é™ä½é™åˆ¶ï¼‰   å‘ç”Ÿé˜¶æ®µ ç¼–è¯‘æœŸ è¿è¡ŒæœŸ    1.4 é¢å‘å¯¹è±¡ 1.4.1. åœ¨ Java ä¸­å®šä¹‰ä¸€ä¸ªä¸åšäº‹ä¸”æ²¡æœ‰å‚æ•°çš„æ„é€ æ–¹æ³•çš„ä½œç”¨ Java ç¨‹åºåœ¨æ‰§è¡Œå­ç±»çš„æ„é€ æ–¹æ³•ä¹‹å‰ï¼Œå¦‚æœæ²¡æœ‰ç”¨ super()æ¥è°ƒç”¨çˆ¶ç±»ç‰¹å®šçš„æ„é€ æ–¹æ³•ï¼Œåˆ™ä¼šè°ƒç”¨çˆ¶ç±»ä¸­â€œæ²¡æœ‰å‚æ•°çš„æ„é€ æ–¹æ³•â€ã€‚å› æ­¤ï¼Œå¦‚æœçˆ¶ç±»ä¸­åªå®šä¹‰äº†æœ‰å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œè€Œåœ¨å­ç±»çš„æ„é€ æ–¹æ³•ä¸­åˆæ²¡æœ‰ç”¨ super()æ¥è°ƒç”¨çˆ¶ç±»ä¸­ç‰¹å®šçš„æ„é€ æ–¹æ³•ï¼Œåˆ™ç¼–è¯‘æ—¶å°†å‘ç”Ÿé”™è¯¯ï¼Œå› ä¸º Java ç¨‹åºåœ¨çˆ¶ç±»ä¸­æ‰¾ä¸åˆ°æ²¡æœ‰å‚æ•°çš„æ„é€ æ–¹æ³•å¯ä¾›æ‰§è¡Œã€‚è§£å†³åŠæ³•æ˜¯åœ¨çˆ¶ç±»é‡ŒåŠ ä¸Šä¸€ä¸ªä¸åšäº‹ä¸”æ²¡æœ‰å‚æ•°çš„æ„é€ æ–¹æ³•ã€‚\n1.4.2. é¢å¯¹å¯¹è±¡çš„ä¸‰å¤§ç‰¹æ€§ å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚\nå°è£…æ˜¯æŒ‡æŠŠä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯ï¼ˆä¹Ÿå°±æ˜¯å±æ€§ï¼‰éšè—åœ¨å¯¹è±¡å†…éƒ¨ï¼Œä¸å…è®¸å¤–éƒ¨å¯¹è±¡ç›´æ¥è®¿é—®å¯¹è±¡çš„å†…éƒ¨ä¿¡æ¯ã€‚\nç»§æ‰¿ï¼šä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œç›¸äº’ä¹‹é—´ç»å¸¸æœ‰ä¸€å®šæ•°é‡çš„å…±åŒç‚¹ã€‚\nå¤šæ€ï¼Œé¡¾åæ€ä¹‰ï¼Œè¡¨ç¤ºä¸€ä¸ªå¯¹è±¡å…·æœ‰å¤šç§çš„çŠ¶æ€ã€‚å…·ä½“è¡¨ç°ä¸ºçˆ¶ç±»çš„å¼•ç”¨æŒ‡å‘å­ç±»çš„å®ä¾‹ã€‚\n1.4. åå°„æœºåˆ¶ JAVA åå°„æœºåˆ¶æ˜¯åœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•å’Œå±æ€§ï¼›è¿™ç§åŠ¨æ€è·å–çš„ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•çš„åŠŸèƒ½ç§°ä¸º java è¯­è¨€çš„åå°„æœºåˆ¶ã€‚\nåå°„æœºåˆ¶ä¼˜ç¼ºç‚¹\n ä¼˜ç‚¹ï¼š è¿è¡ŒæœŸç±»å‹çš„åˆ¤æ–­ï¼ŒåŠ¨æ€åŠ è½½ç±»ï¼Œæé«˜ä»£ç çµæ´»åº¦ã€‚ ç¼ºç‚¹ï¼š 1,æ€§èƒ½ç“¶é¢ˆï¼šåå°„ç›¸å½“äºä¸€ç³»åˆ—è§£é‡Šæ“ä½œï¼Œé€šçŸ¥ JVM è¦åšçš„äº‹æƒ…ï¼Œæ€§èƒ½æ¯”ç›´æ¥çš„ java ä»£ç è¦æ…¢å¾ˆå¤šã€‚2,å®‰å…¨é—®é¢˜ï¼Œè®©æˆ‘ä»¬å¯ä»¥åŠ¨æ€æ“ä½œæ”¹å˜ç±»çš„å±æ€§åŒæ—¶ä¹Ÿå¢åŠ äº†ç±»çš„å®‰å…¨éšæ‚£ã€‚  åå°„çš„åº”ç”¨åœºæ™¯\nåå°„æ˜¯æ¡†æ¶è®¾è®¡çš„çµé­‚ã€‚\nåœ¨æˆ‘ä»¬å¹³æ—¶çš„é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼ŒåŸºæœ¬ä¸Šå¾ˆå°‘ä¼šç›´æ¥ä½¿ç”¨åˆ°åå°„æœºåˆ¶ï¼Œä½†è¿™ä¸èƒ½è¯´æ˜åå°„æœºåˆ¶æ²¡æœ‰ç”¨ï¼Œå®é™…ä¸Šæœ‰å¾ˆå¤šè®¾è®¡ã€å¼€å‘éƒ½ä¸åå°„æœºåˆ¶æœ‰å…³ï¼Œä¾‹å¦‚æ¨¡å—åŒ–çš„å¼€å‘ï¼Œé€šè¿‡åå°„å»è°ƒç”¨å¯¹åº”çš„å­—èŠ‚ç ï¼›åŠ¨æ€ä»£ç†è®¾è®¡æ¨¡å¼ä¹Ÿé‡‡ç”¨äº†åå°„æœºåˆ¶ï¼Œè¿˜æœ‰æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„ Springï¼Hibernate ç­‰æ¡†æ¶ä¹Ÿå¤§é‡ä½¿ç”¨åˆ°äº†åå°„æœºåˆ¶ã€‚\nä¸¾ä¾‹ï¼š\n æˆ‘ä»¬åœ¨ä½¿ç”¨ JDBC è¿æ¥æ•°æ®åº“æ—¶ä½¿ç”¨ Class.forName()é€šè¿‡åå°„åŠ è½½æ•°æ®åº“çš„é©±åŠ¨ç¨‹åºï¼› Spring æ¡†æ¶çš„ IOCï¼ˆåŠ¨æ€åŠ è½½ç®¡ç† Beanï¼‰åˆ›å»ºå¯¹è±¡ä»¥åŠ AOPï¼ˆåŠ¨æ€ä»£ç†ï¼‰åŠŸèƒ½éƒ½å’Œåå°„æœ‰è”ç³»ï¼› åŠ¨æ€é…ç½®å®ä¾‹çš„å±æ€§ï¼›  1.5. æ–‡ä»¶ä¸IOæµ 1.5.1. BIO,NIO,AIO æœ‰ä»€ä¹ˆåŒºåˆ«?  BIO (Blocking I/O): åŒæ­¥é˜»å¡ I/O æ¨¡å¼ï¼Œæ•°æ®çš„è¯»å–å†™å…¥å¿…é¡»é˜»å¡åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ç­‰å¾…å…¶å®Œæˆã€‚åœ¨æ´»åŠ¨è¿æ¥æ•°ä¸æ˜¯ç‰¹åˆ«é«˜ï¼ˆå°äºå•æœº 1000ï¼‰çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ¨¡å‹æ˜¯æ¯”è¾ƒä¸é”™çš„ï¼Œå¯ä»¥è®©æ¯ä¸€ä¸ªè¿æ¥ä¸“æ³¨äºè‡ªå·±çš„ I/O å¹¶ä¸”ç¼–ç¨‹æ¨¡å‹ç®€å•ï¼Œä¹Ÿä¸ç”¨è¿‡å¤šè€ƒè™‘ç³»ç»Ÿçš„è¿‡è½½ã€é™æµç­‰é—®é¢˜ã€‚çº¿ç¨‹æ± æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¤©ç„¶çš„æ¼æ–—ï¼Œå¯ä»¥ç¼“å†²ä¸€äº›ç³»ç»Ÿå¤„ç†ä¸äº†çš„è¿æ¥æˆ–è¯·æ±‚ã€‚ä½†æ˜¯ï¼Œå½“é¢å¯¹åä¸‡ç”šè‡³ç™¾ä¸‡çº§è¿æ¥çš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„ BIO æ¨¡å‹æ˜¯æ— èƒ½ä¸ºåŠ›çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´é«˜æ•ˆçš„ I/O å¤„ç†æ¨¡å‹æ¥åº”å¯¹æ›´é«˜çš„å¹¶å‘é‡ã€‚ NIO (Non-blocking/New I/O): NIO æ˜¯ä¸€ç§åŒæ­¥éé˜»å¡çš„ I/O æ¨¡å‹ï¼Œåœ¨ Java 1.4 ä¸­å¼•å…¥äº† NIO æ¡†æ¶ï¼Œå¯¹åº” java.nio åŒ…ï¼Œæä¾›äº† Channel , Selectorï¼ŒBuffer ç­‰æŠ½è±¡ã€‚NIO ä¸­çš„ N å¯ä»¥ç†è§£ä¸º Non-blockingï¼Œä¸å•çº¯æ˜¯ Newã€‚å®ƒæ”¯æŒé¢å‘ç¼“å†²çš„ï¼ŒåŸºäºé€šé“çš„ I/O æ“ä½œæ–¹æ³•ã€‚ NIO æä¾›äº†ä¸ä¼ ç»Ÿ BIO æ¨¡å‹ä¸­çš„ Socket å’Œ ServerSocket ç›¸å¯¹åº”çš„ SocketChannel å’Œ ServerSocketChannel ä¸¤ç§ä¸åŒçš„å¥—æ¥å­—é€šé“å®ç°,ä¸¤ç§é€šé“éƒ½æ”¯æŒé˜»å¡å’Œéé˜»å¡ä¸¤ç§æ¨¡å¼ã€‚é˜»å¡æ¨¡å¼ä½¿ç”¨å°±åƒä¼ ç»Ÿä¸­çš„æ”¯æŒä¸€æ ·ï¼Œæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æ€§èƒ½å’Œå¯é æ€§éƒ½ä¸å¥½ï¼›éé˜»å¡æ¨¡å¼æ­£å¥½ä¸ä¹‹ç›¸åã€‚å¯¹äºä½è´Ÿè½½ã€ä½å¹¶å‘çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨åŒæ­¥é˜»å¡ I/O æ¥æå‡å¼€å‘é€Ÿç‡å’Œæ›´å¥½çš„ç»´æŠ¤æ€§ï¼›å¯¹äºé«˜è´Ÿè½½ã€é«˜å¹¶å‘çš„ï¼ˆç½‘ç»œï¼‰åº”ç”¨ï¼Œåº”ä½¿ç”¨ NIO çš„éé˜»å¡æ¨¡å¼æ¥å¼€å‘ AIO (Asynchronous I/O): AIO ä¹Ÿå°±æ˜¯ NIO 2ã€‚åœ¨ Java 7 ä¸­å¼•å…¥äº† NIO çš„æ”¹è¿›ç‰ˆ NIO 2,å®ƒæ˜¯å¼‚æ­¥éé˜»å¡çš„ IO æ¨¡å‹ã€‚å¼‚æ­¥ IO æ˜¯åŸºäºäº‹ä»¶å’Œå›è°ƒæœºåˆ¶å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ“ä½œä¹‹åä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå µå¡åœ¨é‚£é‡Œï¼Œå½“åå°å¤„ç†å®Œæˆï¼Œæ“ä½œç³»ç»Ÿä¼šé€šçŸ¥ç›¸åº”çš„çº¿ç¨‹è¿›è¡Œåç»­çš„æ“ä½œã€‚AIO æ˜¯å¼‚æ­¥ IO çš„ç¼©å†™ï¼Œè™½ç„¶ NIO åœ¨ç½‘ç»œæ“ä½œä¸­ï¼Œæä¾›äº†éé˜»å¡çš„æ–¹æ³•ï¼Œä½†æ˜¯ NIO çš„ IO è¡Œä¸ºè¿˜æ˜¯åŒæ­¥çš„ã€‚å¯¹äº NIO æ¥è¯´ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡çº¿ç¨‹æ˜¯åœ¨ IO æ“ä½œå‡†å¤‡å¥½æ—¶ï¼Œå¾—åˆ°é€šçŸ¥ï¼Œæ¥ç€å°±ç”±è¿™ä¸ªçº¿ç¨‹è‡ªè¡Œè¿›è¡Œ IO æ“ä½œï¼ŒIO æ“ä½œæœ¬èº«æ˜¯åŒæ­¥çš„ã€‚æŸ¥é˜…ç½‘ä¸Šç›¸å…³èµ„æ–™ï¼Œæˆ‘å‘ç°å°±ç›®å‰æ¥è¯´ AIO çš„åº”ç”¨è¿˜ä¸æ˜¯å¾ˆå¹¿æ³›ï¼ŒNetty ä¹‹å‰ä¹Ÿå°è¯•ä½¿ç”¨è¿‡ AIOï¼Œä¸è¿‡åˆæ”¾å¼ƒäº†ã€‚  2. å®¹å™¨ 3. å‚è€ƒ [1] JavaGuide\n","date":"2020å¹´12æœˆ16æ—¥","permalink":"https://ahamoment.cn/posts/interview/interview-java/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡æ”¶é›†JavaåŸºç¡€çŸ¥è¯†ç‚¹ç›¸å…³çš„é¢è¯•é¢˜ç›®\u003c/p\u003e\n\u003c/blockquote\u003e","title":"Java åŸºç¡€é¢è¯•é¢˜"},{"contents":" æœ¬æ–‡ä¸»è¦æ”¶é›†é¢è¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„è®¡ç®—æœºç½‘ç»œçš„é¢è¯•é¢˜ã€‚\n 1. OSI ä¸ TCP/IP å„å±‚çš„ç»“æ„ä¸åŠŸèƒ½ï¼Œéƒ½æœ‰å“ªäº›åè®®ï¼Ÿ å­¦ä¹ è®¡ç®—æœºç½‘ç»œæ—¶æˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨æŠ˜ä¸­çš„åŠæ³•ï¼Œä¹Ÿå°±æ˜¯ä¸­å’Œ OSI å’Œ TCP/IP çš„ä¼˜ç‚¹ï¼Œé‡‡ç”¨ä¸€ç§åªæœ‰äº”å±‚åè®®çš„ä½“ç³»ç»“æ„ï¼Œè¿™æ ·æ—¢ç®€æ´åˆèƒ½å°†æ¦‚å¿µé˜è¿°æ¸…æ¥šã€‚\nç»“åˆäº’è”ç½‘çš„æƒ…å†µï¼Œè‡ªä¸Šè€Œä¸‹åœ°ï¼Œéå¸¸ç®€è¦çš„ä»‹ç»ä¸€ä¸‹å„å±‚çš„ä½œç”¨ã€‚\n1.1. åº”ç”¨å±‚ åº”ç”¨å±‚(application-layerï¼‰çš„ä»»åŠ¡æ˜¯é€šè¿‡åº”ç”¨è¿›ç¨‹é—´çš„äº¤äº’æ¥å®Œæˆç‰¹å®šç½‘ç»œåº”ç”¨ã€‚åº”ç”¨å±‚åè®®å®šä¹‰çš„æ˜¯åº”ç”¨è¿›ç¨‹ï¼ˆè¿›ç¨‹ï¼šä¸»æœºä¸­æ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼‰é—´çš„é€šä¿¡å’Œäº¤äº’çš„è§„åˆ™ã€‚å¯¹äºä¸åŒçš„ç½‘ç»œåº”ç”¨éœ€è¦ä¸åŒçš„åº”ç”¨å±‚åè®®ã€‚åœ¨äº’è”ç½‘ä¸­åº”ç”¨å±‚åè®®å¾ˆå¤šï¼Œå¦‚åŸŸåç³»ç»ŸDNSï¼Œæ”¯æŒä¸‡ç»´ç½‘åº”ç”¨çš„ HTTPåè®®ï¼Œæ”¯æŒç”µå­é‚®ä»¶çš„ SMTPåè®®ç­‰ç­‰ã€‚æˆ‘ä»¬æŠŠåº”ç”¨å±‚äº¤äº’çš„æ•°æ®å•å…ƒç§°ä¸ºæŠ¥æ–‡ã€‚\n1.2. è¿è¾“å±‚ è¿è¾“å±‚(transport layer)çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯è´Ÿè´£å‘ä¸¤å°ä¸»æœºè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æä¾›é€šç”¨çš„æ•°æ®ä¼ è¾“æœåŠ¡ã€‚åº”ç”¨è¿›ç¨‹åˆ©ç”¨è¯¥æœåŠ¡ä¼ é€åº”ç”¨å±‚æŠ¥æ–‡ã€‚â€œé€šç”¨çš„â€æ˜¯æŒ‡å¹¶ä¸é’ˆå¯¹æŸä¸€ä¸ªç‰¹å®šçš„ç½‘ç»œåº”ç”¨ï¼Œè€Œæ˜¯å¤šç§åº”ç”¨å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªè¿è¾“å±‚æœåŠ¡ã€‚ç”±äºä¸€å°ä¸»æœºå¯åŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œå› æ­¤è¿è¾“å±‚æœ‰å¤ç”¨å’Œåˆ†ç”¨çš„åŠŸèƒ½ã€‚æ‰€è°“å¤ç”¨å°±æ˜¯æŒ‡å¤šä¸ªåº”ç”¨å±‚è¿›ç¨‹å¯åŒæ—¶ä½¿ç”¨ä¸‹é¢è¿è¾“å±‚çš„æœåŠ¡ï¼Œåˆ†ç”¨å’Œå¤ç”¨ç›¸åï¼Œæ˜¯è¿è¾“å±‚æŠŠæ”¶åˆ°çš„ä¿¡æ¯åˆ†åˆ«äº¤ä»˜ä¸Šé¢åº”ç”¨å±‚ä¸­çš„ç›¸åº”è¿›ç¨‹ã€‚\nè¿è¾“å±‚ä¸»è¦ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§åè®®:\n ä¼ è¾“æ§åˆ¶åè®® TCPï¼ˆTransmission Control Protocolï¼‰\u0026ndash;æä¾›é¢å‘è¿æ¥çš„ï¼Œå¯é çš„æ•°æ®ä¼ è¾“æœåŠ¡ã€‚ ç”¨æˆ·æ•°æ®åè®® UDPï¼ˆUser Datagram Protocolï¼‰\u0026ndash;æä¾›æ— è¿æ¥çš„ï¼Œå°½æœ€å¤§åŠªåŠ›çš„æ•°æ®ä¼ è¾“æœåŠ¡ï¼ˆä¸ä¿è¯æ•°æ®ä¼ è¾“çš„å¯é æ€§ï¼‰ã€‚  TCP ä¸ UDP çš„å¯¹æ¯”è§é—®é¢˜ä¸‰ã€‚\n1.3. ç½‘ç»œå±‚ åœ¨ è®¡ç®—æœºç½‘ç»œä¸­è¿›è¡Œé€šä¿¡çš„ä¸¤ä¸ªè®¡ç®—æœºä¹‹é—´å¯èƒ½ä¼šç»è¿‡å¾ˆå¤šä¸ªæ•°æ®é“¾è·¯ï¼Œä¹Ÿå¯èƒ½è¿˜è¦ç»è¿‡å¾ˆå¤šé€šä¿¡å­ç½‘ã€‚ç½‘ç»œå±‚çš„ä»»åŠ¡å°±æ˜¯é€‰æ‹©åˆé€‚çš„ç½‘é—´è·¯ç”±å’Œäº¤æ¢ç»“ç‚¹ï¼Œ ç¡®ä¿æ•°æ®åŠæ—¶ä¼ é€ã€‚ åœ¨å‘é€æ•°æ®æ—¶ï¼Œç½‘ç»œå±‚æŠŠè¿è¾“å±‚äº§ç”Ÿçš„æŠ¥æ–‡æ®µæˆ–ç”¨æˆ·æ•°æ®æŠ¥å°è£…æˆåˆ†ç»„å’ŒåŒ…è¿›è¡Œä¼ é€ã€‚åœ¨ TCP/IP ä½“ç³»ç»“æ„ä¸­ï¼Œç”±äºç½‘ç»œå±‚ä½¿ç”¨ IP åè®®ï¼Œå› æ­¤åˆ†ç»„ä¹Ÿå« IP æ•°æ®æŠ¥ ï¼Œç®€ç§° æ•°æ®æŠ¥ã€‚\nè¿™é‡Œè¦æ³¨æ„ï¼šä¸è¦æŠŠè¿è¾“å±‚çš„â€œç”¨æˆ·æ•°æ®æŠ¥ UDP â€å’Œç½‘ç»œå±‚çš„â€œ IP æ•°æ®æŠ¥â€å¼„æ··ã€‚å¦å¤–ï¼Œæ— è®ºæ˜¯å“ªä¸€å±‚çš„æ•°æ®å•å…ƒï¼Œéƒ½å¯ç¬¼ç»Ÿåœ°ç”¨â€œåˆ†ç»„â€æ¥è¡¨ç¤ºã€‚\nè¿™é‡Œå¼ºè°ƒæŒ‡å‡ºï¼Œç½‘ç»œå±‚ä¸­çš„â€œç½‘ç»œâ€äºŒå­—å·²ç»ä¸æ˜¯æˆ‘ä»¬é€šå¸¸è°ˆåˆ°çš„å…·ä½“ç½‘ç»œï¼Œè€Œæ˜¯æŒ‡è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„æ¨¡å‹ä¸­ç¬¬ä¸‰å±‚çš„åç§°.\näº’è”ç½‘æ˜¯ç”±å¤§é‡çš„å¼‚æ„ï¼ˆheterogeneousï¼‰ç½‘ç»œé€šè¿‡è·¯ç”±å™¨ï¼ˆrouterï¼‰ç›¸äº’è¿æ¥èµ·æ¥çš„ã€‚äº’è”ç½‘ä½¿ç”¨çš„ç½‘ç»œå±‚åè®®æ˜¯æ— è¿æ¥çš„ç½‘é™…åè®®ï¼ˆInternet Protocolï¼‰å’Œè®¸å¤šè·¯ç”±é€‰æ‹©åè®®ï¼Œå› æ­¤äº’è”ç½‘çš„ç½‘ç»œå±‚ä¹Ÿå«åšç½‘é™…å±‚æˆ–IPå±‚ã€‚\n1.4. æ•°æ®é“¾è·¯å±‚ æ•°æ®é“¾è·¯å±‚(data link layer)é€šå¸¸ç®€ç§°ä¸ºé“¾è·¯å±‚ã€‚ä¸¤å°ä¸»æœºä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Œæ€»æ˜¯åœ¨ä¸€æ®µä¸€æ®µçš„é“¾è·¯ä¸Šä¼ é€çš„ï¼Œè¿™å°±éœ€è¦ä½¿ç”¨ä¸“é—¨çš„é“¾è·¯å±‚çš„åè®®ã€‚ åœ¨ä¸¤ä¸ªç›¸é‚»èŠ‚ç‚¹ä¹‹é—´ä¼ é€æ•°æ®æ—¶ï¼Œæ•°æ®é“¾è·¯å±‚å°†ç½‘ç»œå±‚äº¤ä¸‹æ¥çš„ IP æ•°æ®æŠ¥ç»„è£…æˆå¸§ï¼Œåœ¨ä¸¤ä¸ªç›¸é‚»èŠ‚ç‚¹é—´çš„é“¾è·¯ä¸Šä¼ é€å¸§ã€‚æ¯ä¸€å¸§åŒ…æ‹¬æ•°æ®å’Œå¿…è¦çš„æ§åˆ¶ä¿¡æ¯ï¼ˆå¦‚åŒæ­¥ä¿¡æ¯ï¼Œåœ°å€ä¿¡æ¯ï¼Œå·®é”™æ§åˆ¶ç­‰ï¼‰ã€‚\nåœ¨æ¥æ”¶æ•°æ®æ—¶ï¼Œæ§åˆ¶ä¿¡æ¯ä½¿æ¥æ”¶ç«¯èƒ½å¤ŸçŸ¥é“ä¸€ä¸ªå¸§ä»å“ªä¸ªæ¯”ç‰¹å¼€å§‹å’Œåˆ°å“ªä¸ªæ¯”ç‰¹ç»“æŸã€‚è¿™æ ·ï¼Œæ•°æ®é“¾è·¯å±‚åœ¨æ”¶åˆ°ä¸€ä¸ªå¸§åï¼Œå°±å¯ä»ä¸­æå‡ºæ•°æ®éƒ¨åˆ†ï¼Œä¸Šäº¤ç»™ç½‘ç»œå±‚ã€‚ æ§åˆ¶ä¿¡æ¯è¿˜ä½¿æ¥æ”¶ç«¯èƒ½å¤Ÿæ£€æµ‹åˆ°æ‰€æ”¶åˆ°çš„å¸§ä¸­æœ‰æ— å·®é”™ã€‚å¦‚æœå‘ç°å·®é”™ï¼Œæ•°æ®é“¾è·¯å±‚å°±ç®€å•åœ°ä¸¢å¼ƒè¿™ä¸ªå‡ºäº†å·®é”™çš„å¸§ï¼Œä»¥é¿å…ç»§ç»­åœ¨ç½‘ç»œä¸­ä¼ é€ä¸‹å»ç™½ç™½æµªè´¹ç½‘ç»œèµ„æºã€‚å¦‚æœéœ€è¦æ”¹æ­£æ•°æ®åœ¨é“¾è·¯å±‚ä¼ è¾“æ—¶å‡ºç°å·®é”™ï¼ˆè¿™å°±æ˜¯è¯´ï¼Œæ•°æ®é“¾è·¯å±‚ä¸ä»…è¦æ£€é”™ï¼Œè€Œä¸”è¿˜è¦çº é”™ï¼‰ï¼Œé‚£ä¹ˆå°±è¦é‡‡ç”¨å¯é æ€§ä¼ è¾“åè®®æ¥çº æ­£å‡ºç°çš„å·®é”™ã€‚è¿™ç§æ–¹æ³•ä¼šä½¿é“¾è·¯å±‚çš„åè®®å¤æ‚äº›ã€‚\n1.5. ç‰©ç†å±‚ åœ¨ç‰©ç†å±‚ä¸Šæ‰€ä¼ é€çš„æ•°æ®å•ä½æ˜¯æ¯”ç‰¹ã€‚\nç‰©ç†å±‚(physical layer)çš„ä½œç”¨æ˜¯å®ç°ç›¸é‚»è®¡ç®—æœºèŠ‚ç‚¹ä¹‹é—´æ¯”ç‰¹æµçš„é€æ˜ä¼ é€ï¼Œå°½å¯èƒ½å±è”½æ‰å…·ä½“ä¼ è¾“ä»‹è´¨å’Œç‰©ç†è®¾å¤‡çš„å·®å¼‚ï¼Œ ä½¿å…¶ä¸Šé¢çš„æ•°æ®é“¾è·¯å±‚ä¸å¿…è€ƒè™‘ç½‘ç»œçš„å…·ä½“ä¼ è¾“ä»‹è´¨æ˜¯ä»€ä¹ˆã€‚â€œé€æ˜ä¼ é€æ¯”ç‰¹æµâ€è¡¨ç¤ºç»å®é™…ç”µè·¯ä¼ é€åçš„æ¯”ç‰¹æµæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå¯¹ä¼ é€çš„æ¯”ç‰¹æµæ¥è¯´ï¼Œè¿™ä¸ªç”µè·¯å¥½åƒæ˜¯çœ‹ä¸è§çš„ã€‚\nåœ¨äº’è”ç½‘ä½¿ç”¨çš„å„ç§åä¸­æœ€é‡è¦å’Œæœ€è‘—åçš„å°±æ˜¯ TCP/IP ä¸¤ä¸ªåè®®ã€‚ç°åœ¨äººä»¬ç»å¸¸æåˆ°çš„TCP/IPå¹¶ä¸ä¸€å®šå•æŒ‡TCPå’ŒIPè¿™ä¸¤ä¸ªå…·ä½“çš„åè®®ï¼Œè€Œå¾€å¾€è¡¨ç¤ºäº’è”ç½‘æ‰€ä½¿ç”¨çš„æ•´ä¸ªTCP/IPåè®®æ—ã€‚\n2. TCP ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹   Q1: ä»€ä¹ˆæ˜¯ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ï¼Ÿ Q2: ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿå¦‚æœæ˜¯ä¸¤æ¬¡æ¡æ‰‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ Q4: ä¸ºä»€ä¹ˆéœ€è¦å››æ¬¡æŒ¥æ‰‹ï¼Ÿ   è¿™éƒ¨åˆ†çš„å†…å®¹ç½‘ä¸Šæœ‰å¾ˆå¤šæ–‡ç« éƒ½è®²çš„å¾ˆä¸é”™ï¼Œå¯ä»¥ç›´æ¥å€Ÿé‰´ã€‚\n  ä¸¤å¼ åŠ¨å›¾-å½»åº•æ˜ç™½TCPçš„ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹ é¢è¯•å®˜ï¼Œä¸è¦å†é—®æˆ‘ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹   ä¸Šé¢çš„ä¸¤ç¯‡æ–‡ç« éƒ½æ²¡æœ‰è®²æ¸…æ¥šä¸ºä»€ä¹ˆä¸¤æ¬¡æ¡æ‰‹ä¼šæœ‰é—®é¢˜ï¼Œæˆ‘ä»è°¢å¸Œä»çš„ã€Šè®¡ç®—æœºç½‘ç»œã€‹ ä¸€ä¹¦ä¸­æ‰¾åˆ°äº†æ¯”è¾ƒå®Œæ•´çš„ç­”æ¡ˆã€‚\n ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯è¿˜è¦å‘é€ä¸€æ¬¡ç¡®è®¤å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢å·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡çªç„¶åˆä¼ é€åˆ°äº†æœåŠ¡ç«¯ï¼Œå› è€Œäº§ç”Ÿé”™è¯¯ã€‚\næ‰€è°“çš„â€œå·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µâ€æ˜¯è¿™æ ·äº§ç”Ÿçš„ã€‚è€ƒè™‘ä¸€ç§æ­£å¸¸æƒ…å†µã€‚å®¢æˆ·ç«¯å‘å‡ºè¿æ¥è¯·æ±‚ï¼Œä½†å› ä¸ºè¿æ¥è¯·æ±‚æŠ¥æ–‡ä¸¢å¤±è€Œæœªæ”¶åˆ°ç¡®è®¤ã€‚äºæ˜¯å®¢æˆ·ç«¯å†é‡ä¼ äº†ä¸€æ¬¡è¿æ¥è¯·æ±‚ã€‚åæ¥æ”¶åˆ°äº†ç¡®è®¤ï¼Œå»ºç«‹äº†è¿æ¥ã€‚æ•°æ®ä¼ è¾“å®Œæ¯•åï¼Œå°±é‡Šæ”¾äº†è¿æ¥ã€‚å®¢æˆ·ç«¯å…±å‘é€äº†ä¸¤ä¸ªè¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªä¸¢å¤±ï¼Œç¬¬äºŒä¸ªåˆ°è¾¾äº†æœåŠ¡ç«¯ã€‚æ²¡æœ‰â€œå·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µâ€ã€‚\nç°åœ¨å‡è®¾ä¸€ç§å¼‚å¸¸æƒ…å†µï¼Œå³å®¢æˆ·ç«¯å‘é€å‡ºçš„ç¬¬ä¸€ä¸ªè¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µå¹¶æ²¡æœ‰ä¸¢å¤±ï¼Œè€Œæ˜¯åœ¨æŸäº›ç½‘ç»œç»“ç‚¹é•¿æ—¶é—´æ»ç•™äº†ï¼Œä»¥è‡³å»¶è¯¯åˆ°è¿æ¥é‡Šæ”¾åçš„æŸä¸ªæ—¶é—´æ‰åˆ°è¾¾æœåŠ¡ç«¯ã€‚æœ¬æ¥è¿™æ˜¯ä¸€ä¸ªæ—©å·²å¤±æ•ˆçš„æŠ¥æ–‡æ®µã€‚ä½†æ˜¯æœåŠ¡ç«¯æ”¶åˆ°æ­¤å¤±æ•ˆçš„è¿æ¥æŠ¥æ–‡æ®µåï¼Œå°±è¯¯ä»¥ä¸ºæ˜¯å®¢æˆ·ç«¯åˆå‘é€ä¸€æ¬¡æ–°çš„è¯·æ±‚ã€‚äºæ˜¯å°±å‘å®¢æˆ·ç«¯å‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ŒåŒæ„å»ºç«‹è¿æ¥ã€‚å‡å®šä¸é‡‡ç”¨ä¸‰æ¬¡æ¡æ‰‹ï¼Œé‚£ä¹ˆåªè¦å®¢æˆ·ç«¯å‘å‡ºç¡®è®¤ï¼Œæ–°çš„è¿æ¥å°±å»ºç«‹äº†ã€‚\nç”±äºç°åœ¨å®¢æˆ·ç«¯å¹¶æ²¡æœ‰å‘é€å»ºç«‹è¿æ¥çš„è¯·æ±‚ï¼Œå› æ­¤ä¸ä¼šç†ç¬æœåŠ¡ç«¯çš„ç¡®è®¤ï¼Œä¹Ÿä¸ä¼šå‘æœåŠ¡ç«¯å‘é€æ•°æ®ã€‚ä½†æœåŠ¡ç«¯å´è®¤ä¸ºæ–°çš„è¿è¾“è¿æ¥å·²ç»å»ºç«‹äº†ï¼Œå¹¶ä¸€ç›´ç­‰å¾…å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚æœåŠ¡ç«¯çš„è®¸å¤šèµ„æºå°±è¿™æ ·ç™½ç™½æµªè´¹äº†ã€‚\né‡‡ç”¨ä¸‰æ¬¡æ¡æ‰‹å¯ä»¥é˜²æ­¢ä¸Šè¿°ç°è±¡ã€‚ä¾‹å¦‚åœ¨åˆšæ‰çš„æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå‘æœåŠ¡ç«¯ç¡®è®¤å‘é€ç¡®è®¤ã€‚æœåŠ¡ç«¯ç”±äºæ”¶ä¸åˆ°ç¡®è®¤ï¼Œå°±çŸ¥é“å®¢æˆ·ç«¯æ²¡æœ‰å»ºç«‹è¿æ¥çš„è¦æ±‚ã€‚\n 3. TCP åè®®å¦‚ä½•ä¿è¯å¯é ä¼ è¾“  åº”ç”¨æ•°æ®è¢«åˆ†å‰²æˆ TCP è®¤ä¸ºæœ€é€‚åˆå‘é€çš„æ•°æ®å—ã€‚ TCP ç»™å‘é€çš„æ¯ä¸€ä¸ªåŒ…è¿›è¡Œç¼–å·ï¼Œæ¥æ”¶æ–¹å¯¹æ•°æ®åŒ…è¿›è¡Œæ’åºï¼ŒæŠŠæœ‰åºæ•°æ®ä¼ é€ç»™åº”ç”¨å±‚ã€‚ æ ¡éªŒå’Œï¼š TCP å°†ä¿æŒå®ƒé¦–éƒ¨å’Œæ•°æ®çš„æ£€éªŒå’Œã€‚è¿™æ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ£€éªŒå’Œï¼Œç›®çš„æ˜¯æ£€æµ‹æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„ä»»ä½•å˜åŒ–ã€‚å¦‚æœæ”¶åˆ°æ®µçš„æ£€éªŒå’Œæœ‰å·®é”™ï¼ŒTCP å°†ä¸¢å¼ƒè¿™ä¸ªæŠ¥æ–‡æ®µå’Œä¸ç¡®è®¤æ”¶åˆ°æ­¤æŠ¥æ–‡æ®µã€‚ TCP çš„æ¥æ”¶ç«¯ä¼šä¸¢å¼ƒé‡å¤çš„æ•°æ®ã€‚ æµé‡æ§åˆ¶ï¼š TCP è¿æ¥çš„æ¯ä¸€æ–¹éƒ½æœ‰å›ºå®šå¤§å°çš„ç¼“å†²ç©ºé—´ï¼ŒTCPçš„æ¥æ”¶ç«¯åªå…è®¸å‘é€ç«¯å‘é€æ¥æ”¶ç«¯ç¼“å†²åŒºèƒ½æ¥çº³çš„æ•°æ®ã€‚å½“æ¥æ”¶æ–¹æ¥ä¸åŠå¤„ç†å‘é€æ–¹çš„æ•°æ®ï¼Œèƒ½æç¤ºå‘é€æ–¹é™ä½å‘é€çš„é€Ÿç‡ï¼Œé˜²æ­¢åŒ…ä¸¢å¤±ã€‚TCP ä½¿ç”¨çš„æµé‡æ§åˆ¶åè®®æ˜¯å¯å˜å¤§å°çš„æ»‘åŠ¨çª—å£åè®®ã€‚ ï¼ˆTCP åˆ©ç”¨æ»‘åŠ¨çª—å£å®ç°æµé‡æ§åˆ¶ï¼‰ æ‹¥å¡æ§åˆ¶ï¼š å½“ç½‘ç»œæ‹¥å¡æ—¶ï¼Œå‡å°‘æ•°æ®çš„å‘é€ã€‚ ARQåè®®ï¼š ä¹Ÿæ˜¯ä¸ºäº†å®ç°å¯é ä¼ è¾“çš„ï¼Œå®ƒçš„åŸºæœ¬åŸç†å°±æ˜¯æ¯å‘å®Œä¸€ä¸ªåˆ†ç»„å°±åœæ­¢å‘é€ï¼Œç­‰å¾…å¯¹æ–¹ç¡®è®¤ã€‚åœ¨æ”¶åˆ°ç¡®è®¤åå†å‘ä¸‹ä¸€ä¸ªåˆ†ç»„ã€‚ è¶…æ—¶é‡ä¼ ï¼š å½“ TCP å‘å‡ºä¸€ä¸ªæ®µåï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç­‰å¾…ç›®çš„ç«¯ç¡®è®¤æ”¶åˆ°è¿™ä¸ªæŠ¥æ–‡æ®µã€‚å¦‚æœä¸èƒ½åŠæ—¶æ”¶åˆ°ä¸€ä¸ªç¡®è®¤ï¼Œå°†é‡å‘è¿™ä¸ªæŠ¥æ–‡æ®µã€‚  3.1. æµé‡æ§åˆ¶ ï¼ˆ1ï¼‰ä»€ä¹ˆæ˜¯æµé‡æ§åˆ¶ï¼Ÿæµé‡æ§åˆ¶çš„ç›®çš„ï¼Ÿ\nå¦‚æœå‘é€è€…å‘é€æ•°æ®è¿‡å¿«ï¼Œæ¥æ”¶è€…æ¥ä¸åŠæ¥æ”¶ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰åˆ†ç»„ä¸¢å¤±ã€‚ä¸ºäº†é¿å…åˆ†ç»„ä¸¢å¤±ï¼Œæ§åˆ¶å‘é€è€…çš„å‘é€é€Ÿåº¦ï¼Œä½¿å¾—æ¥æ”¶è€…æ¥å¾—åŠæ¥æ”¶ï¼Œè¿™å°±æ˜¯æµé‡æ§åˆ¶ã€‚æµé‡æ§åˆ¶æ ¹æœ¬ç›®çš„æ˜¯é˜²æ­¢åˆ†ç»„ä¸¢å¤±ï¼Œå®ƒæ˜¯æ„æˆTCPå¯é æ€§çš„ä¸€æ–¹é¢ã€‚\nï¼ˆ2ï¼‰å¦‚ä½•å®ç°æµé‡æ§åˆ¶ï¼Ÿ\nç”±æ»‘åŠ¨çª—å£åè®®ï¼ˆè¿ç»­ARQåè®®ï¼‰å®ç°ã€‚æ»‘åŠ¨çª—å£åè®®æ—¢ä¿è¯äº†åˆ†ç»„æ— å·®é”™ã€æœ‰åºæ¥æ”¶ï¼Œä¹Ÿå®ç°äº†æµé‡æ§åˆ¶ã€‚ä¸»è¦çš„æ–¹å¼å°±æ˜¯æ¥æ”¶æ–¹è¿”å›çš„ ACK ä¸­ä¼šåŒ…å«è‡ªå·±çš„æ¥æ”¶çª—å£çš„å¤§å°ï¼Œå¹¶ä¸”åˆ©ç”¨å¤§å°æ¥æ§åˆ¶å‘é€æ–¹çš„æ•°æ®å‘é€ã€‚\nï¼ˆ3ï¼‰æµé‡æ§åˆ¶å¼•å‘çš„æ­»é”ï¼Ÿæ€ä¹ˆé¿å…æ­»é”çš„å‘ç”Ÿï¼Ÿ\nå½“å‘é€è€…æ”¶åˆ°äº†ä¸€ä¸ªçª—å£ä¸º0çš„åº”ç­”ï¼Œå‘é€è€…ä¾¿åœæ­¢å‘é€ï¼Œç­‰å¾…æ¥æ”¶è€…çš„ä¸‹ä¸€ä¸ªåº”ç­”ã€‚ä½†æ˜¯å¦‚æœè¿™ä¸ªçª—å£ä¸ä¸º0çš„åº”ç­”åœ¨ä¼ è¾“è¿‡ç¨‹ä¸¢å¤±ï¼Œå‘é€è€…ä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œè€Œæ¥æ”¶è€…ä»¥ä¸ºå‘é€è€…å·²ç»æ”¶åˆ°è¯¥åº”ç­”ï¼Œç­‰å¾…æ¥æ”¶æ–°æ•°æ®ï¼Œè¿™æ ·åŒæ–¹å°±ç›¸äº’ç­‰å¾…ï¼Œä»è€Œäº§ç”Ÿæ­»é”ã€‚ ä¸ºäº†é¿å…æµé‡æ§åˆ¶å¼•å‘çš„æ­»é”ï¼ŒTCPä½¿ç”¨äº†æŒç»­è®¡æ—¶å™¨ã€‚æ¯å½“å‘é€è€…æ”¶åˆ°ä¸€ä¸ªé›¶çª—å£çš„åº”ç­”åå°±å¯åŠ¨è¯¥è®¡æ—¶å™¨ã€‚æ—¶é—´ä¸€åˆ°ä¾¿ä¸»åŠ¨å‘é€æŠ¥æ–‡è¯¢é—®æ¥æ”¶è€…çš„çª—å£å¤§å°ã€‚è‹¥æ¥æ”¶è€…ä»ç„¶è¿”å›é›¶çª—å£ï¼Œåˆ™é‡ç½®è¯¥è®¡æ—¶å™¨ç»§ç»­ç­‰å¾…ï¼›è‹¥çª—å£ä¸ä¸º0ï¼Œåˆ™è¡¨ç¤ºåº”ç­”æŠ¥æ–‡ä¸¢å¤±äº†ï¼Œæ­¤æ—¶é‡ç½®å‘é€çª—å£åå¼€å§‹å‘é€ï¼Œè¿™æ ·å°±é¿å…äº†æ­»é”çš„äº§ç”Ÿã€‚\n3.2 . æ‹¥å¡æ§åˆ¶  https://zhuanlan.zhihu.com/p/37379780\n 4. TCP çš„ç²˜åŒ…å’Œæ‹†åŒ… å‚è€ƒ: TCP çš„ç²˜åŒ…å’Œæ‹†åŒ…\næ‹†åŒ…å’Œç²˜åŒ…æ˜¯åœ¨socketç¼–ç¨‹ä¸­ç»å¸¸å‡ºç°çš„æƒ…å†µï¼Œåœ¨socketé€šè®¯è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé€šè®¯çš„ä¸€ç«¯ä¸€æ¬¡æ€§è¿ç»­å‘é€å¤šæ¡æ•°æ®åŒ…ï¼Œtcpåè®®ä¼šå°†å¤šä¸ªæ•°æ®åŒ…æ‰“åŒ…æˆä¸€ä¸ªtcpæŠ¥æ–‡å‘é€å‡ºå»ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ç²˜åŒ…ã€‚è€Œå¦‚æœé€šè®¯çš„ä¸€ç«¯å‘é€çš„æ•°æ®åŒ…è¶…è¿‡ä¸€æ¬¡tcpæŠ¥æ–‡æ‰€èƒ½ä¼ è¾“çš„æœ€å¤§å€¼æ—¶ï¼Œå°±ä¼šå°†ä¸€ä¸ªæ•°æ®åŒ…æ‹†æˆå¤šä¸ªæœ€å¤§tcpé•¿åº¦çš„tcpæŠ¥æ–‡åˆ†å¼€ä¼ è¾“ï¼Œè¿™å°±å«åšæ‹†åŒ…ã€‚\næ€»ç»“å‡ºç°ç²˜åŒ…çš„åŸå› ï¼š\n è¦å‘é€çš„æ•°æ®å°äºTCPå‘é€ç¼“å†²åŒºçš„å¤§å°ï¼ŒTCPå°†å¤šæ¬¡å†™å…¥ç¼“å†²åŒºçš„æ•°æ®ä¸€æ¬¡å‘é€å‡ºå»ï¼› æ¥æ”¶æ•°æ®ç«¯çš„åº”ç”¨å±‚æ²¡æœ‰åŠæ—¶è¯»å–æ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼› æ•°æ®å‘é€è¿‡å¿«ï¼Œæ•°æ®åŒ…å †ç§¯å¯¼è‡´ç¼“å†²åŒºç§¯å‹å¤šä¸ªæ•°æ®åæ‰ä¸€æ¬¡æ€§å‘é€å‡ºå»(å¦‚æœå®¢æˆ·ç«¯æ¯å‘é€ä¸€æ¡æ•°æ®å°±ç¡çœ ä¸€æ®µæ—¶é—´å°±ä¸ä¼šå‘ç”Ÿç²˜åŒ…)ï¼›  è§£å†³æ–¹æ¡ˆ\nå¯¹äºç²˜åŒ…çš„æƒ…å†µï¼Œè¦å¯¹ç²˜åœ¨ä¸€èµ·çš„åŒ…è¿›è¡Œæ‹†åŒ…ã€‚å¯¹äºæ‹†åŒ…çš„æƒ…å†µï¼Œè¦å¯¹è¢«æ‹†å¼€çš„åŒ…è¿›è¡Œç²˜åŒ…ï¼Œå³å°†ä¸€ä¸ªè¢«æ‹†å¼€çš„å®Œæ•´åº”ç”¨åŒ…å†ç»„åˆæˆä¸€ä¸ªå®Œæ•´åŒ…ã€‚æ¯”è¾ƒé€šç”¨çš„åšæ³•å°±æ˜¯æ¯æ¬¡å‘é€ä¸€ä¸ªåº”ç”¨æ•°æ®åŒ…å‰åœ¨å‰é¢åŠ ä¸Šå››ä¸ªå­—èŠ‚çš„åŒ…é•¿åº¦å€¼ï¼ŒæŒ‡æ˜è¿™ä¸ªåº”ç”¨åŒ…çš„çœŸå®é•¿åº¦ã€‚å¦‚ä¸‹å›¾å°±æ˜¯åº”ç”¨æ•°æ®åŒ…æ ¼å¼ã€‚\nå®ç°è§£å†³æ‹†åŒ…ç²˜åŒ…é—®é¢˜ï¼Œæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š\n ä¸€ç§æ–¹å¼æ˜¯å¼•å…¥nettyåº“ï¼Œnettyå°è£…äº†å¤šç§æ‹†åŒ…ç²˜åŒ…çš„æ–¹å¼ï¼Œåªéœ€è¦å¯¹æ¥å£ç†Ÿæ‚‰å¹¶è°ƒç”¨å³å¯ï¼Œå‡å°‘è‡ªå·±å¤„ç†æ•°æ®åè®®çš„ç¹çæµç¨‹ï¼› è‡ªå·±å†™åè®®å°è£…å’Œè§£ææµç¨‹ï¼Œç›¸å½“äºå®ç°äº†nettyåº“æ‹†ç²˜åŒ…çš„ç®€æ˜“ç‰ˆæœ¬.  5. åœ¨æµè§ˆå™¨ä¸­è¾“å…¥urlåœ°å€åˆ°æ˜¾ç¤ºä¸»é¡µçš„è¿‡ç¨‹ å¤§è‡´ä¸Šåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š\n DNSè§£æ TCPè¿æ¥ å‘é€HTTPè¯·æ±‚ æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å›HTTPæŠ¥æ–‡ æµè§ˆå™¨è§£ææ¸²æŸ“é¡µé¢ è¿æ¥ç»“æŸ  å¯ä»¥å‚è€ƒä¸‹é¢è¿™ç¯‡æ–‡ç« : å‰ç«¯ç»å…¸é¢è¯•é¢˜: ä»è¾“å…¥URLåˆ°é¡µé¢åŠ è½½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ\nhttps://github.com/Snailclimb/JavaGuide/blob/master/docs/network/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.md\n","date":"2020å¹´12æœˆ10æ—¥","permalink":"https://ahamoment.cn/posts/interview/interview-network/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡ä¸»è¦æ”¶é›†é¢è¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„è®¡ç®—æœºç½‘ç»œçš„é¢è¯•é¢˜ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e","title":"è®¡ç®—æœºç½‘ç»œé¢è¯•é¢˜"},{"contents":"1. ä»€ä¹ˆæ˜¯MySQLï¼Ÿ MySQL æ˜¯ä¸€ç§å…³ç³»å‹æ•°æ®åº“ï¼Œåœ¨Javaä¼ä¸šçº§å¼€å‘ä¸­éå¸¸å¸¸ç”¨ï¼Œå› ä¸º MySQL æ˜¯å¼€æºå…è´¹çš„ï¼Œå¹¶ä¸”æ–¹ä¾¿æ‰©å±•ã€‚é˜¿é‡Œå·´å·´æ•°æ®åº“ç³»ç»Ÿä¹Ÿå¤§é‡ç”¨åˆ°äº† MySQLï¼Œå› æ­¤å®ƒçš„ç¨³å®šæ€§æ˜¯æœ‰ä¿éšœçš„ã€‚MySQLæ˜¯å¼€æ”¾æºä»£ç çš„ï¼Œå› æ­¤ä»»ä½•äººéƒ½å¯ä»¥åœ¨ GPL(General Public License) çš„è®¸å¯ä¸‹ä¸‹è½½å¹¶æ ¹æ®ä¸ªæ€§åŒ–çš„éœ€è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚MySQLçš„é»˜è®¤ç«¯å£å·æ˜¯3306ã€‚\n2. å­˜å‚¨å¼•æ“ 2.1. MyISAM å’Œ InnoDB çš„åŒºåˆ« MyISAMæ˜¯MySQLçš„é»˜è®¤æ•°æ®åº“å¼•æ“ï¼ˆ5.5ç‰ˆä¹‹å‰ï¼‰ã€‚è™½ç„¶æ€§èƒ½æä½³ï¼Œè€Œä¸”æä¾›äº†å¤§é‡çš„ç‰¹æ€§ï¼ŒåŒ…æ‹¬å…¨æ–‡ç´¢å¼•ã€å‹ç¼©ã€ç©ºé—´å‡½æ•°ç­‰ï¼Œä½†MyISAMä¸æ”¯æŒäº‹åŠ¡å’Œè¡Œçº§é”ï¼Œè€Œä¸”æœ€å¤§çš„ç¼ºé™·å°±æ˜¯å´©æºƒåæ— æ³•å®‰å…¨æ¢å¤ã€‚ä¸è¿‡ï¼Œ5.5ç‰ˆæœ¬ä¹‹åï¼ŒMySQLå¼•å…¥äº†InnoDBï¼ˆäº‹åŠ¡æ€§æ•°æ®åº“å¼•æ“ï¼‰ï¼ŒMySQL 5.5ç‰ˆæœ¬åé»˜è®¤çš„å­˜å‚¨å¼•æ“ä¸ºInnoDBã€‚\nå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä½¿ç”¨çš„éƒ½æ˜¯ InnoDB å­˜å‚¨å¼•æ“ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ä½¿ç”¨ MyISAM ä¹Ÿæ˜¯åˆé€‚çš„æ¯”å¦‚è¯»å¯†é›†çš„æƒ…å†µä¸‹ã€‚ï¼ˆå¦‚æœä½ ä¸ä»‹æ„ MyISAM å´©æºƒæ¢å¤é—®é¢˜çš„è¯ï¼‰ã€‚\nä¸¤è€…çš„å¯¹æ¯”ï¼š\n æ˜¯å¦æ”¯æŒè¡Œçº§é” : MyISAM åªæœ‰è¡¨çº§é”(table-level locking)ï¼Œè€ŒInnoDB æ”¯æŒè¡Œçº§é”(row-level locking)å’Œè¡¨çº§é”ï¼Œé»˜è®¤ä¸ºè¡Œçº§é”ã€‚ æ˜¯å¦æ”¯æŒäº‹åŠ¡å’Œå´©æºƒåçš„å®‰å…¨æ¢å¤ï¼š MyISAM å¼ºè°ƒçš„æ˜¯æ€§èƒ½ï¼Œæ¯æ¬¡æŸ¥è¯¢å…·æœ‰åŸå­æ€§,å…¶æ‰§è¡Œé€Ÿåº¦æ¯”InnoDBç±»å‹æ›´å¿«ï¼Œä½†æ˜¯ä¸æä¾›äº‹åŠ¡æ”¯æŒã€‚ä½†æ˜¯InnoDB æä¾›äº‹åŠ¡æ”¯æŒï¼Œå¤–éƒ¨é”®ç­‰é«˜çº§æ•°æ®åº“åŠŸèƒ½ã€‚ å…·æœ‰äº‹åŠ¡(commit)ã€å›æ»š(rollback)å’Œå´©æºƒä¿®å¤èƒ½åŠ›(crash recovery capabilities)çš„äº‹åŠ¡å®‰å…¨(transaction-safe (ACID compliant))å‹è¡¨ã€‚ æ˜¯å¦æ”¯æŒå¤–é”®ï¼š MyISAMä¸æ”¯æŒï¼Œè€ŒInnoDBæ”¯æŒã€‚ æ˜¯å¦æ”¯æŒMVCC ï¼šä»… InnoDB æ”¯æŒã€‚åº”å¯¹é«˜å¹¶å‘äº‹åŠ¡, MVCCæ¯”å•çº¯çš„åŠ é”æ›´é«˜æ•ˆ;MVCCåªåœ¨ READ COMMITTED å’Œ REPEATABLE READ ä¸¤ä¸ªéš”ç¦»çº§åˆ«ä¸‹å·¥ä½œ;MVCCå¯ä»¥ä½¿ç”¨ ä¹è§‚(optimistic)é” å’Œ æ‚²è§‚(pessimistic)é”æ¥å®ç°;å„æ•°æ®åº“ä¸­MVCCå®ç°å¹¶ä¸ç»Ÿä¸€ã€‚æ¨èé˜…è¯»ï¼šMySQL-InnoDB-MVCCå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶  3. ç´¢å¼• 3.1. ä»€ä¹ˆæ˜¯ç´¢å¼• ç´¢å¼•æ˜¯ä¸€ç§ç”¨äºå¿«é€ŸæŸ¥è¯¢å’Œæ£€ç´¢æ•°æ®çš„æ•°æ®ç»“æ„ã€‚å¸¸è§çš„ç´¢å¼•ç»“æ„æœ‰: Bæ ‘ï¼Œ B+æ ‘å’ŒHashã€‚\nç´¢å¼•çš„ä½œç”¨å°±ç›¸å½“äºç›®å½•çš„ä½œç”¨ã€‚æ‰“ä¸ªæ¯”æ–¹: æˆ‘ä»¬åœ¨æŸ¥å­—å…¸çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ç›®å½•ï¼Œé‚£æˆ‘ä»¬å°±åªèƒ½ä¸€é¡µä¸€é¡µçš„å»æ‰¾æˆ‘ä»¬éœ€è¦æŸ¥çš„é‚£ä¸ªå­—ï¼Œé€Ÿåº¦å¾ˆæ…¢ã€‚å¦‚æœæœ‰ç›®å½•äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å…ˆå»ç›®å½•é‡ŒæŸ¥æ‰¾å­—çš„ä½ç½®ï¼Œç„¶åç›´æ¥ç¿»åˆ°é‚£ä¸€é¡µå°±è¡Œäº†ã€‚ç´¢å¼•æ˜¯ä¸€ç§ç”¨äºå¿«é€ŸæŸ¥è¯¢å’Œæ£€ç´¢æ•°æ®çš„æ•°æ®ç»“æ„ã€‚å¸¸è§çš„ç´¢å¼•ç»“æ„æœ‰: Bæ ‘ï¼Œ B+æ ‘å’ŒHashã€‚\n3.2. ä¸ºä»€ä¹ˆç”¨ç´¢å¼•ï¼Ÿ ç´¢å¼•çš„ä¼˜ç‚¹\nå¯ä»¥å¤§å¤§åŠ å¿«æ£€ç´¢çš„é€Ÿåº¦ï¼Œè¿™ä¹Ÿæ˜¯åˆ›å»ºç´¢å¼•çš„æœ€ä¸»è¦çš„åŸå› ã€‚æ¯•ç«Ÿå¤§éƒ¨åˆ†ç³»ç»Ÿçš„è¯»è¯·æ±‚æ€»æ˜¯å¤§äºå†™è¯·æ±‚çš„ã€‚ å¦å¤–ï¼Œé€šè¿‡åˆ›å»ºå”¯ä¸€æ€§ç´¢å¼•ï¼Œå¯ä»¥ä¿è¯æ•°æ®åº“è¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®çš„å”¯ä¸€æ€§ã€‚\nç´¢å¼•çš„ç¼ºç‚¹\n åˆ›å»ºç´¢å¼•å’Œç»´æŠ¤ç´¢å¼•éœ€è¦è€—è´¹è®¸å¤šæ—¶é—´ï¼šå½“å¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹çš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆç´¢å¼•ä¹Ÿéœ€è¦åŠ¨æ€çš„ä¿®æ”¹ï¼Œä¼šé™ä½SQLæ‰§è¡Œæ•ˆç‡ã€‚ å ç”¨ç‰©ç†å­˜å‚¨ç©ºé—´ ï¼šç´¢å¼•éœ€è¦ä½¿ç”¨ç‰©ç†æ–‡ä»¶å­˜å‚¨ï¼Œä¹Ÿä¼šè€—è´¹ä¸€å®šç©ºé—´ã€‚  3.3. ç´¢å¼•çš„åŸç† InnoDB çš„ç´¢å¼•ä½¿ç”¨çš„æ˜¯ B+ æ ‘ã€‚\nä¸ºä»€ä¹ˆè¦ç”¨B+æ ‘ä½œä¸ºç´¢å¼•ï¼Ÿè€Œä¸æ˜¯Bæ ‘ï¼Ÿ\n MySQLç´¢å¼•åŸç†åŠæ…¢æŸ¥è¯¢ä¼˜åŒ–\n 3.4 ç´¢å¼•ç±»å‹ 3.4.1. ä¸»é”®ç´¢å¼•ä¸äºŒçº§ç´¢å¼• ï¼ˆ1ï¼‰ä¸»é”®ç´¢å¼•\næ•°æ®è¡¨çš„ä¸»é”®åˆ—ä½¿ç”¨çš„å°±æ˜¯ä¸»é”®ç´¢å¼•ã€‚ä¸€å¼ æ•°æ®è¡¨æœ‰åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ï¼Œå¹¶ä¸”ä¸»é”®ä¸èƒ½ä¸ºnullï¼Œä¸èƒ½é‡å¤ã€‚åœ¨mysqlçš„InnoDBçš„è¡¨ä¸­ï¼Œå½“æ²¡æœ‰æ˜¾ç¤ºçš„æŒ‡å®šè¡¨çš„ä¸»é”®æ—¶ï¼ŒInnoDBä¼šè‡ªåŠ¨å…ˆæ£€æŸ¥è¡¨ä¸­æ˜¯å¦æœ‰å”¯ä¸€ç´¢å¼•çš„å­—æ®µï¼Œå¦‚æœæœ‰ï¼Œåˆ™é€‰æ‹©è¯¥å­—æ®µä¸ºé»˜è®¤çš„ä¸»é”®ï¼Œå¦åˆ™InnoDBå°†ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª6Byteçš„è‡ªå¢ä¸»é”®ã€‚\nï¼ˆ2ï¼‰äºŒçº§ç´¢å¼•\nåˆç§°ä¸ºè¾…åŠ©ç´¢å¼•ï¼Œæ˜¯å› ä¸ºäºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®æ˜¯ä¸»é”®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡äºŒçº§ç´¢å¼•ï¼Œå¯ä»¥å®šä½ä¸»é”®çš„ä½ç½®ã€‚å”¯ä¸€ç´¢å¼•ï¼Œæ™®é€šç´¢å¼•ï¼Œå‰ç¼€ç´¢å¼•ç­‰ç´¢å¼•å±äºäºŒçº§ç´¢å¼•ã€‚\n å”¯ä¸€ç´¢å¼•(Unique Key) ï¼šå”¯ä¸€ç´¢å¼•ä¹Ÿæ˜¯ä¸€ç§çº¦æŸã€‚**å”¯ä¸€ç´¢å¼•çš„å±æ€§åˆ—ä¸èƒ½å‡ºç°é‡å¤çš„æ•°æ®ï¼Œä½†æ˜¯å…è®¸æ•°æ®ä¸ºNULLï¼Œä¸€å¼ è¡¨å…è®¸åˆ›å»ºå¤šä¸ªå”¯ä¸€ç´¢å¼•ã€‚**å»ºç«‹å”¯ä¸€ç´¢å¼•çš„ç›®çš„å¤§éƒ¨åˆ†æ—¶å€™éƒ½æ˜¯ä¸ºäº†è¯¥å±æ€§åˆ—çš„æ•°æ®çš„å”¯ä¸€æ€§ï¼Œè€Œä¸æ˜¯ä¸ºäº†æŸ¥è¯¢æ•ˆç‡ã€‚ æ™®é€šç´¢å¼•(Index) ï¼šæ™®é€šç´¢å¼•çš„å”¯ä¸€ä½œç”¨å°±æ˜¯ä¸ºäº†å¿«é€ŸæŸ¥è¯¢æ•°æ®ï¼Œä¸€å¼ è¡¨å…è®¸åˆ›å»ºå¤šä¸ªæ™®é€šç´¢å¼•ï¼Œå¹¶å…è®¸æ•°æ®é‡å¤å’ŒNULLã€‚ å‰ç¼€ç´¢å¼•(Prefix) ï¼šå‰ç¼€ç´¢å¼•åªé€‚ç”¨äºå­—ç¬¦ä¸²ç±»å‹çš„æ•°æ®ã€‚å‰ç¼€ç´¢å¼•æ˜¯å¯¹æ–‡æœ¬çš„å‰å‡ ä¸ªå­—ç¬¦åˆ›å»ºç´¢å¼•ï¼Œç›¸æ¯”æ™®é€šç´¢å¼•å»ºç«‹çš„æ•°æ®æ›´å°ï¼Œ å› ä¸ºåªå–å‰å‡ ä¸ªå­—ç¬¦ã€‚ å…¨æ–‡ç´¢å¼•(Full Text) ï¼šå…¨æ–‡ç´¢å¼•ä¸»è¦æ˜¯ä¸ºäº†æ£€ç´¢å¤§æ–‡æœ¬æ•°æ®ä¸­çš„å…³é”®å­—çš„ä¿¡æ¯ï¼Œæ˜¯ç›®å‰æœç´¢å¼•æ“æ•°æ®åº“ä½¿ç”¨çš„ä¸€ç§æŠ€æœ¯ã€‚Mysql5.6ä¹‹å‰åªæœ‰MYISAMå¼•æ“æ”¯æŒå…¨æ–‡ç´¢å¼•ï¼Œ5.6ä¹‹åInnoDBä¹Ÿæ”¯æŒäº†å…¨æ–‡ç´¢å¼•ã€‚  3.4.2. èšé›†ç´¢å¼•ä¸éèšé›†ç´¢å¼• ï¼ˆ1ï¼‰èšé›†ç´¢å¼•\nèšé›†ç´¢å¼•å³ç´¢å¼•ç»“æ„å’Œæ•°æ®ä¸€èµ·å­˜æ”¾çš„ç´¢å¼•ã€‚ä¸»é”®ç´¢å¼•å±äºèšé›†ç´¢å¼•ã€‚\nèšé›†ç´¢å¼•çš„ä¼˜ç‚¹:\nèšé›†ç´¢å¼•çš„æŸ¥è¯¢é€Ÿåº¦éå¸¸çš„å¿«ï¼Œå› ä¸ºæ•´ä¸ªB+æ ‘æœ¬èº«å°±æ˜¯ä¸€é¢—å¤šå‰å¹³è¡¡æ ‘ï¼Œå¶å­èŠ‚ç‚¹ä¹Ÿéƒ½æ˜¯æœ‰åºçš„ï¼Œå®šä½åˆ°ç´¢å¼•çš„èŠ‚ç‚¹ï¼Œå°±ç›¸å½“äºå®šä½åˆ°äº†æ•°æ®ã€‚\nèšé›†ç´¢å¼•çš„ç¼ºç‚¹:\n ä¾èµ–äºæœ‰åºçš„æ•°æ® ï¼šå› ä¸ºB+æ ‘æ˜¯å¤šè·¯å¹³è¡¡æ ‘ï¼Œå¦‚æœç´¢å¼•çš„æ•°æ®ä¸æ˜¯æœ‰åºçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨æ’å…¥æ—¶æ’åºï¼Œå¦‚æœæ•°æ®æ˜¯æ•´å‹è¿˜å¥½ï¼Œå¦åˆ™ç±»ä¼¼äºå­—ç¬¦ä¸²æˆ–UUIDè¿™ç§åˆé•¿åˆéš¾æ¯”è¾ƒçš„æ•°æ®ï¼Œæ’å…¥æˆ–æŸ¥æ‰¾çš„é€Ÿåº¦è‚¯å®šæ¯”è¾ƒæ…¢ã€‚ æ›´æ–°ä»£ä»·å¤§ ï¼š å¦‚æœå¯¹ç´¢å¼•åˆ—çš„æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œé‚£ä¹ˆå¯¹åº”çš„ç´¢å¼•ä¹Ÿå°†ä¼šè¢«ä¿®æ”¹ï¼Œ è€Œä¸”å†µèšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹è¿˜å­˜æ”¾ç€æ•°æ®ï¼Œä¿®æ”¹ä»£ä»·è‚¯å®šæ˜¯è¾ƒå¤§çš„ï¼Œ æ‰€ä»¥å¯¹äºä¸»é”®ç´¢å¼•æ¥è¯´ï¼Œä¸»é”®ä¸€èˆ¬éƒ½æ˜¯ä¸å¯è¢«ä¿®æ”¹çš„ã€‚  ï¼ˆ2ï¼‰éèšé›†ç´¢å¼•\néèšé›†ç´¢å¼•å³ç´¢å¼•ç»“æ„å’Œæ•°æ®åˆ†å¼€å­˜æ”¾çš„ç´¢å¼•ã€‚\néèšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å¹¶ä¸ä¸€å®šå­˜æ”¾æ•°æ®çš„æŒ‡é’ˆï¼Œ å› ä¸ºäºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å°±å­˜æ”¾çš„æ˜¯ä¸»é”®ï¼Œæ ¹æ®ä¸»é”®å†å›è¡¨æŸ¥æ•°æ®ã€‚\néèšé›†ç´¢å¼•çš„ä¼˜ç‚¹:\næ›´æ–°ä»£ä»·æ¯”èšé›†ç´¢å¼•è¦å° ã€‚éèšé›†ç´¢å¼•çš„æ›´æ–°ä»£ä»·å°±æ²¡æœ‰èšé›†ç´¢å¼•é‚£ä¹ˆå¤§äº†ï¼Œéèšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹æ˜¯ä¸å­˜æ”¾æ•°æ®çš„\néèšé›†ç´¢å¼•çš„ç¼ºç‚¹:\n è·Ÿèšé›†ç´¢å¼•ä¸€æ ·ï¼Œéèšé›†ç´¢å¼•ä¹Ÿä¾èµ–äºæœ‰åºçš„æ•°æ® å¯èƒ½ä¼šäºŒæ¬¡æŸ¥è¯¢(å›è¡¨) :è¿™åº”è¯¥æ˜¯éèšé›†ç´¢å¼•æœ€å¤§çš„ç¼ºç‚¹äº†ã€‚ å½“æŸ¥åˆ°ç´¢å¼•å¯¹åº”çš„æŒ‡é’ˆæˆ–ä¸»é”®åï¼Œå¯èƒ½è¿˜éœ€è¦æ ¹æ®æŒ‡é’ˆæˆ–ä¸»é”®å†åˆ°æ•°æ®æ–‡ä»¶æˆ–è¡¨ä¸­æŸ¥è¯¢ã€‚  ï¼ˆ3ï¼‰éèšé›†ç´¢å¼•ä¸€å®šå›è¡¨æŸ¥è¯¢å—(è¦†ç›–ç´¢å¼•)?\néèšé›†ç´¢å¼•ä¸ä¸€å®šå›è¡¨æŸ¥è¯¢ã€‚\n è¯•æƒ³ä¸€ç§æƒ…å†µï¼Œç”¨æˆ·å‡†å¤‡ä½¿ç”¨SQLæŸ¥è¯¢ç”¨æˆ·åï¼Œè€Œç”¨æˆ·åå­—æ®µæ­£å¥½å»ºç«‹äº†ç´¢å¼•ã€‚\n  SELECT name FROM table WHERE username='guang19';   é‚£ä¹ˆè¿™ä¸ªç´¢å¼•çš„keyæœ¬èº«å°±æ˜¯nameï¼ŒæŸ¥åˆ°å¯¹åº”çš„nameç›´æ¥è¿”å›å°±è¡Œäº†ï¼Œæ— éœ€å›è¡¨æŸ¥è¯¢ã€‚\n ä¸»é”®ç´¢å¼•æœ¬èº«çš„keyå°±æ˜¯ä¸»é”®ï¼ŒæŸ¥åˆ°è¿”å›å°±è¡Œäº†ã€‚è¿™ç§æƒ…å†µå°±ç§°ä¹‹ä¸ºè¦†ç›–ç´¢å¼•äº†ã€‚\n3.5. ç´¢å¼•åˆ›å»ºåŸåˆ™ ï¼ˆ1ï¼‰å•åˆ—ç´¢å¼•\nå•åˆ—ç´¢å¼•å³ç”±ä¸€åˆ—å±æ€§ç»„æˆçš„ç´¢å¼•ã€‚\nï¼ˆ2ï¼‰è”åˆç´¢å¼•(å¤šåˆ—ç´¢å¼•)\nè”åˆç´¢å¼•æ—¢ç”±å¤šåˆ—å±æ€§ç»„æˆç´¢å¼•ã€‚\nï¼ˆ3ï¼‰æœ€å·¦å‰ç¼€åŸåˆ™\nå‡è®¾åˆ›å»ºçš„è”åˆç´¢å¼•ç”±ä¸‰ä¸ªå­—æ®µç»„æˆ:\nALTER TABLE table ADD INDEX index_name (num,name,age)  é‚£ä¹ˆå½“æŸ¥è¯¢çš„æ¡ä»¶æœ‰ä¸º:num / (num AND name) / (num AND name AND age)æ—¶ï¼Œç´¢å¼•æ‰ç”Ÿæ•ˆã€‚æ‰€ä»¥åœ¨åˆ›å»ºè”åˆç´¢å¼•æ—¶ï¼Œå°½é‡æŠŠæŸ¥è¯¢æœ€é¢‘ç¹çš„é‚£ä¸ªå­—æ®µä½œä¸ºæœ€å·¦(ç¬¬ä¸€ä¸ª)å­—æ®µã€‚æŸ¥è¯¢çš„æ—¶å€™ä¹Ÿå°½é‡ä»¥è¿™ä¸ªå­—æ®µä¸ºç¬¬ä¸€æ¡ä»¶ã€‚\n4. äº‹åŠ¡ äº‹åŠ¡æ˜¯é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚\näº‹åŠ¡æœ€ç»å…¸ä¹Ÿç»å¸¸è¢«æ‹¿å‡ºæ¥è¯´ä¾‹å­å°±æ˜¯è½¬è´¦äº†ã€‚å‡å¦‚å°æ˜è¦ç»™å°çº¢è½¬è´¦1000å…ƒï¼Œè¿™ä¸ªè½¬è´¦ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªå…³é”®æ“ä½œå°±æ˜¯ï¼šå°†å°æ˜çš„ä½™é¢å‡å°‘1000å…ƒï¼Œå°†å°çº¢çš„ä½™é¢å¢åŠ 1000å…ƒã€‚ä¸‡ä¸€åœ¨è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´çªç„¶å‡ºç°é”™è¯¯æ¯”å¦‚é“¶è¡Œç³»ç»Ÿå´©æºƒï¼Œå¯¼è‡´å°æ˜ä½™é¢å‡å°‘è€Œå°çº¢çš„ä½™é¢æ²¡æœ‰å¢åŠ ï¼Œè¿™æ ·å°±ä¸å¯¹äº†ã€‚äº‹åŠ¡å°±æ˜¯ä¿è¯è¿™ä¸¤ä¸ªå…³é”®æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½è¦å¤±è´¥ã€‚\n4.1. äº‹åŠ¡çš„å››å¤§ç‰¹æ€§  åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼š äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼› ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼š æ‰§è¡Œäº‹åŠ¡åï¼Œæ•°æ®åº“ä»ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€å˜åŒ–åˆ°å¦ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ï¼› éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼š å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼› æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼š ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚  4.2. å¹¶å‘äº‹åŠ¡å¸¦æ¥äº†å“ªäº›é—®é¢˜ åœ¨å…¸å‹çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¤šä¸ªäº‹åŠ¡å¹¶å‘è¿è¡Œï¼Œç»å¸¸ä¼šæ“ä½œç›¸åŒçš„æ•°æ®æ¥å®Œæˆå„è‡ªçš„ä»»åŠ¡ï¼ˆå¤šä¸ªç”¨æˆ·å¯¹åŒä¸€æ•°æ®è¿›è¡Œæ“ä½œï¼‰ã€‚å¹¶å‘è™½ç„¶æ˜¯å¿…é¡»çš„ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´ä»¥ä¸‹çš„é—®é¢˜ã€‚\n è„è¯»ï¼ˆDirty readï¼‰: å½“ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨è®¿é—®æ•°æ®å¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œè¿™ç§ä¿®æ”¹è¿˜æ²¡æœ‰æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ—¶å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®äº†è¿™ä¸ªæ•°æ®ï¼Œç„¶åä½¿ç”¨äº†è¿™ä¸ªæ•°æ®ï¼ˆA å†™ B è¯»ï¼‰ã€‚å› ä¸ºè¿™ä¸ªæ•°æ®æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œé‚£ä¹ˆå¦å¤–ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°çš„è¿™ä¸ªæ•°æ®æ˜¯â€œè„æ•°æ®â€ï¼Œä¾æ®â€œè„æ•°æ®â€æ‰€åšçš„æ“ä½œå¯èƒ½æ˜¯ä¸æ­£ç¡®çš„ã€‚ ä¸¢å¤±ä¿®æ”¹ï¼ˆLost to modifyï¼‰: æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡è¯»å–ä¸€ä¸ªæ•°æ®æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®äº†è¯¥æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­ä¿®æ”¹äº†è¿™ä¸ªæ•°æ®åï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ä¹Ÿä¿®æ”¹äº†è¿™ä¸ªæ•°æ®ã€‚è¿™æ ·ç¬¬ä¸€ä¸ªäº‹åŠ¡å†…çš„ä¿®æ”¹ç»“æœå°±è¢«ä¸¢å¤±ï¼Œå› æ­¤ç§°ä¸ºä¸¢å¤±ä¿®æ”¹ï¼ˆAå†™ B å†™ï¼‰ã€‚ ä¾‹å¦‚ï¼šäº‹åŠ¡1è¯»å–æŸè¡¨ä¸­çš„æ•°æ®A=20ï¼Œäº‹åŠ¡2ä¹Ÿè¯»å–A=20ï¼Œäº‹åŠ¡1ä¿®æ”¹A=A-1ï¼Œäº‹åŠ¡2ä¹Ÿä¿®æ”¹A=A-1ï¼Œæœ€ç»ˆç»“æœA=19ï¼Œäº‹åŠ¡1çš„ä¿®æ”¹è¢«ä¸¢å¤±ã€‚ ä¸å¯é‡å¤è¯»ï¼ˆUnrepeatablereadï¼‰: æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»åŒä¸€æ•°æ®ã€‚åœ¨è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¯¥æ•°æ®ã€‚é‚£ä¹ˆï¼Œåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­çš„ä¸¤æ¬¡è¯»æ•°æ®ä¹‹é—´ï¼Œç”±äºç¬¬äºŒä¸ªäº‹åŠ¡çš„ä¿®æ”¹å¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»å–çš„æ•°æ®å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚è¿™å°±å‘ç”Ÿäº†åœ¨ä¸€ä¸ªäº‹åŠ¡å†…ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå› æ­¤ç§°ä¸ºä¸å¯é‡å¤è¯»ï¼ˆA è¯» B å†™ A è¯»ï¼‰ã€‚ å¹»è¯»ï¼ˆPhantom readï¼‰: å¹»è¯»ä¸ä¸å¯é‡å¤è¯»ç±»ä¼¼ã€‚å®ƒå‘ç”Ÿåœ¨ä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰è¯»å–äº†å‡ è¡Œæ•°æ®ï¼Œæ¥ç€å¦ä¸€ä¸ªå¹¶å‘äº‹åŠ¡ï¼ˆT2ï¼‰æ’å…¥äº†ä¸€äº›æ•°æ®æ—¶ã€‚åœ¨éšåçš„æŸ¥è¯¢ä¸­ï¼Œç¬¬ä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰å°±ä¼šå‘ç°å¤šäº†ä¸€äº›åŸæœ¬ä¸å­˜åœ¨çš„è®°å½•ï¼Œå°±å¥½åƒå‘ç”Ÿäº†å¹»è§‰ä¸€æ ·ï¼Œæ‰€ä»¥ç§°ä¸ºå¹»è¯»ã€‚ï¼ˆA è¯» B å†™ A è¯»ï¼‰  ä¸å¯é‡å¤è¯»å’Œå¹»è¯»åŒºåˆ«ï¼š\nä¸å¯é‡å¤è¯»çš„é‡ç‚¹æ˜¯ä¿®æ”¹æ¯”å¦‚å¤šæ¬¡è¯»å–ä¸€æ¡è®°å½•å‘ç°å…¶ä¸­æŸäº›åˆ—çš„å€¼è¢«ä¿®æ”¹ï¼Œå¹»è¯»çš„é‡ç‚¹åœ¨äºæ–°å¢æˆ–è€…åˆ é™¤æ¯”å¦‚å¤šæ¬¡è¯»å–ä¸€æ¡è®°å½•å‘ç°è®°å½•å¢å¤šæˆ–å‡å°‘äº†ã€‚\n4.3. äº‹åŠ¡çš„éš”ç¦»çº§åˆ«  READ-UNCOMMITTED(è¯»å–æœªæäº¤)ï¼š æœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ã€‚ READ-COMMITTED(è¯»å–å·²æäº¤)ï¼š å…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚ REPEATABLE-READ(å¯é‡å¤è¯»)ï¼š å¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚ SERIALIZABLE(å¯ä¸²è¡ŒåŒ–)ï¼š æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä»ACIDçš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚     éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»å½±è¯»     READ-UNCOMMITTED âˆš âˆš âˆš   READ-COMMITTED Ã— âˆš âˆš   REPEATABLE-READ Ã— Ã— âˆš   SERIALIZABLE Ã— Ã— Ã—    MySQL InnoDB å­˜å‚¨å¼•æ“çš„é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡SELECT @@tx_isolation;å‘½ä»¤æ¥æŸ¥çœ‹ï¼ŒMySQL 8.0 è¯¥å‘½ä»¤æ”¹ä¸ºSELECT @@transaction_isolation;\nmysql\u0026gt; SELECT @@tx_isolation; +-----------------+ | @@tx_isolation | +-----------------+ | REPEATABLE-READ | +-----------------+  è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸ SQL æ ‡å‡†ä¸åŒçš„åœ°æ–¹åœ¨äº InnoDB å­˜å‚¨å¼•æ“åœ¨ REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰ äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ä½¿ç”¨çš„æ˜¯Next-Key Lock é”ç®—æ³•ï¼Œå› æ­¤å¯ä»¥é¿å…å¹»è¯»çš„äº§ç”Ÿï¼Œè¿™ä¸å…¶ä»–æ•°æ®åº“ç³»ç»Ÿ(å¦‚ SQL Server) æ˜¯ä¸åŒçš„ã€‚æ‰€ä»¥è¯´InnoDB å­˜å‚¨å¼•æ“çš„é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰ å·²ç»å¯ä»¥å®Œå…¨ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§è¦æ±‚ï¼Œå³è¾¾åˆ°äº† SQLæ ‡å‡†çš„ SERIALIZABLE(å¯ä¸²è¡ŒåŒ–) éš”ç¦»çº§åˆ«ã€‚å› ä¸ºéš”ç¦»çº§åˆ«è¶Šä½ï¼Œäº‹åŠ¡è¯·æ±‚çš„é”è¶Šå°‘ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æ•°æ®åº“ç³»ç»Ÿçš„éš”ç¦»çº§åˆ«éƒ½æ˜¯ READ-COMMITTED(è¯»å–æäº¤å†…å®¹) ï¼Œä½†æ˜¯ä½ è¦çŸ¥é“çš„æ˜¯InnoDB å­˜å‚¨å¼•æ“é»˜è®¤ä½¿ç”¨ REPEAaTABLE-READï¼ˆå¯é‡è¯»ï¼‰ å¹¶ä¸ä¼šæœ‰ä»»ä½•æ€§èƒ½æŸå¤±ã€‚\nInnoDB å­˜å‚¨å¼•æ“åœ¨ åˆ†å¸ƒå¼äº‹åŠ¡ çš„æƒ…å†µä¸‹ä¸€èˆ¬ä¼šç”¨åˆ° SERIALIZABLE(å¯ä¸²è¡ŒåŒ–) éš”ç¦»çº§åˆ«ã€‚N,MF.Â Ã”VÂ ","date":"2020å¹´12æœˆ09æ—¥","permalink":"https://ahamoment.cn/posts/interview/interview-mysql/","summary":"1. ä»€ä¹ˆæ˜¯MySQLï¼Ÿ MySQL æ˜¯ä¸€ç§å…³ç³»å‹æ•°æ®åº“ï¼Œåœ¨Javaä¼ä¸šçº§å¼€å‘ä¸­éå¸¸å¸¸ç”¨ï¼Œå› ä¸º MySQL æ˜¯å¼€æºå…è´¹çš„ï¼Œå¹¶ä¸”æ–¹ä¾¿æ‰©å±•ã€‚é˜¿é‡Œå·´å·´æ•°æ®åº“ç³»ç»Ÿä¹Ÿå¤§é‡ç”¨åˆ°äº† MySQLï¼Œå› æ­¤å®ƒçš„ç¨³å®šæ€§æ˜¯æœ‰ä¿éšœçš„ã€‚MySQLæ˜¯å¼€æ”¾æºä»£ç çš„ï¼Œå› æ­¤ä»»ä½•äººéƒ½å¯ä»¥åœ¨ GPL(General Public License) çš„è®¸å¯ä¸‹ä¸‹è½½å¹¶æ ¹æ®ä¸ªæ€§åŒ–çš„éœ€è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚MySQLçš„é»˜è®¤ç«¯å£å·æ˜¯3306ã€‚\n2. å­˜å‚¨å¼•æ“ 2.1. MyISAM å’Œ InnoDB çš„åŒºåˆ« MyISAMæ˜¯MySQLçš„é»˜è®¤æ•°æ®åº“å¼•æ“ï¼ˆ5.5ç‰ˆä¹‹å‰ï¼‰ã€‚è™½ç„¶æ€§èƒ½æä½³ï¼Œè€Œä¸”æä¾›äº†å¤§é‡çš„ç‰¹æ€§ï¼ŒåŒ…æ‹¬å…¨æ–‡ç´¢å¼•ã€å‹ç¼©ã€ç©ºé—´å‡½æ•°ç­‰ï¼Œä½†MyISAMä¸æ”¯æŒäº‹åŠ¡å’Œè¡Œçº§é”ï¼Œè€Œä¸”æœ€å¤§çš„ç¼ºé™·å°±æ˜¯å´©æºƒåæ— æ³•å®‰å…¨æ¢å¤ã€‚ä¸è¿‡ï¼Œ5.5ç‰ˆæœ¬ä¹‹åï¼ŒMySQLå¼•å…¥äº†InnoDBï¼ˆäº‹åŠ¡æ€§æ•°æ®åº“å¼•æ“ï¼‰ï¼ŒMySQL 5.5ç‰ˆæœ¬åé»˜è®¤çš„å­˜å‚¨å¼•æ“ä¸ºInnoDBã€‚","title":"MySQL é¢è¯•é¢˜"},{"contents":"1. æ’¤é”€æäº¤ æ’¤é”€æäº¤å±äºè¯¯æ“ä½œçš„èŒƒç•´ï¼ŒGit è¯¯æ“ä½œçš„ç±»å‹ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š\n commit - åˆ†æ”¯æäº¤é”™è¯¯ reset - è¯¯åˆ ä»£ç   1.1 åˆ†æ”¯æäº¤é”™è¯¯ æœ‰æ—¶æˆ‘ä»¬ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼šæˆ‘ä»¬ä»develop åˆ†æ”¯æ–°å»ºä¸€ä¸ªåä¸ºfeat/home åˆ†æ”¯å»åšAåŠŸèƒ½ï¼Œç„¶åç”±äºä¸€äº›å…¶ä»–åŸå› A åŠŸèƒ½éœ€è¦å»¶åï¼Œç„¶åæˆ‘ä»¬å†ä»developåˆ†æ”¯æ–°å»ºä¸€ä¸ªåˆ†æ”¯å»åšBåŠŸèƒ½æˆ–è€…CåŠŸèƒ½ï¼Œåœ¨å¤šåˆ†æ”¯å¤šåŠŸèƒ½å¼€å‘æ—¶ï¼Œå°±å®¹æ˜“å‡ºç°åšBåŠŸèƒ½æ—¶ï¼Œå¿˜è®°åˆ‡æ¢åˆ†æ”¯ï¼Œä¸€ç›´ç­‰åšå®Œäº†æäº¤äº†pushä¹‹åæ‰å‘ç° push é”™äº†è¿œç«¯çš„åˆ†æ”¯ï¼Œå¹¶ä¸” push çš„æ”¹åŠ¨ä¸è¯¥åˆ†æ”¯éœ€è¦å¼€å‘çš„åŠŸèƒ½å¹¶æ²¡æœ‰äº¤é›†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†å·²ç»æäº¤é”™çš„åˆ†æ”¯å†…å®¹å›æ»šå¹¶æäº¤push åˆ°æ­£ç¡®çš„è¿œç«¯åˆ†æ”¯ã€‚\næ­¤æ—¶æœ‰ä¸¤ç§æƒ…å†µ:\nåœºæ™¯ä¸€ï¼šå·²ç»commitï¼Œä½†æ˜¯æœªpushåˆ°è¿œç«¯ ä½¿ç”¨git resetå‘½ä»¤ï¼Œå¯ä»¥åœ¨æäº¤å±‚é¢åœ¨ç§æœ‰åˆ†æ”¯èˆå¼ƒä¸€äº›æ²¡æœ‰æäº¤çš„ä¿®æ”¹ï¼š\n# å›é€€åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ git reset --hard HEAD^  git reset å‘½ä»¤ä¸»è¦æœ‰ä¸‰ä¸ªé€‰é¡¹ï¼š \u0026ndash;softã€\u0026ndash;mixed ã€\u0026ndash;hardï¼Œé»˜è®¤å‚æ•°ä¸º \u0026ndash;mixedã€‚\ngit reset \u0026ndash;soft æäº¤ï¼š\n--soft è¿™ä¸ªç‰ˆæœ¬çš„å‘½ä»¤æœ‰â€œæœ€å°â€å½±å“ï¼Œåªæ”¹å˜ä¸€ä¸ªç¬¦å·å¼•ç”¨çš„çŠ¶æ€ä½¿å…¶æŒ‡å‘ä¸€ä¸ªæ–°æäº¤ï¼Œä¸ä¼šæ”¹å˜å…¶ç´¢å¼•å’Œå·¥ä½œç›®å½•ï¼Œ å…·ä½“ä½“ç°å¦‚ä¸‹ï¼š\n# æ¨¡æ‹Ÿä¸€ä»½æäº¤å†å² git add 1.js \u0026amp;\u0026amp; git commit -m \u0026quot;update part 1\u0026quot; git add 2.js \u0026amp;\u0026amp; git commit -m \u0026quot;update part 2\u0026quot; git add 3.js \u0026amp;\u0026amp; git commit -m \u0026quot;update part 3\u0026quot; git add 4.js \u0026amp;\u0026amp; git commit -m \u0026quot;update part 4\u0026quot; git log --oneline --graph -4 --decorate  # ç”¨ --soft å‚æ•°å°è¯•å›é€€ä¸€ä¸ªç‰ˆæœ¬ git reset --soft HEAD~1  å½“æˆ‘ä»¬æ‰§è¡Œ --soft å‘½ä»¤åï¼Œå¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ— ä»»ä½•è¾“å‡ºï¼Œæ­¤æ—¶å†æ¬¡æŸ¥çœ‹å½“å‰æäº¤å†å²ï¼š\ngit log --oneline --graph -4 --decorate  å¦‚ä¸‹å›¾ï¼Œå¯ä»¥çœ‹åˆ°ç‰ˆæœ¬åº“å·²ç»å›é€€äº†ä¸€ä¸ªç‰ˆæœ¬ï¼š\næ‰§è¡Œ git statusï¼Œå¯ä»¥çœ‹åˆ°SHA1ä¸º54b1941 çš„commit ä¸Šçš„æ›´æ”¹å›åˆ°äº†ç¼“å­˜åŒºï¼š\nå› æ­¤æˆ‘ä»¬å¯ä»¥è®¤ä¸º \u0026ndash;soft æ“ä½œæ˜¯è½¯é‡ç½®ï¼Œåªæ’¤é”€äº†git commitæ“ä½œï¼Œä¿ç•™äº† git add æ“ä½œã€‚\ngit reset \u0026ndash;hard æäº¤:\næ­¤æ—¶æ¥ä¸Šé¢çš„æµç¨‹ï¼Œæˆ‘ä»¬è¿™æ¬¡æ‰§è¡Œ --hard æ“ä½œï¼Œå°è¯•å›é€€ä¸¤ä¸ªç‰ˆæœ¬ï¼š\ngit reset --hard HEAD~2  å¦‚ä¸‹å›¾ï¼Œå¯ä»¥çœ‹åˆ°ç‰ˆæœ¬åº“å›é€€äº†ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå¹¶ä¸”å°†æœ¬åœ°ç‰ˆæœ¬åº“çš„å¤´æŒ‡é’ˆå…¨éƒ¨é‡ç½®åˆ°äº†æŒ‡å®šç‰ˆæœ¬ï¼Œæš‚å­˜åŒºä¹Ÿä¼šè¢«é‡ç½®ï¼Œå·¥ä½œåŒºçš„ä»£ç ä¹Ÿå›é€€åˆ°äº†è¿™ä¸€ç‰ˆæœ¬ï¼š\næ‰§è¡Œgit status å¯ä»¥çœ‹åˆ° æˆ‘ä»¬çš„ SHA1 ä¸º 54b1941çš„ commit ä¸Šåšçš„ä¿®æ”¹éƒ½â€œä¸¢å¤±â€äº†ï¼Œæ–°çš„æ–‡ä»¶ä¹Ÿè¢«åˆ é™¤äº†ã€‚\nå› æ­¤å¯ä»¥çŸ¥é“ï¼Œgit commit --hard æ˜¯å…·æœ‰ç ´åæ€§ï¼Œæ˜¯å¾ˆå±é™©çš„æ“ä½œï¼Œå®ƒå¾ˆå®¹æ˜“å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œå¦‚æœæˆ‘ä»¬çœŸçš„è¿›è¡Œäº†è¯¥æ“ä½œæƒ³è¦æ‰¾å›ä¸¢å¤±çš„æ•°æ®ï¼Œé‚£ä¹ˆæ­¤æ—¶å¯ä»¥ä½¿ç”¨git reflog å›åˆ°æœªæ¥ï¼Œæ‰¾åˆ°ä¸¢å¤±çš„commitã€‚è¿™ä¸ªå‘½ä»¤çš„å…·ä½“ä½¿ç”¨ä¼šåœ¨æ–‡ç« åé¢ä»‹ç»ã€‚\ngit reset \u0026ndash;mixed æäº¤ï¼š\næˆ‘ä»¬é‡æ–°é€ ä¸€ç³»åˆ— commit å†å²ï¼š\ngit add 1.js \u0026amp;\u0026amp; git commit -m \u0026quot;update 1.js\u0026quot; git add 2.js \u0026amp;\u0026amp; git commit -m \u0026quot;update 2.js\u0026quot; git add 3.js \u0026amp;\u0026amp; git commit -m \u0026quot;update 3.js\u0026quot; git add 4.js \u0026amp;\u0026amp; git commit -m \u0026quot;update 4.js\u0026quot; git add 5.js \u0026amp;\u0026amp; git commit -m \u0026quot;update 5.js\u0026quot; git log --oneline --graph -4 --decorate  å¯ä»¥çœ‹åˆ°å½“å‰çš„ commit å†å²å¦‚ä¸‹ï¼š\næ­¤æ—¶æ‰§è¡Œ\u0026ndash;mixed æ“ä½œï¼Œå°è¯•å›é€€ä¸¤ä¸ªç‰ˆæœ¬ï¼š\n# ç­‰ä»·äº git reset HEAD~2 git reset --mixed HEAD~2  æäº¤å†å²æ­¤æ—¶æ”¹å˜ä¸ºä¸‹å›¾æ‰€ç¤ºï¼š\næ­¤æ—¶æ‰§è¡Œ git status ï¼Œå‘½ä»¤è¡Œè¾“å‡ºå¦‚ä¸‹ï¼š\nHEADã€ç´¢å¼•è¢«æ›´æ”¹ï¼Œå·¥ä½œç›®å½•æœªè¢«æ›´æ”¹\nSourceTree å·¥å…·ä¸Šçš„ç›´è§‚æ˜¾ç¤ºå¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹å‡ºï¼Œè¯¥å‘½ä»¤åŠ ä¸Š \u0026ndash;mixed å‚æ•°ä¼šä¿ç•™æäº¤çš„æºç æ”¹åŠ¨ï¼Œåªæ˜¯å°†ç´¢å¼•ä¿¡æ¯å›é€€åˆ°äº†æŸä¸€ä¸ªç‰ˆæœ¬ï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­æäº¤ï¼Œå†æ¬¡æ‰§è¡Œ git add å’Œ git commit\nä»‹ç»å®Œgit resetï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥è¯´ä¸€ä¸‹å¦‚ä½•ç”¨è¯¥å‘½ä»¤è§£å†³æäº¤åˆ†æ”¯é”™è¯¯çš„é—®é¢˜:\nç¬¬ä¸€ç§æ–¹æ³•ï¼š\né€‚ç”¨äºå¤šä¸ªåˆ†æ”¯ä¸€èµ·å¼€å‘çš„æ—¶å€™å°†Aåˆ†æ”¯çš„æ”¹åŠ¨é”™è¯¯çš„æäº¤åˆ°Bçš„åœºæ™¯ï¼š\n# å°†è¯¥åˆ†æ”¯çš„æœ¬ä¸åº”è¯¥æäº¤çš„commitæ’¤é”€ git reset HEAD^ # æŒ‰éœ€é€‰æ‹©æƒ³è¦å›åˆ°å“ªä¸ªç‰ˆæœ¬ # å›åˆ°HEAD git reset --soft HEAD # å›åˆ°HEADçš„å‰ä¸€ä¸ªç‰ˆæœ¬ git reset --soft HEAD^ # å›åˆ°HEADçš„å‰10ä¸ªç‰ˆæœ¬ git reset --soft HEAD~5 # åˆ©ç”¨idå›åˆ°æŒ‡å®šç‰ˆæœ¬ git reset --soft a06ef2f # å°†æ’¤é”€çš„ä»£ç æš‚å­˜èµ·æ¥ git stash # åˆ‡æ¢åˆ°æ­£ç¡®çš„åˆ†æ”¯ git checkout feat/xxx # é‡æ–°åº”ç”¨ç¼“å­˜ git stash pop # åœ¨æ­£ç¡®çš„åˆ†æ”¯è¿›è¡Œæäº¤æ“ä½œ git add . \u0026amp;\u0026amp; git commit -m \u0026quot;update xxxx\u0026quot;  ç¬¬äºŒç§æ–¹æ³•ï¼š\né€‚ç”¨äºåœ¨ä¸å°å¿ƒåœ¨ master åˆ†æ”¯ä¸Šæäº¤äº†ä»£ç ï¼Œè€Œå®é™…æƒ³è¦åœ¨ feature åˆ†æ”¯ä¸Šæäº¤ä»£ç çš„åœºæ™¯ï¼š\n# æ–°æ£€å‡ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œä½†æ˜¯ä»åœ¨master åˆ†æ”¯ä¸Šï¼Œå¹¶ä¸ä¼šåˆ‡æ¢åˆ°æ–°åˆ†æ”¯ git branch feat/update # æ¢å¤masteræœ¬èº«æäº¤çš„çŠ¶æ€ git reset --hard origin/master # æäº¤é”™çš„ä»£ç å·²ç»åœ¨æ–°æ£€å‡ºçš„åˆ†æ”¯ä¸Šé¢äº†ï¼Œå¯ä»¥ç»§ç»­è¿›è¡Œå¼€å‘æˆ–è€…push git checkout feat/update  ç¬¬ä¸‰ç§æ–¹æ³•ï¼š\n é€‚ç”¨äºæƒ³è¦å¯¹ç‰¹å®šçš„æŸä¸€ä¸ªæˆ–å‡ ä¸ªcommit è¿›è¡Œâ€œå«æ¥â€ï¼Œä½¿å…¶å¤åˆ¶ä¸€ä»½åˆ°æ­£ç¡®çš„ feature åˆ†æ”¯çš„åœºæ™¯ï¼› åœ¨åŠŸèƒ½æ€§è¿­ä»£å¼€å‘ä¸­å‘ç°ä¸€ä¸ªbugï¼Œå¹¶æäº¤äº†ä¸€ä¸ªcommit è¿›è¡Œä¿®å¤ï¼Œä½†æ˜¯å‘ç°è¯¥bugä¹Ÿå­˜åœ¨çº¿ä¸Šçš„å‘å¸ƒç‰ˆæœ¬ä¸Šï¼Œå¿…é¡»è¦å°½å¿«å¯¹çº¿ä¸Šè¿›è¡Œä¿®å¤ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨git cherry-pick å°†bug ä¿®å¤çš„commit å«æ¥åˆ° fix åˆ†æ”¯ä¸Šè¿›è¡Œä»£ç ä¿®å¤ï¼Œå¹¶åŠæ—¶å‘å¸ƒï¼Œè§£å†³çº¿ä¸Šbugã€‚  # å…ˆåˆ‡æ¢åˆ°æ­£ç¡®çš„åˆ†æ”¯ git checkout feat/update # å–å‡ºæäº¤é”™è¯¯çš„æˆ–bug fixçš„ commit å¼•å…¥åˆ°feat/update åˆ†æ”¯ä¸­ git cherry-pick a06ef2f # å›åˆ°é”™è¯¯çš„åˆ†æ”¯ git checkout feat/feedback # å°† a06ef2f çš„æ”¹åŠ¨ä»å½“å‰åˆ†æ”¯é”€æ¯ git reset --head a06ef2f  ä¸Šé¢æ¼”ç¤ºçš„æ˜¯â€œå«æ¥â€ ä¸€ä¸ªcommitï¼Œå¦‚æœæƒ³è¦å«æ¥å¤šä¸ª commit å¯ä»¥è¿™æ ·åšï¼š\n# å°†ä¸‰ä¸ªcommit åˆå¹¶è¿‡æ¥ git cherry-pick b9dabf9 e2c739d dad9e51  å¦‚æœæƒ³åŠ ä¸ªä¸€ä¸ªåº”ç”¨èŒƒå›´å†…çš„ commitï¼Œå¯ä»¥è¿™æ ·åšï¼š\ngit cherry-pick 422db47..e2c739d  éœ€è¦æ³¨æ„çš„æ˜¯æ— è®ºæ˜¯å¯¹å•ä¸ª commit è¿›è¡Œ git cherry-pick ï¼Œè¿˜æ˜¯æ‰¹é‡å¤„ç†ï¼Œæ³¨æ„ä¸€å®šè¦æ ¹æ®æ—¶é—´çº¿ï¼Œä¾ç…§ commit çš„å…ˆåé¡ºåºæ¥å¤„ç†ã€‚\nå¦‚æœä½ åªæƒ³æŠŠæ”¹åŠ¨è½¬ç§»åˆ°ç›®æ ‡åˆ†æ”¯ï¼Œä½†æ˜¯å¹¶ä¸æƒ³æäº¤ï¼Œå¯ä»¥è¿™æ ·åšï¼š\n# --no-commit å‚æ•°ä¼šä½¿å«æ¥è¿‡æ¥çš„æ”¹åŠ¨ä¸ä¼šæäº¤ï¼Œåªä¼šæ”¾åœ¨æš‚å­˜åŒº git cherry-pick b9dabf9 --no-commit  ç¬¬å››ç§æ–¹æ³•ï¼š\né€‚ç”¨äºå½“å¤šä¸ªæ–‡ä»¶è¢«ç¼“å­˜æ—¶ï¼Œå‘ç°å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶æ˜¯å…¶ä»–åˆ†æ”¯çš„åŠŸèƒ½æ€§æ”¹åŠ¨ï¼Œæƒ³ç›´æ¥å–æ¶ˆè¯¥æ–‡ä»¶çš„ç¼“å­˜ï¼š\n# ç¼–è¾‘äº† 1.js 2.js 3.js # ç¼“å­˜æ‰€æœ‰æ”¹åŠ¨çš„æ–‡ä»¶ git add . # å‘ç° 3.js ä¸åº”è¯¥å‡ºç°åœ¨æ­¤æ—¶æäº¤çš„åŠŸèƒ½ä¸Šï¼Œè¦å–æ¶ˆå®ƒçš„ç¼“å­˜ git reset 3.js # æ­¤æ—¶3.js è¢«å–æ¶ˆäº†ç¼“å­˜ï¼Œæˆ‘ä»¬ç»§ç»­æäº¤1.js 2.js git commit -m \u0026quot;Update 1.js 2.js\u0026quot; # å°†3.js æš‚å­˜èµ·æ¥ git stash # åˆ‡æ¢åˆ°æäº¤ 3.js æ”¹åŠ¨çš„åˆ†æ”¯ git checkout feat/update # é‡æ–°åº”ç”¨ç¼“å­˜èµ·æ¥çš„ stashï¼ˆ3.jsï¼‰ # pop å‚æ•°ä¼šå°†ç¼“å­˜æ ˆçš„ç¬¬ä¸€ä¸ªstashåˆ é™¤ï¼Œå¹¶å°†å¯¹åº”ä¿®æ”¹åº”ç”¨åˆ°å½“å‰åˆ†æ”¯ç›®å½•ä¸‹ git stash pop # ç»§ç»­æäº¤ git add \u0026amp;\u0026amp; git commit -m \u0026quot;update 3.js\u0026quot;  åœºæ™¯2ï¼šCommitä¹‹åå·²ç» push åˆ°è¿œç«¯ åœºæ™¯ï¼šå‡è®¾æˆ‘ä»¬åœ¨ feat/feedback åˆ†æ”¯ä¸Šå‘ç°æœ€åä¸€æ¬¡ commit çš„åŠŸèƒ½æ˜¯feat/update åˆ†æ”¯çš„æ”¹åŠ¨ï¼Œæ­¤æ—¶æƒ³è¦å–æ¶ˆè¿™æ¬¡commitï¼ˆupdate 2.jsï¼‰\nä¸‹å›¾æ˜¯feat/feedback çš„æäº¤å†å²ï¼š\næ­¤æ—¶æˆ‘ä»¬éœ€è¦å€ŸåŠ© git revert å‘½ä»¤æ¥æ’¤é”€æˆ‘ä»¬çš„æ“ä½œã€‚\nè§£å†³æ–¹å¼ï¼š\n# æ’¤é”€æœ€è¿‘çš„ä¸€æ¬¡æäº¤ git revert HEAD --no-edit  æ¥ç€æˆ‘ä»¬ä½¿ç”¨ sourceTree æŸ¥çœ‹æ’¤é”€ä¹‹åçš„æäº¤å†å²ï¼š\næˆ‘ä»¬çœ‹åˆ°æƒ³è¦æ’¤é”€çš„ SHA1 ä¸º db6bb3 çš„ commitï¼ˆUpdate 2.jsï¼‰è®°å½•è¿˜åœ¨ï¼Œå¹¶ä¸”å¤šäº†ä¸€ä¸ªSHA1 ä¸º 6e1d7ee æ–°çš„ commitï¼ˆRevert \u0026ldquo;Update 2.js\u0026rdquo;ï¼‰ã€‚å› æ­¤å¯ä»¥çœ‹å‡ºï¼Œgit revert æ˜¯å¯¹ç»™å®šçš„ commit æäº¤è¿›è¡Œé€†è¿‡ç¨‹ï¼Œè¯¥å‘½ä»¤ä¼šå¼•å…¥ä¸€ä¸ªæ–°çš„æäº¤æ¥æŠµæ¶ˆç»™å®šæäº¤çš„å½±å“ã€‚ å’Œ git cherry-pick ä¸€æ ·ï¼Œrevertå‘½ä»¤ä¸ä¿®æ”¹ç‰ˆæœ¬åº“çš„ç°å­˜å†å²è®°å½•ï¼Œç›¸åå®ƒåªä¼šåœ¨è®°å½•æ·»åŠ æ–°çš„æäº¤ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬å·²ç»è§£å†³äº†é”™è¯¯åˆ†æ”¯çš„æäº¤ï¼Œä½†æ˜¯è¿˜è¦æŠŠè¿™æ¬¡æäº¤æ”¾åˆ°æ­£ç¡®çš„åˆ†æ”¯ä¸Šï¼Œä¾ç„¶å¯ä»¥ä½¿ç”¨ git cherry pick å»æ“ä½œï¼š\n# å°†revert commit pushåˆ°è¿œç«¯ git push origin feat/feedback # åˆ‡æ¢åˆ°æ­£ç¡®çš„åˆ†æ”¯ git checkout feat/update å°†ç›®æ ‡commit å«æ¥åˆ°å½“å‰åˆ†æ”¯ git cherry pick db6bb3f  git revert åé¢å¯ä»¥åŠ ä¸åŒçš„å‚æ•°è¾¾åˆ°ä¸åŒçš„æ’¤é”€æ•ˆæœï¼Œå¸¸ç”¨çš„å¦‚ä¸‹ï¼š\n--edit ï¼šè¯¥å‚æ•°ä¸ºgit revert çš„é»˜è®¤å‚æ•°ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»ºæäº¤æ—¥å¿—æé†’ï¼Œæ­¤æ—¶ä¼šå¼¹å‡ºç¼–è¾‘å™¨ä¼šè¯ï¼Œå¯ä»¥åœ¨é‡Œé¢ä¿®æ”¹æäº¤æ¶ˆæ¯ï¼Œç„¶åå†æäº¤ã€‚\ngit revert 6ac5152 --edit  --no-edit ï¼šè¡¨ç¤ºä¸ç¼–è¾‘ commit ä¿¡æ¯ï¼Œrevert çš„ commit ä¼šç›´æ¥è‡ªåŠ¨å˜å› \u0026lsquo;Revert + æƒ³è¦æ’¤é”€çš„commit çš„message\u0026rsquo; çš„æ ¼å¼ã€‚ä¸Šé¢ä¾‹å­ä¸­ä½¿ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼ã€‚\n--no-commitï¼šè¯¥å‘½ä»¤ä¼šä½¿æ’¤é”€çš„ commit é‡Œé¢çš„æ”¹åŠ¨æ”¾åˆ°æš‚å­˜åŒºï¼Œä¸è¿›è¡Œæäº¤ï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œå†æ¬¡æäº¤ã€‚è¿™ç§å‚æ•°å¹¶ä¸”é€‚ç”¨äºå°†å¤šä¸ª commit ç»“æœè¿˜åŸåˆ°ç´¢å¼•ä¸­ï¼Œé›†ä½“æ”¾ç½®åœ¨ç¼“å†²åŒºï¼Œè¿›è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„æ“ä½œã€‚\ngit revert 13b7faf --no-commit  åœºæ™¯3ï¼šæ”¹åŠ¨ä¸ä»…å·²ç» push åˆ°è¿œç«¯ï¼Œå¹¶ä¸”å·²ç»åˆåˆ°ä¸»ä»“åº“ å½“æˆ‘ä»¬æŠŠæœ¬ä¸å±äºè¯¥åˆ†æ”¯çš„ä»£ç æˆ–è€…ä¸éœ€è¦æäº¤çš„æ”¹åŠ¨æäº¤åˆ°ä¸»ä»“åº“ï¼Œå¹¶åˆå¹¶åˆ°äº†develop ä»“åº“ä¹‹åï¼Œè¿™æ˜¯æƒ³è¦æ’¤é”€åˆåˆ°ä¸»ä»“åº“çš„æ”¹åŠ¨ï¼Œè§£å†³æ–¹å¼å¦‚ä¸‹ï¼š\n1. å½“ä»¥pull request çš„æ–¹å¼è¿›è¡Œçš„åˆå¹¶\nåœ¨å›¢é˜Ÿçš„ github flow æµç¨‹ä¸­ï¼Œè‹¥æˆ‘ä»¬æŠŠé—®é¢˜åˆ†æ”¯çš„ pull request è¯·æ±‚é€šè¿‡å¹¶åˆå¹¶åˆ°develop ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ open a pull request é¡µé¢æœ‰å¦‚ä¸‹æç¤ºï¼š\nè¿™æ—¶æˆ‘ä»¬å¯ä»¥ç›´æ¥ç‚¹å‡» ã€Revertã€‘æŒ‰é’®è¿›è¡Œæ’¤å›ã€‚è¯¥æ’¤å›æ“ä½œä¼šæç¤ºä½ éœ€è¦åˆ›å»ºä¸€ä¸ª revert pull requestï¼Œæ ¼å¼é»˜è®¤ä¸ºï¼š revert-${é—®é¢˜prå·}-${é—®é¢˜åˆ†æ”¯}\næœ€åæˆ‘ä»¬å°†revert äº§ç”Ÿçš„ pull request åˆå¹¶åˆ° develop åˆ†æ”¯ã€‚\nå› æ­¤å¯¹äºå›¢é˜Ÿåä½œä¸­ï¼Œæ¨èçš„å·¥ä½œæµç¨‹æ˜¯å¦‚ä¸Šå›¾æ‰€ç¤ºåœ¨ä¸€ä¸ªæ–°åˆ†æ”¯ä¸­æ¢å¤é”™è¯¯çš„æäº¤ã€‚åœ¨è¿™é‡Œæœ‰äººä¼šé—®ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨ develop åˆ†æ”¯è¿›è¡Œ git revert æ“ä½œï¼Œå²‚ä¸æ˜¯æ›´æ–¹ä¾¿ï¼Œä½•å¿…éº»éº»çƒ¦çƒ¦çš„å»å¤šå»ºä¸€ä¸ªåˆ†æ”¯å‡ºæ¥ï¼Ÿ\nè¿™ä¹ˆåšçš„åŸå› æ˜¯ï¼šåœ¨æ‹¥æœ‰å¤§é‡å¼€å‘äººå‘˜çš„å›¢é˜Ÿä¸­ï¼Œ developã€master åˆ†æ”¯ä¸ºä¿æŠ¤åˆ†æ”¯ï¼Œä¸ºäº†å®‰å…¨ä¸å…è®¸æˆ–å»ºè®®å»ç›´æ¥ä¿®æ”¹ã€‚\né€šè¿‡è¿™æ¬¡æ“ä½œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼šrevert åˆ†æ”¯çš„æ“ä½œå®é™…ä¸Šæ˜¯åˆå¹¶è¿›develop åˆ†æ”¯çš„é€†æ“ä½œï¼Œå®ƒä¼šæ–°äº§ç”Ÿä¸€ä¸ªæ–°çš„åˆ†æ”¯ï¼Œå°† feat/feedback çš„æ”¹åŠ¨è¿˜åŸã€‚\nåœ¨å›¢é˜Ÿåä½œæµç¨‹ä¸­ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨ Github çš„ã€Merge pull requestã€‘ ç»¿è‰²æŒ‰é’®è¿›è¡Œåˆå¹¶pull request çš„æ“ä½œï¼Œå› ä¸ºè¿™æ ·ä¼šæ›´ç®€å•ç›´è§‚ï¼Œå»ºè®®å§‹ç»ˆä½¿ç”¨è¯¥ç»¿è‰²æŒ‰é’®è¿›è¡Œæ“ä½œã€‚\n2. å½“ç”¨å‘½ä»¤è¡Œæ‰§è¡Œåˆå¹¶æ—¶\nä¸Šé¢å±•ç¤ºäº†é€šè¿‡ç•Œé¢æŒ‰é’®å»æ“ä½œå¦‚ä½•æ’¤é”€å·²ç»åˆå¹¶develop åˆ†æ”¯çš„æ”¹åŠ¨ï¼Œé‚£ä¹ˆåœ¨ä¸ªäººé¡¹ç›®ä¸­ç”¨å‘½ä»¤è¡Œæ“ä½œæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ\n# æ·»åŠ ä¸‰ä¸ªæ–‡ä»¶ echo 1 \u0026gt; 1.html echo 2 \u0026gt; 2.html echo 3 \u0026gt; 3.html # ä»¥ä¸ºæäº¤çš„æ˜¯1.html 2.htmlï¼Œå°†æ”¹åŠ¨æ¨åˆ°äº†è¿œç«¯åˆ†æ”¯ git add . \u0026amp;\u0026amp; git commit -m \u0026quot;Add 1.html 2.html\u0026quot; git push origin feat/update # å°†feat/updateçš„æ”¹åŠ¨åˆ›å»ºä¸€ä¸ªâ€œåˆå¹¶æäº¤â€åˆå…¥develop åˆ†æ”¯ï¼Œç”Ÿæˆçš„ Merge commit çš„SHA1 ä¸º f439c6f git checkout develop git merge feat/update --no-ff # å¦‚æœå­˜åœ¨å†²çªï¼Œå…ˆè§£å†³å†²çªï¼Œç„¶åç»§ç»­è¯·æ±‚åˆå¹¶ git add . \u0026amp;\u0026amp; git merge --continue # å°†develop åˆå¹¶çš„æœ€åç»“æœæäº¤åˆ°è¿œç«¯ git push origin develop # åˆå¹¶ä¹‹åå‘ç°ä¸åº”è¯¥å°†3.html ä¸åº”è¯¥æ”¾å…¥åŠŸèƒ½è¿­ä»£ä¸­ã€‚éœ€è¦æ’¤é”€æœ¬æ¬¡åˆå¹¶ # åšä»»ä½•æ“ä½œå‰ï¼Œå…ˆä¿è¯æœ¬åœ°çš„develop ä»£ç æ˜¯æœ€æ–°çŠ¶æ€ git pull --rebase origin develop # ä»developåˆ†æ”¯æ–°å»ºä¸€ä¸ª revert åˆ†æ”¯ git checkout -b revert-feat/update # ç”¨ -m å‚æ•°æŒ‡å®šçˆ¶ç¼–å·ï¼ˆä»1å¼€å§‹ï¼‰ï¼Œå› ä¸ºå®ƒæ˜¯â€œåˆå¹¶æäº¤â€ git revert -m 1 f439c6f # push revert çš„æ”¹åŠ¨ git push origin revert-feat/update # åˆ‡æ¢å› develop åˆ†æ”¯ï¼Œå°† revert-feat/update åˆ†æ”¯è¿›è¡Œåˆå¹¶ git checkout develop git merge revert-feat/update --no-ff git push origin develop  å›¾ä¸ºæ–°å»ºrevert åˆ†æ”¯ï¼š\nå›¾ä¸ºgit revert å¼¹å‡ºç¼–è¾‘å™¨ç¼–è¾‘ revert commit message è¿‡ç¨‹ï¼š\nå›¾ä¸ºæ‰§è¡Œå®Œgit revert ä¹‹åçš„ commit å†å²è®°å½•ï¼š\næ¥ä¸‹æ¥æˆ‘ä»¬æƒ³å°† 3.html çš„æ”¹åŠ¨æ’¤é”€çš„æ“ä½œå°±å˜æˆäº†ä¸Šé¢åœºæ™¯ 2 çš„æ“ä½œæµç¨‹äº†ã€‚\nåœºæ™¯4ï¼šrevert é”™è¯¯ï¼Œéœ€è¦å†æ¬¡è¡¥æ•‘ å½“æˆ‘ä»¬çš„ä»£ç åˆåˆ°ä¸»ä»“åº“ï¼Œå¹¶ä¸”æˆåŠŸå‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒï¼Œæ­¤æ—¶å‘ç°çº¿ä¸Šæœ‰é›†ä¸­æŠ¥é”™ï¼Œå¿…é¡»é©¬ä¸Šå°†çº¿ä¸Šä»£ç å›æ»šåˆ°æœ€æ–°ç‰ˆæœ¬ã€‚è¿™æ˜¯æˆ‘ä»¬éœ€è¦è¿›è¡Œrevert æ“ä½œã€‚revert çš„ä»£ç å‘å¸ƒåˆ°ç”Ÿäº§ä¹‹åï¼Œå‘ç°é”™è¯¯ä»æ—§å­˜åœ¨ï¼Œæœ€åæ’æŸ¥åˆ°æ˜¯æŸä¸ªå¤–éƒ¨æœåŠ¡ä¾èµ–å‡ºç°é—®é¢˜ï¼Œæœ¬æ¬¡revert çš„æ”¹åŠ¨æ— å…³ï¼Œå¹¶ä¸”å¤–éƒ¨æœåŠ¡å·²ç»æ¢å¤ã€‚æ­¤æ—¶éœ€è¦å°† revert çš„æ”¹åŠ¨å†æ¬¡å‘å¸ƒä¸Šç”Ÿäº§ç¯å¢ƒã€‚\næˆ‘ä»¬å¯ä»¥å†ç”¨ä¸€æ¬¡git revertï¼Œrevert æ‰æˆ‘ä»¬ä¹‹å‰çš„ revert commitï¼š\ngit revert HEAD --no-edit  è¿™æ · revert æ’¤é”€çš„æ”¹åŠ¨åˆå›æ¥äº†ï¼Œæ­¤æ—¶ä¼šå‘ç°æäº¤å†å²ä¸Šåˆä¼šå‡ºç°ä¸€ä¸ªæ–°çš„revert commitã€‚\n1.2. è¯¯åˆ ä»£ç  ä»‹ç»ä¸Šé¢æäº¤é”™è¯¯ commit çš„æ—¶å€™ï¼Œæˆ‘ä»¬æåˆ°äº†git reset --hardã€‚ å¦‚æœæˆ‘ä»¬çœŸçš„ä½¿ç”¨äº†git reset --hard ä¹‹åï¼Œå‘ç°æŸäº›ä¿®æ”¹è¿˜æœ‰å¿…è¦çš„ï¼Œè¿™æ—¶å€™å°±éœ€è¦å€ŸåŠ©æ—¶å…‰æœº git reflog â€œå›æ¥æœªæ¥â€äº†ã€‚\ngit reflog æ˜¯éå¸¸å¥½ç”¨çš„â€œåæ‚”è¯â€ï¼Œå®ƒå‡ ä¹å¯ä»¥æ¢å¤æˆ‘ä»¬ commit è¿‡çš„æ”¹åŠ¨ï¼Œå³ä½¿è¿™æ¡ commit è®°å½•å·²ç»è¢«æˆ‘ä»¬ reset æ‰äº†ã€‚\nå…·ä½“æ¼”ç¤ºå¦‚ä¸‹ï¼š\nå¦‚ä¸Šå›¾ï¼Œåœ¨å½“å‰æäº¤å†å²ä¸­ï¼Œæˆ‘ä»¬è®¤ä¸ºæœ€æ–°çš„ä¸¤ä¸ªcommit å·²ç»æ²¡æœ‰ç”¨äº†ï¼Œæƒ³ç›´æ¥reset åˆ° SHA1 ä¸º c48a245 è¿™ä¸ª commitï¼š\n# å›åˆ° c48a245 commit git reset --hard c48a245  æ­¤æ—¶æäº¤å†å²å˜ä¸ºç°åœ¨è¿™æ ·ï¼š\næ­¤æ—¶å¯ä»¥çœ‹åˆ°SHA1 ä¸ºc48a245 çš„ commit æ—¶é—´çº¿ä¹‹åçš„æ”¹åŠ¨éƒ½å·²ç»è¢«æ’¤é”€äº†ã€‚ è¿™æ—¶å€™æˆ‘ä»¬çªç„¶æƒ³åˆ°ï¼šcommit ä¿¡æ¯ä¸º â€œAdd 1.html 2.htmlâ€ çš„æäº¤é‡Œé¢çš„æ”¹åŠ¨å¾ˆé‡è¦ï¼Œéœ€è¦è¢«æ‰¾å›ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨ git log æŸ¥çœ‹è¿‡å»æäº¤å†å²ï¼Œå·²ç»æ‰¾ä¸åˆ°è¿™æ¡è¢«æˆ‘ä»¬ reset æ‰çš„å†å²è®°å½•äº†ã€‚è¿™æ—¶å€™è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š\ngit reflog  æˆ‘ä»¬å¦‚æ„¿ä»¥å¿çš„çœ‹åˆ°äº†æ›¾ç»æäº¤è¿‡çš„è¿™ä¸ªæƒ³è¦æ‰¾å›çš„commitï¼ˆcommit: Add 1.html 2.htmlï¼‰ï¼Œå®ƒçš„ SHA1 ä¸º cf2e245ã€‚\næ¥ä¸‹æ¥æ€ä¹ˆåšå–å†³äºä½ å…·ä½“æƒ³è¦è¾¾åˆ°ä»€ä¹ˆç›®çš„ï¼š\n æƒ³è¦å›åˆ°cf2e245 è¿™ä¸ªç‰¹å®šçš„commitï¼š  git reset --hard cf2e245   æƒ³è¦æš‚å­˜ cf2e245 ä¸­çš„æ”¹åŠ¨ï¼Œå¹¶ä¸”ä¸æƒ³é©¬ä¸Šæäº¤ï¼š  git reset --soft cf2e245   æƒ³è¦æŠŠcf2e245 å«æ¥åˆ°æŸä¸ªåˆ†æ”¯ç›®å½•ä¸‹ï¼š  git checkout feat/xxx git cherry-pick cf2e245   æƒ³è¦æ‰¾å› cf2e245 æŸä¸ªæ–‡ä»¶çš„æ”¹åŠ¨ï¼Œæš‚å­˜èµ·æ¥ï¼š  git checkout cf2e245 1.html  å¯¹äº git reflog éœ€è¦æ³¨æ„çš„æ˜¯ï¼š å®ƒä¸æ˜¯ä¸‡èƒ½çš„ã€‚Git ä¼šå®šæœŸæ¸…ç†é‚£äº›ä½ å·²ç»ä¸å†ç”¨åˆ°çš„â€œå¯¹è±¡â€ï¼Œå¦‚æœä½ æƒ³æ‰¾åˆ°å‡ ä¸ªæœˆä»¥å‰çš„æäº¤ï¼Œå¯èƒ½ä¼šæŒ‡æœ›ä¸ä¸Šå®ƒã€‚\n2. filemode çš„å˜åŒ– æ‰§è¡Œgit diff filename ,å‡ºç° old mode 100644 new mode 100755 çš„æç¤ºï¼Œå¦‚ä¸‹å›¾ï¼š\nä½†æ˜¯å‘ç°æ–‡ä»¶å†…å®¹å¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜\näº§ç”Ÿè¿™ä¸ªé—®é¢˜çš„åŸå› å°±æ˜¯ï¼šfilemodeçš„å˜åŒ–ï¼Œæ–‡ä»¶chmodåå…¶æ–‡ä»¶æŸäº›ä½æ˜¯æ”¹å˜äº†çš„ï¼Œå¦‚æœä¸¥æ ¼çš„æ¯”è¾ƒåŸæ–‡ä»¶å’Œchmodåçš„æ–‡ä»¶ï¼Œä¸¤è€…æ˜¯æœ‰åŒºåˆ«çš„ï¼Œä½†æ˜¯æºä»£ç é€šå¸¸åªå…³å¿ƒæ–‡æœ¬å†…å®¹ï¼Œå› æ­¤chmodäº§ç”Ÿçš„å˜åŒ–åº”è¯¥å¿½ç•¥ï¼Œæ‰€ä»¥è®¾ç½®ä¸€ä¸‹ï¼š\nåˆ‡åˆ°æºç çš„æ ¹ç›®å½•ä¸‹ï¼Œ\ngit config --add core.filemode false  è¿™æ ·ä½ çš„æ‰€æœ‰çš„gitåº“éƒ½ä¼šå¿½ç•¥filemodeå˜æ›´äº†ã€‚\nå‚è€ƒ  Git è¯¯æ“ä½œæ•‘å‘½ç¯‡ä¸€ï¼š å¦‚ä½•å°†æ”¹åŠ¨æ’¤é”€\ngit diff old mode 100644 new mode 100755\n ","date":"2020å¹´11æœˆ24æ—¥","permalink":"https://ahamoment.cn/posts/tool/tool-git-common-operations/","summary":"1. æ’¤é”€æäº¤ æ’¤é”€æäº¤å±äºè¯¯æ“ä½œçš„èŒƒç•´ï¼ŒGit è¯¯æ“ä½œçš„ç±»å‹ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š\n commit - åˆ†æ”¯æäº¤é”™è¯¯ reset - è¯¯åˆ ä»£ç   1.1 åˆ†æ”¯æäº¤é”™è¯¯ æœ‰æ—¶æˆ‘ä»¬ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼šæˆ‘ä»¬ä»develop åˆ†æ”¯æ–°å»ºä¸€ä¸ªåä¸ºfeat/home åˆ†æ”¯å»åšAåŠŸèƒ½ï¼Œç„¶åç”±äºä¸€äº›å…¶ä»–åŸå› A åŠŸèƒ½éœ€è¦å»¶åï¼Œç„¶åæˆ‘ä»¬å†ä»developåˆ†æ”¯æ–°å»ºä¸€ä¸ªåˆ†æ”¯å»åšBåŠŸèƒ½æˆ–è€…CåŠŸèƒ½ï¼Œåœ¨å¤šåˆ†æ”¯å¤šåŠŸèƒ½å¼€å‘æ—¶ï¼Œå°±å®¹æ˜“å‡ºç°åšBåŠŸèƒ½æ—¶ï¼Œå¿˜è®°åˆ‡æ¢åˆ†æ”¯ï¼Œä¸€ç›´ç­‰åšå®Œäº†æäº¤äº†pushä¹‹åæ‰å‘ç° push é”™äº†è¿œç«¯çš„åˆ†æ”¯ï¼Œå¹¶ä¸” push çš„æ”¹åŠ¨ä¸è¯¥åˆ†æ”¯éœ€è¦å¼€å‘çš„åŠŸèƒ½å¹¶æ²¡æœ‰äº¤é›†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†å·²ç»æäº¤é”™çš„åˆ†æ”¯å†…å®¹å›æ»šå¹¶æäº¤push åˆ°æ­£ç¡®çš„è¿œç«¯åˆ†æ”¯ã€‚","title":"Git å¸¸ç”¨å‘½ä»¤æ±‡æ€»"},{"contents":"1. ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼Ÿ  æ± åŒ–æŠ€æœ¯ç›¸æ¯”å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€Http è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚\n çº¿ç¨‹æ± æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆåŒ…æ‹¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰ã€‚ æ¯ä¸ªçº¿ç¨‹æ± è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚\nè¿™é‡Œå€Ÿç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹æåˆ°çš„æ¥è¯´ä¸€ä¸‹ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„ï¼š\n é™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚ æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦çš„ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚ æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚  2. è‡ªå®šä¹‰ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ±  ä¸€ä¸ªçº¿ç¨‹æ± åº”è¯¥å…·å¤‡ä»¥ä¸‹è¦ç´ ï¼š\n ä»»åŠ¡é˜Ÿåˆ—ï¼šç”¨äºç¼“å­˜æäº¤çš„ä»»åŠ¡ã€‚ ä»»åŠ¡çº¿ç¨‹ç®¡ç†åŠŸèƒ½ï¼šä¸€ä¸ªçº¿ç¨‹æ± å¿…é¡»èƒ½å¤Ÿå¾ˆå¥½åœ°ç®¡ç†å’Œæ§åˆ¶çº¿ç¨‹æ•°é‡ï¼Œå¯é€šè¿‡å¦‚ä¸‹ä¸‰ä¸ªå‚æ•°æ¥å®ç°ï¼Œæ¯”å¦‚åˆ›å»ºçº¿ç¨‹æ± æ—¶åˆå§‹çš„çº¿ç¨‹æ•°é‡initï¼›çº¿ç¨‹æ± è‡ªåŠ¨æ‰©å……æ—¶æœ€å¤§çš„çº¿ç¨‹æ•°é‡maxï¼›åœ¨çº¿ç¨‹æ± ç©ºé—²æ—¶éœ€è¦é‡Šæ”¾çº¿ç¨‹ä½†æ˜¯ä¹Ÿè¦ç»´æŠ¤ä¸€å®šæ•°é‡çš„æ´»è·ƒæ•°é‡æˆ–è€…æ ¸å¿ƒæ•°é‡coreã€‚æœ‰äº†è¿™ä¸‰ä¸ªå‚æ•°ï¼Œå°±èƒ½å¤Ÿå¾ˆå¥½åœ°æ§åˆ¶çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ï¼Œå°†å…¶ç»´æŠ¤åœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´ä¹‹å†…ï¼Œä¸‰è€…ä¹‹é—´çš„å…³ç³»æ˜¯initï¼œ=coreï¼œ=maxã€‚ ä»»åŠ¡æ‹’ç»ç­–ç•¥ï¼šå¦‚æœçº¿ç¨‹æ•°é‡å·²è¾¾åˆ°ä¸Šé™ä¸”ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™éœ€è¦æœ‰ç›¸åº”çš„æ‹’ç»ç­–ç•¥æ¥é€šçŸ¥ä»»åŠ¡æäº¤è€…ã€‚ çº¿ç¨‹å·¥å‚ï¼šä¸»è¦ç”¨äºä¸ªæ€§åŒ–å®šåˆ¶çº¿ç¨‹ï¼Œæ¯”å¦‚å°†çº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ä»¥åŠè®¾ç½®çº¿ç¨‹åç§°ç­‰ã€‚ QueueSizeï¼šä»»åŠ¡é˜Ÿåˆ—ä¸»è¦å­˜æ”¾æäº¤çš„Runnableï¼Œä½†æ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜æº¢å‡ºï¼Œéœ€è¦æœ‰limitæ•°é‡å¯¹å…¶è¿›è¡Œæ§åˆ¶ã€‚ Keepedaliveæ—¶é—´ï¼šè¯¥æ—¶é—´ä¸»è¦å†³å®šçº¿ç¨‹å„ä¸ªé‡è¦å‚æ•°è‡ªåŠ¨ç»´æŠ¤çš„æ—¶é—´é—´éš”ã€‚  2.1 çº¿ç¨‹æ± å®ç°ç±»å›¾ ä¸Šå›¾ä¸ºçº¿ç¨‹æ± å®ç°ç±»å›¾ï¼Œä¸‹é¢çœ‹å…·ä½“çš„ä»£ç ã€‚\n2.2 ThreadPool å…ˆå®šä¹‰ä¸€ä¸ªçº¿ç¨‹æ± æ¥å£ï¼Œå®šä¹‰å¸¸ç”¨çš„æ–¹æ³•ã€‚\npublic interface ThreadPool { //æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ±  void execute(Runnable runnable); // å…³é—­çº¿ç¨‹æ±  void shutdown(); // è·å–çº¿ç¨‹æ± çš„åˆå§‹åŒ–å¤§å° int getInitSize(); // è·å–çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•° int getMaxSize(); // è·å–çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•° int getCoreSize(); // è·å–çº¿ç¨‹æ± ä¸­ç”¨äºç¼“å­˜ä»»åŠ¡é˜Ÿåˆ—çš„å¤§å° int getQueueSize(); // è·å–çº¿ç¨‹æ± ä¸­æ´»è·ƒçº¿ç¨‹çš„æ•°é‡ int getActiveCount(); // æŸ¥çœ‹çº¿ç¨‹æ± æ˜¯å¦å·²ç»è¢«shutdown boolean isShutdown(); }  2.3 RunnableQueue æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜æ”¾æäº¤çš„ä»»åŠ¡ï¼Œè¯¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ªBlockedQueueï¼Œå¹¶ä¸”æœ‰limitçš„é™åˆ¶ã€‚\npublic interface RunnableQueue { // å½“æœ‰æ–°ä»»åŠ¡è¿›æ¥æ—¶é¦–å…ˆä¼šofferåˆ°é˜Ÿåˆ—ä¸­ void offer(Runnable runnable); // å·¥ä½œçº¿ç¨‹é€šè¿‡takeæ–¹æ³•è·å–Runnable Runnable take() throws InterruptedException; // è·å–ä»»åŠ¡é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„æ•°é‡ int size(); }  2.4 ThreadFactory ThreadFactoryæä¾›äº†åˆ›å»ºçº¿ç¨‹çš„æ¥å£ï¼Œä»¥ä¾¿äºä¸ªæ€§åŒ–åœ°å®šåˆ¶Threadï¼Œæ¯”å¦‚Threadåº”è¯¥è¢«åŠ åˆ°å“ªä¸ªGroupä¸­ï¼Œä¼˜å…ˆçº§ã€çº¿ç¨‹åå­—ä»¥åŠæ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹ç­‰ã€‚\n@FunctionalInterface public interface ThreadFactory { Thread createThread(Runnable runnable); }  2.5 æ‹’ç»ç­–ç•¥ï¼ˆDenyPolicyï¼‰ DenyPolicyä¸»è¦ç”¨äºå½“Queueä¸­çš„runnableè¾¾åˆ°äº†limitä¸Šé™æ—¶ï¼Œå†³å®šé‡‡ç”¨ä½•ç§ç­–ç•¥é€šçŸ¥æäº¤è€…ã€‚è¯¥æ¥å£ä¸­å®šä¹‰äº†ä¸‰ç§é»˜è®¤çš„å®ç°ã€‚\n DiscardDenyPolicyï¼šç›´æ¥å°†ä»»åŠ¡ä¸¢å¼ƒã€‚ AbortDenyPolicyï¼šå‘ä»»åŠ¡æäº¤è€…æŠ›å‡ºå¼‚å¸¸ã€‚ RunnerDenyPolicyï¼šä½¿ç”¨æäº¤è€…æ‰€åœ¨çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚  public interface DenyPolicy { void reject(Runnable runnable, ThreadPool threadPool); /** * è¯¥æ‹’ç»ç­–ç•¥ä¼šç›´æ¥å°†ä»»åŠ¡ä¸¢å¼ƒ */ class DiscardDenyPolicy implements DenyPolicy { @Override public void reject(Runnable runnable, ThreadPool threadPool) { //do nothing System.out.println(\u0026quot;task will be discard\u0026quot;); } } /** * è¯¥æ‹’ç»ç­–ç•¥ä¼šå‘ä»»åŠ¡æäº¤è€…æŠ›å‡ºå¼‚å¸¸ */ class AbortDenyPolicy implements DenyPolicy { @Override public void reject(Runnable runnable, ThreadPool threadPool) { throw new RunnableDenyException(\u0026quot;The Runnable \u0026quot; + runnable + \u0026quot; will be abort.\u0026quot;); } } /** * è¯¥æ‹’ç»ç­–ç•¥ä¼šä½¿ä»»åŠ¡åœ¨æäº¤è€…æ‰€åœ¨çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ */ class RunnerDenyPolicy implements DenyPolicy { @Override public void reject(Runnable runnable, ThreadPool threadPool) { if (!threadPool.isShutdown()) { runnable.run(); } } } }  è¿™é‡Œè¿˜å®šä¹‰äº†ä¸€ä¸ª RunnableDenyException ï¼Œä¸»è¦ç”¨äºé€šçŸ¥ä»»åŠ¡æäº¤è€…ï¼Œä»»åŠ¡é˜Ÿåˆ—å·²ç»æ— æ³•å†æ¥æ”¶æ–°çš„ä»»åŠ¡ã€‚\npublic class RunnableDenyException extends RuntimeException{ public RunnableDenyException(String message) { super(message); } }  2.6 InternalTask InternalTaskæ˜¯Runnableçš„ä¸€ä¸ªå®ç°ï¼Œæ˜¯å®é™…ä»»åŠ¡å­˜å‚¨çš„æ•°æ®ç»“æ„ã€‚ä¸»è¦ç”¨äºçº¿ç¨‹æ± å†…éƒ¨ï¼Œè¯¥ç±»ä¼šä½¿ç”¨åˆ°RunnableQueueï¼Œç„¶åä¸æ–­åœ°ä»queueä¸­å–å‡ºæŸä¸ªrunnableï¼Œå¹¶è¿è¡Œrunnableçš„runæ–¹æ³•ã€‚\npublic class InternalTask implements Runnable{ private final RunnableQueue runnableQueue; private volatile boolean running = true; public InternalTask(RunnableQueue runnableQueue) { this.runnableQueue = runnableQueue; } @Override public void run() { // å¦‚æœå½“å‰ä»»åŠ¡ä¸ºrunningå¹¶ä¸”æ²¡æœ‰è¢«ä¸­æ–­ï¼Œåˆ™å…¶å°†ä¸æ–­åœ°ä»queueä¸­è·å–runnableï¼Œç„¶åæ‰§è¡Œrunæ–¹æ³• // è¿™æ˜¯æäº¤åˆ°çº¿ç¨‹æ± çš„ä»»åŠ¡æœ€ç»ˆè¿è¡Œçš„åœ°æ–¹ while (running \u0026amp;\u0026amp; !Thread.currentThread().isInterrupted()) { try { Runnable task = runnableQueue.take(); task.run(); } catch (InterruptedException e) { running = false; break; } } } // åœæ­¢å½“å‰ä»»åŠ¡ï¼Œä¸»è¦ä¼šåœ¨çº¿ç¨‹æ± çš„shutdownæ–¹æ³•ä¸­ä½¿ç”¨ public void stop() { this.running = false; } }  ä»£ç è¿˜å¯¹è¯¥ç±»å¢åŠ äº†ä¸€ä¸ªå¼€å…³æ–¹æ³•stopï¼Œä¸»è¦ç”¨äºåœæ­¢å½“å‰çº¿ç¨‹ï¼Œä¸€èˆ¬åœ¨çº¿ç¨‹æ± é”€æ¯å’Œçº¿ç¨‹æ•°é‡ç»´æŠ¤çš„æ—¶å€™ä¼šä½¿ç”¨åˆ°ã€‚\n2.7 çº¿ç¨‹æ± è¯¦ç»†å®ç° åœ¨LinkedRunnableQueueä¸­æœ‰å‡ ä¸ªé‡è¦çš„å±æ€§ï¼Œç¬¬ä¸€ä¸ªæ˜¯limitï¼Œä¹Ÿå°±æ˜¯Runnableé˜Ÿåˆ—çš„ä¸Šé™ï¼›å½“æäº¤çš„Runnableæ•°é‡è¾¾åˆ°limitä¸Šé™æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨DenyPolicyçš„rejectæ–¹æ³•ï¼›runnableListæ˜¯ä¸€ä¸ªåŒå‘å¾ªç¯åˆ—è¡¨ï¼Œç”¨äºå­˜æ”¾Runnableä»»åŠ¡\npublic class LinkedRunnableQueue implements RunnableQueue{ // ä»»åŠ¡é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡ï¼Œåœ¨æ„é€ æ—¶ä¼ å…¥ private final int limit; // è‹¥ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™æ‰§è¡Œæ‹’ç»ç­–ç•¥ private final DenyPolicy denyPolicy; // å­˜æ”¾ä»»åŠ¡çš„é˜Ÿåˆ— private final LinkedList\u0026lt;Runnable\u0026gt; runnableList = new LinkedList\u0026lt;\u0026gt;(); private final ThreadPool threadPool; public LinkedRunnableQueue(int limit, DenyPolicy denyPolicy, ThreadPool threadPool) { this.limit = limit; this.denyPolicy = denyPolicy; this.threadPool = threadPool; } @Override public void offer(Runnable runnable) { synchronized (runnableList) { if (runnableList.size() \u0026gt;= limit) { // æ— æ³•å®¹çº³æ–°çš„ä»»åŠ¡ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥ denyPolicy.reject(runnable, threadPool); } else { // å°†ä»»åŠ¡åŠ å…¥é˜Ÿå°¾ï¼Œå¹¶ä¸”å”¤é†’é˜»å¡ä¸­çš„çº¿ç¨‹ runnableList.addLast(runnable); runnableList.notifyAll(); } } } /** * takeæ–¹æ³•ä¹Ÿæ˜¯åŒæ­¥æ–¹æ³•ï¼Œçº¿ç¨‹ä¸æ–­ä»é˜Ÿåˆ—ä¸­è·å–Runnableä»»åŠ¡ï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™å·¥ä½œçº¿ç¨‹ä¼šé™·å…¥é˜»å¡ï¼Œ * æœ‰å¯èƒ½åœ¨é˜»å¡çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼Œä¸ºäº†ä¼ é€’ä¸­æ–­ä¿¡å·éœ€è¦åœ¨catchè¯­å¥å—ä¸­å°†å¼‚å¸¸æŠ›å‡ºä»¥é€šçŸ¥ä¸Šæ¸¸ï¼ˆInternalTaskï¼‰ * @return ä»»åŠ¡ * @throws InterruptedException ä¸­æ–­å¼‚å¸¸ï¼Œé€šçŸ¥ä¸Šæ¸¸(InternalTask) */ @Override public Runnable take() throws InterruptedException { synchronized (runnableList) { while (runnableList.isEmpty()) { try { // å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰å¯æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œè¿›å…¥runnableListå…³è”çš„monitor waitsetä¸­ç­‰å¾…å”¤é†’ runnableList.wait(); } catch (InterruptedException e) { // è¢«ä¸­æ–­æ—¶éœ€è¦å°†å¼‚å¸¸æŠ›å‡º throw e; } } // ä»ä»»åŠ¡é˜Ÿåˆ—å¤´æ’é™¤ä¸€ä¸ªä»»åŠ¡ return runnableList.removeFirst(); } } @Override public int size() { return runnableList.size(); } }  æ ¹æ®å‰é¢çš„è®²è§£ï¼Œçº¿ç¨‹æ± éœ€è¦æœ‰æ•°é‡æ§åˆ¶å±æ€§ã€åˆ›å»ºçº¿ç¨‹å·¥å‚ã€ä»»åŠ¡é˜Ÿåˆ—ç­–ç•¥ç­‰åŠŸèƒ½ï¼Œçº¿ç¨‹æ± åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š\npublic class BasicThreadPool extends Thread implements ThreadPool{ // åˆå§‹åŒ–çº¿ç¨‹æ•°é‡ private final int initSize; // çº¿ç¨‹æ± æœ€å¤§æ•°é‡ private final int maxSize; // çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°é‡ private final int coreSize; // å½“å‰æ´»è·ƒçš„çº¿ç¨‹æ•°é‡ private int activeCount; // åˆ›å»ºçº¿ç¨‹æ‰€éœ€çš„å·¥å‚ private final ThreadFactory threadFactory; // ä»»åŠ¡é˜Ÿåˆ— private final RunnableQueue runnableQueue; // çº¿ç¨‹æ± æ˜¯å¦å·²ç»è¢«shutdown private volatile boolean isShutdown = false; // å·¥ä½œçº¿ç¨‹é˜Ÿåˆ— private final Queue\u0026lt;ThreadTask\u0026gt; threadQueue = new ArrayDeque\u0026lt;\u0026gt;(); private final static DenyPolicy DEFAULT_DENY_POLICY = new DenyPolicy.DiscardDenyPolicy(); private final static ThreadFactory DEFAULT_THREAD_FACTORY = new DefaultThreadFactory(); private final long keepAliveTime; private final TimeUnit timeUnit; // æ„é€ æ—¶éœ€è¦ä¼ é€’çš„å‚æ•°ï¼šåˆå§‹çš„çº¿ç¨‹æ•°é‡ï¼Œæœ€å¤§çš„çº¿ç¨‹æ•°é‡ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼Œä»»åŠ¡é˜Ÿåˆ—çš„æœ€å¤§æ•°é‡ public BasicThreadPool(int initSize, int maxSize, int coreSize, int queueSize) { this(initSize, maxSize, coreSize, DEFAULT_THREAD_FACTORY, queueSize, DEFAULT_DENY_POLICY, 10 ,TimeUnit.SECONDS); } // æ„é€ çº¿ç¨‹æ± æ—¶éœ€è¦ä¼ å…¥çš„å‚æ•°ï¼Œè¯¥æ„é€ å‡½æ•°éœ€è¦çš„å‚æ•°æ¯”è¾ƒå¤š public BasicThreadPool(int initSize, int maxSize, int coreSize, ThreadFactory threadFactory, int queueSize, DenyPolicy denyPolicy, long keepAliveTime, TimeUnit timeUnit) { this.initSize = initSize; this.maxSize = maxSize; this.coreSize = coreSize; this.threadFactory = threadFactory; this.runnableQueue = new LinkedRunnableQueue(queueSize, denyPolicy, this); this.keepAliveTime = keepAliveTime; this.timeUnit = timeUnit; this.init(); } // åˆå§‹åŒ–æ—¶ï¼Œå…ˆåˆ›å»º initSize ä¸ªçº¿ç¨‹ private void init() { start(); for (int i = 0; i \u0026lt; initSize; i++) { newThread(); } } private void newThread() { //åˆ›å»ºä»»åŠ¡çº¿ç¨‹ï¼Œå¹¶ä¸”å¯åŠ¨ InternalTask internalTask = new InternalTask(runnableQueue); Thread thread = this.threadFactory.createThread(internalTask); ThreadTask threadTask = new ThreadTask(thread, internalTask); threadQueue.offer(threadTask); this.activeCount++; thread.start(); } private void removeThread() { // ä»çº¿ç¨‹æ± ä¸­ç§»é™¤æŸä¸ªçº¿ç¨‹ ThreadTask threadTask = threadQueue.remove(); threadTask.internalTask.stop(); this.activeCount--; } @Override public void execute(Runnable runnable) { if (this.isShutdown) { throw new IllegalStateException(\u0026quot;The thread pool is destroy\u0026quot;); } // æäº¤ä»»åŠ¡åªæ˜¯ç®€å•åœ°å¾€ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’å…¥Runnable this.runnableQueue.offer(runnable); } @Override public void run() { // run æ–¹æ³•ç»§æ‰¿è‡ªThreadï¼Œä¸»è¦ç”¨äºç»´æŠ¤çº¿ç¨‹æ•°é‡ï¼Œæ¯”å¦‚æ‰©å®¹ã€å›æ”¶å·¥ä½œ while (!isShutdown \u0026amp;\u0026amp; !isInterrupted()) { try { timeUnit.sleep(keepAliveTime); } catch (InterruptedException e) { isShutdown = true; break; } synchronized (this) { if (isShutdown) { break; } //å½“å‰é˜Ÿåˆ—ä¸­æœ‰å°šæœªå¤„ç†ï¼Œå¹¶ä¸”activeCount\u0026lt;coreSizeåˆ™ç»§ç»­æ‰©å®¹ if (runnableQueue.size() \u0026gt; 0 \u0026amp;\u0026amp; activeCount \u0026lt; coreSize) { for (int i = initSize; i \u0026lt; coreSize; i++) { newThread(); } // continue çš„ç›®çš„åœ¨äºä¸æƒ³è®©çº¿ç¨‹çš„æ‰©å®¹ç›´æ¥è¾¾åˆ°maxsize continue; } // å½“å‰é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡å°šæœªå¤„ç†ï¼Œå¹¶ä¸”activeCount\u0026lt;maxSizeåˆ™ç»§ç»­æ‰©å®¹ if (runnableQueue.size() \u0026gt; 0 \u0026amp;\u0026amp; activeCount \u0026lt; maxSize) { for (int i = coreSize; i \u0026lt; maxSize; ++i) { newThread(); } } // å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼Œåˆ™éœ€è¦å›æ”¶ï¼Œå›æ”¶è‡³coreSizeå³å¯ if (runnableQueue.size() == 0 \u0026amp;\u0026amp; activeCount \u0026gt; coreSize) { for (int i = coreSize; i \u0026lt; activeCount; i++) { removeThread(); } } } } } //ThreadTask åªæ˜¯InternalTaskå’ŒThreadçš„ä¸€ä¸ªç»„åˆ private static class ThreadTask { Thread thread; InternalTask internalTask; public ThreadTask(Thread thread, InternalTask internalTask) { this.thread = thread; this.internalTask = internalTask; } } /** * é”€æ¯çº¿ç¨‹æ± ä¸»è¦ä¸ºäº†æ˜¯åœæ­¢BasicThreadPoolçº¿ç¨‹ï¼Œåœæ­¢çº¿ç¨‹æ± ä¸­çš„æ´»åŠ¨çº¿ç¨‹å¹¶ä¸”å°†isShutdownå¼€å…³å˜é‡æ›´æ”¹ä¸ºtrueã€‚ */ @Override public void shutdown() { synchronized (this) { if (isShutdown) { return; } isShutdown = true; threadQueue.forEach(threadTask -\u0026gt; { threadTask.internalTask.stop(); threadTask.thread.interrupt(); }); this.interrupt(); } } @Override public int getInitSize() { if (isShutdown) { throw new IllegalStateException(\u0026quot;The thread pool is destroy\u0026quot;); } return this.initSize; } @Override public int getMaxSize() { if (isShutdown) { throw new IllegalStateException(\u0026quot;The thread pool is destroy\u0026quot;); } return this.maxSize; } @Override public int getCoreSize() { if (isShutdown) { throw new IllegalStateException(\u0026quot;The thread pool is destroy\u0026quot;); } return this.coreSize; } @Override public int getQueueSize() { if (isShutdown) { throw new IllegalStateException(\u0026quot;The thread pool is destroy\u0026quot;); } return runnableQueue.size(); } @Override public int getActiveCount() { synchronized (this) { return this.activeCount; } } @Override public boolean isShutdown() { return this.isShutdown; } private static class DefaultThreadFactory implements ThreadFactory { private static final AtomicInteger GROUP_COUNTER = new AtomicInteger(1); private static final ThreadGroup group = new ThreadGroup(\u0026quot;MyThreadPool-\u0026quot; + GROUP_COUNTER.getAndIncrement()); private static final AtomicInteger COUNTER = new AtomicInteger(0); @Override public Thread createThread(Runnable runnable) { return new Thread(group, runnable, \u0026quot;thread-pool-\u0026quot; + COUNTER.getAndIncrement()); } } }  è‡ªåŠ¨ç»´æŠ¤çº¿ç¨‹çš„ä»£ç å—æ˜¯åŒæ­¥ä»£ç å—ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜»æ­¢åœ¨çº¿ç¨‹ç»´æŠ¤è¿‡ç¨‹ä¸­çº¿ç¨‹æ± é”€æ¯å¼•èµ·çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚\nä»»åŠ¡é˜Ÿåˆ—ä¸­è‹¥å­˜åœ¨ç§¯å‹ä»»åŠ¡ï¼Œå¹¶ä¸”å½“å‰æ´»åŠ¨çº¿ç¨‹å°‘äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™æ–°å»º coreSize-initSizeæ•°é‡çš„çº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…¶åŠ å…¥åˆ°æ´»åŠ¨çº¿ç¨‹é˜Ÿåˆ—ä¸­ï¼Œä¸ºäº†é˜²æ­¢é©¬ä¸Šè¿›è¡ŒmaxSize-coreSizeæ•°é‡çš„æ‰©å……ï¼Œå»ºè®®ä½¿ç”¨continueç»ˆæ­¢æœ¬æ¬¡å¾ªç¯ã€‚\nä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰ç§¯å‹ä»»åŠ¡ï¼Œå¹¶ä¸”å½“å‰æ´»åŠ¨çº¿ç¨‹å°‘äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ™æ–°å»ºmaxSize-coreSizeæ•°é‡çš„çº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…¶åŠ å…¥åˆ°æ´»åŠ¨é˜Ÿåˆ—ä¸­ã€‚\nå½“å‰çº¿ç¨‹æ± ä¸å¤Ÿç¹å¿™æ—¶ï¼Œåˆ™éœ€è¦å›æ”¶éƒ¨åˆ†çº¿ç¨‹ï¼Œå›æ”¶åˆ°coreSizeæ•°é‡å³å¯ï¼Œå›æ”¶æ—¶è°ƒç”¨removeThread()æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­éœ€è¦è€ƒè™‘çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœè¢«å›æ”¶çš„çº¿ç¨‹æ°å·§ä»Runnableä»»åŠ¡å–å‡ºäº†æŸä¸ªä»»åŠ¡ï¼Œåˆ™ä¼šç»§ç»­ä¿æŒè¯¥çº¿ç¨‹çš„è¿è¡Œï¼Œç›´åˆ°å®Œæˆäº†ä»»åŠ¡çš„è¿è¡Œä¸ºæ­¢ï¼Œè¯¦è§InternalTaskçš„runæ–¹æ³•ã€‚\n3. çº¿ç¨‹æ± çš„åº”ç”¨ å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºåˆ†åˆ«æµ‹è¯•çº¿ç¨‹æ± çš„ä»»åŠ¡æäº¤ã€çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡çš„åŠ¨æ€æ‰©å±•ï¼Œä»¥åŠçº¿ç¨‹æ± çš„é”€æ¯åŠŸèƒ½ã€‚\npublic class ThreadPoolTest { public static void main(String[] args) throws InterruptedException { //å®šä¹‰çº¿ç¨‹æ± ï¼Œåˆå§‹åŒ–çº¿ç¨‹æ•°ä¸º2ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º4ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä½6ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤šå…è®¸1000ä¸ªä»»åŠ¡ final ThreadPool threadPool = new BasicThreadPool(2, 6, 4, 1000); // å®šä¹‰20ä¸ªä»»åŠ¡å¹¶ä¸”æäº¤ç»™çº¿ç¨‹æ±  for (int i = 0; i \u0026lt; 20; i++) { threadPool.execute(()-\u0026gt; { try { TimeUnit.SECONDS.sleep(10); System.out.println(Thread.currentThread().getName() + \u0026quot; is running and done.\u0026quot;); } catch (InterruptedException e) { e.printStackTrace(); } }); } for (; ;) { //ä¸æ–­è¾“å‡ºçº¿ç¨‹æ± çš„ä¿¡æ¯ System.out.println(\u0026quot;getActiveCount: \u0026quot; + threadPool.getActiveCount()); System.out.println(\u0026quot;getQueueSize: \u0026quot; + threadPool.getQueueSize()); System.out.println(\u0026quot;getCoreSize: \u0026quot; + threadPool.getCoreSize()); System.out.println(\u0026quot;getMaxSize: \u0026quot; + threadPool.getMaxSize()); System.out.println(\u0026quot;================================================\u0026quot;); TimeUnit.SECONDS.sleep(5); } } }  ä¸Šè¿°æµ‹è¯•ä»£ç ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªBasicçº¿ç¨‹æ± ï¼Œå…¶ä¸­åˆå§‹åŒ–çº¿ç¨‹æ•°é‡ä¸º2ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°é‡ä¸º4ï¼Œæœ€å¤§çº¿ç¨‹æ•°é‡ä¸º6ï¼Œæœ€å¤§ä»»åŠ¡é˜Ÿåˆ—æ•°é‡ä¸º1000ï¼ŒåŒæ—¶æäº¤äº†20ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­ï¼Œç„¶ååœ¨mainçº¿ç¨‹ä¸­ä¸æ–­åœ°è¾“å‡ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ä¿¡æ¯ç›‘æ§å˜åŒ–ï¼Œè¿è¡Œä¸Šè¿°ä»£ç ï¼Œæˆªå–çš„éƒ¨åˆ†è¾“å‡ºä¿¡æ¯å¦‚ä¸‹ï¼š\ngetActiveCount: 2 getQueueSize: 18 getCoreSize: 4 getMaxSize: 6 ================================================ getActiveCount: 2 getQueueSize: 18 getCoreSize: 4 getMaxSize: 6 ================================================ thread-pool-1 is running and done. thread-pool-0 is running and done. getActiveCount: 4 getQueueSize: 14 getCoreSize: 4 getMaxSize: 6 ================================================ getActiveCount: 4 getQueueSize: 14 getCoreSize: 4 getMaxSize: 6 ================================================ thread-pool-2 is running and done. thread-pool-3 is running and done. thread-pool-0 is running and done. thread-pool-1 is running and done. getActiveCount: 6 getQueueSize: 8 getCoreSize: 4 getMaxSize: 6 ================================================ getActiveCount: 6 getQueueSize: 8 getCoreSize: 4 getMaxSize: 6 ================================================ thread-pool-4 is running and done. thread-pool-5 is running and done. thread-pool-3 is running and done. thread-pool-2 is running and done. thread-pool-0 is running and done. thread-pool-1 is running and done. getActiveCount: 6 getQueueSize: 2 getCoreSize: 4 getMaxSize: 6 ================================================ getActiveCount: 6 getQueueSize: 2 getCoreSize: 4 getMaxSize: 6 ================================================ thread-pool-3 is running and done. thread-pool-2 is running and done. thread-pool-5 is running and done. thread-pool-4 is running and done. thread-pool-1 is running and done. thread-pool-0 is running and done. getActiveCount: 6 getQueueSize: 0 getCoreSize: 4 getMaxSize: 6 ================================================ getActiveCount: 6 getQueueSize: 0 getCoreSize: 4 getMaxSize: 6 ================================================ thread-pool-3 is running and done. thread-pool-2 is running and done. getActiveCount: 5 getQueueSize: 0 getCoreSize: 4 getMaxSize: 6 ================================================ getActiveCount: 5 getQueueSize: 0 getCoreSize: 4 getMaxSize: 6 ================================================ getActiveCount: 4 getQueueSize: 0 getCoreSize: 4 getMaxSize: 6 ================================================  é€šè¿‡ä¸Šè¿°è¾“å‡ºä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„åŠ¨æ€æ‰©å±•çŠ¶å†µä»¥åŠä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼Œåœ¨è¾“å‡ºçš„æœ€åä¼šå‘ç°active countåœç•™åœ¨äº†core sizeçš„ä½ç½®ï¼Œè¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬çš„è®¾è®¡ï¼Œæœ€åä¸ºäº†ç¡®å®šçº¿ç¨‹æ± ä¸­çš„æ´»è·ƒçº¿ç¨‹æ•°é‡\n================================================ getActiveCount: 4 getQueueSize: 0 getCoreSize: 4 getMaxSize: 6 ================================================ getActiveCount: 4 getQueueSize: 0 getCoreSize: 4 getMaxSize: 6  4. å‚è€ƒ  ã€1ã€‘ã€ŠJava é«˜å¹¶å‘ç¼–ç¨‹è¯¦è§£ã€‹-æ±ªæ–‡å›\n ","date":"2020å¹´11æœˆ12æ—¥","permalink":"https://ahamoment.cn/posts/java/java-multithread-thread-pool/","summary":"1. ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼Ÿ  æ± åŒ–æŠ€æœ¯ç›¸æ¯”å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€Http è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚\n çº¿ç¨‹æ± æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆåŒ…æ‹¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰ã€‚ æ¯ä¸ªçº¿ç¨‹æ± è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚\nè¿™é‡Œå€Ÿç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹æåˆ°çš„æ¥è¯´ä¸€ä¸‹ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„ï¼š\n é™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚ æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦çš„ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚ æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚  2. è‡ªå®šä¹‰ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ±  ä¸€ä¸ªçº¿ç¨‹æ± åº”è¯¥å…·å¤‡ä»¥ä¸‹è¦ç´ ï¼š\n ä»»åŠ¡é˜Ÿåˆ—ï¼šç”¨äºç¼“å­˜æäº¤çš„ä»»åŠ¡ã€‚ ä»»åŠ¡çº¿ç¨‹ç®¡ç†åŠŸèƒ½ï¼šä¸€ä¸ªçº¿ç¨‹æ± å¿…é¡»èƒ½å¤Ÿå¾ˆå¥½åœ°ç®¡ç†å’Œæ§åˆ¶çº¿ç¨‹æ•°é‡ï¼Œå¯é€šè¿‡å¦‚ä¸‹ä¸‰ä¸ªå‚æ•°æ¥å®ç°ï¼Œæ¯”å¦‚åˆ›å»ºçº¿ç¨‹æ± æ—¶åˆå§‹çš„çº¿ç¨‹æ•°é‡initï¼›çº¿ç¨‹æ± è‡ªåŠ¨æ‰©å……æ—¶æœ€å¤§çš„çº¿ç¨‹æ•°é‡maxï¼›åœ¨çº¿ç¨‹æ± ç©ºé—²æ—¶éœ€è¦é‡Šæ”¾çº¿ç¨‹ä½†æ˜¯ä¹Ÿè¦ç»´æŠ¤ä¸€å®šæ•°é‡çš„æ´»è·ƒæ•°é‡æˆ–è€…æ ¸å¿ƒæ•°é‡coreã€‚æœ‰äº†è¿™ä¸‰ä¸ªå‚æ•°ï¼Œå°±èƒ½å¤Ÿå¾ˆå¥½åœ°æ§åˆ¶çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ï¼Œå°†å…¶ç»´æŠ¤åœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´ä¹‹å†…ï¼Œä¸‰è€…ä¹‹é—´çš„å…³ç³»æ˜¯initï¼œ=coreï¼œ=maxã€‚ ä»»åŠ¡æ‹’ç»ç­–ç•¥ï¼šå¦‚æœçº¿ç¨‹æ•°é‡å·²è¾¾åˆ°ä¸Šé™ä¸”ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™éœ€è¦æœ‰ç›¸åº”çš„æ‹’ç»ç­–ç•¥æ¥é€šçŸ¥ä»»åŠ¡æäº¤è€…ã€‚ çº¿ç¨‹å·¥å‚ï¼šä¸»è¦ç”¨äºä¸ªæ€§åŒ–å®šåˆ¶çº¿ç¨‹ï¼Œæ¯”å¦‚å°†çº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ä»¥åŠè®¾ç½®çº¿ç¨‹åç§°ç­‰ã€‚ QueueSizeï¼šä»»åŠ¡é˜Ÿåˆ—ä¸»è¦å­˜æ”¾æäº¤çš„Runnableï¼Œä½†æ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜æº¢å‡ºï¼Œéœ€è¦æœ‰limitæ•°é‡å¯¹å…¶è¿›è¡Œæ§åˆ¶ã€‚ Keepedaliveæ—¶é—´ï¼šè¯¥æ—¶é—´ä¸»è¦å†³å®šçº¿ç¨‹å„ä¸ªé‡è¦å‚æ•°è‡ªåŠ¨ç»´æŠ¤çš„æ—¶é—´é—´éš”ã€‚  2.","title":"Java å¤šçº¿ç¨‹ - è‡ªå®šä¹‰çº¿ç¨‹æ± "},{"contents":"çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¤§ä½“å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹6ä¸ªä¸»è¦çš„é˜¶æ®µï¼š\n NEW RUNNABLE WAITING TIMED_WAITING BLOCKED TERMINATED  ä» JDK çš„æºä»£ç ä¸­ä¹Ÿèƒ½çœ‹åˆ°å…³äºçº¿ç¨‹çŠ¶æ€çš„æè¿°ï¼š\n// Thread.State public enum State { /** * Thread state for a thread which has not yet started. */ NEW, /** * Thread state for a runnable thread. A thread in the runnable * state is executing in the Java virtual machine but it may * be waiting for other resources from the operating system * such as processor. */ RUNNABLE, /** * Thread state for a thread blocked waiting for a monitor lock. * A thread in the blocked state is waiting for a monitor lock * to enter a synchronized block/method or * reenter a synchronized block/method after calling * {@link Object#wait() Object.wait}. */ BLOCKED, /** * Thread state for a waiting thread. * A thread is in the waiting state due to calling one of the * following methods: * \u0026lt;ul\u0026gt; * \u0026lt;li\u0026gt;{@link Object#wait() Object.wait} with no timeout\u0026lt;/li\u0026gt; * \u0026lt;li\u0026gt;{@link #join() Thread.join} with no timeout\u0026lt;/li\u0026gt; * \u0026lt;li\u0026gt;{@link LockSupport#park() LockSupport.park}\u0026lt;/li\u0026gt; * \u0026lt;/ul\u0026gt; * * \u0026lt;p\u0026gt;A thread in the waiting state is waiting for another thread to * perform a particular action. * * For example, a thread that has called \u0026lt;tt\u0026gt;Object.wait()\u0026lt;/tt\u0026gt; * on an object is waiting for another thread to call * \u0026lt;tt\u0026gt;Object.notify()\u0026lt;/tt\u0026gt; or \u0026lt;tt\u0026gt;Object.notifyAll()\u0026lt;/tt\u0026gt; on * that object. A thread that has called \u0026lt;tt\u0026gt;Thread.join()\u0026lt;/tt\u0026gt; * is waiting for a specified thread to terminate. */ WAITING, /** * Thread state for a waiting thread with a specified waiting time. * A thread is in the timed waiting state due to calling one of * the following methods with a specified positive waiting time: * \u0026lt;ul\u0026gt; * \u0026lt;li\u0026gt;{@link #sleep Thread.sleep}\u0026lt;/li\u0026gt; * \u0026lt;li\u0026gt;{@link Object#wait(long) Object.wait} with timeout\u0026lt;/li\u0026gt; * \u0026lt;li\u0026gt;{@link #join(long) Thread.join} with timeout\u0026lt;/li\u0026gt; * \u0026lt;li\u0026gt;{@link LockSupport#parkNanos LockSupport.parkNanos}\u0026lt;/li\u0026gt; * \u0026lt;li\u0026gt;{@link LockSupport#parkUntil LockSupport.parkUntil}\u0026lt;/li\u0026gt; * \u0026lt;/ul\u0026gt; */ TIMED_WAITING, /** * Thread state for a terminated thread. * The thread has completed execution. */ TERMINATED; }  çº¿ç¨‹çš„NEWçŠ¶æ€ å½“æˆ‘ä»¬ç”¨å…³é”®å­—newåˆ›å»ºä¸€ä¸ªThreadå¯¹è±¡æ—¶ï¼Œæ­¤æ—¶å®ƒå¹¶ä¸å¤„äºæ‰§è¡ŒçŠ¶æ€ï¼Œå› ä¸ºæ²¡æœ‰è°ƒç”¨startæ–¹æ³•å¯åŠ¨è¯¥çº¿ç¨‹ï¼Œé‚£ä¹ˆçº¿ç¨‹çš„çŠ¶æ€ä¸ºNEWçŠ¶æ€ï¼Œå‡†ç¡®åœ°è¯´ï¼Œå®ƒåªæ˜¯Threadå¯¹è±¡çš„çŠ¶æ€ï¼Œå› ä¸ºåœ¨æ²¡æœ‰startä¹‹å‰ï¼Œè¯¥çº¿ç¨‹æ ¹æœ¬ä¸å­˜åœ¨ï¼Œä¸ä½ ç”¨å…³é”®å­—newåˆ›å»ºä¸€ä¸ªæ™®é€šçš„Javaå¯¹è±¡æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚\nNEWçŠ¶æ€é€šè¿‡startæ–¹æ³•è¿›å…¥RUNNABLEçŠ¶æ€ã€‚\nçº¿ç¨‹çš„RUNNABLEçŠ¶æ€ æ“ä½œç³»ç»Ÿéšè— Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰ä¸­çš„ READY å’Œ RUNNING çŠ¶æ€ï¼Œå®ƒåªèƒ½çœ‹åˆ° RUNNABLE çŠ¶æ€ï¼Œæ‰€ä»¥ Java ç³»ç»Ÿä¸€èˆ¬å°†è¿™ä¸¤ä¸ªçŠ¶æ€ç»Ÿç§°ä¸º RUNNABLEï¼ˆè¿è¡Œä¸­ï¼‰ çŠ¶æ€ ã€‚\nçº¿ç¨‹è°ƒç”¨ start() æ–¹æ³•åå¼€å§‹è¿è¡Œï¼Œé‚£ä¹ˆæ­¤æ—¶æ‰æ˜¯çœŸæ­£åœ°åœ¨JVMè¿›ç¨‹ä¸­åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹ä¸€ç»å¯åŠ¨å°±å¯ä»¥ç«‹å³å¾—åˆ°æ‰§è¡Œå—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œçº¿ç¨‹çš„è¿è¡Œä¸å¦å’Œè¿›ç¨‹ä¸€æ ·éƒ½è¦å¬ä»¤äºCPUçš„è°ƒåº¦ï¼Œçº¿ç¨‹è¿™æ—¶å€™å¤„äº READYï¼ˆå¯è¿è¡Œï¼‰ çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå…·å¤‡æ‰§è¡Œçš„èµ„æ ¼ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰çœŸæ­£åœ°æ‰§è¡Œèµ·æ¥è€Œæ˜¯åœ¨ç­‰å¾…CPUçš„è°ƒåº¦ã€‚å¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹è·å¾—äº† CPU æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰åå°±å¤„äº RUNNINGï¼ˆè¿è¡Œï¼‰ çŠ¶æ€ã€‚\nç”±äºå­˜åœ¨RUNNINGçŠ¶æ€ï¼Œæ‰€ä»¥ä¸ä¼šç›´æ¥è¿›å…¥BLOCKEDçŠ¶æ€å’ŒTERMINATEDçŠ¶æ€ï¼Œå³ä½¿æ˜¯åœ¨çº¿ç¨‹çš„æ‰§è¡Œé€»è¾‘ä¸­è°ƒç”¨waitã€sleepæˆ–è€…å…¶ä»–blockçš„IOæ“ä½œç­‰ï¼Œä¹Ÿå¿…é¡»å…ˆè·å¾—CPUçš„è°ƒåº¦æ‰§è¡Œæƒæ‰å¯ä»¥ï¼Œä¸¥æ ¼æ¥è®²ï¼ŒRUNNABLEçš„çº¿ç¨‹åªèƒ½æ„å¤–ç»ˆæ­¢æˆ–è€…è¿›å…¥RUNNINGçŠ¶æ€ã€‚\nåœ¨è¯¥RUNNINGçŠ¶æ€ä¸­ï¼Œçº¿ç¨‹çš„çŠ¶æ€å¯ä»¥å‘ç”Ÿå¦‚ä¸‹çš„çŠ¶æ€è½¬æ¢ã€‚\n ç›´æ¥è¿›å…¥TERMINATEDçŠ¶æ€ï¼Œæ¯”å¦‚è°ƒç”¨JDKå·²ç»ä¸æ¨èä½¿ç”¨çš„stopæ–¹æ³•æˆ–è€…åˆ¤æ–­æŸä¸ªé€»è¾‘æ ‡è¯†ã€‚ è¿›å…¥WAITINGçŠ¶æ€ï¼Œæ¯”å¦‚è°ƒç”¨äº†sleepï¼Œæˆ–è€…waitæ–¹æ³•è€ŒåŠ å…¥äº†waitSetä¸­ã€‚ è¿›è¡ŒæŸä¸ªé˜»å¡çš„IOæ“ä½œï¼Œæ¯”å¦‚å› ç½‘ç»œæ•°æ®çš„è¯»å†™è€Œè¿›å…¥äº†BLOCKEDçŠ¶æ€ã€‚ è·å–æŸä¸ªé”èµ„æºï¼Œä»è€ŒåŠ å…¥åˆ°è¯¥é”çš„é˜»å¡é˜Ÿåˆ—ä¸­è€Œè¿›å…¥äº†BLOCKEDçŠ¶æ€ã€‚ ç”±äºCPUçš„è°ƒåº¦å™¨è½®è¯¢ä½¿è¯¥çº¿ç¨‹æ”¾å¼ƒæ‰§è¡Œï¼Œè¿›å…¥READY çŠ¶æ€ã€‚ çº¿ç¨‹ä¸»åŠ¨è°ƒç”¨yieldæ–¹æ³•ï¼Œæ”¾å¼ƒCPUæ‰§è¡Œæƒï¼Œè¿›å…¥READYçŠ¶æ€ã€‚  çº¿ç¨‹çš„BLOCKEDçŠ¶æ€ çº¿ç¨‹åœ¨BLOCKEDçŠ¶æ€ä¸­å¯ä»¥åˆ‡æ¢è‡³å¦‚ä¸‹å‡ ä¸ªçŠ¶æ€ã€‚\n ç›´æ¥è¿›å…¥TERMINATEDçŠ¶æ€ï¼Œæ¯”å¦‚è°ƒç”¨JDKå·²ç»ä¸æ¨èä½¿ç”¨çš„stopæ–¹æ³•æˆ–è€…æ„å¤–æ­»äº¡ï¼ˆJVM Crashï¼‰ã€‚ çº¿ç¨‹é˜»å¡çš„æ“ä½œç»“æŸï¼Œæ¯”å¦‚è¯»å–äº†æƒ³è¦çš„æ•°æ®å­—èŠ‚è¿›å…¥åˆ°RUNNABLEçŠ¶æ€ã€‚ çº¿ç¨‹å®Œæˆäº†æŒ‡å®šæ—¶é—´çš„ä¼‘çœ ï¼Œè¿›å…¥åˆ°äº†RUNNABLEçŠ¶æ€ã€‚ çº¿ç¨‹è·å–åˆ°äº†æŸä¸ªé”èµ„æºï¼Œè¿›å…¥RUNNABLEçŠ¶æ€ã€‚ çº¿ç¨‹åœ¨é˜»å¡è¿‡ç¨‹ä¸­è¢«æ‰“æ–­ï¼Œæ¯”å¦‚å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†interruptæ–¹æ³•ï¼Œè¿›å…¥RUNNABLEçŠ¶æ€ã€‚  çº¿ç¨‹çš„ WAITING çŠ¶æ€ çº¿ç¨‹è¿›å…¥WAITINGçŠ¶æ€ï¼Œå¯èƒ½æ˜¯è°ƒç”¨äº†wait/join/parkæ–¹æ³•ä½¿çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå¤„åœ¨WAITING çŠ¶æ€çš„çº¿ç¨‹è¢«å…¶ä»–çº¿ç¨‹è°ƒç”¨ notify/notifyAll å”¤é†’ä¹‹åï¼Œå°±ä¼šé‡æ–°è¿›å…¥ RUNNABLE çŠ¶æ€ã€‚\nçº¿ç¨‹çš„ TIMED_WAITING çŠ¶æ€ TIMED_WAITING å°±æ˜¯è¶…æ—¶ç­‰å¾…çš„æ„æ€ï¼Œè·Ÿ WAITING çŠ¶æ€ä¸åŒçš„æ˜¯ï¼ŒTIMED_WAITING ä¼šç­‰å¾…æŒ‡å®šçš„è¶…æ—¶æ—¶é—´åè‡ªåŠ¨é€€å‡ºã€‚\nçº¿ç¨‹çš„TERMINATEDçŠ¶æ€ TERMINATEDæ˜¯ä¸€ä¸ªçº¿ç¨‹çš„æœ€ç»ˆçŠ¶æ€ï¼Œåœ¨è¯¥çŠ¶æ€ä¸­çº¿ç¨‹å°†ä¸ä¼šåˆ‡æ¢åˆ°å…¶ä»–ä»»ä½•çŠ¶æ€ï¼Œçº¿ç¨‹è¿›å…¥TERMINATEDçŠ¶æ€ï¼Œæ„å‘³ç€è¯¥çº¿ç¨‹çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½ç»“æŸäº†ï¼Œä¸‹åˆ—è¿™äº›æƒ…å†µå°†ä¼šä½¿çº¿ç¨‹è¿›å…¥TERMINATEDçŠ¶æ€ã€‚\n çº¿ç¨‹è¿è¡Œæ­£å¸¸ç»“æŸï¼Œç»“æŸç”Ÿå‘½å‘¨æœŸã€‚ çº¿ç¨‹è¿è¡Œå‡ºé”™æ„å¤–ç»“æŸã€‚ JVM Crashï¼Œå¯¼è‡´æ‰€æœ‰çš„çº¿ç¨‹éƒ½ç»“æŸã€‚  å‚è€ƒ  ã€1ã€‘ã€ŠJava é«˜å¹¶å‘ç¼–ç¨‹è¯¦è§£ã€‹-æ±ªæ–‡å›\n ","date":"2020å¹´11æœˆ11æ—¥","permalink":"https://ahamoment.cn/posts/java/java-multithread-thread-lifecycle/","summary":"çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¤§ä½“å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹6ä¸ªä¸»è¦çš„é˜¶æ®µï¼š\n NEW RUNNABLE WAITING TIMED_WAITING BLOCKED TERMINATED  ä» JDK çš„æºä»£ç ä¸­ä¹Ÿèƒ½çœ‹åˆ°å…³äºçº¿ç¨‹çŠ¶æ€çš„æè¿°ï¼š\n// Thread.State public enum State { /** * Thread state for a thread which has not yet started.","title":"Java å¤šçº¿ç¨‹ - çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ"},{"contents":" JavaGuide\n 1. è¯·ç®€è¦æè¿°çº¿ç¨‹ä¸è¿›ç¨‹çš„å…³ç³»ï¼ŒåŒºåˆ«åŠä¼˜ç¼ºç‚¹ï¼Ÿ ä» JVM è§’åº¦è¯´è¿›ç¨‹å’Œçº¿ç¨‹ä¹‹é—´çš„å…³ç³»\nä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„å †å’Œ**æ–¹æ³•åŒº (JDK1.8 ä¹‹åçš„å…ƒç©ºé—´)*èµ„æºï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„*ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆ å’Œ æœ¬åœ°æ–¹æ³•æ ˆã€‚\næ€»ç»“ï¼š çº¿ç¨‹æ˜¯è¿›ç¨‹åˆ’åˆ†æˆçš„æ›´å°çš„è¿è¡Œå•ä½ã€‚çº¿ç¨‹å’Œè¿›ç¨‹æœ€å¤§çš„ä¸åŒåœ¨äºåŸºæœ¬ä¸Šå„è¿›ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œå„çº¿ç¨‹åˆ™ä¸ä¸€å®šï¼Œå› ä¸ºåŒä¸€è¿›ç¨‹ä¸­çš„çº¿ç¨‹ææœ‰å¯èƒ½ä¼šç›¸äº’å½±å“ã€‚çº¿ç¨‹æ‰§è¡Œå¼€é”€å°ï¼Œä½†ä¸åˆ©äºèµ„æºçš„ç®¡ç†å’Œä¿æŠ¤ï¼›è€Œè¿›ç¨‹æ­£ç›¸åã€‚\nä¸‹é¢æ˜¯è¯¥çŸ¥è¯†ç‚¹çš„æ‰©å±•å†…å®¹ï¼\nä¸‹é¢æ¥æ€è€ƒè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„å‘¢ï¼Ÿä¸ºä»€ä¹ˆå †å’Œæ–¹æ³•åŒºæ˜¯çº¿ç¨‹å…±äº«çš„å‘¢ï¼Ÿ\n1.1. ç¨‹åºè®¡æ•°å™¨ä¸ºä»€ä¹ˆæ˜¯ç§æœ‰çš„? ç¨‹åºè®¡æ•°å™¨ä¸»è¦æœ‰ä¸‹é¢ä¸¤ä¸ªä½œç”¨ï¼š\n å­—èŠ‚ç è§£é‡Šå™¨é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨æ¥ä¾æ¬¡è¯»å–æŒ‡ä»¤ï¼Œä»è€Œå®ç°ä»£ç çš„æµç¨‹æ§åˆ¶ï¼Œå¦‚ï¼šé¡ºåºæ‰§è¡Œã€é€‰æ‹©ã€å¾ªç¯ã€å¼‚å¸¸å¤„ç†ã€‚ åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œç¨‹åºè®¡æ•°å™¨ç”¨äºè®°å½•å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ä½ç½®ï¼Œä»è€Œå½“çº¿ç¨‹è¢«åˆ‡æ¢å›æ¥çš„æ—¶å€™èƒ½å¤ŸçŸ¥é“è¯¥çº¿ç¨‹ä¸Šæ¬¡è¿è¡Œåˆ°å“ªå„¿äº†ã€‚  éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ‰§è¡Œçš„æ˜¯ native æ–¹æ³•ï¼Œé‚£ä¹ˆç¨‹åºè®¡æ•°å™¨è®°å½•çš„æ˜¯ undefined åœ°å€ï¼Œåªæœ‰æ‰§è¡Œçš„æ˜¯ Java ä»£ç æ—¶ç¨‹åºè®¡æ•°å™¨è®°å½•çš„æ‰æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚\næ‰€ä»¥ï¼Œç¨‹åºè®¡æ•°å™¨ç§æœ‰ä¸»è¦æ˜¯ä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ã€‚\n1.2. è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆä¸ºä»€ä¹ˆæ˜¯ç§æœ‰çš„?  è™šæ‹Ÿæœºæ ˆï¼š æ¯ä¸ª Java æ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å¸¸é‡æ± å¼•ç”¨ç­‰ä¿¡æ¯ã€‚ä»æ–¹æ³•è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨ Java è™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆå’Œå‡ºæ ˆçš„è¿‡ç¨‹ã€‚ æœ¬åœ°æ–¹æ³•æ ˆï¼š å’Œè™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«æ˜¯ï¼š è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡Œ Java æ–¹æ³• ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„ Native æ–¹æ³•æœåŠ¡ã€‚ åœ¨ HotSpot è™šæ‹Ÿæœºä¸­å’Œ Java è™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚  æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯çº¿ç¨‹ä¸­çš„å±€éƒ¨å˜é‡ä¸è¢«åˆ«çš„çº¿ç¨‹è®¿é—®åˆ°ï¼Œè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚\n1.3. ä¸€å¥è¯ç®€å•äº†è§£å †å’Œæ–¹æ³•åŒº å †å’Œæ–¹æ³•åŒºæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„èµ„æºï¼Œå…¶ä¸­å †æ˜¯è¿›ç¨‹ä¸­æœ€å¤§çš„ä¸€å—å†…å­˜ï¼Œä¸»è¦ç”¨äºå­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡ (å‡ ä¹æ‰€æœ‰å¯¹è±¡éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜)ï¼Œæ–¹æ³•åŒºä¸»è¦ç”¨äºå­˜æ”¾å·²è¢«åŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚\n2. è¯´è¯´å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«?  å¹¶å‘ï¼š åŒä¸€æ—¶é—´æ®µï¼Œå¤šä¸ªä»»åŠ¡éƒ½åœ¨æ‰§è¡Œ (å•ä½æ—¶é—´å†…ä¸ä¸€å®šåŒæ—¶æ‰§è¡Œ)ï¼› å¹¶è¡Œï¼š å•ä½æ—¶é—´å†…ï¼Œå¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œã€‚  3. è¯´è¯´çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ  å‚è€ƒæ–‡ç« ï¼šJava å¤šçº¿ç¨‹ - çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ\n 4. ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢? å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€èˆ¬çº¿ç¨‹çš„ä¸ªæ•°éƒ½å¤§äº CPU æ ¸å¿ƒçš„ä¸ªæ•°ï¼Œè€Œä¸€ä¸ª CPU æ ¸å¿ƒåœ¨ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¸ºäº†è®©è¿™äº›çº¿ç¨‹éƒ½èƒ½å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œï¼ŒCPU é‡‡å–çš„ç­–ç•¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡å¹¶è½®è½¬çš„å½¢å¼ã€‚å½“ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œçš„æ—¶å€™å°±ä¼šé‡æ–°å¤„äºå°±ç»ªçŠ¶æ€è®©ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å±äºä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\næ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚ä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\nä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒéœ€è¦ç›¸å½“å¯è§‚çš„å¤„ç†å™¨æ—¶é—´ï¼Œåœ¨æ¯ç§’å‡ åä¸Šç™¾æ¬¡çš„åˆ‡æ¢ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦çº³ç§’é‡çº§çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´æ„å‘³ç€æ¶ˆè€—å¤§é‡çš„ CPU æ—¶é—´ï¼Œäº‹å®ä¸Šï¼Œå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿä¸­æ—¶é—´æ¶ˆè€—æœ€å¤§çš„æ“ä½œã€‚\nLinux ç›¸æ¯”ä¸å…¶ä»–æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶ä»–ç±» Unix ç³»ç»Ÿï¼‰æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹å°±æ˜¯ï¼Œå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—éå¸¸å°‘ã€‚\n5. ä»€ä¹ˆæ˜¯çº¿ç¨‹æ­»é”ï¼Ÿå¦‚ä½•é¿å…æ­»é”ï¼Ÿ  å‚è€ƒæ–‡ç« ï¼šhttps://chenxq.xyz/post/java-multithread-dead-lock/\n 6. è¯´è¯´ sleep() æ–¹æ³•å’Œ wait() æ–¹æ³•åŒºåˆ«å’Œå…±åŒç‚¹? å…±åŒç‚¹ï¼š\n wait å’Œ sleep æ–¹æ³•éƒ½å¯ä»¥ä½¿çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ wait å’Œ sleep æ–¹æ³•å‡æ˜¯å¯ä¸­æ–­æ–¹æ³•ï¼Œè¢«ä¸­æ–­åéƒ½ä¼šæ”¶åˆ°ä¸­æ–­å¼‚å¸¸ã€‚  åŒºåˆ«ï¼š\n waitæ˜¯Objectçš„æ–¹æ³•ï¼Œè€Œsleepæ˜¯Threadç‰¹æœ‰çš„æ–¹æ³•ã€‚   sleep æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼Œè€Œ wait æ–¹æ³•é‡Šæ”¾äº†é” ã€‚ waitæ–¹æ³•çš„æ‰§è¡Œå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•ä¸­è¿›è¡Œï¼Œè€Œsleepåˆ™ä¸éœ€è¦ã€‚ sleepæ–¹æ³•çŸ­æš‚ä¼‘çœ ä¹‹åä¼šä¸»åŠ¨é€€å‡ºé˜»å¡ï¼Œè€Œwaitæ–¹æ³•ï¼ˆæ²¡æœ‰æŒ‡å®šwaitæ—¶é—´ï¼‰åˆ™éœ€è¦è¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­åæ‰èƒ½é€€å‡ºé˜»å¡ã€‚  7. ä¸ºä»€ä¹ˆæˆ‘ä»¬è°ƒç”¨ start() æ–¹æ³•æ—¶ä¼šæ‰§è¡Œ run() æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨ run() æ–¹æ³•ï¼Ÿ è¿™æ˜¯å¦ä¸€ä¸ªéå¸¸ç»å…¸çš„ java å¤šçº¿ç¨‹é¢è¯•é—®é¢˜ï¼Œè€Œä¸”åœ¨é¢è¯•ä¸­ä¼šç»å¸¸è¢«é—®åˆ°ã€‚å¾ˆç®€å•ï¼Œä½†æ˜¯å¾ˆå¤šäººéƒ½ä¼šç­”ä¸ä¸Šæ¥ï¼\nnew ä¸€ä¸ª Threadï¼Œçº¿ç¨‹è¿›å…¥äº†æ–°å»ºçŠ¶æ€;è°ƒç”¨ start() æ–¹æ³•ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥äº†å°±ç»ªçŠ¶æ€ï¼Œå½“åˆ†é…åˆ°æ—¶é—´ç‰‡åå°±å¯ä»¥å¼€å§‹è¿è¡Œäº†ã€‚ start() ä¼šæ‰§è¡Œçº¿ç¨‹çš„ç›¸åº”å‡†å¤‡å·¥ä½œï¼Œç„¶åè‡ªåŠ¨æ‰§è¡Œ run() æ–¹æ³•çš„å†…å®¹ï¼Œè¿™æ˜¯çœŸæ­£çš„å¤šçº¿ç¨‹å·¥ä½œã€‚ è€Œç›´æ¥æ‰§è¡Œ run() æ–¹æ³•ï¼Œä¼šæŠŠ run æ–¹æ³•å½“æˆä¸€ä¸ª main çº¿ç¨‹ä¸‹çš„æ™®é€šæ–¹æ³•å»æ‰§è¡Œï¼Œå¹¶ä¸ä¼šåœ¨æŸä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå®ƒï¼Œæ‰€ä»¥è¿™å¹¶ä¸æ˜¯å¤šçº¿ç¨‹å·¥ä½œã€‚\næ€»ç»“ï¼š è°ƒç”¨ start æ–¹æ³•æ–¹å¯å¯åŠ¨çº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œè€Œ run æ–¹æ³•åªæ˜¯ thread çš„ä¸€ä¸ªæ™®é€šæ–¹æ³•è°ƒç”¨ï¼Œè¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹é‡Œæ‰§è¡Œã€‚\n","date":"2020å¹´11æœˆ11æ—¥","permalink":"https://ahamoment.cn/posts/java/java-multithread-interview-questions/","summary":"","title":"Java å¤šçº¿ç¨‹é¢è¯•é¢˜æ€»ç»“"},{"contents":"synchronizedå…³é”®å­—æä¾›äº†ä¸€ç§äº’æ–¥æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥èµ„æºï¼Œå¾ˆå¤šèµ„æ–™ã€ä¹¦ç±å°†synchronizedï¼ˆmutexï¼‰ç§°ä¸ºé”ï¼Œå…¶å®è¿™ç§è¯´æ³•æ˜¯ä¸ä¸¥è°¨çš„ï¼Œå‡†ç¡®åœ°è®²åº”è¯¥æ˜¯æŸçº¿ç¨‹è·å–äº†ä¸mutexå…³è”çš„monitoré”ï¼ˆå½“ç„¶å†™ç¨‹åºçš„æ—¶å€™çŸ¥é“å®ƒæƒ³è¦è¡¨è¾¾çš„è¯­ä¹‰å³å¯ï¼‰ã€‚\nä½¿ç”¨JDKå‘½ä»¤javapå¯¹Mutex classè¿›è¡Œåæ±‡ç¼–ï¼Œè¾“å‡ºäº†å¤§é‡çš„JVMæŒ‡ä»¤ï¼Œåœ¨è¿™äº›æŒ‡ä»¤ä¸­ï¼Œä½ å°†å‘ç°monitor enterå’Œmonitor exitæ˜¯æˆå¯¹å‡ºç°çš„ï¼ˆæœ‰äº›æ—¶å€™ä¼šå‡ºç°ä¸€ä¸ªmonitor enterå¤šä¸ªmonitor exitï¼Œä½†æ˜¯æ¯ä¸€ä¸ªmonitor exitä¹‹å‰å¿…æœ‰å¯¹åº”çš„monitor enterï¼Œè¿™æ˜¯è‚¯å®šçš„ï¼‰.\n Monitorenter æ¯ä¸ªå¯¹è±¡éƒ½ä¸ä¸€ä¸ªmonitorç›¸å…³è”ï¼Œä¸€ä¸ªmonitorçš„lockçš„é”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´è·å¾—ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å¾—ä¸å¯¹è±¡å…³è”monitorçš„æ‰€æœ‰æƒæ—¶ä¼šå‘ç”Ÿå¦‚ä¸‹çš„å‡ ä»¶äº‹æƒ…ã€‚  å¦‚æœmonitorçš„è®¡æ•°å™¨ä¸º0ï¼Œåˆ™æ„å‘³ç€è¯¥monitorçš„lockè¿˜æ²¡æœ‰è¢«è·å¾—ï¼ŒæŸä¸ªçº¿ç¨‹è·å¾—ä¹‹åå°†ç«‹å³å¯¹è¯¥è®¡æ•°å™¨åŠ ä¸€ï¼Œä»æ­¤è¯¥çº¿ç¨‹å°±æ˜¯è¿™ä¸ªmonitorçš„æ‰€æœ‰è€…äº†ã€‚ å¦‚æœä¸€ä¸ªå·²ç»æ‹¥æœ‰è¯¥monitoræ‰€æœ‰æƒçš„çº¿ç¨‹é‡å…¥ï¼Œåˆ™ä¼šå¯¼è‡´monitorè®¡æ•°å™¨å†æ¬¡ç´¯åŠ ã€‚ å¦‚æœmonitorå·²ç»è¢«å…¶ä»–çº¿ç¨‹æ‰€æ‹¥æœ‰ï¼Œåˆ™å…¶ä»–çº¿ç¨‹å°è¯•è·å–è¯¥monitorçš„æ‰€æœ‰æƒæ—¶ï¼Œä¼šè¢«é™·å…¥é˜»å¡çŠ¶æ€ç›´åˆ°monitorè®¡æ•°å™¨å˜ä¸º0ï¼Œæ‰èƒ½å†æ¬¡å°è¯•è·å–å¯¹monitorçš„æ‰€æœ‰æƒã€‚   Monitorexit é‡Šæ”¾å¯¹monitorçš„æ‰€æœ‰æƒï¼Œæƒ³è¦é‡Šæ”¾å¯¹æŸä¸ªå¯¹è±¡å…³è”çš„monitorçš„æ‰€æœ‰æƒçš„å‰ææ˜¯ï¼Œä½ æ›¾ç»è·å¾—äº†æ‰€æœ‰æƒã€‚é‡Šæ”¾monitoræ‰€æœ‰æƒçš„è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†monitorçš„è®¡æ•°å™¨å‡ä¸€ï¼Œå¦‚æœè®¡æ•°å™¨çš„ç»“æœä¸º0ï¼Œé‚£å°±æ„å‘³ç€è¯¥çº¿ç¨‹ä¸å†æ‹¥æœ‰å¯¹è¯¥monitorçš„æ‰€æœ‰æƒï¼Œé€šä¿—åœ°è®²å°±æ˜¯è§£é”ã€‚ä¸æ­¤åŒæ—¶è¢«è¯¥monitor blockçš„çº¿ç¨‹å°†å†æ¬¡å°è¯•è·å¾—å¯¹è¯¥monitorçš„æ‰€æœ‰æƒã€‚  ä½¿ç”¨synchronizedæ–¹æ³•éœ€è¦æ³¨æ„å‡ ä¸ªé—®é¢˜ï¼š\n ä¸monitorå…³è”çš„å¯¹è±¡ä¸èƒ½ä¸ºç©º synchronizedä½œç”¨åŸŸå¤ªå¤§ ç”±äºsynchronizedå…³é”®å­—å­˜åœ¨æ’ä»–æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„çº¿ç¨‹å¿…é¡»ä¸²è¡Œåœ°ç»è¿‡synchronizedä¿æŠ¤çš„å…±äº«åŒºåŸŸï¼Œå¦‚æœsynchronizedä½œç”¨åŸŸè¶Šå¤§ï¼Œåˆ™ä»£è¡¨ç€å…¶æ•ˆç‡è¶Šä½ï¼Œç”šè‡³è¿˜ä¼šä¸§å¤±å¹¶å‘çš„ä¼˜åŠ¿ã€‚ ä¸åŒçš„monitorä¼å›¾é”ç›¸åŒçš„æ–¹æ³• å¤šä¸ªé”çš„äº¤å‰å¯¼è‡´æ­»é”  ","date":"2020å¹´10æœˆ25æ—¥","permalink":"https://ahamoment.cn/posts/java/java-multithread-synchronized2/","summary":"synchronizedå…³é”®å­—æä¾›äº†ä¸€ç§äº’æ–¥æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥èµ„æºï¼Œå¾ˆå¤šèµ„æ–™ã€ä¹¦ç±å°†synchronizedï¼ˆmutexï¼‰ç§°ä¸ºé”ï¼Œå…¶å®è¿™ç§è¯´æ³•æ˜¯ä¸ä¸¥è°¨çš„ï¼Œå‡†ç¡®åœ°è®²åº”è¯¥æ˜¯æŸçº¿ç¨‹è·å–äº†ä¸mutexå…³è”çš„monitoré”ï¼ˆå½“ç„¶å†™ç¨‹åºçš„æ—¶å€™çŸ¥é“å®ƒæƒ³è¦è¡¨è¾¾çš„è¯­ä¹‰å³å¯ï¼‰ã€‚\nä½¿ç”¨JDKå‘½ä»¤javapå¯¹Mutex classè¿›è¡Œåæ±‡ç¼–ï¼Œè¾“å‡ºäº†å¤§é‡çš„JVMæŒ‡ä»¤ï¼Œåœ¨è¿™äº›æŒ‡ä»¤ä¸­ï¼Œä½ å°†å‘ç°monitor enterå’Œmonitor exitæ˜¯æˆå¯¹å‡ºç°çš„ï¼ˆæœ‰äº›æ—¶å€™ä¼šå‡ºç°ä¸€ä¸ªmonitor enterå¤šä¸ªmonitor exitï¼Œä½†æ˜¯æ¯ä¸€ä¸ªmonitor exitä¹‹å‰å¿…æœ‰å¯¹åº”çš„monitor enterï¼Œè¿™æ˜¯è‚¯å®šçš„ï¼‰.\n Monitorenter æ¯ä¸ªå¯¹è±¡éƒ½ä¸ä¸€ä¸ªmonitorç›¸å…³è”ï¼Œä¸€ä¸ªmonitorçš„lockçš„é”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´è·å¾—ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å¾—ä¸å¯¹è±¡å…³è”monitorçš„æ‰€æœ‰æƒæ—¶ä¼šå‘ç”Ÿå¦‚ä¸‹çš„å‡ ä»¶äº‹æƒ…ã€‚  å¦‚æœmonitorçš„è®¡æ•°å™¨ä¸º0ï¼Œåˆ™æ„å‘³ç€è¯¥monitorçš„lockè¿˜æ²¡æœ‰è¢«è·å¾—ï¼ŒæŸä¸ªçº¿ç¨‹è·å¾—ä¹‹åå°†ç«‹å³å¯¹è¯¥è®¡æ•°å™¨åŠ ä¸€ï¼Œä»æ­¤è¯¥çº¿ç¨‹å°±æ˜¯è¿™ä¸ªmonitorçš„æ‰€æœ‰è€…äº†ã€‚ å¦‚æœä¸€ä¸ªå·²ç»æ‹¥æœ‰è¯¥monitoræ‰€æœ‰æƒçš„çº¿ç¨‹é‡å…¥ï¼Œåˆ™ä¼šå¯¼è‡´monitorè®¡æ•°å™¨å†æ¬¡ç´¯åŠ ã€‚ å¦‚æœmonitorå·²ç»è¢«å…¶ä»–çº¿ç¨‹æ‰€æ‹¥æœ‰ï¼Œåˆ™å…¶ä»–çº¿ç¨‹å°è¯•è·å–è¯¥monitorçš„æ‰€æœ‰æƒæ—¶ï¼Œä¼šè¢«é™·å…¥é˜»å¡çŠ¶æ€ç›´åˆ°monitorè®¡æ•°å™¨å˜ä¸º0ï¼Œæ‰èƒ½å†æ¬¡å°è¯•è·å–å¯¹monitorçš„æ‰€æœ‰æƒã€‚   Monitorexit é‡Šæ”¾å¯¹monitorçš„æ‰€æœ‰æƒï¼Œæƒ³è¦é‡Šæ”¾å¯¹æŸä¸ªå¯¹è±¡å…³è”çš„monitorçš„æ‰€æœ‰æƒçš„å‰ææ˜¯ï¼Œä½ æ›¾ç»è·å¾—äº†æ‰€æœ‰æƒã€‚é‡Šæ”¾monitoræ‰€æœ‰æƒçš„è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†monitorçš„è®¡æ•°å™¨å‡ä¸€ï¼Œå¦‚æœè®¡æ•°å™¨çš„ç»“æœä¸º0ï¼Œé‚£å°±æ„å‘³ç€è¯¥çº¿ç¨‹ä¸å†æ‹¥æœ‰å¯¹è¯¥monitorçš„æ‰€æœ‰æƒï¼Œé€šä¿—åœ°è®²å°±æ˜¯è§£é”ã€‚ä¸æ­¤åŒæ—¶è¢«è¯¥monitor blockçš„çº¿ç¨‹å°†å†æ¬¡å°è¯•è·å¾—å¯¹è¯¥monitorçš„æ‰€æœ‰æƒã€‚  ä½¿ç”¨synchronizedæ–¹æ³•éœ€è¦æ³¨æ„å‡ ä¸ªé—®é¢˜ï¼š","title":"Java å¤šçº¿ç¨‹ - æ·±å…¥ç†è§£synchronizedå…³é”®å­—"},{"contents":"çº¿ç¨‹interruptï¼Œæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„APIï¼Œä¹Ÿæ˜¯ç»å¸¸ä½¿ç”¨çš„æ–¹æ³•ï¼Œåœ¨æœ¬æ–‡ä¸­æˆ‘ä»¬å°†Threadæ·±å…¥æºç å¯¹å…¶è¿›è¡Œè¯¦ç»†çš„å‰–æã€‚\né¦–å…ˆæ¥çœ‹ä¸€ä¸‹ä¸çº¿ç¨‹ä¸­æ–­ç›¸å…³çš„å‡ ä¸ªAPIï¼š\npublic void interrupt() public static boolean interrupted() public boolean isInterrupted()  interrupt å¦‚ä¸‹æ–¹æ³•çš„è°ƒç”¨ä¼šä½¿å¾—å½“å‰çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œè°ƒç”¨å½“å‰çº¿ç¨‹çš„interruptæ–¹æ³•ï¼Œå°±å¯ä»¥æ‰“æ–­é˜»å¡ã€‚\n Objectçš„waitæ–¹æ³•ã€‚ Objectçš„waitï¼ˆlongï¼‰æ–¹æ³•ã€‚ Objectçš„waitï¼ˆlongï¼Œintï¼‰æ–¹æ³•ã€‚ Threadçš„sleepï¼ˆlongï¼‰æ–¹æ³•ã€‚ Threadçš„sleepï¼ˆlongï¼Œintï¼‰æ–¹æ³•ã€‚ Threadçš„joinæ–¹æ³•ã€‚ Threadçš„joinï¼ˆlongï¼‰æ–¹æ³•ã€‚ Threadçš„joinï¼ˆlongï¼Œintï¼‰æ–¹æ³•ã€‚ InterruptibleChannelçš„ioæ“ä½œã€‚ Selectorçš„wakeupæ–¹æ³•ã€‚  ä¸Šè¿°è‹¥å¹²æ–¹æ³•éƒ½ä¼šä½¿å¾—å½“å‰çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè‹¥å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¢«é˜»å¡çº¿ç¨‹çš„interruptæ–¹æ³•ï¼Œåˆ™ä¼šæ‰“æ–­è¿™ç§é˜»å¡ï¼Œå› æ­¤è¿™ç§æ–¹æ³•æœ‰æ—¶ä¼šè¢«ç§°ä¸ºå¯ä¸­æ–­æ–¹æ³•ï¼Œè®°ä½ï¼Œæ‰“æ–­ä¸€ä¸ªçº¿ç¨‹å¹¶ä¸ç­‰äºè¯¥çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œä»…ä»…æ˜¯æ‰“æ–­äº†å½“å‰çº¿ç¨‹çš„é˜»å¡çŠ¶æ€ã€‚\nä¸€æ—¦çº¿ç¨‹åœ¨é˜»å¡çš„æƒ…å†µä¸‹è¢«æ‰“æ–­ï¼Œéƒ½ä¼šæŠ›å‡ºä¸€ä¸ªç§°ä¸ºInterruptedExceptionçš„å¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸å°±åƒä¸€ä¸ªsignalï¼ˆä¿¡å·ï¼‰ä¸€æ ·é€šçŸ¥å½“å‰çº¿ç¨‹è¢«æ‰“æ–­äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š\nimport java.util.concurrent.TimeUnit; public class ThreadInterrupt { public static void main(String[] args) throws InterruptedException { Thread thread = new Thread(() -\u0026gt; { try { TimeUnit.MINUTES.sleep(1); } catch( InterruptedException e) { System.out.println(\u0026quot;Oh, i am be interrupted.\u0026quot;); } }); thread.start(); //short block and make sure thread is started. TimeUnit.MILLISECONDS.sleep(2); thread.interrupt(); } }  ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”ä¼å›¾ä¼‘çœ 1åˆ†é’Ÿçš„æ—¶é•¿ï¼Œä¸è¿‡å¾ˆå¯æƒœï¼Œå¤§çº¦åœ¨2æ¯«ç§’ä¹‹åå°±è¢«ä¸»çº¿ç¨‹è°ƒç”¨interruptæ–¹æ³•æ‰“æ–­ï¼Œç¨‹åºçš„æ‰§è¡Œç»“æœå°±æ˜¯â€œOhï¼Œi am be interrupted.â€\ninterruptè¿™ä¸ªæ–¹æ³•åˆ°åº•åšäº†ä»€ä¹ˆæ ·çš„äº‹æƒ…å‘¢ï¼Ÿåœ¨ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨å­˜åœ¨ç€åä¸ºinterrupt flagçš„æ ‡è¯†ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è¢«interruptï¼Œé‚£ä¹ˆå®ƒçš„flagå°†è¢«è®¾ç½®ï¼Œä½†æ˜¯å¦‚æœå½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œå¯ä¸­æ–­æ–¹æ³•è¢«é˜»å¡æ—¶ï¼Œè°ƒç”¨interruptæ–¹æ³•å°†å…¶ä¸­æ–­ï¼Œåè€Œä¼šå¯¼è‡´flagè¢«æ¸…é™¤ï¼Œå…³äºè¿™ç‚¹æˆ‘ä»¬åœ¨åé¢è¿˜ä¼šåšè¯¦ç»†çš„ä»‹ç»ã€‚å¦å¤–æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»æ˜¯æ­»äº¡çŠ¶æ€ï¼Œé‚£ä¹ˆå°è¯•å¯¹å…¶çš„interruptä¼šç›´æ¥è¢«å¿½ç•¥ã€‚\nisInterrupted isInterruptedæ˜¯Threadçš„ä¸€ä¸ªæˆå‘˜æ–¹æ³•ï¼Œå®ƒä¸»è¦åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œè¯¥æ–¹æ³•ä»…ä»…æ˜¯å¯¹interruptæ ‡è¯†çš„ä¸€ä¸ªåˆ¤æ–­ï¼Œå¹¶ä¸ä¼šå½±å“æ ‡è¯†å‘ç”Ÿä»»ä½•æ”¹å˜ï¼Œè¿™ä¸ªä¸æˆ‘ä»¬å³å°†å­¦ä¹ åˆ°çš„interruptedæ˜¯å­˜åœ¨å·®åˆ«çš„ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ç¨‹åºï¼š\npublic class ThreadisInterrupted { public static void main(String[] args) throws InterruptedException { Thread thread = new Thread() { @Override public void run() { while (true) { //do nothing, just empty loop. } } }; thread.start(); TimeUnit.MILLISECONDS.sleep(2); System.out.printf(\u0026quot;Thread is interrupted ? ï¼…s\\n\u0026quot;, thread.isInterrupted()); thread.interrupt(); System.out.printf(\u0026quot;Thread is interrupted ? ï¼…s\\n\u0026quot;, thread.isInterrupted()); } }  ä¸Šé¢çš„ä»£ç ä¸­å®šä¹‰äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”åœ¨çº¿ç¨‹çš„æ‰§è¡Œå•å…ƒä¸­ï¼ˆrunæ–¹æ³•ï¼‰å†™äº†ä¸€ä¸ªç©ºçš„æ­»å¾ªç¯ï¼Œä¸ºä»€ä¹ˆä¸å†™sleepå‘¢ï¼Ÿå› ä¸ºsleepæ˜¯å¯ä¸­æ–­æ–¹æ³•ï¼Œä¼šæ•è·åˆ°ä¸­æ–­ä¿¡å·ï¼Œä»è€Œå¹²æ‰°æˆ‘ä»¬ç¨‹åºçš„ç»“æœã€‚ä¸‹é¢æ˜¯ç¨‹åºè¿è¡Œçš„ç»“æœï¼Œè®°å¾—æ‰‹åŠ¨ç»“æŸä¸Šé¢çš„ç¨‹åºè¿è¡Œï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥å°†ä¸Šé¢å®šä¹‰çš„çº¿ç¨‹æŒ‡å®šä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œè¿™æ ·å°±ä¼šéšç€ä¸»çº¿ç¨‹çš„ç»“æŸå¯¼è‡´JVMä¸­æ²¡æœ‰éå®ˆæŠ¤çº¿ç¨‹è€Œè‡ªåŠ¨é€€å‡ºã€‚\nThread is interrupted ? false Thread is interrupted ? true  å¯ä¸­æ–­æ–¹æ³•æ•è·åˆ°äº†ä¸­æ–­ä¿¡å·ï¼ˆsignalï¼‰ä¹‹åï¼Œä¹Ÿå°±æ˜¯æ•è·äº†InterruptedExceptionå¼‚å¸¸ä¹‹åä¼šæ“¦é™¤æ‰interruptçš„æ ‡è¯†ï¼Œå¯¹ä¸Šé¢çš„ç¨‹åºç¨ä½œä¿®æ”¹ï¼Œä½ ä¼šå‘ç°ç¨‹åºçš„ç»“æœåˆä¼šå‡ºç°å¾ˆå¤§çš„ä¸åŒï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\npublic class ThreadisInterrupted { public static void main(String[] args) throws InterruptedException { Thread thread = new Thread() { @Override public void run() { while (true) { try { TimeUnit.MINUTES.sleep(1); } catch (InterruptedException e) { //ignore the exception //here the interrupt flag will be clear. //ç”±äºå¯ä¸­æ–­æ–¹æ³•çš„å¼‚å¸¸è¢«æ•è·åï¼Œä¼šæ“¦é™¤æ‰interrupæ ‡è®°ï¼Œæ‰€ä»¥è°ƒç”¨ //isInterruptedè¿”å›false System.out.printf(\u0026quot;I am be interrupted ? ï¼…s\u0026quot;, isInterrupted()); } } } }; thread.start(); TimeUnit.MILLISECONDS.sleep(2); System.out.printf(\u0026quot;Thread is interrupted ? ï¼…s\\n\u0026quot;, thread.isInterrupted()); thread.interrupt(); System.out.printf(\u0026quot;Thread is interrupted ? ï¼…s\\n\u0026quot;, thread.isInterrupted()); } }  ç”±äºåœ¨runæ–¹æ³•ä¸­ä½¿ç”¨äº†sleepè¿™ä¸ªå¯ä¸­æ–­æ–¹æ³•ï¼Œå®ƒä¼šæ•è·åˆ°ä¸­æ–­ä¿¡å·ï¼Œå¹¶ä¸”ä¼šæ“¦é™¤interruptæ ‡è¯†ï¼Œå› æ­¤ç¨‹åºçš„æ‰§è¡Œç»“æœéƒ½ä¼šæ˜¯falseï¼Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š\nThread is interrupted ? false I am be interrupted ? false Thread is interrupted ? false  å…¶å®è¿™ä¹Ÿä¸éš¾ç†è§£ï¼Œå¯ä¸­æ–­æ–¹æ³•æ•è·åˆ°äº†ä¸­æ–­ä¿¡å·ä¹‹åï¼Œä¸ºäº†ä¸å½±å“çº¿ç¨‹ä¸­å…¶ä»–æ–¹æ³•çš„æ‰§è¡Œï¼Œå°†çº¿ç¨‹çš„interruptæ ‡è¯†å¤ä½æ˜¯ä¸€ç§å¾ˆåˆç†çš„è®¾è®¡ã€‚\ninterrupted interruptedæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œè™½ç„¶å…¶ä¹Ÿç”¨äºåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œä½†æ˜¯å®ƒå’Œæˆå‘˜æ–¹æ³•isInterruptedè¿˜æ˜¯æœ‰å¾ˆå¤§çš„åŒºåˆ«çš„ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¼šç›´æ¥æ“¦é™¤æ‰çº¿ç¨‹çš„interruptæ ‡è¯†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«æ‰“æ–­äº†ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡è°ƒç”¨interruptedæ–¹æ³•ä¼šè¿”å›trueï¼Œå¹¶ä¸”ç«‹å³æ“¦é™¤äº†interruptæ ‡è¯†ï¼›ç¬¬äºŒæ¬¡åŒ…æ‹¬ä»¥åçš„è°ƒç”¨æ°¸è¿œéƒ½ä¼šè¿”å›falseï¼Œé™¤éåœ¨æ­¤æœŸé—´çº¿ç¨‹åˆä¸€æ¬¡åœ°è¢«æ‰“æ–­ï¼Œä¸‹é¢è®¾è®¡äº†ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¥éªŒè¯æˆ‘ä»¬çš„è¯´æ³•ï¼š\npublic class ThreadisInterrupted { public static void main(String[] args) throws InterruptedException { Thread thread = new Thread() { @Override public void run() { while (true) { System.out.println(Thread.interrupted()); } } }; thread.setDaemon(true); thread.start(); //shortly block make sure the thread is started. TimeUnit.MILLISECONDS.sleep(2); thread.interrupt(); } }  åŒæ ·ç”±äºä¸æƒ³è¦å—åˆ°å¯ä¸­æ–­æ–¹æ³•å¦‚sleepçš„å½±å“ï¼Œåœ¨Threadçš„runæ–¹æ³•ä¸­æ²¡æœ‰è¿›è¡Œä»»ä½•çŸ­æš‚çš„ä¼‘çœ ï¼Œæ‰€ä»¥è¿è¡Œä¸Šé¢çš„ç¨‹åºä¼šå‡ºç°éå¸¸å¤šçš„è¾“å‡ºï¼Œä½†æ˜¯æˆ‘ä»¬é€šè¿‡å¯¹è¾“å‡ºçš„æ£€æŸ¥ä¼šå‘ç°å¦‚ä¸‹æ‰€ç¤ºçš„å†…å®¹ï¼Œå…¶è¶³ä»¥ä½œä¸ºå¯¹è¯¥æ–¹æ³•çš„è§£é‡Šã€‚\nâ€¦â€¦ false false true false false â€¦â€¦  åœ¨å¾ˆå¤šçš„falseåŒ…å›´ä¸­å‘ç°äº†ä¸€ä¸ªtrueï¼Œä¹Ÿå°±æ˜¯interruptedæ–¹æ³•åˆ¤æ–­åˆ°äº†å…¶è¢«ä¸­æ–­ï¼Œç«‹å³æ“¦é™¤äº†ä¸­æ–­æ ‡è¯†ï¼Œå¹¶ä¸”åªæœ‰è¿™ä¸€æ¬¡è¿”å›trueï¼Œåé¢çš„éƒ½å°†ä¼šæ˜¯falseã€‚\ninterrupt æ³¨æ„äº‹é¡¹ æ‰“å¼€Threadçš„æºç ï¼Œä¸éš¾å‘ç°ï¼ŒisInterruptedæ–¹æ³•å’Œinterruptedæ–¹æ³•éƒ½è°ƒç”¨äº†åŒä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼š\nprivate native boolean isInterrupted(boolean ClearInterrupted);  å…¶ä¸­å‚æ•°ClearInterruptedä¸»è¦ç”¨æ¥æ§åˆ¶æ˜¯å¦æ“¦é™¤çº¿ç¨‹interruptçš„æ ‡è¯†ã€‚isInterruptedæ–¹æ³•çš„æºç ä¸­è¯¥å‚æ•°ä¸ºfalseï¼Œè¡¨ç¤ºä¸æƒ³æ“¦é™¤ï¼š\npublic boolean isInterrupted() { return isInterrupted(false); }  è€Œinterruptedé™æ€æ–¹æ³•ä¸­è¯¥å‚æ•°åˆ™ä¸ºtrueï¼Œè¡¨ç¤ºæƒ³è¦æ“¦é™¤ï¼š\npublic static boolean interrupted() { return currentThread().isInterrupted(true); }  åœ¨æ¯”è¾ƒè¯¦ç»†åœ°å­¦ä¹ äº†interruptæ–¹æ³•ä¹‹åï¼Œå¤§å®¶æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æ²¡æœ‰æ‰§è¡Œå¯ä¸­æ–­æ–¹æ³•ä¹‹å‰å°±è¢«æ‰“æ–­ï¼Œé‚£ä¹ˆå…¶æ¥ä¸‹æ¥å°†æ‰§è¡Œå¯ä¸­æ–­æ–¹æ³•ï¼Œæ¯”å¦‚sleepä¼šå‘ç”Ÿä»€ä¹ˆæ ·çš„æƒ…å†µå‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„å®éªŒæ¥å›ç­”è¿™ä¸ªç–‘é—®ï¼š\npublic class ThreadisInterrupted { public static void main(String[] args) { //â‘  åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ // flag=false,æ¸…é™¤çº¿ç¨‹ä¸­æ–­æ ‡å¿— System.out.println(\u0026quot;Main thread is interrupted? \u0026quot; + Thread.interrupted()); //â‘¡ä¸­æ–­å½“å‰çº¿ç¨‹ // flag=true Thread.currentThread().interrupt(); //â‘¢åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»è¢«ä¸­æ–­ // è¿™é‡Œä¸èƒ½å†è°ƒç”¨Thread.interrupted()ï¼Œå› ä¸ºä¼šå°†flagæ¸…é™¤ï¼Œè¾¾ä¸åˆ°å®éªŒæ•ˆæœ System.out.println(\u0026quot;Main thread is interrupted? \u0026quot; + Thread.currentThread().isInterrupted()); try { //â‘£ å½“å‰çº¿ç¨‹æ‰§è¡Œå¯ä¸­æ–­æ–¹æ³• TimeUnit.MINUTES.sleep(1); } catch (InterruptedException e) { //â‘¤æ•è·ä¸­æ–­ä¿¡å· System.out.println(\u0026quot;I will be interrupted still.\u0026quot;); } } }  é€šè¿‡è¿è¡Œä¸Šé¢çš„ç¨‹åºï¼Œä½ ä¼šå‘ç°ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è®¾ç½®äº†interruptæ ‡è¯†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„å¯ä¸­æ–­æ–¹æ³•ä¼šç«‹å³ä¸­æ–­ï¼Œå› æ­¤æ³¨é‡Šâ‘¤çš„ä¿¡å·æ•è·éƒ¨åˆ†ä»£ç ä¼šè¢«æ‰§è¡Œ.\nå‚è€ƒ ã€1ã€‘ã€ŠJava é«˜å¹¶å‘ç¼–ç¨‹è¯¦è§£ã€‹-æ±ªæ–‡å›\n","date":"2020å¹´10æœˆ24æ—¥","permalink":"https://ahamoment.cn/posts/java/java-multithread-interrupt/","summary":"\u003cp\u003eçº¿ç¨‹interruptï¼Œæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„APIï¼Œä¹Ÿæ˜¯ç»å¸¸ä½¿ç”¨çš„æ–¹æ³•ï¼Œåœ¨æœ¬æ–‡ä¸­æˆ‘ä»¬å°†Threadæ·±å…¥æºç å¯¹å…¶è¿›è¡Œè¯¦ç»†çš„å‰–æã€‚\u003c/p\u003e","title":"Java å¤šçº¿ç¨‹ - çº¿ç¨‹ä¸­æ–­ Interrupt"},{"contents":" http://www.oracle.com/technetwork/java/javase/memorymanagement-whitepaper-150215.pdf\n JVMåœ¨æ‰§è¡ŒJavaç¨‹åºçš„æ—¶å€™ä¼šæŠŠå¯¹åº”çš„ç‰©ç†å†…å­˜åˆ’åˆ†æˆä¸åŒçš„å†…å­˜åŒºåŸŸï¼Œæ¯ä¸€ä¸ªåŒºåŸŸéƒ½å­˜æ”¾ç€ä¸åŒçš„æ•°æ®ï¼Œä¹Ÿæœ‰ä¸åŒçš„åˆ›å»ºä¸é”€æ¯æ—¶æœºï¼Œæœ‰äº›åˆ†åŒºä¼šåœ¨JVMå¯åŠ¨çš„æ—¶å€™å°±åˆ›å»ºï¼Œæœ‰äº›åˆ™æ˜¯åœ¨è¿è¡Œæ—¶æ‰åˆ›å»ºï¼Œæ¯”å¦‚è™šæ‹Ÿæœºæ ˆï¼Œæ ¹æ®è™šæ‹Ÿæœºè§„èŒƒï¼ŒJVMçš„å†…å­˜ç»“æ„å¦‚å›¾æ‰€ç¤ºã€‚\nç¨‹åºè®¡æ•°å™¨ æ— è®ºä»»ä½•è¯­è¨€ï¼Œå…¶å®æœ€ç»ˆéƒ½æ˜¯éœ€è¦ç”±æ“ä½œç³»ç»Ÿé€šè¿‡æ§åˆ¶æ€»çº¿å‘CPUå‘é€æœºå™¨æŒ‡ä»¤ï¼ŒJavaä¹Ÿä¸ä¾‹å¤–ï¼Œç¨‹åºè®¡æ•°å™¨åœ¨JVMä¸­æ‰€èµ·çš„ä½œç”¨å°±æ˜¯ç”¨äºå­˜æ”¾å½“å‰çº¿ç¨‹æ¥ä¸‹æ¥å°†è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€åˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ç­‰ä¿¡æ¯ã€‚åœ¨ä»»ä½•æ—¶å€™ï¼Œä¸€ä¸ªå¤„ç†å™¨åªæ‰§è¡Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æŒ‡ä»¤ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨CPUæ—¶é—´ç‰‡è½®è½¬åˆ‡æ¢ä¸Šä¸‹æ–‡ä¹‹åé¡ºåˆ©å›åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦å…·æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´äº’ç›¸ä¸å½±å“ï¼Œå› æ­¤JVMå°†æ­¤å—å†…å­˜åŒºåŸŸè®¾è®¡æˆäº†çº¿ç¨‹ç§æœ‰çš„ã€‚\nJava è™šæ‹Ÿæœºæ ˆ ä¸ç¨‹åºè®¡æ•°å™¨å†…å­˜ç›¸ç±»ä¼¼ï¼ŒJavaè™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒï¼Œæ˜¯åœ¨JVMè¿è¡Œæ—¶æ‰€åˆ›å»ºçš„ï¼Œåœ¨çº¿ç¨‹ä¸­ï¼Œæ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªåä¸ºæ ˆå¸§ï¼ˆstack frameï¼‰çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦ç”¨äºå­˜æ”¾å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œæ–¹æ³•çš„è°ƒç”¨å¯¹åº”ç€æ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­çš„å‹æ ˆå’Œå¼¹æ ˆè¿‡ç¨‹ã€‚\næ¯ä¸€ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºçš„æ—¶å€™ï¼ŒJVMéƒ½ä¼šä¸ºå…¶åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œè™šæ‹Ÿæœºæ ˆçš„å¤§å°å¯ä»¥é€šè¿‡-xssæ¥é…ç½®ï¼Œæ–¹æ³•çš„è°ƒç”¨æ˜¯æ ˆå¸§è¢«å‹å…¥å’Œå¼¹å‡ºçš„è¿‡ç¨‹ï¼Œé€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒåŒç­‰çš„è™šæ‹Ÿæœºæ ˆå¦‚æœå±€éƒ¨å˜é‡è¡¨ç­‰å ç”¨å†…å­˜è¶Šå°åˆ™å¯è¢«å‹å…¥çš„æ ˆå¸§å°±ä¼šè¶Šå¤šï¼Œåä¹‹åˆ™å¯è¢«å‹å…¥çš„æ ˆå¸§å°±ä¼šè¶Šå°‘ï¼Œä¸€èˆ¬å°†æ ˆå¸§å†…å­˜çš„å¤§å°ç§°ä¸ºå®½åº¦ï¼Œè€Œæ ˆå¸§çš„æ•°é‡åˆ™ç§°ä¸ºè™šæ‹Ÿæœºæ ˆçš„æ·±åº¦ã€‚\næœ¬åœ°æ–¹æ³•æ ˆ Javaä¸­æä¾›äº†è°ƒç”¨æœ¬åœ°æ–¹æ³•çš„æ¥å£ï¼ˆJava Native Interfaceï¼‰ï¼Œä¹Ÿå°±æ˜¯C/C++ç¨‹åºï¼Œåœ¨çº¿ç¨‹çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°è°ƒç”¨JNIæ–¹æ³•çš„æƒ…å†µï¼Œæ¯”å¦‚ç½‘ç»œé€šä¿¡ã€æ–‡ä»¶æ“ä½œçš„åº•å±‚ï¼Œç”šè‡³æ˜¯Stringçš„internç­‰éƒ½æ˜¯JNIæ–¹æ³•ï¼ŒJVMä¸ºæœ¬åœ°æ–¹æ³•æ‰€åˆ’åˆ†çš„å†…å­˜åŒºåŸŸä¾¿æ˜¯æœ¬åœ°æ–¹æ³•æ ˆï¼Œè¿™å—å†…å­˜åŒºåŸŸå…¶è‡ªç”±åº¦éå¸¸é«˜ï¼Œå®Œå…¨é ä¸åŒçš„JVMå‚å•†æ¥å®ç°ï¼ŒJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æœªç»™å‡ºå¼ºåˆ¶çš„è§„å®šï¼ŒåŒæ ·å®ƒä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„å†…å­˜åŒºåŸŸã€‚\nå †å†…å­˜ å †å†…å­˜æ˜¯JVMä¸­æœ€å¤§çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œè¢«æ‰€æœ‰çš„çº¿ç¨‹æ‰€å…±äº«ï¼ŒJavaåœ¨è¿è¡ŒæœŸé—´åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡å‡ ä¹éƒ½å­˜æ”¾åœ¨è¯¥å†…å­˜åŒºåŸŸï¼Œè¯¥å†…å­˜åŒºåŸŸä¹Ÿæ˜¯åƒåœ¾å›æ”¶å™¨é‡ç‚¹ç…§é¡¾çš„åŒºåŸŸï¼Œå› æ­¤æœ‰äº›æ—¶å€™å †å†…å­˜è¢«ç§°ä¸ºâ€œGCå †â€ã€‚\nå †å†…å­˜ä¸€èˆ¬ä¼šè¢«ç»†åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œæ›´ç»†è‡´çš„åˆ’åˆ†ä¸ºEdenåŒºã€From SurvivoråŒºå’ŒTo SurvivoråŒºï¼Œå¦‚å›¾æ‰€ç¤ºã€‚\nå †å†…å­˜ä¸€èˆ¬ä¼šè¢«ç»†åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œæ›´ç»†è‡´çš„åˆ’åˆ†ä¸ºEdenåŒºã€From SurvivoråŒºå’ŒTo SurvivoråŒºã€‚\næ–¹æ³•åŒº æ–¹æ³•åŒºä¹Ÿæ˜¯è¢«å¤šä¸ªçº¿ç¨‹æ‰€å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œä»–ä¸»è¦ç”¨äºå­˜å‚¨å·²ç»è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ï¼Œè™½ç„¶åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­ï¼Œå°†å †å†…å­˜åˆ’åˆ†ä¸ºå †å†…å­˜çš„ä¸€ä¸ªé€»è¾‘åˆ†åŒºï¼Œä½†æ˜¯å®ƒè¿˜æ˜¯ç»å¸¸è¢«ç§°ä¸ºâ€œéå †â€ï¼Œæœ‰æ—¶å€™ä¹Ÿè¢«ç§°ä¸ºâ€œæŒä¹…ä»£â€ï¼Œä¸»è¦æ˜¯ç«™åœ¨åƒåœ¾å›æ”¶å™¨çš„è§’åº¦è¿›è¡Œåˆ’åˆ†ï¼Œä½†æ˜¯è¿™ç§å«æ³•æ¯”è¾ƒæ¬ å¦¥ï¼Œåœ¨HotSpot JVMä¸­ï¼Œæ–¹æ³•åŒºè¿˜ä¼šè¢«ç»†åˆ’åˆ†ä¸ºæŒä¹…ä»£å’Œä»£ç ç¼“å­˜åŒºï¼Œä»£ç ç¼“å­˜åŒºä¸»è¦ç”¨äºå­˜å‚¨ç¼–è¯‘åçš„æœ¬åœ°ä»£ç ï¼ˆå’Œç¡¬ä»¶ç›¸å…³ï¼‰ä»¥åŠJITï¼ˆJust In Timeï¼‰ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ï¼Œå½“ç„¶ä¸åŒçš„JVMä¼šæœ‰ä¸åŒçš„å®ç°ã€‚\n","date":"2020å¹´10æœˆ15æ—¥","permalink":"https://ahamoment.cn/posts/java/java-jvm-jmm/","summary":"http://www.oracle.com/technetwork/java/javase/memorymanagement-whitepaper-150215.pdf\n JVMåœ¨æ‰§è¡ŒJavaç¨‹åºçš„æ—¶å€™ä¼šæŠŠå¯¹åº”çš„ç‰©ç†å†…å­˜åˆ’åˆ†æˆä¸åŒçš„å†…å­˜åŒºåŸŸï¼Œæ¯ä¸€ä¸ªåŒºåŸŸéƒ½å­˜æ”¾ç€ä¸åŒçš„æ•°æ®ï¼Œä¹Ÿæœ‰ä¸åŒçš„åˆ›å»ºä¸é”€æ¯æ—¶æœºï¼Œæœ‰äº›åˆ†åŒºä¼šåœ¨JVMå¯åŠ¨çš„æ—¶å€™å°±åˆ›å»ºï¼Œæœ‰äº›åˆ™æ˜¯åœ¨è¿è¡Œæ—¶æ‰åˆ›å»ºï¼Œæ¯”å¦‚è™šæ‹Ÿæœºæ ˆï¼Œæ ¹æ®è™šæ‹Ÿæœºè§„èŒƒï¼ŒJVMçš„å†…å­˜ç»“æ„å¦‚å›¾æ‰€ç¤ºã€‚\nç¨‹åºè®¡æ•°å™¨ æ— è®ºä»»ä½•è¯­è¨€ï¼Œå…¶å®æœ€ç»ˆéƒ½æ˜¯éœ€è¦ç”±æ“ä½œç³»ç»Ÿé€šè¿‡æ§åˆ¶æ€»çº¿å‘CPUå‘é€æœºå™¨æŒ‡ä»¤ï¼ŒJavaä¹Ÿä¸ä¾‹å¤–ï¼Œç¨‹åºè®¡æ•°å™¨åœ¨JVMä¸­æ‰€èµ·çš„ä½œç”¨å°±æ˜¯ç”¨äºå­˜æ”¾å½“å‰çº¿ç¨‹æ¥ä¸‹æ¥å°†è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€åˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ç­‰ä¿¡æ¯ã€‚åœ¨ä»»ä½•æ—¶å€™ï¼Œä¸€ä¸ªå¤„ç†å™¨åªæ‰§è¡Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æŒ‡ä»¤ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨CPUæ—¶é—´ç‰‡è½®è½¬åˆ‡æ¢ä¸Šä¸‹æ–‡ä¹‹åé¡ºåˆ©å›åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦å…·æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´äº’ç›¸ä¸å½±å“ï¼Œå› æ­¤JVMå°†æ­¤å—å†…å­˜åŒºåŸŸè®¾è®¡æˆäº†çº¿ç¨‹ç§æœ‰çš„ã€‚\nJava è™šæ‹Ÿæœºæ ˆ ä¸ç¨‹åºè®¡æ•°å™¨å†…å­˜ç›¸ç±»ä¼¼ï¼ŒJavaè™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒï¼Œæ˜¯åœ¨JVMè¿è¡Œæ—¶æ‰€åˆ›å»ºçš„ï¼Œåœ¨çº¿ç¨‹ä¸­ï¼Œæ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªåä¸ºæ ˆå¸§ï¼ˆstack frameï¼‰çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦ç”¨äºå­˜æ”¾å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œæ–¹æ³•çš„è°ƒç”¨å¯¹åº”ç€æ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­çš„å‹æ ˆå’Œå¼¹æ ˆè¿‡ç¨‹ã€‚\næ¯ä¸€ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºçš„æ—¶å€™ï¼ŒJVMéƒ½ä¼šä¸ºå…¶åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œè™šæ‹Ÿæœºæ ˆçš„å¤§å°å¯ä»¥é€šè¿‡-xssæ¥é…ç½®ï¼Œæ–¹æ³•çš„è°ƒç”¨æ˜¯æ ˆå¸§è¢«å‹å…¥å’Œå¼¹å‡ºçš„è¿‡ç¨‹ï¼Œé€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒåŒç­‰çš„è™šæ‹Ÿæœºæ ˆå¦‚æœå±€éƒ¨å˜é‡è¡¨ç­‰å ç”¨å†…å­˜è¶Šå°åˆ™å¯è¢«å‹å…¥çš„æ ˆå¸§å°±ä¼šè¶Šå¤šï¼Œåä¹‹åˆ™å¯è¢«å‹å…¥çš„æ ˆå¸§å°±ä¼šè¶Šå°‘ï¼Œä¸€èˆ¬å°†æ ˆå¸§å†…å­˜çš„å¤§å°ç§°ä¸ºå®½åº¦ï¼Œè€Œæ ˆå¸§çš„æ•°é‡åˆ™ç§°ä¸ºè™šæ‹Ÿæœºæ ˆçš„æ·±åº¦ã€‚\næœ¬åœ°æ–¹æ³•æ ˆ Javaä¸­æä¾›äº†è°ƒç”¨æœ¬åœ°æ–¹æ³•çš„æ¥å£ï¼ˆJava Native Interfaceï¼‰ï¼Œä¹Ÿå°±æ˜¯C/C++ç¨‹åºï¼Œåœ¨çº¿ç¨‹çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°è°ƒç”¨JNIæ–¹æ³•çš„æƒ…å†µï¼Œæ¯”å¦‚ç½‘ç»œé€šä¿¡ã€æ–‡ä»¶æ“ä½œçš„åº•å±‚ï¼Œç”šè‡³æ˜¯Stringçš„internç­‰éƒ½æ˜¯JNIæ–¹æ³•ï¼ŒJVMä¸ºæœ¬åœ°æ–¹æ³•æ‰€åˆ’åˆ†çš„å†…å­˜åŒºåŸŸä¾¿æ˜¯æœ¬åœ°æ–¹æ³•æ ˆï¼Œè¿™å—å†…å­˜åŒºåŸŸå…¶è‡ªç”±åº¦éå¸¸é«˜ï¼Œå®Œå…¨é ä¸åŒçš„JVMå‚å•†æ¥å®ç°ï¼ŒJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æœªç»™å‡ºå¼ºåˆ¶çš„è§„å®šï¼ŒåŒæ ·å®ƒä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„å†…å­˜åŒºåŸŸã€‚\nå †å†…å­˜ å †å†…å­˜æ˜¯JVMä¸­æœ€å¤§çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œè¢«æ‰€æœ‰çš„çº¿ç¨‹æ‰€å…±äº«ï¼ŒJavaåœ¨è¿è¡ŒæœŸé—´åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡å‡ ä¹éƒ½å­˜æ”¾åœ¨è¯¥å†…å­˜åŒºåŸŸï¼Œè¯¥å†…å­˜åŒºåŸŸä¹Ÿæ˜¯åƒåœ¾å›æ”¶å™¨é‡ç‚¹ç…§é¡¾çš„åŒºåŸŸï¼Œå› æ­¤æœ‰äº›æ—¶å€™å †å†…å­˜è¢«ç§°ä¸ºâ€œGCå †â€ã€‚\nå †å†…å­˜ä¸€èˆ¬ä¼šè¢«ç»†åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œæ›´ç»†è‡´çš„åˆ’åˆ†ä¸ºEdenåŒºã€From SurvivoråŒºå’ŒTo SurvivoråŒºï¼Œå¦‚å›¾æ‰€ç¤ºã€‚","title":"JVM å†…å­˜ç»“æ„"},{"contents":"åŸºæœ¬æ¦‚å¿µ åœ¨ç™»å½•QQçš„æ—¶å€™ï¼ŒQQæœåŠ¡å™¨æ˜¯å¦‚ä½•æ ¸å¯¹ä½ çš„èº«ä»½ï¼Ÿé¢å¯¹åºå¤§çš„ç”¨æˆ·ç¾¤ï¼Œå¦‚ä½•å¿«é€Ÿæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Ÿ\næˆ‘ä»¬å·²ç»çŸ¥é“çš„å‡ ç§æŸ¥æ‰¾æ–¹æ³•åŒ…æ‹¬ï¼šé¡ºåºæŸ¥æ‰¾ï¼ŒäºŒåˆ†æŸ¥æ‰¾ï¼ˆé™æ€æŸ¥æ‰¾ï¼‰ï¼ŒäºŒå‰æœç´¢æ ‘ï¼ˆåŠ¨æ€æŸ¥æ‰¾ï¼‰ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œå¦‚æœä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾çš„è¯å°±ä¼šé¢å¯¹æ’å…¥å’Œåˆ é™¤ä¸€ä¸ªæ–°å·ç è¦ç§»åŠ¨å¤§é‡æ•°æ®çš„é—®é¢˜ã€‚\nè¿™é‡Œæˆ‘ä»¬è¦ç”¨åˆ°æ•£åˆ—æŸ¥æ‰¾çš„æ–¹æ³•ï¼Œæ•£åˆ—ï¼ˆHashingï¼‰çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼š\n ä»¥å…³é”®å­— key ä¸ºè‡ªå˜é‡ï¼Œé€šè¿‡ä¸€ä¸ªç¡®å®šçš„**å‡½æ•° h ï¼ˆæ•£åˆ—å‡½æ•°ï¼‰**è®¡ç®—å‡ºå¯¹åº”çš„å‡½æ•°å€¼h(key)ï¼Œä½œä¸ºæ•°æ®å¯¹è±¡çš„å­˜å‚¨åœ°å€ å¯èƒ½ä¸åŒçš„å…³é”®å­—ä¼šæ˜ å°„åˆ°åŒä¸€ä¸ªæ•£åˆ—åœ°å€ä¸Šï¼Œç§°ä¸º**â€œå†²çªâ€**ï¼Œå‘ç”Ÿå†²çªåéœ€è¦æŸç§å†²çªè§£å†³ç­–ç•¥æ¥è§£å†³å†²çªã€‚  æ•£åˆ—æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œå³æŸ¥æ‰¾æ—¶é—´ä¸é—®é¢˜è§„æ¨¡æ— å…³ã€‚\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè®¾æ•£åˆ—è¡¨ç©ºé—´å¤§å°ä¸ºmï¼Œå¡«å…¥è¡¨ä¸­çš„å…ƒç´ ä¸ªæ•°æ˜¯nï¼Œåˆ™ç§°Î±=n/mä¸ºæ•£åˆ—è¡¨çš„â€è£…å¡«å› å­â€œ(Loading Factor)ã€‚å®ç”¨æ—¶ï¼Œé€šå¸¸å°†æ•£åˆ—è¡¨å¤§å°è®¾è®¡ä¸º 0.5-0.8 ä¸ºå®œã€‚\næ•£åˆ—æ˜ å°„æ³•çš„å…³é”®é—®é¢˜æœ‰ä¸¤ä¸ªï¼š\n å¦‚ä½•è®¾è®¡æ•£åˆ—å‡½æ•°ï¼Œä½¿å¾—å‘ç”Ÿå†²çªçš„æ¦‚ç‡å°½å¯èƒ½å°ï¼› å½“å†²çªæˆ–æº¢å‡ºä¸å¯é¿å…çš„æ—¶å€™ï¼Œå¦‚ä½•å¤„ç†ä½¿å¾—è¡¨ä¸­æ²¡æœ‰ç©ºå•å…ƒè¢«æµªè´¹ï¼ŒåŒæ—¶æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾ç­‰æ“ä½œéƒ½æ­£ç¡®å®Œæˆã€‚  æ•£åˆ—å‡½æ•°çš„æ„é€ æ–¹æ³• ä¸€ä¸ªå¥½çš„æ•£åˆ—å‡½æ•°ä¸€èˆ¬è€ƒè™‘ä¸‹åˆ—ä¸¤ä¸ªå› ç´ ï¼š\n è®¡ç®—ç®€å•ï¼Œä»¥ä¾¿æé«˜è½¬æ¢é€Ÿåº¦ å…³é”®å­—å¯¹åº”çš„åœ°å€ç©ºé—´åˆ†ä¸å‡åŒ€ï¼Œä»¥å°½é‡å‡å°‘å†²çªã€‚å³å¯¹äºå…³é”®å­—é›†åˆä¸­çš„ä»»ä½•ä¸€ä¸ªå…³é”®å­—ï¼Œç»æ•£åˆ—å‡½æ•°æ˜ å°„åˆ°åœ°å€é›†åˆä¸­ä»»ä½•ä¸€ä¸ªåœ°å€çš„æ¦‚ç‡æ˜¯åŸºæœ¬ç›¸ç­‰çš„ã€‚å®é™…åº”ç”¨è¿‡ç¨‹ä¸­ï¼Œä¸¥æ ¼çš„å‡åŒ€åˆ†å¸ƒä¹Ÿæ˜¯ä¸å¯èƒ½çš„ï¼Œåªæ˜¯ä¸è¦è¿‡äºèšé›†å°±è¡Œäº†ã€‚  å…³é”®å­—åˆåˆ†ä¸ºæ•°å­—å…³é”®å­—å’Œå­—ç¬¦ä¸²å…³é”®å­—ä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«æœ‰ä¸åŒçš„æ•£åˆ—å‡½æ•°çš„æ„é€ æ–¹æ³•ï¼š\næ•°å­—å…³é”®å­—çš„æ•£åˆ—å‡½æ•°æ„é€    ç›´æ¥å®šå€æ³•\nå–å…³é”®å­—çš„æŸä¸ªçº¿æ€§å‡½æ•°å€¼ä¸ºæ•£åˆ—åœ°å€ï¼Œå³\nh(key) = a*key + b (a,b ä¸ºå¸¸æ•°)    é™¤ç•™ä½™æ•°æ³•\næ•£åˆ—å‡½æ•°ä¸º\nh(key)=key mod p  å‡è®¾æ•£åˆ—è¡¨é•¿ä¸º TableSize ï¼ˆTableSize çš„é€‰å–é€šå¸¸ç”±å…³é”®å­—é›†åˆçš„å¤§å° n å’Œå…è®¸æœ€å¤§çš„è£…å¡«å› å­ Î± å†³å®šï¼Œä¸€èˆ¬ TableSize=n/Î±ï¼‰ï¼Œé€‰æ‹©ä¸€ä¸ªæ­£æ•´æ•° p \u0026lt;= TableSizeã€‚ä¸€èˆ¬é€‰å– p ä¸ºå°äºæˆ–è€…ç­‰äºæ•£åˆ—è¡¨è¡¨é•¿ TableSize çš„æŸä¸ªæœ€å¤§ç´ æ•°æ¯”è¾ƒå¥½ã€‚ç”¨ç´ æ•°æ±‚å¾—å¾—ä½™æ•°ä½œä¸ºæ•£åˆ—åœ°å€ï¼Œæ¯”è¾ƒå‡åŒ€åœ°åˆ†å¸ƒåœ¨æ•´ä¸ªåœ°å€ç©ºé—´ä¸Šçš„å¯èƒ½æ€§æ¯”è¾ƒå¤§ï¼Œå…·ä½“è¯æ˜å¯ä»¥å‚è€ƒä¸ºä»€ä¹ˆä¸€èˆ¬hashtableçš„æ¡¶æ•°ä¼šå–ä¸€ä¸ªç´ æ•°ã€‚ä¾‹å¦‚ï¼ŒTableSize=8ï¼Œp=7;TableSize=16, p=13ã€‚\n  æ•°å­—åˆ†ææ³•\nåˆ†ææ•°å­—å…³é”®å­—åœ¨å„ä½ä¸Šçš„å˜åŒ–æƒ…å†µï¼Œå–æ¯”è¾ƒéšæœºçš„ä½ä½œä¸ºæ•£åˆ—åœ°å€ã€‚æ•£åˆ—å‡½æ•°å¯ä»¥å–ä¸ºï¼š\nh(key)=atoi(key+7)    æŠ˜å æ³•\næŠŠå…³é”®å­—åˆ†å‰²æˆä½æ•°ç›¸åŒçš„å‡ ä¸ªéƒ¨åˆ†ï¼Œç„¶åå åŠ å–éƒ¨åˆ†å€¼ã€‚ä¾‹å¦‚ï¼š\næŠ˜å æ³•æ˜¯å¸Œæœ›æ¯ä¸€ä½å¯¹æœ€åçš„ç»“æœéƒ½èƒ½äº§ç”Ÿå½±å“ã€‚\n  å¹³æ–¹å–ä¸­æ³•\nå¦‚ï¼š56793542\nå¹³æ–¹å–ä¸­æ³•å’ŒæŠ˜å æ³•çš„ç›®çš„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸ºäº†è®©å…³é”®å­—çš„æ¯ä¸€ä½éƒ½å¯¹æœ€åçš„ç»“æœäº§ç”Ÿå½±å“ã€‚\n  å­—ç¬¦å…³é”®å­—çš„æ•£åˆ—å‡½æ•°æ„é€    ä¸€ä¸ªç®€å•çš„æ•£åˆ—å‡½æ•°ï¼šASCII ç åŠ å’Œæ³•ã€‚å¯¹å­—ç¬¦å‹å…³é”®å­—keyå®šä¹‰æ•£åˆ—å‡½æ•°å¦‚ä¸‹ï¼š\n$\\sum key[i]$ mod TableSize\nè¿™ç§æ–¹æ³•ä¼šæœ‰ä¸¥é‡çš„å†²çª\n  ç®€å•çš„æ”¹è¿› - å‰3ä¸ªå­—ç¬¦ç§»ä½æ³•\n$h(key)=(key[0]*27^2+key[1]*27+key[2])$ mod TableSize\nè¿™ä¸ªæ–¹æ³•ä¼šé€ æˆç©ºé—´çš„æµªè´¹\n  å¥½çš„æ•£åˆ—å‡½æ•°ï¼šç§»ä½æ³•\næ¶‰åŠå…³é”®å­—æ‰€æœ‰nä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”åˆ†å¸ƒçš„å¾ˆå¥½ï¼š\n$h(key)=(\\displaystyle \\sum^{n-1}_{i=0}{key[n-i-1]*32^i})$ mod TableSize\nè¯¥å‡½æ•°ç”¨äºå¤„ç†é•¿åº¦ä½ n çš„å­—ç¬¦ä¸²å…³é”®å­—ï¼Œæ¯ä¸ªå­—ç¬¦å 5ä½(å³ $2^5=32$)ï¼Œå…·ä½“å®ç°æ—¶å¹¶ä¸éœ€è¦åšä¹˜æ³•è¿ç®—ï¼Œè€Œæ˜¯é€šè¿‡ä¸€æ¬¡å·¦ç§» 5 ä½æ¥å®Œæˆã€‚\npublic int hashString(String key, int tableSize) { int h = 0; //æ•£åˆ—å‡½æ•°å€¼ï¼Œåˆå§‹åŒ–ä¸º0 char[] keyArrays = key.toCharArray(); for (int i = 0; i \u0026lt;= keyArrays.length; i++) { if (keyArrays[i] != '\\0') { h = (h \u0026lt;\u0026lt; 5) + keyArrays[i]; } } return h % tableSize; }    å†²çªå¤„ç†æ–¹æ³• å¸¸ç”¨å¤„ç†å†²çªçš„æ€è·¯ï¼š\n æ¢ä¸ªä½ç½®ï¼šå¼€æ”¾åœ°å€æ³• åŒä¸€ä½ç½®çš„å†²çªå¯¹è±¡ç»„ç»‡åœ¨ä¸€èµ·ï¼šé“¾åœ°å€æ³•  å¼€æ”¾å®šå€æ³• ä¸€æ—¦äº§ç”Ÿäº†å†²çªï¼ˆè¯¥åœ°å€å·²æœ‰å…¶ä»–å…ƒç´ ï¼‰ï¼Œå°±æŒ‰æŸç§è§„åˆ™å»å¯»æ‰¾å¦ä¸€ç©ºåœ°å€ã€‚å‡è®¾å‘ç”Ÿäº†ç¬¬ i æ¬¡å†²çªï¼Œè¯•æ¢çš„ä¸‹ä¸€ä¸ªåœ°å€å°†å¢åŠ  $d_i$ , åŸºæœ¬å…¬å¼æ˜¯ï¼š\n$d_i(key)=(h(key)+d_i)$ mod tableSize ï¼ˆ1 \u0026lt;= i \u0026lt; tableSizeï¼‰\n$d_i$å†³å®šäº†ä¸åŒçš„è§£å†³å†²çªæ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼šçº¿æ€§æ¢æµ‹ã€å¹³æ–¹æ¢æµ‹ã€åŒæ•£åˆ—ã€‚\n  çº¿æ€§æ¢æµ‹\n$d_i=i$\nä»¥å¢é‡åºåˆ—1,2,\u0026hellip;\u0026hellip;,(tableSize-1) å¾ªç¯è¯•æ¢ä¸‹ä¸€ä¸ªå­˜å‚¨åœ°å€ã€‚åšæ’å…¥æ“ä½œçš„æ—¶å€™ï¼Œè¦æ‰¾åˆ°ä¸€ä¸ªç©ºä½ç½®ï¼Œæˆ–è€…ç›´åˆ°æ•£åˆ—è¡¨æ»¡ä¸ºæ­¢ï¼›åšæŸ¥æ‰¾æ“ä½œæ—¶ï¼Œæ¢æµ‹ä¸€ä¸ªæ¯”è¾ƒä¾æ¬¡ä¸€æ¬¡å…³é”®å­—ï¼Œç›´åˆ°æ‰¾åˆ°ç‰¹å®šçš„æ•°æ®å¯¹è±¡ï¼Œæˆ–è€…æ¢æµ‹åˆ°ä¸€ä¸ªç©ºä½ç½®è¡¨ç¤ºæŸ¥æ‰¾å¤±è´¥ä¸ºæ­¢ã€‚\nçº¿æ€§æ¢æµ‹çš„ç¼ºç‚¹å°±æ˜¯å®¹æ˜“äº§ç”Ÿèšé›†çš„ç°è±¡ï¼Œå› æ­¤å¼•å…¥äº†å¹³æ–¹æ¢æµ‹æ³•\n  å¹³æ–¹æ¢æµ‹æ³•\u0026ndash;äºŒæ¬¡æ¢æµ‹\nå¹³æ–¹æ¢æµ‹çš„å…¬å¼ï¼š$d_i=\\pm i^2$ï¼Œæ¯æ¬¡ä»¥å¢é‡åºåˆ—$1^2,-1^2,2^2,-2^2\u0026hellip;\u0026hellip;$å¾ªç¯è¯•æ¢ä¸‹ä¸€ä¸ªå­˜å‚¨åœ°å€ã€‚\nå¹³æ–¹æ¢æµ‹æ³•æœ‰å¯èƒ½å‡ºç°æ•£åˆ—è¡¨ä¸­æœ‰ç©ºé—´ï¼Œä½†æ˜¯æ— æ³•æ¢æµ‹åˆ°çš„æƒ…å†µã€‚ä¾‹å¦‚:\næ•£åˆ—è¡¨çš„é•¿åº¦ä¸º5ï¼Œæ’å…¥5,6,7,11è¿™å››ä¸ªå…ƒç´ ï¼Œæ•£åˆ—å‡½æ•°è®¾è®¡ä¸º:\nh(key)=key mod 5  å½“æ’å…¥11æ—¶ï¼Œæ•£åˆ—å‡½æ•°æ‰¾åˆ°çš„ä½ç½®ä¸º2ï¼Œå’Œ6è¿™ä¸ªå…ƒç´ æ‰€åœ¨çš„ä½ç½®äº§ç”Ÿå†²çªï¼Œä½¿ç”¨å¹³æ–¹æ¢æµ‹æ³•ï¼Œæ¢æµ‹åºåˆ—ä¸º:\n1+1=2 1-1=0 (1+2*2)%5=0 (1-2*2)%5=2 (1+3*3)%5=0 (1-3*3)%5=2 ......  å¯ä»¥å‘ç°ï¼Œæ¢æµ‹åºåˆ—ä¸€ç›´åœ¨0å’Œ2è¿™ä¸¤ä¸ªä½ç½®ä¹‹é—´å˜åŠ¨ï¼Œä¸€ç›´æ‰¾ä¸åˆ°ç©ºçš„ä½ç½®ï¼Œä½†æ˜¯æ•£åˆ—è¡¨å®é™…ä¸Šè¿˜æœ‰ç©ºé—´ã€‚æœ‰å®šç†æ˜¾ç¤ºï¼šå¦‚æœæ•£åˆ—è¡¨é•¿åº¦tableSizeæ˜¯æŸä¸ª$4k+3$(kæ˜¯æ­£æ•´æ•°) å½¢å¼çš„ç´ æ•°æ—¶ï¼Œå¹³æ–¹æ¢æµ‹æ³•å°±å¯ä»¥æ¢æŸ¥åˆ°æ•´ä¸ªæ•£åˆ—è¡¨ç©ºé—´ã€‚\nè™½ç„¶å¹³æ–¹æ¢æµ‹æ³•æ’é™¤äº†ä¸€æ¬¡èšé›†ï¼Œä½†æ˜¯æ•£åˆ—åˆ°åŒä¸€åœ°å€çš„é‚£äº›æ•°æ®å¯¹è±¡å°†æ¢æµ‹ç›¸åŒçš„å¤‡é€‰å•å…ƒï¼Œè¿™ç§°ä¸ºâ€œäºŒæ¬¡èšé›†â€ã€‚\n  åŒæ•£åˆ—æ¢æµ‹æ³•\nåŒæ•£åˆ—æ¢æµ‹æ³•: $d_i=i*h_2(key)$ï¼Œ$h_2(key)$æ˜¯å¦ä¸€ä¸ªæ•£åˆ—å‡½æ•°ï¼Œæ¢æµ‹åºåˆ—ä¸ºï¼š\n$h_2(key), 2h_2(key), 3h_2(key), \u0026hellip;\u0026hellip;$\næ¢æµ‹åºåˆ—è¿˜åº”è¯¥ä¿è¯æ‰€æœ‰çš„æ•£åˆ—å­˜å‚¨å•å…ƒéƒ½èƒ½è¢«æ¢æµ‹åˆ°ã€‚é€‰æ‹©ä»¥ä¸‹å½¢å¼æœ‰è‰¯å¥½çš„æ•ˆæœï¼š\n$h_2(key)=p$ - (key mod p)\n  å†æ•£åˆ—\nå½“æ•£åˆ—è¡¨å…ƒç´ å¤ªå¤šï¼ˆå³è£…å¡«å› å­Î±å¤ªå¤§ï¼‰æ—¶ï¼ŒæŸ¥æ‰¾æ•ˆç‡ä¼šä¸‹é™ï¼Œå®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œè£…å¡«å› å­ä¸€èˆ¬å– 0.5\u0026lt;=Î±\u0026lt;=0.85ã€‚\nå½“è£…å¡«å› å­è¿‡å¤§æ—¶ï¼Œè§£å†³çš„æ–¹æ³•æ—¶åŠ å€æ‰©å¤§æ•£åˆ—è¡¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšâ€œå†æ•£åˆ—â€ã€‚\n  åœ¨å¼€æ”¾åœ°å€æ•£åˆ—è¡¨ä¸­ï¼Œåˆ é™¤æ“ä½œè¦å¾ˆå°å¿ƒï¼Œé€šå¸¸åªèƒ½ â€œæ‡’æƒ°åˆ é™¤â€ï¼Œå³éœ€è¦å¢åŠ ä¸€ä¸ªåˆ é™¤æ ‡è®°(Deleted)ï¼Œå¹¶ä¸æ˜¯çœŸæ­£åˆ é™¤å®ƒã€‚è¿™æ˜¯å› ä¸ºæ’å…¥çš„æ—¶å€™ï¼Œä¸ºäº†è§£å†³å†²çªé—®é¢˜ï¼Œè¿™ä¸ªä½ç½®å·²ç»è¢«å ç”¨äº†ï¼Œå¦‚æœåˆ é™¤æ‰å®ƒï¼ŒæŸ¥æ‰¾çš„æ—¶å€™å°±ä¼šå‡ºç°â€œæ–­é“¾â€çš„ç°è±¡ã€‚\nåˆ†ç¦»é“¾æ¥æ³• åˆ†ç¦»é“¾æ¥æ³•æ—¶è§£å†³å†²çªçš„å¦ä¸€ç§æ–¹æ³•ï¼Œå…¶åšæ³•æ˜¯å°†æ‰€æœ‰å…³é”®å­—ä¸ºåŒä¹‰è¯çš„æ•°æ®å¯¹è±¡é€šè¿‡èŠ‚ç‚¹é“¾æ¥å­˜å‚¨åˆ°åŒä¸€å•å‘é“¾è¡¨ä¸­ã€‚ã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåˆ†è£‚é“¾æ¥æ³•å®é™…ä¸Šæ˜¯ç”¨ä¸€ä¸ªæ•°ç»„æ¥ç»„ç»‡æ•£åˆ—è¡¨çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªæ•°ç»„ç§°ä¸ºå“ˆå¸Œæ¡¶ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æŒ‡å‘ä¸€ä¸ªé“¾è¡¨ï¼Œå½“å…ƒç´ å†²çªçš„æ—¶å€™ï¼Œå°±åœ¨é“¾è¡¨çš„å¤´èŠ‚ç‚¹ä¸Šæ’å…¥å†²çªçš„å…ƒç´ ã€‚æ–°å…ƒç´ æ’å…¥åˆ°è¡¨å¤´ï¼Œè¿™ä¸ä»…ä»…ä¸ºäº†æ–¹ä¾¿ï¼Œè€Œä¸”è¿˜å› ä¸ºæ–°è¿‘æ’å…¥çš„å…ƒç´ æœ€æœ‰å¯èƒ½è¢«æœ€å…ˆè®¿é—®ï¼Œè¿™æ ·å¯ä»¥åŠ å¿«åœ¨å•å‘é“¾è¡¨ä¸­çš„é¡ºåºæŸ¥æ‰¾é€Ÿåº¦ã€‚\næ•£åˆ—è¡¨çš„æ€§èƒ½åˆ†æ æ•£åˆ—è¡¨çš„æ€§èƒ½ä½¿ç”¨å¹³å‡æŸ¥æ‰¾é•¿åº¦ï¼ˆASLï¼‰æ¥åº¦é‡ã€‚\n  çº¿æ€§æ¢æµ‹æ³•çš„æŸ¥æ‰¾æ€§èƒ½æ»¡è¶³ä¸‹åˆ—å…¬å¼\n  å¹³æ–¹æ¢æµ‹æ³•å’ŒåŒæ•£åˆ—æ¢æµ‹æ³•çš„æŸ¥æ‰¾æ€§èƒ½æ»¡è¶³ä¸‹åˆ—å…¬å¼\n  åˆ†ç¦»é“¾æ¥æ³•çš„æŸ¥æ‰¾æ€§èƒ½æ»¡è¶³ä¸‹åˆ—å…¬å¼\n   å‚è€ƒï¼šæµ™æ±Ÿå¤§å­¦é™ˆè¶Šè€å¸ˆçš„æ•°æ®ç»“æ„è¯¾ç¨‹\n ","date":"2020å¹´10æœˆ15æ—¥","permalink":"https://ahamoment.cn/posts/algorithm/algorithm-hashtable/","summary":"åŸºæœ¬æ¦‚å¿µ åœ¨ç™»å½•QQçš„æ—¶å€™ï¼ŒQQæœåŠ¡å™¨æ˜¯å¦‚ä½•æ ¸å¯¹ä½ çš„èº«ä»½ï¼Ÿé¢å¯¹åºå¤§çš„ç”¨æˆ·ç¾¤ï¼Œå¦‚ä½•å¿«é€Ÿæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Ÿ\næˆ‘ä»¬å·²ç»çŸ¥é“çš„å‡ ç§æŸ¥æ‰¾æ–¹æ³•åŒ…æ‹¬ï¼šé¡ºåºæŸ¥æ‰¾ï¼ŒäºŒåˆ†æŸ¥æ‰¾ï¼ˆé™æ€æŸ¥æ‰¾ï¼‰ï¼ŒäºŒå‰æœç´¢æ ‘ï¼ˆåŠ¨æ€æŸ¥æ‰¾ï¼‰ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œå¦‚æœä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾çš„è¯å°±ä¼šé¢å¯¹æ’å…¥å’Œåˆ é™¤ä¸€ä¸ªæ–°å·ç è¦ç§»åŠ¨å¤§é‡æ•°æ®çš„é—®é¢˜ã€‚\nè¿™é‡Œæˆ‘ä»¬è¦ç”¨åˆ°æ•£åˆ—æŸ¥æ‰¾çš„æ–¹æ³•ï¼Œæ•£åˆ—ï¼ˆHashingï¼‰çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼š\n ä»¥å…³é”®å­— key ä¸ºè‡ªå˜é‡ï¼Œé€šè¿‡ä¸€ä¸ªç¡®å®šçš„**å‡½æ•° h ï¼ˆæ•£åˆ—å‡½æ•°ï¼‰**è®¡ç®—å‡ºå¯¹åº”çš„å‡½æ•°å€¼h(key)ï¼Œä½œä¸ºæ•°æ®å¯¹è±¡çš„å­˜å‚¨åœ°å€ å¯èƒ½ä¸åŒçš„å…³é”®å­—ä¼šæ˜ å°„åˆ°åŒä¸€ä¸ªæ•£åˆ—åœ°å€ä¸Šï¼Œç§°ä¸º**â€œå†²çªâ€**ï¼Œå‘ç”Ÿå†²çªåéœ€è¦æŸç§å†²çªè§£å†³ç­–ç•¥æ¥è§£å†³å†²çªã€‚  æ•£åˆ—æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œå³æŸ¥æ‰¾æ—¶é—´ä¸é—®é¢˜è§„æ¨¡æ— å…³ã€‚\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè®¾æ•£åˆ—è¡¨ç©ºé—´å¤§å°ä¸ºmï¼Œå¡«å…¥è¡¨ä¸­çš„å…ƒç´ ä¸ªæ•°æ˜¯nï¼Œåˆ™ç§°Î±=n/mä¸ºæ•£åˆ—è¡¨çš„â€è£…å¡«å› å­â€œ(Loading Factor)ã€‚å®ç”¨æ—¶ï¼Œé€šå¸¸å°†æ•£åˆ—è¡¨å¤§å°è®¾è®¡ä¸º 0.5-0.8 ä¸ºå®œã€‚\næ•£åˆ—æ˜ å°„æ³•çš„å…³é”®é—®é¢˜æœ‰ä¸¤ä¸ªï¼š\n å¦‚ä½•è®¾è®¡æ•£åˆ—å‡½æ•°ï¼Œä½¿å¾—å‘ç”Ÿå†²çªçš„æ¦‚ç‡å°½å¯èƒ½å°ï¼› å½“å†²çªæˆ–æº¢å‡ºä¸å¯é¿å…çš„æ—¶å€™ï¼Œå¦‚ä½•å¤„ç†ä½¿å¾—è¡¨ä¸­æ²¡æœ‰ç©ºå•å…ƒè¢«æµªè´¹ï¼ŒåŒæ—¶æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾ç­‰æ“ä½œéƒ½æ­£ç¡®å®Œæˆã€‚  æ•£åˆ—å‡½æ•°çš„æ„é€ æ–¹æ³• ä¸€ä¸ªå¥½çš„æ•£åˆ—å‡½æ•°ä¸€èˆ¬è€ƒè™‘ä¸‹åˆ—ä¸¤ä¸ªå› ç´ ï¼š","title":"æ•£åˆ—è¡¨é‚£äº›äº‹"},{"contents":"NSCD(Name Service Cache Daemon)æ˜¯æœåŠ¡ç¼“å­˜å®ˆæŠ¤è¿›ç¨‹ã€‚\nNSCD å®‰è£…   RHEL/CentOS\nyum -y install nscd    Debian/Ubuntu\napt-get install nscd    RPM\nhttps://centos.pkgs.org/7/centos-x86_64/nscd-2.17-307.el7.1.x86_64.rpm.html    CentOS7 ä¹‹å NSCD ä½¿ç”¨ systemd è¿›è¡Œç®¡ç†ã€‚\nNSCD å‘½ä»¤é€‰é¡¹ $ nscd --help ç”¨æ³•ï¼š nscd [é€‰é¡¹...] Name Service Cache Daemon. -d, --debug Do not fork and display messages on the current tty -f, --config-file=åç§° ä»NAMEä¸­è¯»å–é…ç½®æ•°æ® -g, --statistics Print current configuration statistics -i, --invalidate=TABLE Invalidate the specified cache -K, --shutdown å…³é—­æœåŠ¡å™¨ -t, --nthreads=NUMBER å¯åŠ¨ NUMBER ä¸ªçº¿ç¨‹ -?, --help ç»™å‡ºè¯¥ç³»ç»Ÿæ±‚åŠ©åˆ—è¡¨ --usage ç»™å‡ºç®€è¦çš„ç”¨æ³•ä¿¡æ¯ -V, --version æ‰“å°ç¨‹åºç‰ˆæœ¬å· é•¿é€‰é¡¹çš„å¼ºåˆ¶æˆ–å¯é€‰å‚æ•°å¯¹å¯¹åº”çš„çŸ­é€‰é¡¹ä¹Ÿæ˜¯å¼ºåˆ¶æˆ–å¯é€‰çš„ã€‚  NSCD é…ç½®æ–‡ä»¶ NSCDé…ç½®æ–‡ä»¶ä¸º/etc/nscd.confï¼ŒNSCDç¨‹åºåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šè¯»å–/etc/nscd.confæ–‡ä»¶ï¼Œæ¯ä¸€è¡ŒæŒ‡å®šä¸€ä¸ªå±æ€§å’Œå¯¹åº”çš„å€¼ï¼Œæˆ–è€…æŒ‡å®šä¸€ä¸ªæœåŠ¡å’Œå¯¹åº”çš„å€¼ï¼Œ#è¡¨ç¤ºæ³¨é‡Šã€‚æœ‰æ•ˆçš„æœåŠ¡è®¾å®šæ˜¯ï¼špasswd, group, hosts, services, or netgroupäº”ä¸ªã€‚\nNSCD çš„ç¼“å­˜æ–‡ä»¶è·¯å¾„é»˜è®¤ä¸º /var/db/nscd/ã€‚\nNSCD çš„é…ç½®æ–‡ä»¶ç›¸å…³å‚æ•°\n#è®¾ç½®æ—¥å¿—æ–‡ä»¶ logfile debug-file-name #è®¾ç½®debugè®°å½•çš„çº§åˆ«ï¼Œé»˜è®¤æ˜¯0 debug-level value #ç¨‹åºå¯åŠ¨æ—¶ï¼Œç­‰å¾…è¿›å»è¯·æ±‚çš„å¤„ç†çº¿ç¨‹æ•°ï¼Œè‡³å°‘5ä¸ª threads number #æœ€å¤§çº¿ç¨‹æ•°ï¼Œé»˜è®¤32 max-threads number #nscdç¨‹åºä»¥å“ªä¸ªç”¨æˆ·è¿è¡Œ,å¦‚æœè®¾ç½®äº†è¯¥é€‰é¡¹ï¼Œnscdå°†ä½œä¸ºè¯¥ç”¨æˆ·è¿è¡Œï¼Œè€Œä¸æ˜¯ä½œä¸ºrootã€‚å¦‚æœæ¯ä¸ªç”¨æˆ·éƒ½ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ç¼“å­˜(-Så‚æ•°)ï¼Œå°†å¿½ç•¥è¯¥é€‰é¡¹ã€‚ server-user user #å“ªä¸ªç”¨æˆ·å¯ä»¥è¯·æ±‚ç»Ÿè®¡ç”¨æˆ· stat-user user #åœ¨ä¸€ä¸ªç¼“å­˜é¡¹è¢«åˆ é™¤ä¹‹å‰å…è®¸ä½¿ç”¨çš„æ¬¡æ•°ï¼Œé»˜è®¤å€¼æ˜¯5ï¼Œä»£è¡¨SUCCESSçš„ç¼“å­˜åœ¨å†…å­˜ä¸­ä¼šReload5æ¬¡ reload-count unlimited | number #æ˜¯å¦å¯ç”¨åæ‰§æ¨¡å¼ï¼Œå¯ç”¨ä¼šå¯¼è‡´nscdå‘¨æœŸæ€§é‡å¯ï¼Œé»˜è®¤æ˜¯no paranoia \u0026lt;yes|no\u0026gt; #å¦‚æœå¯ç”¨åæ‰§æ¨¡å¼ï¼Œè®¾ç½®çš„å®šæœŸé‡å¯nscdçš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤æ˜¯3600ç§’ restart-interval time #å¼€å¯æˆ–è€…å…³é—­æœåŠ¡ç¼“å­˜ï¼Œé»˜è®¤æ˜¯no enable-cache service \u0026lt;yes|no\u0026gt; #ä¸ºæˆåŠŸè¯·æ±‚çš„å…ƒç´ è®¾ç½®ç¼“å­˜TTLï¼Œå•ä½æ˜¯ç§’ï¼Œå€¼è¶Šå¤§ç¼“å­˜å‘½ä¸­ç‡è¶Šé«˜ï¼Œé™ä½å¹³å‡å“åº”æ—¶é—´ï¼Œä½†ä¼šå¢åŠ ç¼“å­˜çš„ä¸€è‡´æ€§é—®é¢˜ positive-time-to-live service value #ä¸ºå¤±è´¥æŸ¥è¯¢å…ƒç´ è®¾ç½®ç¼“å­˜TTLï¼Œå•ä½æ˜¯ç§’ï¼Œåº”ä¿æŒå°å€¼ï¼Œå‡å°ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ negative-time-to-live service value #å†…éƒ¨çš„æ•£åˆ—è¡¨å¤§å°ï¼Œvalueåº”è¯¥ä¿æŒä¸€ä¸ªç´ æ•°ä»¥è¾¾åˆ°ä¼˜åŒ–æ•ˆæœã€‚é»˜è®¤å€¼æ˜¯211 suggested-size service value #å¯ç”¨æˆ–è€…ç¦ç”¨æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å±äºæŒ‡å®šçš„æœåŠ¡ï¼Œè¿™äº›æ–‡ä»¶æ˜¯/etc/passwdã€/etc/groupã€/etc/hostsã€/etc/servicesã€/etc/netgroupç­‰ check-files service \u0026lt;yes|no\u0026gt; #è®¾ç½®ç¼“å­˜åœ¨æœåŠ¡å™¨é‡å¯åï¼Œä»æ—§èƒ½æä¾›ç¼“å­˜æœåŠ¡ï¼Œåœ¨ä½¿ç”¨åæ‰§æ¨¡å¼æ—¶æœ‰ç”¨ï¼Œé»˜è®¤æ˜¯no persistent service \u0026lt;yes|no\u0026gt; #ä¸ºå®¢æˆ·ç«¯å…±äº«nscdæ•°æ®åº“åœ¨å†…å­˜ä¸­åšçš„æ˜ å°„ï¼Œä½¿å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥æœç´¢ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½æŸ¥è¯¢å®ˆæŠ¤è¿›è¡Œï¼Œé»˜è®¤æ˜¯no shared service \u0026lt;yes|no\u0026gt; #è¯¥æ•°æ®åº“çš„æœ€å¤§å¤§å°ï¼Œå•ä½æ˜¯bytesï¼Œé»˜è®¤æ˜¯33554432 max-db-size service bytes #æ­¤é€‰é¡¹ä»…ä½¿ç”¨äºpasswdå’ŒgroupæœåŠ¡ auto-propagate service \u0026lt;yes|no\u0026gt;  NSCD ä½¿ç”¨ç¤ºä¾‹ï¼šå¯¹DNSè¿›è¡Œç¼“å­˜ DNSç¼“å­˜åœ¨æœåŠ¡å™¨ä¸Šçš„ä½œç”¨ åœ¨éœ€è¦é€šè¿‡åŸŸåä¸å¤–ç•Œè¿›è¡Œæ•°æ®äº¤äº’çš„æ—¶å€™,dnsç¼“å­˜å°±æ´¾ä¸Šç”¨åœºäº†,å®ƒå¯ä»¥å‡å°‘åŸŸåè§£æçš„æ—¶é—´,æé«˜æ•ˆç‡ã€‚ä¾‹å¦‚ä»¥ä¸‹æƒ…å†µ\n ä½¿ç”¨çˆ¬è™«é‡‡é›†ç½‘ç»œä¸Šçš„é¡µé¢æ•°æ®, ä½¿ç”¨auth2.0åè®®ä»å…¶ä»–å¹³å°(å¦‚å¾®åšæˆ–QQ)è·å–ç”¨æˆ·æ•°æ®, ä½¿ç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£, ä½¿ç”¨çŸ­ä¿¡é€šé“ä¸‹å‘çŸ­ä¿¡ç­‰.  å¼€å¯NSCD DNS ç¼“å­˜æœåŠ¡çš„ä¼˜ç¼ºç‚¹  ä¼˜ç‚¹ï¼š  æœ¬åœ°ç¼“å­˜DNSè§£æä¿¡æ¯ï¼Œæä¾›è§£æé€Ÿåº¦ã€‚ DNSæœåŠ¡æŒ‚äº†ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œåœ¨ç¼“å­˜æœåŠ¡æ—¶é—´èŒƒå›´å†…ï¼Œè§£æä¾æ—§æ­£å¸¸ã€‚   ç¼ºç‚¹ï¼š  DNSè§£æä¿¡æ¯ä¼šæ»åï¼Œå¦‚åŸŸåè§£ææ›´æ”¹éœ€è¦æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ï¼ŒNSCDä¸é€‚åˆåšå®æ—¶çš„åˆ‡æ¢çš„åº”ç”¨ å¤šæ¡RRçš„æƒ…å†µä¸‹å¤±å»è½®è¯¢åŠŸèƒ½ï¼Œå¯¼è‡´ç¼“å­˜å‘¨æœŸå†…å•æœºçš„è´Ÿè½½å‡è¡¡å¤±æ•ˆ åŸŸåå˜æ›´ç”Ÿæ•ˆå¯èƒ½æŒç»­ä¸€ä¸ªTTL+15sï¼Œå¯¹äºä¸€éƒ¨åˆ†è®²ç©¶å˜æ›´å¿«é€Ÿç”Ÿæ•ˆçš„åŸŸåè€Œè¨€æœ‰ä¸€å®šçš„å˜æ›´ç”Ÿæ•ˆå»¶è¯¯ å¯¹äºä¸€éƒ¨åˆ†å¼‚å¸¸å¯¼è‡´è§£æé”™è¯¯çš„åŸŸåï¼Œæœ‰å¯èƒ½è¢«NSCDç¼“å­˜å¯¼è‡´ä¸€æ®µæ—¶é—´å†…è§£æéƒ½å¼‚å¸¸    é…ç½®DNSç¼“å­˜ é€šè¿‡ç¼–è¾‘/etc/nscd.confæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­å¢åŠ å¦‚ä¸‹ä¸€è¡Œå¯ä»¥å¼€å¯æœ¬åœ°DNS Cache\nenable-cache hosts yes #è¿™ä¸ªæœåŠ¡é™¤äº†dnsç¼“å­˜ä¹‹å¤–è¿˜å¯ä»¥ç¼“å­˜passwd,group,servers  å®Œæ•´é…ç½®å¦‚ä¸‹ï¼š\n$ cat /etc/nscd.conf logfile /var/log/nscd.log threads 5 max-threads 32 server-user nscd debug-level 0 paranoia no reload-count 5 enable-cache hosts yes enable-cache passwd no enable-cache group no positive-time-to-live hosts 60 negative-time-to-live hosts 20 suggested-size hosts 211 check-files hosts yes persistent hosts yes shared hosts yes max-db-size hosts 33554432  å…³äºä¸»åŠ¨åˆ·æ–° reload-count 5 é»˜è®¤å€¼æ˜¯5ï¼Œä»£è¡¨SUCCESSçš„ç¼“å­˜åœ¨å†…å­˜ä¸­ä¼šReload 5æ¬¡  reloadçš„timeæ˜¯DNSåº”ç­”TTL+CACHE_PRUNE_INTERVALï¼Œreloadè¿‡ç¨‹ä¸­NSCDä¼šä¸»åŠ¨å‘èµ·DNSè¯·æ±‚ï¼ˆéå®¢æˆ·ç«¯å‘èµ·ï¼‰ï¼Œå¦‚æœæœŸé—´å‘ç”Ÿè§£æç»“æœå˜æ›´ä¼šå°†ç»“æœä¸»åŠ¨æ›´æ–°è‡³NSCDç¼“å­˜ã€‚è¿™é‡Œçš„CACHE_PRUNE_INTERVALæ¥è‡ªäºç›¸å…³çš„å®å®šä¹‰ï¼š\n#define CACHE_PRUNE_INTERVAL 15  å…³äºésuccessåŸŸåçš„ç¼“å­˜ æŸ¥çœ‹ä»£ç å‘ç°å¯¹äºésuccessåŸŸåçš„ç¼“å­˜ï¼ŒNSCDä¼šè¯»å–é…ç½®ä¸­çš„negative-time-to-live hostsï¼Œå°†ç¼“å­˜ä¸€ä¸ªnegative-time-to-live hosts+CACHE_PRUNE_INTERVALçš„æ—¶é—´\ndataset-\u0026gt;head.ttl = ttl == INT32_MAX ? db-\u0026gt;negtimeout : ttl; timeout = dataset-\u0026gt;head.timeout = t + dataset-\u0026gt;head.ttl;  å…³äºç¼“å­˜çš„RRè½®è¯¢ NSCDæ˜¯ç›´æ¥ç¼“å­˜äº†GETHOSTBYNAME/GETHOSTBYADDçš„åº”ç­”ç»“æœï¼Œå¦‚æœå­˜åœ¨å¤šæ¡RRçš„æƒ…å†µä¸‹ï¼Œå°†åªä¼šè¯»å–åº”ç­”ç»“æœä¸­çš„ç¬¬ä¸€æ¡ç»“æœä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚å¤šæ¡RRåœ¨NSCDçš„ç¼“å­˜ä¸­å¹¶æ²¡æœ‰RRè½®è¯¢çš„æ•ˆæœï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡reloadæ›´æ–°ç¼“å­˜ç»“æœã€‚è¿™é‡Œå¯èƒ½å¯¼è‡´åŸŸååŸæœ¬çš„è´Ÿè½½å‡è¡¡æœºåˆ¶å¤±æ•ˆã€‚\nå…³äºCNAME+Açš„ç»“æœ GLIBCçš„GETHOSTBYNAME/GETHOSTBYADDè¿”å›çš„TTLä¸­ç›´æ¥è¯»å–çš„æ˜¯Aç±»å‹çš„TTLï¼Œä»£ç ä¸­å¹¶æ²¡æœ‰é’ˆå¯¹CNAMEçš„TTLåšç‰¹æ®Šå¤„ç†ï¼Œå› æ­¤åœ¨æœ‰CNAME+Açš„çº§è”åº”ç­”ç»“æœä¸­ï¼Œç¼“å­˜çš„timeoutå°†åªä¼šè¯»å–å¯¹åº”çš„Aè®°å½•çš„TTLã€‚ å½“DNSåº”ç­”ç»“æœåªæœ‰CNAMEæ—¶ï¼ŒDNSè¯·æ±‚å°†è¢«åˆ¤å®šä¸ºå¤±è´¥ï¼Œè¿™æ—¶CNAMEçš„TTLå°†ä¸èµ·ä½œç”¨ï¼Œç¼“å­˜çš„æ—¶é—´å°†éµå¾ªésuccessåŸŸåçš„timeoutè®¡ç®—ã€‚\nreturn ((qtype == T_A || qtype == T_AAAA) \u0026amp;\u0026amp; ap != host_data-\u0026gt;aliases ? NSS_STATUS_NOTFOUND : NSS_STATUS_TRYAGAIN);  å¯åŠ¨ NSCD è¿›ç¨‹ é»˜è®¤è¯¥æœåŠ¡åœ¨Redhatæˆ–Centosä¸‹æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤å¼€å¯\n$ systemctl start nscd  æŸ¥çœ‹è¿›ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤º\n$ ps aux | grep nscd nscd 1284 0.1 0.3 708056 1580 ? Ssl 23:37 0:00 /usr/sbin/nscd  è¯´æ˜å·²ç»æ­£å¸¸è¿è¡Œäº†ã€‚\nNSCDæœåŠ¡æŸ¥çœ‹å’Œæ¸…é™¤ NSCDç¼“å­˜DBæ–‡ä»¶åœ¨/var/db/nscdä¸‹ã€‚å¯ä»¥é€šè¿‡nscd -gæŸ¥çœ‹ç»Ÿè®¡çš„ä¿¡æ¯ï¼Œè¿™é‡Œåˆ—å‡ºéƒ¨åˆ†ï¼š\n$ nscd -g nscd é…ç½®ï¼š 0 æœåŠ¡å™¨è°ƒè¯•çº§åˆ« 4s server runtime 5 current number of threads 32 maximum number of threads 0 number of times clients had to wait no paranoia mode enabled 3600 restart internal 5 reload count ... çœç•¥è¾“å‡ºä¿¡æ¯è‹¥å¹² ... hosts cache: yes cache is enabled yes cache is persistent yes cache is shared 211 suggested size 216064 total data pool size 0 used data pool size 60 seconds time to live for positive entries 20 seconds time to live for negative entries 0 cache hits on positive entries 0 cache hits on negative entries 0 cache misses on positive entries 0 cache misses on negative entries 0% cache hit rate 0 current number of cached values 0 maximum number of cached values 0 maximum chain length searched 0 number of delays on rdlock 0 number of delays on wrlock 0 memory allocations failed yes check /etc/hosts for changes ... çœç•¥è¾“å‡ºä¿¡æ¯è‹¥å¹² ...  æ¸…é™¤æŒ‡å®šç±»å‹ç¼“å­˜ $ nscd -i passwd $ nscd -i group $ nscd -i hosts  å…³é—­æœåŠ¡ $ nscd -K  å‚è€ƒæ–‡ç«  ã€1ã€‘Linux ä¸‹å¼€å¯ç¼“å­˜æœåŠ¡ NSCD\nã€2ã€‘é˜¿é‡ŒDNS: NSCD-DNSç¼“å­˜è¯¦è§£\nã€3ã€‘Linux man page\n","date":"2020å¹´09æœˆ27æ—¥","permalink":"https://ahamoment.cn/posts/linux/linux-nscd/","summary":"NSCD(Name Service Cache Daemon)æ˜¯æœåŠ¡ç¼“å­˜å®ˆæŠ¤è¿›ç¨‹ã€‚\nNSCD å®‰è£…   RHEL/CentOS\nyum -y install nscd    Debian/Ubuntu\napt-get install nscd    RPM","title":"è®¤è¯† Linux NSCD æœåŠ¡ç¼“å­˜"},{"contents":"ä»€ä¹ˆæ˜¯å † äº†è§£ä»€ä¹ˆæ˜¯å †ä¹‹å‰ï¼Œæˆ‘ä»¬çŸ¥é“é˜Ÿåˆ—çš„æ¦‚å¿µï¼Œé˜Ÿåˆ—çš„ç‰¹ç‚¹æ˜¯å…ˆè¿›å…ˆå‡ºï¼Œä½†æ˜¯æœ‰ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—ï¼Œå–å‡ºå…ƒç´ çš„é¡ºåºæ˜¯æŒ‰ç…§å…ƒç´ çš„ä¼˜å…ˆæƒï¼ˆå…³é”®å­—ï¼‰å¤§å°ï¼Œè€Œä¸æ˜¯å…ƒç´ è¿›å…¥é˜Ÿåˆ—çš„å…ˆåé¡ºåºï¼Œè¿™å°±æ˜¯ä¼˜å…ˆé˜Ÿåˆ—(Priority Queue)ã€‚\nè‹¥é‡‡ç”¨æ•°ç»„æˆ–è€…é“¾è¡¨å®ç°ä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ€»ä¼šæœ‰æ’å…¥ã€åˆ é™¤æˆ–è€…æŸ¥æ‰¾ä¸­çš„ä¸€é¡¹æ“ä½œçš„å¤æ‚åº¦æ˜¯$O(N)$ çš„ã€‚\nè‹¥é‡‡ç”¨äºŒå‰æœç´¢æ ‘å®ç°ï¼Œé‚£ä¹ˆæ’å…¥å’Œåˆ é™¤éƒ½è·Ÿæ ‘çš„é«˜åº¦æœ‰å…³ï¼Œä¹Ÿå°±æ˜¯$O(log_2N)$ çš„å¤æ‚åº¦ï¼Œä½†æ˜¯åˆ é™¤çš„æ—¶å€™ï¼Œç”±äºæ¯æ¬¡éƒ½è¦åˆ é™¤æœ€å¤§çš„æˆ–è€…æœ€å°çš„ï¼Œè¿™æ ·æ“ä½œå‡ æ¬¡åï¼Œä¼šé€ æˆæœç´¢æ ‘å¤±å»å¹³è¡¡ï¼Œæ‰€ä»¥ä¸èƒ½ç®€å•çš„ä½¿ç”¨äºŒå‰æœç´¢æ ‘ã€‚\nå¦‚æœé‡‡ç”¨äºŒå‰æ ‘ç»“æ„ï¼Œæˆ‘ä»¬æ›´å…³æ³¨çš„åº”è¯¥æ˜¯åˆ é™¤çš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬æŠŠæœ€å¤§çš„å€¼æ”¾åˆ°æ ¹ç»“ç‚¹ï¼Œå·¦å³ä¸¤è¾¹ä¹Ÿæ˜¯æœ€å¤§å€¼ä½œä¸ºå·¦å³å­æ ‘çš„æ ¹ç»“ç‚¹ï¼Œæ¯æ¬¡åˆ é™¤åªéœ€è¦åˆ é™¤æ ¹ç»“ç‚¹ã€‚åŒæ—¶ï¼Œä¸ºäº†ä¿è¯æ ‘çš„å¹³è¡¡æ€§ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å®Œå…¨äºŒå‰æ ‘æ¥å®ç°ä¼˜å…ˆé˜Ÿåˆ—ã€‚\nä¼˜å…ˆé˜Ÿåˆ—ä½¿ç”¨å®Œå…¨äºŒå‰æ ‘è¡¨ç¤ºå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ•°ç»„çš„ç¬¬ 0 ä¸ªå…ƒç´ ç©ºç€ï¼Œåé¢çš„æŒ‰ç…§å±‚åºéå†çš„é¡ºåºå­˜æ”¾åˆ°æ•°ç»„ä¸­ã€‚ä½¿ç”¨å®Œå…¨äºŒå‰å®ç°çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºå †ï¼Œå †çš„ç‰¹æ€§å¦‚ä¸‹ï¼š\n ç»“æ„æ€§ï¼šç”¨æ•°ç»„è¡¨ç¤ºçš„å®Œå…¨äºŒå‰æ ‘ã€‚ æœ‰åºæ€§ï¼šä»»ä¸€ç»“ç‚¹çš„å…³é”®å­—æ˜¯å…¶å­æ ‘æ‰€æœ‰ç»“ç‚¹çš„æœ€å¤§å€¼ï¼ˆæˆ–æœ€å°å€¼ï¼‰  \u0026ldquo;æœ€å¤§å †\u0026rdquo;ï¼Œä¹Ÿç§° \u0026ldquo;å¤§é¡¶å †\u0026rdquo;ï¼šå †é¡¶å…ƒç´ æ˜¯æ•´ä¸ªæ ‘çš„æœ€å¤§å€¼ \u0026ldquo;æœ€å°å †\u0026rdquo;ï¼Œä¹Ÿç§°\u0026quot;å°é¡¶å †\u0026quot;ï¼šå †é¡¶å…ƒç´ æ˜¯æ•´ä¸ªæ ‘çš„æœ€å°å€¼    å¦‚ä¸‹å›¾æ‰€ç¤ºçš„å‡ ä¸ªäºŒå‰æ ‘ï¼Œä¸æ˜¯å †ã€‚\nç¬¬ä¸€å’Œç¬¬äºŒæ£µäºŒå‰æ ‘è™½ç„¶æ»¡è¶³æœ‰åºæ€§ï¼Œä½†æ˜¯ä¸æ˜¯å®Œå…¨äºŒå‰æ ‘ã€‚ç¬¬ä¸‰å’Œç¬¬å››æ£µäºŒå‰æ ‘æ˜¯å®Œå…¨äºŒå‰æ ‘ï¼Œä½†æ˜¯ä¸æ»¡è¶³æœ‰åºæ€§çš„ç‰¹ç‚¹ã€‚\n æ³¨æ„ï¼šå †ä»æ ¹ç»“ç‚¹åˆ°ä»»æ„ç»“ç‚¹è·¯å¾„ä¸Šçš„ç»“ç‚¹é¡ºåºéƒ½æ˜¯æœ‰åºçš„ï¼\n æœ€å¤§å †çš„åˆ›å»º å †çš„æ•°æ®ç»“æ„åŒ…æ‹¬å­˜å‚¨å®Œå…¨äºŒå‰æ ‘çš„æ•°ç»„ dataï¼Œå †ä¸­å½“å‰å…ƒç´ ä¸ªæ•° sizeï¼Œå †çš„æœ€å¤§å®¹é‡ capacityã€‚\næ•°ç»„çš„å…ƒç´ ä»1å¼€å§‹ï¼Œ0çš„ä½ç½®å®šä¹‰ä¸ºå“¨å…µï¼Œæ–¹ä¾¿ä»¥åæ›´å¿«æ“ä½œã€‚\npublic abstract class Heap { // å †çš„ç±»å‹å®šä¹‰ protected int[] data; //å­˜å‚¨å…ƒç´ çš„æ•°ç»„ protected int size;//å †ä¸­å½“å‰å…ƒç´ ä¸ªæ•° protected int capacity; //å †çš„æœ€å¤§å®¹é‡ public Heap() { this.size = 0; this.capacity = 0; } public Heap(int[] data, int capacity) { this.data = data; this.size = 0; this.capacity = capacity; this.data[0] = Integer.MAX_VALUE; } public Heap(int maxSize) { this.data = new int[maxSize + 1];//æœ€å¤§å…ƒç´ ä»1å¼€å§‹ this.size = 0; this.capacity = maxSize; this.data[0] = Integer.MAX_VALUE;// å®šä¹‰å“¨å…µï¼Œä¸ºå¤§äºæœ€å¤§å †ä¸­æ‰€æœ‰å¯èƒ½å…ƒç´ çš„å€¼ } public boolean isFull() { return this.size == this.capacity; } public boolean isEmpty() { return this.size == 0; } public abstract boolean insert(int element); }  æœ€å¤§å †çš„æ’å…¥ æ’å…¥å…ƒç´ æ—¶ï¼Œæ’å…¥åˆ°æ•°ç»„çš„æœ€åä¸€ä¸ªä½ç½®ï¼Œè¿™é‡Œæ’å…¥çš„ç»“ç‚¹å€¼ä¸º20ï¼Œæ£€æŸ¥æ’å…¥åä»ç„¶ç¬¦åˆå †çš„ä¸¤ä¸ªç‰¹æ€§ï¼Œæ’å…¥å®Œæˆã€‚\nå½“æ’å…¥çš„å€¼ä¸º35çš„æ—¶å€™ï¼Œå½“å‰å †çš„æœ‰åºæ€§è¢«ç ´åäº†ï¼Œå°†35å’Œ31çš„ä½ç½®è°ƒæ¢åå°±å¯ä»¥äº†ã€‚\nå½“æ’å…¥çš„å€¼ä¸º58çš„æ—¶å€™ï¼Œ58 \u0026gt; 31ï¼Œè·Ÿ31å¯¹è°ƒä½ç½®ï¼Œ58 \u0026gt; 44 ç»§ç»­è·Ÿæ ¹ç»“ç‚¹è°ƒæ¢ä½ç½®ã€‚è°ƒæ•´åä¿è¯äº†æœ‰åºæ€§ï¼ŒåŒæ—¶ï¼Œä»58 -\u0026gt; 44 -\u0026gt; 31è¿™æ¡çº¿ä¹Ÿæ˜¯æŒ‰ç…§ä»å¤§åˆ°å°çš„é¡ºåºã€‚\npublic boolean insert(int element) { // å°†å…ƒç´ Xæ’å…¥æœ€å¤§å †Hï¼Œå…¶ä¸­H-\u0026gt;Data[0]å·²ç»å®šä¹‰ä¸ºå“¨å…µ int i; if (isFull()) { System.out.println(\u0026quot;æœ€å¤§å †å·²æ»¡\u0026quot;); return false; } i = ++this.size; // iæŒ‡å‘æ’å…¥åå †ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ çš„ä½ç½® for (; this.data[i / 2] \u0026lt; element; i /= 2) { data[i] = data[i / 2]; // å‘ä¸‹è¿‡æ»¤ç»“ç‚¹ï¼Œå¯¹è°ƒçˆ¶ç»“ç‚¹çš„ä½ç½® } data[i] = element; // å°†Xæ’å…¥ return true; }  ç”±äºæˆ‘ä»¬å°†æ•°ç»„çš„ç¬¬ 0 ä¸ªå…ƒç´ è®¾ç½®ä¸ºå“¨å…µï¼Œå“¨å…µçš„å€¼ä¸ºä¸€ä¸ªéå¸¸å¤§çš„æ•´æ•°å€¼ã€‚å¦‚æœæ²¡æœ‰å“¨å…µç»“ç‚¹ï¼Œæˆ‘ä»¬åœ¨å¾ªç¯ä¸­è¿˜éœ€è¦åˆ¤æ–­ i \u0026gt; 1 è¿™ä¸ªæ¡ä»¶ï¼Œæœ‰äº†å“¨å…µä¹‹åï¼Œå¾ªç¯åœ¨ i = 0 çš„æ—¶å€™å°±ä¼šåœä¸‹æ¥ï¼Œå¯ä»¥å°‘å†™ä¸€ä¸ªæ¡ä»¶ï¼Œæé«˜ç¨‹åºæ•ˆç‡ã€‚\næœ€å¤§å †çš„åˆ é™¤ æœ€å¤§å †çš„åˆ é™¤è¿‡ç¨‹å°±æ˜¯å–å‡ºæ ¹ç»“ç‚¹ï¼ˆæœ€å¤§å€¼ï¼‰å…ƒç´ ï¼ŒåŒæ—¶åˆ é™¤å †çš„ä¸€ä¸ªç»“ç‚¹ã€‚\nåˆ é™¤ä¸‹å›¾çš„è¿™ä¸ªå †çš„æœ€å¤§å€¼ï¼š\n æŠŠ 31 ç§»è‡³æ ¹ æ‰¾å‡º 31 çš„è¾ƒå¤§çš„å­©å­  æ—¶é—´å¤æ‚åº¦ä¸ºï¼š $T(N)=O(logN)$\npublic int deleteMax() { // ä»æœ€å¤§å †ä¸­å–å‡ºé”®å€¼ä¸ºæœ€å¤§çš„å…ƒç´ ï¼Œå¹¶åˆ é™¤ä¸€ä¸ªç»“ç‚¹ int parent, child; int maxItem, temp;//maxItem-å †é¡¶å…ƒç´ ï¼Œtemp-ä¸´æ—¶å˜é‡ if (isEmpty()) { System.out.println(\u0026quot;æœ€å¤§å †å·²ç»ä¸ºç©º\u0026quot;); return -1; } maxItem = this.data[1];//å–å‡ºæ ¹ç»“ç‚¹æœ€å¤§å€¼ // ç”¨æœ€å¤§å †ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ä»æ ¹ç»“ç‚¹å¼€å§‹å‘ä¸Šè¿‡æ»¤ä¸‹å±‚ç»“ç‚¹ temp = this.data[this.size--]; for (parent = 1; parent * 2 \u0026lt; this.size; parent = child) { child = parent * 2; // å·¦å„¿å­çš„ä½ç½® if (child != this.size \u0026amp;\u0026amp; this.data[child] \u0026lt; this.data[child + 1]) { child++; //child æŒ‡å‘å·¦å³ç»“ç‚¹çš„è¾ƒå¤§è€… } if (temp \u0026gt; this.data[child]) {//æ‰¾åˆ°ä½ç½®äº† break; } else {//å°†å­ç»“ç‚¹ä¸çˆ¶èŠ‚ç‚¹å¯¹æ¢ this.data[parent] = this.data[child]; } } this.data[parent] = temp; return maxItem; }  æœ€å¤§å †çš„å»ºç«‹ å»ºç«‹æœ€å¤§å †æ˜¯å°†å·²ç»å­˜åœ¨çš„Nä¸ªå…ƒç´ æŒ‰æœ€å¤§å †çš„è¦æ±‚å­˜æ”¾åœ¨ä¸€ä¸ªä¸€ç»´æ•°ç»„ä¸­ã€‚\nå»ºå †çš„è¿‡ç¨‹å¯ä»¥ä»æ ‘çš„ä»æœ€åä¸€ä¸ªç»“ç‚¹çš„çˆ¶èŠ‚ç‚¹å¼€å§‹ï¼Œåˆ°æ ¹ç»“ç‚¹1ï¼Œå°†æœ€åä¸€ä¸ªç»“ç‚¹çš„çˆ¶èŠ‚ç‚¹æ‰€åœ¨çš„å°å †è°ƒæ•´ä¸ºæœ€å¤§å †ï¼Œç„¶åå‘å·¦å¯»æ‰¾æœ‰å„¿å­çš„ç»“ç‚¹ï¼Œæ¯æ¬¡è°ƒæ•´ä¸€ä¸ªæœ€å¤§å †ï¼Œç›´åˆ°æ ¹ç»“ç‚¹ã€‚\npublic void buildHeap() { //* è°ƒæ•´Data[]ä¸­çš„å…ƒç´ ï¼Œä½¿æ»¡è¶³æœ€å¤§å †çš„æœ‰åºæ€§ *//* //* è¿™é‡Œå‡è®¾æ‰€æœ‰Sizeä¸ªå…ƒç´ å·²ç»å­˜åœ¨Data[]ä¸­ *//* int i; //* ä»æœ€åä¸€ä¸ªç»“ç‚¹çš„çˆ¶èŠ‚ç‚¹å¼€å§‹ï¼Œåˆ°æ ¹ç»“ç‚¹1 *//* for (i = this.size / 2; i \u0026gt; 0; i--) { preDown(i); } } private void preDown(int p) { //* ä¸‹æ»¤ï¼šå°†Hä¸­ä»¥Data[p]ä¸ºæ ¹çš„å­å †è°ƒæ•´ä¸ºæœ€å¤§å † *//* int parent, child; int temp; temp = data[p]; //* å–å‡ºæ ¹ç»“ç‚¹å­˜æ”¾çš„å€¼ *//* for (parent = p; parent * 2 \u0026lt;= size; parent = child) { //è¿™ä¸ªè¿‡ç¨‹ä¸åˆ é™¤çš„è¿‡ç¨‹ä¸€æ · child = parent * 2; if ((child != size) \u0026amp;\u0026amp; (data[child] \u0026lt; data[child + 1])) child++; //* ChildæŒ‡å‘å·¦å³å­ç»“ç‚¹çš„è¾ƒå¤§è€… *//* if (temp \u0026gt;= data[child]) break; //* æ‰¾åˆ°äº†åˆé€‚ä½ç½® *//* else //* ä¸‹æ»¤X *//* data[parent] = data[child]; } data[parent] = temp; }  æœ€å°å † æœ€å°å †çš„å»ºç«‹å’Œæ“ä½œä¸æœ€å¤§å †å¤§è‡´ä¸Šæ˜¯ä¸€æ ·çš„ã€‚\npublic class MinHeap extends Heap{ public MinHeap(int maxSize, int sentinalVal) { super(maxSize, sentinalVal); } public MinHeap(int[] data, int maxSize, int sentinalVal) {//å“¨å…µå€¼ super(data, maxSize, sentinalVal); } public boolean insert(int element) { // å°†å…ƒç´ Xæ’å…¥æœ€å°å †Hï¼Œå…¶ä¸­H-\u0026gt;Data[0]å·²ç»å®šä¹‰ä¸ºå“¨å…µ int i; if (isFull()) { System.out.println(\u0026quot;æœ€å¤§å †å·²æ»¡\u0026quot;); return false; } i = ++this.size; // iæŒ‡å‘æ’å…¥åå †ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ çš„ä½ç½® for (; this.data[i / 2] \u0026gt; element; i /= 2) { data[i] = data[i / 2]; // å‘ä¸‹è¿‡æ»¤ç»“ç‚¹ï¼Œå¯¹è°ƒçˆ¶ç»“ç‚¹çš„ä½ç½® } data[i] = element; // å°†Xæ’å…¥ return true; } public int deleteMin() { // ä»æœ€å°å †ä¸­å–å‡ºé”®å€¼ä¸ºæœ€å°çš„å…ƒç´ ï¼Œå¹¶åˆ é™¤ä¸€ä¸ªç»“ç‚¹ int parent, child; int minItem, temp;//minItem-å †é¡¶å…ƒç´ ï¼Œtemp-ä¸´æ—¶å˜é‡ if (isEmpty()) { System.out.println(\u0026quot;æœ€å¤§å †å·²ç»ä¸ºç©º\u0026quot;); return -1; } minItem = this.data[1];//å–å‡ºæ ¹ç»“ç‚¹æœ€å°å€¼ // ç”¨æœ€å°å †ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ä»æ ¹ç»“ç‚¹å¼€å§‹å‘ä¸Šè¿‡æ»¤ä¸‹å±‚ç»“ç‚¹ temp = this.data[this.size--]; for (parent = 1; parent * 2 \u0026lt; this.size; parent = child) { child = parent * 2; // å·¦å„¿å­çš„ä½ç½® if (child != this.size \u0026amp;\u0026amp; this.data[child] \u0026gt; this.data[child + 1]) { child++; //child æŒ‡å‘å·¦å³ç»“ç‚¹çš„è¾ƒå°è€… } if (temp \u0026lt; this.data[child]) {//æ‰¾åˆ°ä½ç½®äº† break; } else {//å°†å­ç»“ç‚¹ä¸çˆ¶èŠ‚ç‚¹å¯¹æ¢ this.data[parent] = this.data[child]; } } this.data[parent] = temp; return minItem; } //*----------- å»ºé€ æœ€å°å † -----------*//* private void preDown(int p) { //* ä¸‹æ»¤ï¼šå°†Hä¸­ä»¥Data[p]ä¸ºæ ¹çš„å­å †è°ƒæ•´ä¸ºæœ€å°å † *//* int parent, child; int temp; temp = data[p]; //* å–å‡ºæ ¹ç»“ç‚¹å­˜æ”¾çš„å€¼ *//* for (parent = p; parent * 2 \u0026lt;= size; parent = child) { //è¿™ä¸ªè¿‡ç¨‹ä¸åˆ é™¤çš„è¿‡ç¨‹ä¸€æ · child = parent * 2; if ((child != size) \u0026amp;\u0026amp; (data[child] \u0026gt; data[child + 1])) child++; //* ChildæŒ‡å‘å·¦å³å­ç»“ç‚¹çš„è¾ƒå°è€… *//* if (temp \u0026lt;= data[child]) break; //* æ‰¾åˆ°äº†åˆé€‚ä½ç½® *//* else //* ä¸‹æ»¤X *//* data[parent] = data[child]; } data[parent] = temp; } public void buildHeap() { //* è°ƒæ•´Data[]ä¸­çš„å…ƒç´ ï¼Œä½¿æ»¡è¶³æœ€å¤§å †çš„æœ‰åºæ€§ *//* //* è¿™é‡Œå‡è®¾æ‰€æœ‰Sizeä¸ªå…ƒç´ å·²ç»å­˜åœ¨Data[]ä¸­ *//* int i; //* ä»æœ€åä¸€ä¸ªç»“ç‚¹çš„çˆ¶èŠ‚ç‚¹å¼€å§‹ï¼Œåˆ°æ ¹ç»“ç‚¹1 *//* for (i = this.size / 2; i \u0026gt; 0; i--) { preDown(i); } } }  æ€»ç»“ ä»å †çš„å‡ ç§æ“ä½œå¯ä»¥å‘ç°ï¼Œåˆ é™¤å’Œå»ºå †çš„è¿‡ç¨‹ï¼Œå°±æ˜¯ä»ä¸Šå¾€ä¸‹è°ƒæ•´å †çš„æœ‰åºæ€§çš„è¿‡ç¨‹ï¼Œæ’å…¥å…ƒç´ çš„è¿‡ç¨‹æ˜¯ä»ä¸‹å¾€ä¸Šè°ƒæ•´å †çš„æœ‰åºæ€§çš„è¿‡ç¨‹ã€‚\nå‚è€ƒ ã€1ã€‘æ•°æ®ç»“æ„-æµ™æ±Ÿå¤§å­¦\n","date":"2020å¹´09æœˆ15æ—¥","permalink":"https://ahamoment.cn/posts/algorithm/algorithm-heap/","summary":"ä»€ä¹ˆæ˜¯å † äº†è§£ä»€ä¹ˆæ˜¯å †ä¹‹å‰ï¼Œæˆ‘ä»¬çŸ¥é“é˜Ÿåˆ—çš„æ¦‚å¿µï¼Œé˜Ÿåˆ—çš„ç‰¹ç‚¹æ˜¯å…ˆè¿›å…ˆå‡ºï¼Œä½†æ˜¯æœ‰ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—ï¼Œå–å‡ºå…ƒç´ çš„é¡ºåºæ˜¯æŒ‰ç…§å…ƒç´ çš„ä¼˜å…ˆæƒï¼ˆå…³é”®å­—ï¼‰å¤§å°ï¼Œè€Œä¸æ˜¯å…ƒç´ è¿›å…¥é˜Ÿåˆ—çš„å…ˆåé¡ºåºï¼Œè¿™å°±æ˜¯ä¼˜å…ˆé˜Ÿåˆ—(Priority Queue)ã€‚\nè‹¥é‡‡ç”¨æ•°ç»„æˆ–è€…é“¾è¡¨å®ç°ä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ€»ä¼šæœ‰æ’å…¥ã€åˆ é™¤æˆ–è€…æŸ¥æ‰¾ä¸­çš„ä¸€é¡¹æ“ä½œçš„å¤æ‚åº¦æ˜¯$O(N)$ çš„ã€‚\nè‹¥é‡‡ç”¨äºŒå‰æœç´¢æ ‘å®ç°ï¼Œé‚£ä¹ˆæ’å…¥å’Œåˆ é™¤éƒ½è·Ÿæ ‘çš„é«˜åº¦æœ‰å…³ï¼Œä¹Ÿå°±æ˜¯$O(log_2N)$ çš„å¤æ‚åº¦ï¼Œä½†æ˜¯åˆ é™¤çš„æ—¶å€™ï¼Œç”±äºæ¯æ¬¡éƒ½è¦åˆ é™¤æœ€å¤§çš„æˆ–è€…æœ€å°çš„ï¼Œè¿™æ ·æ“ä½œå‡ æ¬¡åï¼Œä¼šé€ æˆæœç´¢æ ‘å¤±å»å¹³è¡¡ï¼Œæ‰€ä»¥ä¸èƒ½ç®€å•çš„ä½¿ç”¨äºŒå‰æœç´¢æ ‘ã€‚\nå¦‚æœé‡‡ç”¨äºŒå‰æ ‘ç»“æ„ï¼Œæˆ‘ä»¬æ›´å…³æ³¨çš„åº”è¯¥æ˜¯åˆ é™¤çš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬æŠŠæœ€å¤§çš„å€¼æ”¾åˆ°æ ¹ç»“ç‚¹ï¼Œå·¦å³ä¸¤è¾¹ä¹Ÿæ˜¯æœ€å¤§å€¼ä½œä¸ºå·¦å³å­æ ‘çš„æ ¹ç»“ç‚¹ï¼Œæ¯æ¬¡åˆ é™¤åªéœ€è¦åˆ é™¤æ ¹ç»“ç‚¹ã€‚åŒæ—¶ï¼Œä¸ºäº†ä¿è¯æ ‘çš„å¹³è¡¡æ€§ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å®Œå…¨äºŒå‰æ ‘æ¥å®ç°ä¼˜å…ˆé˜Ÿåˆ—ã€‚\nä¼˜å…ˆé˜Ÿåˆ—ä½¿ç”¨å®Œå…¨äºŒå‰æ ‘è¡¨ç¤ºå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ•°ç»„çš„ç¬¬ 0 ä¸ªå…ƒç´ ç©ºç€ï¼Œåé¢çš„æŒ‰ç…§å±‚åºéå†çš„é¡ºåºå­˜æ”¾åˆ°æ•°ç»„ä¸­ã€‚ä½¿ç”¨å®Œå…¨äºŒå‰å®ç°çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºå †ï¼Œå †çš„ç‰¹æ€§å¦‚ä¸‹ï¼š\n ç»“æ„æ€§ï¼šç”¨æ•°ç»„è¡¨ç¤ºçš„å®Œå…¨äºŒå‰æ ‘ã€‚ æœ‰åºæ€§ï¼šä»»ä¸€ç»“ç‚¹çš„å…³é”®å­—æ˜¯å…¶å­æ ‘æ‰€æœ‰ç»“ç‚¹çš„æœ€å¤§å€¼ï¼ˆæˆ–æœ€å°å€¼ï¼‰  \u0026ldquo;æœ€å¤§å †\u0026rdquo;ï¼Œä¹Ÿç§° \u0026ldquo;å¤§é¡¶å †\u0026rdquo;ï¼šå †é¡¶å…ƒç´ æ˜¯æ•´ä¸ªæ ‘çš„æœ€å¤§å€¼ \u0026ldquo;æœ€å°å †\u0026rdquo;ï¼Œä¹Ÿç§°\u0026quot;å°é¡¶å †\u0026quot;ï¼šå †é¡¶å…ƒç´ æ˜¯æ•´ä¸ªæ ‘çš„æœ€å°å€¼    å¦‚ä¸‹å›¾æ‰€ç¤ºçš„å‡ ä¸ªäºŒå‰æ ‘ï¼Œä¸æ˜¯å †ã€‚","title":"å †"},{"contents":"ç°åœ¨è¶Šæ¥è¶Šå¤šçš„å…¬å¸å°†æœåŠ¡é€šè¿‡å®¹å™¨æ¥éƒ¨ç½²ï¼Œä½†è¿™é‡Œå…¶å®å¯¹Javaçš„åº”ç”¨æœ‰ä¸€ä¸ªå‘ã€‚å¾ˆå¤šè¶…æ—¶æ•æ„Ÿçš„åº”ç”¨å…¶å®å¯¹GCçš„è¦æ±‚è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œå‡å°‘GCçš„æ—¶é—´å˜å¾—å¾ˆé‡è¦ï¼Œæ¯”å¦‚ä½ å¯ä»¥æ ¹æ®å½“å‰æœºå™¨çš„CPUæ ¸æ•°å¾—åˆ°ä¸€ä¸ªè¾ƒå¥½çš„å¹¶å‘GCçº¿ç¨‹æ•° -XX:ParallelGCThreadsï¼Œä»è€Œå‡å°‘STWçš„æ—¶é•¿ã€‚\nä½†åœ¨æ—©æœŸçš„JDKç‰ˆæœ¬ä¸­ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨çš„Jdk1.8u102ï¼Œå½“ä½ ä½¿ç”¨Javaçš„Runtimeè·å–CPUæ•°é‡æ—¶ï¼Œåœ¨å®¹å™¨é‡Œé¢ä¼šè¿”å›å®¹å™¨æ‰€åœ¨å®¿ä¸»æœºçš„æ ¸æ•°ï¼Œè€Œä¸æ˜¯å®¹å™¨è‡ªèº«çš„ï¼š\nint cores = Runtime.getRuntime().availableProcessors();  è¿™å…¶å®æ˜¯JDKçš„ä¸€ä¸ªé—®é¢˜ï¼Œå·²ç»traceåœ¨JDK-8140793ï¼ŒåŸå› æ˜¯è·å–CPUæ ¸æ•°æ˜¯é€šè¿‡è¯»å–ä¸¤ä¸ªç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­\n   ENV Description     _SC_NPROCESSORS_CONF number of processors configured   _SC_NPROCESSORS_ONLN The number of processors currently online (available)    å…¶ä¸­_SC_NPROCESSORS_CONF å°±æ˜¯æˆ‘ä»¬éœ€è¦å®¹å™¨çœŸå®çš„CPUæ•°é‡ã€‚ è·å–CPUæ•°é‡çš„æºç \næ€ä¹ˆè§£å†³ ç¬¬ä¸€ç§åŠæ³•æ˜¯ä½¿ç”¨æ–°ç‰ˆæœ¬çš„Jdku131ä»¥ä¸Šçš„ç‰ˆæœ¬1ã€‚\nå¦å¤–ä¸€ä¸ªåŠæ³•æ˜¯ä½¿ç”¨è‡ªç¼–è¯‘ä¸Šé¢çš„æºä»£ç ï¼Œé€šè¿‡LD_PRLOADçš„æ–¹å¼å°†ä¿®æ”¹åçš„soæ–‡ä»¶åŠ è½½è¿›å»Mockæ‰CPUçš„æ ¸æ•°\n Java SE support for Docker CPU and memory limits\n ","date":"2020å¹´09æœˆ11æ—¥","permalink":"https://ahamoment.cn/posts/cloud/cloud-container-get-cpu/","summary":"ç°åœ¨è¶Šæ¥è¶Šå¤šçš„å…¬å¸å°†æœåŠ¡é€šè¿‡å®¹å™¨æ¥éƒ¨ç½²ï¼Œä½†è¿™é‡Œå…¶å®å¯¹Javaçš„åº”ç”¨æœ‰ä¸€ä¸ªå‘ã€‚å¾ˆå¤šè¶…æ—¶æ•æ„Ÿçš„åº”ç”¨å…¶å®å¯¹GCçš„è¦æ±‚è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œå‡å°‘GCçš„æ—¶é—´å˜å¾—å¾ˆé‡è¦ï¼Œæ¯”å¦‚ä½ å¯ä»¥æ ¹æ®å½“å‰æœºå™¨çš„CPUæ ¸æ•°å¾—åˆ°ä¸€ä¸ªè¾ƒå¥½çš„å¹¶å‘GCçº¿ç¨‹æ•° -XX:ParallelGCThreadsï¼Œä»è€Œå‡å°‘STWçš„æ—¶é•¿ã€‚\nä½†åœ¨æ—©æœŸçš„JDKç‰ˆæœ¬ä¸­ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨çš„Jdk1.8u102ï¼Œå½“ä½ ä½¿ç”¨Javaçš„Runtimeè·å–CPUæ•°é‡æ—¶ï¼Œåœ¨å®¹å™¨é‡Œé¢ä¼šè¿”å›å®¹å™¨æ‰€åœ¨å®¿ä¸»æœºçš„æ ¸æ•°ï¼Œè€Œä¸æ˜¯å®¹å™¨è‡ªèº«çš„ï¼š\nint cores = Runtime.getRuntime().availableProcessors();  è¿™å…¶å®æ˜¯JDKçš„ä¸€ä¸ªé—®é¢˜ï¼Œå·²ç»traceåœ¨JDK-8140793ï¼ŒåŸå› æ˜¯è·å–CPUæ ¸æ•°æ˜¯é€šè¿‡è¯»å–ä¸¤ä¸ªç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­\n   ENV Description     _SC_NPROCESSORS_CONF number of processors configured   _SC_NPROCESSORS_ONLN The number of processors currently online (available)    å…¶ä¸­_SC_NPROCESSORS_CONF å°±æ˜¯æˆ‘ä»¬éœ€è¦å®¹å™¨çœŸå®çš„CPUæ•°é‡ã€‚ è·å–CPUæ•°é‡çš„æºç ","title":"å®¹å™¨å†…è·å– CPU æ ¸æ•°é—®é¢˜"},{"contents":"èƒŒæ™¯ æœ€è¿‘ç¢°åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæœ‰ä¸ªåº”ç”¨åœ¨å¯åŠ¨çš„æ—¶å€™ä¸€ç›´æŠ¥é”™ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š\njava: error while loading shared libraries: libjli.so: cannot open shared object file: No such file or directory  é”™è¯¯ä¿¡æ¯æ˜¯è¯´ java åº”ç”¨åŠ è½½ä¸åˆ° libjli.so æ–‡ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ java -version å‘½ä»¤ï¼ŒåŒæ ·çš„é”™è¯¯åˆå‡ºç°äº†ã€‚ä½¿ç”¨ ldd å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹ java åº”ç”¨æ˜¯å¦åŠ è½½äº†è¿™ä¸ª so æ–‡ä»¶ï¼Œå‘ç° java åº”ç”¨åŠ è½½çš„ so æ–‡ä»¶ä¸­å­˜åœ¨ libjli.soã€‚\n$ ldd java linux-vdso.so.1 =\u0026gt; (0x00007ffe2a9c7000) /usr/local/lib/libsysconfcpus.so (0x00002ac503ca8000) libz.so.1 =\u0026gt; /lib64/libz.so.1 (0x00002ac503eaa000) libjli.so =\u0026gt; /apps/svr/jdk-14.0.1/bin/./../lib/libjli.so (0x00002ac5040c0000) libpthread.so.0 =\u0026gt; /lib64/libpthread.so.0 (0x00002ac5042d1000) libdl.so.2 =\u0026gt; /lib64/libdl.so.2 (0x00002ac5044ee000) libc.so.6 =\u0026gt; /lib64/libc.so.6 (0x00002ac5046f2000) /lib64/ld-linux-x86-64.so.2 (0x00002ac503883000)  æˆ‘ä»¬æ¥ç€æŸ¥çœ‹äº† LD_LIBRARY_PATH å’Œ /etc/ld.so.conf.d/xxx.conf æ–‡ä»¶çš„é…ç½®ï¼Œå‘ç°éƒ½æ˜¯æ­£å¸¸çš„ã€‚é€šè¿‡å¯¹æ¯”å…¶ä»–åº”ç”¨çš„å¯åŠ¨é…ç½®ï¼Œå‘ç°è¯¥åº”ç”¨ä½¿ç”¨äº† 80 ç«¯å£å¯åŠ¨ï¼Œä½†æ˜¯æˆ‘ä»¬çš„å®¹å™¨åªèƒ½ä½¿ç”¨ apps æƒé™ç™»å½•ï¼Œæ‰€ä»¥åœ¨å¯åŠ¨å‰ä½¿ç”¨ setcap å‘½ä»¤æå‡äº† java åº”ç”¨çš„æƒé™ï¼Œå…è®¸å…¶ä½¿ç”¨ 80 ç«¯å£ï¼Œä¼šä¸ä¼šæ˜¯è¿™ä¸ªæ“ä½œå¯¼è‡´çš„å‘¢ï¼Ÿåœ¨æŸ¥çœ‹åŸå› ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£å‡ ä¸ªæ¦‚å¿µã€‚\nLinux åŠ¨æ€åº“ åŠ¨æ€åº“(å…±äº«åº“)çš„ä»£ç åœ¨å¯æ‰§è¡Œç¨‹åºè¿è¡Œæ—¶æ‰è½½å…¥å†…å­˜ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä»…ç®€å•çš„å¼•ç”¨ï¼Œä¸åŒçš„åº”ç”¨ç¨‹åºå¦‚æœè°ƒç”¨ç›¸åŒçš„åº“,é‚£ä¹ˆåœ¨å†…å­˜ä¸­åªéœ€è¦æœ‰ä¸€ä»½è¯¥åŠ¨æ€åº“(å…±äº«åº“)çš„å®ä¾‹ã€‚è¿™ç±»åº“çš„åå­—ä¸€èˆ¬æ˜¯libxxx.soï¼Œå…¶ä¸­soæ˜¯ Shared Object çš„ç¼©å†™ï¼Œå³å¯ä»¥å…±äº«çš„ç›®æ ‡æ–‡ä»¶ã€‚åœ¨é“¾æ¥åŠ¨æ€åº“ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œå¹¶ä¸ä¼šæŠŠåŠ¨æ€åº“çš„ä»£ç å¤åˆ¶åˆ°æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯åœ¨æ‰§è¡Œæ–‡ä»¶ä¸­è®°å½•å¯¹åŠ¨æ€åº“çš„å¼•ç”¨ã€‚\nLinuxä¸‹ç”Ÿæˆå’Œä½¿ç”¨åŠ¨æ€åº“çš„æ­¥éª¤å¦‚ä¸‹ï¼š\n ç¼–å†™æºæ–‡ä»¶ã€‚ å°†ä¸€ä¸ªæˆ–å‡ ä¸ªæºæ–‡ä»¶ç¼–è¯‘é“¾æ¥ï¼Œç”Ÿæˆå…±äº«åº“ã€‚ é€šè¿‡ -L -lxxx çš„gccé€‰é¡¹é“¾æ¥ç”Ÿæˆçš„libxxx.soã€‚ä¾‹å¦‚gcc -fPIC -shared -o libmax.so max.c , -fPIC æ˜¯ç¼–è¯‘é€‰é¡¹ï¼ŒPICæ˜¯ Position Independent Code çš„ç¼©å†™ï¼Œè¡¨ç¤ºè¦ç”Ÿæˆä½ç½®æ— å…³çš„ä»£ç ï¼Œè¿™æ˜¯åŠ¨æ€åº“éœ€è¦çš„ç‰¹æ€§ï¼› -shared æ˜¯é“¾æ¥é€‰é¡¹ï¼Œå‘Šè¯‰gccç”ŸæˆåŠ¨æ€åº“è€Œä¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ æŠŠlibxxx.soæ”¾å…¥é“¾æ¥åº“çš„æ ‡å‡†è·¯å¾„ï¼Œæˆ–æŒ‡å®š LD_LIBRARY_PATHï¼Œæ‰èƒ½è¿è¡Œé“¾æ¥äº†libxxx.soçš„ç¨‹åºã€‚  Linuxæ˜¯é€šè¿‡ /etc/ld.so.cache æ–‡ä»¶æœå¯»è¦é“¾æ¥çš„åŠ¨æ€åº“çš„ã€‚è€Œ /etc/ld.so.cache æ˜¯ ldconfig ç¨‹åºè¯»å– /etc/ld.so.conf æ–‡ä»¶ç”Ÿæˆçš„ã€‚ ï¼ˆæ³¨æ„ï¼Œ /etc/ld.so.conf ä¸­å¹¶ä¸å¿…åŒ…å« /lib å’Œ /usr/libï¼Œldconfigç¨‹åºä¼šè‡ªåŠ¨æœç´¢è¿™ä¸¤ä¸ªç›®å½•ï¼‰\næˆ‘ä»¬æŠŠè¦ç”¨çš„ libxx.so æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„æ·»åŠ åˆ° /etc/ld.so.conf ä¸­ï¼Œå†ä»¥rootæƒé™è¿è¡Œ ldconfig ç¨‹åºï¼Œæ›´æ–° /etc/ld.so.cache ï¼Œç¨‹åºè¿è¡Œæ—¶ï¼Œå°±å¯ä»¥æ‰¾åˆ° libxx.soã€‚å¦å¤–å°±æ˜¯é€šè¿‡é…ç½® LD_LIBRARY_PATH çš„æ–¹å¼æ¥æŒ‡å®šé€šè¿‡æŸäº›è·¯å¾„å¯»æ‰¾é“¾æ¥çš„åŠ¨æ€åº“ã€‚\nldd æŸ¥çœ‹ç¨‹åºä¾èµ– ç†è§£äº†åŠ¨æ€åº“çš„æ¦‚å¿µä¹‹åï¼Œå½“ç¢°åˆ°æŸä¸ªç¨‹åºæŠ¥é”™ç¼ºå°‘æŸä¸ªåº“æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆæŸ¥çœ‹è¯¥ç¨‹åºå½“å‰åŠ è½½äº†å“ªäº›åº“æ–‡ä»¶å‘¢ï¼Ÿå¯ä»¥ç”¨ ldd å‘½ä»¤ã€‚\nldd å‘½ä»¤çš„ä½œç”¨æ˜¯ç”¨æ¥æŸ¥çœ‹ç¨‹å¼è¿è¡Œæ‰€éœ€çš„å…±äº«åº“,å¸¸ç”¨æ¥è§£å†³ç¨‹å¼å› ç¼ºå°‘æŸä¸ªåº“æ–‡ä»¶è€Œä¸èƒ½è¿è¡Œçš„ä¸€äº›é—®é¢˜ã€‚\nä¾‹å¦‚ï¼šæŸ¥çœ‹testç¨‹åºè¿è¡Œæ‰€ä¾èµ–çš„åº“:\n[root@localhost testso]# ldd /etc/alternatives/java linux-vdso.so.1 =\u0026gt; (0x00007ffde15f8000) libpthread.so.0 =\u0026gt; /lib64/libpthread.so.0 (0x00007f03f2f8d000) libdl.so.2 =\u0026gt; /lib64/libdl.so.2 (0x00007f03f2d89000) libc.so.6 =\u0026gt; /lib64/libc.so.6 (0x00007f03f29bb000) /lib64/ld-linux-x86-64.so.2 (0x00007f03f33ab000)   ç¬¬ä¸€åˆ—ï¼šç¨‹åºéœ€è¦ä¾èµ–ä»€ä¹ˆåº“ ç¬¬äºŒåˆ—: ç³»ç»Ÿæä¾›çš„ä¸ç¨‹åºéœ€è¦çš„åº“æ‰€å¯¹åº”çš„åº“ ç¬¬ä¸‰åˆ—ï¼šåº“åŠ è½½çš„å¼€å§‹åœ°å€  é€šè¿‡ä¸Šé¢çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹å‡ ä¸ªä¿¡æ¯ï¼š\n é€šè¿‡å¯¹æ¯”ç¬¬ä¸€åˆ—å’Œç¬¬äºŒåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æç¨‹åºéœ€è¦ä¾èµ–çš„åº“å’Œç³»ç»Ÿå®é™…æä¾›çš„ï¼Œæ˜¯å¦ç›¸åŒ¹é… é€šè¿‡è§‚å¯Ÿç¬¬ä¸‰åˆ—ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨å½“å‰çš„åº“ä¸­çš„ç¬¦å·åœ¨å¯¹åº”çš„è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­çš„å¼€å§‹ä½ç½®  å¦‚æœä¾èµ–çš„æŸä¸ªåº“æ‰¾ä¸åˆ°ï¼Œé€šè¿‡è¿™ä¸ªå‘½ä»¤å¯ä»¥è¿…é€Ÿå®šä½é—®é¢˜æ‰€åœ¨.\nLinux capability ä»å†…æ ¸ 2.2 å¼€å§‹ï¼ŒLinux å°†ä¼ ç»Ÿä¸Šä¸è¶…çº§ç”¨æˆ· root å…³è”çš„ç‰¹æƒåˆ’åˆ†ä¸ºä¸åŒçš„å•å…ƒï¼Œç§°ä¸º capabilitesã€‚Capabilites ä½œä¸ºçº¿ç¨‹(Linux å¹¶ä¸çœŸæ­£åŒºåˆ†è¿›ç¨‹å’Œçº¿ç¨‹)çš„å±æ€§å­˜åœ¨ï¼Œæ¯ä¸ªå•å…ƒå¯ä»¥ç‹¬ç«‹å¯ç”¨å’Œç¦ç”¨ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œæƒé™æ£€æŸ¥çš„è¿‡ç¨‹å°±å˜æˆäº†ï¼šåœ¨æ‰§è¡Œç‰¹æƒæ“ä½œæ—¶ï¼Œå¦‚æœè¿›ç¨‹çš„æœ‰æ•ˆèº«ä»½ä¸æ˜¯ rootï¼Œå°±å»æ£€æŸ¥æ˜¯å¦å…·æœ‰è¯¥ç‰¹æƒæ“ä½œæ‰€å¯¹åº”çš„ capabilitesï¼Œå¹¶ä»¥æ­¤å†³å®šæ˜¯å¦å¯ä»¥è¿›è¡Œè¯¥ç‰¹æƒæ“ä½œã€‚\nä¸‹é¢æ˜¯ä» capabilities man page ä¸­æ‘˜å–çš„ capabilites åˆ—è¡¨ï¼š\n   capability åç§° æè¿°     CAP_AUDIT_CONTROL å¯ç”¨å’Œç¦ç”¨å†…æ ¸å®¡è®¡ï¼›æ”¹å˜å®¡è®¡è¿‡æ»¤è§„åˆ™ï¼›æ£€ç´¢å®¡è®¡çŠ¶æ€å’Œè¿‡æ»¤è§„åˆ™   CAP_AUDIT_READ å…è®¸é€šè¿‡ multicast netlink å¥—æ¥å­—è¯»å–å®¡è®¡æ—¥å¿—   CAP_AUDIT_WRITE å°†è®°å½•å†™å…¥å†…æ ¸å®¡è®¡æ—¥å¿—   CAP_BLOCK_SUSPEND ä½¿ç”¨å¯ä»¥é˜»æ­¢ç³»ç»ŸæŒ‚èµ·çš„ç‰¹æ€§   CAP_CHOWN ä¿®æ”¹æ–‡ä»¶æ‰€æœ‰è€…çš„æƒé™   CAP_DAC_OVERRIDE å¿½ç•¥æ–‡ä»¶çš„ DAC è®¿é—®é™åˆ¶   CAP_DAC_READ_SEARCH å¿½ç•¥æ–‡ä»¶è¯»åŠç›®å½•æœç´¢çš„ DAC è®¿é—®é™åˆ¶   CAP_FOWNER å¿½ç•¥æ–‡ä»¶å±ä¸» ID å¿…é¡»å’Œè¿›ç¨‹ç”¨æˆ· ID ç›¸åŒ¹é…çš„é™åˆ¶   CAP_FSETID å…è®¸è®¾ç½®æ–‡ä»¶çš„ setuid ä½   CAP_IPC_LOCK å…è®¸é”å®šå…±äº«å†…å­˜ç‰‡æ®µ   CAP_IPC_OWNER å¿½ç•¥ IPC æ‰€æœ‰æƒæ£€æŸ¥   CAP_KILL å…è®¸å¯¹ä¸å±äºè‡ªå·±çš„è¿›ç¨‹å‘é€ä¿¡å·   CAP_LEASE å…è®¸ä¿®æ”¹æ–‡ä»¶é”çš„ FL_LEASE æ ‡å¿—   CAP_LINUX_IMMUTABLE å…è®¸ä¿®æ”¹æ–‡ä»¶çš„ IMMUTABLE å’Œ APPEND å±æ€§æ ‡å¿—   CAP_MAC_ADMIN å…è®¸ MAC é…ç½®æˆ–çŠ¶æ€æ›´æ”¹   CAP_MAC_OVERRIDE è¦†ç›– MAC(Mandatory Access Control)   CAP_MKNOD å…è®¸ä½¿ç”¨ mknod() ç³»ç»Ÿè°ƒç”¨   CAP_NET_ADMIN å…è®¸æ‰§è¡Œç½‘ç»œç®¡ç†ä»»åŠ¡   CAP_NET_BIND_SERVICE å…è®¸ç»‘å®šåˆ°å°äº 1024 çš„ç«¯å£   CAP_NET_BROADCAST å…è®¸ç½‘ç»œå¹¿æ’­å’Œå¤šæ’­è®¿é—®   CAP_NET_RAW å…è®¸ä½¿ç”¨åŸå§‹å¥—æ¥å­—   CAP_SETGID å…è®¸æ”¹å˜è¿›ç¨‹çš„ GID   CAP_SETFCAP å…è®¸ä¸ºæ–‡ä»¶è®¾ç½®ä»»æ„çš„ capabilities   CAP_SETPCAP å‚è€ƒ capabilities man page   CAP_SETUID å…è®¸æ”¹å˜è¿›ç¨‹çš„ UID   CAP_SYS_ADMIN å…è®¸æ‰§è¡Œç³»ç»Ÿç®¡ç†ä»»åŠ¡ï¼Œå¦‚åŠ è½½æˆ–å¸è½½æ–‡ä»¶ç³»ç»Ÿã€è®¾ç½®ç£ç›˜é…é¢ç­‰   CAP_SYS_BOOT å…è®¸é‡æ–°å¯åŠ¨ç³»ç»Ÿ   CAP_SYS_CHROOT å…è®¸ä½¿ç”¨ chroot() ç³»ç»Ÿè°ƒç”¨   CAP_SYS_MODULE å…è®¸æ’å…¥å’Œåˆ é™¤å†…æ ¸æ¨¡å—   CAP_SYS_NICE å…è®¸æå‡ä¼˜å…ˆçº§åŠè®¾ç½®å…¶ä»–è¿›ç¨‹çš„ä¼˜å…ˆçº§   CAP_SYS_PACCT å…è®¸æ‰§è¡Œè¿›ç¨‹çš„ BSD å¼å®¡è®¡   CAP_SYS_PTRACE å…è®¸è·Ÿè¸ªä»»ä½•è¿›ç¨‹   CAP_SYS_RAWIO å…è®¸ç›´æ¥è®¿é—® /devportã€/dev/memã€/dev/kmem åŠåŸå§‹å—è®¾å¤‡   CAP_SYS_RESOURCE å¿½ç•¥èµ„æºé™åˆ¶   CAP_SYS_TIME å…è®¸æ”¹å˜ç³»ç»Ÿæ—¶é’Ÿ   CAP_SYS_TTY_CONFIG å…è®¸é…ç½® TTY è®¾å¤‡   CAP_SYSLOG å…è®¸ä½¿ç”¨ syslog() ç³»ç»Ÿè°ƒç”¨   CAP_WAKE_ALARM å…è®¸è§¦å‘ä¸€äº›èƒ½å”¤é†’ç³»ç»Ÿçš„ä¸œè¥¿(æ¯”å¦‚ CLOCK_BOOTTIME_ALARM è®¡æ—¶å™¨)    getcap å‘½ä»¤å’Œ setcap å‘½ä»¤åˆ†åˆ«ç”¨æ¥æŸ¥çœ‹å’Œè®¾ç½®ç¨‹åºæ–‡ä»¶çš„ capabilities å±æ€§ã€‚\nä¾‹å¦‚ä¸º ping å‘½ä»¤æ–‡ä»¶æ·»åŠ  capabilities\næ‰§è¡Œ ping å‘½ä»¤æ‰€éœ€çš„ capabilities ä¸º cap_net_admin å’Œ cap_net_rawï¼Œé€šè¿‡ setcap å‘½ä»¤å¯ä»¥æ·»åŠ å®ƒä»¬ï¼š\n$ sudo setcap cap_net_admin,cap_net_raw+ep /bin/ping  ç§»é™¤æ·»åŠ çš„ capabilities ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š\n$ sudo setcap cap_net_admin,cap_net_raw-ep /bin/ping  å‘½ä»¤ä¸­çš„ ep åˆ†åˆ«è¡¨ç¤º Effective å’Œ Permitted é›†åˆ(æ¥ä¸‹æ¥ä¼šä»‹ç»)ï¼Œ+ å·è¡¨ç¤ºæŠŠæŒ‡å®šçš„ capabilities æ·»åŠ åˆ°è¿™äº›é›†åˆä¸­ï¼Œ- å·è¡¨ç¤ºä»é›†åˆä¸­ç§»é™¤(å¯¹äº Effective æ¥è¯´æ˜¯è®¾ç½®æˆ–è€…æ¸…é™¤ä½)ã€‚\nè§£å†³é—®é¢˜ å›åˆ°æˆ‘ä»¬å¼€å§‹çš„é—®é¢˜ï¼Œç”±äºæˆ‘ä»¬ä¸ºé root ç”¨æˆ·èµ‹äºˆäº†ä½¿ç”¨ 80 ç«¯å£çš„æƒé™ï¼Œè°ƒç”¨äº†å¦‚ä¸‹å‘½ä»¤ï¼š\nsetcap cap_net_bind_service=+ep /usr/bin/java  å½“ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æå‡äº†æƒé™åï¼Œè¿è¡Œæ—¶åŠ è½½ç¨‹åºï¼ˆrtldï¼‰â€” ld.soï¼Œå®ƒä¸ä¼šä¸ä¸å—ä¿¡ä»»è·¯å¾„ä¸­çš„åº“é“¾æ¥ã€‚Linux ä¼šä¸ºä½¿ç”¨äº† setcap æˆ– suid çš„ç¨‹åºç¦ç”¨æ‰ LD_LIBRARY_PATHã€‚æ‰€ä»¥å°±å‡ºç°äº† java ç¨‹åºåŠ è½½ä¸åˆ° libjli.so çš„æƒ…å†µäº†ï¼Œè¿™æ˜¯ JDK çš„ä¸€ä¸ª bugã€‚\n JDK-7157699 : can not run java after granting posix capabilities\n é‚£ä¹ˆæ—¢ç„¶ä½¿ç”¨ setcap åä¸ä¼šåŠ è½½é“¾æ¥åº“ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°† libjli.so æ‰€åœ¨çš„è·¯å¾„æ·»åŠ åˆ° /etc/ld.so.conf/xxx.confä¸­ï¼Œä¾‹å¦‚ï¼š\n% cat /etc/ld.so.conf.d/java.conf /usr/java/jdk1.8.0_261-amd64/lib/amd64/jli  ä½¿ç”¨ ldconfig é‡è½½ so æ–‡ä»¶ã€‚\n[root@localhost jli]# ldconfig -p | grep libjli libjli.so (libc6,x86-64) =\u0026gt; /usr/java/jdk1.8.0_261-amd64/lib/amd64/jli/libjli.so% ldconfig | grep libjli libjli.so -\u0026gt; libjli.so .......  è¿™æ ·å†æ¬¡æµ‹è¯•å°±å¯ä»¥äº†ã€‚\nå‚è€ƒæ–‡ç«  ã€1ã€‘LinuxåŠ¨æ€åº“ç”Ÿæˆä¸ä½¿ç”¨æŒ‡å—\nã€2ã€‘ldd æŸ¥çœ‹ç¨‹åºä¾èµ–åº“\nã€3ã€‘Linux Capabiliites ç®€ä»‹\nã€4ã€‘capabilities(7) - Linux man page\nã€5ã€‘å¦‚ä½•å…è®¸é root è¿›ç¨‹ç»‘å®šä½ä½ç«¯å£\nã€6ã€‘[How to get Oracle java 7 to work with setcap cap_net_bind_service+ep](https://unix.stackexchange.com/questions/87978/how-to-get-oracle-java-7-to-work-with-setcap-cap-net-bind-serviceep)\n","date":"2020å¹´09æœˆ11æ—¥","permalink":"https://ahamoment.cn/posts/linux/linux-cap/","summary":"èƒŒæ™¯ æœ€è¿‘ç¢°åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæœ‰ä¸ªåº”ç”¨åœ¨å¯åŠ¨çš„æ—¶å€™ä¸€ç›´æŠ¥é”™ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š\njava: error while loading shared libraries: libjli.so: cannot open shared object file: No such file or directory  é”™è¯¯ä¿¡æ¯æ˜¯è¯´ java åº”ç”¨åŠ è½½ä¸åˆ° libjli.","title":"è§£å†³setcapå¯¼è‡´JavaåŠ è½½libjli.so å¤±è´¥é—®é¢˜"},{"contents":"å¹³è¡¡äºŒå‰æ ‘ å¹³è¡¡äºŒå‰æ ‘ä¹Ÿæ˜¯ä¸€ç§æœç´¢æ ‘ã€‚\næœç´¢æ ‘èŠ‚ç‚¹ä¸åŒæ’å…¥æ¬¡åºï¼Œå°†å¯¼è‡´ä¸åŒçš„æ·±åº¦å’Œå¹³å‡æŸ¥æ‰¾é•¿åº¦ ASLã€‚\nå¹³è¡¡å› å­ï¼ˆBalance Factorï¼‰:BF(T)=hL-hRï¼Œå…¶ä¸­hLå’ŒhRåˆ†åˆ«æ˜¯Tçš„å·¦å³å­æ ‘çš„é«˜åº¦ã€‚å¹³è¡¡äºŒå‰æ ‘ï¼ˆBalanced Binary Tree) åˆå« AVLæ ‘ï¼Œå½“æ ‘ä¸ä¸ºç©ºæ—¶ï¼Œåœ¨ä»»ä¸€èŠ‚ç‚¹å·¦ï¼Œå³å­æ ‘é«˜åº¦å·®çš„ç»å¯¹å€¼ä¸è¶…è¿‡1ï¼Œå³ |BF(T)|\u0026lt;=1ã€‚\nå¹³è¡¡äºŒå‰æ ‘çš„é«˜åº¦èƒ½å¤Ÿè¾¾åˆ° $log_2n$\nå¹³è¡¡äºŒå‰æ ‘çš„è°ƒæ•´ ä»»ä½•æƒ…å†µéƒ½å¯ä»¥å½’ç»“ä¸ºå››ç§æ¨¡å¼ã€‚æ ¹æ®æ’å…¥èŠ‚ç‚¹çš„ä½ç½®ä¸åŒä½¿ç”¨ä¸åŒçš„æŸ¥æ‰¾æ–¹æ³•ï¼ŒåŒæ—¶è®°ä½å¹³è¡¡äºŒå‰æ ‘æ˜¯æœç´¢æ ‘ï¼ŒèŠ‚ç‚¹å°äºå·¦è¾¹å¤§äºå³è¾¹ã€‚å¹³è¡¡äºŒå‰æ ‘çš„å››ç§è°ƒæ•´æ–¹æ³•ä¸ºï¼šå³å•æ—‹ï¼Œå·¦å•æ—‹ï¼Œå³å·¦åŒæ—‹ï¼Œå·¦å³åŒæ—‹ã€‚\nå³å•æ—‹ æŒ‰ç…§å­—æ¯å¤§å°æ’å…¥ä¸‰ä¸ªç»“ç‚¹ï¼ŒMar, May, Novï¼š\nå¦‚ä¸Šå›¾å·¦è¾¹æ‰€ç¤ºï¼Œåœ¨æ’å…¥ Nov ç»“ç‚¹åï¼ŒäºŒå‰æ ‘çš„å¹³è¡¡è¢«ç ´åï¼Œç»“ç‚¹Mar çš„å¹³è¡¡å› å­ä¸º -2ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ç§° Mar ä¸ºä¸å¹³è¡¡çš„å‘ç°è€…ï¼Œéº»çƒ¦èŠ‚ç‚¹ Nov åœ¨å‘ç°è€…å³å­æ ‘çš„å³è¾¹ï¼Œéœ€è¦RRæ—‹è½¬ï¼ˆå³å•æ—‹ï¼‰ã€‚\nå³å•æ—‹çš„è¿‡ç¨‹å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå°† B ç»“ç‚¹è°ƒæ•´ä¸ºè·Ÿç»“ç‚¹ï¼Œ$B_L$ è°ƒæ•´ä¸º A çš„å³ç»“ç‚¹ã€‚ä¸Šå›¾æ‰€ç¤ºçš„æ˜¯æ’å…¥åˆ°å³å­æ ‘çš„å³å­æ ‘çš„å³è¾¹æ—¶ï¼Œå½“æ’å…¥åˆ°å³å­æ ‘çš„å³å­æ ‘çš„ä½ç½®ä¸åŒæ—¶æ€ä¹ˆå¤„ç†ï¼Ÿæ¥çœ‹ä¸ªä¾‹å­ï¼š\nç»“ç‚¹æ’åˆ°å·¦è¾¹å’Œå³è¾¹çš„æ—¶å€™ï¼Œè°ƒæ•´å¹³è¡¡åä½ç½®è¿˜æ˜¯ä¸å˜ã€‚\n// å³å•æ—‹ public AVLTree\u0026lt;T\u0026gt; singleRightRotation(AVLTree\u0026lt;T\u0026gt; a) { // æ³¨æ„ï¼šA å¿…é¡»æœ‰ä¸€ä¸ªå³å­èŠ‚ç‚¹B // å°† A ä¸ B åšå³å•æ—‹ï¼Œæ›´æ–°Aä¸Bçš„é«˜åº¦ï¼Œè¿”å›æ–°çš„æ ¹ç»“ç‚¹B AVLTree\u0026lt;T\u0026gt; b = a.right; a.right = b.left; b.left = a; a.height = Math.max(postOrderGetHight(a.left), postOrderGetHight(a.right)); b.height = Math.max(postOrderGetHight(b.right), a.height); return b; }  å·¦å•æ—‹ å·¦å•æ—‹ä¸å³å•æ—‹ç±»ä¼¼ï¼Œéº»çƒ¦ç»“ç‚¹åœ¨å‘ç°è€…çš„å·¦å­æ ‘çš„å·¦è¾¹ï¼Œå› è€Œå«LLæ’å…¥ï¼Œéœ€è¦ LL æ—‹è½¬ï¼ˆå·¦å•æ—‹ï¼‰ã€‚\nä¸Šå›¾æ˜¯å·¦å•æ—‹çš„è°ƒæ•´è¿‡ç¨‹ã€‚æ³¨æ„ï¼Œå¯¹äºè°ƒæ•´ï¼Œåªéœ€è¦ä»æœ€ä¸‹å±‚çš„å¼€å§‹è°ƒæ•´å°±è¡Œã€‚ä¸‹å±‚å¹³è¡¡äº†ï¼Œä¸Šå±‚è‡ªç„¶ä¹Ÿä¼šå¹³è¡¡ã€‚\n// å·¦å•æ—‹(LLæ—‹è½¬) public AVLTree\u0026lt;T\u0026gt; singleLeftRotation(AVLTree\u0026lt;T\u0026gt; a) { // æ³¨æ„ï¼šAå¿…é¡»æœ‰ä¸€ä¸ªå·¦å­ç»“ç‚¹B //å°† Aä¸Båšå·¦å•æ—‹ï¼Œæ›´æ–°Aä¸Bçš„é«˜åº¦ï¼Œè¿”å›æ–°çš„æ ¹ç»“ç‚¹B AVLTree\u0026lt;T\u0026gt; b = a.left; a.left = b.right; b.right = a; a.height = Math.max(postOrderGetHight(a.left), postOrderGetHight(a.right)); b.height = Math.max(postOrderGetHight(b.left), a.height); return b; }  å·¦å³åŒæ—‹ å¯¹äºå·¦å³åŒæ—‹ï¼Œéº»çƒ¦ç»“ç‚¹å‡ºç°åœ¨å·¦å­æ ‘çš„å³è¾¹ï¼Œå› è€Œå« LR æ’å…¥ï¼Œéœ€è¦åš LR æ—‹è½¬ã€‚\nå½“æ’å…¥çš„ç»“ç‚¹åœ¨ C çš„å·¦å­æ ‘æˆ–è€…å³å­æ ‘ä¸‹è¾¹æ—¶ï¼Œå°±éœ€è¦å·¦å³åŒæ—‹ï¼Œå·¦å³åŒæ—‹å¯ä»¥çœ‹æˆåšäº†ä¸¤æ¬¡å•æ—‹ï¼Œç›®çš„æ˜¯è°ƒæ•´ A,B,C è¿™ä¸‰ä¸ªç»“ç‚¹çš„ä½ç½®ã€‚å…ˆå°†Bå’ŒC åšä¸€æ¬¡å³å•æ—‹ï¼Œå†å°† C å’Œ A åšä¸€æ¬¡å·¦å•æ—‹ã€‚\npublic AVLTree\u0026lt;T\u0026gt; doubleLeftRightRotation(AVLTree\u0026lt;T\u0026gt; a) { // æ³¨æ„ï¼šAå¿…é¡»æœ‰ä¸€ä¸ªå·¦å­èŠ‚ç‚¹Bï¼Œä¸”Bå¿…é¡»æœ‰ä¸€ä¸ªå³å­èŠ‚ç‚¹C // å°†Aã€Bä¸Cåšä¸¤æ¬¡å•æ—‹ï¼Œè¿”å›æ–°çš„æ ¹ç»“ç‚¹C // å°†Bä¸Cåšå³å•æ—‹ï¼ŒCè¢«è¿”å› a.left = singleLeftRotation(a.left); // å°†Aä¸Cåšå·¦å•æ—‹ï¼ŒCè¢«è¿”å› return singleLeftRotation(a); }  å³å·¦åŒæ—‹ å³å·¦åŒæ—‹æ—¶ï¼Œéº»çƒ¦ç»“ç‚¹å‡ºç°åœ¨å³å­æ ‘çš„å·¦è¾¹ï¼Œå› è€Œåˆå« RL æ’å…¥ã€‚\nåŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯å°†å³å·¦åŒæ—‹çœ‹æˆæ˜¯ä¸¤æ¬¡å•æ—‹ï¼Œå°† B å’Œ C åšå·¦å•æ—‹ï¼Œå†å°† A ä¸ C åšå³å•æ—‹ã€‚\npublic AVLTree\u0026lt;T\u0026gt; doubleRightLeftRotation(AVLTree\u0026lt;T\u0026gt; a) { // æ³¨æ„ï¼šAå¿…é¡»æœ‰ä¸€ä¸ªå³å­èŠ‚ç‚¹Bï¼Œä¸”Bå¿…é¡»æœ‰ä¸€ä¸ªå·¦å­èŠ‚ç‚¹C // å°†Aã€Bä¸Cåšä¸¤æ¬¡å•æ—‹ï¼Œè¿”å›æ–°çš„æ ¹ç»“ç‚¹C // å°†Bä¸Cåšå·¦å•æ—‹ï¼ŒCè¢«è¿”å› a.right = singleRightRotation(a.right); // å°†Aä¸Cåšå³å•æ—‹ï¼ŒCè¢«è¿”å› return singleLeftRotation(a); }  æ³¨æ„è°ƒæ•´æ—¶ï¼Œå¯èƒ½èŠ‚ç‚¹çš„ä½ç½®ä¸å˜ï¼Œä½†æ˜¯å¹³è¡¡å› å­éœ€è¦æ›´æ–°ã€‚\næœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¹³è¡¡äºŒå‰æ ‘çš„æ’å…¥ï¼Œæ¯ä¸€æ¬¡çš„æ’å…¥éƒ½è¦åˆ¤æ–­å¹³è¡¡æ˜¯å¦è¢«ç ´åï¼Œå¦‚æœå‘ç°æ ‘çš„å¹³è¡¡è¢«ç ´åï¼Œæ ¹æ®æ’å…¥çš„ä½ç½®åšä¸Šé¢çš„å››ç§æ—‹è½¬é‡æ–°è°ƒæ•´æˆå¹³è¡¡äºŒå‰æ ‘ã€‚\npublic AVLTree\u0026lt;T\u0026gt; insert(AVLTree\u0026lt;T\u0026gt; t, T x) { /* å°†Xæ’å…¥AVLæ ‘Tä¸­ï¼Œå¹¶ä¸”è¿”å›è°ƒæ•´åçš„AVLæ ‘ */ if (t != null) { /* è‹¥æ’å…¥ç©ºæ ‘ï¼Œåˆ™æ–°å»ºåŒ…å«ä¸€ä¸ªç»“ç‚¹çš„æ ‘ */ t = new AVLTree\u0026lt;\u0026gt;(x, null, null); t.height = 0; } /* if (æ’å…¥ç©ºæ ‘) ç»“æŸ */ else if (x.compareTo(t.data) \u0026lt; 0) { /* æ’å…¥Tçš„å·¦å­æ ‘ */ t.left = insert(t.left, x); /* å¦‚æœéœ€è¦å·¦æ—‹ */ if (postOrderGetHight(t.left) - postOrderGetHight(t.right) == 2) if (x.compareTo(t.left.data) \u0026lt; 0) t = singleLeftRotation(t); /* å·¦å•æ—‹ */ else t = doubleLeftRightRotation(t); /* å·¦-å³åŒæ—‹ */ } /* else if (æ’å…¥å·¦å­æ ‘) ç»“æŸ */ else if (x.compareTo(t.data) \u0026gt; 0) { /* æ’å…¥Tçš„å³å­æ ‘ */ t.right = insert(t.right, x); /* å¦‚æœéœ€è¦å³æ—‹ */ if (postOrderGetHight(t.left) - postOrderGetHight(t.right) == -2) if (x.compareTo(t.right.data) \u0026gt; 0) t = singleRightRotation(t); /* å³å•æ—‹ */ else t = doubleRightLeftRotation(t); /* å³-å·¦åŒæ—‹ */ } /* else if (æ’å…¥å³å­æ ‘) ç»“æŸ */ /* else X == T-\u0026gt;Dataï¼Œæ— é¡»æ’å…¥ */ /* åˆ«å¿˜äº†æ›´æ–°æ ‘é«˜ */ t.height = Math.max(postOrderGetHight(t.left), postOrderGetHight(t.right)) + 1; return t; }  å‚è€ƒ ã€1ã€‘æµ™æ±Ÿå¤§å­¦é™ˆè¶Šè€å¸ˆçš„æ•°æ®ç»“æ„è¯¾ç¨‹\n","date":"2020å¹´08æœˆ31æ—¥","permalink":"https://ahamoment.cn/posts/algorithm/algorithm-balanced-binary-tree/","summary":"å¹³è¡¡äºŒå‰æ ‘ å¹³è¡¡äºŒå‰æ ‘ä¹Ÿæ˜¯ä¸€ç§æœç´¢æ ‘ã€‚\næœç´¢æ ‘èŠ‚ç‚¹ä¸åŒæ’å…¥æ¬¡åºï¼Œå°†å¯¼è‡´ä¸åŒçš„æ·±åº¦å’Œå¹³å‡æŸ¥æ‰¾é•¿åº¦ ASLã€‚\nå¹³è¡¡å› å­ï¼ˆBalance Factorï¼‰:BF(T)=hL-hRï¼Œå…¶ä¸­hLå’ŒhRåˆ†åˆ«æ˜¯Tçš„å·¦å³å­æ ‘çš„é«˜åº¦ã€‚å¹³è¡¡äºŒå‰æ ‘ï¼ˆBalanced Binary Tree) åˆå« AVLæ ‘ï¼Œå½“æ ‘ä¸ä¸ºç©ºæ—¶ï¼Œåœ¨ä»»ä¸€èŠ‚ç‚¹å·¦ï¼Œå³å­æ ‘é«˜åº¦å·®çš„ç»å¯¹å€¼ä¸è¶…è¿‡1ï¼Œå³ |BF(T)|\u0026lt;=1ã€‚\nå¹³è¡¡äºŒå‰æ ‘çš„é«˜åº¦èƒ½å¤Ÿè¾¾åˆ° $log_2n$\nå¹³è¡¡äºŒå‰æ ‘çš„è°ƒæ•´ ä»»ä½•æƒ…å†µéƒ½å¯ä»¥å½’ç»“ä¸ºå››ç§æ¨¡å¼ã€‚æ ¹æ®æ’å…¥èŠ‚ç‚¹çš„ä½ç½®ä¸åŒä½¿ç”¨ä¸åŒçš„æŸ¥æ‰¾æ–¹æ³•ï¼ŒåŒæ—¶è®°ä½å¹³è¡¡äºŒå‰æ ‘æ˜¯æœç´¢æ ‘ï¼ŒèŠ‚ç‚¹å°äºå·¦è¾¹å¤§äºå³è¾¹ã€‚å¹³è¡¡äºŒå‰æ ‘çš„å››ç§è°ƒæ•´æ–¹æ³•ä¸ºï¼šå³å•æ—‹ï¼Œå·¦å•æ—‹ï¼Œå³å·¦åŒæ—‹ï¼Œå·¦å³åŒæ—‹ã€‚\nå³å•æ—‹ æŒ‰ç…§å­—æ¯å¤§å°æ’å…¥ä¸‰ä¸ªç»“ç‚¹ï¼ŒMar, May, Novï¼š\nå¦‚ä¸Šå›¾å·¦è¾¹æ‰€ç¤ºï¼Œåœ¨æ’å…¥ Nov ç»“ç‚¹åï¼ŒäºŒå‰æ ‘çš„å¹³è¡¡è¢«ç ´åï¼Œç»“ç‚¹Mar çš„å¹³è¡¡å› å­ä¸º -2ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ç§° Mar ä¸ºä¸å¹³è¡¡çš„å‘ç°è€…ï¼Œéº»çƒ¦èŠ‚ç‚¹ Nov åœ¨å‘ç°è€…å³å­æ ‘çš„å³è¾¹ï¼Œéœ€è¦RRæ—‹è½¬ï¼ˆå³å•æ—‹ï¼‰ã€‚","title":"å¹³è¡¡äºŒå‰æ ‘"},{"contents":" æœ¬æ–‡ç¿»è¯‘è‡ªLEARN UNIXï¼Œåšä¸»åœ¨åŸæ–‡çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸€äº›å†…å®¹ã€‚å¦‚æœæ²¡æœ‰Linux æœºå™¨ï¼Œæ¨èä½¿ç”¨è¯¥ç½‘ç«™ https://www.tutorialspoint.com/execute_ksh_online.php ä½œä¸ºshellåœ¨çº¿demoçš„ç¯å¢ƒã€‚\n 1. Shell æ˜¯ä»€ä¹ˆ Shellä¸ºæ‚¨æä¾›äº†ä¸Unixç³»ç»Ÿçš„æ¥å£ã€‚å®ƒæ”¶é›†æ‚¨çš„è¾“å…¥ï¼Œå¹¶æ ¹æ®è¯¥è¾“å…¥æ‰§è¡Œç¨‹åºã€‚ç¨‹åºå®Œæˆæ‰§è¡Œåï¼Œå°†æ˜¾ç¤ºè¯¥ç¨‹åºçš„è¾“å‡ºã€‚ Shell æ˜¯å¯ä»¥è¿è¡Œæˆ‘ä»¬çš„å‘½ä»¤ï¼Œç¨‹åºï¼Œshell è„šæœ¬çš„ç¯å¢ƒã€‚Shell æœ‰ä¸åŒçš„ç±»å‹ï¼Œæ¯ç§Shelléƒ½æœ‰å®ƒè‡ªå·±çš„å‘½ä»¤å’ŒåŠŸèƒ½ã€‚\n1.1 Shell ç±»å‹ Linux ç³»ç»Ÿä¸­ï¼Œä¸»è¦æœ‰ä¸¤ç§ç±»å‹çš„Shellï¼š\n Bourne shell - å¦‚æœä½¿ç”¨Bourneç±»å‹çš„shellï¼Œé»˜è®¤çš„æç¤ºç¬¦å°±æ˜¯$ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ç¯å¢ƒå˜é‡PS1æ¥æ›´æ”¹ä½ çš„æç¤ºç¬¦ã€‚ C shell - C ç±»å‹çš„shellï¼Œé»˜è®¤çš„æç¤ºç¬¦æ˜¯%ã€‚  Bourne Shell åˆæœ‰ä¸‹é¢å‡ ç§ç±»å‹ï¼š\n Bourne shell (sh) Korn shell (ksh) Bourne Again shell (bash) POSIX shell (sh)  C ç±»å‹ çš„ShellåŒ…æ‹¬ä»¥ä¸‹ä¸¤ç§ï¼š\n C shell (csh) TENEX/TOPS C shell (tcsh)  åœ¨å¤§å¤šæ•° Linux ç‰ˆæœ¬ä¸­ï¼ŒBourne shell é€šå¸¸éƒ½å®‰è£…ä¸º/bin/shã€‚ç”±äºè¿™ä¸ªåŸå› ï¼Œå®ƒæ˜¯ä¸åŒç‰ˆæœ¬çš„Linux çš„é¦–é€‰ Shellã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¤§å¤šæ•°åŸºäºBourne Shellçš„Shellæ¦‚å¿µã€‚\n1.2 Shell è„šæœ¬ Shellè„šæœ¬çš„åŸºæœ¬æ¦‚å¿µæ˜¯å‘½ä»¤åˆ—è¡¨ï¼ŒæŒ‰æ‰§è¡Œé¡ºåºåˆ—å‡ºå‘½ä»¤ã€‚ Shell è„šæœ¬æ–‡ä»¶ä»¥ .sh ç»“å°¾ï¼Œä¾‹å¦‚ test.sh ã€‚Shell è„šæœ¬çš„å†…å®¹ä»¥ #! å¼€å¤´ï¼Œå‘Šè¯‰ç³»ç»Ÿæ¥ä¸‹æ¥çš„å‘½ä»¤å°†ä¼šè¢« Bourne Shell æ‰§è¡Œã€‚æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªShellè„šæœ¬ï¼Œå¹¶å¾€è„šæœ¬ä¸­æ·»åŠ ä¸€ç‚¹æ³¨é‡Šï¼Œæ³¨é‡Šä»¥ # å¼€å¤´ï¼š\n#!/bin/bash # Author: xueqiang.chen # Script follows here: pwd ls  ä¿å­˜å‘½ä»¤å¹¶æ‰§è¡Œè„šæœ¬ï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºå†…å®¹ï¼š\n$ chmod +x test.sh $ ./test.sh /home/centos go.sh test.sh  Shell è„šæœ¬å¯ä»¥æœ‰å¾ˆå¤æ‚çš„ç»“æ„ï¼Œæ¯•ç«Ÿï¼Œshellæ˜¯ä¸€ç§çœŸæ­£çš„ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒåŒ…æ‹¬å˜é‡ï¼Œæ§åˆ¶ç»“æ„ç­‰ã€‚æ— è®ºè„šæœ¬å˜å¾—å¤šä¹ˆå¤æ‚ï¼Œå®ƒä»ç„¶åªæ˜¯é¡ºåºæ‰§è¡Œçš„å‘½ä»¤çš„åˆ—è¡¨ã€‚\n2. Shell å˜é‡ å˜é‡æ˜¯æˆ‘ä»¬ä¸ºå…¶åˆ†é…å€¼çš„å­—ç¬¦ä¸²ï¼Œå˜é‡çš„å€¼åŒ…æ‹¬æ•°å­—ï¼Œæ–‡æœ¬ï¼Œæ–‡ä»¶åï¼Œè®¾å¤‡ï¼Œæˆ–æ˜¯ä»»æ„çš„æ•°æ®ç±»å‹ã€‚å˜é‡åªæ˜¯å®é™…æ•°æ®çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºï¼Œèµ‹å€¼ï¼Œåˆ é™¤å˜é‡ã€‚\n2.1 å˜é‡ç±»å‹ å½“Shellè¿è¡Œæ—¶ï¼Œå­˜åœ¨ä¸‰ç§ä¸»è¦ç±»å‹çš„å˜é‡ï¼š\n å±€éƒ¨å˜é‡ï¼šå±€éƒ¨å˜é‡æ˜¯å­˜åœ¨äºShellå½“å‰å®ä¾‹ä¸­çš„å˜é‡ã€‚å®ƒä¸é€‚ç”¨äºç”± Shell å¯åŠ¨çš„ç¨‹åºã€‚å®ƒä»¬åœ¨å‘½ä»¤æç¤ºç¬¦ä¸‹è®¾ç½®ã€‚ ç¯å¢ƒå˜é‡ï¼šç¯å¢ƒå˜é‡å¯ç”¨äºShellçš„ä»»ä½•å­è¿›ç¨‹ã€‚æŸäº›ç¨‹åºéœ€è¦ç¯å¢ƒå˜é‡æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚é€šå¸¸ï¼Œshellè„šæœ¬ä»…å®šä¹‰å…¶è¿è¡Œçš„ç¨‹åºæ‰€éœ€çš„é‚£äº›ç¯å¢ƒå˜é‡ã€‚ Shellå˜é‡ï¼šShellå˜é‡æ˜¯Shellè®¾ç½®çš„ç‰¹æ®Šå˜é‡ï¼Œshellè¦æ±‚Shellå˜é‡æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚è¿™äº›å˜é‡ä¸­çš„ä¸€äº›æ˜¯ç¯å¢ƒå˜é‡ï¼Œè€Œå¦ä¸€äº›æ˜¯å±€éƒ¨å˜é‡ã€‚  2.2 å˜é‡å å˜é‡åç§°åªèƒ½åŒ…å«å­—æ¯ï¼ˆaåˆ°zæˆ–Aåˆ°Zï¼‰ï¼Œæ•°å­—ï¼ˆ0åˆ°9ï¼‰æˆ–ä¸‹åˆ’çº¿å­—ç¬¦ï¼ˆ_ï¼‰ã€‚æŒ‰ç…§çº¦å®šï¼ŒUnix shellå˜é‡å°†ä»¥å¤§å†™å­—æ¯å‘½åã€‚ ä¸‹é¢çš„ä¾‹å­æ˜¯ä¸€äº›æœ‰æ•ˆå’Œæ— æ•ˆçš„å˜é‡åï¼š\n#!/bin/bash # valid variable names _ALL TOKEN_A VAR_1 VAR_2 # invaild variable names 2_VAR -VARIABLE VAR1-VAR2 VAR_A!  åœ¨shell ä¸­ï¼Œ!, *, - æ˜¯å«æœ‰ç‰¹æ®Šæ„ä¹‰çš„ï¼Œå› æ­¤ä¸èƒ½åœ¨å˜é‡åä¸­ä½¿ç”¨ã€‚\n2.3 å®šä¹‰å˜é‡ å˜é‡çš„å®šä¹‰æ–¹å¼å¦‚ä¸‹ï¼š\nvariable_name=variable_value  æ³¨æ„ï¼Œ= å·ä¸¤è¾¹ä¸èƒ½æœ‰ç©ºæ ¼ã€‚\n#!/bin/bash NAME=\u0026quot;Zara Ali\u0026quot;  è¿™ä¸ªä¾‹å­ä¸­å®šä¹‰äº†ä¸€ä¸ªå˜é‡ï¼Œå¹¶ç»™è¿™ä¸ªå˜é‡èµ‹å€¼ï¼Œè¿™ç§å˜é‡çš„ç±»å‹ç§°ä¸ºæ ‡é‡ï¼Œ æ ‡é‡åªä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªå€¼ã€‚\n2.4 ä½¿ç”¨å˜é‡ Shell ä¸­é€šè¿‡ $ ç¬¦å·è·å–å˜é‡çš„å€¼ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä¾‹å­å°†è·å–å˜é‡NAMEçš„å€¼å¹¶å°†å…¶æ‰“å°åœ¨æ ‡å‡†è¾“å‡ºä¸­ï¼š\n#!/bin/bash NAME=\u0026quot;Zara Ali\u0026quot; echo $NAME  2.5 åªè¯»å˜é‡ Shell å…è®¸é€šè¿‡ readonly å‘½ä»¤å°†ä¸€ä¸ªå˜é‡å˜æˆåªè¯»å˜é‡ã€‚å½“å˜é‡æˆä¸ºåªè¯»å˜é‡åï¼Œå®ƒçš„å€¼å°±ä¸èƒ½æ›´æ”¹äº†ã€‚\n#!/bin/bash NAME=\u0026quot;Zara Ali\u0026quot; readonly NAME NAME=\u0026quot;Qadiri\u0026quot;  ä¸Šé¢çš„è„šæœ¬ä¼šå‘ç”Ÿé”™è¯¯ã€‚\n/bin/sh: NAME: This variable is read only.  2.6 é‡ç½®å˜é‡ é‡ç½®æˆ–åˆ é™¤å˜é‡å°†æŒ‡ç¤ºShellç¨‹åºä»å…¶è·Ÿè¸ªçš„å˜é‡åˆ—è¡¨ä¸­åˆ é™¤è¯¥å˜é‡ã€‚é‡ç½®å˜é‡åï¼Œå°†æ— æ³•è®¿é—®è¯¥å˜é‡ä¸­çš„å­˜å‚¨å€¼ã€‚ ä»¥ä¸‹æ˜¯ä½¿ç”¨ unset å‘½ä»¤å–æ¶ˆå®šä¹‰çš„å˜é‡çš„è¯­æ³•ï¼š\nunset variable_name  ä¸Šé¢çš„å‘½ä»¤é‡ç½®å®šä¹‰çš„å˜é‡çš„å€¼ï¼Œä¸‹é¢çš„è¿™ä¸ªä¾‹å­ç®€å•è¯´æ˜è¿™ä¸ªå‘½ä»¤æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š\n#!/bin/bash NAME=\u0026quot;Zara Ali\u0026quot; unset NAME echo $NAME  ä¸Šé¢çš„ä¾‹å­ä¸ä¼šæ‰“å°å‡ºä»»ä½•å†…å®¹ï¼Œä½ å¯ä»¥ä½¿ç”¨ unset å‘½ä»¤æ¥é‡ç½®è¢«æ ‡è®°ä¸º readonly çš„å˜é‡ã€‚\n3. ç‰¹æ®Šå˜é‡ åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†åœ¨å˜é‡åç§°ä¸­ä½¿ç”¨æŸäº›éå­—æ¯æ•°å­—å­—ç¬¦æ—¶åº”æ³¨æ„çš„äº‹é¡¹ã€‚è¿™æ˜¯å› ä¸ºè¿™äº›å­—ç¬¦ç”¨åœ¨ç‰¹æ®Šçš„Unixå˜é‡çš„åç§°ä¸­ã€‚è¿™äº›å˜é‡ä¿ç•™ç”¨äºç‰¹å®šåŠŸèƒ½ã€‚\nä¸‹é¢çš„è¡¨æ ¼åˆ—å‡ºäº†å¯ä»¥åœ¨æˆ‘ä»¬çš„è„šæœ¬ä¸­ä½¿ç”¨çš„ç‰¹æ®Šå˜é‡ï¼š\n   å˜é‡ è¯´æ˜     $0 å½“å‰è„šæœ¬çš„æ–‡ä»¶å   $n è¿™ä¸ªå˜é‡å¯¹åº”äºè°ƒç”¨è„šæœ¬çš„å‚æ•°ã€‚å…¶ä¸­å‚æ•° n æ˜¯æ­£æ•´æ•°ï¼Œä»£è¡¨å‚æ•°çš„ä½ç½®ã€‚ä¾‹å¦‚ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ $1 ï¼Œ ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ $2ï¼Œ ä»¥æ­¤ç±»æ¨ã€‚   $# è„šæœ¬å‚æ•°çš„æ•°é‡   $* è¾“å‡ºæ•´ä¸ªå‚æ•°åˆ—è¡¨ï¼Œå°†æ•´ä¸ªåˆ—è¡¨ä½œä¸ºä¸€ä¸ªå‚æ•°ï¼Œä¸”ä¹‹é—´ä½¿ç”¨ç©ºæ ¼éš”å¼€ã€‚   $@ ä¸$* çš„ä½œç”¨æ˜¯ä¸€è‡´çš„ï¼Œä¸åŒçš„æ˜¯è¯¥å˜é‡è¾“å‡ºæ—¶ä¼šå°†å‚æ•°åˆ—è¡¨åˆ†æˆå•ç‹¬çš„å‚æ•°ã€‚   $$ å½“å‰shellçš„è¿›ç¨‹å·ã€‚å¯¹äºShellè„šæœ¬ï¼Œè¿™æ˜¯å®ƒä»¬æ‰§è¡Œæ—¶çš„è¿›ç¨‹IDã€‚   $! æœ€åä¸€ä¸ªåå°å‘½ä»¤çš„è¿›ç¨‹å·ã€‚   ä»¥ä¸‹è„šæœ¬ä½¿ç”¨ä¸å‘½ä»¤è¡Œç›¸å…³çš„å„ç§ç‰¹æ®Šå˜é‡:     #!/bin/sh echo \u0026quot;File Name: $0\u0026quot; echo \u0026quot;First Parameter : $1\u0026quot; echo \u0026quot;Second Parameter : $2\u0026quot; echo \u0026quot;Quoted Values: $@\u0026quot; echo \u0026quot;Quoted Values: $*\u0026quot; echo \u0026quot;Total Number of Parameters : $#\u0026quot;  è¿è¡Œç»“æœï¼š\n$./test.sh Zara Ali File Name : ./test.sh First Parameter : Zara Second Parameter : Ali Quoted Values: Zara Ali Quoted Values: Zara Ali Total Number of Parameters : 2  3.1 é”™è¯¯çŠ¶æ€ $? å˜é‡è¡¨ç¤ºä¸Šä¸€ä¸ªå‘½ä»¤çš„é€€å‡ºçŠ¶æ€ã€‚ é€€å‡ºçŠ¶æ€æ˜¯æ¯ä¸ªå‘½ä»¤å®Œæˆåè¿”å›çš„æ•°å€¼ã€‚é€šå¸¸ï¼Œå¦‚æœå¤§å¤šæ•°å‘½ä»¤æˆåŠŸï¼Œåˆ™è¿”å›é€€å‡ºçŠ¶æ€0ï¼›å¦‚æœä¸æˆåŠŸï¼Œåˆ™è¿”å›1ã€‚ æŸäº›å‘½ä»¤å‡ºäºç‰¹æ®ŠåŸå› ä¼šè¿”å›å…¶ä»–é€€å‡ºçŠ¶æ€ã€‚ä¾‹å¦‚ï¼ŒæŸäº›å‘½ä»¤åŒºåˆ†é”™è¯¯çš„ç§ç±»ï¼Œå¹¶å°†æ ¹æ®æ•…éšœçš„ç‰¹å®šç±»å‹è¿”å›å„ç§é€€å‡ºå€¼ã€‚\nä¸‹é¢çš„è¿™ä¸ªä¾‹å­è¿”å›çš„æ˜¯æˆåŠŸå‘½ä»¤çš„çŠ¶æ€ï¼š\n$./test.sh Zara Ali File Name : ./test.sh First Parameter : Zara Second Parameter : Ali Quoted Values: Zara Ali Quoted Values: Zara Ali Total Number of Parameters : 2 $echo $? 0 $  4. æ•°ç»„ Shellå˜é‡è¶³ä»¥å®¹çº³å•ä¸ªå€¼ã€‚è¿™äº›å˜é‡ç§°ä¸ºæ ‡é‡å˜é‡ã€‚\nShellæ”¯æŒå¦ä¸€ç§ç±»å‹çš„å˜é‡ï¼Œç§°ä¸ºæ•°ç»„å˜é‡ã€‚å®ƒå¯ä»¥åŒæ—¶ä¿å­˜å¤šä¸ªå€¼ã€‚æ•°ç»„æä¾›äº†ä¸€ç§å¯¹ä¸€ç»„å˜é‡è¿›è¡Œåˆ†ç»„çš„æ–¹æ³•ã€‚æ•°ç»„çš„å‘½åå‚è€ƒå˜é‡çš„å‘½åè§„åˆ™ã€‚\n4.1 å®šä¹‰æ•°ç»„ æ•°ç»„å˜é‡å’Œæ ‡é‡å˜é‡ä¹‹é—´çš„å·®å¼‚å¯ä»¥è§£é‡Šå¦‚ä¸‹ã€‚ å‡è®¾æ‚¨å°è¯•å°†å„ä¸ªå­¦ç”Ÿçš„å§“åè¡¨ç¤ºä¸ºä¸€ç»„å˜é‡ã€‚æ¯ä¸ªå•ç‹¬çš„å˜é‡éƒ½æ˜¯æ ‡é‡å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n#!/bin/bash NAME01=\u0026quot;Zara\u0026quot; NAME02=\u0026quot;Qadir\u0026quot; NAME03=\u0026quot;Mahnaz\u0026quot; NAME04=\u0026quot;Ayan\u0026quot; NAME05=\u0026quot;Daisy\u0026quot;  æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å•ä¸ªæ•°ç»„æ¥å­˜å‚¨æ‰€æœ‰ä¸Šè¿°åç§°ã€‚ä»¥ä¸‹æ˜¯åˆ›å»ºæ•°ç»„å˜é‡çš„æœ€ç®€å•æ–¹æ³•ã€‚\narray_name[index]=value  è¿™é‡Œ array_name æ˜¯æ•°ç»„çš„åå­—ï¼Œindex æ˜¯è¦è®¾ç½®çš„æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œ value å°±æ˜¯ä½ è¦ä¸ºè¯¥å…ƒç´ è®¾ç½®çš„å€¼ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š\n#!/bin/bash NAME[0]=\u0026quot;Zara\u0026quot; NAME[1]=\u0026quot;Qadir\u0026quot; NAME[2]=\u0026quot;Mahnaz\u0026quot; NAME[3]=\u0026quot;Ayan\u0026quot; NAME[4]=\u0026quot;Daisy\u0026quot;  å¦‚æœä½¿ç”¨çš„æ˜¯ bash shell ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹è¿™ç§æ–¹æ³•è¿›è¡Œæ•°ç»„åˆå§‹åŒ–ï¼š\narray_name=(value1 ... valuen)  4.2 ä½¿ç”¨æ•°ç»„ ä¸ºå˜é‡èµ‹å€¼ä¹‹åï¼Œè®¿é—®å˜é‡å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š\n${array_name[index]}  è¿™é‡Œ array_name æ˜¯æ•°ç»„åï¼Œ index æ˜¯è¦è®¿é—®é‚£ä¸ªæ•°ç»„é¡¹çš„ç´¢å¼•ã€‚å…·ä½“çš„ä¾‹å­å¦‚ä¸‹ï¼š\n#!/bin/bash NAME[0]=\u0026quot;Zara\u0026quot; NAME[1]=\u0026quot;Qadir\u0026quot; NAME[2]=\u0026quot;Mahnaz\u0026quot; NAME[3]=\u0026quot;Ayan\u0026quot; NAME[4]=\u0026quot;Daisy\u0026quot; echo \u0026quot;First Index: ${NAME[0]}\u0026quot; echo \u0026quot;Second Index: ${NAME[1]}\u0026quot; echo \u0026quot;First Method: ${NAME[*]}\u0026quot; echo \u0026quot;Second Method: ${NAME[@]}\u0026quot;  è¿è¡Œç»“æœï¼š\n$./test.sh First Index: Zara Second Index: Qadir First Method: Zara Qadir Mahnaz Ayan Daisy Second Method: Zara Qadir Mahnaz Ayan Daisy  ä¸Šé¢çš„ç¤ºä¾‹ä¸­é€šè¿‡ * å’Œ @ æ¥è·å–æ•´ä¸ªæ•°ç»„çš„å€¼ã€‚\n${array_name[*]} ${array_name[@]}  5. è¿ç®—ç¬¦ æ¯ä¸ªShelléƒ½æ”¯æŒä¸åŒçš„è¿ç®—ç¬¦ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦è®¨è®ºçš„æ˜¯ bash shell çš„è¿ç®—ç¬¦ã€‚\n5.1 ç®—æœ¯è¿ç®—ç¬¦ Bourne shell æœ€åˆæ²¡æœ‰ä»»ä½•æ‰§è¡Œç®€å•ç®—æœ¯è¿ç®—çš„æœºåˆ¶ï¼Œå®ƒä½¿ç”¨ awk æˆ– expr æ¥è¿›è¡Œè®¡ç®—ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š\n#!/bin/sh val=`expr 2 + 2` echo \u0026quot;Total value : $val\u0026quot;  è¿è¡Œç»“æœï¼š\nTotal value : 4  ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æœ‰ä¸¤ç‚¹ï¼š\n è¡¨è¾¾å¼å’Œè¿ç®—ç¬¦ä¹‹é—´å¿…é¡»ç”¨ç©ºæ ¼éš”å¼€ï¼Œä¾‹å¦‚ 2+2 æ˜¯é”™è¯¯çš„ï¼Œåº”è¯¥å†™æˆ 2 + 2 æ•´ä¸ªè¡¨è¾¾å¼è¦ç”¨åå¼•å· `` æ¥åŒ…èµ·æ¥ã€‚  å‡è®¾å˜é‡ a ç­‰äº 10ï¼Œ å˜é‡ b ç­‰äº 20ï¼Œ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ bash shell æ”¯æŒçš„ç®—æœ¯è¿ç®—ç¬¦æ˜¯å¦‚ä½•è®¡ç®—è¿™ä¸¤ä¸ªå€¼å¾—ï¼š\n   è¿ç®—ç¬¦ ç¤ºä¾‹     + expr $a + $b = 30   - expr $a - $b = -10   * expr $a \\* $b = 200   / expr $b / $a = 2   % expr $b % $a = 0   = a = $b å°†bçš„å€¼èµ‹ç»™a   == [ $a == $b ] å°†ä¼šè¿”å› false   ï¼= [ $a != $b ]å°†ä¼šè¿”å› true    æ³¨æ„ï¼š[ $a == $b ] ä¸èƒ½å†™æˆ [$a==$b]ã€‚\n5.2 å…³ç³»è¿ç®—ç¬¦ Bash æ”¯æŒä»¥ä¸‹ç‰¹å®šäºæ•°å€¼çš„å…³ç³»è¿ç®—ç¬¦ã€‚ å‡è®¾å˜é‡a = 10ï¼Œå˜é‡b = 20,\n   è¿ç®—ç¬¦ æè¿° ä¾‹å­     -eq æ£€æŸ¥è¿ç®—ç¬¦ä¸¤è¾¹çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰è¿”å› true [ $a -eq $b ] is not true.   -ne æ£€æŸ¥è¿ç®—ç¬¦ä¸¤è¾¹çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œä¸ç›¸ç­‰è¿”å› true [ $a -ne $b ] is true   -gt gt æ˜¯ greater than çš„ç¼©å†™ï¼Œæ£€æŸ¥è¿ç®—ç¬¦å·¦è¾¹çš„å€¼æ˜¯å¦å¤§äºå³è¾¹ï¼Œæ˜¯çš„è¯è¿”å› true [ $a -gt $b ] is not true   -lt lt æ˜¯ less than çš„ç¼©å†™ï¼Œæ£€æŸ¥è¿ç®—ç¬¦å·¦è¾¹çš„å€¼æ˜¯å¦å°äºå³è¾¹ï¼Œæ˜¯çš„è¯è¿”å›true [ $a -lt $b ] is true   -ge ge æ˜¯ greater than or equal çš„ç¼©å†™ï¼Œæ£€æŸ¥è¿ç®—ç¬¦å·¦è¾¹çš„å€¼æ˜¯å¦å¤§äºæˆ–ç­‰äºå³è¾¹çš„å€¼ï¼Œæ˜¯çš„è¯è¿”å›true [ $a -ge $b ] is not true   -le le æ˜¯ less than or equal çš„ç¼©å†™ï¼Œæ£€æŸ¥è¿ç®—ç¬¦å·¦è¾¹çš„å€¼æ˜¯å¦å°äºæˆ–ç­‰äºå³è¾¹çš„å€¼ï¼Œæ˜¯çš„è¯è¿”å›true [ $a -le $b ] is true    æ³¨æ„ï¼šæ‰€æœ‰æ¡ä»¶è¡¨è¾¾å¼åº”æ”¾åœ¨æ–¹æ‹¬å·å†…å¹¶åœ¨å…¶å‘¨å›´ç•™æœ‰ç©ºæ ¼ã€‚\n5.3 å¸ƒå°”è¿ç®—ç¬¦ Bash æ”¯æŒä»¥ä¸‹å¸ƒå°”è¿ç®—ç¬¦ã€‚å‡è®¾å˜é‡ a çš„å€¼æ˜¯ 10ï¼Œ å˜é‡ b çš„å€¼æ˜¯20ï¼š\n   è¿ç®—ç¬¦ æè¿° ç¤ºä¾‹     ï¼ é€»è¾‘å¦ã€‚è¿™ä¼šå°†çœŸå®æ¡ä»¶è½¬æ¢ä¸ºé”™è¯¯æ¡ä»¶ï¼Œåä¹‹äº¦ç„¶ã€‚ [ ! false ] is true.   -o é€»è¾‘æˆ–ã€‚å¦‚æœè¿ç®—ç¬¦ä¸¤è¾¹ä¹‹ä¸€ä¸ºçœŸï¼Œåˆ™æ¡ä»¶ä¸ºçœŸã€‚ [ $a -lt 20 -o $b -gt 100 ] is true.   -a é€»è¾‘ä¸ã€‚å¦‚æœè¿ç®—ç¬¦ä¸¤è¾¹éƒ½æ˜¯çœŸçš„ï¼Œåˆ™æ¡ä»¶ä¸ºçœŸã€‚ [ $a -lt 20 -a $b -gt 100 ] is false.    5.4 å­—ç¬¦ä¸²è¿ç®—ç¬¦ Bash è¿ç®—ç¬¦æ”¯æŒä»¥ä¸‹æ“ä½œã€‚ å‡è®¾å˜é‡ a çš„å€¼ä¸º \u0026ldquo;abc\u0026rdquo;ï¼Œå˜é‡bçš„å€¼ä¸º \u0026ldquo;efg\u0026rdquo;ï¼š\n   è¿ç®—ç¬¦ æè¿° ç¤ºä¾‹     = æ£€æŸ¥è¿ç®—ç¬¦ä¸¤è¾¹çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼›å¦‚æœæ˜¯ï¼Œåˆ™æ¡ä»¶å˜ä¸ºçœŸã€‚ [ $a = $b ] is not true.   != æ£€æŸ¥è¿ç®—ç¬¦ä¸¤è¾¹çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼›å¦‚æœå€¼ä¸ç›¸ç­‰ï¼Œåˆ™æ¡ä»¶ä¸ºçœŸ [ $a != $b ] is true.   -z æ£€æŸ¥ç»™å®šçš„å­—ç¬¦ä¸²æ“ä½œæ•°å¤§å°æ˜¯å¦ä¸ºé›¶ï¼›å¦‚æœé•¿åº¦ä¸ºé›¶ï¼Œåˆ™è¿”å›trueã€‚ [ -z $a ] is not true.   -n æ£€æŸ¥ç»™å®šçš„å­—ç¬¦ä¸²æ“ä½œæ•°å¤§å°æ˜¯å¦ä¸ºéé›¶ï¼›å¦‚æœé•¿åº¦éé›¶ï¼Œåˆ™è¿”å›trueã€‚ [ -n $a ] is not false.   str Checks if str is not the empty string; if it is empty, then it returns false. [ $a ] is not false.    5.5 æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦ æˆ‘ä»¬æœ‰ä¸€äº›è¿ç®—ç¬¦å¯ç”¨äºæµ‹è¯•ä¸æ–‡ä»¶ç›¸å…³çš„å„ç§å±æ€§ã€‚ å‡è®¾æœ‰ä¸ªæ–‡ä»¶å˜é‡ file çš„å€¼ä¸ºä¸€ä¸ªå­˜åœ¨çš„åä¸º \u0026ldquo;test\u0026rdquo; çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶çš„å¤§å°ä¸º100bytesï¼Œå¹¶ä¸”æœ‰è¯»å†™å’Œæ‰§è¡Œçš„æƒé™ã€‚\n   è¿ç®—ç¬¦ æè¿° ç¤ºä¾‹     -b file æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ˜¯ä¸€ä¸ªå—æ–‡ä»¶ï¼Œå¦‚æœæ˜¯å°±è¿”å›trueã€‚ [ -b $file ] è¿”å› falseã€‚   -c file æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯å­—ç¬¦è®¾å¤‡æ–‡ä»¶ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -c $file ] è¿”å› falseã€‚   -d file æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯ç›®å½•ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -d $file ] è¿”å› falseã€‚   -f file æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶ï¼ˆæ—¢ä¸æ˜¯ç›®å½•ï¼Œä¹Ÿä¸æ˜¯è®¾å¤‡æ–‡ä»¶ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -f $file ] è¿”å› trueã€‚   -g file æ£€æµ‹æ–‡ä»¶æ˜¯å¦è®¾ç½®äº† SGID ä½ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -g $file ] è¿”å› falseã€‚   -k file æ£€æµ‹æ–‡ä»¶æ˜¯å¦è®¾ç½®äº†ç²˜ç€ä½(Sticky Bit)ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -k $file ] è¿”å› falseã€‚   -p file æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯æœ‰åç®¡é“ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -p $file ] è¿”å› falseã€‚   -t file æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦æ‰“å¼€å¹¶ä¸ç»ˆç«¯å…³è”ï¼›å¦‚æœæ˜¯ï¼Œåˆ™æ¡ä»¶å˜ä¸ºçœŸã€‚ [ -t $file ] is false.   -u file æ£€æµ‹æ–‡ä»¶æ˜¯å¦è®¾ç½®äº† SUID ä½ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -u $file ] è¿”å› falseã€‚   -r file æ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯è¯»ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -r $file ] è¿”å› trueã€‚   -w file æ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯å†™ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -w $file ] è¿”å› trueã€‚   -x file æ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -x $file ] è¿”å› trueã€‚   -s file æ£€æµ‹æ–‡ä»¶æ˜¯å¦ä¸ºç©ºï¼ˆæ–‡ä»¶å¤§å°æ˜¯å¦å¤§äº0ï¼‰ï¼Œä¸ä¸ºç©ºè¿”å› trueã€‚ [ -s $file ] è¿”å› trueã€‚   -e file æ£€æµ‹æ–‡ä»¶ï¼ˆåŒ…æ‹¬ç›®å½•ï¼‰æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -e $file ] è¿”å› trueã€‚    5.6 å…¶ä»–shellçš„è¿ç®—ç¬¦  C Shell è¿ç®—ç¬¦ï¼šC Shell Operators Korn Shell è¿ç®—ç¬¦ï¼šKorn Shell Operators  6. æ¡ä»¶è¡¨è¾¾å¼ åœ¨ç¼–å†™shellè„šæœ¬æ—¶ï¼Œå¯èƒ½éœ€è¦ä»ç»™å®šçš„ä¸¤ä¸ªè·¯å¾„ä¸­é‡‡ç”¨ä¸€ä¸ªè·¯å¾„ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦ä½¿ç”¨æ¡ä»¶è¯­å¥ï¼Œè¿™äº›æ¡ä»¶è¯­å¥å…è®¸æ‚¨çš„ç¨‹åºåšå‡ºæ­£ç¡®çš„å†³å®šå¹¶æ‰§è¡Œæ­£ç¡®çš„æ“ä½œã€‚\n7. å¾ªç¯ å¾ªç¯æ˜¯åŠŸèƒ½å¼ºå¤§çš„ç¼–ç¨‹å·¥å…·ï¼Œä½¿æ‚¨èƒ½å¤Ÿé‡å¤æ‰§è¡Œä¸€ç»„å‘½ä»¤ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶ä»¥ä¸‹å¯ä¾›Shellç¨‹åºå‘˜ä½¿ç”¨çš„å¾ªç¯ç±»å‹-\n while å¾ªç¯ for å¾ªç¯ until å¾ªç¯ select å¾ªç¯  æ‚¨å°†æ ¹æ®æƒ…å†µä½¿ç”¨ä¸åŒçš„å¾ªç¯ã€‚\n7.1 åµŒå¥—å¾ªç¯ æ‰€æœ‰å¾ªç¯éƒ½æ”¯æŒåµŒå¥—æ¦‚å¿µï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥å°†ä¸€ä¸ªå¾ªç¯æ”¾å…¥å¦ä¸€ä¸ªç±»ä¼¼çš„æˆ–ä¸åŒçš„å¾ªç¯ä¸­ã€‚æ ¹æ®æ‚¨çš„è¦æ±‚ï¼Œæ­¤åµŒå¥—æœ€å¤šå¯ä»¥æ— é™æ¬¡ã€‚\nè¿™æ˜¯åµŒå¥—whileå¾ªç¯çš„ç¤ºä¾‹ã€‚å…¶ä»–å¾ªç¯å¯ä»¥æ ¹æ®ç¼–ç¨‹è¦æ±‚ä»¥ç±»ä¼¼çš„æ–¹å¼åµŒå¥—-\nå¯ä»¥å°†whileå¾ªç¯ç”¨ä½œå¦ä¸€ä¸ªwhileå¾ªç¯ä¸»ä½“çš„ä¸€éƒ¨åˆ†ã€‚ è¯­æ³•ï¼š\nwhile command1 ; # this is loop1, the outer loop do Statement(s) to be executed if command1 is true while command2 ; # this is loop2, the inner loop do Statement(s) to be executed if command2 is true done Statement(s) to be executed if command1 is true done  ç¤ºä¾‹ï¼š\n#!/bin/sh a=0 while [ \u0026quot;$a\u0026quot; -lt 10 ] # this is loop1 do b=\u0026quot;$a\u0026quot; while [ \u0026quot;$b\u0026quot; -ge 0 ] # this is loop2 do echo -n \u0026quot;$b \u0026quot; b=`expr $b - 1` done echo a=`expr $a + 1` done  è¿è¡Œç»“æœï¼š\n0 1 0 2 1 0 3 2 1 0 4 3 2 1 0 5 4 3 2 1 0 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0  ","date":"2020å¹´08æœˆ27æ—¥","permalink":"https://ahamoment.cn/posts/linux/linux-bash-tutorials/","summary":"æœ¬æ–‡ç¿»è¯‘è‡ªLEARN UNIXï¼Œåšä¸»åœ¨åŸæ–‡çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸€äº›å†…å®¹ã€‚å¦‚æœæ²¡æœ‰Linux æœºå™¨ï¼Œæ¨èä½¿ç”¨è¯¥ç½‘ç«™ https://www.tutorialspoint.com/execute_ksh_online.php ä½œä¸ºshellåœ¨çº¿demoçš„ç¯å¢ƒã€‚\n 1. Shell æ˜¯ä»€ä¹ˆ Shellä¸ºæ‚¨æä¾›äº†ä¸Unixç³»ç»Ÿçš„æ¥å£ã€‚å®ƒæ”¶é›†æ‚¨çš„è¾“å…¥ï¼Œå¹¶æ ¹æ®è¯¥è¾“å…¥æ‰§è¡Œç¨‹åºã€‚ç¨‹åºå®Œæˆæ‰§è¡Œåï¼Œå°†æ˜¾ç¤ºè¯¥ç¨‹åºçš„è¾“å‡ºã€‚ Shell æ˜¯å¯ä»¥è¿è¡Œæˆ‘ä»¬çš„å‘½ä»¤ï¼Œç¨‹åºï¼Œshell è„šæœ¬çš„ç¯å¢ƒã€‚Shell æœ‰ä¸åŒçš„ç±»å‹ï¼Œæ¯ç§Shelléƒ½æœ‰å®ƒè‡ªå·±çš„å‘½ä»¤å’ŒåŠŸèƒ½ã€‚\n1.1 Shell ç±»å‹ Linux ç³»ç»Ÿä¸­ï¼Œä¸»è¦æœ‰ä¸¤ç§ç±»å‹çš„Shellï¼š","title":"Linux Shell Script åŸºç¡€æ•™ç¨‹"},{"contents":"1. äºŒå‰æœç´¢æ ‘çš„æ¦‚å¿µ äºŒå‰æœç´¢æ ‘ï¼Œä¹Ÿç§°ä¸ºäºŒå‰æ’åºæ ‘æˆ–äºŒå‰æŸ¥æ‰¾æ ‘ã€‚ä¸€æ£µä¸ä¸ºç©ºçš„äºŒå‰æœç´¢æ ‘æ»¡è¶³ä»¥ä¸‹æ€§è´¨ï¼š\n éç©ºå·¦å­æ ‘çš„æ‰€æœ‰é”®å€¼å°äºå…¶æ ¹ç»“ç‚¹çš„é”®å€¼ã€‚ éç©ºå³å­æ ‘çš„æ‰€æœ‰é”®å€¼å¤§äºå…¶æ ¹ç»“ç‚¹çš„é”®å€¼ã€‚ å·¦ï¼Œå³å­æ ‘éƒ½æ˜¯äºŒå‰æœç´¢æ ‘ã€‚  2. äºŒå‰æœç´¢æ ‘çš„æŸ¥æ‰¾ ä»äºŒå‰æœç´¢æ ‘BSTä¸­æŸ¥æ‰¾å…ƒç´ Xï¼Œè¿”å›å…¶æ‰€åœ¨ç»“ç‚¹çš„åœ°å€ã€‚äºŒå‰æœç´¢æ ‘çš„æŸ¥æ‰¾è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š\n æŸ¥æ‰¾ä»æ ¹ç»“ç‚¹å¼€å§‹ï¼Œå¦‚æœæ ‘ä¸ºç©ºï¼Œç›´æ¥è¿”å› null è‹¥æŸ¥æ‰¾æ ‘éç©ºï¼Œåˆ™æ ¹ç»“ç‚¹å…³é”®å­—ä¸ X è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚  x å°äºæ ¹ç»“ç‚¹çš„é”®å€¼ï¼Œåœ¨å·¦å­æ ‘ä¸­æœç´¢ï¼› x å¤§äºæ ¹ç»“ç‚¹çš„é”®å€¼ï¼Œåœ¨å³å­æ ‘ä¸­æœç´¢ï¼› è‹¥ä¸¤è€…æ¯”è¾ƒçš„ç»“æœç›¸ç­‰ï¼Œæœç´¢å®Œæˆï¼Œç›´æ¥è¿”å›æŒ‡å‘ç»“ç‚¹çš„æŒ‡é’ˆã€‚    æˆ‘ä»¬ç”¨é€’å½’æ¥å®ç°æŸ¥æ‰¾è¿‡ç¨‹ï¼Œ\npublic TreeNode\u0026lt;T\u0026gt; find(T x, TreeNode\u0026lt;T\u0026gt; bst) { if (bst == null) { System.out.println(\u0026quot;æ ‘ä¸ºç©ºï¼ŒæŸ¥æ‰¾å¤±è´¥ï¼\u0026quot;); return null; //æŸ¥æ‰¾å¤±è´¥ } int result = x.compareTo(bst.data); if (result \u0026gt; 0) { // x å¤§äºæ ¹ç»“ç‚¹çš„å€¼ï¼Œå‘å³å­æ ‘é€’å½’æŸ¥æ‰¾ return find(x, bst.right); } else if (result \u0026lt; 0) { // x å°äºæ ¹ç»“ç‚¹çš„å€¼ï¼Œå‘å·¦å­æ ‘é€’å½’æŸ¥æ‰¾ return find(x, bst.left); } else { // æ‰¾åˆ° x çš„å€¼ï¼Œç›´æ¥è¿”å›ç»“ç‚¹æ‰€åœ¨çš„æŒ‡é’ˆ return bst; } }  åœ¨è¿™ä¸ªé€’å½’å®ç°ä¸­ï¼Œä¸¤ä¸ªé€’å½’è¿‡ç¨‹éƒ½æ˜¯å°¾é€’å½’ï¼Œå¯ä»¥æ”¹æˆç”¨è¿­ä»£å‡½æ•°æ¥å®ç°ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚\npublic TreeNode\u0026lt;T\u0026gt; findNonRecursive(T x, TreeNode\u0026lt;T\u0026gt; bst) { while (bst != null) { int result = x.compareTo(bst.data); if (result \u0026gt; 0) { // å‘å³å­æ ‘ä¸­ç§»åŠ¨ï¼Œç»§ç»­æŸ¥æ‰¾ bst = bst.right; } else if (result \u0026lt; 0) { // å‘å·¦å­æ ‘ä¸­ç§»åŠ¨ï¼Œç»§ç»­æŸ¥æ‰¾ bst = bst.left; } else { // x == bst.data // æŸ¥æ‰¾æˆåŠŸï¼Œè¿”å›ç»“ç‚¹çš„æ‰¾åˆ°ç»“ç‚¹çš„åœ°å€ return bst; } } // æŸ¥æ‰¾å¤±è´¥ return null; }  é™¤äº†é€šç”¨çš„æŸ¥æ‰¾å¤–ï¼ŒäºŒå‰æœç´¢æ ‘ç»å¸¸è¦ä½¿ç”¨åˆ°æœ€å¤§å’Œæœ€å°å…ƒç´ çš„æŸ¥æ‰¾ã€‚å¯¹äºä¸€æ£µäºŒå‰æœç´¢æ ‘æ¥è¯´ï¼Œæœ€å¤§å…ƒç´ ä¸€å®šæ˜¯åœ¨æ ‘çš„æœ€å³åˆ†æ”¯çš„ç«¯ç»“ç‚¹ä¸Šï¼Œæœ€å°å…ƒç´ ä¸€å®šæ˜¯åœ¨æ ‘çš„æœ€å·¦åˆ†æ”¯çš„ç«¯ç»“ç‚¹ä¸Šã€‚\næœ€å¤§å…ƒç´ å’Œæœ€å°å…ƒç´ çš„é€’å½’å’Œéé€’å½’å®ç°ä¸ºï¼š\n// æŸ¥æ‰¾æ ‘çš„æœ€å°å€¼ public TreeNode\u0026lt;T\u0026gt; findMin(TreeNode\u0026lt;T\u0026gt; bst) { if (bst == null) { // ç©ºçš„äºŒå‰æœç´¢æ ‘ï¼Œè¿”å›NULL return null; } else if (bst.left == null) { // æ‰¾åˆ°æœ€å·¦å¶ç»“ç‚¹å¹¶è¿”å› return bst; } else { // æ²¿å·¦åˆ†æ”¯ç»§ç»­æŸ¥æ‰¾ return findMin(bst.left); } } // æŸ¥æ‰¾æ ‘çš„æœ€å¤§å€¼ public TreeNode\u0026lt;T\u0026gt; findMax(TreeNode\u0026lt;T\u0026gt; bst) { if (bst == null) { // ç©ºçš„äºŒå‰æœç´¢æ ‘ return null; } else if (bst.right == null) { // æ‰¾åˆ°æœ€å³çš„å¶ç»“ç‚¹å¹¶è¿”å› return bst; } else { // æ²¿å³åˆ†æ”¯ç»§ç»­æŸ¥æ‰¾ return findMax(bst.right); } } // æœ€å°å€¼éé€’å½’å®ç° public TreeNode\u0026lt;T\u0026gt; findMinNonRecursive(TreeNode\u0026lt;T\u0026gt; bst) { if (bst != null) { while (bst.left != null) { // æ²¿å·¦åˆ†æ”¯ç»§ç»­æŸ¥æ‰¾ï¼Œç›´åˆ°æœ€å³å¶ç»“ç‚¹ bst = bst.left; } } return bst; } // æŸ¥æ‰¾æœ€å¤§å€¼éé€’å½’å®ç° public TreeNode\u0026lt;T\u0026gt; findMaxNonRecursive(TreeNode\u0026lt;T\u0026gt; bst) { if (bst != null) { while (bst.right != null) { // æ²¿å³åˆ†æ”¯ç»§ç»­æŸ¥æ‰¾ï¼Œç›´åˆ°æœ€å³å¶ç»“ç‚¹ bst = bst.right; } } return bst; }  3. äºŒå‰æœç´¢æ ‘çš„æ’å…¥ æ’å…¥æŒ‡å®šç»“ç‚¹åˆ°ä¸€æ£µäºŒå‰æ ‘ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬å…³é”®è¦æ‰¾åˆ°è¿™ä¸ªç»“ç‚¹è¦æ’å…¥çš„ä½ç½®ï¼Œå¯ä»¥é‡‡ç”¨ä¸æŸ¥æ‰¾ç±»ä¼¼çš„æ–¹æ³•ã€‚\n// æ’å…¥æ“ä½œ public TreeNode\u0026lt;T\u0026gt; insert(T x, TreeNode\u0026lt;T\u0026gt; bst) { if (bst == null) { // è‹¥åŸæ ‘ä¸ºç©ºï¼Œç”Ÿæˆå¹¶è¿”å›ä¸€ä¸ªç»“ç‚¹çš„äºŒå‰æœç´¢æ ‘ bst = new TreeNode\u0026lt;\u0026gt;(); bst.data = x; bst.left = bst.right = null; } else { // å¼€å§‹æŸ¥æ‰¾è¦æ’å…¥å…ƒç´ çš„ä½ç½® int result = x.compareTo(bst.data); if (result \u0026lt; 0) { // é€’å½’æ’å…¥å·¦å­æ ‘ bst.left = insert(x, bst.left); } else if (result \u0026gt; 0) { // é€’å½’æ’å…¥å³å­æ ‘ bst.right = insert(x, bst.right); } /*else { // x å…ƒç´ å·²ç»å­˜åœ¨, ä¸åšä»»ä½•æ“ä½œ // }*/ } return bst; }  é€šè¿‡é€’å½’å·¦å³å­æ ‘ï¼Œæ‰¾åˆ°è¦æ’å…¥çš„ä½ç½®ï¼Œç„¶åæ’å…¥ç»“ç‚¹ã€‚\n4. äºŒå‰æœç´¢æ ‘çš„åˆ é™¤ åˆ é™¤ä¸€æ£µäºŒå‰æ ‘ï¼Œåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼Œåˆ†åˆ«æ¥åˆ†æä¸€ä¸‹ï¼š\nç¬¬ä¸€ç§ï¼Œè¦åˆ é™¤çš„ç»“ç‚¹æ˜¯æ ‘çš„å¶å­ç»“ç‚¹ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥åˆ é™¤ï¼Œå¹¶ä¿®æ”¹å…¶çˆ¶ç»“ç‚¹çš„æŒ‡é’ˆä¸º nullï¼Œä¾‹å¦‚ï¼Œåˆ é™¤ä¸‹é¢è¿™æ£µäºŒå‰æœç´¢æ ‘ 35 è¿™ä¸ªç»“ç‚¹ï¼š\nç¬¬äºŒç§ï¼Œè¦åˆ é™¤çš„ç»“ç‚¹æœ‰ä¸€ä¸ªå­©å­ç»“ç‚¹ï¼Œé‚£ä¹ˆåˆ é™¤è¯¥ç»“ç‚¹åï¼Œè¦ä¿®æ”¹å…¶çˆ¶ç»“ç‚¹çš„æŒ‡é’ˆåˆ°è¦åˆ é™¤ç»“ç‚¹çš„å­©å­ç»“ç‚¹ä¸Šã€‚ä¾‹å¦‚ï¼Œåˆ é™¤ä¸‹é¢è¿™æ£µäºŒå‰æœç´¢æ ‘çš„33ç»“ç‚¹ã€‚\nç¬¬ä¸‰ç§ï¼Œè¦åˆ é™¤çš„ç»“ç‚¹æœ‰å·¦ã€å³ä¸¤ä¸ªå­æ ‘ï¼Œç”¨å¦ä¸€ç»“ç‚¹æ›¿ä»£è¢«åˆ é™¤ç»“ç‚¹ï¼šå³å­æ ‘çš„æœ€å°å…ƒç´ æˆ–è€…å·¦å­æ ‘çš„æœ€å¤§å…ƒç´ ã€‚ä¾‹å¦‚ï¼Œåˆ é™¤41 è¿™ä¸ªç»“ç‚¹çš„æ—¶å€™ã€‚\nå®ç°å¦‚ä¸‹ï¼š\npublic TreeNode\u0026lt;T\u0026gt; delete(T x, TreeNode\u0026lt;T\u0026gt; bst) { TreeNode\u0026lt;T\u0026gt; tmp; if (bst == null) { System.out.println(\u0026quot;æ ‘ä¸ºç©ºï¼Œè¦åˆ é™¤çš„å…ƒç´ æœªæ‰¾åˆ°ï¼\u0026quot;); return null; } else if (x.compareTo(bst.data) \u0026lt; 0) { //å·¦å­æ ‘é€’å½’åˆ é™¤ bst.left = delete(x, bst.left); } else if (x.compareTo(bst.data) \u0026gt; 0) { bst.right = delete(x, bst.right); //å³å­æ ‘é€’å½’åˆ é™¤ } else { //æ‰¾åˆ°è¦åˆ é™¤çš„èŠ‚ç‚¹ if (bst.left != null \u0026amp;\u0026amp; bst.right != null) { //è¢«åˆ é™¤ç»“ç‚¹æœ‰å·¦å³ä¸¤ä¸ªå­ç»“ç‚¹ tmp = findMin(bst.right); // åœ¨å³å­æ ‘ä¸­æ‰¾æœ€å°çš„å…ƒç´ å¡«å……åˆ é™¤ç»“ç‚¹ bst.data = tmp.data; bst.right = delete(bst.data, bst.right); } else { // è¢«åˆ é™¤ç»“ç‚¹æœ‰ä¸€ä¸ªæˆ–æ— å­ç»“ç‚¹ if (bst.left == null) { // æœ‰å³å­©å­æˆ–æ— å­ç»“ç‚¹ bst = bst.right; } else if (bst.right == null) { bst = bst.left; } } } return bst; }  é¢˜ç›®ï¼šæ˜¯å¦æ˜¯åŒä¸€æ£µäºŒå‰æœç´¢æ ‘\nç»™å®šä¸€ä¸ªæ’å…¥åºåˆ—å°±å¯ä»¥å”¯ä¸€ç¡®å®šä¸€æ£µäºŒå‰æœç´¢æ ‘ã€‚ç„¶åï¼Œç»™å®šä¸€æ£µäºŒå‰æœç´¢æ ‘å¯ä»¥ç”±å¤šç§ä¸åŒçš„æ’å…¥åºåˆ—å¾—åˆ°ã€‚\nä¾‹å¦‚ï¼ŒæŒ‰ç…§åºåˆ—(2,1,3)å’Œï¼ˆ2ï¼Œ3ï¼Œ1ï¼‰æ’å…¥åˆå§‹ä¸ºç©ºçš„äºŒå‰æœç´¢æ ‘ï¼Œå¾—åˆ°ä¸€æ ·çš„ç»“æœã€‚\né—®é¢˜ï¼šå¯¹äºè¾“å…¥çš„å„ç§æ’å…¥åºåˆ—ï¼Œä½ éœ€è¦åˆ¤æ–­ä»–ä»¬æ˜¯å¦èƒ½ç”Ÿæˆä¸€æ ·çš„äºŒå‰æœç´¢æ ‘ã€‚\nå‚è€ƒ ã€1ã€‘æµ™æ±Ÿå¤§å­¦é™ˆè¶Šè€å¸ˆçš„æ•°æ®ç»“æ„è¯¾ç¨‹\n","date":"2020å¹´08æœˆ19æ—¥","permalink":"https://ahamoment.cn/posts/algorithm/algorithm-binary-search-tree/","summary":"1. äºŒå‰æœç´¢æ ‘çš„æ¦‚å¿µ äºŒå‰æœç´¢æ ‘ï¼Œä¹Ÿç§°ä¸ºäºŒå‰æ’åºæ ‘æˆ–äºŒå‰æŸ¥æ‰¾æ ‘ã€‚ä¸€æ£µä¸ä¸ºç©ºçš„äºŒå‰æœç´¢æ ‘æ»¡è¶³ä»¥ä¸‹æ€§è´¨ï¼š\n éç©ºå·¦å­æ ‘çš„æ‰€æœ‰é”®å€¼å°äºå…¶æ ¹ç»“ç‚¹çš„é”®å€¼ã€‚ éç©ºå³å­æ ‘çš„æ‰€æœ‰é”®å€¼å¤§äºå…¶æ ¹ç»“ç‚¹çš„é”®å€¼ã€‚ å·¦ï¼Œå³å­æ ‘éƒ½æ˜¯äºŒå‰æœç´¢æ ‘ã€‚  2. äºŒå‰æœç´¢æ ‘çš„æŸ¥æ‰¾ ä»äºŒå‰æœç´¢æ ‘BSTä¸­æŸ¥æ‰¾å…ƒç´ Xï¼Œè¿”å›å…¶æ‰€åœ¨ç»“ç‚¹çš„åœ°å€ã€‚äºŒå‰æœç´¢æ ‘çš„æŸ¥æ‰¾è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š\n æŸ¥æ‰¾ä»æ ¹ç»“ç‚¹å¼€å§‹ï¼Œå¦‚æœæ ‘ä¸ºç©ºï¼Œç›´æ¥è¿”å› null è‹¥æŸ¥æ‰¾æ ‘éç©ºï¼Œåˆ™æ ¹ç»“ç‚¹å…³é”®å­—ä¸ X è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚  x å°äºæ ¹ç»“ç‚¹çš„é”®å€¼ï¼Œåœ¨å·¦å­æ ‘ä¸­æœç´¢ï¼› x å¤§äºæ ¹ç»“ç‚¹çš„é”®å€¼ï¼Œåœ¨å³å­æ ‘ä¸­æœç´¢ï¼› è‹¥ä¸¤è€…æ¯”è¾ƒçš„ç»“æœç›¸ç­‰ï¼Œæœç´¢å®Œæˆï¼Œç›´æ¥è¿”å›æŒ‡å‘ç»“ç‚¹çš„æŒ‡é’ˆã€‚    æˆ‘ä»¬ç”¨é€’å½’æ¥å®ç°æŸ¥æ‰¾è¿‡ç¨‹ï¼Œ","title":"äºŒå‰æœç´¢æ ‘"},{"contents":"æ‘˜è¦ï¼šäºŒå‰æ ‘çš„å®šä¹‰ï¼Œéå†äºŒå‰æ ‘\n1. äºŒå‰æ ‘çš„å®šä¹‰  äºŒå‰æ ‘ï¼šä¸€ä¸ªæœ‰ç©·çš„ç»“ç‚¹é›†åˆã€‚è¿™ä¸ªé›†åˆå¯ä»¥ä¸ºç©ºï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™å®ƒæ˜¯ç”±æ ¹ç»“ç‚¹å’Œç§°ä¸ºå…¶å·¦å­æ ‘ TL å’Œå³å­æ ‘ TR çš„ä¸¤ä¸ªä¸æƒ³äº¤çš„äºŒå‰æ ‘ç»„æˆã€‚\n   äºŒå‰æ ‘å…·ä½“äº”ç§åŸºæœ¬å½¢æ€\n  äºŒå‰æ ‘çš„å­æ ‘æœ‰å·¦å³é¡ºåºä¹‹åˆ†\n  ç‰¹æ®ŠäºŒå‰æ ‘   æ–œäºŒå‰æ ‘ï¼ˆSkewed Binary Treeï¼‰\n  å®Œç¾äºŒå‰æ ‘ï¼ˆPerfect Binary Treeï¼‰ï¼Œåˆç§°ä¸ºæ»¡äºŒå‰æ ‘ï¼ˆFull Binary Treeï¼‰\nä¸€æ£µå®Œç¾äºŒå‰æ ‘æ‰€æœ‰çš„ç»“ç‚¹éƒ½æœ‰å·¦å³ä¸¤ä¸ªå­ç»“ç‚¹ã€‚\n  å®Œå…¨äºŒå‰æ ‘ï¼ˆComplete Binary Treeï¼‰\nå®Œå…¨äºŒå‰æ ‘çš„æœ€åä¸€å±‚å¯ä»¥å´æ˜¯éƒ¨åˆ†ç»“ç‚¹ï¼Œä¾‹å¦‚å³åŠéƒ¨åˆ†ç¼ºå¤±äº†12-15å·ç»“ç‚¹ï¼Œä½†æ˜¯è¿™æ ·çš„äºŒå‰æ ‘ä¸æ˜¯å®Œå…¨äºŒå‰æ ‘ï¼š\n2. äºŒå‰æ ‘çš„å‡ ä¸ªé‡è¦æ€§è´¨   ä¸€ä¸ªäºŒå‰æ ‘ç¬¬ i å±‚çš„æœ€å¤§ç»“ç‚¹æ•°ä¸ºï¼š$2^{i-1},i\\geq1$\n  æ·±åº¦ä¸º K çš„äºŒå‰æ ‘æœ‰æœ€å¤§ç»“ç‚¹æ€»æ•°ä¸ºï¼š$2^{k}-1, k\\geq1$\n  å¯¹ä»»ä½•éç©ºçš„äºŒå‰æ ‘ Tï¼Œ è‹¥ $n_0$ è¡¨ç¤ºå¶ç»“ç‚¹çš„ä¸ªæ•°ï¼Œ$n_2$ æ˜¯åº¦ä¸º2çš„éå¶ç»“ç‚¹ä¸ªæ•°ï¼Œé‚£ä¹ˆä¸¤è€…æ»¡è¶³å…³ç³» $n_0=n_2+1$\nè¿™ä¸ªå…³ç³»å¾ˆå®¹æ˜“å¯ä»¥æ¨å¯¼å‡ºæ¥ï¼Œä»è¾¹çš„è§’åº¦å‡ºå‘ï¼Œæˆ‘ä»¬çŸ¥é“æ¯ä¸ªäºŒå‰æ ‘çš„è¾¹æ˜¯ç¡®å®šçš„ï¼Œä»æœ€åä¸€å±‚å¾€ä¸Šçœ‹ï¼Œé™¤æ ¹ç»“ç‚¹å¤–ï¼Œæ¯ä¸ªç»“ç‚¹éƒ½æœ‰ä¸€æ¡è¾¹å’Œä¸Šä¸€ä¸ªç»“ç‚¹è¿æ¥ï¼Œæ€»çš„è¾¹æ•°ä¸º: $n_0+n_1+n_2-1$ï¼›ä»æ ¹ç»“ç‚¹å¾€ä¸‹ï¼Œåº¦ä¸º2çš„ç»“ç‚¹å¯¹æœ‰ä¸¤æ¡è¾¹è·Ÿå…¶ä»–ç»“ç‚¹è¿æ¥ï¼Œåº¦ä¸º1çš„ç»“ç‚¹ä¸ºä¸€æ¡ï¼Œå¶ç»“ç‚¹ä¸º0æ¡ï¼Œå³ï¼š$2n_2+n_1+0n_0$ã€‚ è¿™ä¸¤ä¸ªå¼å­ç›¸ç­‰ï¼š $$ n_0+n_1+n_2-1=2n_2+n_1 $$ åŒ–ç®€åå°±å¯ä»¥å¾—åˆ°ä¸Šé¢é‚£ä¸ªå¼å­ã€‚\n  3. äºŒå‰æ ‘çš„æŠ½è±¡æ•°æ®ç±»å‹å®šä¹‰ äºŒå‰æ ‘çš„ç»“æ„ç”±æ•°æ®ï¼Œå·¦å­æ ‘ï¼Œå³å­æ ‘ç»„æˆï¼Œæ“ä½œé›†åŒ…æ‹¬ï¼šåˆ¤ç©ºï¼Œéå†ï¼Œåˆ›å»ºä¸€ä¸ªäºŒå‰æ ‘ã€‚\n/** * äºŒå‰æ ‘æ ‘èŠ‚ç‚¹å®šä¹‰ * @param \u0026lt;T\u0026gt; */ public class TreeNode\u0026lt;T\u0026gt; { public T data; //èŠ‚ç‚¹æ•°æ® public TreeNode\u0026lt;T\u0026gt; left; //æŒ‡å‘å·¦å­æ ‘ public TreeNode\u0026lt;T\u0026gt; right; //æŒ‡å‘å³å­æ ‘ public TreeNode(T data) { this.data = data; } public TreeNode(T data, TreeNode\u0026lt;T\u0026gt; left, TreeNode\u0026lt;T\u0026gt; right) { this.data = data; this.left = left; this.right = right; } } public interface Tree\u0026lt;T\u0026gt; { /** * åˆ¤åˆ«äºŒå‰æ ‘æ˜¯å¦ä¸ºç©º * @param treeNode * @return */ boolean isEmpty(TreeNode\u0026lt;T\u0026gt; treeNode); /** * éå†ï¼ŒæŒ‰æŸé¡ºåºè®¿é—®æ¯ä¸ªç»“ç‚¹ * éå†æ–¹æ³•æœ‰å››ç§ï¼š * 1. å…ˆåºéå†ï¼špreOrderTraversal * 2. ä¸­åºéå†ï¼šinOrderTraversal * 3. ååºéå†ï¼špostOrderTraversal * 4. å±‚æ¬¡éå†ï¼šlevelOrderTraversal * @param treeNode */ void traversal(TreeNode\u0026lt;T\u0026gt; treeNode); /** * åˆ›å»ºä¸€ä¸ªäºŒå‰æ ‘ * @return */ TreeNode\u0026lt;T\u0026gt; createBinTree(); }  å…¶ä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯äºŒå‰æ ‘çš„éå†ï¼ŒåŒ…æ‹¬å…ˆåºï¼Œä¸­åºï¼Œååºå’Œå±‚æ¬¡éå†å››ç§ï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦ç»†è®²ä¸€ä¸‹ã€‚\n  4. äºŒå‰æ ‘çš„å­˜å‚¨ç»“æ„ 4.1 é¡ºåºå­˜å‚¨ç»“æ„ äºŒå‰æ ‘å¯ä»¥é‡‡ç”¨é¡ºåºå­˜å‚¨ç»“æ„æ¥å­˜å‚¨ï¼Œå¯¹äºä¸€æ£µå®Œå…¨äºŒå‰æ ‘æ¥è¯´ï¼ŒæŒ‰ç…§ä»ä¸Šåˆ°ä¸‹ï¼Œä»å·¦åˆ°å³çš„é¡ºåºå­˜å‚¨ n ä¸ªç»“ç‚¹çš„å®Œå…¨äºŒå‰æ ‘çš„ç»“ç‚¹çˆ¶å­å…³ç³»ï¼š\n éæ ¹ç»“ç‚¹çš„çˆ¶ç»“ç‚¹çš„åºå·æ˜¯ $i/2$ å‘ä¸‹å–æ•´çš„å€¼ ç»“ç‚¹çš„å·¦å­©å­ç»“ç‚¹çš„åºå·æ˜¯ $2i$ï¼Œï¼ˆè‹¥$2i\\leq n$ï¼Œå¦åˆ™æ²¡æœ‰å·¦å­©å­ ï¼‰ ç»“ç‚¹çš„å³å­©å­çš„åºå·ä¸º$2i+1$ï¼Œï¼ˆè‹¥ $2i+1 \\leq n$, å¦åˆ™æ²¡æœ‰å³å­©å­ï¼‰  ä¸€èˆ¬çš„äºŒå‰æ ‘ä¹Ÿå¯ä»¥é‡‡ç”¨è¿™ç§ç»“æ„ï¼Œä½†æ˜¯éœ€è¦è¡¥å……ç©ºçš„ç»“ç‚¹ï¼Œä¼šé€ æˆç©ºé—´æµªè´¹ã€‚\n4.2. é“¾è¡¨å­˜å‚¨ é“¾è¡¨çš„å­˜å‚¨ç»“æ„ï¼Œæˆ‘ä»¬åœ¨å‰é¢å·²ç»å±•ç¤ºè¿‡ï¼Œè¿™é‡Œä¸å†è¿‡å¤šèµ˜è¿°ã€‚\n5. äºŒå‰æ ‘çš„éå† äºŒå‰æ ‘çš„éå†æ–¹å¼ä¸€å…±æœ‰å››ç§ï¼Œåˆ†åˆ«æ˜¯ï¼šå…ˆåºéå†ï¼Œä¸­åºéå†ï¼Œååºéå†å’Œå±‚åºéå†ã€‚å…¶ä¸­å…ˆåºï¼Œä¸­åºå’Œååºéå†çš„å®ç°æ–¹å¼åˆæœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯é€’å½’å’Œéé€’å½’ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥è¯¦ç»†çš„ä»‹ç»ä¸€ä¸‹ï¼š\n5.1 é€’å½’å®ç° 5.1.1 å…ˆåºéå† å…ˆåºéå†çš„è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºï¼š\n è®¿é—®æ ¹ç»“ç‚¹ å…ˆåºéå†å…¶å·¦å­æ ‘ å…ˆåºéå†å…¶å³å­æ ‘  ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰è¿™æ ·ä¸€æ£µæ ‘ï¼š\næŒ‰ç…§å…ˆåºéå†çš„é¡ºåºå°†ç»“ç‚¹æ‰“å°å‡ºæ¥ï¼Œä¾æ­¤æ˜¯ï¼šA B D F E C G H Iï¼Œç¨‹åºæè¿°ä¸ºï¼š\npublic void preOrderTraversal(TreeNode\u0026lt;T\u0026gt; binTree) { if (binTree != null) { System.out.println(binTree.data); preOrderTraversal(binTree.left); preOrderTraversal(binTree.right); } }  5.1.2 ä¸­åºéå† ä¸­åºéå†çš„è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºï¼š\n ä¸­åºéå†å…¶å·¦å­æ ‘ è®¿é—®æ ¹ç»“ç‚¹ ä¸­åºéå†å…¶å³å­æ ‘  æŒ‰ç…§ä¸­åºéå†çš„æ–¹å¼å°†ä¸Šé¢è¿™æ£µæ ‘çš„ç»“æœè¾“å‡ºï¼Œä¾æ¬¡æ˜¯ï¼šD B E F A G H C I ,ä½¿ç”¨ç¨‹åºæè¿°ä¸ºï¼š\npublic void inOrderTraversal(TreeNode\u0026lt;T\u0026gt; binTree) { if (binTree != null) { inOrderTraversal(binTree.left); System.out.println(binTree.data); inOrderTraversal(binTree.right); } }  5.1.3 ååºéå† ååºéå†çš„è¿‡ç¨‹ä¸ºï¼š\n ååºéå†å…¶å·¦å­æ ‘ ååºéå†å…¶å³å­æ ‘ è®¿é—®æ ¹ç»“ç‚¹  æŒ‰ç…§ååºéå†çš„æ–¹å¼å°†ä¸Šé¢è¿™æ£µæ ‘çš„ç»“ç‚¹è¾“å‡ºï¼Œä¾æ­¤æ˜¯ï¼šD E F B H G I C A\n5.2 éé€’å½’å®ç° é€’å½’çš„æœ¬è´¨æ˜¯åˆ©ç”¨å †æ ˆæ¥åšçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å †æ ˆæ¥å®ç°ä¸Šé¢çš„ä¸‰ç§æ–¹å¼ã€‚\nå…ˆä»ä¸­åºéå†å¼€å§‹ï¼Œä¸­åºéå†çš„éé€’å½’å®ç°è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š\n  é‡åˆ°ä¸€ä¸ªç»“ç‚¹ï¼Œå°±æŠŠå®ƒå‹æ ˆï¼Œå¹¶å»éå†å®ƒçš„å·¦å­æ ‘ï¼›\n  å½“å·¦å­æ ‘éå†ç»“æŸåï¼Œä»æ ˆé¡¶å¼¹å‡ºè¿™ä¸ªç»“ç‚¹å¹¶è®¿é—®å®ƒï¼›\n  ç„¶åæŒ‰å…¶å³æŒ‡é’ˆå†å»ä¸­åºéå†è¯¥ç»“ç‚¹çš„å³å­æ ‘ã€‚\n  å¯¹äºä¸Šé¢çš„è¿™æ ·ä¸€æ£µæ ‘ï¼Œæˆ‘ä»¬æŒ‰ç…§ä¸­åºéå†çš„è¿‡ç¨‹æ“ä½œå †æ ˆï¼š\nå…¥æ ˆå’Œå‡ºæ ˆçš„è¿‡ç¨‹å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚\npublic void nonRecursiveInOrderTraversal(TreeNode\u0026lt;T\u0026gt; binTree) { TreeNode\u0026lt;T\u0026gt; tmpTree = binTree; Stack\u0026lt;TreeNode\u0026lt;T\u0026gt;\u0026gt; stack = new Stack\u0026lt;\u0026gt;(); while ( tmpTree != null || !stack.isEmpty(stack)) { // ä¸€ç›´å‘å·¦å¹¶å°†æ²¿é€”ç»“ç‚¹å‹å…¥å †æ ˆ while (tmpTree != null) { stack.push(stack, tmpTree); tmpTree = tmpTree.left; } if (!stack.isEmpty(stack)) { // ç»“ç‚¹å¼¹å‡ºå †æ ˆ tmpTree = stack.pop(stack); // è®¿é—®ç»“ç‚¹ System.out.print(tmpTree.data + \u0026quot; \u0026quot;); // è½¬å‘å³å­æ ‘ tmpTree = tmpTree.right; } } }  å…ˆåºéå†çš„è¿‡ç¨‹è·Ÿä¸­åºéå†ç±»ä¼¼ï¼Œåªéœ€è¦åœ¨ç¬¬ä¸€æ¬¡éå†åˆ°ç»“ç‚¹çš„æ—¶å€™æŠŠç»“ç‚¹çš„å€¼æ‰“å°å‡ºæ¥å³å¯ã€‚\npublic void nonRecursivePreOrderTraversal(TreeNode\u0026lt;T\u0026gt; binTree) { TreeNode\u0026lt;T\u0026gt; tmpTree = binTree; Stack\u0026lt;TreeNode\u0026lt;T\u0026gt;\u0026gt; stack = new Stack\u0026lt;\u0026gt;(); while ( tmpTree != null || !stack.isEmpty(stack)) { // ä¸€ç›´å‘å·¦å¹¶å°†æ²¿é€”ç»“ç‚¹å‹å…¥å †æ ˆ while (tmpTree != null) { // è®¿é—®ç»“ç‚¹ System.out.print(tmpTree.data + \u0026quot; \u0026quot;); stack.push(stack, tmpTree); tmpTree = tmpTree.left; } if (!stack.isEmpty(stack)) { // ç»“ç‚¹å¼¹å‡ºå †æ ˆ tmpTree = stack.pop(stack); // è½¬å‘å³å­æ ‘ tmpTree = tmpTree.right; } } }  ååºéå†çš„æ–¹å¼ç•¥æœ‰ä¸åŒï¼Œ ååºéå†åº”è¯¥æŠŠæ•°æ®ä¸¤æ¬¡å‹å…¥å †æ ˆï¼Œç¬¬äºŒæ¬¡popå‡ºæ¥å† print é‰´äºæ²¡æœ‰è®°å½•è®¿é—®æ¬¡æ•°çš„ç»“æ„ï¼Œç¬¬äºŒæ¬¡popçš„æ—¶å€™è¦ä¹ˆå³èŠ‚ç‚¹æ˜¯ç©ºçš„ï¼Œè¦ä¹ˆå³èŠ‚ç‚¹åˆšåˆšè¢«printã€‚æ‰€ä»¥ï¼Œéœ€è¦å¦ä¸€ä¸ªæŒ‡é’ˆptæ¥è®°å½•è¢«åˆšåˆšprintçš„èŠ‚ç‚¹ã€‚\npublic void nonRecursivepostOrderTraversal(TreeNode\u0026lt;T\u0026gt; binTree) { TreeNode\u0026lt;T\u0026gt; tmpTree = binTree; TreeNode\u0026lt;T\u0026gt; pt = null; Stack\u0026lt;TreeNode\u0026lt;T\u0026gt;\u0026gt; stack = new Stack\u0026lt;\u0026gt;(); while ( tmpTree != null || !stack.isEmpty(stack)) { while (tmpTree != null) { stack.push(stack, tmpTree); tmpTree = tmpTree.left; } if (!stack.isEmpty(stack)) { // ç»“ç‚¹å¼¹å‡ºå †æ ˆ tmpTree = stack.pop(stack); if ((tmpTree.right== null)||(tmpTree.right == pt)) {//åˆ¤æ–­å³èŠ‚ç‚¹ä¸ºç©ºæˆ–è€…å³èŠ‚ç‚¹å·²ç»è¾“å‡º System.out.print(tmpTree.data + \u0026quot; \u0026quot;); pt = tmpTree; //è®°å½•ä¸‹ä¸Šä¸€ä¸ªè¢«è¾“å‡ºçš„ tmpTree = null; } else { stack.push(stack, tmpTree); //ç¬¬äºŒæ¬¡å…¥æ ˆï¼ˆç›¸å½“äºTæ²¡æœ‰å‡ºæ ˆï¼‰ tmpTree = tmpTree.right; //è½¬å‘å³å­æ ‘ } } } }  5.3 å±‚åºéå† å±‚åºéå†å³å°†æ ‘ä»ä¸Šåˆ°ä¸‹ï¼Œä»å·¦åˆ°å³è¾“å‡ºï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ ·çš„ä¸€æ£µæ ‘ï¼ŒæŒ‰ç…§å±‚åºéå†è¾“å‡ºçš„ç»“æœä¸ºï¼šA B C D F G I E H.\nå±‚åºéå†å¯ä»¥é€šè¿‡é˜Ÿåˆ—æ¥å®ç°ï¼Œéå†ä»æ ¹ç»“ç‚¹å¼€å§‹ï¼Œé¦–å…ˆå°†æ ¹ç»“ç‚¹å…¥é˜Ÿï¼Œç„¶åå¼€å§‹æ‰§è¡Œå¾ªç¯ï¼šç»“ç‚¹å…¥é˜Ÿï¼Œè®¿é—®è¯¥ç»“ç‚¹ã€å…¶å·¦å³å„¿å­å…¥é˜Ÿã€‚\nå±‚åºåŸºæœ¬è¿‡ç¨‹ï¼šå…ˆæ ¹ç»“ç‚¹å…¥é˜Ÿï¼Œç„¶åï¼š\n ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªå…ƒç´ ï¼› è®¿é—®è¯¥å…ƒç´ æ‰€æŒ‡çš„ç»“ç‚¹ï¼› è‹¥è¯¥å…ƒç´ æ‰€æŒ‡ç»“ç‚¹çš„å·¦ã€å³å­©å­ç»“ç‚¹éç©ºï¼Œåˆ™å°†å…¶å·¦ã€å³å­©å­çš„æŒ‡é’ˆé¡ºåºå…¥é˜Ÿã€‚  public void levelOrderTraveral(TreeNode\u0026lt;T\u0026gt; binTree) { SeqQueue\u0026lt;TreeNode\u0026lt;T\u0026gt;\u0026gt; queue = new SeqQueue\u0026lt;\u0026gt;(20); TreeNode\u0026lt;T\u0026gt; t; // è‹¥æ˜¯ç©ºæ ‘åˆ™ç›´æ¥è¿”å› if (binTree == null) { return; } queue.add(binTree); while (!queue.isEmpty()) { t = queue.delete(); System.out.print(t.data + \u0026quot; \u0026quot;);//è®¿é—®å–å‡ºé˜Ÿåˆ—ä¸­çš„ç»“ç‚¹ if (t.left != null) { queue.add(t.left);//å·¦ç»“ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™å·¦èŠ‚ç‚¹å…¥é˜Ÿ } if (t.right != null) { queue.add(t.right); //å³èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™å³èŠ‚ç‚¹å…¥é˜Ÿ } } }  6. äºŒå‰æ ‘åº”ç”¨çš„ä¾‹å­  ä¾‹ï¼šè¾“å‡ºäºŒå‰æ ‘ä¸­çš„å¶å­ç»“ç‚¹\n åœ¨äºŒå‰æ ‘çš„éå†ç®—æ³•ä¸­å¢åŠ æ£€æµ‹ç»“ç‚¹çš„åˆ¤æ–­ï¼šå·¦å³å­æ ‘æ˜¯å¦éƒ½ä¸ºç©º\npublic void preOrderPrintLeaves(TreeNode\u0026lt;T\u0026gt; binTree) { if (binTree != null) { //å¶å­ç»“ç‚¹çš„å·¦å³éƒ½ä¸ºç©º if (binTree.left == null \u0026amp;\u0026amp; binTree.right == null) { System.out.print(binTree.data + \u0026quot; \u0026quot;); } preOrderPrintLeaves(binTree.left); preOrderPrintLeaves(binTree.right); } }   æ±‚äºŒå‰æ ‘çš„é«˜åº¦\n äºŒå‰æ ‘çš„é«˜åº¦æ˜¯å·¦å­æ ‘å’Œå³å­æ ‘ä¸¤è€…ä¸­æœ€å¤§çš„ä¸€ä¸ªå†åŠ ä¸Šæ ¹ç»“ç‚¹çš„é«˜åº¦1.\npublic int postOrderGetHight(TreeNode\u0026lt;T\u0026gt; binTree) { int hl, hr, maxH; if (binTree != null) { hl = postOrderGetHight(binTree.left); //æ±‚å·¦å­æ ‘çš„é«˜åº¦ hr = postOrderGetHight(binTree.right); //æ±‚å³å­æ ‘çš„é«˜åº¦ maxH = Math.max(hl, hr); //å–å·¦å³å­æ ‘è¾ƒå¤§çš„æ·±åº¦ return maxH+1; } else { return 0; } }   ç”±ä¸¤ç§éå†åºåˆ—ç¡®å®šäºŒå‰æ ‘ï¼Œå·²çŸ¥ä¸‰ç§éå†ä¸­çš„ä»»æ„ä¸¤ç§éå†åºåˆ—ï¼Œèƒ½å¦å”¯ä¸€ç¡®å®šä¸€æ£µäºŒå‰æ ‘å‘¢ï¼Ÿ\n ç­”æ¡ˆæ˜¯ï¼šå¿…é¡»è¦æœ‰ä¸­åºéå†æ‰è¡Œã€‚\nå‡å¦‚æ²¡æœ‰ä¸­åºéå†ï¼Œæ¥çœ‹ä¸ªä¾‹å­ï¼šå…ˆåºï¼šA Bï¼Œååºï¼šB Aï¼Œå°±ä¼šå‡ºç°ä¸¤ç§ä¸åŒçš„ç»“æ„ã€‚\nåœ¨çŸ¥é“ä¸­åºçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆ©ç”¨ä¸­åºåºåˆ—åˆ†å‰²å‡ºå·¦å³ä¸¤ä¸ªå­åºåˆ—ã€‚\n å‚è€ƒï¼šæµ™æ±Ÿå¤§å­¦é™ˆè¶Šè€å¸ˆçš„æ•°æ®ç»“æ„è¯¾ç¨‹\n","date":"2020å¹´08æœˆ11æ—¥","permalink":"https://ahamoment.cn/posts/algorithm/algorithm-binary-tree/","summary":"\u003cp\u003eæ‘˜è¦ï¼šäºŒå‰æ ‘çš„å®šä¹‰ï¼Œéå†äºŒå‰æ ‘\u003c/p\u003e","title":"äºŒå‰æ ‘åŠå­˜å‚¨ç»“æ„"},{"contents":"è¿™ä¸€éƒ¨åˆ†ä¸»è¦ä»‹ç»ä¸€ä¸‹æ•°æ®ç»“æ„ä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼šæ ‘ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯æ ‘å‘¢ï¼Ÿåœ¨è¯´æ˜è¿™ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å’Œå®ƒç›¸å…³çš„ä¸€äº›å†…å®¹ã€‚\n1. æŸ¥æ‰¾ æŸ¥æ‰¾æ˜¯æ ¹æ®æŸä¸ªç»™å®šå…³é”®å­—K ï¼Œä»é›†åˆRä¸­æ‰¾å‡ºå…³é”®å­—ä¸Kç›¸åŒçš„è®°å½•ã€‚æŸ¥æ‰¾åˆåˆ†ä¸ºé™æ€æŸ¥æ‰¾å’ŒåŠ¨æ€æŸ¥æ‰¾ï¼Œé™æ€æŸ¥æ‰¾çš„é›†åˆä¸­è®°å½•æ˜¯å›ºå®šçš„ï¼Œæ²¡æœ‰æ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œåªæœ‰æŸ¥æ‰¾ï¼Œè€ŒåŠ¨æ€æŸ¥æ‰¾çš„é›†åˆä¸­è®°å½•æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œé™¤äº†æŸ¥æ‰¾å¤–ï¼Œè¿˜å¯èƒ½å‘ç”Ÿæ’å…¥å’Œåˆ é™¤æ“ä½œã€‚\n1.1 é™æ€æŸ¥æ‰¾ æ–¹æ³•ä¸€ï¼šé¡ºåºæŸ¥æ‰¾ é¡ºåºæŸ¥æ‰¾å°±æ˜¯ä»æ•°ç»„ä¸­ä¸€ä¸ªä¸€ä¸ªåœ°æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„å…ƒç´ ä¸ºæ­¢ã€‚\nå¦‚å›¾æ‰€ç¤ºï¼Œåœ¨é•¿åº¦ä¸º8çš„æ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ Kï¼Œå¦‚æœæˆ‘ä»¬ä»æœ€åä¸€ä¸ªå…ƒç´ æ‰¾èµ·æ¥ï¼ŒæŸ¥æ‰¾æˆåŠŸå°±è¿”å›æ‰€åœ¨å•å…ƒä¸‹è¡¨ï¼Œä¸æˆåŠŸè¿”å›0ã€‚æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œåœ¨ç¬¬ä¸€ä¸ªå‡ ç‚¹å»ºç«‹å“¨å…µï¼Œå“¨å…µçš„ä½œç”¨å¯ä»¥è®©ç¨‹åºçŸ¥é“ä»€ä¹ˆæ—¶å€™åº”è¯¥åœä¸‹æ¥ï¼ŒåŒæ—¶å¯ä»¥å°‘äº›ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ã€‚\npublic int sequentialSearch(int[] array, int k) { int i; array[0] = k; // å»ºç«‹å“¨å…µ for (i = array.length - 1; array[i] != k; i--) ; // æŸ¥æ‰¾æˆåŠŸè¿”å›æ‰€åœ¨å•å…ƒä¸‹æ ‡ï¼Œä¸æˆåŠŸè¿”å›0 return i; } public static void main(String[] args) { Search search = new Search(); int[] array = new int[9]; for (int i = array.length - 1; i != 0; i--) { array[i] = i; } int target = 7; int result = search.sequentialSearch(array, target); System.out.println(\u0026quot;search for \u0026quot; + target + \u0026quot; in array is \u0026quot; + result); }  æ–¹æ³•äºŒï¼šäºŒåˆ†æŸ¥æ‰¾(Binary Search) äºŒåˆ†æŸ¥æ‰¾ä¹Ÿç§°æŠ˜åŠæŸ¥æ‰¾ï¼ˆBinary Searchï¼‰ï¼Œå®ƒæ˜¯ä¸€ç§æ•ˆç‡è¾ƒé«˜çš„æŸ¥æ‰¾æ–¹æ³•ã€‚ ä½†æ˜¯ï¼ŒæŠ˜åŠæŸ¥æ‰¾è¦æ±‚çº¿æ€§è¡¨å¿…é¡»é‡‡ç”¨é¡ºåºå­˜å‚¨ç»“æ„ï¼Œè€Œä¸”è¡¨ä¸­å…ƒç´ æŒ‰å…³é”®å­—æœ‰åºæ’åˆ—ã€‚\næ³¨æ„ï¼ŒäºŒåˆ†æŸ¥æ‰¾çš„å‰ææ˜¯è¿ç»­å­˜æ”¾ï¼ˆæ•°ç»„ï¼‰æ˜¯æœ‰åºçš„ã€‚\näºŒåˆ†æŸ¥æ‰¾ç¤ºä¾‹ï¼š\nåœ¨ä¸€ä¸ªæŒ‰ä»å°åˆ°å¤§æ’åºçš„æ•°ç»„ä¸­æŸ¥æ‰¾ 444 è¿™ä¸ªå…ƒç´ ï¼Œç”¨ä¸‰ä¸ªæŒ‡é’ˆåˆ†åˆ«ä»£è¡¨å·¦è¾¹ï¼Œå³è¾¹å’Œä¸­é—´ï¼Œæ¯æ¬¡æŸ¥æ‰¾éƒ½å°†ä¸­é—´ä¸ºæ­¢çš„å€¼å’Œç›®æ ‡å€¼å¯¹æ¯”ï¼Œè‹¥å¤§äºç›®æ ‡å€¼ï¼Œåˆ™åœ¨å·¦åŠéƒ¨åˆ†åšäºŒåˆ†æŸ¥æ‰¾ï¼Œè‹¥å°äºç›®æ ‡å€¼ï¼Œåˆ™åœ¨å³åŠéƒ¨åˆ†åšäºŒåˆ†æŸ¥æ‰¾ã€‚\npublic int binarySearch(int[] array, int k) { /*åœ¨è¡¨Tblä¸­æŸ¥æ‰¾å…³é”®å­—ä¸ºKçš„æ•°æ®å…ƒç´ */ int left, right, mid, NoFound = -1; left = 1; /*åˆå§‹å·¦è¾¹ç•Œ*/ right = array.length; /*åˆå§‹å³è¾¹ç•Œ*/ while (left \u0026lt;= right) { mid = (left + right) / 2; /*è®¡ç®—ä¸­é—´å…ƒç´ åæ ‡*/ if (k \u0026lt; array[mid]) right = mid - 1; /*è°ƒæ•´å³è¾¹ç•Œ*/ else if (k \u0026gt; array[mid]) left = mid + 1; /*è°ƒæ•´å·¦è¾¹ç•Œ*/ else return mid; /*æŸ¥æ‰¾æˆåŠŸï¼Œè¿”å›æ•°æ®å…ƒç´ çš„ä¸‹æ ‡*/ } return NoFound; /*æŸ¥æ‰¾ä¸æˆåŠŸï¼Œè¿”å›-1*/ }  äºŒåˆ†æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(logN)\näºŒåˆ†æŸ¥æ‰¾æ˜¯ä¸€ç§æ•ˆç‡æ¯”è¾ƒé«˜çš„æŸ¥æ‰¾ç®—æ³•ï¼Œæ•´ä¸ªäºŒåˆ†æŸ¥æ‰¾çš„è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºä»¥ä¸‹çš„è¿™ç§æ ‘å½¢ç»“æ„ï¼š\nç»“ç‚¹è¡¨ç¤ºçš„æ˜¯æ•°ç»„çš„ä¸‹æ ‡ï¼Œè¿™æ ·çš„ç»“æ„ç§°ä¸ºäºŒåˆ†æŸ¥æ‰¾åˆ¤å®šæ ‘ï¼Œåˆ¤å®šæ ‘ä¸Šæ¯ä¸ªç»“ç‚¹éœ€è¦çš„æŸ¥æ‰¾æ¬¡æ•°åˆšå¥½ä¸ºè¯¥ç»“ç‚¹æ‰€åœ¨çš„å±‚æ•°ã€‚åè¿‡æ¥è®²ï¼Œæˆ‘ä»¬å¦‚æœå°†æ•°æ®æŒ‰ç…§æ ‘çš„è¿™ç§å½¢åŠ¿å­˜å‚¨èµ·æ¥ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿèƒ½è¾¾åˆ°äºŒåˆ†æŸ¥æ‰¾è¿™ç§æ•ˆç‡å‘¢ï¼Ÿ\n2. æ ‘çš„å®šä¹‰  æ ‘æ˜¯ n ï¼ˆn\u0026gt;=0ï¼‰ä¸ªç»“ç‚¹æ„æˆçš„æœ‰é™é›†åˆã€‚å½“n=0æ—¶ï¼Œç§°ä¸ºç©ºæ ‘ã€‚\n å¯¹äºä»»ä½•ä¸€æ£µéç©ºæ ‘ï¼Œå…·å¤‡ä»¥ä¸‹æ€§è´¨ï¼š\n æ ‘ä¸­æœ‰ä¸€ä¸ªç§°ä¸º æ ¹ï¼ˆrootï¼‰ çš„ç‰¹æ®Šç»“ç‚¹ å…¶ä½™ç»“ç‚¹å¯åˆ†ä¸º mï¼ˆm\u0026gt;0) ä¸ªäº’ä¸ç›¸äº¤çš„æœ‰é™é›†ï¼Œ å…¶ä¸­æ¯ä¸ªé›†åˆæœ¬èº«åˆæ˜¯ä¸€æ£µæ ‘ï¼Œç§°ä¸ºåŸæ¥æ ‘çš„å­æ ‘ã€‚  2.1 æ ‘çš„ä¸€äº›åŸºæœ¬æœ¯è¯­  ç»“ç‚¹çš„åº¦ï¼ˆDegreeï¼‰ï¼šç»“ç‚¹çš„å­æ ‘ä¸ªæ•°ã€‚ æ ‘çš„åº¦ï¼šæ ‘çš„æ‰€æœ‰ç»“ç‚¹ä¸­æœ€å¤§çš„åº¦æ•°ã€‚ å¶ç»“ç‚¹ï¼šåº¦ä¸º 0 çš„ç»“ç‚¹ã€‚ çˆ¶ç»“ç‚¹ï¼šæœ‰å­æ ‘çš„ç»“ç‚¹æ˜¯å…¶å­æ ‘çš„æ ¹ç»“ç‚¹çš„çˆ¶ç»“ç‚¹ã€‚ å­ç»“ç‚¹ï¼šè‹¥Aç»“ç‚¹æ˜¯Bç»“ç‚¹çš„çˆ¶ç»“ç‚¹ï¼Œåˆ™ç§°Bç»“ç‚¹æ˜¯Aç»“ç‚¹çš„å­ç»“ç‚¹ï¼›å­ç»“ç‚¹ä¹Ÿç§°å­©å­ç»“ç‚¹ã€‚ å…„å¼Ÿç»“ç‚¹ï¼ˆsiblingï¼‰ï¼šå…·æœ‰åŒä¸€çˆ¶ç»“ç‚¹çš„å„ç»“ç‚¹å½¼æ­¤æ˜¯å…„å¼Ÿç»“ç‚¹ã€‚ è·¯å¾„å’Œè·¯å¾„é•¿åº¦ï¼šä»ç»“ç‚¹n1åˆ°nkçš„è·¯å¾„ä¸ºä¸€ä¸ªç»“ç‚¹åºåˆ—n1, n2,â€¦ , nk , niæ˜¯ni+1çš„çˆ¶ç»“ç‚¹ã€‚è·¯å¾„æ‰€åŒ…å«è¾¹çš„ä¸ªæ•°ä¸ºè·¯å¾„çš„é•¿åº¦ã€‚ ç¥–å…ˆç»“ç‚¹(Ancestor)ï¼šæ²¿æ ‘æ ¹åˆ°æŸä¸€ç»“ç‚¹è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹éƒ½æ˜¯è¿™ä¸ªç»“ç‚¹çš„ç¥–å…ˆç»“ç‚¹ã€‚ å­å­™ç»“ç‚¹(Descendant)ï¼šæŸä¸€ç»“ç‚¹çš„å­æ ‘ä¸­çš„æ‰€æœ‰ç»“ç‚¹æ˜¯è¿™ä¸ªç»“ç‚¹çš„å­å­™ã€‚ ç»“ç‚¹çš„å±‚æ¬¡ï¼ˆLevelï¼‰ï¼šè§„å®šæ ¹ç»“ç‚¹åœ¨1å±‚ï¼Œå…¶å®ƒä»»ä¸€ç»“ç‚¹çš„å±‚æ•°æ˜¯å…¶çˆ¶ç»“ç‚¹çš„å±‚æ•°åŠ 1ã€‚ æ ‘çš„æ·±åº¦ï¼ˆDepthï¼‰ï¼šæ ‘ä¸­æ‰€æœ‰ç»“ç‚¹ä¸­çš„æœ€å¤§å±‚æ¬¡æ˜¯è¿™æ£µæ ‘çš„æ·±åº¦ã€‚  2.2 æ ‘çš„è¡¨ç¤º é‡‡ç”¨å„¿å­-å…„å¼Ÿè¡¨ç¤ºæ³•æ¥è¡¨ç¤ºä¸€ä¸ªæ ‘çš„ç»“ç‚¹ï¼Œå…¶ä¸­å·¦è¾¹çš„æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå³è¾¹çš„æŒ‡é’ˆæŒ‡å‘ç›¸é‚»çš„å…„å¼Ÿç»“ç‚¹ï¼Œå…„å¼Ÿç»“ç‚¹æˆ–å­ç»“ç‚¹ä¸ºç©ºåˆ™ç”¨Nullè¡¨ç¤ºã€‚\n å‚è€ƒï¼šæµ™æ±Ÿå¤§å­¦-é™ˆè¶Šè€å¸ˆçš„æ•°æ®ç»“æ„è¯¾ç¨‹\n ","date":"2020å¹´08æœˆ11æ—¥","permalink":"https://ahamoment.cn/posts/algorithm/algorithm-tree/","summary":"è¿™ä¸€éƒ¨åˆ†ä¸»è¦ä»‹ç»ä¸€ä¸‹æ•°æ®ç»“æ„ä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼šæ ‘ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯æ ‘å‘¢ï¼Ÿåœ¨è¯´æ˜è¿™ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å’Œå®ƒç›¸å…³çš„ä¸€äº›å†…å®¹ã€‚\n1. æŸ¥æ‰¾ æŸ¥æ‰¾æ˜¯æ ¹æ®æŸä¸ªç»™å®šå…³é”®å­—K ï¼Œä»é›†åˆRä¸­æ‰¾å‡ºå…³é”®å­—ä¸Kç›¸åŒçš„è®°å½•ã€‚æŸ¥æ‰¾åˆåˆ†ä¸ºé™æ€æŸ¥æ‰¾å’ŒåŠ¨æ€æŸ¥æ‰¾ï¼Œé™æ€æŸ¥æ‰¾çš„é›†åˆä¸­è®°å½•æ˜¯å›ºå®šçš„ï¼Œæ²¡æœ‰æ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œåªæœ‰æŸ¥æ‰¾ï¼Œè€ŒåŠ¨æ€æŸ¥æ‰¾çš„é›†åˆä¸­è®°å½•æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œé™¤äº†æŸ¥æ‰¾å¤–ï¼Œè¿˜å¯èƒ½å‘ç”Ÿæ’å…¥å’Œåˆ é™¤æ“ä½œã€‚\n1.1 é™æ€æŸ¥æ‰¾ æ–¹æ³•ä¸€ï¼šé¡ºåºæŸ¥æ‰¾ é¡ºåºæŸ¥æ‰¾å°±æ˜¯ä»æ•°ç»„ä¸­ä¸€ä¸ªä¸€ä¸ªåœ°æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„å…ƒç´ ä¸ºæ­¢ã€‚\nå¦‚å›¾æ‰€ç¤ºï¼Œåœ¨é•¿åº¦ä¸º8çš„æ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ Kï¼Œå¦‚æœæˆ‘ä»¬ä»æœ€åä¸€ä¸ªå…ƒç´ æ‰¾èµ·æ¥ï¼ŒæŸ¥æ‰¾æˆåŠŸå°±è¿”å›æ‰€åœ¨å•å…ƒä¸‹è¡¨ï¼Œä¸æˆåŠŸè¿”å›0ã€‚æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œåœ¨ç¬¬ä¸€ä¸ªå‡ ç‚¹å»ºç«‹å“¨å…µï¼Œå“¨å…µçš„ä½œç”¨å¯ä»¥è®©ç¨‹åºçŸ¥é“ä»€ä¹ˆæ—¶å€™åº”è¯¥åœä¸‹æ¥ï¼ŒåŒæ—¶å¯ä»¥å°‘äº›ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ã€‚\npublic int sequentialSearch(int[] array, int k) { int i; array[0] = k; // å»ºç«‹å“¨å…µ for (i = array.","title":"æ ‘çš„å®šä¹‰åŠè¡¨ç¤º"},{"contents":"1. ä»€ä¹ˆæ˜¯é˜Ÿåˆ—  å…·æœ‰ä¸€å®šæ“ä½œçº¦æŸçš„çº¿æ€§è¡¨ã€‚æ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œåªèƒ½åœ¨ä¸€ç«¯æ’å…¥ï¼Œå¦ä¸€ç«¯åˆ é™¤ã€‚\n æ•°æ®æ’å…¥ç§°ä¹‹ä¸ºå…¥é˜Ÿ(addQ)ï¼Œæ•°æ®åˆ é™¤ç§°ä¹‹ä¸ºå‡ºé˜Ÿ(deleteQ)ï¼Œé˜Ÿåˆ—æœ€é‡è¦çš„ç‰¹å¾å°±æ˜¯å…ˆè¿›å…ˆå‡º(FIFO)ã€‚ç”Ÿæ´»ä¸­æœ‰å¾ˆå¤šè·Ÿé˜Ÿåˆ—ç›¸å…³çš„ä¾‹å­ï¼Œä¾‹å¦‚è¶…å¸‚æ’é˜Ÿã€‚\n2. é˜Ÿåˆ—çš„æŠ½è±¡æ•°æ®ç±»å‹æè¿° ä¸é˜Ÿåˆ—ç›¸å…³çš„æ“ä½œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š\n åˆ›å»ºé˜Ÿåˆ—ï¼šç”Ÿæˆé•¿åº¦ä¸º size çš„ç©ºé˜Ÿåˆ—ã€‚ åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ã€‚ åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚ å°†æ•°æ®å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚ å°†æ•°æ®å…ƒç´ ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚  3. é˜Ÿåˆ—çš„é¡ºåºå­˜å‚¨å®ç° é˜Ÿåˆ—çš„é¡ºåºå­˜å‚¨ç»“æ„é€šå¸¸ç”±ä¸€ä¸ªä¸€ç»´æ•°ç»„å’Œä¸€ä¸ªè®°å½•é˜Ÿåˆ—å¤´å…ƒç´ ä½ç½®çš„å˜é‡frontä»¥åŠä¸€ä¸ªè®°å½•é˜Ÿåˆ—å°¾å…ƒç´ ä½ç½®çš„å˜é‡rearç»„æˆã€‚\npublic class SeqQueue\u0026lt;T\u0026gt; implements Queue\u0026lt;T\u0026gt; { private T elementData[]; private int front, rear; }  å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”¨é¡ºåºå­˜å‚¨å®ç°é˜Ÿåˆ—ï¼Œç”±äºæ•°ç»„çš„å…ƒç´ ä» 0 å¼€å§‹ï¼Œæ‰€ä»¥ front å’Œ rear åŒæ—¶æŒ‡å‘ -1 è¿™ä¸ªä½ç½®ï¼Œæ·»åŠ  Job1ï¼Œrear å¾€åç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œåˆ é™¤ Job1 ï¼Œfront å¾€åç§»åŠ¨ä¸€ä¸ªä½ç½®ã€‚å½“é˜Ÿåˆ—æ»¡äº†çš„æ—¶å€™ï¼Œå°±æ— æ³•æ·»åŠ å…ƒç´ äº†ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾å°±èƒ½å‘ç°ï¼Œæ­¤æ—¶ä¹‹å‰åˆ é™¤çš„ä½ç½®è¿˜æ˜¯ç©ºçš„ï¼Œé˜Ÿåˆ—ä¸­è¿˜æœ‰ä½ç½®ï¼Œåªæ˜¯æ— æ³•æ·»åŠ è€Œå·²ï¼Œè¿™æ ·çš„ç»“æ„ä¼šé€ æˆç©ºé—´æµªè´¹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨å¾ªç¯ç»“æ„æ¥è§£å†³ã€‚\nå¾ªç¯é˜Ÿåˆ—çš„æœºæ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å¾ªç¯ç»“æ„ä¸­ï¼Œfront å’Œ rear å¼€å§‹æ—¶åŒæ—¶æŒ‡å‘ 0 è¿™ä¸ªä½ç½®ï¼Œä¹‹åï¼Œæ¯ä¸€æ¬¡å…¥é˜Ÿï¼Œrear å‘ç€é¡ºæ—¶é’ˆæ–¹å‘ç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œæ¯ä¸€æ¬¡å‡ºé˜Ÿåˆ—ï¼Œfront å‘é¡ºæ—¶é’ˆæ–¹å‘ç§»åŠ¨ä¸€ä¸ªä½ç½®ã€‚é‚£ä¹ˆè¿™é‡Œå°±æœ‰ä¸ªé—®é¢˜ï¼šé˜Ÿåˆ—ç©ºå’Œæ»¡çš„åˆ¤åˆ«æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿé˜Ÿåˆ—ç©ºå’Œæ»¡çš„æ—¶å€™ï¼Œfront=rearï¼Œé‚£ä¹ˆå°±é€ æˆæ— æ³•åˆ¤æ–­é˜Ÿåˆ—ç©ºè¿˜æ˜¯æ»¡äº†ã€‚é‚£ä¹ˆè¦å¦‚ä½•è§£å†³å‘¢ï¼Ÿè¿™é‡Œæä¾›ä¸¤ä¸ªè§£å†³æ–¹æ³•ï¼š\n ä½¿ç”¨é¢å¤–æ ‡è®°ï¼š Sizeæˆ–è€…tag ã€‚size ç”¨æ¥è®°å½•å½“å‰å…ƒç´ çš„ä¸ªæ•°ï¼Œå½“ä½ åŠ å…¥ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œsize åŠ  1ï¼Œåˆ é™¤ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œsizeå‡1ï¼Œæ‰€ä»¥åªè¦æ ¹æ®sizeæ˜¯0è¿˜æ˜¯nå°±çŸ¥é“æ˜¯ç©ºè¿˜æ˜¯æ»¡çš„ã€‚tag ï¼ˆ0ï¼Œ1ï¼‰æ ‡è®°ï¼Œæ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œtag=1ï¼Œåˆ é™¤ä¸€ä¸ªå…ƒç´  tag=0ï¼Œå½“æˆ‘ä»¬æƒ³åˆ¤æ–­é˜Ÿåˆ—æ˜¯æ»¡è¿˜æ˜¯ç©ºæ—¶ï¼Œåªè¦åˆ¤æ–­ tag çš„å€¼å°±çŸ¥é“æœ€åä¸€æ¬¡æ“ä½œæ˜¯æ·»åŠ è¿˜æ˜¯åˆ é™¤ã€‚ ä»…ä½¿ç”¨n-1ä¸ªæ•°ç»„ç©ºé—´ã€‚  æˆ‘ä»¬é‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆï¼Œä½¿ç”¨æ±‚ä½™å‡½æ•°æ¥æŸ¥çœ‹åˆ—é˜Ÿæ˜¯å¦å·²æ»¡ã€‚\n(rear + 1) % size == front  çœ‹çœ‹å…·ä½“çš„å®ç°ä»£ç ï¼š\npackage leetcode.editor.datastructure.queue; import java.io.Serializable; public class SeqQueue\u0026lt;T\u0026gt; implements Queue\u0026lt;T\u0026gt;, Serializable { private final static int DEAFULT_SIZE = 10; private T elementData[]; private int front, rear; private int size; public SeqQueue() { elementData = (T[]) new Object[DEAFULT_SIZE]; front = 0; rear = 0; } public SeqQueue(int size) { this.size = size; elementData = (T[]) new Object[size]; front = 0; rear = 0; } public void add(T data) { if ((rear + 1) % this.elementData.length == front) { System.out.println(\u0026quot;é˜Ÿåˆ—å·²æ»¡\u0026quot;); return; } rear = (rear + 1) % this.elementData.length; elementData[rear] = data; } public boolean isEmpty() { return this.elementData.length == 0; } public T delete() { if (front == rear) { System.out.println(\u0026quot;é˜Ÿåˆ—ä¸ºç©º\u0026quot;); return null; } else { front = (front + 1) % this.elementData.length; return elementData[front]; } } }  4. é˜Ÿåˆ—çš„é“¾å¼å­˜å‚¨å®ç°  é˜Ÿåˆ—çš„é“¾å¼å­˜å‚¨ç»“æ„ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªå•é“¾è¡¨å®ç°ã€‚æ’å…¥å’Œåˆ é™¤æ“ä½œåˆ†åˆ«åœ¨é“¾è¡¨çš„ä¸¤å¤´è¿›è¡Œï¼›é˜Ÿåˆ—æŒ‡é’ˆfrontå’Œrearåº”è¯¥åˆ†åˆ«æŒ‡å‘é“¾è¡¨çš„è¡¨å¤´å’Œè¡¨å°¾ã€‚\n æ•´ä¸ªé˜Ÿåˆ—çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä¸é¡ºåºç»“æ„ä¸åŒçš„æ˜¯ï¼Œé“¾å¼å­˜å‚¨å®ç°çš„é˜Ÿåˆ—ï¼Œå‡ºé˜Ÿéœ€è¦åœ¨è¡¨å¤´è¿›è¡Œï¼Œå› ä¸ºæ˜¯å•å‘é“¾è¡¨ï¼Œå¦‚æœåœ¨è¡¨å°¾è¿›è¡Œåˆ é™¤æ“ä½œï¼Œæˆ‘ä»¬æ— æ³•çŸ¥é“å‰ä¸€ä¸ªå…ƒç´ æ˜¯å¤šå°‘ã€‚å› æ­¤å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œä¸ºï¼š\npublic class LinkedQueue\u0026lt;T\u0026gt; implements Queue\u0026lt;T\u0026gt; { private Node\u0026lt;T\u0026gt; front; //æŒ‡å‘é˜Ÿå¤´èŠ‚ç‚¹ private Node\u0026lt;T\u0026gt; rear; //æŒ‡å‘é˜Ÿå°¾èŠ‚ç‚¹ public LinkedQueue() { this.front = null; this.rear = null; } @Override public void add(T data) { Node\u0026lt;T\u0026gt; node = new Node\u0026lt;\u0026gt;(data, null); if (this.front == null) {//ç©ºé˜Ÿåˆ—æ’å…¥ this.front = node; } else {//éç©ºé˜Ÿåˆ—,å°¾éƒ¨æ’å…¥ this.rear.next = node; } this.rear = node; } @Override public boolean isEmpty() { return front == null \u0026amp;\u0026amp; rear == null; } @Override public T delete() { Node\u0026lt;T\u0026gt; frontCell; T frontElem; if (this.front == null) { System.out.println(\u0026quot;é˜Ÿåˆ—ä¸ºç©º\u0026quot;); return null; } frontCell = front; if (front == rear) //è‹¥é˜Ÿåˆ—åªæœ‰ä¸€ä¸ªå…ƒç´  front = rear = null; //åˆ é™¤åé˜Ÿåˆ—ç½®ä¸ºç©º else front = front.next();//frontç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´  frontElem = frontCell.data; return frontElem; } } public class Node\u0026lt;T\u0026gt; { public T data; public Node\u0026lt;T\u0026gt; next; public Node(T data) { this.data = data; next = null; } public Node(T data, Node\u0026lt;T\u0026gt; next) { this.data = data; this.next = next; } public Node\u0026lt;T\u0026gt; next() { return this.next; } }   å‚è€ƒï¼šæµ™æ±Ÿå¤§å­¦é™ˆè¶Šè€å¸ˆçš„æ•°æ®ç»“æ„è¯¾ç¨‹\n ","date":"2020å¹´08æœˆ06æ—¥","permalink":"https://ahamoment.cn/posts/algorithm/algorithm-queue/","summary":"1. ä»€ä¹ˆæ˜¯é˜Ÿåˆ—  å…·æœ‰ä¸€å®šæ“ä½œçº¦æŸçš„çº¿æ€§è¡¨ã€‚æ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œåªèƒ½åœ¨ä¸€ç«¯æ’å…¥ï¼Œå¦ä¸€ç«¯åˆ é™¤ã€‚\n æ•°æ®æ’å…¥ç§°ä¹‹ä¸ºå…¥é˜Ÿ(addQ)ï¼Œæ•°æ®åˆ é™¤ç§°ä¹‹ä¸ºå‡ºé˜Ÿ(deleteQ)ï¼Œé˜Ÿåˆ—æœ€é‡è¦çš„ç‰¹å¾å°±æ˜¯å…ˆè¿›å…ˆå‡º(FIFO)ã€‚ç”Ÿæ´»ä¸­æœ‰å¾ˆå¤šè·Ÿé˜Ÿåˆ—ç›¸å…³çš„ä¾‹å­ï¼Œä¾‹å¦‚è¶…å¸‚æ’é˜Ÿã€‚\n2. é˜Ÿåˆ—çš„æŠ½è±¡æ•°æ®ç±»å‹æè¿° ä¸é˜Ÿåˆ—ç›¸å…³çš„æ“ä½œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š\n åˆ›å»ºé˜Ÿåˆ—ï¼šç”Ÿæˆé•¿åº¦ä¸º size çš„ç©ºé˜Ÿåˆ—ã€‚ åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ã€‚ åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚ å°†æ•°æ®å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚ å°†æ•°æ®å…ƒç´ ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚  3. é˜Ÿåˆ—çš„é¡ºåºå­˜å‚¨å®ç° é˜Ÿåˆ—çš„é¡ºåºå­˜å‚¨ç»“æ„é€šå¸¸ç”±ä¸€ä¸ªä¸€ç»´æ•°ç»„å’Œä¸€ä¸ªè®°å½•é˜Ÿåˆ—å¤´å…ƒç´ ä½ç½®çš„å˜é‡frontä»¥åŠä¸€ä¸ªè®°å½•é˜Ÿåˆ—å°¾å…ƒç´ ä½ç½®çš„å˜é‡rearç»„æˆã€‚","title":"é˜Ÿåˆ—åŠå…¶å®ç°"},{"contents":"é”æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œè¿ç”¨åœºæ™¯éå¸¸å¤šï¼Œå› ä¸ºå®ƒä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œè€Œä¸”æ˜“äºç†è§£ã€‚ä½†åŒæ—¶å®ƒä¹Ÿä¼šå¸¦æ¥ä¸€äº›å›°æ‰°ï¼Œé‚£å°±æ˜¯å¯èƒ½å¼•èµ·æ­»é”ã€‚\n1. ä»€ä¹ˆæ˜¯æ­»é”  ç™¾åº¦ç™¾ç§‘ä¸­å¯¹äºæ­»é”çš„å®šä¹‰ï¼šæ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚\n ç®€è€Œè¨€ä¹‹ï¼Œå½“çº¿ç¨‹1æŒæœ‰èµ„æºAï¼Œçº¿ç¨‹2æŒæœ‰èµ„æºBã€‚æ­¤æ—¶çº¿ç¨‹1æƒ³è¦è·å–èµ„æºBï¼Œçº¿ç¨‹2æƒ³è¦è·å–èµ„æºAã€‚ä¸¤ä¸ªçº¿ç¨‹éƒ½æƒ³è¦è·å–å¯¹æ–¹æ‰‹ä¸­çš„èµ„æºï¼Œè‡ªå·±åˆä¸è‚¯è®©å‡ºå·²æœ‰èµ„æºï¼Œä¸€ç›´åƒµæŒä¸ä¸‹å°±å½¢æˆäº†æ­»é”ã€‚\n2. æ­»é”äº§ç”Ÿçš„å››ä¸ªæ¡ä»¶  äº’æ–¥æ¡ä»¶ï¼šæŒ‡è¿›ç¨‹å¯¹æ‰€åˆ†é…åˆ°çš„èµ„æºè¿›è¡Œæ’å®ƒæ€§ä½¿ç”¨ï¼Œå³åœ¨ä¸€æ®µæ—¶é—´å†…æŸèµ„æºåªç”±ä¸€ä¸ªè¿›ç¨‹å ç”¨ã€‚å¦‚æœæ­¤æ—¶è¿˜æœ‰å…¶å®ƒè¿›ç¨‹è¯·æ±‚èµ„æºï¼Œåˆ™è¯·æ±‚è€…åªèƒ½ç­‰å¾…ï¼Œç›´è‡³å æœ‰èµ„æºçš„è¿›ç¨‹ç”¨æ¯•é‡Šæ”¾ã€‚ è¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼šæŒ‡è¿›ç¨‹å·²ç»ä¿æŒè‡³å°‘ä¸€ä¸ªèµ„æºï¼Œä½†åˆæå‡ºäº†æ–°çš„èµ„æºè¯·æ±‚ï¼Œè€Œè¯¥èµ„æºå·²è¢«å…¶å®ƒè¿›ç¨‹å æœ‰ï¼Œæ­¤æ—¶è¯·æ±‚è¿›ç¨‹é˜»å¡ï¼Œä½†åˆå¯¹è‡ªå·±å·²è·å¾—çš„å…¶å®ƒèµ„æºä¿æŒä¸æ”¾ã€‚ ä¸å‰¥å¤ºæ¡ä»¶ï¼šæŒ‡è¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½è¢«å‰¥å¤ºï¼Œåªèƒ½åœ¨ä½¿ç”¨å®Œæ—¶ç”±è‡ªå·±é‡Šæ”¾ã€‚ ç¯è·¯ç­‰å¾…æ¡ä»¶ï¼šæŒ‡åœ¨å‘ç”Ÿæ­»é”æ—¶ï¼Œå¿…ç„¶å­˜åœ¨ä¸€ä¸ªè¿›ç¨‹â€”â€”èµ„æºçš„ç¯å½¢é“¾ï¼Œå³è¿›ç¨‹é›†åˆ{P0ï¼ŒP1ï¼ŒP2ï¼ŒÂ·Â·Â·ï¼ŒPn}ä¸­çš„P0æ­£åœ¨ç­‰å¾…ä¸€ä¸ª P1 å ç”¨çš„èµ„æºï¼›P1 æ­£åœ¨ç­‰å¾… P2 å ç”¨çš„èµ„æºï¼Œâ€¦â€¦ï¼ŒPn æ­£åœ¨ç­‰å¾…å·²è¢« P0 å ç”¨çš„èµ„æºã€‚  3. æ¡ˆä¾‹ public class DeadLock { private OtherService otherService; public void setOtherService(OtherService otherService) { this.otherService = otherService; } // DeadLockçš„å®ä¾‹çš„é”-èµ„æºA private final Object LOCK = new Object(); public void m1() { synchronized (LOCK) { System.out.println(\u0026quot;********m1********\u0026quot;); otherService.s1(); } } public void m2() { synchronized (LOCK) { System.out.println(\u0026quot;********m2********\u0026quot;); } } } public class OtherService { private DeadLock deadLock; public void setDeadLock(DeadLock deadLock) { this.deadLock = deadLock; } // OtherServiceçš„å®ä¾‹çš„é”-èµ„æºB private final Object LOCK = new Object(); public void s1() { synchronized (LOCK) { System.out.println(\u0026quot;========s1========\u0026quot;); } } public void s2() { synchronized (LOCK) { System.out.println(\u0026quot;========s2========\u0026quot;); deadLock.m2(); } } } public class DeadLockTest { public static void main(String[] args) { DeadLock deadLock = new DeadLock(); OtherService otherService = new OtherService(); deadLock.setOtherService(otherService); otherService.setDeadLock(deadLock); new Thread(() -\u0026gt; { while (true) { deadLock.m1(); } }, \u0026quot;T1\u0026quot;).start(); new Thread(() -\u0026gt; { while (true) { otherService.s2(); } }, \u0026quot;T2\u0026quot;).start(); } }  ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼Œä¸¤ä¸ªçº¿ç¨‹ T1 å’Œ T2 , å…¶ä¸­ T1 çº¿ç¨‹è°ƒç”¨ DeadLock çš„ m1 æ–¹æ³•ï¼Œåœ¨ m1 æ–¹æ³•å†…éƒ¨åˆè°ƒç”¨äº† OtherService çš„ s1 æ–¹æ³•ï¼Œs1 å’Œ m1 è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å«æœ‰ç”¨ synchronized å…³é”®å­—ä¿®é¥°çš„åŒæ­¥ä»£ç å—ã€‚ T2 çº¿ç¨‹è°ƒç”¨ OtherService çš„ s2 æ–¹æ³•ï¼Œåœ¨ s2 æ–¹æ³•å†…åˆè°ƒç”¨çš„ DeadLock çš„ m2 æ–¹æ³•ï¼ŒåŒæ ·çš„ï¼Œs2 å’Œ m1 è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å«æœ‰ç”¨ synchronized å…³é”®å­—ä¿®é¥°çš„åŒæ­¥ä»£ç å—ã€‚æ•´ä¸ªç¨‹åºå¦‚å›¾æ‰€ç¤ºï¼š\nå½“ T1 çº¿ç¨‹æ‰§è¡Œçš„æ—¶å€™ï¼Œm1 æ–¹æ³•è·å– DeadLock çš„ LOCK é”ï¼Œå¹¶è°ƒç”¨ OtherService çš„ s1 æ–¹æ³•ï¼ŒåŒæ—¶ï¼ŒT2 çº¿ç¨‹ä¹Ÿå¼€å§‹æ‰§è¡Œï¼ŒT2 çº¿ç¨‹è·å–åˆ° OtherService çš„ LOCK é”ï¼Œå¹¶è°ƒç”¨ DeadLock çš„ m2 æ–¹æ³•ï¼Œä½†æ˜¯ç”±äº m2 çš„æ–¹æ³•çš„é”æ­¤æ—¶å·²ç»è¢« T1 çº¿ç¨‹å æœ‰ï¼ŒT2 çº¿ç¨‹åªèƒ½ç­‰å¾… T1 çº¿ç¨‹é‡Šæ”¾é”ï¼ŒåŒç†ï¼ŒT1 çº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾… T2 çº¿ç¨‹é‡Šæ”¾é”ï¼Œäºæ˜¯å°±å½¢æˆäº†æ­»é”ã€‚\næˆ‘ä»¬ä½¿ç”¨ jstack æ¥è§‚å¯Ÿä¸€ä¸‹æ­»é”ã€‚\né¦–å…ˆçœ‹åˆ°è¿™ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹è±¡çš„é”ï¼Œåœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ã€‚\njstack çš„ä¿¡æ¯æœ€åä¹Ÿä¼šå‘Šè¯‰æˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ªæ­»é”ã€‚\n4. å¦‚ä½•é¿å…æ­»é”  é¿å…ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è·å–å¤šä¸ªé”ã€‚ é¿å…ä¸€ä¸ªçº¿ç¨‹åœ¨é”å†…åŒæ—¶å ç”¨å¤šä¸ªèµ„æºï¼Œå°½é‡ä¿è¯æ¯ä¸ªé”åªå ç”¨ä¸€ä¸ªèµ„æºã€‚ å°è¯•ä½¿ç”¨å®šæ—¶é”ï¼Œä½¿ç”¨ lock.tryLock(timeout) æ¥æ›¿ä»£ä½¿ç”¨å†…éƒ¨é”æœºåˆ¶ã€‚ å¯¹äºæ•°æ®åº“é”ï¼ŒåŠ é”å’Œè§£é”å¿…é¡»åœ¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥é‡Œï¼Œå¦åˆ™ä¼šå‡ºç°è§£é”å¤±è´¥çš„æƒ…å†µã€‚  ","date":"2020å¹´06æœˆ10æ—¥","permalink":"https://ahamoment.cn/posts/java/java-multithread-dead-lock/","summary":"é”æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œè¿ç”¨åœºæ™¯éå¸¸å¤šï¼Œå› ä¸ºå®ƒä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œè€Œä¸”æ˜“äºç†è§£ã€‚ä½†åŒæ—¶å®ƒä¹Ÿä¼šå¸¦æ¥ä¸€äº›å›°æ‰°ï¼Œé‚£å°±æ˜¯å¯èƒ½å¼•èµ·æ­»é”ã€‚\n1. ä»€ä¹ˆæ˜¯æ­»é”  ç™¾åº¦ç™¾ç§‘ä¸­å¯¹äºæ­»é”çš„å®šä¹‰ï¼šæ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚\n ç®€è€Œè¨€ä¹‹ï¼Œå½“çº¿ç¨‹1æŒæœ‰èµ„æºAï¼Œçº¿ç¨‹2æŒæœ‰èµ„æºBã€‚æ­¤æ—¶çº¿ç¨‹1æƒ³è¦è·å–èµ„æºBï¼Œçº¿ç¨‹2æƒ³è¦è·å–èµ„æºAã€‚ä¸¤ä¸ªçº¿ç¨‹éƒ½æƒ³è¦è·å–å¯¹æ–¹æ‰‹ä¸­çš„èµ„æºï¼Œè‡ªå·±åˆä¸è‚¯è®©å‡ºå·²æœ‰èµ„æºï¼Œä¸€ç›´åƒµæŒä¸ä¸‹å°±å½¢æˆäº†æ­»é”ã€‚\n2. æ­»é”äº§ç”Ÿçš„å››ä¸ªæ¡ä»¶  äº’æ–¥æ¡ä»¶ï¼šæŒ‡è¿›ç¨‹å¯¹æ‰€åˆ†é…åˆ°çš„èµ„æºè¿›è¡Œæ’å®ƒæ€§ä½¿ç”¨ï¼Œå³åœ¨ä¸€æ®µæ—¶é—´å†…æŸèµ„æºåªç”±ä¸€ä¸ªè¿›ç¨‹å ç”¨ã€‚å¦‚æœæ­¤æ—¶è¿˜æœ‰å…¶å®ƒè¿›ç¨‹è¯·æ±‚èµ„æºï¼Œåˆ™è¯·æ±‚è€…åªèƒ½ç­‰å¾…ï¼Œç›´è‡³å æœ‰èµ„æºçš„è¿›ç¨‹ç”¨æ¯•é‡Šæ”¾ã€‚ è¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼šæŒ‡è¿›ç¨‹å·²ç»ä¿æŒè‡³å°‘ä¸€ä¸ªèµ„æºï¼Œä½†åˆæå‡ºäº†æ–°çš„èµ„æºè¯·æ±‚ï¼Œè€Œè¯¥èµ„æºå·²è¢«å…¶å®ƒè¿›ç¨‹å æœ‰ï¼Œæ­¤æ—¶è¯·æ±‚è¿›ç¨‹é˜»å¡ï¼Œä½†åˆå¯¹è‡ªå·±å·²è·å¾—çš„å…¶å®ƒèµ„æºä¿æŒä¸æ”¾ã€‚ ä¸å‰¥å¤ºæ¡ä»¶ï¼šæŒ‡è¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½è¢«å‰¥å¤ºï¼Œåªèƒ½åœ¨ä½¿ç”¨å®Œæ—¶ç”±è‡ªå·±é‡Šæ”¾ã€‚ ç¯è·¯ç­‰å¾…æ¡ä»¶ï¼šæŒ‡åœ¨å‘ç”Ÿæ­»é”æ—¶ï¼Œå¿…ç„¶å­˜åœ¨ä¸€ä¸ªè¿›ç¨‹â€”â€”èµ„æºçš„ç¯å½¢é“¾ï¼Œå³è¿›ç¨‹é›†åˆ{P0ï¼ŒP1ï¼ŒP2ï¼ŒÂ·Â·Â·ï¼ŒPn}ä¸­çš„P0æ­£åœ¨ç­‰å¾…ä¸€ä¸ª P1 å ç”¨çš„èµ„æºï¼›P1 æ­£åœ¨ç­‰å¾… P2 å ç”¨çš„èµ„æºï¼Œâ€¦â€¦ï¼ŒPn æ­£åœ¨ç­‰å¾…å·²è¢« P0 å ç”¨çš„èµ„æºã€‚  3.","title":"Java å¤šçº¿ç¨‹ - æ­»é”é—®é¢˜"},{"contents":"Synchronized ç®€ä»‹  æœ¬æ–‡å‡ºè‡ªæ±ªæ–‡å›è€å¸ˆçš„ã€ŠJava å¹¶å‘ç¼–ç¨‹ã€‹è¯¾ç¨‹ï¼Œå¦‚éœ€è½¬è½½ï¼Œè¯·æ³¨æ˜æºå‡ºå¤„ï¼\n å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œè¿™ä¸ªä¾‹å­æ˜¯æ¨¡æ‹Ÿé“¶è¡Œå«å·çš„ï¼Œä½¿ç”¨ä¸‰ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿä¸‰ä¸ªæŸœå°ä¸€èµ·å«å·ï¼Œæ€»å…±50ä¸ªå·ã€‚åœ¨ä¸åŠ  synchronized çš„å…³é”®å­—çš„æƒ…å†µä¸‹ï¼Œå¾ˆå®¹æ˜“å°±ä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚\npublic class BankRunnable { public static void main(String[] args) { // ä¸€ä¸ªrunnableå®ä¾‹è¢«å¤šä¸ªçº¿ç¨‹å…±äº« TicketWindowRunnable ticketWindow = new TicketWindowRunnable(); Thread windowThread1 = new Thread(ticketWindow, \u0026quot;ä¸€å·çª—å£\u0026quot;); Thread windowThread2 = new Thread(ticketWindow, \u0026quot;äºŒå·çª—å£\u0026quot;); Thread windowThread3 = new Thread(ticketWindow, \u0026quot;ä¸‰å·çª—å£\u0026quot;); windowThread1.start(); windowThread2.start(); windowThread3.start(); } } public class TicketWindowRunnable implements Runnable { private int index = 1; private static final int MAX = 50; @Override public void run() { while (true) { if (index \u0026gt; MAX) {//1 break; } try { Thread.sleep(5); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread().getName()+\u0026quot; çš„å·ç æ˜¯ï¼š\u0026quot;+(index++));//2 } } }  å¤šè¿è¡Œå‡ éç¨‹åºï¼Œå°±ä¼šå‡ºç°ä¸‹é¢è¿™ä¸ªé—®é¢˜ï¼š\nåœ¨ä¸€å·çª—å£æ‹¿å®Œæœ€åä¸€ä¸ªå·ç ä¹‹åï¼ŒäºŒå·çª—å£å’Œä¸‰å·çª—å£åˆåç»­æ‹¿åˆ°äº† 52 å’Œ 51 å·ã€‚ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§ç°è±¡å‘¢ï¼Ÿ\né¦–å…ˆå½“ index=499 çš„æ—¶å€™ï¼Œä¸‰ä¸ªçº¿ç¨‹å‡ä¸æ»¡è¶³ index \u0026gt; MAXï¼Œéƒ½ä¼šå‘ä¸‹æ‰§è¡Œã€‚ä¸‰ä¸ªçº¿ç¨‹éƒ½å¯ä»¥å‘ä¸‹æ‰§è¡Œï¼Œå°† index åŠ  1ã€‚\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œå¼•å…¥äº† synchronized ã€‚\nä»€ä¹ˆæ˜¯ synchronized  synchronizedå…³é”®å­—å¯ä»¥å®ç°ä¸€ä¸ªç®€å•çš„ç­–ç•¥æ¥é˜²æ­¢çº¿ç¨‹å¹²æ‰°å’Œå†…å­˜ä¸€è‡´æ€§é”™è¯¯ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å¯¹å¤šä¸ªçº¿ç¨‹æ˜¯å¯è§çš„ï¼Œé‚£ä¹ˆå¯¹è¯¥å¯¹è±¡çš„æ‰€æœ‰è¯»æˆ–è€…å†™éƒ½å°†é€šè¿‡åŒæ­¥çš„æ–¹å¼æ¥è¿›è¡Œã€‚\n ä¸Šé¢è¿™æ®µè¯æ˜¯oracleå®˜ç½‘å¯¹synchronizedå…³é”®å­—çš„è§£é‡Šï¼Œå…·ä½“è¡¨ç°å¦‚ä¸‹ï¼š\n synchronizedå…³é”®å­—æä¾›äº†ä¸€ç§é”çš„æœºåˆ¶ï¼Œèƒ½å¤Ÿç¡®ä¿å…±äº«å˜é‡çš„äº’æ–¥è®¿é—®ï¼Œä»è€Œé˜²æ­¢æ•°æ®ä¸ä¸€è‡´é—®é¢˜çš„å‡ºç°ã€‚ synchronizedå…³é”®å­—åŒ…æ‹¬monitor enterå’Œmonitor exitä¸¤ä¸ªJVMæŒ‡ä»¤ï¼Œå®ƒèƒ½å¤Ÿä¿è¯åœ¨ä»»ä½•æ—¶å€™ä»»ä½•çº¿ç¨‹æ‰§è¡Œåˆ°monitor enteræˆåŠŸä¹‹å‰éƒ½å¿…é¡»ä»ä¸»å†…å­˜ä¸­è·å–æ•°æ®ï¼Œè€Œä¸æ˜¯ä»ç¼“å­˜ä¸­ï¼Œåœ¨monitor exitè¿è¡ŒæˆåŠŸä¹‹åï¼Œå…±äº«å˜é‡è¢«æ›´æ–°åçš„å€¼å¿…é¡»åˆ·å…¥ä¸»å†…å­˜ï¼ˆåœ¨æœ¬ä¹¦çš„ç¬¬ä¸‰éƒ¨åˆ†ä¼šé‡ç‚¹ä»‹ç»ï¼‰ã€‚ synchronizedçš„æŒ‡ä»¤ä¸¥æ ¼éµå®ˆjava happens-beforeè§„åˆ™ï¼Œä¸€ä¸ªmonitor exitæŒ‡ä»¤ä¹‹å‰å¿…å®šè¦æœ‰ä¸€ä¸ªmonitor enterã€‚  synchronizedå…³é”®å­—çš„ç”¨æ³• Javaé€šè¿‡ synchronized å¯¹å…±äº«æ•°æ®çš„çº¿ç¨‹è®¿é—®æä¾›äº†ä¸€ç§é¿å…ç«äº‰æ¡ä»¶çš„æœºåˆ¶ã€‚synchronized å¯ä»¥ä¿®é¥°æ–¹æ³•æˆ–è€…ä»£ç å—ï¼Œè¢«ä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—åŒä¸€æ—¶é—´åªä¼šå…è®¸ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œè¿™æ¡æ‰§è¡Œçš„çº¿ç¨‹æŒæœ‰åŒæ­¥éƒ¨åˆ†çš„é”ã€‚synchronized æ–¹æ³•ä¸èƒ½ç”¨äºå¯¹classåŠå…¶å˜é‡è¿›è¡Œä¿®é¥°ã€‚\nsynchronized å…³é”®å­—å¯ä»¥ä¿®é¥°æ–¹æ³•æˆ–è€…ä»£ç å—ï¼Œé‚£ä¹ˆè¿™ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ\n// åŒæ­¥ä»£ç å— public class TicketWindowRunnable implements Runnable { private int index = 1; private static final int MAX = 500; private final Object MONITOR = new Object(); @Override public void run() { while (true) { synchronized (MONITOR) { if (index \u0026gt; MAX) { break; } try { Thread.sleep(5); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread().getName() + \u0026quot; çš„å·ç æ˜¯ï¼š\u0026quot; + (index++)); } } } }  synchronized æ–¹æ³•ä¿®é¥°ä»£ç å—çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯ monitor é”ã€‚å†æ¥ç”¨ synchronized ä¿®é¥°ä¸€ä¸‹åŒæ­¥æ–¹æ³•ï¼š\n@Override public synchronized void run() { while (true) { if (index \u0026gt; MAX) { break; } try { Thread.sleep(5); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread().getName() + \u0026quot; çš„å·ç æ˜¯ï¼š\u0026quot; + (index++)); } }  è¿è¡Œä¹‹åå‘ç°éƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹åœ¨è·‘ï¼Œå¦å¤–ä¸¤ä¸ªçº¿ç¨‹æ— æ³•æ‰§è¡Œã€‚è¿™æ˜¯å› ä¸º synchronized åœ¨ä¿®é¥°æ–¹æ³•çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯ this é”ï¼Œå½“å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°é”è¿›åˆ° while å¾ªç¯ä¹‹åï¼Œå°±ä¸€ç›´å»åšäº‹æƒ…ï¼Œç›´åˆ°æ»¡è¶³æ¡ä»¶é€€å‡ºä¸ºæ­¢ã€‚å°† while é‡Œé¢çš„ä»£ç æŠ½å‡ºæ¥æ”¾åˆ°ä¸€ä¸ªæ–¹æ³•é‡Œï¼Œç”¨ synchronized æ¥ä¿®é¥°è¯¥æ–¹æ³•å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\n@Override public void run() { while (true) { if (ticket()) { break; } } } private synchronized boolean ticket() { if (index \u0026gt; MAX) { return true; } try { Thread.sleep(5); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread().getName() + \u0026quot; çš„å·ç æ˜¯ï¼š\u0026quot; + (index++)); return false; }  synchronized ä¿®é¥°æ–¹æ³•æ—¶é»˜è®¤æ˜¯ä½¿ç”¨çš„ this é”ï¼Œä¿®é¥°ä»£ç å—æ—¶ä½¿ç”¨çš„æ˜¯å¯¹è±¡é”ã€‚synchronized å…³é”®å­—è¿˜å¯ä»¥ç”¨æ¥ä¿®é¥°é™æ€æ–¹æ³•å’Œé™æ€ä»£ç å—ã€‚\npublic class SynchronizedStatic { public synchronized static void m1() { System.out.println(\u0026quot;m1 \u0026quot; + Thread.currentThread().getName()); try { Thread.sleep(10_000); } catch (InterruptedException e) { e.printStackTrace(); } } public synchronized static void m2() { System.out.println(\u0026quot;m2 \u0026quot; + Thread.currentThread().getName()); try { Thread.sleep(10_000); } catch (InterruptedException e) { e.printStackTrace(); } } } public class SynchronizedStaticTest { public static void main(String[] args) { new Thread(\u0026quot;T1\u0026quot;) { @Override public void run() { SynchronizedStatic.m1(); } }.start(); new Thread(\u0026quot;T2\u0026quot;) { @Override public void run() { SynchronizedStatic.m2(); } }.start(); } } // output m1 T1 m2 T2  é™æ€æ–¹æ³• m1 å’Œ m2 åŒæ—¶è¢« synchronized ä¿®é¥°ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹ T2 ä¼šç­‰åˆ°çº¿ç¨‹ T1 æ‰§è¡Œå®Œå†æ‰§è¡Œï¼Œè¯´æ˜è¿™ä¸¤ä¸ªæ–¹æ³•ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œè¿™å°±æ˜¯ Class é”ã€‚æˆ‘ä»¬æŠŠ sleep çš„æ—¶é—´å˜é•¿ä¸€ç‚¹æ¥è§‚å¯Ÿä¸€ä¸‹æ˜¯ä¸æ˜¯ Class é”ã€‚\nå¯ä»¥çœ‹åˆ°ï¼Œçº¿ç¨‹ T1 æ‰§è¡Œçš„æ—¶å€™ï¼ŒæŒæœ‰çš„æ˜¯ Class é”ï¼Œæ­¤æ—¶çº¿ç¨‹ T2 åœ¨ç­‰å¾… T1 æ‰§è¡Œå®Œé‡Šæ”¾é”ï¼Œå½“ T1 æ‰§è¡Œå®Œä¹‹åï¼ŒT2 æ‹¿åˆ° Class é”æ‰§è¡Œä»£ç ã€‚\näº†è§£äº† synchronized ä¿®é¥°é™æ€æ–¹æ³•ä½¿ç”¨çš„æ˜¯ Class é”ä¹‹åï¼Œæˆ‘ä»¬å†æ¥éªŒè¯ä¸€ä¸‹å½“å®ƒä¿®é¥°é™æ€æ–¹æ³•çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ä½¿ç”¨ Class é”ï¼Ÿ\npublic class SynchronizedStatic { public synchronized static void m1() { System.out.println(\u0026quot;m1 \u0026quot; + Thread.currentThread().getName()); try { Thread.sleep(100_000); } catch (InterruptedException e) { e.printStackTrace(); } } public static void m3() { System.out.println(\u0026quot;m3 \u0026quot; + Thread.currentThread().getName()); try { Thread.sleep(10_000); } catch (InterruptedException e) { e.printStackTrace(); } } } public class SynchronizedStaticTest { public static void main(String[] args) { new Thread(\u0026quot;T1\u0026quot;) { @Override public void run() { SynchronizedStatic.m1(); } }.start(); new Thread(\u0026quot;T3\u0026quot;) { @Override public void run() { SynchronizedStatic.m3(); } }.start(); } }  è¿™é‡ŒåŠ äº†ä¸€ä¸ªæ²¡æœ‰ synchronized ä¿®é¥°çš„é™æ€æ–¹æ³• m3ï¼Œè¿è¡Œä¹‹åå¾ˆå®¹æ˜“çŸ¥é“ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹æ˜¯åŒæ—¶è¿è¡Œçš„ã€‚æˆ‘ä»¬åœ¨ SynchronizedStatic å¼€å§‹çš„åœ°æ–¹åŠ ä¸€ä¸ªé™æ€ä»£ç å—ï¼Œé™æ€ä»£ç å—å†…éƒ¨ä½¿ç”¨ synchronized é”ã€‚\npublic class SynchronizedStatic { static { synchronized (SynchronizedStatic.class) { System.out.println(\u0026quot;static \u0026quot; + Thread.currentThread().getName()); try { Thread.sleep(10_000); } catch (InterruptedException e) { e.printStackTrace(); } } } public synchronized static void m1() { System.out.println(\u0026quot;m1 \u0026quot; + Thread.currentThread().getName()); try { Thread.sleep(100_000); } catch (InterruptedException e) { e.printStackTrace(); } } public static void m3() { System.out.println(\u0026quot;m3 \u0026quot; + Thread.currentThread().getName()); try { Thread.sleep(10_000); } catch (InterruptedException e) { e.printStackTrace(); } } } //output static T1 m1 T1 m3 T3  å¯ä»¥å‘ç°ï¼ŒT1 çº¿ç¨‹è¦å…ˆæ‰§è¡Œé™æ€ä»£ç å—æ‰èƒ½å¾€ä¸‹èµ°ï¼Œè¯´æ˜é™æ€ä»£ç å—ä½¿ç”¨çš„é”å’Œé™æ€æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œå¦å¤–è¿™ä¸ªæ—¶å€™æ²¡æœ‰ç”¨ synchronized ä¿®é¥°çš„ m3 ä¹Ÿè¦ç­‰é™æ€ä»£ç å—æ‰§è¡Œå®ä¾‹åŒ–æ‰è¡Œã€‚\næ€»ç»“ä¸€ä¸‹ï¼Œsynchronized å…³é”®å­—èƒ½å¤Ÿé¿å…å¤šçº¿ç¨‹ç«äº‰å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ï¼Œè¢« synchronized ä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—åŒä¸€æ—¶é—´åªä¼šå…è®¸ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œè¿™æ¡æ‰§è¡Œçš„çº¿ç¨‹æŒæœ‰åŒæ­¥éƒ¨åˆ†çš„é”ã€‚synchronized å…³é”®å­—ä¿®é¥°æ™®é€šæ–¹æ³•æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ this é”ï¼Œä¿®é¥°é™æ€æ–¹æ³•å’Œé™æ€ä»£ç å—æ—¶ï¼Œä½¿ç”¨ Class é”ï¼Œä¿®é¥°ä»£ç å—æ—¶ï¼Œä½¿ç”¨ LOCK é”ã€‚\n","date":"2020å¹´06æœˆ10æ—¥","permalink":"https://ahamoment.cn/posts/java/java-multithread-synchronized/","summary":"Synchronized ç®€ä»‹  æœ¬æ–‡å‡ºè‡ªæ±ªæ–‡å›è€å¸ˆçš„ã€ŠJava å¹¶å‘ç¼–ç¨‹ã€‹è¯¾ç¨‹ï¼Œå¦‚éœ€è½¬è½½ï¼Œè¯·æ³¨æ˜æºå‡ºå¤„ï¼\n å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œè¿™ä¸ªä¾‹å­æ˜¯æ¨¡æ‹Ÿé“¶è¡Œå«å·çš„ï¼Œä½¿ç”¨ä¸‰ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿä¸‰ä¸ªæŸœå°ä¸€èµ·å«å·ï¼Œæ€»å…±50ä¸ªå·ã€‚åœ¨ä¸åŠ  synchronized çš„å…³é”®å­—çš„æƒ…å†µä¸‹ï¼Œå¾ˆå®¹æ˜“å°±ä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚\npublic class BankRunnable { public static void main(String[] args) { // ä¸€ä¸ªrunnableå®ä¾‹è¢«å¤šä¸ªçº¿ç¨‹å…±äº« TicketWindowRunnable ticketWindow = new TicketWindowRunnable(); Thread windowThread1 = new Thread(ticketWindow, \u0026quot;ä¸€å·çª—å£\u0026quot;); Thread windowThread2 = new Thread(ticketWindow, \u0026quot;äºŒå·çª—å£\u0026quot;); Thread windowThread3 = new Thread(ticketWindow, \u0026quot;ä¸‰å·çª—å£\u0026quot;); windowThread1.","title":"Java å¤šçº¿ç¨‹ - åˆè¯† Synchronized"},{"contents":" æœ¬æ–‡ç¿»è¯‘è‡ª20 Practical Examples of RPM Commands in Linux\n RMP (Red Hat Package Manager) æ˜¯ä¸€æ¬¾ Red Hat ç³»ç»Ÿçš„å¼€æºåŒ…ç®¡ç†å·¥å…·ï¼Œæ”¯æŒå®‰è£…ã€æ›´æ–°ã€å¸è½½ã€æŸ¥è¯¢ã€éªŒè¯å’Œç®¡ç†ç³»ç»Ÿè½¯ä»¶åŒ…ã€‚RPMä»¥å‰ç§°ä¸º .rpm æ–‡ä»¶ï¼Œæ–‡ä»¶å†…åŒ…å«ç¼–è¯‘å¥½çš„è½¯ä»¶å’ŒåŒ…æ‰€éœ€è¦çš„åº“ã€‚\nè¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº† 20 ä¸ªå¸¸ç”¨çš„ RPM å‘½ä»¤ã€‚\nå…³äº RPM çš„ä¸€äº›å¸¸è¯†   RPM æ˜¯å…è´¹çš„ï¼Œå¹¶ä¸”éµå¾ª GPL å¼€æºåè®®\n  RPM å°†æ‰€æœ‰å·²å®‰è£…è½¯ä»¶åŒ…çš„ä¿¡æ¯ä¿å­˜åœ¨ /var/lib/rpm æ•°æ®åº“ä¸­ã€‚\n  RPM æ˜¯åœ¨ Linux ç³»ç»Ÿä¸‹å®‰è£…è½¯ä»¶åŒ…çš„å”¯ä¸€æ–¹æ³•ï¼Œå¦‚æœæ‚¨ä½¿ç”¨æºä»£ç å®‰è£…äº†è½¯ä»¶åŒ…ï¼Œåˆ™ rpm å°†æ— æ³•å¯¹å…¶è¿›è¡Œç®¡ç†ã€‚\n  RPM å¤„ç† .rpm æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³è½¯ä»¶åŒ…çš„å®é™…ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šå®ƒæ˜¯ä»€ä¹ˆï¼Œå®ƒæ¥è‡ªå“ªé‡Œï¼Œè½¯ä»¶ä¾èµ–ä¿¡æ¯ï¼Œç‰ˆæœ¬ä¿¡æ¯ç­‰ã€‚\n  RPMå‘½ä»¤çš„äº”ä¸ªåŸºæœ¬æ¨¡å¼  Install : ä½¿ç”¨äºå®‰è£…ä»»æ„çš„ RPM åŒ…ã€‚ Remove ï¼šç”¨äºæ“¦é™¤ï¼Œåˆ é™¤æˆ–å¸è½½ä»»ä½• RPM è½¯ä»¶åŒ…ã€‚ Upgrade : ç”¨äºæ›´æ–°å·²ç»å­˜åœ¨çš„ RPM è½¯ä»¶åŒ…ã€‚ Verify ï¼šç”¨æ¥éªŒè¯ RPM è½¯ä»¶åŒ…ã€‚ Queryï¼šç”¨æ¥æŸ¥è¯¢ RPM è½¯ä»¶åŒ…ã€‚  æŸ¥æ‰¾å’Œä¸‹è½½ RPM åŒ… ä»¥ä¸‹æ˜¯rpmç½‘ç«™çš„åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­æ‰¾åˆ°å’Œä¸‹è½½æ‰€æœ‰RPMè½¯ä»¶åŒ…ã€‚\n http://rpmfind.net http://www.redhat.com http://freshrpms.net/ http://rpm.pbone.net/  1. æ£€æŸ¥ RPM åŒ…çš„ç­¾å åœ¨å°†è½¯ä»¶åŒ…å®‰è£…åœ¨Linuxç³»ç»Ÿä¸Šä¹‹å‰ï¼Œå…ˆæ£€æŸ¥è½¯ä»¶åŒ…çš„ PGP ç­¾åï¼Œå¹¶ç¡®ä¿å…¶å®Œæ•´æ€§å’Œæ¥æºæ˜¯æ­£ç¡®çš„ã€‚ä½¿ç”¨ â€“-checksig (check signature) å‘½ä»¤æ£€æŸ¥ RPM åŒ…çš„ç­¾åã€‚\n[root@tecmint]# rpm --checksig pidgin-2.7.9-5.el6.2.i686.rpm pidgin-2.7.9-5.el6.2.i686.rpm: rsa sha1 (md5) pgp md5 OK  2. å®‰è£… RPM åŒ… ä½¿ç”¨ -i é€‰é¡¹å®‰è£… RPM åŒ…\n[root@localhost ~]# rpm -ivh tree-1.6.0-10.el7.x86_64.rpm å‡†å¤‡ä¸­... ################################# [100%] æ­£åœ¨å‡çº§/å®‰è£…... 1:tree-1.6.0-10.el7 ################################# [100%]  RPM å‘½ä»¤å’Œé€‰é¡¹\n  -i : å®‰è£…åŒ…\n  -v : è¯¦ç»†æ˜¾ç¤º\n  -h åœ¨æ‰“åŒ…å½’æ¡£æ–‡ä»¶è§£å‹ç¼©æ—¶æ‰“å°å“ˆå¸Œæ ‡è®°ã€‚\n  3. å®‰è£… RPM åŒ…ä¹‹å‰æ£€æŸ¥åŒ…ä¾èµ– [root@localhost ~]# rpm -qpR tree-1.6.0-10.el7.x86_64.rpm libc.so.6()(64bit) libc.so.6(GLIBC_2.14)(64bit) libc.so.6(GLIBC_2.2.5)(64bit) libc.so.6(GLIBC_2.3)(64bit) libc.so.6(GLIBC_2.3.4)(64bit) libc.so.6(GLIBC_2.4)(64bit) rpmlib(CompressedFileNames) \u0026lt;= 3.0.4-1 rpmlib(FileDigests) \u0026lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) \u0026lt;= 4.0-1 rtld(GNU_HASH) rpmlib(PayloadIsXz) \u0026lt;= 5.2-1  å‘½ä»¤å’Œé€‰é¡¹è¯´æ˜ï¼š\n -q : æŸ¥è¯¢ä¸€ä¸ªåŒ… -p: åˆ—å‡ºæ­¤è½¯ä»¶åŒ…æä¾›çš„åŠŸèƒ½ã€‚ -R: åˆ—å‡ºæ­¤ç¨‹åºåŒ…æ‰€ä¾èµ–çš„åŠŸèƒ½ã€‚  4. å¿½ç•¥ä¾èµ–å®‰è£… RPM åŒ… å¦‚æœå·²ç»çŸ¥é“æ‰€æœ‰å¿…éœ€çš„è½¯ä»¶åŒ…éƒ½å·²å®‰è£…ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨å®‰è£…è½¯ä»¶åŒ…ä¹‹å‰ä½¿ç”¨ -â€“nodeps(no dependencies check) é€‰é¡¹æ¥å¿½ç•¥é‚£äº›ä¾èµ–é¡¹ã€‚\n[root@localhost ~]# rpm -ivh --nodeps tree-1.6.0-10.el7.x86_64.rpm å‡†å¤‡ä¸­... ################################# [100%] è½¯ä»¶åŒ… tree-1.6.0-10.el7.x86_64 å·²ç»å®‰è£…  ä¸Šé¢çš„å‘½ä»¤é€šè¿‡å¿½ç•¥ä¾èµ–é¡¹é”™è¯¯æ¥å¼ºåˆ¶å®‰è£…rpmè½¯ä»¶åŒ…ï¼Œä½†æ˜¯å¦‚æœç¼ºå°‘é‚£äº›ä¾èµ–é¡¹æ–‡ä»¶ä¼šå¯¼è‡´ç¨‹åºå°†æ— æ³•è¿è¡Œã€‚\n5. æŸ¥æ‰¾ä¸€ä¸ªå·²ç»å®‰è£…çš„ RPM åŒ… åœ¨è½¯ä»¶åŒ…åç§°ä¸­ä½¿ç”¨ -q é€‰é¡¹ï¼Œå°†æ˜¾ç¤ºæ˜¯å¦å·²å®‰è£… rpm åŒ…ã€‚\n[root@localhost ~]# rpm -q tree tree-1.6.0-10.el7.x86_64  6. åˆ—å‡ºå·²å®‰è£…çš„RPMè½¯ä»¶åŒ…çš„æ‰€æœ‰æ–‡ä»¶ è¦æŸ¥çœ‹å·²å®‰è£…çš„rpmè½¯ä»¶åŒ…çš„æ‰€æœ‰æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨ -qlï¼ˆquery listï¼‰ rpm å‘½ä»¤ã€‚\n[root@localhost ~]# rpm -ql tree /usr/bin/tree /usr/share/doc/tree-1.6.0 /usr/share/doc/tree-1.6.0/LICENSE /usr/share/doc/tree-1.6.0/README /usr/share/man/man1/tree.1.gz  7. åˆ—å‡ºæœ€è¿‘å®‰è£…çš„ RPM åŒ… ä½¿ç”¨ -qa(query all) å‘½ä»¤ï¼Œä¼šåˆ—å‡ºæœ€è¿‘å®‰è£…çš„æ‰€æœ‰ RPM åŒ…\n[root@localhost ~]# rpm -qa --last tree-1.6.0-10.el7.x86_64 2020å¹´06æœˆ01æ—¥ æ˜ŸæœŸä¸€ 19æ—¶04åˆ†28ç§’ perl-Git-1.8.3.1-22.el7_8.noarch 2020å¹´06æœˆ01æ—¥ æ˜ŸæœŸä¸€ 14æ—¶18åˆ†37ç§’ git-1.8.3.1-22.el7_8.x86_64 2020å¹´06æœˆ01æ—¥ æ˜ŸæœŸä¸€ 14æ—¶18åˆ†36ç§’ perl-TermReadKey-2.30-20.el7.x86_64 2020å¹´06æœˆ01æ—¥ æ˜ŸæœŸä¸€ 14æ—¶18åˆ†34ç§’ rsync-3.1.2-10.el7.x86_64 2020å¹´06æœˆ01æ—¥ æ˜ŸæœŸä¸€ 14æ—¶18åˆ†33ç§’ perl-Error-0.17020-2.el7.noarch 2020å¹´06æœˆ01æ—¥ æ˜ŸæœŸä¸€ 14æ—¶18åˆ†33ç§’ nux-dextop-release-0-5.el7.nux.noarch 2020å¹´05æœˆ22æ—¥ æ˜ŸæœŸäº” 19æ—¶40åˆ†35ç§’ gpg-pubkey-85c6cd8a-4e060c35 2020å¹´05æœˆ22æ—¥ æ˜ŸæœŸäº” 19æ—¶40åˆ†19ç§’ epel-release-7-11.noarch 2020å¹´05æœˆ22æ—¥ æ˜ŸæœŸäº” 19æ—¶39åˆ†27ç§’ libtirpc-0.2.4-0.16.el7.x86_64 2020å¹´05æœˆ22æ—¥ æ˜ŸæœŸäº” 18æ—¶58åˆ†40ç§’ vim-enhanced-7.4.629-6.el7.x86_64 2020å¹´05æœˆ22æ—¥ æ˜ŸæœŸäº” 17æ—¶48åˆ†48ç§’ vim-common-7.4.629-6.el7.x86_64 2020å¹´05æœˆ22æ—¥ æ˜ŸæœŸäº” 17æ—¶48åˆ†48ç§’ vim-filesystem-7.4.629-6.el7.x86_64 2020å¹´05æœˆ22æ—¥ æ˜ŸæœŸäº” 17æ—¶48åˆ†44ç§’ ...  8. åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„ RPM åŒ… é”®å…¥ä»¥ä¸‹å‘½ä»¤ä»¥æ‰“å°Linuxç³»ç»Ÿä¸Šå·²å®‰è£…è½¯ä»¶åŒ…çš„æ‰€æœ‰åç§°ã€‚è¯¥å‘½ä»¤å’Œ grep ä¸€èµ·ä½¿ç”¨ï¼Œå³å¯æœç´¢åˆ°æˆ‘ä»¬æ˜¯å¦å®‰è£…è¿‡æŸä¸ªåŒ…ï¼Œä¾‹å¦‚ rpm -qa | grep gitï¼ŒæŸ¥çœ‹æˆ‘ä»¬æ˜¯å¦å®‰è£…è¿‡ git ã€‚\n[root@localhost ~]# rpm -qa kexec-tools-2.0.15-43.el7.x86_64 grub2-common-2.02-0.81.el7.centos.noarch openssh-clients-7.4p1-21.el7.x86_64 setup-2.8.71-11.el7.noarch authconfig-6.2.8-30.el7.x86_64 basesystem-10.0-7.el7.centos.noarch postfix-2.10.1-9.el7.x86_64 ncurses-base-5.9-14.20130511.el7_4.noarch kbd-1.15.5-15.el7.x86_64 kbd-misc-1.15.5-15.el7.noarch qemu-guest-agent-2.12.0-3.el7.x86_64 ...  9. æ›´æ–° RPM åŒ… ä½¿ç”¨ -U(upgrade) é€‰é¡¹æ¥å‡çº§ RPM åŒ…ã€‚è¯¥å‘½ä»¤ä¸ä»…ä¼šå°†æŸä¸ª rpm åŒ…å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œè€Œä¸”è¿˜ä¼šç»´æŠ¤æ—§è½¯ä»¶åŒ…çš„å¤‡ä»½ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‡çº§è½¯ä»¶åŒ…ä¸èƒ½ä½¿ç”¨çš„æ—¶å€™è¿˜èƒ½ä½¿ç”¨æ—§çš„ RPM åŒ…ã€‚\n[root@localhost ~]# rpm -Uvh tree-1.6.0-10.el7.x86_64.rpm å‡†å¤‡ä¸­... ################################# [100%] è½¯ä»¶åŒ… tree-1.6.0-10.el7.x86_64 å·²ç»å®‰è£…  10. åˆ é™¤ RPM åŒ… ä½¿ç”¨ -e (erase) å‘½ä»¤æ¥ç§»é™¤å·²å®‰è£…çš„ rpm åŒ…ã€‚å¦‚æœè¦ç§»é™¤çš„ RPM åŒ…ä¸å­˜åœ¨ï¼Œå°±ä¼šæœ‰é”™è¯¯æç¤ºã€‚\n[root@localhost ~]# rpm -evv tree D: loading keyring from pubkeys in /var/lib/rpm/pubkeys/*.key D: couldn't find any keys in /var/lib/rpm/pubkeys/*.key D: loading keyring from rpmdb D: opening db environment /var/lib/rpm cdb:0x401 D: opening db index /var/lib/rpm/Packages 0x400 mode=0x0 D: locked db index /var/lib/rpm/Packages D: opening db index /var/lib/rpm/Name 0x400 mode=0x0 D: read h# 302 å¤´ SHA1 æ‘˜è¦ï¼š OK (489efff35e604042709daf46fb78611fe90a75aa) D: added key gpg-pubkey-f4a80eb5-53a7ff4b to keyring D: read h# 371 å¤´ SHA1 æ‘˜è¦ï¼š OK (052c9c3b53cea0014763d9f82c173a87dc743eea) D: added key gpg-pubkey-85c6cd8a-4e060c35 to keyring D: Using legacy gpg-pubkey(s) from rpmdb D: read h# 380 å¤´V3 RSA/SHA256 Signature, å¯†é’¥ ID f4a80eb5: OK D: opening db index /var/lib/rpm/Conflictname 0x400 mode=0x0 D: ========== --- tree-1.6.0-10.el7 x86_64/linux 0x2 D: opening db index /var/lib/rpm/Requirename 0x400 mode=0x0 D: ========== recording tsort relations D: ========== tsorting packages (order, #predecessors, #succesors, depth) D: 0 0 0 1 -tree-1.6.0-10.el7.x86_64 D: erasing packages D: closed db index /var/lib/rpm/Conflictname D: closed db index /var/lib/rpm/Requirename D: closed db index /var/lib/rpm/Name D: closed db index /var/lib/rpm/Packages D: closed db environment /var/lib/rpm D: opening db environment /var/lib/rpm cdb:0x401 D: opening db index /var/lib/rpm/Packages (none) mode=0x42 D: sanity checking 1 elements D: running pre-transaction scripts D: computing 5 file fingerprints D: opening db index /var/lib/rpm/Name (none) mode=0x42 D: opening db index /var/lib/rpm/Basenames (none) mode=0x42 D: opening db index /var/lib/rpm/Group (none) mode=0x42 D: opening db index /var/lib/rpm/Requirename (none) mode=0x42 D: opening db index /var/lib/rpm/Providename (none) mode=0x42 D: opening db index /var/lib/rpm/Conflictname (none) mode=0x42 D: opening db index /var/lib/rpm/Obsoletename (none) mode=0x42 D: opening db index /var/lib/rpm/Triggername (none) mode=0x42 D: opening db index /var/lib/rpm/Dirnames (none) mode=0x42 D: opening db index /var/lib/rpm/Installtid (none) mode=0x42 D: opening db index /var/lib/rpm/Sigmd5 (none) mode=0x42 D: opening db index /var/lib/rpm/Sha1header (none) mode=0x42 è½¯ä»¶åŒ…å‡†å¤‡ä¸­... D: computing file dispositions D: 0x0000fd00 4096 9228841 19356493 / D: ========== +++ tree-1.6.0-10.el7 x86_64-linux 0x2 D: read h# 380 å¤´V3 RSA/SHA256 Signature, å¯†é’¥ ID f4a80eb5: OK D: erase: tree-1.6.0-10.el7 has 5 files tree-1.6.0-10.el7.x86_64 D: erase 100644 1 ( 0, 0) 4100 /usr/share/man/man1/tree.1.gz D: erase 100644 1 ( 0, 0) 4628 /usr/share/doc/tree-1.6.0/README D: erase 100644 1 ( 0, 0) 18009 /usr/share/doc/tree-1.6.0/LICENSE D: erase 040755 2 ( 0, 0) 6 /usr/share/doc/tree-1.6.0 D: erase 100755 1 ( 0, 0) 62768 /usr/bin/tree D: --- h# 380 tree-1.6.0-10.el7.x86_64 D: removing \u0026quot;tree\u0026quot; from Name index. D: removing 5 entries from Basenames index. D: removing \u0026quot;Applications/File\u0026quot; from Group index. D: removing 11 entries from Requirename index. D: removing 2 entries from Providename index. D: removing 4 entries from Dirnames index. D: removing 1 entries from Installtid index. D: removing 1 entries from Sigmd5 index. D: removing \u0026quot;a09f99f73ee3fe352489e734c63c32fa41b1be56\u0026quot; from Sha1header index. D: running post-transaction scripts D: closed db index /var/lib/rpm/Sha1header D: closed db index /var/lib/rpm/Sigmd5 D: closed db index /var/lib/rpm/Installtid D: closed db index /var/lib/rpm/Dirnames D: closed db index /var/lib/rpm/Triggername D: closed db index /var/lib/rpm/Obsoletename D: closed db index /var/lib/rpm/Conflictname D: closed db index /var/lib/rpm/Providename D: closed db index /var/lib/rpm/Requirename D: closed db index /var/lib/rpm/Group D: closed db index /var/lib/rpm/Basenames D: closed db index /var/lib/rpm/Name D: closed db index /var/lib/rpm/Packages D: closed db environment /var/lib/rpm [root@localhost ~]# echo $? 0 [root@localhost ~]# rpm -e tree é”™è¯¯ï¼šæœªå®‰è£…è½¯ä»¶åŒ… tree  11. å¿½ç•¥ä¾èµ–åœ°åˆ é™¤RPM åŒ… ä½¿ç”¨ \u0026ndash;nodeps (Do not check dependencies) å‘½ä»¤é¡¹å¼ºåˆ¶ä»ç³»ç»Ÿä¸­åˆ é™¤ RPM åŒ…ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ é™¤ç‰¹å®šçš„è½¯ä»¶åŒ…å¯èƒ½ä¼šç ´åå…¶ä»–æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚\n[root@localhost ~]# rpm -ev --nodeps tree  12. æŸ¥çœ‹ä¸€ä¸ªæ–‡ä»¶å±äºå“ªä¸ª RPM åŒ… å‡è®¾æœ‰ä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶ä¸”æƒ³æ‰¾å‡ºè¿™äº›æ–‡ä»¶å±äºå“ªä¸ª RPM åŒ…çš„ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ -qf (query file) å‘½ä»¤ã€‚\n[root@localhost ~]# rpm -qf /usr/bin/tree tree-1.6.0-10.el7.x86_64  13. æŸ¥çœ‹å·²å®‰è£…çš„ RPM åŒ…çš„ä¿¡æ¯ ä½¿ç”¨ -qi (query info) å‘½ä»¤æŸ¥è¯¢æƒ³è¦çŸ¥é“çš„ rpm åŒ…çš„ä¿¡æ¯ã€‚\n[root@localhost ~]# rpm -qi tree Name : tree Version : 1.6.0 Release : 10.el7 Architecture: x86_64 Install Date: 2020å¹´06æœˆ02æ—¥ æ˜ŸæœŸäºŒ 19æ—¶05åˆ†24ç§’ Group : Applications/File Size : 89505 License : GPLv2+ Signature : RSA/SHA256, 2014å¹´07æœˆ04æ—¥ æ˜ŸæœŸäº” 13æ—¶36åˆ†46ç§’, Key ID 24c6a8a7f4a80eb5 Source RPM : tree-1.6.0-10.el7.src.rpm Build Date : 2014å¹´06æœˆ10æ—¥ æ˜ŸæœŸäºŒ 03æ—¶28åˆ†53ç§’ Build Host : worker1.bsys.centos.org Relocations : (not relocatable) Packager : CentOS BuildSystem \u0026lt;http://bugs.centos.org\u0026gt; Vendor : CentOS URL : http://mama.indstate.edu/users/ice/tree/ Summary : File system tree viewer Description : The tree utility recursively displays the contents of directories in a tree-like format. Tree is basically a UNIX port of the DOS tree utility.  14. åœ¨å®‰è£…ä¹‹å‰è·å– RPM åŒ…çš„ä¿¡æ¯ å‡è®¾ä½ ä»ç½‘ä¸Šä¸‹è½½äº†ä¸€ä¸ª rpm åŒ…ï¼Œå¹¶ä¸”æƒ³è¦åœ¨å®‰è£…ä¹‹å‰çŸ¥é“è¿™ä¸ª rpm åŒ…çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ -qip (query info package) è¿™ä¸ªå‘½ä»¤æ¥æ‰“å°è½¯ä»¶åŒ…çš„ä¿¡æ¯ã€‚\n[root@localhost ~]# rpm -qip python3-3.6.8-13.el7.x86_64.rpm Name : python3 Version : 3.6.8 Release : 13.el7 Architecture: x86_64 Install Date: (not installed) Group : Unspecified Size : 39904 License : Python Signature : RSA/SHA256, 2020å¹´04æœˆ04æ—¥ æ˜ŸæœŸå…­ 05æ—¶06åˆ†11ç§’, Key ID 24c6a8a7f4a80eb5 Source RPM : python3-3.6.8-13.el7.src.rpm Build Date : 2020å¹´04æœˆ02æ—¥ æ˜ŸæœŸå›› 22æ—¶17åˆ†47ç§’ Build Host : x86-01.bsys.centos.org Relocations : (not relocatable) Packager : CentOS BuildSystem \u0026lt;http://bugs.centos.org\u0026gt; Vendor : CentOS URL : https://www.python.org/ Summary : Interpreter of the Python programming language Description : Python is an accessible, high-level, dynamically typed, interpreted programming language, designed with an emphasis on code readability. It includes an extensive standard library, and has a vast ecosystem of third-party libraries. The python3 package provides the \u0026quot;python3\u0026quot; executable: the reference interpreter for the Python language, version 3. The majority of its standard library is provided in the python3-libs package, which should be installed automatically along with python3. The remaining parts of the Python standard library are broken out into the python3-tkinter and python3-test packages, which may need to be installed separately. Documentation for Python is provided in the python3-docs package. Packages containing additional libraries for Python are generally named with the \u0026quot;python3-\u0026quot; prefix.  15. æŸ¥çœ‹ RPM åŒ…å®‰è£…äº†å“ªäº›ç›®å½• è¦è·å–å·²å®‰è£…è½¯ä»¶åŒ…çš„æ–‡ä»¶åˆ—è¡¨ï¼Œä½¿ç”¨é€‰é¡¹ -qdfï¼ˆquery document file) çš„å‘½ä»¤ã€‚\n[root@localhost ~]# rpm -qdf /usr/bin/tree /usr/share/doc/tree-1.6.0/LICENSE /usr/share/doc/tree-1.6.0/README /usr/share/man/man1/tree.1.gz  16. éªŒè¯ä¸€ä¸ª RPM åŒ… éªŒè¯è½¯ä»¶åŒ…ä¼šå°†è½¯ä»¶åŒ…å·²å®‰è£…æ–‡ä»¶çš„ä¿¡æ¯ä¸rpmæ•°æ®åº“è¿›è¡Œæ¯”è¾ƒã€‚ä½¿ç”¨ -Vp (verify package) å‘½ä»¤æ¥éªŒè¯ä¸€ä¸ªè½¯ä»¶åŒ…ã€‚\n[root@localhost ~]# rpm -Vp python3-3.6.8-13.el7.x86_64.rpm æœªæ»¡è¶³çš„ä¾èµ–å…³ç³» python3-3.6.8-13.el7.x86_64ï¼š libpython3.6m.so.1.0()(64bit) è¢« python3-3.6.8-13.el7.x86_64 éœ€è¦ python3-libs(x86-64) = 3.6.8-13.el7 è¢« python3-3.6.8-13.el7.x86_64 éœ€è¦ python3-pip è¢« python3-3.6.8-13.el7.x86_64 éœ€è¦ python3-setuptools è¢« python3-3.6.8-13.el7.x86_64 éœ€è¦ é—æ¼ /usr/bin/pydoc3 é—æ¼ /usr/bin/pydoc3.6 é—æ¼ /usr/bin/python3 é—æ¼ /usr/bin/python3.6 é—æ¼ /usr/bin/python3.6m é—æ¼ /usr/bin/pyvenv é—æ¼ /usr/bin/pyvenv-3.6 é—æ¼ /usr/share/doc/python3-3.6.8 é—æ¼ d /usr/share/doc/python3-3.6.8/README.rst é—æ¼ /usr/share/licenses/python3-3.6.8 é—æ¼ l /usr/share/licenses/python3-3.6.8/LICENSE é—æ¼ d /usr/share/man/man1/python3.1.gz é—æ¼ d /usr/share/man/man1/python3.6.1.gz  17. éªŒè¯æ‰€æœ‰çš„ RPM åŒ… [root@tecmint]# rpm -Va S.5....T. c /etc/rc.d/rc.local .......T. c /etc/dnsmasq.conf .......T. /etc/ld.so.conf.d/kernel-2.6.32-279.5.2.el6.i686.conf S.5....T. c /etc/yum.conf S.5....T. c /etc/yum.repos.d/epel.repo  18. å¯¼å…¥ GPG key è¦éªŒè¯ RHEL / CentOS / Fedora è½¯ä»¶åŒ…ï¼Œå¿…é¡»å¯¼å…¥ GPG å¯†é’¥ã€‚ä¸ºæ­¤ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå®ƒå°†å¯¼å…¥CentOS 6 GPGå¯†é’¥ã€‚\n[root@localhost ~]# rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7  19. åˆ—å‡ºæ‰€æœ‰å¯¼å…¥çš„ RPM GPG key [root@localhost ~]# rpm -qa gpg-pubkey* gpg-pubkey-85c6cd8a-4e060c35 gpg-pubkey-f4a80eb5-53a7ff4b  20. é‡å»ºæŸåçš„RPMæ•°æ®åº“ æœ‰æ—¶rpmæ•°æ®åº“æŸåå¹¶åœæ­¢rpmå’Œç³»ç»Ÿä¸Šå…¶ä»–åº”ç”¨ç¨‹åºçš„æ‰€æœ‰åŠŸèƒ½ã€‚å› æ­¤ï¼Œå½“æ—¶æˆ‘ä»¬éœ€è¦é‡å»ºrpmæ•°æ®åº“å¹¶åœ¨ä»¥ä¸‹å‘½ä»¤çš„å¸®åŠ©ä¸‹å°†å…¶è¿˜åŸã€‚\n[root@tecmint]# cd /var/lib [root@tecmint]# rm __db* [root@tecmint]# rpm --rebuilddb [root@tecmint]# rpmdb_verify Packages  21. æŸ¥çœ‹ RPM çš„è„šæœ¬ rpm -qp --scripts \u0026lt;rpm file name\u0026gt;  export LD_LIBRARY_PATH=/apps/svr/python3/lib:$LD_LIBRARY_PATHï¼›\n","date":"2020å¹´06æœˆ02æ—¥","permalink":"https://ahamoment.cn/posts/linux/linux-20-rpm-command/","summary":"æœ¬æ–‡ç¿»è¯‘è‡ª20 Practical Examples of RPM Commands in Linux\n RMP (Red Hat Package Manager) æ˜¯ä¸€æ¬¾ Red Hat ç³»ç»Ÿçš„å¼€æºåŒ…ç®¡ç†å·¥å…·ï¼Œæ”¯æŒå®‰è£…ã€æ›´æ–°ã€å¸è½½ã€æŸ¥è¯¢ã€éªŒè¯å’Œç®¡ç†ç³»ç»Ÿè½¯ä»¶åŒ…ã€‚RPMä»¥å‰ç§°ä¸º .rpm æ–‡ä»¶ï¼Œæ–‡ä»¶å†…åŒ…å«ç¼–è¯‘å¥½çš„è½¯ä»¶å’ŒåŒ…æ‰€éœ€è¦çš„åº“ã€‚","title":"20 å¸¸ç”¨çš„ RPM å‘½ä»¤"},{"contents":"ä¸€ã€å‡†å¤‡ Itellj IDEAï¼Œ jdk1.8 çš„æºä»£ç åŒ…(è§£å‹ jdk ç›®å½•ä¸‹çš„ src.zip åŒ…å¾—åˆ°)\näºŒã€é¡¹ç›®ç»“æ„ IDEA åˆ›å»ºä¸€ä¸ªæ™®é€šçš„ java é¡¹ç›® æŠŠè§£å‹å¾—åˆ°çš„ jdk1.8 çš„æºä»£ç å¤åˆ¶åˆ° source ç›®å½•ä¸‹ï¼š test ç›®å½•ç”¨æ¥å†™æµ‹è¯•ç”¨ä¾‹, è¿™é‡Œç”¨ä¸åˆ° Main æ–¹æ³•ã€‚\nä¸‰ã€IDEA è®¾ç½®  Project Structure -\u0026gt; Project è®¾ç½®é¡¹ç›®çš„ SDK (jdk8u221)ï¼Œlanguage level é€‰æ‹© 8 - Lambdas, type annotations etc.  Project Structure -\u0026gt; Dependencies é€‰æ‹© Modulesï¼ŒSDK é€‰æ‹© 1.8_221  è®¾ç½®å¹³å°çš„ SDK æºä»£ç è·¯å¾„ä¸ºè‡ªå·±é¡¹ç›®çš„ source ç›®å½•  è°ƒæ•´ç¼–è¯‘çº¿ç¨‹çš„å †å¤§å°ï¼Œé¿å…å†…å­˜ä¸è¶³ï¼Œç¼–è¯‘æ— æ³•é€šè¿‡ï¼Œè°ƒæ•´åˆ° 1G ä»¥ä¸Šã€‚  IDEA é»˜è®¤è°ƒè¯•æ˜¯ä¸ä¼šè¿›å…¥åˆ° jdk çš„æºä»£ç çš„ï¼Œåœ¨ Debugger è®¾ç½®ä¸­å…è®¸è¿›å…¥åˆ° jdk çš„åŒ… åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å®Œæˆäº† idea çš„è®¾ç½®ï¼Œå¯ä»¥å¼€å§‹å†™ä¸ªæµ‹è¯•ç¨‹åºç¼–è¯‘è¿è¡Œã€‚  å››ã€ç¼–è¯‘è°ƒå¼ åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±»è¿›è¡Œè°ƒè¯•ï¼š\nimport java.util.HashMap; import java.util.Map; public class Test { public static void main(String[] args) { Map\u0026lt;String, Double\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); hashMap.put(\u0026quot;k1\u0026quot;, 0.1); hashMap.put(\u0026quot;k2\u0026quot;, 0.2); hashMap.put(\u0026quot;k3\u0026quot;, 0.3); hashMap.put(\u0026quot;k4\u0026quot;, 0.4); } }  è¿›å…¥ debug ä¹‹åï¼Œå°±å¯ä»¥åœ¨æºä»£ç é‡Œå†™ä¸€äº›ç¬”è®°äº†ã€‚ äº”ã€ç¼–è¯‘é—®é¢˜ ç»å¸¸ç¢°åˆ°çš„å‡ ä¸ªé—®é¢˜ï¼š\n  ç¼ºå°‘com.sun.toolsåŒ… ç¼ºå°‘sun.awt.UNIXToolkit å’Œ sun.font.FontConfigManagerè¿™ä¸¤ä¸ªç±»   è§£å†³åŠæ³•å¯ä»¥å‚è€ƒè¿™ç¯‡åšå®¢ï¼šJDK1.8æºç åˆ†æ03ä¹‹ideaæ­å»ºæºç é˜…è¯»ç¯å¢ƒ\n","date":"2020å¹´05æœˆ11æ—¥","permalink":"https://ahamoment.cn/posts/java/java-source-code-learn/","summary":"ä¸€ã€å‡†å¤‡ Itellj IDEAï¼Œ jdk1.8 çš„æºä»£ç åŒ…(è§£å‹ jdk ç›®å½•ä¸‹çš„ src.zip åŒ…å¾—åˆ°)\näºŒã€é¡¹ç›®ç»“æ„ IDEA åˆ›å»ºä¸€ä¸ªæ™®é€šçš„ java é¡¹ç›® æŠŠè§£å‹å¾—åˆ°çš„ jdk1.8 çš„æºä»£ç å¤åˆ¶åˆ° source ç›®å½•ä¸‹ï¼š test ç›®å½•ç”¨æ¥å†™æµ‹è¯•ç”¨ä¾‹, è¿™é‡Œç”¨ä¸åˆ° Main æ–¹æ³•ã€‚","title":"JDK1.8 æºä»£ç é˜…è¯»ç¯å¢ƒæ­å»º"},{"contents":"è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»ä½¿ç”¨spring boot å‘é€é‚®ä»¶ã€‚\n1. Maven ä¾èµ– \u0026lt;!--mail--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-mail\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt;   å¦‚æœéœ€è¦æŒ‡å®šç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥ä»mvn repoä¸­æ‰¾åˆ°ä½ éœ€è¦çš„ç‰ˆæœ¬å·ã€‚\n 2. Spring Mail æœåŠ¡ç®€ä»‹ Spring mail æ˜¯Spring æ¡†æ¶æä¾›çš„ä¸€ä¸ªç¨‹åºåº“ï¼Œç”¨äºå‘é€ç”µå­é‚®ä»¶ï¼Œä½¿æˆ‘ä»¬ä¸å—åº•å±‚é‚®ä»¶ç³»ç»Ÿçš„é™åˆ¶ï¼Œåªå…³æ³¨å®¢æˆ·ç«¯è¿›è¡Œèµ„æºå¤„ç†ã€‚Spring mail åŒ…çš„å†…å®¹å¦‚ä¸‹ï¼š\n MailSender æ¥å£ï¼šæ ¸å¿ƒæ¥å£ï¼Œæä¾›ç”¨äºå‘é€ç®€å•ç”µå­é‚®ä»¶çš„åŸºæœ¬åŠŸèƒ½ã€‚ JavaMailSender æ¥å£ï¼šä¸Šè¿°MailSenderçš„å­æ¥å£ã€‚å®ƒæ”¯æŒMIMEæ¶ˆæ¯ï¼Œå¹¶ä¸”é€šå¸¸ä¸MimeMessageHelperç±»ç»“åˆä½¿ç”¨ä»¥åˆ›å»ºMimeMessageã€‚ JavaMailSenderImpl ç±»ï¼šæä¾›JavaMailSenderæ¥å£çš„å®ç°ã€‚å®ƒæ”¯æŒMimeMessageå’ŒSimpleMailMessageã€‚ SimpleMailMessageç±»ï¼šç”¨äºåˆ›å»ºç®€å•çš„é‚®ä»¶ï¼ŒåŒ…æ‹¬from(å‘é€è€…)ï¼Œto(æ¥æ”¶è€…)ï¼Œcc(æŠ„é€)ï¼Œsubject(ä¸»é¢˜)å’Œtext(æ–‡æœ¬)ç­‰å­—æ®µã€‚ MimeMessagePreparatoræ¥å£ï¼šæä¾›ç”¨äºæ¥æ”¶MIMEæ¶ˆæ¯çš„å›è°ƒæ¥å£ã€‚ MimeMessageHelperç±»ï¼šç”¨äºåˆ›å»ºMIMEæ¶ˆæ¯çš„å¸®åŠ©å™¨ç±»ã€‚å®ƒæä¾›åœ¨HTMLå¸ƒå±€ä¸­å¯¹å›¾åƒï¼Œå…¸å‹é‚®ä»¶é™„ä»¶å’Œæ–‡æœ¬å†…å®¹çš„æ”¯æŒã€‚  3. é‚®ä»¶æœåŠ¡é…ç½® å¼•å…¥mavenä¾èµ–ä¹‹åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯ä½¿ç”¨spring.mail.*namespace åœ¨ application.properties æ–‡ä»¶ä¸­é…ç½®é‚®ä»¶æœåŠ¡ã€‚\nspring: mail: default-encoding: UTF-8 #é‚®ä»¶æœåŠ¡å™¨çš„åœ°å€ï¼šä¾‹å¦‚smtp.qq.com,smtp.gmail.com host: localhost #ç™»é™†æœåŠ¡å™¨çš„ç”¨æˆ·åå’Œå¯†ç  username: username password: password port: 25 properties: mail: debug: false smtp: debug: false auth: true #å¯ç”¨tlsè¿æ¥ starttls: true protocol: smtp test-connection: false  4. å‘é€é‚®ä»¶ 4.1 å‘é€ç®€å•é‚®ä»¶ @Service public class MailServiceImpl implements MailService { @Autowired private JavaMailSender javaMailSender; @Override public void sendSimpleMessage() { SimpleMailMessage message = new SimpleMailMessage(); message.setFrom(\u0026quot;abc@qq.com\u0026quot;); message.setTo(\u0026quot;efd@qq.com\u0026quot;); message.setSubject(\u0026quot;Test send simple mail message\u0026quot;); message.setText(\u0026quot;Hello world!\u0026quot;); javaMailSender.send(message); } }  4.2 å‘é€é™„ä»¶é‚®ä»¶ @Override public void sendMessageWithAttachment() { MimeMessage message = javaMailSender.createMimeMessage(); try { MimeMessageHelper helper = new MimeMessageHelper(message, true); helper.setTo(\u0026quot;to@qq.com\u0026quot;); helper.setFrom(\u0026quot;from@qq.com\u0026quot;); helper.setSubject(\u0026quot;Send attachment file to email\u0026quot;); helper.setText(\u0026quot;attachment file...\u0026quot;); FileSystemResource file = new FileSystemResource(new File(\u0026quot;Absolute path\u0026quot;)); helper.addAttachment(\u0026quot;Invoice\u0026quot;, file); javaMailSender.send(message); } catch (MessagingException ex) { logger.error(\u0026quot;Failed to send email to. error={}\u0026quot;, ex.getMessage()); } }  4.3 å‘é€æ¨¡æ¿é‚®ä»¶ Spring ä¸­å¯ä»¥ä½œä¸ºé‚®ä»¶æ¨¡æ¿çš„æœ‰å‡ ä¸ªé€‰æ‹©ï¼šVelocityï¼ŒFreemarkerï¼ŒThymeleafã€‚ SpringBoot 1.4.0ä»¥å Velocity åºŸå¼ƒäº†ï¼Œå®˜æ–¹å»ºè®®ç”¨Freemarkerã€‚è€ŒThymeleafçš„æ•ˆç‡æ²¡æœ‰freemakeré«˜(è¯„æµ‹è§å‚è€ƒæ–‡ç« ã€4ã€‘ï¼‰ã€‚\n Freemarker çš„è¯­æ³•å¯ä»¥å‚è€ƒå®˜ç½‘çš„æ‰‹å†Œ:https://freemarker.apache.org/docs/index.html ä¸­æ–‡æ‰‹å†Œï¼šhttps://sourceforge.net/projects/freemarker/files/chinese-manual/\n åŒæ ·ï¼Œæˆ‘ä»¬å…ˆå¼•å…¥ Freemarker çš„ Maven ä¾èµ–ã€‚\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-freemarker\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt;  ç„¶ååœ¨é¡¹ç›®çš„ /resoource/templates ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ª Freemarker æ¨¡æ¿æ–‡ä»¶ notification.fltã€‚\n\u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Hello world!\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Hello\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;My name is ${name}\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;  åœ¨ SpringBoot çš„é…ç½®æ–‡ä»¶ä¸­åŠ ä¸Š Freemarker çš„ç›¸å…³é…ç½®ï¼š\nspring: freemarker: template-loader-path: classpath:/templates/ enabled: true cache: false charset: UTF-8 content-type: text/html check-template-location: true  åœ¨ EmailServiceImpl ä¸­ä½¿ç”¨ Freemarker æ¨¡æ¿å‘é€é‚®ä»¶ï¼š\n@Service public class MailServiceImpl implements MailService { private static final Logger logger = LoggerFactory.getLogger(MailServiceImpl.class); @Autowired private JavaMailSender javaMailSender; @Autowired private FreeMarkerConfigurer freeMarkerConfigurer; @Override public void sendMessageWithFreemarkerTemplate() { MimeMessage message = javaMailSender.createMimeMessage(); try { MimeMessageHelper helper = new MimeMessageHelper(message, true); helper.setTo(\u0026quot;to@qq.com\u0026quot;); helper.setFrom(\u0026quot;from@qq.com\u0026quot;); helper.setSubject(\u0026quot;Send freemarker template to email\u0026quot;); HashMap\u0026lt;String, Object\u0026gt; models = new HashMap\u0026lt;\u0026gt;(); models.put(\u0026quot;name\u0026quot;, \u0026quot;freemarker\u0026quot;); Template template = freeMarkerConfigurer.getConfiguration().getTemplate(\u0026quot;notification.flt\u0026quot;); String text = FreeMarkerTemplateUtils.processTemplateIntoString(template, models); helper.setText(text); javaMailSender.send(message); } catch (Exception ex) { logger.error(\u0026quot;Failed to send email to. error={}\u0026quot;, ex.getMessage()); } } }  è‡³æ­¤å®ç°äº†ä¸‰ä¸­æ–¹å¼ï¼šçº¯æ–‡æœ¬ï¼Œå¯Œæ–‡æœ¬(å›¾ç‰‡/é™„ä»¶)ï¼ŒFreemarkeræ¨¡ç‰ˆçš„é‚®ä»¶å‘é€åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥å°±æ¥æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬çš„é‚®ä»¶æ˜¯å¦èƒ½å‘é€å‡ºå»å§ã€‚\n5. æµ‹è¯•é‚®ä»¶å‘é€æœåŠ¡ æˆ‘ä»¬ä¸ºäº†æµ‹è¯•é‚®ä»¶æœåŠ¡çš„å‘é€åŠŸèƒ½ï¼Œæš‚æ—¶å¯ä»¥å…ˆä¸ç”¨ä½¿ç”¨çœŸæ­£çš„é‚®ä»¶æœåŠ¡å™¨ï¼Œè€Œæ˜¯æ¢æˆGreenMailã€‚ GreenMailæ˜¯ç”¨äºæµ‹è¯•ç›®çš„çš„ç”µå­é‚®ä»¶æœåŠ¡å™¨ï¼Œå¯ä»¥ç”¨äºé‚®ä»¶é›†æˆæµ‹è¯•æˆ–ç”¨äºå¼€å‘çš„è½»é‡çº§æ²™ç›’é‚®ä»¶æœåŠ¡å™¨ã€‚å…·ä½“çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒå®˜ç½‘ä¸Šçš„ç”¨ä¾‹ã€‚\nè¿™é‡Œå…ˆå¼•å…¥GreenMail çš„Mavenä¾èµ–ï¼š\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.icegreen\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;greenmail\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.5.11\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt;  åœ¨Spring boot çš„æµ‹è¯•æ–‡ä»¶(application-test.yaml)ä¸­é…ç½®ç”¨äºé‚®ä»¶æœåŠ¡çš„ç›¸å…³å±æ€§ã€‚\nspring: mail: default-encoding: UTF-8 host: localhost username: abc@qq.com password: password port: 3025 properties: mail: debug: false smtp: debug: false auth: true starttls: true protocol: smtp test-connection: false  æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ JUnit Rule æ¥åˆå§‹åŒ–å’Œåœæ­¢GreenMailé‚®ä»¶æœåŠ¡å™¨ã€‚\npublic class SmtpServerRule extends ExternalResource { # è®¾ç½®å‘é€é‚®ä»¶æœåŠ¡çš„ç”¨æˆ·çš„ç”¨æˆ·å private static final String USER_PASSWORD = \u0026quot;password\u0026quot;; # è®¾ç½®å‘é€é‚®ä»¶æœåŠ¡ç”¨æˆ·çš„å¯†ç  private static final String USER_NAME = \u0026quot;abc@qq.com\u0026quot;; private GreenMail smtpServer; @Override protected void before() throws Throwable { super.before(); smtpServer = new GreenMail(ServerSetupTest.SMTP); smtpServer.start(); // setup user on the mail server smtpServer.setUser(USER_NAME, USER_PASSWORD); } public MimeMessage[] getMessage() { return smtpServer.getReceivedMessages(); } @Override protected void after() { super.after(); smtpServer.stop(); } }  ç„¶åå°±å¯ä»¥å¼€å§‹å†™æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹äº†ã€‚ æˆ‘ä»¬ä½¿ç”¨JUnit @Ruleæ³¨è§£é…ç½®SmtpServerRuleã€‚è¿™æ ‡è®°äº†åœ¨æ¯ä¸ªé›†æˆæµ‹è¯•ä¹‹å‰å’Œä¹‹åè¦è°ƒç”¨çš„è‡ªå®šä¹‰è§„åˆ™ã€‚å¹¶å…è®¸æˆ‘ä»¬æ‹¦æˆªä¼ å…¥çš„ç”µå­é‚®ä»¶ã€‚æœ€åï¼Œæˆ‘ä»¬åšå‡ºä¸€äº›æ–­è¨€å¹¶éªŒè¯å‘é€çš„ç”µå­é‚®ä»¶æ˜¯å¦ç­‰äºæ¥æ”¶çš„ç”µå­é‚®ä»¶ã€‚\n@ActiveProfiles(\u0026quot;test\u0026quot;) @SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT) @RunWith(SpringRunner.class) public class MailServiceImplTest { @Rule public SmtpServerRule smtpServerRule = new SmtpServerRule(); @Autowired private MailService mailService; @Test public void sendSimpleMessage() throws MessagingException { mailService.sendSimpleMessage(); MimeMessage[] messages = smtpServerRule.getMessage(); assertEquals(\u0026quot;Test send simple mail message\u0026quot;, messages[0].getSubject()); assertEquals(\u0026quot;abc@qq.com\u0026quot;, messages[0].getFrom()[0].toString()); assertEquals(\u0026quot;efd@qq.com\u0026quot;, messages[0].getAllRecipients()[0].toString()); } }  å¦å¤–çš„ä¸¤ç§é‚®ä»¶å‚è€ƒä¸Šé¢çš„ä»£ç å®ç°ã€‚\n6. æ€»ç»“ åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•é€šè¿‡Spring Bootåº”ç”¨ç¨‹åºè®¾ç½®å’Œå‘é€ç”µå­é‚®ä»¶ã€‚æ‰€æœ‰è¿™äº›ç¤ºä¾‹å’Œä»£ç ç‰‡æ®µçš„å®ç°éƒ½å¯ä»¥åœ¨MyGitHubé¡¹ç›®ä¸­æ‰¾åˆ°ã€‚\n7. å‚è€ƒæ–‡ç«  ã€1ã€‘Testing mail code in Spring Boot application\nã€2ã€‘Spring Mail Integration Testing with JUnit and GreenMail Example\nã€3ã€‘Guide to Spring Email\nã€4ã€‘SpringBootå¼€å‘æ¡ˆä¾‹ä¹‹æ•´åˆmailå‘é€æœåŠ¡\n","date":"2020å¹´03æœˆ27æ—¥","permalink":"https://ahamoment.cn/posts/java/framewordk-springboot-send-email/","summary":"\u003cp\u003eè¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»ä½¿ç”¨\u003ccode\u003espring boot\u003c/code\u003e å‘é€é‚®ä»¶ã€‚\u003c/p\u003e","title":"Spring Boot å‘é€é‚®ä»¶"},{"contents":"å¤§å¤šæ•° UNIX ç³»ç»Ÿå‘½ä»¤ä»ä½ çš„ç»ˆç«¯æ¥å—è¾“å…¥å¹¶å°†æ‰€äº§ç”Ÿçš„è¾“å‡ºå‘é€å›åˆ°æ‚¨çš„ç»ˆç«¯ã€‚ä¸€ä¸ªå‘½ä»¤é€šå¸¸ä»ä¸€ä¸ªå«æ ‡å‡†è¾“å…¥çš„åœ°æ–¹è¯»å–è¾“å…¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ°å¥½æ˜¯ä½ çš„ç»ˆç«¯ã€‚åŒæ ·ï¼Œä¸€ä¸ªå‘½ä»¤é€šå¸¸å°†å…¶è¾“å‡ºå†™å…¥åˆ°æ ‡å‡†è¾“å‡ºï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¹Ÿæ˜¯ä½ çš„ç»ˆç«¯ã€‚\né‡å®šå‘å‘½ä»¤åˆ—è¡¨å¦‚ä¸‹ï¼š\n   å‘½ä»¤ è¯´æ˜     command \u0026gt; file å°†è¾“å‡ºé‡å®šå‘åˆ° fileã€‚   command \u0026lt; file å°†è¾“å…¥é‡å®šå‘åˆ° fileã€‚   command \u0026raquo; file å°†è¾“å‡ºä»¥è¿½åŠ çš„æ–¹å¼é‡å®šå‘åˆ° fileã€‚   n \u0026gt; file å°†æ–‡ä»¶æè¿°ç¬¦ä¸º n çš„æ–‡ä»¶é‡å®šå‘åˆ° fileã€‚   n \u0026raquo; file å°†æ–‡ä»¶æè¿°ç¬¦ä¸º n çš„æ–‡ä»¶ä»¥è¿½åŠ çš„æ–¹å¼é‡å®šå‘åˆ° fileã€‚   n \u0026gt;\u0026amp; m å°†è¾“å‡ºæ–‡ä»¶ m å’Œ n åˆå¹¶ã€‚   n \u0026lt;\u0026amp; m å°†è¾“å…¥æ–‡ä»¶ m å’Œ n åˆå¹¶ã€‚   \u0026laquo; tag å°†å¼€å§‹æ ‡è®° tag å’Œç»“æŸæ ‡è®° tag ä¹‹é—´çš„å†…å®¹ä½œä¸ºè¾“å…¥ã€‚     éœ€è¦æ³¨æ„çš„æ˜¯æ–‡ä»¶æè¿°ç¬¦ 0 é€šå¸¸æ˜¯æ ‡å‡†è¾“å…¥ï¼ˆSTDINï¼‰ï¼Œ1 æ˜¯æ ‡å‡†è¾“å‡ºï¼ˆSTDOUTï¼‰ï¼Œ2 æ˜¯æ ‡å‡†é”™è¯¯è¾“å‡ºï¼ˆSTDERRï¼‰ã€‚\n è¾“å‡ºé‡å®šå‘ é‡å®šå‘ä¸€èˆ¬é€šè¿‡åœ¨å‘½ä»¤é—´æ’å…¥ç‰¹å®šçš„ç¬¦å·æ¥å®ç°ã€‚ç‰¹åˆ«çš„ï¼Œè¿™äº›ç¬¦å·çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤º:\ncommand1 \u0026gt; file1\nä¸Šé¢è¿™ä¸ªå‘½ä»¤æ‰§è¡Œcommand1ç„¶åå°†è¾“å‡ºçš„å†…å®¹å­˜å…¥file1ã€‚\næ³¨æ„ä»»ä½•file1å†…çš„å·²ç»å­˜åœ¨çš„å†…å®¹å°†è¢«æ–°å†…å®¹æ›¿ä»£ã€‚å¦‚æœè¦å°†æ–°å†…å®¹æ·»åŠ åœ¨æ–‡ä»¶æœ«å°¾ï¼Œè¯·ä½¿ç”¨\u0026raquo;æ“ä½œç¬¦ã€‚\nå®ä¾‹ æ‰§è¡Œä¸‹é¢çš„ who å‘½ä»¤ï¼Œå®ƒå°†å‘½ä»¤çš„å®Œæ•´çš„è¾“å‡ºé‡å®šå‘åœ¨ç”¨æˆ·æ–‡ä»¶ä¸­(users):\n$ who \u0026gt; users  æ‰§è¡Œåï¼Œå¹¶æ²¡æœ‰åœ¨ç»ˆç«¯è¾“å‡ºä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºè¾“å‡ºå·²è¢«ä»é»˜è®¤çš„æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼ˆç»ˆç«¯ï¼‰é‡å®šå‘åˆ°æŒ‡å®šçš„æ–‡ä»¶ã€‚\nä½ å¯ä»¥ä½¿ç”¨ cat å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼š\n$ cat users _mbsetupuser console Oct 31 17:35 laolan console Oct 31 17:35 laolan ttys000 Dec 1 11:33  è¾“å‡ºé‡å®šå‘ä¼šè¦†ç›–æ–‡ä»¶å†…å®¹ï¼Œè¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š\n$ echo \u0026quot;W3Cschoolæ•™ç¨‹ï¼šwww.w3cschool.cn\u0026quot; \u0026gt; users $ cat users W3Cschoolæ•™ç¨‹ï¼šwww.w3cschool.cn $  å¦‚æœä¸å¸Œæœ›æ–‡ä»¶å†…å®¹è¢«è¦†ç›–ï¼Œå¯ä»¥ä½¿ç”¨ \u0026raquo; è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼Œä¾‹å¦‚ï¼š\n$ echo \u0026quot;W3Cschoolæ•™ç¨‹ï¼šwww.w3cschool.cn\u0026quot; \u0026gt;\u0026gt; users $ cat users W3Cschoolæ•™ç¨‹ï¼šwww.w3cschool.cn W3Cschoolæ•™ç¨‹ï¼šwww.w3cschool.cn $  è¾“å…¥é‡å®šå‘ å’Œè¾“å‡ºé‡å®šå‘ä¸€æ ·ï¼ŒUnix å‘½ä»¤ä¹Ÿå¯ä»¥ä»æ–‡ä»¶è·å–è¾“å…¥ï¼Œè¯­æ³•ä¸ºï¼š\ncommand1 \u0026lt; file1\nè¿™æ ·ï¼Œæœ¬æ¥éœ€è¦ä»é”®ç›˜è·å–è¾“å…¥çš„å‘½ä»¤ä¼šè½¬ç§»åˆ°æ–‡ä»¶è¯»å–å†…å®¹ã€‚\næ³¨æ„ï¼šè¾“å‡ºé‡å®šå‘æ˜¯å¤§äºå·(\u0026gt;)ï¼Œè¾“å…¥é‡å®šå‘æ˜¯å°äºå·(\u0026lt;)ã€‚\nå®ä¾‹ æ¥ç€ä»¥ä¸Šå®ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿè®¡ users æ–‡ä»¶çš„è¡Œæ•°,æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\n$ wc -l users 2 users  ä¹Ÿå¯ä»¥å°†è¾“å…¥é‡å®šå‘åˆ° users æ–‡ä»¶ï¼š\n$ wc -l \u0026lt; users 2  æ³¨æ„ï¼šä¸Šé¢ä¸¤ä¸ªä¾‹å­çš„ç»“æœä¸åŒï¼šç¬¬ä¸€ä¸ªä¾‹å­ï¼Œä¼šè¾“å‡ºæ–‡ä»¶åï¼›ç¬¬äºŒä¸ªä¸ä¼šï¼Œå› ä¸ºå®ƒä»…ä»…çŸ¥é“ä»æ ‡å‡†è¾“å…¥è¯»å–å†…å®¹ã€‚\ncommand1 \u0026lt; infile \u0026gt; outfile\nåŒæ—¶æ›¿æ¢è¾“å…¥å’Œè¾“å‡ºï¼Œæ‰§è¡Œcommand1ï¼Œä»æ–‡ä»¶infileè¯»å–å†…å®¹ï¼Œç„¶åå°†è¾“å‡ºå†™å…¥åˆ°outfileä¸­ã€‚\né‡å®šå‘æ·±å…¥è®²è§£ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ª Unix/Linux å‘½ä»¤è¿è¡Œæ—¶éƒ½ä¼šæ‰“å¼€ä¸‰ä¸ªæ–‡ä»¶ï¼š\n æ ‡å‡†è¾“å…¥æ–‡ä»¶(stdin)ï¼šstdinçš„æ–‡ä»¶æè¿°ç¬¦ä¸º0ï¼ŒUnixç¨‹åºé»˜è®¤ä»stdinè¯»å–æ•°æ®ã€‚ æ ‡å‡†è¾“å‡ºæ–‡ä»¶(stdout)ï¼šstdout çš„æ–‡ä»¶æè¿°ç¬¦ä¸º1ï¼ŒUnixç¨‹åºé»˜è®¤å‘stdoutè¾“å‡ºæ•°æ®ã€‚ æ ‡å‡†é”™è¯¯æ–‡ä»¶(stderr)ï¼šstderrçš„æ–‡ä»¶æè¿°ç¬¦ä¸º2ï¼ŒUnixç¨‹åºä¼šå‘stderræµä¸­å†™å…¥é”™è¯¯ä¿¡æ¯ã€‚  é»˜è®¤æƒ…å†µä¸‹ï¼Œcommand \u0026gt; file å°† stdout é‡å®šå‘åˆ° fileï¼Œcommand \u0026lt; file å°†stdin é‡å®šå‘åˆ° fileã€‚\nå¦‚æœå¸Œæœ› stderr é‡å®šå‘åˆ° fileï¼Œå¯ä»¥è¿™æ ·å†™ï¼š\n$ command 2 \u0026gt; file\nå¦‚æœå¸Œæœ› stderr è¿½åŠ åˆ° file æ–‡ä»¶æœ«å°¾ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š\n$ command 2 \u0026gt;\u0026gt; file\n2 è¡¨ç¤ºæ ‡å‡†é”™è¯¯æ–‡ä»¶(stderr)ã€‚\nå¦‚æœå¸Œæœ›å°† stdout å’Œ stderr åˆå¹¶åé‡å®šå‘åˆ° fileï¼Œå¯ä»¥è¿™æ ·å†™ï¼š\n$ command \u0026gt; file 2\u0026gt;\u0026amp;1\næˆ–è€…\n$ command \u0026gt;\u0026gt; file 2\u0026gt;\u0026amp;1\nå¦‚æœå¸Œæœ›å¯¹ stdin å’Œ stdout éƒ½é‡å®šå‘ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š\n$ command \u0026lt; file1 \u0026gt;file2\ncommand å‘½ä»¤å°† stdin é‡å®šå‘åˆ° file1ï¼Œå°† stdout é‡å®šå‘åˆ° file2ã€‚\nHere Document Here Document æ˜¯ Shell ä¸­çš„ä¸€ç§ç‰¹æ®Šçš„é‡å®šå‘æ–¹å¼ï¼Œç”¨æ¥å°†è¾“å…¥é‡å®šå‘åˆ°ä¸€ä¸ªäº¤äº’å¼ Shell è„šæœ¬æˆ–ç¨‹åºã€‚\nå®ƒçš„åŸºæœ¬çš„å½¢å¼å¦‚ä¸‹ï¼š\ncommand \u0026lt;\u0026lt; delimiter document delimiter  å®ƒçš„ä½œç”¨æ˜¯å°†ä¸¤ä¸ª delimiter ä¹‹é—´çš„å†…å®¹(document) ä½œä¸ºè¾“å…¥ä¼ é€’ç»™ commandã€‚\næ³¨æ„ï¼š\nç»“å°¾çš„delimiter ä¸€å®šè¦é¡¶æ ¼å†™ï¼Œå‰é¢ä¸èƒ½æœ‰ä»»ä½•å­—ç¬¦ï¼Œåé¢ä¹Ÿä¸èƒ½æœ‰ä»»ä½•å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œ tab ç¼©è¿›ã€‚ å¼€å§‹çš„delimiterå‰åçš„ç©ºæ ¼ä¼šè¢«å¿½ç•¥æ‰ã€‚\nå®ä¾‹ åœ¨å‘½ä»¤è¡Œä¸­é€šè¿‡ wc -l å‘½ä»¤è®¡ç®— Here Document çš„è¡Œæ•°ï¼š\n$ wc -l \u0026lt;\u0026lt; EOF æ¬¢è¿æ¥åˆ° W3Cschoolæ•™ç¨‹ www.w3cschool.cn EOF 3 # è¾“å‡ºç»“æœä¸º 3 è¡Œ $  æˆ‘ä»¬ä¹Ÿå¯ä»¥å°† Here Document ç”¨åœ¨è„šæœ¬ä¸­ï¼Œä¾‹å¦‚ï¼š\n#!/bin/bash # author:W3Cschoolæ•™ç¨‹ # url:www.w3cschool.cn cat \u0026lt;\u0026lt; EOF æ¬¢è¿æ¥åˆ° W3Cschoolæ•™ç¨‹ www.w3cschool.cn EOF  æ‰§è¡Œä»¥ä¸Šè„šæœ¬ï¼Œè¾“å‡ºç»“æœï¼š\næ¬¢è¿æ¥åˆ° W3Cschoolæ•™ç¨‹ www.w3cschool.cn  /dev/null æ–‡ä»¶ å¦‚æœå¸Œæœ›æ‰§è¡ŒæŸä¸ªå‘½ä»¤ï¼Œä½†åˆä¸å¸Œæœ›åœ¨å±å¹•ä¸Šæ˜¾ç¤ºè¾“å‡ºç»“æœï¼Œé‚£ä¹ˆå¯ä»¥å°†è¾“å‡ºé‡å®šå‘åˆ° /dev/nullï¼š\n$ command \u0026gt; /dev/null\n/dev/null æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå†™å…¥åˆ°å®ƒçš„å†…å®¹éƒ½ä¼šè¢«ä¸¢å¼ƒï¼›å¦‚æœå°è¯•ä»è¯¥æ–‡ä»¶è¯»å–å†…å®¹ï¼Œé‚£ä¹ˆä»€ä¹ˆä¹Ÿè¯»ä¸åˆ°ã€‚ä½†æ˜¯ /dev/null æ–‡ä»¶éå¸¸æœ‰ç”¨ï¼Œå°†å‘½ä»¤çš„è¾“å‡ºé‡å®šå‘åˆ°å®ƒï¼Œä¼šèµ·åˆ°\u0026quot;ç¦æ­¢è¾“å‡º\u0026quot;çš„æ•ˆæœã€‚\nå¦‚æœå¸Œæœ›å±è”½ stdout å’Œ stderrï¼Œå¯ä»¥è¿™æ ·å†™ï¼š\n$ command \u0026gt; /dev/null 2\u0026gt;\u0026amp;1\n æ³¨æ„ï¼š0 æ˜¯æ ‡å‡†è¾“å…¥ï¼ˆSTDINï¼‰ï¼Œ1 æ˜¯æ ‡å‡†è¾“å‡ºï¼ˆSTDOUTï¼‰ï¼Œ2 æ˜¯æ ‡å‡†é”™è¯¯è¾“å‡ºï¼ˆSTDERRï¼‰ã€‚\n ","date":"2019å¹´11æœˆ26æ—¥","permalink":"https://ahamoment.cn/posts/linux/linux-shell-input-output-redirect/","summary":"å¤§å¤šæ•° UNIX ç³»ç»Ÿå‘½ä»¤ä»ä½ çš„ç»ˆç«¯æ¥å—è¾“å…¥å¹¶å°†æ‰€äº§ç”Ÿçš„è¾“å‡ºå‘é€å›åˆ°æ‚¨çš„ç»ˆç«¯ã€‚ä¸€ä¸ªå‘½ä»¤é€šå¸¸ä»ä¸€ä¸ªå«æ ‡å‡†è¾“å…¥çš„åœ°æ–¹è¯»å–è¾“å…¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ°å¥½æ˜¯ä½ çš„ç»ˆç«¯ã€‚åŒæ ·ï¼Œä¸€ä¸ªå‘½ä»¤é€šå¸¸å°†å…¶è¾“å‡ºå†™å…¥åˆ°æ ‡å‡†è¾“å‡ºï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¹Ÿæ˜¯ä½ çš„ç»ˆç«¯ã€‚\né‡å®šå‘å‘½ä»¤åˆ—è¡¨å¦‚ä¸‹ï¼š\n   å‘½ä»¤ è¯´æ˜     command \u0026gt; file å°†è¾“å‡ºé‡å®šå‘åˆ° fileã€‚   command \u0026lt; file å°†è¾“å…¥é‡å®šå‘åˆ° fileã€‚   command \u0026raquo; file å°†è¾“å‡ºä»¥è¿½åŠ çš„æ–¹å¼é‡å®šå‘åˆ° fileã€‚   n \u0026gt; file å°†æ–‡ä»¶æè¿°ç¬¦ä¸º n çš„æ–‡ä»¶é‡å®šå‘åˆ° fileã€‚   n \u0026raquo; file å°†æ–‡ä»¶æè¿°ç¬¦ä¸º n çš„æ–‡ä»¶ä»¥è¿½åŠ çš„æ–¹å¼é‡å®šå‘åˆ° fileã€‚   n \u0026gt;\u0026amp; m å°†è¾“å‡ºæ–‡ä»¶ m å’Œ n åˆå¹¶ã€‚   n \u0026lt;\u0026amp; m å°†è¾“å…¥æ–‡ä»¶ m å’Œ n åˆå¹¶ã€‚   \u0026laquo; tag å°†å¼€å§‹æ ‡è®° tag å’Œç»“æŸæ ‡è®° tag ä¹‹é—´çš„å†…å®¹ä½œä¸ºè¾“å…¥ã€‚     éœ€è¦æ³¨æ„çš„æ˜¯æ–‡ä»¶æè¿°ç¬¦ 0 é€šå¸¸æ˜¯æ ‡å‡†è¾“å…¥ï¼ˆSTDINï¼‰ï¼Œ1 æ˜¯æ ‡å‡†è¾“å‡ºï¼ˆSTDOUTï¼‰ï¼Œ2 æ˜¯æ ‡å‡†é”™è¯¯è¾“å‡ºï¼ˆSTDERRï¼‰ã€‚","title":"Linux Shell è¾“å…¥/è¾“å‡ºé‡å®šå‘"},{"contents":"1. å‰è¨€ å½“æˆ‘ä»¬å‘ç°æœåŠ¡å™¨ä¸Šçš„åº”ç”¨å‘ç”ŸæŸäº›æ•…éšœï¼Œå¹¶ä¸”æ²¡æœ‰è¶³å¤Ÿçš„æ—¥å¿—æ¥å®šä½é—®é¢˜çš„æ—¶å€™ï¼Œå°±ä¼šè§‰å¾—éå¸¸å¤´ç–¼ï¼Œå°¤å…¶æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æƒ³è¦å¯¹åº”ç”¨è¿›è¡Œè°ƒè¯•å¹¶éæ˜“äº‹ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Javaå¹³å°æä¾›çš„æ ‡å‡†åŠŸèƒ½æ¥é…ç½®æ­£åœ¨è¿è¡Œçš„WebæœåŠ¡å™¨å’Œè°ƒè¯•åº”ç”¨ç¨‹åºã€‚\n2. é…ç½® åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ä»‹ç»ä¸€ä¸‹æœ¬æ–‡çš„ç¤ºä¾‹å·¥ç¨‹æ‰€ç”¨çš„å·¥å…·å’Œç¯å¢ƒï¼š\n åº”ç”¨ä½¿ç”¨spring bootæ¡†æ¶ï¼Œéƒ¨ç½²åœ¨linuxä¸­ï¼Œç”±äº spring boot å†…ç½®tomcatæœåŠ¡å™¨ï¼Œå› æ­¤éƒ¨ç½²çš„æ—¶é€šè¿‡maven/gradleæ‰“åŒ…åï¼Œç›´æ¥ç”¨ java -jar test.jar å‘½ä»¤å¯åŠ¨åº”ç”¨ã€‚ è°ƒè¯•å·¥å…·ç”¨çš„æ˜¯IntelliJ idea  2.1 Java å¯åŠ¨å‚æ•°é…ç½® Java Platform Debugging Architectureï¼ˆJPDAï¼‰æ˜¯ä¸€ç»„å¯æ‰©å±•çš„APIï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†æ˜¯ç§°ä¸ºJDWPï¼ˆJava Debug Wire Protocolï¼‰çš„ç‰¹æ®Šè°ƒè¯•åè®®ã€‚\nJDWPæ˜¯ç”¨äºåœ¨åº”ç”¨ç¨‹åºå’Œè°ƒè¯•å™¨è¿›ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡çš„åè®®ï¼Œå¯ç”¨äºå¯¹æ­£åœ¨è¿è¡Œçš„Javaåº”ç”¨ç¨‹åºè¿›è¡Œè¿œç¨‹æ•…éšœæ’é™¤ã€‚\nè¦é…ç½®è¿œç¨‹åº”ç”¨ç¨‹åºè¿›è¡Œè°ƒè¯•ï¼Œæ‚¨å¿…é¡»åœ¨Javaåº”ç”¨çš„å¯åŠ¨å‚æ•°ä¸­ä¸ºæ­¤åè®®æŒ‡å®šå‚æ•°ã€‚\njava -Xdebug -Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=y Test\nè¿™äº›å‚æ•°è¦åšçš„äº‹æƒ…å°±æ˜¯å¯ç”¨è¿œç¨‹è°ƒè¯•å’Œé…ç½®æœ‰æ•ˆçš„é€‰é¡¹ï¼š\n -Xdebugï¼šå‚æ•°å¯ç”¨debugè°ƒè¯•ç‰¹æ€§ -Xrunjdwpï¼šä½¿ç”¨å‡ ä¸ªé‡è¦å‚æ•°é…ç½®JDWPåè®®ã€‚  ä» JDK5 å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨ -agentlib:jdwp é€‰é¡¹ï¼Œè€Œä¸æ˜¯ -Xdebug å’Œ -Xrunjdwpã€‚ä½†å¦‚æœè¿æ¥åˆ° JDK5 ä»¥å‰çš„ VMï¼Œåªèƒ½é€‰æ‹© -Xdebug å’Œ -Xrunjdwpã€‚\njava -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=8001 Test\nJDK 9 ä¹‹åï¼Œ ç”±äºJava 9 JDWPä»£ç†é»˜è®¤æƒ…å†µä¸‹ä»…ä¾¦å¬æœ¬åœ°ç½‘ç»œæ¥å£ï¼Œå› æ­¤å°†æ‹’ç»è¿œç¨‹è¿æ¥ã€‚\n JDK 9 Realease Notes core-svc/debugger JDWP socket connector accept only local connections by default The JDWP socket connector has been changed to bind to localhost only if no ip address or hostname is specified on the agent command line. A hostname of asterisk (*) may be used to achieve the old behavior which is to bind the JDWP socket connector to all available interfaces; this is not secure and not recommended.\n å› æ­¤å¯¹äº JDK 9 åŠæ›´é«˜çš„ç‰ˆæœ¬ï¼Œå¯åŠ¨debugçš„å‘½ä»¤å¦‚ä¸‹ï¼š\njava -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8001 Test\nä¸‹é¢ä»‹ç»ä¸€ä¸‹jdwpæä¾›çš„ä¸€äº›å­é€‰é¡¹å‚æ•°ï¼š\n  transportï¼šæŒ‡å®šè¿è¡Œçš„è¢«è°ƒè¯•åº”ç”¨å’Œè°ƒè¯•è€…ä¹‹é—´çš„é€šä¿¡åè®®ã€‚è¿™é‡Œé€šå¸¸ä½¿ç”¨å¥—æ¥å­—ä¼ è¾“ã€‚ä½†æ˜¯åœ¨ Windows å¹³å°ä¸Šä¹Ÿå¯ä»¥ä½¿ç”¨å…±äº«å†…å­˜ä¼ è¾“ã€‚\n  serverï¼šå¦‚æœå€¼ä¸º yï¼Œç›®æ ‡åº”ç”¨ç¨‹åºç›‘å¬å°†è¦è¿æ¥çš„è°ƒè¯•å™¨åº”ç”¨ç¨‹åºã€‚å¦åˆ™ï¼Œå®ƒå°†è¿æ¥åˆ°ç‰¹å®šåœ°å€ä¸Šçš„è°ƒè¯•å™¨åº”ç”¨ç¨‹åºã€‚\n  suspendï¼šå¦‚æœå€¼ä¸º n ç”¨æ¥å‘ŠçŸ¥ JVM ç«‹å³æ‰§è¡Œï¼Œä¸è¦ç­‰å¾…æœªæ¥å°†è¦é™„ç€ä¸Š/è¿ä¸Šï¼ˆattachedï¼‰çš„è°ƒè¯•è€…ã€‚å¦‚æœè®¾æˆ y, åˆ™åº”ç”¨å°†æš‚åœä¸è¿è¡Œï¼Œç›´åˆ°æœ‰è°ƒè¯•è€…è¿æ¥ä¸Š\n suspend=yçš„ä¸€ä¸ªæ¯”è¾ƒé€‚ç”¨çš„åœºæ™¯æ˜¯ï¼Œå½“debugä¸€ä¸ªä¼šé˜»æ­¢åº”ç”¨æˆåŠŸå¯åŠ¨çš„é—®é¢˜æ—¶ï¼Œ é€šè¿‡suspend=yå¯ä»¥ç¡®ä¿è°ƒè¯•è€…è¿ä¸Šæ¥ä¹‹åå†å¯åŠ¨åº”ç”¨ï¼Œå¦åˆ™åº”ç”¨å·²ç»å¯åŠ¨æŠ¥é”™äº†å†è°ƒè¯•ä¹Ÿæ²¡æ„ä¹‰äº†ã€‚\n   addressï¼šè¿œç¨‹è¢«è°ƒè¯•åº”ç”¨å¼€é€šçš„ç«¯å£ï¼Œå¯å®šä¹‰å…¶ä»–ç«¯å£ã€‚\n  æœåŠ¡ç«¯ä½¿ç”¨jdwpçš„è°ƒè¯•å‚æ•°æˆåŠŸå¯åŠ¨åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°javaè¿›ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š\n[root@test]$ ps -ef | grep java root 1323 0 99 11:36 ? 00:00:30 java -Dspring.profiles.active=default -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=2222 -jar ./test.jar  2.2 IntelliJ idea é…ç½® é¦–å…ˆä¿è¯ IDEA é‡Œé¢å·²ç»æ‰“å¼€äº†éœ€è¦è¿œç¨‹è°ƒè¯•çš„ä»£ç ï¼Œæ³¨æ„ä»£ç è¦ä¸çº¿ä¸Šçš„ä»£ç ä¸€è‡´ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥ç”¨war/jaråŒ…æ¥è°ƒã€‚ ç„¶åç‚¹å‡» Run â Edit Configurations â **+ **æŒ‰é’® â Remote è¿™é‡Œåªéœ€è¦å¡«å¥½æœåŠ¡å™¨çš„åœ°å€å’Œdebugç«¯å£åï¼Œç‚¹å‡»\u0026quot;debug\u0026quot;æŒ‰é’®å¯åŠ¨å³å¯ã€‚ å½“æˆ‘ä»¬çœ‹åˆ°æ‰“å°å‡ºè¿™è¡Œä¿¡æ¯æ—¶ï¼Œå°±å¯ä»¥å¯¹éœ€è¦è°ƒè¯•çš„ä»£ç æ‰“æ–­ç‚¹è°ƒè¯•äº†ã€‚\n3. è¿œç¨‹ JVM è°ƒè¯•çš„å·¥ä½œåŸç† ä¸€åˆ‡æºäºè¢«ç§°ä½œ Agents çš„ä¸œè¥¿ã€‚\nè¿è¡Œç€å„ç§ç¼–è¯‘è¿‡çš„ .class æ–‡ä»¶çš„JVMï¼Œ æœ‰ä¸€ç§ç‰¹æ€§ï¼Œå¯ä»¥å…è®¸å¤–éƒ¨çš„åº“ï¼ˆJavaæˆ–C++å†™çš„librariesï¼‰åœ¨è¿è¡Œæ—¶æ³¨å…¥åˆ° JVM ä¸­ã€‚è¿™äº›å¤–éƒ¨çš„åº“å°±ç§°ä½œ Agents, ä»–ä»¬æœ‰èƒ½åŠ›ä¿®æ”¹è¿è¡Œä¸­ .class æ–‡ä»¶çš„å†…å®¹ã€‚\nè¿™äº› Agents æ‹¥æœ‰çš„è¿™äº› JVM çš„åŠŸèƒ½æƒé™ï¼Œ æ˜¯åœ¨ JVM å†…è¿è¡Œçš„ Java Code æ‰€æ— æ³•è·å–çš„ï¼Œ ä»–ä»¬èƒ½ç”¨æ¥åšä¸€äº›æœ‰è¶£çš„äº‹æƒ…ï¼Œæ¯”å¦‚ä¿®æ”¹è¿è¡Œä¸­çš„æºç ï¼Œ æ€§èƒ½åˆ†æç­‰ã€‚ åƒ JRebel å·¥å…·å°±æ˜¯ç”¨äº†è¿™äº›åŠŸèƒ½è¾¾åˆ°é­”æœ¯èˆ¬çš„æ•ˆæœã€‚\nä¼ é€’ä¸€ä¸ª Agent Lib ç»™ JVM, é€šè¿‡æ·»åŠ  agentlib:libname[=options] æ ¼å¼çš„å¯åŠ¨å‚æ•°å³å¯åŠåˆ°ã€‚åƒä¸Šé¢çš„è¿œç¨‹è°ƒè¯•æˆ‘ä»¬ç”¨çš„å°±æ˜¯ -agentlib:jdwp=transport=dt_socket,address=1043,server=y,suspend=næ¥å¼•å…¥ jdwp è¿™ä¸ª Agent çš„ã€‚\njdwp æ˜¯ä¸€ä¸ª JVM ç‰¹å®šçš„ JDWPï¼ˆJava Debug Wire Protocolï¼‰ å¯é€‰å®ç°ï¼Œç”¨æ¥å®šä¹‰è°ƒè¯•è€…ä¸è¿è¡ŒJVMä¹‹é—´çš„é€šè®¯ï¼Œå®ƒçš„æ˜¯é€šè¿‡ JVM æœ¬åœ°åº“çš„ jdwp.so æˆ–è€… jdwp.dll æ”¯æŒå®ç°çš„ã€‚\nJPDA ç”±ä¸¤ä¸ªæ¥å£ï¼ˆåˆ†åˆ«æ˜¯ JVM Tool Interface å’Œ JDIï¼‰ã€ä¸€ä¸ªåè®®ï¼ˆJava Debug Wire Protocolï¼‰å’Œä¸¤ä¸ªç”¨äºåˆå¹¶å®ƒä»¬çš„è½¯ä»¶ç»„ä»¶ï¼ˆåç«¯å’Œå‰ç«¯ï¼‰ç»„æˆã€‚  JVM TI-Java VMå·¥å…·æ¥å£ã€‚JVM TIæ˜¯J2SE 5.0ä¸­å¼•å…¥çš„æ–°æ¥å£ï¼Œå®ƒæ›¿ä»£äº†JVMDIã€‚å®ƒå®šä¹‰äº†VMæä¾›çš„è°ƒè¯•æœåŠ¡ã€‚ JDWP-Javaè°ƒè¯•çº¿åè®®ã€‚å®šä¹‰è°ƒè¯•å¯¹è±¡å’Œè°ƒè¯•å™¨è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚ JDI-Javaè°ƒè¯•æ¥å£ã€‚å®šä¹‰é«˜çº§Javaè¯­è¨€ç•Œé¢ï¼Œå·¥å…·å¼€å‘äººå‘˜å¯ä»¥è½»æ¾åœ°ä½¿ç”¨è¯¥ç•Œé¢æ¥ç¼–å†™è¿œç¨‹è°ƒè¯•å™¨åº”ç”¨ç¨‹åºã€‚  ç®€å•æ¥è¯´ï¼Œ jdwp agent ä¼šå»ºç«‹è¿è¡Œåº”ç”¨çš„ JVM å’Œè°ƒè¯•è€…ï¼ˆæœ¬åœ°æˆ–è€…è¿œç¨‹ï¼‰ä¹‹é—´çš„æ¡¥æ¢ã€‚æ—¢ç„¶ä»–æ˜¯ä¸€ä¸ªAgent Library, å®ƒå°±æœ‰èƒ½åŠ›æ‹¦æˆªè¿è¡Œçš„ä»£ç ã€‚\nåœ¨ JVM æ¶æ„é‡Œï¼Œ debugging åŠŸèƒ½åœ¨ JVM æœ¬èº«çš„å†…éƒ¨æ˜¯æ‰¾ä¸åˆ°çš„ï¼Œå®ƒæ˜¯ä¸€ç§æŠ½è±¡åˆ°å¤–éƒ¨å·¥å…·çš„æ–¹å¼ï¼ˆä¹Ÿç§°ä½œè°ƒè¯•è€… debuggerï¼‰ã€‚è¿™äº›è°ƒè¯•å·¥å…·æˆ–è€…è¿è¡Œåœ¨ JVM çš„æœ¬åœ° æˆ–è€…åœ¨è¿œç¨‹ã€‚è¿™æ˜¯ä¸€ç§è§£è€¦ï¼Œæ¨¡å—åŒ–çš„æ¶æ„ã€‚\næ¦‚è¿°æ­¤æ¨¡å—åŒ–ä½“ç³»ç»“æ„çš„æ‰€æœ‰è§„èŒƒéƒ½åŒ…å«åœ¨Javaå¹³å°ä¸­ï¼Œè°ƒè¯•å™¨ä½“ç³»ç»“æ„ï¼ŒJPDAï¼Œæ‚¨å¯ä»¥åœ¨æ­¤å¤„é˜…è¯»å…¶è¯¦ç»†ä»‹ç»ï¼š Java Platform Debugger Architecture Overview.\n4. æ€»ç»“ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»äº†å¦‚ä½•é…ç½®JavaæœåŠ¡å™¨ä»¥è¿›è¡Œè¿œç¨‹è°ƒè¯•ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ç®€å•çš„æ§åˆ¶å°å·¥å…·æ¥è°ƒè¯•åº”ç”¨ç¨‹åºã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè°ƒè¯•æ¨¡å¼ä¼šé™ä½æœåŠ¡å™¨çš„é€Ÿåº¦ï¼Œå› ä¸ºå®ƒä¼šç¦ç”¨ä¸€äº›JVMä¼˜åŒ–ã€‚å¦å¤–ï¼Œè°ƒè¯•æ¨¡å¼å¯èƒ½ä¼šå¸¦æ¥æ½œåœ¨çš„å®‰å…¨é£é™©ã€‚æ‚¨éœ€è¦é€šè¿‡ç‰¹å®šç«¯å£å‘è°ƒè¯•å™¨æä¾›å¯¹æœåŠ¡å™¨çš„è®¿é—®æƒé™ï¼Œè¿™å¯¹äºç”¨å¿ƒä¸è‰¯çš„äººæ¥è¯´æ˜¯å¦ä¸€ä¸ªæ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚æ‰€ä»¥å¹¶ä¸å»ºè®®é•¿æœŸå¼€ç€è°ƒè¯•æ¨¡å¼è·‘åº”ç”¨ã€‚\nå‚è€ƒæ–‡æ¡£ [1] Javaè¿œç¨‹è°ƒè¯•ï¼ˆRemote Debuggingï¼‰çš„é‚£äº›äº‹\n[2] How to Remotely Debug Application Running on Tomcat From Within Intellij IDEA\n[3] A Practical Guide to Java Remote Debugging\n[4] ä½¿ç”¨ Eclipse è¿œç¨‹è°ƒè¯• Java åº”ç”¨ç¨‹åº\n[5] JPDA\n[6] æ·±å…¥ Java è°ƒè¯•ä½“ç³»\n[7] Java: local and remote JVM debugging â€” JDK 8, 9 and later\n","date":"2019å¹´11æœˆ21æ—¥","permalink":"https://ahamoment.cn/posts/java/java-remote-debug/","summary":"1. å‰è¨€ å½“æˆ‘ä»¬å‘ç°æœåŠ¡å™¨ä¸Šçš„åº”ç”¨å‘ç”ŸæŸäº›æ•…éšœï¼Œå¹¶ä¸”æ²¡æœ‰è¶³å¤Ÿçš„æ—¥å¿—æ¥å®šä½é—®é¢˜çš„æ—¶å€™ï¼Œå°±ä¼šè§‰å¾—éå¸¸å¤´ç–¼ï¼Œå°¤å…¶æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æƒ³è¦å¯¹åº”ç”¨è¿›è¡Œè°ƒè¯•å¹¶éæ˜“äº‹ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Javaå¹³å°æä¾›çš„æ ‡å‡†åŠŸèƒ½æ¥é…ç½®æ­£åœ¨è¿è¡Œçš„WebæœåŠ¡å™¨å’Œè°ƒè¯•åº”ç”¨ç¨‹åºã€‚\n2. é…ç½® åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ä»‹ç»ä¸€ä¸‹æœ¬æ–‡çš„ç¤ºä¾‹å·¥ç¨‹æ‰€ç”¨çš„å·¥å…·å’Œç¯å¢ƒï¼š\n åº”ç”¨ä½¿ç”¨spring bootæ¡†æ¶ï¼Œéƒ¨ç½²åœ¨linuxä¸­ï¼Œç”±äº spring boot å†…ç½®tomcatæœåŠ¡å™¨ï¼Œå› æ­¤éƒ¨ç½²çš„æ—¶é€šè¿‡maven/gradleæ‰“åŒ…åï¼Œç›´æ¥ç”¨ java -jar test.jar å‘½ä»¤å¯åŠ¨åº”ç”¨ã€‚ è°ƒè¯•å·¥å…·ç”¨çš„æ˜¯IntelliJ idea  2.1 Java å¯åŠ¨å‚æ•°é…ç½® Java Platform Debugging Architectureï¼ˆJPDAï¼‰æ˜¯ä¸€ç»„å¯æ‰©å±•çš„APIï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†æ˜¯ç§°ä¸ºJDWPï¼ˆJava Debug Wire Protocolï¼‰çš„ç‰¹æ®Šè°ƒè¯•åè®®ã€‚","title":"IntellJ IDEA è¿œç¨‹è°ƒè¯• Java ç¨‹åº"},{"contents":"1. èƒŒæ™¯ å…¬å¸ä½¿ç”¨çš„ä»£ç ä»“åº“æ˜¯Gitlabï¼Œä¸ªäººä»£ç ä»“åº“åˆæ˜¯Githubã€‚æ¯æ¬¡æäº¤ä»£ç çš„æ—¶å€™ï¼Œéœ€è¦åˆ‡æ¢ä¸åŒçš„æäº¤ä½œè€…å’Œæäº¤é‚®ç®±ï¼Œéå¸¸å®¹æ˜“å‡ºé”™ã€‚ è¿™ä¸ªè„šæœ¬æ˜¯æ ¹æ®repo urlè‡ªåŠ¨è®¾ç½®æäº¤ä½œè€…ï¼Œé¿å…æ¯æ¬¡æ‰‹åŠ¨é…ç½®ã€‚\n2. æ–¹æ³• 2.1 å®‰è£…Git  Linux ä¸Šå®‰è£…Gitç›´æ¥ä½¿ç”¨ sudo yum install git æˆ–è€… sudo apt-get install git å‘½ä»¤å³å¯ã€‚ Windows ä¸Šå®‰è£…åˆ°å®˜ç½‘ä¸‹è½½å®‰è£…è½¯ä»¶å®‰è£…å³å¯ã€‚å®‰è£…åœ°å€  2.2 æ·»åŠ è„šæœ¬ åœ¨/root/ä¸‹æ·»åŠ .git-templates/hooks ç›®å½•ï¼Œæ·»åŠ è„šæœ¬post-checkoutï¼Œè„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š\n#!/bin/bash #checkout hook to locally set user name and email based on user defined patterns #The patterns are matched against the clone url. # #Based on http://www.dvratil.cz/2015/12/git-trick-628-automatically-set-commit-author-based-on-repo-url/ function warn { echo -e \u0026quot;\\n$1 Email and author not initialized in local config!\u0026quot; } email=\u0026quot;$(git config --local user.email)\u0026quot; name=\u0026quot;$(git config --local user.name)\u0026quot; if [[ $1 != \u0026quot;0000000000000000000000000000000000000000\u0026quot; || -n $email || -n $name ]]; then exit 0 fi #get remote name: # only one: take it # more: take \u0026quot;origin\u0026quot;, or fail remote=\u0026quot;$([[ $(git remote | wc -l) -eq 1 ]] \u0026amp;\u0026amp; git remote || git remote | grep \u0026quot;^origin$\u0026quot;)\u0026quot; if [[ -z $remote ]]; then warn \u0026quot;Failed to detect remote.\u0026quot; exit 0 fi url=\u0026quot;$(git config --local remote.${remote}.url)\u0026quot; if [[ ! -f ~/.git-clone-init ]]; then cat \u0026lt;\u0026lt; INPUT \u0026gt; ~/.git-clone-init #!/bin/bash case \u0026quot;\\$url\u0026quot; in *@github.com:* ) email=\u0026quot;\u0026quot;; name=\u0026quot;\u0026quot;;; *//github.com/* ) email=\u0026quot;\u0026quot;; name=\u0026quot;\u0026quot;;; esac INPUT warn \u0026quot;\\nMissing file ~/.git-clone-init. Template created...\u0026quot; exit 0 fi . ~/.git-clone-init if [[ -z $name || -z $email ]]; then warn \u0026quot;Failed to detect identity using ~/.git-clone-init.\u0026quot; exit 0 fi git config --local user.email \u0026quot;$email\u0026quot; git config --local user.name \u0026quot;$name\u0026quot; echo -e \u0026quot;\\nIdentity set to $name \u0026lt;$email\u0026gt;\u0026quot;  2.3 æ·»åŠ é…ç½®æ–‡ä»¶ åœ¨/root/.gitconfigæ–‡ä»¶ä¸­ï¼ˆæ²¡æœ‰çš„è¯è‡ªè¡Œåˆ›å»ºï¼‰æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼ŒæŒ‡å®šä½¿ç”¨çš„æ¨¡æ¿ï¼š\n[user] [init] templatedir = /root/.git-templates [push] default = simple  åœ¨/root/.git-clone-initä¸­é’ˆå¯¹ä¸åŒçš„gitä»“åº“æ·»åŠ æäº¤ä½œè€…å’Œé‚®ç®±ï¼š\n#!/bin/bash case \u0026quot;$url\u0026quot; in *@github.com:* ) email=\u0026quot;test@qq.com\u0026quot;; name=\u0026quot;xq\u0026quot;;; *//github.com/* ) email=\u0026quot;test@qq.com\u0026quot;; name=\u0026quot;xq\u0026quot;;; *@gitlab.com:* ) email=\u0026quot;test@google.com\u0026quot;; name=\u0026quot;xq\u0026quot;;; *//gitlab.com/* ) email=\u0026quot;test@google.com\u0026quot;; name=\u0026quot;xq\u0026quot;;; esac  2.4 éªŒè¯  æ›´æ”¹è„šæœ¬post-checkoutçš„æƒé™å¹¶æ‰§è¡Œã€‚ sudo chmod 777 post-checkout sh post-checkout å°è¯•ä»github å…‹éš†ä¸€ä¸ªä»“åº“ï¼š [root@yxj-test git_storage]# git clone git@github.com:XueqiangChen/scripts.git Cloning into 'scripts'... Warning: Permanently added the RSA host key for IP address '52.74.223.119' to the list of known hosts. remote: Enumerating objects: 8, done. remote: Counting objects: 100% (8/8), done. remote: Compressing objects: 100% (6/6), done. remote: Total 8 (delta 0), reused 5 (delta 0), pack-reused 0 Receiving objects: 100% (8/8), done. Identity set to XueqiangChen \u0026lt;569503960@qq.com\u0026gt;  `` å¯ä»¥çœ‹åˆ°æœ€åä¸€è¡Œçš„æ‰“å°å‡ºæ¥çš„ä¿¡æ¯ï¼Œè‡ªåŠ¨é’ˆå¯¹è¯¥ä»“åº“è®¾ç½®äº†æäº¤ä½œè€…å’Œé‚®ç®±ï¼Œä¸‹ä¸€æ¬¡æäº¤å°±ä¼šä½¿ç”¨è¿™ä¸ªæäº¤ä½œè€…å’Œé‚®ç®±ã€‚\n  æ¬¢è¿è®¿é—®GITHUBæŸ¥çœ‹å…·ä½“ä»£ç ï¼ï¼ï¼\n å‚è€ƒæ–‡ç« \n GIT TRICK #628: AUTOMATICALLY SET COMMIT AUTHOR BASED ON REPO URL å»–é›ªå³°çš„GITæ•™ç¨‹   ","date":"2019å¹´11æœˆ16æ—¥","permalink":"https://ahamoment.cn/posts/tool/tool-git-set-config/","summary":"1. èƒŒæ™¯ å…¬å¸ä½¿ç”¨çš„ä»£ç ä»“åº“æ˜¯Gitlabï¼Œä¸ªäººä»£ç ä»“åº“åˆæ˜¯Githubã€‚æ¯æ¬¡æäº¤ä»£ç çš„æ—¶å€™ï¼Œéœ€è¦åˆ‡æ¢ä¸åŒçš„æäº¤ä½œè€…å’Œæäº¤é‚®ç®±ï¼Œéå¸¸å®¹æ˜“å‡ºé”™ã€‚ è¿™ä¸ªè„šæœ¬æ˜¯æ ¹æ®repo urlè‡ªåŠ¨è®¾ç½®æäº¤ä½œè€…ï¼Œé¿å…æ¯æ¬¡æ‰‹åŠ¨é…ç½®ã€‚\n2. æ–¹æ³• 2.1 å®‰è£…Git  Linux ä¸Šå®‰è£…Gitç›´æ¥ä½¿ç”¨ sudo yum install git æˆ–è€… sudo apt-get install git å‘½ä»¤å³å¯ã€‚ Windows ä¸Šå®‰è£…åˆ°å®˜ç½‘ä¸‹è½½å®‰è£…è½¯ä»¶å®‰è£…å³å¯ã€‚å®‰è£…åœ°å€  2.","title":"è‡ªåŠ¨é…ç½®Gitä»“åº“æäº¤ä½œè€…"}]